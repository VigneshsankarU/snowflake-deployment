-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_STG_BENFIELD_SUPP_INFO("RUN_ID" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' BEGIN 

-- Component LKPTRANS, Type Prerequisite Lookup Object 
CREATE OR REPLACE TEMPORARY TABLE LKPTRANS AS
(
SELECT  DAILY_FEED_IND AS DAILY_FEED_IND_LKP, max(CYC_END_DT) AS CYC_END_DT_LKP FROM DB_T_CTRL_PROD.ECTL_MISPREM_HEADER GROUP BY DAILY_FEED_IND_LKP /*  */
);


-- PIPELINE START FOR 1
-- Component TGT_DUMMY1, Type Pre SQL 
DELete FROM DB_T_STAG_PROD.STG_BENFIELD_SUPP_INFO;


-- Component SQ_STG_BENFIELD_SUPP_INFO, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_STG_BENFIELD_SUPP_INFO AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as DUMMY,
$2 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELect COUNT(*) AS DUMMY FROM DB_T_STAG_PROD.STG_BENFIELD_SUPP_INFO
) SRC
)
);


-- Component FILTRANS, Type FILTER 
CREATE OR REPLACE TEMPORARY TABLE FILTRANS AS
(
SELECT
SQ_STG_BENFIELD_SUPP_INFO.DUMMY as DUMMY,
SQ_STG_BENFIELD_SUPP_INFO.source_record_id
FROM
SQ_STG_BENFIELD_SUPP_INFO
WHERE TO_CHAR(SQ_STG_BENFIELD_SUPP_INFO.DUMMY) = ''A''
);


-- Component TGT_DUMMY1, Type TARGET 
CREATE OR REPLACE TABLE TGT_DUMMY1 AS
SELECT
FILTRANS.DUMMY as DUMMY
FROM
FILTRANS;


-- PIPELINE END FOR 1

-- PIPELINE START FOR 2

-- Component SQ_BENFIELD_SUPP_INFO_SRC, Type TABLE_DDL Creating an empty table
CREATE OR REPLACE TEMPORARY TABLE SQ_BENFIELD_SUPP_INFO
(
POLICY_NBR varchar(9),
INCEPT_DT varchar(6),
EXP_DT varchar(6),
POLICY_STATUS varchar(3),
CMPY_NBR varchar(3),
ROOF_YR varchar(4),
SQUARE_FTG varchar(5),
EQUAKE_ENDRSMN varchar(5),
EQUAKE_END_DESC varchar(25),
HURR_ENDRSMNT varchar(5),
HURR_END_DESC varchar(25),
XWIND_ENDRSMNT varchar(5),
XWIND_END_DESC varchar(25),
LOCATION_DESC varchar(61),
source_record_id number autoincrement start 1 increment 1
);


-- Component SQ_BENFIELD_SUPP_INFO_SRC, Type IMPORT_DATA Importing Data
;


-- Component EXPTRANS, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE EXPTRANS AS
(
SELECT
SQ_BENFIELD_SUPP_INFO.POLICY_NBR as POLICY_NBR,
SQ_BENFIELD_SUPP_INFO.INCEPT_DT as INCEPT_DT,
SQ_BENFIELD_SUPP_INFO.EXP_DT as EXP_DT,
SQ_BENFIELD_SUPP_INFO.POLICY_STATUS as POLICY_STATUS,
SQ_BENFIELD_SUPP_INFO.CMPY_NBR as CMPY_NBR,
SQ_BENFIELD_SUPP_INFO.ROOF_YR as ROOF_YR,
SQ_BENFIELD_SUPP_INFO.SQUARE_FTG as SQUARE_FTG,
SQ_BENFIELD_SUPP_INFO.EQUAKE_ENDRSMN as EQUAKE_ENDRSMN,
SQ_BENFIELD_SUPP_INFO.EQUAKE_END_DESC as EQUAKE_END_DESC,
SQ_BENFIELD_SUPP_INFO.HURR_ENDRSMNT as HURR_ENDRSMNT,
SQ_BENFIELD_SUPP_INFO.HURR_END_DESC as HURR_END_DESC,
SQ_BENFIELD_SUPP_INFO.XWIND_ENDRSMNT as XWIND_ENDRSMNT,
SQ_BENFIELD_SUPP_INFO.XWIND_END_DESC as XWIND_END_DESC,
SQ_BENFIELD_SUPP_INFO.LOCATION_DESC as LOCATION_DESC,
LKP_1.CYC_END_DT_LKP /* replaced lookup LKPTRANS */ as v_FEED_DT,
TO_DATE ( v_FEED_DT , ''YYYY-MM-DD'' ) as FEED_DT,
SQ_BENFIELD_SUPP_INFO.source_record_id,
row_number() over (partition by SQ_BENFIELD_SUPP_INFO.source_record_id order by SQ_BENFIELD_SUPP_INFO.source_record_id) as RNK
FROM
SQ_BENFIELD_SUPP_INFO
LEFT JOIN LKPTRANS LKP_1 ON LKP_1.DAILY_FEED_IND_LKP = ''M''
QUALIFY RNK = 1
);


-- Component STG_BENFIELD_SUPP_INFO, Type TARGET_EXPORT_PREPARE Stage data before exporting
CREATE OR REPLACE TEMPORARY TABLE STG_BENFIELD_SUPP_INFO AS
(
SELECT
EXPTRANS.POLICY_NBR as POLICY_NBR,
EXPTRANS.INCEPT_DT as INCEPT_DT,
EXPTRANS.EXP_DT as EXP_DT,
EXPTRANS.POLICY_STATUS as POLICY_STATUS,
EXPTRANS.CMPY_NBR as CMPY_NBR,
EXPTRANS.ROOF_YR as ROOF_YR,
EXPTRANS.SQUARE_FTG as SQUARE_FTG,
EXPTRANS.EQUAKE_ENDRSMN as EQUAKE_ENDRSMN,
EXPTRANS.EQUAKE_END_DESC as EQUAKE_END_DESC,
EXPTRANS.HURR_ENDRSMNT as HURR_ENDRSMNT,
EXPTRANS.HURR_END_DESC as HURR_END_DESC,
EXPTRANS.XWIND_ENDRSMNT as XWIND_ENDRSMNT,
EXPTRANS.XWIND_END_DESC as XWIND_END_DESC,
EXPTRANS.LOCATION_DESC as LOCATION_DESC,
EXPTRANS.FEED_DT as FEED_DT
FROM
EXPTRANS
);


-- Component STG_BENFIELD_SUPP_INFO, Type EXPORT_DATA Exporting data
;


-- PIPELINE END FOR 2

END; ';