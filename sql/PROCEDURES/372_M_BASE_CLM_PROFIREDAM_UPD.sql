-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_BASE_CLM_PROFIREDAM_UPD("RUN_ID" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' DECLARE start_dttm TIMESTAMP;
end_dttm TIMESTAMP;
PRCS_ID INTEGER;
FS_DATE date;
BEGIN 
start_dttm := CURRENT_TIMESTAMP();
end_dttm := CURRENT_TIMESTAMP();
PRCS_ID := 1;  

-- Component LKP_TERADATA_ETL_REF_XLAT_CLM_SRC_CD, Type Prerequisite Lookup Object 
CREATE OR REPLACE TEMPORARY TABLE LKP_TERADATA_ETL_REF_XLAT_CLM_SRC_CD AS
(
SELECT 

	TERADATA_ETL_REF_XLAT.TGT_IDNTFTN_VAL as TGT_IDNTFTN_VAL

	,TERADATA_ETL_REF_XLAT.SRC_IDNTFTN_VAL as SRC_IDNTFTN_VAL, 
row_number() over (order by 1) AS source_record_id
FROM 

	DB_T_PROD_CORE.TERADATA_ETL_REF_XLAT

WHERE 

	TERADATA_ETL_REF_XLAT.TGT_IDNTFTN_NM= ''SRC_SYS''

             AND TERADATA_ETL_REF_XLAT.SRC_IDNTFTN_NM= ''derived''

		AND TERADATA_ETL_REF_XLAT.SRC_IDNTFTN_SYS= ''DS''

		AND TERADATA_ETL_REF_XLAT.EXPN_DT=''9999-12-31''
);


-- Component SQ_cc_propertyfiredamage, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_cc_propertyfiredamage AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as ClaimNumber,
$2 as TYPECODE,
$3 as CLM_SRC_CD,
$4 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT	cc_propertyfiredamage.ClaimNumber_stg AS ClaimNumber, cctl_damageextent_alfa.TYPECODE_stg AS TYPECODE,

		''SRC_SYS6'' as clm_src_cd

FROM

 (SELECT	cc_propertyfiredamage.DamageExtent_alfa_stg,

		cc_propertyfiredamage.UpdateTime_stg, cc_propertyfiredamage.ClaimID_stg,

		cc_claim.ClaimNumber_stg

FROM

 DB_T_PROD_STAG.cc_propertyfiredamage,

			(select cc_claim.* 

	from	DB_T_PROD_STAG.cc_claim 

	inner join DB_T_PROD_STAG.cctl_claimstate 

		on cc_claim.State_stg= cctl_claimstate.id_stg 

	where	cctl_claimstate.name_stg <> ''Draft'') cc_claim

WHERE

 cc_claim.ID_stg=cc_propertyfiredamage.ClaimID_stg

	and (cc_propertyfiredamage.UpdateTime_stg > (:start_dttm)

	and cc_propertyfiredamage.UpdateTime_stg <= (:END_DTTM))) cc_propertyfiredamage

inner join (SELECT	cctl_damageextent_alfa.TYPECODE_stg, cctl_damageextent_alfa.id_stg

FROM DB_T_PROD_STAG.cctl_damageextent_alfa) cctl_damageextent_alfa

	on cc_propertyfiredamage.damageextent_alfa_stg = cctl_damageextent_alfa.id_stg
) SRC
)
);


-- Component exp_pass_through, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_pass_through AS
(
SELECT
SQ_cc_propertyfiredamage.ClaimNumber as ClaimNumber,
SQ_cc_propertyfiredamage.TYPECODE as TYPECODE,
LKP_1.TGT_IDNTFTN_VAL /* replaced lookup LKP_TERADATA_ETL_REF_XLAT_CLM_SRC_CD */ as out_CLM_SRC_CD,
SQ_cc_propertyfiredamage.source_record_id,
row_number() over (partition by SQ_cc_propertyfiredamage.source_record_id order by SQ_cc_propertyfiredamage.source_record_id) as RNK
FROM
SQ_cc_propertyfiredamage
LEFT JOIN LKP_TERADATA_ETL_REF_XLAT_CLM_SRC_CD LKP_1 ON LKP_1.SRC_IDNTFTN_VAL = SQ_cc_propertyfiredamage.CLM_SRC_CD
QUALIFY RNK = 1
);


-- Component LKP_CLM, Type LOOKUP 
CREATE OR REPLACE TEMPORARY TABLE LKP_CLM AS
(
SELECT
LKP.CLM_ID,
exp_pass_through.source_record_id,
ROW_NUMBER() OVER(PARTITION BY exp_pass_through.source_record_id ORDER BY LKP.CLM_ID desc,LKP.CLM_TYPE_CD desc,LKP.CLM_MDIA_TYPE_CD desc,LKP.CLM_SUBMTL_TYPE_CD desc,LKP.ACDNT_TYPE_CD desc,LKP.CLM_CTGY_TYPE_CD desc,LKP.ADDL_INSRNC_PLN_IND desc,LKP.EMPLMT_RLTD_IND desc,LKP.ATTNY_INVLVMT_IND desc,LKP.CLM_NUM desc,LKP.CLM_PRIR_IND desc,LKP.PMT_MODE_CD desc,LKP.CLM_OBLGTN_TYPE_CD desc,LKP.SUBRGTN_ELGBL_CD desc,LKP.SUBRGTN_ELGBLY_RSN_CD desc,LKP.CURY_CD desc,LKP.INCDT_EV_ID desc,LKP.INSRD_AT_FAULT_IND desc,LKP.CVGE_IN_QUES_IND desc,LKP.EXTNT_OF_FIRE_DMG_TYPE_CD desc,LKP.VFYD_CLM_IND desc,LKP.PRCS_ID desc,LKP.CLM_STRT_DTTM desc,LKP.CLM_END_DTTM desc,LKP.EDW_STRT_DTTM desc,LKP.EDW_END_DTTM desc,LKP.SRC_SYS_CD desc,LKP.TRANS_STRT_DTTM desc,LKP.LGCY_CLM_NUM desc) RNK
FROM
exp_pass_through
LEFT JOIN (
SELECT CLM.CLM_ID as CLM_ID, CLM.CLM_TYPE_CD as CLM_TYPE_CD, CLM.CLM_MDIA_TYPE_CD as CLM_MDIA_TYPE_CD, CLM.CLM_SUBMTL_TYPE_CD as CLM_SUBMTL_TYPE_CD, CLM.ACDNT_TYPE_CD as ACDNT_TYPE_CD, CLM.CLM_CTGY_TYPE_CD as CLM_CTGY_TYPE_CD, CLM.ADDL_INSRNC_PLN_IND as ADDL_INSRNC_PLN_IND, CLM.EMPLMT_RLTD_IND as EMPLMT_RLTD_IND, CLM.ATTNY_INVLVMT_IND as ATTNY_INVLVMT_IND, CLM.CLM_PRIR_IND as CLM_PRIR_IND, CLM.PMT_MODE_CD as PMT_MODE_CD, CLM.CLM_OBLGTN_TYPE_CD as CLM_OBLGTN_TYPE_CD, CLM.SUBRGTN_ELGBL_CD as SUBRGTN_ELGBL_CD, CLM.SUBRGTN_ELGBLY_RSN_CD as SUBRGTN_ELGBLY_RSN_CD, CLM.CURY_CD as CURY_CD, CLM.INCDT_EV_ID as INCDT_EV_ID, CLM.INSRD_AT_FAULT_IND as INSRD_AT_FAULT_IND, CLM.CVGE_IN_QUES_IND as CVGE_IN_QUES_IND, CLM.EXTNT_OF_FIRE_DMG_TYPE_CD as EXTNT_OF_FIRE_DMG_TYPE_CD, CLM.VFYD_CLM_IND as VFYD_CLM_IND, CLM.PRCS_ID as PRCS_ID, CLM.CLM_STRT_DTTM as CLM_STRT_DTTM, CLM.CLM_END_DTTM as CLM_END_DTTM, CLM.EDW_STRT_DTTM as EDW_STRT_DTTM, CLM.EDW_END_DTTM as EDW_END_DTTM, CLM.TRANS_STRT_DTTM as TRANS_STRT_DTTM, CLM.LGCY_CLM_NUM as LGCY_CLM_NUM, CLM.CLM_NUM as CLM_NUM, CLM.SRC_SYS_CD as SRC_SYS_CD FROM DB_T_PROD_CORE.CLM  QUALIFY ROW_NUMBER() OVER(PARTITION BY CLM.CLM_NUM,CLM.SRC_SYS_CD  ORDER BY CLM.EDW_END_DTTM desc) = 1
) LKP ON LKP.CLM_NUM = exp_pass_through.ClaimNumber AND LKP.SRC_SYS_CD = exp_pass_through.out_CLM_SRC_CD
QUALIFY RNK = 1
);


-- Component LKP_TGT, Type LOOKUP 
CREATE OR REPLACE TEMPORARY TABLE LKP_TGT AS
(
SELECT
LKP.CLM_ID,
LKP_CLM.source_record_id,
ROW_NUMBER() OVER(PARTITION BY LKP_CLM.source_record_id ORDER BY LKP.CLM_ID asc,LKP.CLM_TYPE_CD asc,LKP.CLM_MDIA_TYPE_CD asc,LKP.CLM_SUBMTL_TYPE_CD asc,LKP.ACDNT_TYPE_CD asc,LKP.CLM_CTGY_TYPE_CD asc,LKP.ADDL_INSRNC_PLN_IND asc,LKP.EMPLMT_RLTD_IND asc,LKP.ATTNY_INVLVMT_IND asc,LKP.CLM_NUM asc,LKP.CLM_PRIR_IND asc,LKP.PMT_MODE_CD asc,LKP.CLM_OBLGTN_TYPE_CD asc,LKP.SUBRGTN_ELGBL_CD asc,LKP.SUBRGTN_ELGBLY_RSN_CD asc,LKP.CURY_CD asc,LKP.INCDT_EV_ID asc,LKP.INSRD_AT_FAULT_IND asc,LKP.CVGE_IN_QUES_IND asc,LKP.EXTNT_OF_FIRE_DMG_TYPE_CD asc,LKP.PRCS_ID asc) RNK
FROM
LKP_CLM
LEFT JOIN (
SELECT
CLM_ID,
CLM_TYPE_CD,
CLM_MDIA_TYPE_CD,
CLM_SUBMTL_TYPE_CD,
ACDNT_TYPE_CD,
CLM_CTGY_TYPE_CD,
ADDL_INSRNC_PLN_IND,
EMPLMT_RLTD_IND,
ATTNY_INVLVMT_IND,
CLM_NUM,
CLM_PRIR_IND,
PMT_MODE_CD,
CLM_OBLGTN_TYPE_CD,
SUBRGTN_ELGBL_CD,
SUBRGTN_ELGBLY_RSN_CD,
CURY_CD,
INCDT_EV_ID,
INSRD_AT_FAULT_IND,
CVGE_IN_QUES_IND,
EXTNT_OF_FIRE_DMG_TYPE_CD,
PRCS_ID
FROM DB_T_PROD_CORE.CLM
) LKP ON LKP.CLM_ID = LKP_CLM.CLM_ID
QUALIFY RNK = 1
);


-- Component exp, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp AS
(
SELECT
LKP_TGT.CLM_ID as CLM_ID,
LKP_TERADATA_ETL_REF_XLAT.TGT_IDNTFTN_VAL as TYPECODE,
:PRCS_ID as PRCS_ID,
LKP_TERADATA_ETL_REF_XLAT.source_record_id
FROM
LKP_TERADATA_ETL_REF_XLAT_CLM_SRC_CD LKP_TERADATA_ETL_REF_XLAT
INNER JOIN LKP_TGT ON LKP_TERADATA_ETL_REF_XLAT.source_record_id = LKP_TGT.source_record_id
);


-- Component upd_update, Type UPDATE 
CREATE OR REPLACE TEMPORARY TABLE upd_update AS
(
/* UPDATE_STRATEGY_ACTION = 0 FOR INSERT / UPDATE_STRATEGY_ACTION = 1 FOR UPDATE / UPDATE_STRATEGY_ACTION = 2 FOR DELETE / UPDATE_STRATEGY_ACTION = 3 FOR REJECT */
SELECT
exp.TYPECODE as TYPECODE,
exp.CLM_ID as CLM_ID,
exp.PRCS_ID as PRCS_ID,
1 as UPDATE_STRATEGY_ACTION
FROM
exp
);


-- Component CLM, Type TARGET 
/* Perform Updates */
MERGE INTO DB_T_PROD_CORE.CLM
USING upd_update ON (UPDATE_STRATEGY_ACTION = 1 AND CLM.CLM_ID = upd_update.CLM_ID)
WHEN MATCHED THEN UPDATE
SET
EXTNT_OF_FIRE_DMG_TYPE_CD = upd_update.TYPECODE,
PRCS_ID = upd_update.PRCS_ID
;


END; ';