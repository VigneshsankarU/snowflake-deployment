-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_AUDT_PRM_SUMM("RUN_ID" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' BEGIN 

-- Component SQ_Shortcut_to_FIN_PREMIUM_TXN, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_Shortcut_to_FIN_PREMIUM_TXN AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as CMPY_CD,
$2 as ST_CD,
$3 as LOB_CD,
$4 as PRODUCT_CD,
$5 as COV_TYPE_CD,
$6 as ACCTNG_YR,
$7 as POOL_CD,
$8 as REINSUR_CD,
$9 as LEDGER,
$10 as ACCT_NBR,
$11 as GL_DSTR_STATUS,
$12 as MONETARY_AMT,
$13 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT
FIN_PREMIUM_TXN.CMPY_CD,
FIN_PREMIUM_TXN.ST_CD,
FIN_PREMIUM_TXN.LOB_CD,
FIN_PREMIUM_TXN.PRODUCT_CD,
FIN_PREMIUM_TXN.COV_TYPE_CD,
FIN_PREMIUM_TXN.ACCTNG_YR,
FIN_PREMIUM_TXN.POOL_CD,
FIN_PREMIUM_TXN.REINSUR_CD,
FIN_PREMIUM_TXN.LEDGER,
FIN_PREMIUM_TXN.ACCT_NBR,
FIN_PREMIUM_TXN.GL_DSTR_STATUS,
FIN_PREMIUM_TXN.MONETARY_AMT
FROM DB_T_CORE_FIN_PROD.FIN_PREMIUM_TXN
limit 1000
) SRC
)
);


-- Component EXPTRANS, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE EXPTRANS AS
(
SELECT
SQ_Shortcut_to_FIN_PREMIUM_TXN.CMPY_CD as CMPY_CD,
SQ_Shortcut_to_FIN_PREMIUM_TXN.ST_CD as ST_CD,
SQ_Shortcut_to_FIN_PREMIUM_TXN.LOB_CD as LOB_CD,
SQ_Shortcut_to_FIN_PREMIUM_TXN.PRODUCT_CD as PRODUCT_CD,
SQ_Shortcut_to_FIN_PREMIUM_TXN.COV_TYPE_CD as COV_TYPE_CD,
SQ_Shortcut_to_FIN_PREMIUM_TXN.ACCTNG_YR as ACCTNG_YR,
SQ_Shortcut_to_FIN_PREMIUM_TXN.POOL_CD as POOL_CD,
SQ_Shortcut_to_FIN_PREMIUM_TXN.REINSUR_CD as REINSUR_CD,
SQ_Shortcut_to_FIN_PREMIUM_TXN.LEDGER as LEDGER,
SQ_Shortcut_to_FIN_PREMIUM_TXN.ACCT_NBR as ACCT_NBR,
SQ_Shortcut_to_FIN_PREMIUM_TXN.GL_DSTR_STATUS as GL_DSTR_STATUS,
SQ_Shortcut_to_FIN_PREMIUM_TXN.MONETARY_AMT as MONETARY_AMT,
SQ_Shortcut_to_FIN_PREMIUM_TXN.source_record_id
FROM
SQ_Shortcut_to_FIN_PREMIUM_TXN
);


-- Component AUDT_PRM_SUMM, Type TARGET_EXPORT_PREPARE Stage data before exporting
CREATE OR REPLACE TEMPORARY TABLE AUDT_PRM_SUMM AS
(
SELECT
EXPTRANS.CMPY_CD as CMPY_CD,
EXPTRANS.ST_CD as ST_CD,
EXPTRANS.LOB_CD as LOB_CD,
EXPTRANS.PRODUCT_CD as PRODUCT_CD,
EXPTRANS.COV_TYPE_CD as COV_TYP_CD,
EXPTRANS.ACCTNG_YR as ACCTNG_YR,
EXPTRANS.POOL_CD as POOL_CD,
EXPTRANS.REINSUR_CD as REINSUR_CD,
EXPTRANS.LEDGER as LEDGER,
EXPTRANS.ACCT_NBR as ACCT_NBR,
EXPTRANS.GL_DSTR_STATUS as GL_DSTR_STATUS,
EXPTRANS.MONETARY_AMT as PREM_AMT
FROM
EXPTRANS
);

COPY INTO @public.edw_stage/my_export_folder/AUDT_PRM_SUMM_
FROM (SELECT * FROM AUDT_PRM_SUMM)
HEADER = TRUE
OVERWRITE = TRUE;
-- Component AUDT_PRM_SUMM, Type EXPORT_DATA Exporting data
;


END; ';