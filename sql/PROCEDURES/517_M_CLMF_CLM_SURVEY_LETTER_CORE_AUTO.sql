-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_CLMF_CLM_SURVEY_LETTER_CORE_AUTO("RUN_ID" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' 
DECLARE
PMMAPPINGNAME varchar;
ACT_PROJ_ID varchar;
BATCH_ACTIVE_IND varchar;
TABLE_NM varchar;
BEGIN 

-- Component LKP_ECTL_PRGM_PARAM, Type Prerequisite Lookup Object 
CREATE OR REPLACE TEMPORARY TABLE LKP_ECTL_PRGM_PARAM AS
(
SELECT
ECTL_PARAM_VALUE,
ECTL_PARAM_DESC
FROM db_t_ctrl_prod.ECTL_PRGM_PARAM
);


-- Component SQ_STG_CLMF_CLM_SURVEY_LETTER_TRL, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_STG_CLMF_CLM_SURVEY_LETTER_TRL AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as OPERATOR_ID,
$2 as COMPANY,
$3 as MRI,
$4 as TRL_COUNT,
$5 as POL_STATE,
$6 as PFX,
$7 as PNO,
$8 as DATE_O_LOSS,
$9 as DATE_O_LOSS_DATE,
$10 as SEQNO,
$11 as TRI_L,
$12 as SL_TYPE_SURVY_L,
$13 as SL_NAME1_L,
$14 as SL_NAME2_L,
$15 as SL_ADDRESS_L,
$16 as SL_CITY_L,
$17 as SL_STATE_L,
$18 as SL_ZIP_L,
$19 as SL_ZIP_EXT_L,
$20 as SL_DPX_L,
$21 as SL_DNO_L,
$22 as SL_LETR_DT_L,
$23 as SL_LETR_DT_L_DATE,
$24 as SL_RET_CODE_L,
$25 as SL_2ND_3RD_DT_L,
$26 as SL_2ND_3RD_DT_L_DATE,
$27 as SL_ADJ_NO_L,
$28 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT DISTINCT
TRIM(STG_CLMF_CLM_SURVEY_LTR_AUTO.OPERATOR_ID) AS OPERATOR_ID , 
STG_CLMF_CLM_SURVEY_LTR_AUTO.COMPANY,
 TRIM(STG_CLMF_CLM_SURVEY_LTR_AUTO.MRI) AS MRI, 
STG_CLMF_CLM_SURVEY_LTR_AUTO.TRL_COUNT, 
STG_CLMF_CLM_SURVEY_LTR_AUTO.POL_STATE, 
STG_CLMF_CLM_SURVEY_LTR_AUTO.PFX,
 STG_CLMF_CLM_SURVEY_LTR_AUTO.PNO,
 STG_CLMF_CLM_SURVEY_LTR_AUTO.DATE_O_LOSS, 
STG_CLMF_CLM_SURVEY_LTR_AUTO.DATE_O_LOSS_DATE,
 STG_CLMF_CLM_SURVEY_LTR_AUTO.SEQNO, 
 STG_CLMF_CLM_SURVEY_LTR_AUTO.TRI_L,
 STG_CLMF_CLM_SURVEY_LTR_AUTO.SL_TYPE_SURVY_L, 
TRIM(STG_CLMF_CLM_SURVEY_LTR_AUTO.SL_NAME1_L) AS SL_NAME1_L,
TRIM(STG_CLMF_CLM_SURVEY_LTR_AUTO.SL_NAME2_L) AS SL_NAME2_L, 
TRIM(STG_CLMF_CLM_SURVEY_LTR_AUTO.SL_ADDRESS_L) AS SL_ADDRESS_L,
TRIM(STG_CLMF_CLM_SURVEY_LTR_AUTO.SL_CITY_L) AS SL_CITY_L,
TRIM(STG_CLMF_CLM_SURVEY_LTR_AUTO.SL_STATE_L) AS SL_STATE_L,
 STG_CLMF_CLM_SURVEY_LTR_AUTO.SL_ZIP_L,
 STG_CLMF_CLM_SURVEY_LTR_AUTO.SL_ZIP_EXT_L,
TRIM(STG_CLMF_CLM_SURVEY_LTR_AUTO.SL_DPX_L) AS SL_DPX_L,
 STG_CLMF_CLM_SURVEY_LTR_AUTO.SL_DNO_L, 
STG_CLMF_CLM_SURVEY_LTR_AUTO.SL_LETR_DT_L, 
STG_CLMF_CLM_SURVEY_LTR_AUTO.SL_LETR_DT_L_DATE,
 STG_CLMF_CLM_SURVEY_LTR_AUTO.SL_RET_CODE_L,
 STG_CLMF_CLM_SURVEY_LTR_AUTO.SL_2ND_3RD_DT_L,
 STG_CLMF_CLM_SURVEY_LTR_AUTO.SL_2ND_3RD_DT_L_DATE, 
TRIM(STG_CLMF_CLM_SURVEY_LTR_AUTO.SL_ADJ_NO_L) AS SL_ADJ_NO_L
FROM
 DB_T_STAG_PROD.STG_CLMF_CLM_SURVEY_LTR_AUTO
) SRC
)
);


-- Component exp_HOLD_DATA, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_HOLD_DATA AS
(
SELECT
SQ_STG_CLMF_CLM_SURVEY_LETTER_TRL.MRI as MRI,
SQ_STG_CLMF_CLM_SURVEY_LETTER_TRL.POL_STATE as POL_STATE,
SQ_STG_CLMF_CLM_SURVEY_LETTER_TRL.PFX as PFX,
SQ_STG_CLMF_CLM_SURVEY_LETTER_TRL.PNO as PNO,
SQ_STG_CLMF_CLM_SURVEY_LETTER_TRL.DATE_O_LOSS as DATE_O_LOSS,
SQ_STG_CLMF_CLM_SURVEY_LETTER_TRL.DATE_O_LOSS_DATE as DATE_O_LOSS_DATE,
SQ_STG_CLMF_CLM_SURVEY_LETTER_TRL.SEQNO as SEQNO,
SQ_STG_CLMF_CLM_SURVEY_LETTER_TRL.SL_TYPE_SURVY_L as SL_TYPE_SURVY_L,
SQ_STG_CLMF_CLM_SURVEY_LETTER_TRL.SL_NAME1_L as SL_NAME1_L,
SQ_STG_CLMF_CLM_SURVEY_LETTER_TRL.SL_NAME2_L as SL_NAME2_L,
SQ_STG_CLMF_CLM_SURVEY_LETTER_TRL.SL_ADDRESS_L as SL_ADDRESS_L,
SQ_STG_CLMF_CLM_SURVEY_LETTER_TRL.SL_CITY_L as SL_CITY_L,
SQ_STG_CLMF_CLM_SURVEY_LETTER_TRL.SL_STATE_L as SL_STATE_L,
SQ_STG_CLMF_CLM_SURVEY_LETTER_TRL.SL_ZIP_L as SL_ZIP_L,
SQ_STG_CLMF_CLM_SURVEY_LETTER_TRL.SL_ZIP_EXT_L as SL_ZIP_EXT_L,
SQ_STG_CLMF_CLM_SURVEY_LETTER_TRL.SL_DPX_L as SL_DPX_L,
SQ_STG_CLMF_CLM_SURVEY_LETTER_TRL.SL_DNO_L as SL_DNO_L,
SQ_STG_CLMF_CLM_SURVEY_LETTER_TRL.SL_LETR_DT_L as SL_LETR_DT_L,
SQ_STG_CLMF_CLM_SURVEY_LETTER_TRL.SL_LETR_DT_L_DATE as SL_LETR_DT_L_DATE,
SQ_STG_CLMF_CLM_SURVEY_LETTER_TRL.SL_RET_CODE_L as SL_RET_CODE_L,
SQ_STG_CLMF_CLM_SURVEY_LETTER_TRL.SL_2ND_3RD_DT_L as SL_2ND_3RD_DT_L,
SQ_STG_CLMF_CLM_SURVEY_LETTER_TRL.SL_2ND_3RD_DT_L_DATE as SL_2ND_3RD_DT_L_DATE,
SQ_STG_CLMF_CLM_SURVEY_LETTER_TRL.SL_ADJ_NO_L as SL_ADJ_NO_L,
SQ_STG_CLMF_CLM_SURVEY_LETTER_TRL.source_record_id
FROM
SQ_STG_CLMF_CLM_SURVEY_LETTER_TRL
);


-- Component LKP_CLMF_CLAIM_CORE, Type LOOKUP 
CREATE OR REPLACE TEMPORARY TABLE LKP_CLMF_CLAIM_CORE AS
(
SELECT
LKP.CLAIM_SKEY,
exp_HOLD_DATA.source_record_id,
ROW_NUMBER() OVER(PARTITION BY exp_HOLD_DATA.source_record_id ORDER BY LKP.CLAIM_SKEY asc) RNK
FROM
exp_HOLD_DATA
LEFT JOIN (
SELECT
CLAIM_SKEY,
PLCY_ST,
PLCY_PREFIX,
PLCY_NBR,
LOSS_DT,
SEQ_NBR
FROM db_t_core_prod.CLMF_CLAIM_CORE
) LKP ON LKP.PLCY_ST = exp_HOLD_DATA.POL_STATE AND LKP.PLCY_PREFIX = exp_HOLD_DATA.PFX AND LKP.PLCY_NBR = exp_HOLD_DATA.PNO AND LKP.LOSS_DT = exp_HOLD_DATA.DATE_O_LOSS AND LKP.SEQ_NBR = exp_HOLD_DATA.SEQNO
QUALIFY RNK = 1
);


-- Component exp_HOLD_SRC, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_HOLD_SRC AS
(
SELECT
LKP_CLMF_CLAIM_CORE.CLAIM_SKEY as CLAIM_SKEY,
exp_HOLD_DATA.MRI as MRI,
exp_HOLD_DATA.POL_STATE as POL_STATE,
exp_HOLD_DATA.PFX as PFX,
exp_HOLD_DATA.PNO as PNO,
exp_HOLD_DATA.DATE_O_LOSS as DATE_O_LOSS,
exp_HOLD_DATA.DATE_O_LOSS_DATE as DATE_O_LOSS_DATE,
exp_HOLD_DATA.SEQNO as SEQNO,
exp_HOLD_DATA.SL_TYPE_SURVY_L as SL_TYPE_SURVY_L,
exp_HOLD_DATA.SL_NAME1_L as SL_NAME1_L,
exp_HOLD_DATA.SL_NAME2_L as SL_NAME2_L,
exp_HOLD_DATA.SL_ADDRESS_L as SL_ADDRESS_L,
exp_HOLD_DATA.SL_CITY_L as SL_CITY_L,
exp_HOLD_DATA.SL_STATE_L as SL_STATE_L,
exp_HOLD_DATA.SL_ZIP_L as SL_ZIP_L,
exp_HOLD_DATA.SL_ZIP_EXT_L as SL_ZIP_EXT_L,
exp_HOLD_DATA.SL_DPX_L as SL_DPX_L,
exp_HOLD_DATA.SL_DNO_L as SL_DNO_L,
exp_HOLD_DATA.SL_LETR_DT_L as SL_LETR_DT_L,
exp_HOLD_DATA.SL_LETR_DT_L_DATE as SL_LETR_DT_L_DATE,
exp_HOLD_DATA.SL_RET_CODE_L as SL_RET_CODE_L,
exp_HOLD_DATA.SL_2ND_3RD_DT_L as SL_2ND_3RD_DT_L,
exp_HOLD_DATA.SL_2ND_3RD_DT_L_DATE as SL_2ND_3RD_DT_L_DATE,
exp_HOLD_DATA.SL_ADJ_NO_L as SL_ADJ_NO_L,
LKP_1.ECTL_PARAM_VALUE /* replaced lookup LKP_ECTL_PRGM_PARAM */ as var_CHG_EFF_DT,
TO_DATE ( var_CHG_EFF_DT , ''YYYY-MM-DD'' ) as out_CHG_EFF_DT,
TO_DATE ( ''9999-12-31'' , ''YYYY-MM-DD'' ) as out_CHG_EXP_DT,
exp_HOLD_DATA.source_record_id,
row_number() over (partition by exp_HOLD_DATA.source_record_id order by exp_HOLD_DATA.source_record_id) as RNK
FROM
exp_HOLD_DATA
INNER JOIN LKP_CLMF_CLAIM_CORE ON exp_HOLD_DATA.source_record_id = LKP_CLMF_CLAIM_CORE.source_record_id
LEFT JOIN LKP_ECTL_PRGM_PARAM LKP_1 ON LKP_1.ECTL_PARAM_DESC = ''CLAIM MASTER FEED DATE''
QUALIFY RNK = 1
);


-- Component LKP_CLMF_CLM_SURVEY_LETTER_CORE, Type LOOKUP 
CREATE OR REPLACE TEMPORARY TABLE LKP_CLMF_CLM_SURVEY_LETTER_CORE AS
(
SELECT
LKP.SRVY_LTR_SKEY,
LKP.CLAIM_SKEY,
LKP.REC_TYPE,
LKP.PLCY_STATE,
LKP.PLCY_PREFIX,
LKP.PLCY_NBR,
LKP.LOSS_DT,
LKP.LOSS_DATE,
LKP.SEQ_NBR,
LKP.CHG_EFF_DT,
LKP.CHG_EXP_DT,
LKP.CLM_TYPE_SRVY,
LKP.NAME1,
LKP.NAME2,
LKP.ADDRESS,
LKP.CITY,
LKP.STATE,
LKP.ZIP,
LKP.ZIP_EXT,
LKP.DRFT_NBR_PFX,
LKP.DRFT_NBR,
LKP.LETTER_DT,
LKP.LETTER_DATE,
LKP.RETURN_CODE,
LKP.SL_2ND_3RD_DT,
LKP.SL_2ND_3RD_DATE,
LKP.ADJ_NBR,
exp_HOLD_SRC.source_record_id,
ROW_NUMBER() OVER(PARTITION BY exp_HOLD_SRC.source_record_id ORDER BY LKP.SRVY_LTR_SKEY asc,LKP.CLAIM_SKEY asc,LKP.REC_TYPE asc,LKP.PLCY_STATE asc,LKP.PLCY_PREFIX asc,LKP.PLCY_NBR asc,LKP.LOSS_DT asc,LKP.LOSS_DATE asc,LKP.SEQ_NBR asc,LKP.CHG_EFF_DT asc,LKP.CHG_EXP_DT asc,LKP.CLM_TYPE_SRVY asc,LKP.NAME1 asc,LKP.NAME2 asc,LKP.ADDRESS asc,LKP.CITY asc,LKP.STATE asc,LKP.ZIP asc,LKP.ZIP_EXT asc,LKP.DRFT_NBR_PFX asc,LKP.DRFT_NBR asc,LKP.LETTER_DT asc,LKP.LETTER_DATE asc,LKP.RETURN_CODE asc,LKP.SL_2ND_3RD_DT asc,LKP.SL_2ND_3RD_DATE asc,LKP.ADJ_NBR asc) RNK
FROM
exp_HOLD_SRC
LEFT JOIN (
SELECT DISTINCT CLMF_CLM_SURVEY_LETTER_CORE.SRVY_LTR_SKEY as SRVY_LTR_SKEY, CLMF_CLM_SURVEY_LETTER_CORE.REC_TYPE as REC_TYPE, CLMF_CLM_SURVEY_LETTER_CORE.PLCY_STATE as PLCY_STATE, CLMF_CLM_SURVEY_LETTER_CORE.PLCY_PREFIX as PLCY_PREFIX, CLMF_CLM_SURVEY_LETTER_CORE.PLCY_NBR as PLCY_NBR, CLMF_CLM_SURVEY_LETTER_CORE.LOSS_DT as LOSS_DT, CLMF_CLM_SURVEY_LETTER_CORE.LOSS_DATE as LOSS_DATE, CLMF_CLM_SURVEY_LETTER_CORE.SEQ_NBR as SEQ_NBR, CLMF_CLM_SURVEY_LETTER_CORE.CHG_EFF_DT as CHG_EFF_DT, CLMF_CLM_SURVEY_LETTER_CORE.CHG_EXP_DT as CHG_EXP_DT, CLMF_CLM_SURVEY_LETTER_CORE.NAME1 as NAME1, CLMF_CLM_SURVEY_LETTER_CORE.NAME2 as NAME2, CLMF_CLM_SURVEY_LETTER_CORE.ADDRESS as ADDRESS, CLMF_CLM_SURVEY_LETTER_CORE.CITY as CITY, CLMF_CLM_SURVEY_LETTER_CORE.STATE as STATE, CLMF_CLM_SURVEY_LETTER_CORE.ZIP as ZIP, CLMF_CLM_SURVEY_LETTER_CORE.ZIP_EXT as ZIP_EXT, CLMF_CLM_SURVEY_LETTER_CORE.DRFT_NBR_PFX as DRFT_NBR_PFX, CLMF_CLM_SURVEY_LETTER_CORE.LETTER_DT as LETTER_DT, CLMF_CLM_SURVEY_LETTER_CORE.LETTER_DATE as LETTER_DATE, CLMF_CLM_SURVEY_LETTER_CORE.RETURN_CODE as RETURN_CODE, CLMF_CLM_SURVEY_LETTER_CORE.SL_2ND_3RD_DT as SL_2ND_3RD_DT, CLMF_CLM_SURVEY_LETTER_CORE.SL_2ND_3RD_DATE as SL_2ND_3RD_DATE, CLMF_CLM_SURVEY_LETTER_CORE.ADJ_NBR as ADJ_NBR, CLMF_CLM_SURVEY_LETTER_CORE.CLAIM_SKEY as CLAIM_SKEY, CLMF_CLM_SURVEY_LETTER_CORE.DRFT_NBR as DRFT_NBR, CLMF_CLM_SURVEY_LETTER_CORE.CLM_TYPE_SRVY as CLM_TYPE_SRVY 
FROM db_t_core_prod.CLMF_CLM_SURVEY_LETTER_CORE WHERE ECTL_TX_CD=''NEW''
) LKP ON LKP.CLAIM_SKEY = exp_HOLD_SRC.CLAIM_SKEY AND LKP.DRFT_NBR = exp_HOLD_SRC.SL_DNO_L AND LKP.CLM_TYPE_SRVY = exp_HOLD_SRC.SL_TYPE_SURVY_L
QUALIFY RNK = 1
);


-- Component exp_CHECK, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_CHECK AS
(
SELECT
LKP_CLMF_CLM_SURVEY_LETTER_CORE.SRVY_LTR_SKEY as SRVY_LTR_SKEY_lkp,
LKP_CLMF_CLM_SURVEY_LETTER_CORE.CHG_EFF_DT as CHG_EFF_DT_lkp,
exp_HOLD_SRC.MRI as MRI,
exp_HOLD_SRC.CLAIM_SKEY as CLAIM_SKEY,
exp_HOLD_SRC.POL_STATE as POL_STATE,
exp_HOLD_SRC.PFX as PFX,
exp_HOLD_SRC.PNO as PNO,
exp_HOLD_SRC.DATE_O_LOSS as DATE_O_LOSS,
exp_HOLD_SRC.DATE_O_LOSS_DATE as DATE_O_LOSS_DATE,
exp_HOLD_SRC.SEQNO as SEQNO,
exp_HOLD_SRC.SL_TYPE_SURVY_L as SL_TYPE_SURVY_L,
exp_HOLD_SRC.SL_NAME1_L as SL_NAME1_L,
exp_HOLD_SRC.SL_NAME2_L as SL_NAME2_L,
exp_HOLD_SRC.SL_ADDRESS_L as SL_ADDRESS_L,
exp_HOLD_SRC.SL_CITY_L as SL_CITY_L,
exp_HOLD_SRC.SL_STATE_L as SL_STATE_L,
exp_HOLD_SRC.SL_ZIP_L as SL_ZIP_L,
exp_HOLD_SRC.SL_ZIP_EXT_L as SL_ZIP_EXT_L,
exp_HOLD_SRC.SL_DPX_L as SL_DPX_L,
exp_HOLD_SRC.SL_DNO_L as SL_DNO_L,
exp_HOLD_SRC.SL_LETR_DT_L as SL_LETR_DT_L,
exp_HOLD_SRC.SL_LETR_DT_L_DATE as SL_LETR_DT_L_DATE,
exp_HOLD_SRC.SL_RET_CODE_L as SL_RET_CODE_L,
exp_HOLD_SRC.SL_2ND_3RD_DT_L as SL_2ND_3RD_DT_L,
exp_HOLD_SRC.SL_2ND_3RD_DT_L_DATE as SL_2ND_3RD_DT_L_DATE,
exp_HOLD_SRC.SL_ADJ_NO_L as SL_ADJ_NO_L,
LTRIM ( RTRIM ( :PMMappingName ) ) as in_PRGM_NM,
:ACT_PROJ_ID as in_ACT_PROJ_ID,
:BATCH_ACTIVE_IND as in_BATCH_ACTIVE_IND,
:TABLE_NM as in_TABLE_NM,
CASE WHEN LKP_CLMF_CLM_SURVEY_LETTER_CORE.CLAIM_SKEY IS NULL THEN ''INS'' ELSE CASE WHEN CASE WHEN LKP_CLMF_CLM_SURVEY_LETTER_CORE.REC_TYPE IS NULL THEN ''~'' ELSE LKP_CLMF_CLM_SURVEY_LETTER_CORE.REC_TYPE END <> CASE WHEN exp_HOLD_SRC.MRI IS NULL THEN ''~'' ELSE exp_HOLD_SRC.MRI END OR CASE WHEN LKP_CLMF_CLM_SURVEY_LETTER_CORE.LOSS_DATE IS NULL THEN TO_DATE ( ''9999-12-31'' , ''YYYY-MM-DD'' ) ELSE LKP_CLMF_CLM_SURVEY_LETTER_CORE.LOSS_DATE END <> CASE WHEN exp_HOLD_SRC.DATE_O_LOSS_DATE IS NULL THEN TO_DATE ( ''9999-12-31'' , ''YYYY-MM-DD'' ) ELSE exp_HOLD_SRC.DATE_O_LOSS_DATE END OR CASE WHEN LKP_CLMF_CLM_SURVEY_LETTER_CORE.NAME1 IS NULL THEN ''~'' ELSE LKP_CLMF_CLM_SURVEY_LETTER_CORE.NAME1 END <> CASE WHEN exp_HOLD_SRC.SL_NAME1_L IS NULL THEN ''~'' ELSE exp_HOLD_SRC.SL_NAME1_L END OR CASE WHEN LKP_CLMF_CLM_SURVEY_LETTER_CORE.NAME2 IS NULL THEN ''~'' ELSE LKP_CLMF_CLM_SURVEY_LETTER_CORE.NAME2 END <> CASE WHEN exp_HOLD_SRC.SL_NAME2_L IS NULL THEN ''~'' ELSE exp_HOLD_SRC.SL_NAME2_L END OR CASE WHEN LKP_CLMF_CLM_SURVEY_LETTER_CORE.ADDRESS IS NULL THEN ''~'' ELSE LKP_CLMF_CLM_SURVEY_LETTER_CORE.ADDRESS END <> CASE WHEN exp_HOLD_SRC.SL_ADDRESS_L IS NULL THEN ''~'' ELSE exp_HOLD_SRC.SL_ADDRESS_L END OR CASE WHEN LKP_CLMF_CLM_SURVEY_LETTER_CORE.CITY IS NULL THEN ''~'' ELSE LKP_CLMF_CLM_SURVEY_LETTER_CORE.CITY END <> CASE WHEN exp_HOLD_SRC.SL_CITY_L IS NULL THEN ''~'' ELSE exp_HOLD_SRC.SL_CITY_L END OR CASE WHEN LKP_CLMF_CLM_SURVEY_LETTER_CORE.STATE IS NULL THEN ''~'' ELSE LKP_CLMF_CLM_SURVEY_LETTER_CORE.STATE END <> CASE WHEN exp_HOLD_SRC.SL_STATE_L IS NULL THEN ''~'' ELSE exp_HOLD_SRC.SL_STATE_L END OR CASE WHEN LKP_CLMF_CLM_SURVEY_LETTER_CORE.ZIP IS NULL THEN 0 ELSE LKP_CLMF_CLM_SURVEY_LETTER_CORE.ZIP END <> CASE WHEN exp_HOLD_SRC.SL_ZIP_L IS NULL THEN 0 ELSE exp_HOLD_SRC.SL_ZIP_L END OR CASE WHEN LKP_CLMF_CLM_SURVEY_LETTER_CORE.ZIP_EXT IS NULL THEN 0 ELSE LKP_CLMF_CLM_SURVEY_LETTER_CORE.ZIP_EXT END <> CASE WHEN exp_HOLD_SRC.SL_ZIP_EXT_L IS NULL THEN 0 ELSE exp_HOLD_SRC.SL_ZIP_EXT_L END OR CASE WHEN LKP_CLMF_CLM_SURVEY_LETTER_CORE.DRFT_NBR_PFX IS NULL THEN ''~'' ELSE LKP_CLMF_CLM_SURVEY_LETTER_CORE.DRFT_NBR_PFX END <> CASE WHEN exp_HOLD_SRC.SL_DPX_L IS NULL THEN ''~'' ELSE exp_HOLD_SRC.SL_DPX_L END OR CASE WHEN LKP_CLMF_CLM_SURVEY_LETTER_CORE.LETTER_DT IS NULL THEN 0 ELSE LKP_CLMF_CLM_SURVEY_LETTER_CORE.LETTER_DT END <> CASE WHEN exp_HOLD_SRC.SL_LETR_DT_L IS NULL THEN 0 ELSE exp_HOLD_SRC.SL_LETR_DT_L END OR CASE WHEN LKP_CLMF_CLM_SURVEY_LETTER_CORE.LETTER_DATE IS NULL THEN TO_DATE ( ''9999-12-31'' , ''YYYY-MM-DD'' ) ELSE LKP_CLMF_CLM_SURVEY_LETTER_CORE.LETTER_DATE END <> CASE WHEN exp_HOLD_SRC.SL_LETR_DT_L_DATE IS NULL THEN TO_DATE ( ''9999-12-31'' , ''YYYY-MM-DD'' ) ELSE exp_HOLD_SRC.SL_LETR_DT_L_DATE END OR CASE WHEN LKP_CLMF_CLM_SURVEY_LETTER_CORE.RETURN_CODE IS NULL THEN 0 ELSE LKP_CLMF_CLM_SURVEY_LETTER_CORE.RETURN_CODE END <> CASE WHEN exp_HOLD_SRC.SL_RET_CODE_L IS NULL THEN 0 ELSE exp_HOLD_SRC.SL_RET_CODE_L END OR CASE WHEN LKP_CLMF_CLM_SURVEY_LETTER_CORE.SL_2ND_3RD_DT IS NULL THEN 0 ELSE LKP_CLMF_CLM_SURVEY_LETTER_CORE.SL_2ND_3RD_DT END <> CASE WHEN exp_HOLD_SRC.SL_2ND_3RD_DT_L IS NULL THEN 0 ELSE exp_HOLD_SRC.SL_2ND_3RD_DT_L END OR CASE WHEN LKP_CLMF_CLM_SURVEY_LETTER_CORE.SL_2ND_3RD_DATE IS NULL THEN TO_DATE ( ''9999-12-31'' , ''YYYY-MM-DD'' ) ELSE LKP_CLMF_CLM_SURVEY_LETTER_CORE.SL_2ND_3RD_DATE END <> CASE WHEN exp_HOLD_SRC.SL_2ND_3RD_DT_L_DATE IS NULL THEN TO_DATE ( ''9999-12-31'' , ''YYYY-MM-DD'' ) ELSE exp_HOLD_SRC.SL_2ND_3RD_DT_L_DATE END OR CASE WHEN LKP_CLMF_CLM_SURVEY_LETTER_CORE.ADJ_NBR IS NULL THEN ''~'' ELSE LKP_CLMF_CLM_SURVEY_LETTER_CORE.ADJ_NBR END <> CASE WHEN exp_HOLD_SRC.SL_ADJ_NO_L IS NULL THEN ''~'' ELSE exp_HOLD_SRC.SL_ADJ_NO_L END THEN ''UPD'' ELSE ''REJ'' END END as out_CHECK,
exp_HOLD_SRC.out_CHG_EFF_DT as out_CHG_EFF_DT,
CASE WHEN ( CASE WHEN LKP_CLMF_CLM_SURVEY_LETTER_CORE.NAME1 IS NULL THEN ''~'' ELSE LKP_CLMF_CLM_SURVEY_LETTER_CORE.NAME1 END <> CASE WHEN exp_HOLD_SRC.SL_NAME1_L IS NULL THEN ''~'' ELSE exp_HOLD_SRC.SL_NAME1_L END AND exp_HOLD_SRC.SL_NAME1_L IS NULL ) OR ( CASE WHEN LKP_CLMF_CLM_SURVEY_LETTER_CORE.ADDRESS IS NULL THEN ''~'' ELSE LKP_CLMF_CLM_SURVEY_LETTER_CORE.ADDRESS END <> CASE WHEN exp_HOLD_SRC.SL_ADDRESS_L IS NULL THEN ''~'' ELSE exp_HOLD_SRC.SL_ADDRESS_L END AND exp_HOLD_SRC.SL_ADDRESS_L IS NULL ) THEN ''REJ'' ELSE ''INS'' END as out_FLAG,
exp_HOLD_SRC.out_CHG_EXP_DT as out_CHG_EXP_DT,
exp_HOLD_SRC.source_record_id
FROM
exp_HOLD_SRC
INNER JOIN LKP_CLMF_CLM_SURVEY_LETTER_CORE ON exp_HOLD_SRC.source_record_id = LKP_CLMF_CLM_SURVEY_LETTER_CORE.source_record_id
);


-- Component mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE, Type MAPPLET 
--MAPPLET NOT REGISTERED: mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE, mapplet instance mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE;
call mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE(''exp_CHECK'');


-- Component rtr_INS_UPD_INS, Type ROUTER Output Group INS
create or replace temporary table rtr_INS_UPD_INS as
SELECT
exp_CHECK.CLAIM_SKEY as CLAIM_SKEY,
exp_CHECK.SRVY_LTR_SKEY_lkp as SRVY_LTR_SKEY_lkp,
exp_CHECK.MRI as MRI,
exp_CHECK.POL_STATE as POL_STATE,
exp_CHECK.PFX as PFX,
exp_CHECK.PNO as PNO,
exp_CHECK.DATE_O_LOSS as DATE_O_LOSS,
exp_CHECK.DATE_O_LOSS_DATE as DATE_O_LOSS_DATE,
exp_CHECK.SEQNO as SEQNO,
exp_CHECK.SL_TYPE_SURVY_L as SL_TYPE_SURVY_L,
exp_CHECK.SL_NAME1_L as SL_NAME1_L,
exp_CHECK.SL_NAME2_L as SL_NAME2_L,
exp_CHECK.SL_ADDRESS_L as SL_ADDRESS_L,
exp_CHECK.SL_CITY_L as SL_CITY_L,
exp_CHECK.SL_STATE_L as SL_STATE_L,
exp_CHECK.SL_ZIP_L as SL_ZIP_L,
exp_CHECK.SL_ZIP_EXT_L as SL_ZIP_EXT_L,
exp_CHECK.SL_DPX_L as SL_DPX_L,
exp_CHECK.SL_DNO_L as SL_DNO_L,
exp_CHECK.SL_LETR_DT_L as SL_LETR_DT_L,
exp_CHECK.SL_LETR_DT_L_DATE as SL_LETR_DT_L_DATE,
exp_CHECK.SL_RET_CODE_L as SL_RET_CODE_L,
exp_CHECK.SL_2ND_3RD_DT_L as SL_2ND_3RD_DT_L,
exp_CHECK.SL_2ND_3RD_DT_L_DATE as SL_2ND_3RD_DT_L_DATE,
exp_CHECK.SL_ADJ_NO_L as SL_ADJ_NO_L,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_PRGM_ID as out_ECTL_PRGM_ID,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_SRC_ID as out_ECTL_SRC_ID,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_SRC_INST_ID as out_ECTL_SRC_INST_ID,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_BATCH_ID as out_ECTL_BATCH_ID,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ORIG_INS_TS as out_ORIG_INS_TS,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_BATCH_START_DATE as out_ECTL_BATCH_START_DATE,
exp_CHECK.out_CHECK as out_CHECK,
exp_CHECK.out_CHG_EFF_DT as out_CHG_EFF_DT,
exp_CHECK.out_CHG_EXP_DT as out_CHG_EXP_DT,
exp_CHECK.CHG_EFF_DT_lkp as CHG_EFF_DT_lkp,
exp_CHECK.out_FLAG as out_FLAG,
exp_CHECK.source_record_id
FROM
exp_CHECK
LEFT JOIN mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE ON exp_CHECK.source_record_id = mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.source_record_id
WHERE exp_CHECK.out_CHECK = ''INS'';


-- Component rtr_INS_UPD_UPD, Type ROUTER Output Group UPD
create or replace temporary table rtr_INS_UPD_UPD as
SELECT
exp_CHECK.CLAIM_SKEY as CLAIM_SKEY,
exp_CHECK.SRVY_LTR_SKEY_lkp as SRVY_LTR_SKEY_lkp,
exp_CHECK.MRI as MRI,
exp_CHECK.POL_STATE as POL_STATE,
exp_CHECK.PFX as PFX,
exp_CHECK.PNO as PNO,
exp_CHECK.DATE_O_LOSS as DATE_O_LOSS,
exp_CHECK.DATE_O_LOSS_DATE as DATE_O_LOSS_DATE,
exp_CHECK.SEQNO as SEQNO,
exp_CHECK.SL_TYPE_SURVY_L as SL_TYPE_SURVY_L,
exp_CHECK.SL_NAME1_L as SL_NAME1_L,
exp_CHECK.SL_NAME2_L as SL_NAME2_L,
exp_CHECK.SL_ADDRESS_L as SL_ADDRESS_L,
exp_CHECK.SL_CITY_L as SL_CITY_L,
exp_CHECK.SL_STATE_L as SL_STATE_L,
exp_CHECK.SL_ZIP_L as SL_ZIP_L,
exp_CHECK.SL_ZIP_EXT_L as SL_ZIP_EXT_L,
exp_CHECK.SL_DPX_L as SL_DPX_L,
exp_CHECK.SL_DNO_L as SL_DNO_L,
exp_CHECK.SL_LETR_DT_L as SL_LETR_DT_L,
exp_CHECK.SL_LETR_DT_L_DATE as SL_LETR_DT_L_DATE,
exp_CHECK.SL_RET_CODE_L as SL_RET_CODE_L,
exp_CHECK.SL_2ND_3RD_DT_L as SL_2ND_3RD_DT_L,
exp_CHECK.SL_2ND_3RD_DT_L_DATE as SL_2ND_3RD_DT_L_DATE,
exp_CHECK.SL_ADJ_NO_L as SL_ADJ_NO_L,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_PRGM_ID as out_ECTL_PRGM_ID,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_SRC_ID as out_ECTL_SRC_ID,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_SRC_INST_ID as out_ECTL_SRC_INST_ID,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_BATCH_ID as out_ECTL_BATCH_ID,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ORIG_INS_TS as out_ORIG_INS_TS,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_BATCH_START_DATE as out_ECTL_BATCH_START_DATE,
exp_CHECK.out_CHECK as out_CHECK,
exp_CHECK.out_CHG_EFF_DT as out_CHG_EFF_DT,
exp_CHECK.out_CHG_EXP_DT as out_CHG_EXP_DT,
exp_CHECK.CHG_EFF_DT_lkp as CHG_EFF_DT_lkp,
exp_CHECK.out_FLAG as out_FLAG,
exp_CHECK.source_record_id
FROM
exp_CHECK
LEFT JOIN mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE ON exp_CHECK.source_record_id = mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.source_record_id
WHERE exp_CHECK.out_CHECK = ''UPD'' AND exp_CHECK.out_FLAG = ''INS'';


-- Component exp_UPD, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_UPD AS
(
SELECT
rtr_INS_UPD_UPD.SRVY_LTR_SKEY_lkp as SRVY_LTR_SKEY_lkp3,
rtr_INS_UPD_UPD.CLAIM_SKEY as CLAIM_SKEY_lkp3,
rtr_INS_UPD_UPD.out_ECTL_BATCH_ID as out_ECTL_BATCH_ID3,
rtr_INS_UPD_UPD.out_ORIG_INS_TS as out_ORIG_INS_TS3,
rtr_INS_UPD_UPD.out_CHECK as out_CHECK3,
dateadd ( day, -1, rtr_INS_UPD_UPD.out_CHG_EFF_DT ) as out_CHG_EXP_DT,
CURRENT_TIMESTAMP as out_ECTL_END_DATE,
rtr_INS_UPD_UPD.CHG_EFF_DT_lkp as CHG_EFF_DT_lkp3,
rtr_INS_UPD_UPD.source_record_id
FROM
rtr_INS_UPD_UPD
);


-- Component exp_INS, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_INS AS
(
SELECT
rtr_INS_UPD_INS.CLAIM_SKEY as CLAIM_SKEY41,
rtr_INS_UPD_INS.MRI as MRI1,
rtr_INS_UPD_INS.POL_STATE as POL_STATE1,
rtr_INS_UPD_INS.PFX as PFX1,
rtr_INS_UPD_INS.PNO as PNO1,
rtr_INS_UPD_INS.DATE_O_LOSS as DATE_O_LOSS1,
rtr_INS_UPD_INS.DATE_O_LOSS_DATE as DATE_O_LOSS_DATE1,
rtr_INS_UPD_INS.SEQNO as SEQNO1,
rtr_INS_UPD_INS.SL_TYPE_SURVY_L as SL_TYPE_SURVY_L1,
rtr_INS_UPD_INS.SL_NAME1_L as SL_NAME1_L1,
rtr_INS_UPD_INS.SL_NAME2_L as SL_NAME2_L1,
rtr_INS_UPD_INS.SL_ADDRESS_L as SL_ADDRESS_L1,
rtr_INS_UPD_INS.SL_CITY_L as SL_CITY_L1,
rtr_INS_UPD_INS.SL_STATE_L as SL_STATE_L1,
rtr_INS_UPD_INS.SL_ZIP_L as SL_ZIP_L1,
rtr_INS_UPD_INS.SL_ZIP_EXT_L as SL_ZIP_EXT_L1,
rtr_INS_UPD_INS.SL_DPX_L as SL_DPX_L1,
rtr_INS_UPD_INS.SL_DNO_L as SL_DNO_L1,
rtr_INS_UPD_INS.SL_LETR_DT_L as SL_LETR_DT_L1,
rtr_INS_UPD_INS.SL_LETR_DT_L_DATE as SL_LETR_DT_L_DATE1,
rtr_INS_UPD_INS.SL_RET_CODE_L as SL_RET_CODE_L1,
rtr_INS_UPD_INS.SL_2ND_3RD_DT_L as SL_2ND_3RD_DT_L1,
rtr_INS_UPD_INS.SL_2ND_3RD_DT_L_DATE as SL_2ND_3RD_DT_L_DATE1,
rtr_INS_UPD_INS.SL_ADJ_NO_L as SL_ADJ_NO_L1,
rtr_INS_UPD_INS.out_ECTL_PRGM_ID as out_ECTL_PRGM_ID1,
rtr_INS_UPD_INS.out_ECTL_SRC_ID as out_ECTL_SRC_ID1,
rtr_INS_UPD_INS.out_ECTL_SRC_INST_ID as out_ECTL_SRC_INST_ID1,
rtr_INS_UPD_INS.out_ECTL_BATCH_ID as out_ECTL_BATCH_ID1,
rtr_INS_UPD_INS.out_ORIG_INS_TS as out_ORIG_INS_TS1,
rtr_INS_UPD_INS.out_ECTL_BATCH_START_DATE as out_ECTL_BATCH_START_DATE1,
TO_DATE ( ''9999-12-31'' , ''YYYY-MM-DD'' ) as out_ECTL_END_DATE,
''NEW'' as out_CHECK,
rtr_INS_UPD_INS.out_CHG_EFF_DT as CHG_EFF_DT,
rtr_INS_UPD_INS.out_CHG_EXP_DT as out_CHG_EXP_DT,
rtr_INS_UPD_INS.source_record_id
FROM
rtr_INS_UPD_INS
);


-- Component exp_UPD_INS, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_UPD_INS AS
(
SELECT
rtr_INS_UPD_UPD.SRVY_LTR_SKEY_lkp as SRVY_LTR_SKEY_lkp3,
rtr_INS_UPD_UPD.CLAIM_SKEY as CLAIM_SKEY_lkp3,
rtr_INS_UPD_UPD.MRI as MRI3,
rtr_INS_UPD_UPD.POL_STATE as POL_STATE3,
rtr_INS_UPD_UPD.PFX as PFX3,
rtr_INS_UPD_UPD.PNO as PNO3,
rtr_INS_UPD_UPD.DATE_O_LOSS as DATE_O_LOSS3,
rtr_INS_UPD_UPD.DATE_O_LOSS_DATE as DATE_O_LOSS_DATE3,
rtr_INS_UPD_UPD.SEQNO as SEQNO3,
rtr_INS_UPD_UPD.SL_TYPE_SURVY_L as SL_TYPE_SURVY_L3,
rtr_INS_UPD_UPD.SL_NAME1_L as SL_NAME1_L3,
rtr_INS_UPD_UPD.SL_NAME2_L as SL_NAME2_L3,
rtr_INS_UPD_UPD.SL_ADDRESS_L as SL_ADDRESS_L3,
rtr_INS_UPD_UPD.SL_CITY_L as SL_CITY_L3,
rtr_INS_UPD_UPD.SL_STATE_L as SL_STATE_L3,
rtr_INS_UPD_UPD.SL_ZIP_L as SL_ZIP_L3,
rtr_INS_UPD_UPD.SL_ZIP_EXT_L as SL_ZIP_EXT_L3,
rtr_INS_UPD_UPD.SL_DPX_L as SL_DPX_L3,
rtr_INS_UPD_UPD.SL_DNO_L as SL_DNO_L3,
rtr_INS_UPD_UPD.SL_LETR_DT_L as SL_LETR_DT_L3,
rtr_INS_UPD_UPD.SL_LETR_DT_L_DATE as SL_LETR_DT_L_DATE3,
rtr_INS_UPD_UPD.SL_RET_CODE_L as SL_RET_CODE_L3,
rtr_INS_UPD_UPD.SL_2ND_3RD_DT_L as SL_2ND_3RD_DT_L3,
rtr_INS_UPD_UPD.SL_2ND_3RD_DT_L_DATE as SL_2ND_3RD_DT_L_DATE3,
rtr_INS_UPD_UPD.SL_ADJ_NO_L as SL_ADJ_NO_L3,
rtr_INS_UPD_UPD.out_ECTL_PRGM_ID as out_ECTL_PRGM_ID3,
rtr_INS_UPD_UPD.out_ECTL_SRC_ID as out_ECTL_SRC_ID3,
rtr_INS_UPD_UPD.out_ECTL_SRC_INST_ID as out_ECTL_SRC_INST_ID3,
rtr_INS_UPD_UPD.out_ECTL_BATCH_ID as out_ECTL_BATCH_ID3,
rtr_INS_UPD_UPD.out_ORIG_INS_TS as out_ORIG_INS_TS3,
rtr_INS_UPD_UPD.out_ECTL_BATCH_START_DATE as out_ECTL_BATCH_START_DATE3,
rtr_INS_UPD_UPD.out_CHG_EFF_DT as CHG_EFF_DT_lkp3,
''NEW'' as out_CHECK3,
TO_DATE ( ''9999-12-31'' , ''YYYY-MM-DD'' ) as out_ECTL_END_DATE,
rtr_INS_UPD_UPD.out_CHG_EXP_DT as out_CHG_EXP_DT3,
rtr_INS_UPD_UPD.source_record_id
FROM
rtr_INS_UPD_UPD
);


-- Component CLMF_CLM_SURVEY_LETTER_CODE_INS, Type TARGET_EXPORT_PREPARE Stage data before exporting
CREATE OR REPLACE TEMPORARY TABLE CLMF_CLM_SURVEY_LETTER_CODE_INS AS
(
SELECT
seq_SKEY_GEN.NEXTVAL as SRVY_LTR_SKEY,
exp_INS.CLAIM_SKEY41 as CLAIM_SKEY,
exp_INS.MRI1 as REC_TYPE,
exp_INS.POL_STATE1 as PLCY_STATE,
exp_INS.PFX1 as PLCY_PREFIX,
exp_INS.PNO1 as PLCY_NBR,
exp_INS.DATE_O_LOSS1 as LOSS_DT,
exp_INS.DATE_O_LOSS_DATE1 as LOSS_DATE,
exp_INS.SEQNO1 as SEQ_NBR,
exp_INS.CHG_EFF_DT as CHG_EFF_DT,
exp_INS.out_CHG_EXP_DT as CHG_EXP_DT,
exp_INS.SL_TYPE_SURVY_L1 as CLM_TYPE_SRVY,
exp_INS.SL_NAME1_L1 as NAME1,
exp_INS.SL_NAME2_L1 as NAME2,
exp_INS.SL_ADDRESS_L1 as ADDRESS,
exp_INS.SL_CITY_L1 as CITY,
exp_INS.SL_STATE_L1 as STATE,
exp_INS.SL_ZIP_L1 as ZIP,
exp_INS.SL_ZIP_EXT_L1 as ZIP_EXT,
exp_INS.SL_DPX_L1 as DRFT_NBR_PFX,
exp_INS.SL_DNO_L1 as DRFT_NBR,
exp_INS.SL_LETR_DT_L1 as LETTER_DT,
exp_INS.SL_LETR_DT_L_DATE1 as LETTER_DATE,
exp_INS.SL_RET_CODE_L1 as RETURN_CODE,
exp_INS.SL_2ND_3RD_DT_L1 as SL_2ND_3RD_DT,
exp_INS.SL_2ND_3RD_DT_L_DATE1 as SL_2ND_3RD_DATE,
exp_INS.SL_ADJ_NO_L1 as ADJ_NBR,
exp_INS.out_ECTL_BATCH_ID1 as ECTL_BATCH_ID,
exp_INS.out_ORIG_INS_TS1 as ECTL_ORIG_INS_TS,
exp_INS.out_ORIG_INS_TS1 as ECTL_MODIFY_TS,
exp_INS.out_ECTL_SRC_ID1 as ECTL_SRC_ID,
exp_INS.out_ECTL_SRC_INST_ID1 as ECTL_SRC_INST_ID,
exp_INS.out_ECTL_PRGM_ID1 as ECTL_PRGM_ID,
exp_INS.out_CHECK as ECTL_TX_CD,
exp_INS.out_ECTL_BATCH_START_DATE1 as ECTL_START_DATE,
exp_INS.out_ECTL_END_DATE as ECTL_END_DATE
FROM
exp_INS
);

copy into @public.edw_stage/CLMF_CLM_SURVEY_LETTER_CODE_INS from (select * from CLMF_CLM_SURVEY_LETTER_CODE_INS)
header=true
overwrite=true;

-- Component CLMF_CLM_SURVEY_LETTER_CODE_INS, Type EXPORT_DATA Exporting data
;


-- Component CLMF_CLM_SURVEY_LETTER_CODE_UPD_NK, Type TARGET 
INSERT INTO DB_T_CORE_PROD.CLMF_CLM_SURVEY_LETTER_CORE
(
SRVY_LTR_SKEY,
CLAIM_SKEY,
REC_TYPE,
PLCY_STATE,
PLCY_PREFIX,
PLCY_NBR,
LOSS_DT,
LOSS_DATE,
SEQ_NBR,
CHG_EFF_DT,
CHG_EXP_DT,
CLM_TYPE_SRVY,
NAME1,
NAME2,
ADDRESS,
CITY,
STATE,
ZIP,
ZIP_EXT,
DRFT_NBR_PFX,
DRFT_NBR,
LETTER_DT,
LETTER_DATE,
RETURN_CODE,
SL_2ND_3RD_DT,
SL_2ND_3RD_DATE,
ADJ_NBR,
ECTL_BATCH_ID,
ECTL_ORIG_INS_TS,
ECTL_MODIFY_TS,
ECTL_SRC_ID,
ECTL_SRC_INST_ID,
ECTL_PRGM_ID,
ECTL_TX_CD,
ECTL_START_DATE,
ECTL_END_DATE
)
SELECT
exp_UPD_INS.SRVY_LTR_SKEY_lkp3 as SRVY_LTR_SKEY,
exp_UPD_INS.CLAIM_SKEY_lkp3 as CLAIM_SKEY,
exp_UPD_INS.MRI3 as REC_TYPE,
exp_UPD_INS.POL_STATE3 as PLCY_STATE,
exp_UPD_INS.PFX3 as PLCY_PREFIX,
exp_UPD_INS.PNO3 as PLCY_NBR,
exp_UPD_INS.DATE_O_LOSS3 as LOSS_DT,
exp_UPD_INS.DATE_O_LOSS_DATE3 as LOSS_DATE,
exp_UPD_INS.SEQNO3 as SEQ_NBR,
exp_UPD_INS.CHG_EFF_DT_lkp3 as CHG_EFF_DT,
exp_UPD_INS.out_CHG_EXP_DT3 as CHG_EXP_DT,
exp_UPD_INS.SL_TYPE_SURVY_L3 as CLM_TYPE_SRVY,
exp_UPD_INS.SL_NAME1_L3 as NAME1,
exp_UPD_INS.SL_NAME2_L3 as NAME2,
exp_UPD_INS.SL_ADDRESS_L3 as ADDRESS,
exp_UPD_INS.SL_CITY_L3 as CITY,
exp_UPD_INS.SL_STATE_L3 as STATE,
exp_UPD_INS.SL_ZIP_L3 as ZIP,
exp_UPD_INS.SL_ZIP_EXT_L3 as ZIP_EXT,
exp_UPD_INS.SL_DPX_L3 as DRFT_NBR_PFX,
exp_UPD_INS.SL_DNO_L3 as DRFT_NBR,
exp_UPD_INS.SL_LETR_DT_L3 as LETTER_DT,
exp_UPD_INS.SL_LETR_DT_L_DATE3 as LETTER_DATE,
exp_UPD_INS.SL_RET_CODE_L3 as RETURN_CODE,
exp_UPD_INS.SL_2ND_3RD_DT_L3 as SL_2ND_3RD_DT,
exp_UPD_INS.SL_2ND_3RD_DT_L_DATE3 as SL_2ND_3RD_DATE,
exp_UPD_INS.SL_ADJ_NO_L3 as ADJ_NBR,
exp_UPD_INS.out_ECTL_BATCH_ID3 as ECTL_BATCH_ID,
exp_UPD_INS.out_ORIG_INS_TS3 as ECTL_ORIG_INS_TS,
exp_UPD_INS.out_ORIG_INS_TS3 as ECTL_MODIFY_TS,
exp_UPD_INS.out_ECTL_SRC_ID3 as ECTL_SRC_ID,
exp_UPD_INS.out_ECTL_SRC_INST_ID3 as ECTL_SRC_INST_ID,
exp_UPD_INS.out_ECTL_PRGM_ID3 as ECTL_PRGM_ID,
exp_UPD_INS.out_CHECK3 as ECTL_TX_CD,
exp_UPD_INS.out_ECTL_BATCH_START_DATE3 as ECTL_START_DATE,
exp_UPD_INS.out_ECTL_END_DATE as ECTL_END_DATE
FROM
exp_UPD_INS;


-- Component upd_TARGET, Type UPDATE 
CREATE OR REPLACE TEMPORARY TABLE upd_TARGET AS
(
/* UPDATE_STRATEGY_ACTION = 0 FOR INSERT / UPDATE_STRATEGY_ACTION = 1 FOR UPDATE / UPDATE_STRATEGY_ACTION = 2 FOR DELETE / UPDATE_STRATEGY_ACTION = 3 FOR REJECT */
SELECT
exp_UPD.SRVY_LTR_SKEY_lkp3 as SRVY_LTR_SKEY_lkp3,
exp_UPD.CLAIM_SKEY_lkp3 as CLAIM_SKEY_lkp3,
exp_UPD.out_CHECK3 as out_CHECK3,
exp_UPD.out_ECTL_BATCH_ID3 as out_ECTL_BATCH_ID3,
exp_UPD.out_ORIG_INS_TS3 as out_ORIG_INS_TS3,
exp_UPD.out_CHG_EXP_DT as out_CHG_EXP_DT,
exp_UPD.out_ECTL_END_DATE as out_ECTL_END_DATE,
exp_UPD.CHG_EFF_DT_lkp3 as CHG_EFF_DT_lkp3,
1 as UPDATE_STRATEGY_ACTION
FROM
exp_UPD
);


-- Component CLMF_CLM_SURVEY_LETTER_CODE_UPD, Type TARGET 
/* Perform Updates */
MERGE INTO DB_T_CORE_PROD.CLMF_CLM_SURVEY_LETTER_CORE
USING upd_TARGET
ON (SRVY_LTR_SKEY = upd_TARGET.SRVY_LTR_SKEY_lkp3 and CHG_EFF_DT = upd_TARGET.CHG_EFF_DT_lkp3 and CLAIM_SKEY =upd_TARGET.CLAIM_SKEY_lkp3)
WHEN MATCHED THEN UPDATE SET
CHG_EXP_DT = upd_TARGET.out_CHG_EXP_DT, ECTL_BATCH_ID = upd_TARGET.out_ECTL_BATCH_ID3, ECTL_MODIFY_TS = upd_TARGET.out_ORIG_INS_TS3, 
--ECTL_TX_CD = upd_TARGET.ECTL_TX_CD, 
ECTL_END_DATE = upd_TARGET.out_ECTL_END_DATE;




END; ';