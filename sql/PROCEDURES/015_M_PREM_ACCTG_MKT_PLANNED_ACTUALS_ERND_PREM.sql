-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_PREM_ACCTG_MKT_PLANNED_ACTUALS_ERND_PREM("PARAM_JSON" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' 
DECLARE
  RUN_DATE STRING;
  LOOKBACK_YR STRING;
BEGIN
  SELECT 
    TRY_PARSE_JSON(:param_json):RUN_DATE::STRING,
    TRY_PARSE_JSON(:param_json):LOOKBACK_YR::STRING
  INTO
    RUN_DATE,
    LOOKBACK_YR;

-- Component SQ_FIN_MANUAL_ENTRIES_PREMIUM_TXN, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_FIN_MANUAL_ENTRIES_PREMIUM_TXN AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as MTRC,
$2 as ST_CD,
$3 as SEGMENT,
$4 as LOB_GRP,
$5 as PRD,
$6 as YR,
$7 as ACTUAL_AMT,
$8 as PLND_AMT,
$9 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT MTRC, ST_CD, SEGMENT, LOB_GRP, PRD, YR, ACTUAL_AMT, Sum(PLND_AMT) AS PLND_AMT

FROM

(

SELECT ACTL.MTRC AS MTRC, ACTL.ST_CD AS ST_CD, ACTL.SEGMENT AS SEGMENT, ACTL.LOB_GRP AS LOB_GRP, ACTL.PRD AS PRD, ACTL.YR AS YR, ACTL.ACTUAL_AMT AS ACTUAL_AMT, 

CASE WHEN (PLAN.PLND_AMT*-1) > 0 THEN (PLAN.PLND_AMT*-1) ELSE 0 END AS PLND_AMT FROM



(SELECT  ''EARN'' AS MTRC, 

ST_CD, 

CASE WHEN (LOB_CD = ''PA'' AND SUBSTR(PROD_CD,1,2) <> ''CA'') THEN ''AUTO''

WHEN LOB_CD IN (''HO'',''MH'',''RFD'',''SF'',''FOP'',''MACHINERY'') THEN ''PROPERTY'' /* Added ''FARMOWNERS'', ''FOP'', ''MACHINERY'' as part of EIM-49071, EIM-50215 */
ELSE ''COMMERCIAL/OTHER'' END AS LOB_GRP,

CASE WHEN UNDRWRTG_CO_CD IN (''ASI'',''AVI'') THEN ''TREXIS'' 

ELSE ''CORE'' END AS SEGMENT,

EXTRACT(MONTH FROM CAL_DT) AS PRD, 

EXTRACT(YEAR FROM CAL_DT) AS YR, 

SUM(ERND_PREM) AS ACTUAL_AMT

FROM    DB_T_PROD_STAG.F_FIN_PREM_LOSS_MTHLY A

JOIN  DB_T_PROD_STAG.D_FIN_PREM_LOSS_MTHLY B ON A.DIM_SKEY = B.DIM_SKEY

WHERE  

A.SRC_TYPE_CD NOT IN (''MAN-REIN'')

AND ST_CD IN (''AL'',''GA'',''MS'')

AND ltrim(rtrim(YR))||lpad(ltrim(rtrim(PRD)),2,''0'') >=cast(cast(extract( year from ADD_MONTHS(:RUN_DATE,-1) )-:LOOKBACK_YR as varchar(4)) ||''01'' as varchar(6)) 

AND LPAD(TRIM(YR), 4, ''0'') || LPAD(TRIM(PRD), 2, ''0'') <= TO_CHAR(DATEADD(MONTH, -1, :RUN_DATE), ''YYYYMM'')

GROUP BY 2,3,4,5,6) ACTL



LEFT JOIN DB_T_CORE_FIN_PROD.PLANNED_PREM PLAN

ON PLAN.LOB_GRP = ACTL.LOB_GRP 

AND PLAN.MTRC = ACTL.MTRC 

AND PLAN.ST_CD = ACTL.ST_CD 

AND PLAN.SEGMENT = ACTL.SEGMENT 

AND PLAN.YR = ACTL.YR 

AND PLAN.PRD = ACTL.PRD 

WHERE ACTL.MTRC = ''EARN''

AND

ltrim(rtrim(PLAN.YR))||lpad(ltrim(rtrim(PLAN.PRD)),2,''0'') >=cast(cast(extract( year from ADD_MONTHS(:RUN_DATE,-1) )-:LOOKBACK_YR as varchar(4)) ||''01'' as varchar(6)) 

AND LPAD(TRIM(PLAN.YR), 4, ''0'') || LPAD(TRIM(PLAN.PRD), 2, ''0'') <= TO_CHAR(DATEADD(MONTH, -1, :RUN_DATE), ''YYYYMM'')

)MAIN

GROUP BY MTRC, ST_CD, SEGMENT, LOB_GRP, PRD, YR, ACTUAL_AMT

ORDER BY 6,5,1,2,3
) SRC
)
);


-- Component exp_MOVE_DATA, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_MOVE_DATA AS
(
SELECT
SQ_FIN_MANUAL_ENTRIES_PREMIUM_TXN.MTRC as MTRC,
SQ_FIN_MANUAL_ENTRIES_PREMIUM_TXN.ST_CD as ST_CD,
SQ_FIN_MANUAL_ENTRIES_PREMIUM_TXN.SEGMENT as SEGMENT,
SQ_FIN_MANUAL_ENTRIES_PREMIUM_TXN.LOB_GRP as LOB_GRP,
SQ_FIN_MANUAL_ENTRIES_PREMIUM_TXN.PRD as PRD,
SQ_FIN_MANUAL_ENTRIES_PREMIUM_TXN.YR as YR,
SQ_FIN_MANUAL_ENTRIES_PREMIUM_TXN.ACTUAL_AMT as ACTUAL_AMT,
SQ_FIN_MANUAL_ENTRIES_PREMIUM_TXN.PLND_AMT as PLND_AMT,
SQ_FIN_MANUAL_ENTRIES_PREMIUM_TXN.source_record_id
FROM
SQ_FIN_MANUAL_ENTRIES_PREMIUM_TXN
);


-- Component PREM_ACTTG_MKT_ERND_PREM, Type TARGET_EXPORT_PREPARE Stage data before exporting
CREATE OR REPLACE TEMPORARY TABLE PREM_ACTTG_MKT_ERND_PREM AS
(
SELECT
exp_MOVE_DATA.MTRC as MTRC,
exp_MOVE_DATA.ST_CD as ST_CD,
exp_MOVE_DATA.SEGMENT as SEGMENT,
exp_MOVE_DATA.LOB_GRP as LOB_GRP,
exp_MOVE_DATA.PRD as PRD,
exp_MOVE_DATA.YR as YEAR,
exp_MOVE_DATA.ACTUAL_AMT as ACTUAL_AMT,
exp_MOVE_DATA.PLND_AMT as PLND_AMT
FROM
exp_MOVE_DATA
);


-- Component PREM_ACTTG_MKT_ERND_PREM, Type EXPORT_DATA Exporting data
;


END; ';