-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_STG_TREXIS_PREM_LOSS("RUN_ID" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' BEGIN 

-- Component sq_TREXIS_PREM_LOSS, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE sq_TREXIS_PREM_LOSS AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as MonthID,
$2 as PolNum,
$3 as LOB,
$4 as LOBDescription,
$5 as TermEffDate,
$6 as LossDateMonth,
$7 as CatCode,
$8 as WrittenPrem,
$9 as EarnedPrem,
$10 as IncurredLoss,
$11 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT
VISION_PREM_LOSS.MO_ID as MonthID,
VISION_PREM_LOSS.PLCY_NBR PolNum,
VISION_PREM_LOSS.LOB,
VISION_PREM_LOSS.LOB_DESC LOBDescription,
VISION_PREM_LOSS.TERM_EFF_DT TermEffDate,
VISION_PREM_LOSS.LOSS_DT_MNTH LossDateMonth,
VISION_PREM_LOSS.CAT_CD CatCode,
VISION_PREM_LOSS.WRIT_PREM WrittenPrem,
VISION_PREM_LOSS.ERND_PREM EarnedPrem,
VISION_PREM_LOSS.INCUR_LOSS IncurredLoss
FROM DB_T_CORE_PROD.VISION_PREM_LOSS
) SRC
)
);


-- Component STG_TREXIS_PREM_LOSS, Type TARGET 
INSERT INTO DB_T_STAG_PROD.STG_VISION_PREM_LOSS
(
MONTH_ID,
PLCY_NBR,
LOB,
LOB_DESC,
TERM_EFF_DT,
LOSS_DT_MNTH,
CAT_CD,
WRIT_PREM,
ERND_PREM,
INCUR_LOSS
)
SELECT
sq_TREXIS_PREM_LOSS.MonthID as MONTH_ID,
sq_TREXIS_PREM_LOSS.PolNum as PLCY_NBR,
sq_TREXIS_PREM_LOSS.LOB as LOB,
sq_TREXIS_PREM_LOSS.LOBDescription as LOB_DESC,
sq_TREXIS_PREM_LOSS.TermEffDate as TERM_EFF_DT,
sq_TREXIS_PREM_LOSS.LossDateMonth as LOSS_DT_MNTH,
sq_TREXIS_PREM_LOSS.CatCode as CAT_CD,
sq_TREXIS_PREM_LOSS.WrittenPrem as WRIT_PREM,
sq_TREXIS_PREM_LOSS.EarnedPrem as ERND_PREM,
sq_TREXIS_PREM_LOSS.IncurredLoss as INCUR_LOSS
FROM
sq_TREXIS_PREM_LOSS;


-- Component agg_RECORD_CNT, Type AGGREGATOR 
CREATE OR REPLACE TEMPORARY TABLE agg_RECORD_CNT AS
(
SELECT
MIN(sq_TREXIS_PREM_LOSS.PolNum) as PolNum,
MIN(sq_TREXIS_PREM_LOSS.MonthID) as MONTHID,
count(PolNum) as out_RECORD_CNT,
max(MONTHID) as out_MO_ID,
MIN(sq_TREXIS_PREM_LOSS.source_record_id) as source_record_id
FROM
sq_TREXIS_PREM_LOSS
);


-- Component exp_TRG_FILE, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_TRG_FILE AS
(
SELECT
''M'' as FEED,
agg_RECORD_CNT.out_MO_ID as MO_ID,
agg_RECORD_CNT.out_RECORD_CNT as RECORD_CNT,
agg_RECORD_CNT.source_record_id
FROM
agg_RECORD_CNT
);


-- Component TRG_TREXIS_PREM_LOSS, Type TARGET_EXPORT_PREPARE Stage data before exporting
CREATE OR REPLACE TEMPORARY TABLE TRG_TREXIS_PREM_LOSS AS
(
SELECT
exp_TRG_FILE.FEED as FEED,
exp_TRG_FILE.MO_ID as MOID,
exp_TRG_FILE.RECORD_CNT as COUNT
FROM
exp_TRG_FILE
);


-- Component TRG_TREXIS_PREM_LOSS, Type EXPORT_DATA Exporting data

COPY INTO @public.edw_stage/my_export_folder/TRG_TREXIS_PREM_LOSS_
FROM (SELECT * FROM TRG_TREXIS_PREM_LOSS)
HEADER = TRUE
OVERWRITE = TRUE;

END; ';