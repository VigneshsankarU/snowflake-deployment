-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_STG_FIN_S3C("RUN_ID" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' BEGIN 

-- Component sq_PS_ALF_REPOS_S3C_S, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE sq_PS_ALF_REPOS_S3C_S AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as BUSINESS_UNIT,
$2 as TRANSACTION_ID,
$3 as DTTM_STAMP,
$4 as ALF_REC_COUNTER,
$5 as LEDGER_GROUP,
$6 as LEDGER,
$7 as JOURNAL_ID,
$8 as JOURNAL_LINE,
$9 as FISCAL_YEAR,
$10 as ACCOUNTING_PERIOD,
$11 as JOURNAL_DATE,
$12 as ACCOUNT_CD,
$13 as DEPTID,
$14 as PRODUCT,
$15 as PROJECT_ID,
$16 as CHARTFIELD1,
$17 as CHARTFIELD2,
$18 as CHARTFIELD3,
$19 as AFFILIATE,
$20 as ALF_POL_SYMBOL,
$21 as ALF_POLICY_NBR,
$22 as ALF_COV_TYPE,
$23 as ALF_AGT_NBR,
$24 as ALF_SERV_CTR_NBR,
$25 as ALF_COMPANY_CD,
$26 as ALF_TRANS_OBJ_CD,
$27 as ALF_TRANS_ACT_CD,
$28 as ALF_LOB_CD,
$29 as ALF_POLICY_ID,
$30 as ALF_CLAIM_NBR,
$31 as ALF_CLAIMENT_ID,
$32 as ALF_CLAIM_OBJ_TYPE,
$33 as ALF_CLAIM_OBJ_SEQ,
$34 as ALF_ADJUSTER_NBR,
$35 as ALF_DATE_OF_LOSS,
$36 as ALF_LAWSUIT_CD,
$37 as ALF_MICRO_ECD_NBR,
$38 as ALF_POOL_CD,
$39 as ALF_CAT_POOL_LVL,
$40 as ALF_CAT_POOL_YYYY,
$41 as ALF_ACCT_DT,
$42 as MONETARY_AMOUNT,
$43 as CURRENCY_CD,
$44 as STATISTIC_AMOUNT,
$45 as STATISTICS_CODE,
$46 as FOREIGN_AMOUNT,
$47 as FOREIGN_CURRENCY,
$48 as APPL_JRNL_ID,
$49 as BUSINESS_UNIT_GL,
$50 as ACCOUNTING_DT,
$51 as GL_DISTRIB_STATUS,
$52 as JRNL_LN_REF,
$53 as JRNL_DESCR,
$54 as PROCESS_INSTANCE,
$55 as ALF_OFFSET_IND,
$56 as ALF_GW_PLCY_TYPE,
$57 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT 

TRIM(PS_ALF_REPOS_S3C_S.BUSINESS_UNIT), 

TRIM(PS_ALF_REPOS_S3C_S.TRANSACTION_ID), 

PS_ALF_REPOS_S3C_S.DTTM_STAMP, 

PS_ALF_REPOS_S3C_S.ALF_REC_COUNTER, 

TRIM(PS_ALF_REPOS_S3C_S.LEDGER_GROUP), 

TRIM(PS_ALF_REPOS_S3C_S.LEDGER), 

TRIM(PS_ALF_REPOS_S3C_S.JOURNAL_ID), 

PS_ALF_REPOS_S3C_S.JOURNAL_LINE, 

PS_ALF_REPOS_S3C_S.FISCAL_YEAR, 

PS_ALF_REPOS_S3C_S.ACCOUNTING_PERIOD, 

PS_ALF_REPOS_S3C_S.JOURNAL_DATE, 

TRIM(PS_ALF_REPOS_S3C_S.ACCOUNT_CD), 

TRIM(PS_ALF_REPOS_S3C_S.DEPTID), 

TRIM(PS_ALF_REPOS_S3C_S.PRODUCT), 

TRIM(PS_ALF_REPOS_S3C_S.PROJECT_ID), 

TRIM(PS_ALF_REPOS_S3C_S.CHARTFIELD1), 

TRIM(PS_ALF_REPOS_S3C_S.CHARTFIELD2), 

TRIM(PS_ALF_REPOS_S3C_S.CHARTFIELD3), 

TRIM(PS_ALF_REPOS_S3C_S.AFFILIATE), 

TRIM(PS_ALF_REPOS_S3C_S.ALF_POL_SYMBOL), 

TRIM(PS_ALF_REPOS_S3C_S.ALF_POLICY_NBR), 

TRIM(PS_ALF_REPOS_S3C_S.ALF_COV_TYPE), 

TRIM(PS_ALF_REPOS_S3C_S.ALF_AGT_NBR), 

TRIM(PS_ALF_REPOS_S3C_S.ALF_SERV_CTR_NBR), 

TRIM(PS_ALF_REPOS_S3C_S.ALF_COMPANY_CD), 

TRIM(PS_ALF_REPOS_S3C_S.ALF_TRANS_OBJ_CD), 

TRIM(PS_ALF_REPOS_S3C_S.ALF_TRANS_ACT_CD), 

TRIM(PS_ALF_REPOS_S3C_S.ALF_LOB_CD), 

TRIM(PS_ALF_REPOS_S3C_S.ALF_POLICY_ID), 

TRIM(PS_ALF_REPOS_S3C_S.ALF_CLAIM_NBR), 

TRIM(PS_ALF_REPOS_S3C_S.ALF_CLAIMENT_ID), 

TRIM(PS_ALF_REPOS_S3C_S.ALF_CLAIM_OBJ_TYPE), 

PS_ALF_REPOS_S3C_S.ALF_CLAIM_OBJ_SEQ, 

TRIM(PS_ALF_REPOS_S3C_S.ALF_ADJUSTER_NBR), 

PS_ALF_REPOS_S3C_S.ALF_DATE_OF_LOSS, 

TRIM(PS_ALF_REPOS_S3C_S.ALF_LAWSUIT_CD), 

TRIM(PS_ALF_REPOS_S3C_S.ALF_MICRO_ECD_NBR), 

TRIM(PS_ALF_REPOS_S3C_S.ALF_POOL_CD), 

PS_ALF_REPOS_S3C_S.ALF_CAT_POOL_LVL, 

PS_ALF_REPOS_S3C_S.ALF_CAT_POOL_YYYY, 

PS_ALF_REPOS_S3C_S.ALF_ACCT_DT, 

PS_ALF_REPOS_S3C_S.MONETARY_AMOUNT, 

TRIM(PS_ALF_REPOS_S3C_S.CURRENCY_CD), 

PS_ALF_REPOS_S3C_S.STATISTIC_AMOUNT, 

TRIM(PS_ALF_REPOS_S3C_S.STATISTICS_CODE), 

PS_ALF_REPOS_S3C_S.FOREIGN_AMOUNT, 

TRIM(PS_ALF_REPOS_S3C_S.FOREIGN_CURRENCY), 

TRIM(PS_ALF_REPOS_S3C_S.APPL_JRNL_ID), 

TRIM(PS_ALF_REPOS_S3C_S.BUSINESS_UNIT_GL), 

PS_ALF_REPOS_S3C_S.ACCOUNTING_DT, 

TRIM(PS_ALF_REPOS_S3C_S.GL_DISTRIB_STATUS), 

TRIM(PS_ALF_REPOS_S3C_S.JRNL_LN_REF), 

TRIM(PS_ALF_REPOS_S3C_S.JRNL_DESCR), 

PS_ALF_REPOS_S3C_S.PROCESS_INSTANCE, 

TRIM(PS_ALF_REPOS_S3C_S.ALF_OFFSET_IND) ,

TRIM(PS_ALF_REPOS_S3C_S.ALF_GW_POLICY_TYPE) 

FROM

 DB_T_STAG_FIN_PROD.PS_ALF_REPOS_S3C_S

WHERE TRIM(PS_ALF_REPOS_S3C_S.FISCAL_YEAR) = (SELECT ECTL_PARAM_VALUE FROM DB_T_CTRL_FIN_PROD.ECTL_PRGM_PARAM WHERE ECTL_PARAM_DESC=''ACCOUNTING_YEAR'') AND TRIM( PS_ALF_REPOS_S3C_S.ACCOUNTING_PERIOD) = (SELECT ECTL_PARAM_VALUE FROM DB_T_CTRL_FIN_PROD.ECTL_PRGM_PARAM WHERE ECTL_PARAM_DESC=''ACCOUNTING_MONTH'')
) SRC
)
);


-- Component STG_FIN_S3C_INS, Type TARGET 
INSERT INTO DB_T_STAG_FIN_PROD.STG_FIN_S3C
(
BUSINESS_UNIT,
TRANSACTION_ID,
DTTM_STAMP,
ALF_REC_COUNTER,
LEDGER_GROUP,
LEDGER,
JOURNAL_ID,
JOURNAL_LINE,
FISCAL_YEAR,
ACCOUNTING_PERIOD,
JOURNAL_DATE,
ACCOUNT_NBR,
DEPTID,
PRODUCT,
PROJECT_ID,
CHARTFIELD1,
CHARTFIELD2,
CHARTFIELD3,
AFFILIATE,
ALF_POL_SYMBOL,
ALF_POLICY_NBR,
ALF_COV_TYPE,
ALF_AGT_NBR,
ALF_SERV_CTR_NBR,
ALF_COMPANY_CD,
ALF_TRANS_OBJ_CD,
ALF_TRANS_ACT_CD,
ALF_LOB_CD,
ALF_POLICY_ID,
ALF_CLAIM_NBR,
ALF_CLAIMENT_ID,
ALF_CLAIM_OBJ_TYPE,
ALF_CLAIM_OBJ_SEQ,
ALF_ADJUSTER_NBR,
ALF_DATE_OF_LOSS,
ALF_LAWSUIT_CD,
ALF_MICRO_ECD_NBR,
ALF_POOL_CD,
ALF_CAT_POOL_LVL,
ALF_CAT_POOL_YYYY,
ALF_ACCT_DT,
MONETARY_AMOUNT,
CURRENCY_CD,
STATISTIC_AMOUNT,
STATISTICS_CODE,
FOREIGN_AMOUNT,
FOREIGN_CURRENCY,
APPL_JRNL_ID,
BUSINESS_UNIT_GL,
ACCOUNTING_DT,
GL_DISTRIB_STATUS,
JRNL_LN_REF,
JRNL_DESCR,
PROCESS_INSTANCE,
ALF_OFFSET_IND,
ALF_GW_POLICY_TYPE
)
SELECT
sq_PS_ALF_REPOS_S3C_S.BUSINESS_UNIT as BUSINESS_UNIT,
sq_PS_ALF_REPOS_S3C_S.TRANSACTION_ID as TRANSACTION_ID,
sq_PS_ALF_REPOS_S3C_S.DTTM_STAMP as DTTM_STAMP,
sq_PS_ALF_REPOS_S3C_S.ALF_REC_COUNTER as ALF_REC_COUNTER,
sq_PS_ALF_REPOS_S3C_S.LEDGER_GROUP as LEDGER_GROUP,
sq_PS_ALF_REPOS_S3C_S.LEDGER as LEDGER,
sq_PS_ALF_REPOS_S3C_S.JOURNAL_ID as JOURNAL_ID,
sq_PS_ALF_REPOS_S3C_S.JOURNAL_LINE as JOURNAL_LINE,
sq_PS_ALF_REPOS_S3C_S.FISCAL_YEAR as FISCAL_YEAR,
sq_PS_ALF_REPOS_S3C_S.ACCOUNTING_PERIOD as ACCOUNTING_PERIOD,
sq_PS_ALF_REPOS_S3C_S.JOURNAL_DATE as JOURNAL_DATE,
sq_PS_ALF_REPOS_S3C_S.ACCOUNT_CD as ACCOUNT_NBR,
sq_PS_ALF_REPOS_S3C_S.DEPTID as DEPTID,
sq_PS_ALF_REPOS_S3C_S.PRODUCT as PRODUCT,
sq_PS_ALF_REPOS_S3C_S.PROJECT_ID as PROJECT_ID,
sq_PS_ALF_REPOS_S3C_S.CHARTFIELD1 as CHARTFIELD1,
sq_PS_ALF_REPOS_S3C_S.CHARTFIELD2 as CHARTFIELD2,
sq_PS_ALF_REPOS_S3C_S.CHARTFIELD3 as CHARTFIELD3,
sq_PS_ALF_REPOS_S3C_S.AFFILIATE as AFFILIATE,
sq_PS_ALF_REPOS_S3C_S.ALF_POL_SYMBOL as ALF_POL_SYMBOL,
sq_PS_ALF_REPOS_S3C_S.ALF_POLICY_NBR as ALF_POLICY_NBR,
sq_PS_ALF_REPOS_S3C_S.ALF_COV_TYPE as ALF_COV_TYPE,
sq_PS_ALF_REPOS_S3C_S.ALF_AGT_NBR as ALF_AGT_NBR,
sq_PS_ALF_REPOS_S3C_S.ALF_SERV_CTR_NBR as ALF_SERV_CTR_NBR,
sq_PS_ALF_REPOS_S3C_S.ALF_COMPANY_CD as ALF_COMPANY_CD,
sq_PS_ALF_REPOS_S3C_S.ALF_TRANS_OBJ_CD as ALF_TRANS_OBJ_CD,
sq_PS_ALF_REPOS_S3C_S.ALF_TRANS_ACT_CD as ALF_TRANS_ACT_CD,
sq_PS_ALF_REPOS_S3C_S.ALF_LOB_CD as ALF_LOB_CD,
sq_PS_ALF_REPOS_S3C_S.ALF_POLICY_ID as ALF_POLICY_ID,
sq_PS_ALF_REPOS_S3C_S.ALF_CLAIM_NBR as ALF_CLAIM_NBR,
sq_PS_ALF_REPOS_S3C_S.ALF_CLAIMENT_ID as ALF_CLAIMENT_ID,
sq_PS_ALF_REPOS_S3C_S.ALF_CLAIM_OBJ_TYPE as ALF_CLAIM_OBJ_TYPE,
sq_PS_ALF_REPOS_S3C_S.ALF_CLAIM_OBJ_SEQ as ALF_CLAIM_OBJ_SEQ,
sq_PS_ALF_REPOS_S3C_S.ALF_ADJUSTER_NBR as ALF_ADJUSTER_NBR,
sq_PS_ALF_REPOS_S3C_S.ALF_DATE_OF_LOSS as ALF_DATE_OF_LOSS,
sq_PS_ALF_REPOS_S3C_S.ALF_LAWSUIT_CD as ALF_LAWSUIT_CD,
sq_PS_ALF_REPOS_S3C_S.ALF_MICRO_ECD_NBR as ALF_MICRO_ECD_NBR,
sq_PS_ALF_REPOS_S3C_S.ALF_POOL_CD as ALF_POOL_CD,
sq_PS_ALF_REPOS_S3C_S.ALF_CAT_POOL_LVL as ALF_CAT_POOL_LVL,
sq_PS_ALF_REPOS_S3C_S.ALF_CAT_POOL_YYYY as ALF_CAT_POOL_YYYY,
sq_PS_ALF_REPOS_S3C_S.ALF_ACCT_DT as ALF_ACCT_DT,
sq_PS_ALF_REPOS_S3C_S.MONETARY_AMOUNT as MONETARY_AMOUNT,
sq_PS_ALF_REPOS_S3C_S.CURRENCY_CD as CURRENCY_CD,
sq_PS_ALF_REPOS_S3C_S.STATISTIC_AMOUNT as STATISTIC_AMOUNT,
sq_PS_ALF_REPOS_S3C_S.STATISTICS_CODE as STATISTICS_CODE,
sq_PS_ALF_REPOS_S3C_S.FOREIGN_AMOUNT as FOREIGN_AMOUNT,
sq_PS_ALF_REPOS_S3C_S.FOREIGN_CURRENCY as FOREIGN_CURRENCY,
sq_PS_ALF_REPOS_S3C_S.APPL_JRNL_ID as APPL_JRNL_ID,
sq_PS_ALF_REPOS_S3C_S.BUSINESS_UNIT_GL as BUSINESS_UNIT_GL,
sq_PS_ALF_REPOS_S3C_S.ACCOUNTING_DT as ACCOUNTING_DT,
sq_PS_ALF_REPOS_S3C_S.GL_DISTRIB_STATUS as GL_DISTRIB_STATUS,
sq_PS_ALF_REPOS_S3C_S.JRNL_LN_REF as JRNL_LN_REF,
sq_PS_ALF_REPOS_S3C_S.JRNL_DESCR as JRNL_DESCR,
sq_PS_ALF_REPOS_S3C_S.PROCESS_INSTANCE as PROCESS_INSTANCE,
sq_PS_ALF_REPOS_S3C_S.ALF_OFFSET_IND as ALF_OFFSET_IND,
sq_PS_ALF_REPOS_S3C_S.ALF_GW_PLCY_TYPE as ALF_GW_POLICY_TYPE
FROM
sq_PS_ALF_REPOS_S3C_S;


END; ';