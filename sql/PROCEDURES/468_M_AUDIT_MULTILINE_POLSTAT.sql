-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_AUDIT_MULTILINE_POLSTAT("RUN_ID" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' DECLARE SRC_NM varchar;
TGT_NM varchar;
SRC_FLTR_VAR varchar;
TGT_FLTR_VAR varchar;
ACT_PROJ_ID varchar;
ECTL_ACTIVE_IND varchar;
PRGM_NM varchar;
BATCH_ACTIVE_IND varchar;

BEGIN 

SRC_NM:=''DB_T_CTRL_FIN_PROD.ECTL_BATCH_INFO''; 
TGT_NM:=''DB_T_CTRL_FIN_PROD.ECTL_BATCH_INFO''; 
SRC_FLTR_VAR:='' ''; 
TGT_FLTR_VAR:='' ''; 
ECTL_ACTIVE_IND:='' ''; 
PRGM_NM:='' ''; 
BATCH_ACTIVE_IND:=(select ectl_active_ind from DB_T_CTRL_FIN_PROD.ECTL_BATCH_INFO where ECTL_BATCH_ID= :run_id); 
ACT_PROJ_ID:=(select ectl_proj_id from DB_T_CTRL_FIN_PROD.ECTL_BATCH_INFO where ECTL_BATCH_ID= :run_id); 


-- Component sq_SRC_TABLE, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE sq_SRC_TABLE AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as SRC_CNT,
$2 as DUMMY,
$3 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT COUNT(*) SRC_CNT,''1'' AS DUMMY FROM table(:SRC_NM) --WHERE 
--SRC_FLTR_VAR 
GROUP BY 2
) SRC
)
);


-- Component exp_INT_CON_SRC_TABLE, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_INT_CON_SRC_TABLE AS
(
SELECT
TO_NUMBER(LTRIM ( RTRIM ( sq_SRC_TABLE.SRC_CNT ) )) as out_SRC_CNT,
TO_NUMBER(LTRIM ( RTRIM ( sq_SRC_TABLE.DUMMY ) )) as out_DUMMY,
sq_SRC_TABLE.source_record_id
FROM
sq_SRC_TABLE
);


-- Component sq_TGT_TABLE, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE sq_TGT_TABLE AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as INS_CNT,
$2 as UPD_CNT,
$3 as DUMMY,
$4 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT A.INS_CNT INS_CNT,B.UPD_CNT UPD_CNT,''1'' AS DUMMY FROM (SELECT COALESCE(COUNT(*),0) INS_CNT FROM table(:TGT_NM) --WHERE TGT_FLTR_VAR
)A,
(SELECT COUNT(*) UPD_CNT FROM table(:TGT_NM)
--WHERE ECTL_END_DATE=(SELECT CAST(ECTL_BATCH_START_TS AS DATE) FROM DB_T_CTRL_FIN_PROD.ECTL_BATCH_INFO 
--WHERE ECTL_PROJ_ID=ACT_PROJ_ID AND ECTL_ACTIVE_IND=ECTL_ACTIVE_IND)
) B WHERE 1=1
) SRC
)
);


-- Component exp_INT_CONV_TGT_TABLE, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_INT_CONV_TGT_TABLE AS
(
SELECT
TO_NUMBER(LTRIM ( RTRIM ( sq_TGT_TABLE.INS_CNT ) )) as out_TGT_CNT,
TO_NUMBER(LTRIM ( RTRIM ( sq_TGT_TABLE.UPD_CNT ) )) as out_UPD_CNT,
TO_NUMBER(LTRIM ( RTRIM ( sq_TGT_TABLE.DUMMY ) )) as out_DUMMY,
sq_TGT_TABLE.source_record_id
FROM
sq_TGT_TABLE
);


-- Component jnr_SRC_TGT_TABLE, Type JOINER 
CREATE OR REPLACE TEMPORARY TABLE jnr_SRC_TGT_TABLE AS
(
SELECT
exp_INT_CON_SRC_TABLE.out_SRC_CNT as SRC_CNT,
exp_INT_CON_SRC_TABLE.out_DUMMY as DUMMY_SRC,
exp_INT_CONV_TGT_TABLE.out_TGT_CNT as INS_CNT,
exp_INT_CONV_TGT_TABLE.out_DUMMY as DUMMY_TGT,
exp_INT_CONV_TGT_TABLE.out_UPD_CNT as UPD_CNT,
row_number() over (order by 1) AS source_record_id
FROM
exp_INT_CON_SRC_TABLE
INNER JOIN exp_INT_CONV_TGT_TABLE ON exp_INT_CONV_TGT_TABLE.out_DUMMY = exp_INT_CON_SRC_TABLE.out_DUMMY
);


-- Component exp_MSG_DESC, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_MSG_DESC AS
(
SELECT
jnr_SRC_TGT_TABLE.SRC_CNT as SRC_CNT,
jnr_SRC_TGT_TABLE.INS_CNT as TARGET_INS,
jnr_SRC_TGT_TABLE.SRC_CNT - jnr_SRC_TGT_TABLE.INS_CNT as TARGET_REJ,
jnr_SRC_TGT_TABLE.UPD_CNT as TARGET_UPD,
0 as TARGET_DEL,
LTRIM ( RTRIM ( SUBSTR ( :TGT_NM , 1 , 18 ) ) ) || '' - AUDIT INFORMATION SUCCESSFULLY LOADED'' as MSG_DESCRIPTION,
CURRENT_TIMESTAMP as out_ORGN_TS,
:PRGM_NM as out_PRGM_NM,
:ACT_PROJ_ID as out_ACT_PROJ_ID,
:BATCH_ACTIVE_IND as out_BATCH_ACTIVE_IND,
LTRIM ( RTRIM ( SUBSTR ( :TGT_NM , 1 , 18 ) ) ) as out_TABLE_NM,
:ACT_PROJ_ID as IN_ACT_PROJ_ID,
:BATCH_ACTIVE_IND as IN_BATCH_ACTIVE_IND,
''m_STG_FIN_CLM'' IN_PRGM_NM,
null IN_TABLE_NM,
jnr_SRC_TGT_TABLE.source_record_id
FROM
jnr_SRC_TGT_TABLE
);


-- Component mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE, Type MAPPLET 
--MAPPLET NOT REGISTERED: mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE, mapplet instance mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE;
call mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE(''exp_MSG_DESC'');

-- Component ECTL_AUDIT_LOG, Type TARGET 
INSERT INTO DB_T_CTRL_FIN_PROD.ECTL_AUDIT_LOG
(
ECTL_BATCH_ID,
ECTL_PRGM_ID,
ECTL_TABLE_ID,
ECTL_SRC_ROW_CNT,
ECTL_TRGT_INS_CNT,
ECTL_TRGT_UPD_CNT,
ECTL_TRGT_DEL_CNT,
ECTL_TRGT_REJ_CNT,
ECTL_MESSAGE_TXT,
ECTL_ORIG_INS_TS
)
SELECT
nvl(mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_BATCH_ID,-1) as ECTL_BATCH_ID,
nvl(mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_PRGM_ID,-1) as ECTL_PRGM_ID,
nvl(mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_TABLE_ID,-1) as ECTL_TABLE_ID,
exp_MSG_DESC.SRC_CNT as ECTL_SRC_ROW_CNT,
exp_MSG_DESC.TARGET_INS as ECTL_TRGT_INS_CNT,
exp_MSG_DESC.TARGET_UPD as ECTL_TRGT_UPD_CNT,
exp_MSG_DESC.TARGET_DEL as ECTL_TRGT_DEL_CNT,
exp_MSG_DESC.TARGET_REJ as ECTL_TRGT_REJ_CNT,
exp_MSG_DESC.MSG_DESCRIPTION as ECTL_MESSAGE_TXT,
exp_MSG_DESC.out_ORGN_TS as ECTL_ORIG_INS_TS
FROM
exp_MSG_DESC
INNER JOIN mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE ON exp_MSG_DESC.source_record_id = mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.source_record_id;


END; ';