-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_LOAD_CLAIM_DETAILS_VIN_CLAIMS("RUN_ID" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' BEGIN 

-- Component SQ_FNOL_ADJ_REVIEW, Type Pre SQL 
DELETE FROM DB_T_STAG_MEMBXREF_PROD.CLAIM_DETAILS WHERE POLICYSTATUS_GROUPNM=''VIN CLAIMS'';


-- Component SQ_FNOL_ADJ_REVIEW, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_FNOL_ADJ_REVIEW AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as FNOL_MEMBER_NUM,
$2 as POLICY_NUM,
$3 as DOL,
$4 as VIN,
$5 as CAUSE_CD,
$6 as CLM_AMOUNT,
$7 as CLAIM_NBR,
$8 as CSR_CLAIM_NBR,
$9 as CLAIM_STATUS_CD,
$10 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT	DISTINCT FNOL.MEMBER_NUM FNOL_MEMBER_NUM, V.PLCY_NBR POLICY_NUM,
		''APV'' POL_TYPE, CAST(CTAB.CLM_LOSS_DT AS VARCHAR(10))DOL, VEH.VIN,
		
CTAB.CLM_CAUSE_LOSS_CD CAUSE_CODE, null CLM_AMOUNT,
		'''' POL_STATUS, ''VIN CLAIMS'' GROUPNM, 
CTAB.CLM_CLAIM_NBR CLAIM_NBR,
		CTAB.CLM_CSR_CLAIM_NBR CSR_CLAIM_NBR,  CTAB.CLAIM_STATUS_CD
FROM	
(
	SELECT	MEMBER_NUM, CLAIM_NUM 
	FROM	DB_T_STAG_MEMBXREF_PROD.FNOL_ADJ_REVIEW 
	GROUP BY 1,2) FNOL JOIN
(
	SELECT	COB_UNIT_RFR_NBR, COB_CLAIM_NBR 
	FROM	DB_T_ONSITE_PROD.CLAIM_OBJECT 
	GROUP BY 1,2) COBJ 
	ON FNOL.CLAIM_NUM=COBJ.COB_CLAIM_NBR JOIN
(
	SELECT	VEH_VIN_CD VIN, UNIT_REF_NBR 
	FROM	DB_T_CORE_PROD.POLICY_VEHICLE 
	GROUP BY 1,2 
	UNION 
	SELECT	VIN_NBR, UNIT_RFR_NBR 
	FROM	 DB_T_CORE_PROD.AUTO_QUOTE_DLY 
	WHERE	QUOTE_IND=''N'' 
	GROUP BY 1,2 ) VEH 
	ON COBJ.COB_UNIT_RFR_NBR=VEH.UNIT_REF_NBR 
LEFT OUTER JOIN
(
	SELECT	PLCY_NBR, VEH_VIN_CD VIN, UNIT_REF_NBR 
	FROM	DB_T_CORE_PROD.POLICY_VEHICLE 
	GROUP BY 1,2,3 
	UNION 
	SELECT	POL_NBR, VIN_NBR, UNIT_RFR_NBR 
	FROM	 DB_T_CORE_PROD.AUTO_QUOTE_DLY 
	WHERE	QUOTE_IND=''N'' 
	GROUP BY 1,2,3 ) V 
	ON VEH.VIN=V.VIN 
LEFT OUTER JOIN 
(
	SELECT	COB_UNIT_RFR_NBR, COB_CLAIM_NBR 
	FROM	DB_T_ONSITE_PROD.CLAIM_OBJECT 
	GROUP BY 1,2) CO 
	ON V.UNIT_REF_NBR=CO.COB_UNIT_RFR_NBR 
LEFT OUTER JOIN
(
	SELECT	CLM_CLAIM_NBR, CLM_CSR_CLAIM_NBR, CLM_LOSS_DT, CLM_CAUSE_LOSS_CD,
			CASE 
				WHEN CLM_STATUS_CD=''O'' THEN ''OPEN'' 
				WHEN CLM_STATUS_CD=''C'' THEN ''CLOSED'' 
				ELSE CLM_STATUS_CD 
			END CLAIM_STATUS_CD 
	FROM	
	DB_T_ONSITE_PROD.CLAIM_TAB 
	GROUP BY 1,2,3,4,5)CTAB 
	ON CO.COB_CLAIM_NBR=CTAB.CLM_CLAIM_NBR 
LEFT OUTER JOIN
(
	SELECT	CTF_CLAIM_NBR, SUM(CTF_INCURRED_AMT) AS CLM_AMT 
	FROM	DB_T_ONSITE_PROD.CLAIM_CLAIMANT_FIN 
	GROUP BY 1)CFIN 
	ON CO.COB_CLAIM_NBR=CFIN.CTF_CLAIM_NBR
) SRC
)
);


-- Component EXPTRANS, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE EXPTRANS AS
(
SELECT
SQ_FNOL_ADJ_REVIEW.FNOL_MEMBER_NUM as FNOL_MEMBER_NUM,
SQ_FNOL_ADJ_REVIEW.POLICY_NUM as POLICY_NUM,
''APV'' as POL_TYPE,
SQ_FNOL_ADJ_REVIEW.DOL as DOL,
SQ_FNOL_ADJ_REVIEW.VIN as VIN,
SQ_FNOL_ADJ_REVIEW.CAUSE_CD as CAUSE_CD,
SQ_FNOL_ADJ_REVIEW.CLM_AMOUNT as CLM_AMOUNT,
'' '' as POL_STATUS,
''NULL CLAIMS'' as GROUPNM,
SQ_FNOL_ADJ_REVIEW.CLAIM_NBR as CLAIM_NBR,
SQ_FNOL_ADJ_REVIEW.CSR_CLAIM_NBR as CSR_CLAIM_NBR,
SQ_FNOL_ADJ_REVIEW.CLAIM_STATUS_CD as CLAIM_STATUS_CD,
SQ_FNOL_ADJ_REVIEW.source_record_id
FROM
SQ_FNOL_ADJ_REVIEW
);


-- Component CLAIM_DETAILS, Type TARGET 
INSERT INTO DB_T_STAG_MEMBXREF_PROD.CLAIM_DETAILS
(
MEMBER_NUM,
POLICY_NUM,
POLICY_TYPE,
DOL,
LINECODE_VIN,
CAUSE_CODE,
CLM_AMOUNT,
POLICY_STATUS,
POLICYSTATUS_GROUPNM,
CLAIM_NBR,
CSR_CLAIM_NBR,
CLAIM_STATUS_CD
)
SELECT
EXPTRANS.FNOL_MEMBER_NUM as MEMBER_NUM,
EXPTRANS.POLICY_NUM as POLICY_NUM,
EXPTRANS.POL_TYPE as POLICY_TYPE,
EXPTRANS.DOL as DOL,
EXPTRANS.VIN as LINECODE_VIN,
EXPTRANS.CAUSE_CD as CAUSE_CODE,
EXPTRANS.CLM_AMOUNT as CLM_AMOUNT,
EXPTRANS.POL_STATUS as POLICY_STATUS,
EXPTRANS.GROUPNM as POLICYSTATUS_GROUPNM,
EXPTRANS.CLAIM_NBR as CLAIM_NBR,
EXPTRANS.CSR_CLAIM_NBR as CSR_CLAIM_NBR,
EXPTRANS.CLAIM_STATUS_CD as CLAIM_STATUS_CD
FROM
EXPTRANS;


END; ';