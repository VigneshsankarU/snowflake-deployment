-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_STAG_ASICPOLS("RUN_ID" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' DECLARE FEED_IND varchar;
FEED_DT date;
BEGIN 

FEED_IND:=(select DAILY_FEED_IND from DB_T_CTRL_PROD.ECTL_JOB_LOAD_STATUS_LOG where ECTL_BATCH_ID= :run_id); 
FEED_DT:=(select current_date);

-- Component ASICPOLS1, Type TRUNCATE_TABLE 
TRUNCATE TABLE DB_T_CORE_MEMBXREF_PROD.ASICPOLS;


-- PIPELINE START FOR 1

-- Component SQ_ASICPOLS3, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_ASICPOLS3 AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as SC_SERVICE_CENTER,
$2 as SC_POLICY_NUM,
$3 as PC_ALPHA_CODE,
$4 as PC_EFF_DATE,
$5 as PC_EXP_DATE,
$6 as PC_NAME_1,
$7 as PC_NAME_2,
$8 as PC_ADDRESS_1,
$9 as PC_ADDRESS_2,
$10 as PC_CITYST,
$11 as PC_ZIP,
$12 as PC_ZIP_EXT,
$13 as PC_TAX_CODE,
$14 as PC_AGENT,
$15 as PC_MEMBER_NUMBER,
$16 as PC_ENCUMBRANCE,
$17 as PC_COMPANY,
$18 as PC_STATUS,
$19 as PC_SSNO_1,
$20 as PC_SSNO_2,
$21 as PC_STATE,
$22 as PC_ALPHA_2,
$23 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT
ASICPOLS.SC_SERVICE_CENTER,
ASICPOLS.SC_POLICY_NUM,
ASICPOLS.PC_ALPHA_CODE,
ASICPOLS.PC_EFF_DATE,
ASICPOLS.PC_EXP_DATE,
ASICPOLS.PC_NAME_1,
ASICPOLS.PC_NAME_2,
ASICPOLS.PC_ADDRESS_1,
ASICPOLS.PC_ADDRESS_2,
ASICPOLS.PC_CITYST,
ASICPOLS.PC_ZIP,
ASICPOLS.PC_ZIP_EXT,
ASICPOLS.PC_TAX_CODE,
ASICPOLS.PC_AGENT,
ASICPOLS.PC_MEMBER_NUMBER,
ASICPOLS.PC_ENCUMBRANCE,
ASICPOLS.PC_COMPANY,
ASICPOLS.PC_STATUS,
ASICPOLS.PC_SSNO_1,
ASICPOLS.PC_SSNO_2,
ASICPOLS.PC_STATE,
ASICPOLS.PC_ALPHA_2
FROM DB_T_CORE_MEMBXREF_PROD.ASICPOLS
) SRC
)
);


-- Component exp_pass_through, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_pass_through AS
(
SELECT
SQ_ASICPOLS3.SC_SERVICE_CENTER as SC_SERVICE_CENTER,
SQ_ASICPOLS3.SC_POLICY_NUM as SC_POLICY_NUM,
SQ_ASICPOLS3.PC_ALPHA_CODE as PC_ALPHA_CODE,
SQ_ASICPOLS3.PC_EFF_DATE as PC_EFF_DATE,
SQ_ASICPOLS3.PC_EXP_DATE as PC_EXP_DATE,
SQ_ASICPOLS3.PC_NAME_1 as PC_NAME_1,
SQ_ASICPOLS3.PC_NAME_2 as PC_NAME_2,
SQ_ASICPOLS3.PC_ADDRESS_1 as PC_ADDRESS_1,
SQ_ASICPOLS3.PC_ADDRESS_2 as PC_ADDRESS_2,
SQ_ASICPOLS3.PC_CITYST as PC_CITYST,
SQ_ASICPOLS3.PC_ZIP as PC_ZIP,
SQ_ASICPOLS3.PC_ZIP_EXT as PC_ZIP_EXT,
SQ_ASICPOLS3.PC_TAX_CODE as PC_TAX_CODE,
SQ_ASICPOLS3.PC_AGENT as PC_AGENT,
SQ_ASICPOLS3.PC_MEMBER_NUMBER as PC_MEMBER_NUMBER,
SQ_ASICPOLS3.PC_ENCUMBRANCE as PC_ENCUMBRANCE,
SQ_ASICPOLS3.PC_COMPANY as PC_COMPANY,
SQ_ASICPOLS3.PC_STATUS as PC_STATUS,
SQ_ASICPOLS3.PC_SSNO_1 as PC_SSNO_1,
SQ_ASICPOLS3.PC_SSNO_2 as PC_SSNO_2,
SQ_ASICPOLS3.PC_STATE as PC_STATE,
SQ_ASICPOLS3.PC_ALPHA_2 as PC_ALPHA_2,
SQ_ASICPOLS3.source_record_id
FROM
SQ_ASICPOLS3
);


-- Component ASICPOLS1, Type TARGET 
INSERT INTO DB_T_CORE_MEMBXREF_PROD.ASICPOLS
(
SC_SERVICE_CENTER,
SC_POLICY_NUM,
PC_ALPHA_CODE,
PC_EFF_DATE,
PC_EXP_DATE,
PC_NAME_1,
PC_NAME_2,
PC_ADDRESS_1,
PC_ADDRESS_2,
PC_CITYST,
PC_ZIP,
PC_ZIP_EXT,
PC_TAX_CODE,
PC_AGENT,
PC_MEMBER_NUMBER,
PC_ENCUMBRANCE,
PC_COMPANY,
PC_STATUS,
PC_SSNO_1,
PC_SSNO_2,
PC_STATE,
PC_ALPHA_2
)
SELECT
exp_pass_through.SC_SERVICE_CENTER as SC_SERVICE_CENTER,
exp_pass_through.SC_POLICY_NUM as SC_POLICY_NUM,
exp_pass_through.PC_ALPHA_CODE as PC_ALPHA_CODE,
exp_pass_through.PC_EFF_DATE as PC_EFF_DATE,
exp_pass_through.PC_EXP_DATE as PC_EXP_DATE,
exp_pass_through.PC_NAME_1 as PC_NAME_1,
exp_pass_through.PC_NAME_2 as PC_NAME_2,
exp_pass_through.PC_ADDRESS_1 as PC_ADDRESS_1,
exp_pass_through.PC_ADDRESS_2 as PC_ADDRESS_2,
exp_pass_through.PC_CITYST as PC_CITYST,
exp_pass_through.PC_ZIP as PC_ZIP,
exp_pass_through.PC_ZIP_EXT as PC_ZIP_EXT,
exp_pass_through.PC_TAX_CODE as PC_TAX_CODE,
exp_pass_through.PC_AGENT as PC_AGENT,
exp_pass_through.PC_MEMBER_NUMBER as PC_MEMBER_NUMBER,
exp_pass_through.PC_ENCUMBRANCE as PC_ENCUMBRANCE,
exp_pass_through.PC_COMPANY as PC_COMPANY,
exp_pass_through.PC_STATUS as PC_STATUS,
exp_pass_through.PC_SSNO_1 as PC_SSNO_1,
exp_pass_through.PC_SSNO_2 as PC_SSNO_2,
exp_pass_through.PC_STATE as PC_STATE,
exp_pass_through.PC_ALPHA_2 as PC_ALPHA_2
FROM
exp_pass_through;


-- PIPELINE END FOR 1

-- PIPELINE START FOR 2

-- Component SQ_ASICPOLS2, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_ASICPOLS2 AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as record_count,
$2 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT count(*) as record_count
FROM
DB_T_CORE_MEMBXREF_PROD.ASICPOLS
) SRC
)
);


-- Component exp_rec_cnt, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_rec_cnt AS
(
SELECT
TO_NUMBER(SQ_ASICPOLS2.record_count) as o_record_count,
:feed_ind as feed_ind,
:feed_dt as feed_dt,
SQ_ASICPOLS2.source_record_id
FROM
SQ_ASICPOLS2
);


-- Component TRG_MEMBXREF, Type TARGET_EXPORT_PREPARE Stage data before exporting
CREATE OR REPLACE TEMPORARY TABLE TRG_MEMBXREF AS
(
SELECT
exp_rec_cnt.feed_ind as feed_ind,
exp_rec_cnt.feed_dt as feed_dt,
exp_rec_cnt.o_record_count as record_cnt
FROM
exp_rec_cnt
);


-- Component TRG_MEMBXREF, Type EXPORT_DATA Exporting data
;


-- PIPELINE END FOR 2

END; ';