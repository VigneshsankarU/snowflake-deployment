-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_FIRE("RUN_ID" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' BEGIN 

-- Component FIRE, Type TRUNCATE_TABLE 
TRUNCATE TABLE DB_T_STAG_MEMBXREF_PROD.FIRE;


-- Component SQ_view_Fire, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_view_Fire AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as POLICY,
$2 as MEMBER_NUMBER,
$3 as AGENT,
$4 as FORM,
$5 as FORM_DESC,
$6 as FI_ITEM_NDX,
$7 as MAKE_MODEL,
$8 as LOCATION,
$9 as NAME1,
$10 as NAME2,
$11 as DWELLING,
$12 as OTHR_STR,
$13 as PERSONAL_PROPERTY,
$14 as LOSS_OF_USE,
$15 as LIABILITY,
$16 as MEDICAL,
$17 as DEDUCTIBLE,
$18 as CONSTRUCTION_YEAR,
$19 as EFF_DATE,
$20 as EXP_DATE,
$21 as PREMIUM,
$22 as STATUS,
$23 as MORTGAGE_IND,
$24 as DISCOUNT,
$25 as HOME_ALERT_DISCOUNT,
$26 as VALUE_CLIENT_DISCOUNT,
$27 as SPRINKLER_DISCOUNT,
$28 as NEW_HOME_DISCOUNT,
$29 as BLD_RISK_DISCOUNT,
$30 as OTH_END,
$31 as END_CD,
$32 as END_DESC,
$33 as CLAIM_DATE_1,
$34 as CLAIM_AMOUNT_1,
$35 as CLAIM_DATE_2,
$36 as CLAIM_AMOUNT_2,
$37 as CLAIM_DATE_3,
$38 as CLAIM_AMOUNT_3,
$39 as CLAIM_DATE_4,
$40 as CLAIM_AMOUNT_4,
$41 as CLAIM_DATE_5,
$42 as CLAIM_AMOUNT_5,
$43 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT
view_Fire.POLICY,
view_Fire.MEMBER_NUMBER,
view_Fire.AGENT,
view_Fire.FORM,
view_Fire.FORM_DESC,
view_Fire.FI_ITEM_NDX,
view_Fire.MAKE_MODEL,
view_Fire.LOCATION,
view_Fire.NAME1,
view_Fire.NAME2,
view_Fire.DWELLING,
view_Fire.OTHR_STR,
view_Fire.PERSONAL_PROPERTY,
view_Fire.LOSS_OF_USE,
view_Fire.LIABILITY,
view_Fire.MEDICAL,
view_Fire.DEDUCTIBLE,
view_Fire.CONSTRUCTION_YEAR,
view_Fire.EFF_DATE,
view_Fire.EXP_DATE,
view_Fire.PREMIUM,
view_Fire.STATUS,
view_Fire.MORTGAGE_IND,
view_Fire.DISCOUNT,
view_Fire.HOME_ALERT_DISCOUNT,
view_Fire.VALUE_CLIENT_DISCOUNT,
view_Fire.SPRINKLER_DISCOUNT,
view_Fire.NEW_HOME_DISCOUNT,
view_Fire.BLD_RISK_DISCOUNT,
view_Fire.OTH_END,
view_Fire.END_CD,
view_Fire.END_DESC,
view_Fire.CLAIM_DATE_1,
view_Fire.CLAIM_AMOUNT_1,
view_Fire.CLAIM_DATE_2,
view_Fire.CLAIM_AMOUNT_2,
view_Fire.CLAIM_DATE_3,
view_Fire.CLAIM_AMOUNT_3,
view_Fire.CLAIM_DATE_4,
view_Fire.CLAIM_AMOUNT_4,
view_Fire.CLAIM_DATE_5,
view_Fire.CLAIM_AMOUNT_5
FROM DB_T_STAG_MEMBXREF_PROD.view_Fire
) SRC
)
);


-- Component exp_fire, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_fire AS
(
SELECT
SQ_view_Fire.POLICY as POLICY,
SQ_view_Fire.MEMBER_NUMBER as MEMBER_NUMBER,
SQ_view_Fire.AGENT as AGENT,
SQ_view_Fire.FORM as FORM,
SQ_view_Fire.FORM_DESC as FORM_DESC,
SQ_view_Fire.FI_ITEM_NDX as FI_ITEM_NDX,
SQ_view_Fire.MAKE_MODEL as MAKE_MODEL,
SQ_view_Fire.LOCATION as LOCATION,
SQ_view_Fire.NAME1 as NAME1,
SQ_view_Fire.NAME2 as NAME2,
SQ_view_Fire.DWELLING as DWELLING,
SQ_view_Fire.OTHR_STR as OTHR_STR,
SQ_view_Fire.PERSONAL_PROPERTY as PERSONAL_PROPERTY,
SQ_view_Fire.LOSS_OF_USE as LOSS_OF_USE,
SQ_view_Fire.LIABILITY as LIABILITY,
SQ_view_Fire.MEDICAL as MEDICAL,
SQ_view_Fire.DEDUCTIBLE as DEDUCTIBLE,
SQ_view_Fire.CONSTRUCTION_YEAR as CONSTRUCTION_YEAR,
SQ_view_Fire.EFF_DATE as EFF_DATE,
SQ_view_Fire.EXP_DATE as EXP_DATE,
SQ_view_Fire.PREMIUM as PREMIUM,
SQ_view_Fire.STATUS as STATUS,
SQ_view_Fire.MORTGAGE_IND as MORTGAGE_IND,
SQ_view_Fire.DISCOUNT as DISCOUNT,
SQ_view_Fire.HOME_ALERT_DISCOUNT as HOME_ALERT_DISCOUNT,
SQ_view_Fire.VALUE_CLIENT_DISCOUNT as VALUE_CLIENT_DISCOUNT,
SQ_view_Fire.SPRINKLER_DISCOUNT as SPRINKLER_DISCOUNT,
SQ_view_Fire.NEW_HOME_DISCOUNT as NEW_HOME_DISCOUNT,
SQ_view_Fire.BLD_RISK_DISCOUNT as BLD_RISK_DISCOUNT,
SQ_view_Fire.OTH_END as OTH_END,
SQ_view_Fire.END_CD as END_CD,
SQ_view_Fire.END_DESC as END_DESC,
SQ_view_Fire.CLAIM_DATE_1 as CLAIM_DATE_1,
SQ_view_Fire.CLAIM_AMOUNT_1 as CLAIM_AMOUNT_1,
SQ_view_Fire.CLAIM_DATE_2 as CLAIM_DATE_2,
SQ_view_Fire.CLAIM_AMOUNT_2 as CLAIM_AMOUNT_2,
SQ_view_Fire.CLAIM_DATE_3 as CLAIM_DATE_3,
SQ_view_Fire.CLAIM_AMOUNT_3 as CLAIM_AMOUNT_3,
SQ_view_Fire.CLAIM_DATE_4 as CLAIM_DATE_4,
SQ_view_Fire.CLAIM_AMOUNT_4 as CLAIM_AMOUNT_4,
SQ_view_Fire.CLAIM_DATE_5 as CLAIM_DATE_5,
SQ_view_Fire.CLAIM_AMOUNT_5 as CLAIM_AMOUNT_5,
SQ_view_Fire.source_record_id
FROM
SQ_view_Fire
);


-- Component FIRE, Type TARGET 
INSERT INTO DB_T_STAG_MEMBXREF_PROD.FIRE
(
POLICY,
MEMBER_NUMBER,
AGENT,
FORM,
FORM_DESC,
FI_ITEM_NDX,
MAKE_MODEL,
LOCATION,
NAME1,
NAME2,
DWELLING,
OTHR_STR,
PERSONAL_PROPERTY,
LOSS_OF_USE,
LIABILITY,
MEDICAL,
DEDUCTIBLE,
CONSTRUCTION_YEAR,
EFF_DATE,
EXP_DATE,
PREMIUM,
STATUS,
MORTGAGE_IND,
DISCOUNT,
HOME_ALERT_DISCOUNT,
VALUE_CLIENT_DISCOUNT,
SPRINKLER_DISCOUNT,
NEW_HOME_DISCOUNT,
BLD_RISK_DISCOUNT,
OTH_END,
END_CD,
END_DESC,
CLAIM_DATE_1,
CLAIM_AMOUNT_1,
CLAIM_DATE_2,
CLAIM_AMOUNT_2,
CLAIM_DATE_3,
CLAIM_AMOUNT_3,
CLAIM_DATE_4,
CLAIM_AMOUNT_4,
CLAIM_DATE_5,
CLAIM_AMOUNT_5
)
SELECT
exp_fire.POLICY as POLICY,
exp_fire.MEMBER_NUMBER as MEMBER_NUMBER,
exp_fire.AGENT as AGENT,
exp_fire.FORM as FORM,
exp_fire.FORM_DESC as FORM_DESC,
exp_fire.FI_ITEM_NDX as FI_ITEM_NDX,
exp_fire.MAKE_MODEL as MAKE_MODEL,
exp_fire.LOCATION as LOCATION,
exp_fire.NAME1 as NAME1,
exp_fire.NAME2 as NAME2,
exp_fire.DWELLING as DWELLING,
exp_fire.OTHR_STR as OTHR_STR,
exp_fire.PERSONAL_PROPERTY as PERSONAL_PROPERTY,
exp_fire.LOSS_OF_USE as LOSS_OF_USE,
exp_fire.LIABILITY as LIABILITY,
exp_fire.MEDICAL as MEDICAL,
exp_fire.DEDUCTIBLE as DEDUCTIBLE,
exp_fire.CONSTRUCTION_YEAR as CONSTRUCTION_YEAR,
exp_fire.EFF_DATE as EFF_DATE,
exp_fire.EXP_DATE as EXP_DATE,
exp_fire.PREMIUM as PREMIUM,
exp_fire.STATUS as STATUS,
exp_fire.MORTGAGE_IND as MORTGAGE_IND,
exp_fire.DISCOUNT as DISCOUNT,
exp_fire.HOME_ALERT_DISCOUNT as HOME_ALERT_DISCOUNT,
exp_fire.VALUE_CLIENT_DISCOUNT as VALUE_CLIENT_DISCOUNT,
exp_fire.SPRINKLER_DISCOUNT as SPRINKLER_DISCOUNT,
exp_fire.NEW_HOME_DISCOUNT as NEW_HOME_DISCOUNT,
exp_fire.BLD_RISK_DISCOUNT as BLD_RISK_DISCOUNT,
exp_fire.OTH_END as OTH_END,
exp_fire.END_CD as END_CD,
exp_fire.END_DESC as END_DESC,
exp_fire.CLAIM_DATE_1 as CLAIM_DATE_1,
exp_fire.CLAIM_AMOUNT_1 as CLAIM_AMOUNT_1,
exp_fire.CLAIM_DATE_2 as CLAIM_DATE_2,
exp_fire.CLAIM_AMOUNT_2 as CLAIM_AMOUNT_2,
exp_fire.CLAIM_DATE_3 as CLAIM_DATE_3,
exp_fire.CLAIM_AMOUNT_3 as CLAIM_AMOUNT_3,
exp_fire.CLAIM_DATE_4 as CLAIM_DATE_4,
exp_fire.CLAIM_AMOUNT_4 as CLAIM_AMOUNT_4,
exp_fire.CLAIM_DATE_5 as CLAIM_DATE_5,
exp_fire.CLAIM_AMOUNT_5 as CLAIM_AMOUNT_5
FROM
exp_fire;


END; ';