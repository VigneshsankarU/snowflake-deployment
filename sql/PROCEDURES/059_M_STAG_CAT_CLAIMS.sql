-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_STAG_CAT_CLAIMS("PARAM_JSON" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' 
DECLARE
  PRCS_ID STRING;
BEGIN
  SELECT 
    TRY_PARSE_JSON(:param_json):PRCS_ID::STRING
  INTO
    PRCS_ID;

-- Component SQ_CAT_CLAIMS, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_CAT_CLAIMS AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as CLAIM_NUMBER,
$2 as TRAILER_NUMBER,
$3 as CREATION_TS,
$4 as POLICY_NUMBER,
$5 as CLM_LOSS_DT,
$6 as COMPANY,
$7 as STATE,
$8 as CLAIM_SEQ_NBR,
$9 as ACCOUNTING_DATE,
$10 as COVERAGE_CD,
$11 as CAUSE_LOSS_CODE,
$12 as REINSURANCE,
$13 as PAID_LOSS_AMT,
$14 as RESERVE_AMT,
$15 as SALVAGE_AMT,
$16 as DESCRIPTION,
$17 as LINE_OF_BUS,
$18 as LINE_OF_BUS_DESC,
$19 as BRANCH_NBR,
$20 as COUNTY_NBR,
$21 as COUNTY_NAME,
$22 as CATASTROPHE_CODE,
$23 as LINE_OF_BUS_IND,
$24 as CATASTROPHE_DESC,
$25 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT
CAT_CLAIMS.CLAIM_NUMBER,
CAT_CLAIMS.TRAILER_NUMBER,
CAT_CLAIMS.CREATION_TS,
CAT_CLAIMS.POLICY_NUMBER,
CAT_CLAIMS.CLM_LOSS_DT,
CAT_CLAIMS.COMPANY,
CAT_CLAIMS.STATE,
CAT_CLAIMS.CLAIM_SEQ_NBR,
CAT_CLAIMS.ACCOUNTING_DATE,
CAT_CLAIMS.COVERAGE_CD,
CAT_CLAIMS.CAUSE_LOSS_CODE,
CAT_CLAIMS.REINSURANCE,
CAT_CLAIMS.PAID_LOSS_AMT,
CAT_CLAIMS.RESERVE_AMT,
CAT_CLAIMS.SALVAGE_AMT,
CAT_CLAIMS.DESCRIPTION,
CAT_CLAIMS.LINE_OF_BUS,
CAT_CLAIMS.LINE_OF_BUS_DESC,
CAT_CLAIMS.BRANCH_NBR,
CAT_CLAIMS.COUNTY_NBR,
CAT_CLAIMS.COUNTY_NAME,
CAT_CLAIMS.CATASTROPHE_CODE,
CAT_CLAIMS.LINE_OF_BUS_IND,
CAT_CLAIMS.CATASTROPHE_DESC
FROM DB_T_PROD_STAG.CAT_CLAIMS
) SRC
)
);


-- Component exp_pass_through, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_pass_through AS
(
SELECT
SQ_CAT_CLAIMS.CLAIM_NUMBER as CLAIM_NUMBER,
SQ_CAT_CLAIMS.TRAILER_NUMBER as TRAILER_NUMBER,
SQ_CAT_CLAIMS.CREATION_TS as CREATION_TS,
SQ_CAT_CLAIMS.POLICY_NUMBER as POLICY_NUMBER,
SQ_CAT_CLAIMS.CLM_LOSS_DT as CLM_LOSS_DT,
SQ_CAT_CLAIMS.COMPANY as COMPANY,
SQ_CAT_CLAIMS.STATE as STATE,
SQ_CAT_CLAIMS.CLAIM_SEQ_NBR as CLAIM_SEQ_NBR,
SQ_CAT_CLAIMS.ACCOUNTING_DATE as ACCOUNTING_DATE,
SQ_CAT_CLAIMS.COVERAGE_CD as COVERAGE_CD,
SQ_CAT_CLAIMS.CAUSE_LOSS_CODE as CAUSE_LOSS_CODE,
SQ_CAT_CLAIMS.REINSURANCE as REINSURANCE,
SQ_CAT_CLAIMS.PAID_LOSS_AMT as PAID_LOSS_AMT,
SQ_CAT_CLAIMS.RESERVE_AMT as RESERVE_AMT,
SQ_CAT_CLAIMS.SALVAGE_AMT as SALVAGE_AMT,
SQ_CAT_CLAIMS.DESCRIPTION as DESCRIPTION,
SQ_CAT_CLAIMS.LINE_OF_BUS as LINE_OF_BUS,
SQ_CAT_CLAIMS.LINE_OF_BUS_DESC as LINE_OF_BUS_DESC,
SQ_CAT_CLAIMS.BRANCH_NBR as BRANCH_NBR,
SQ_CAT_CLAIMS.COUNTY_NBR as COUNTY_NBR,
SQ_CAT_CLAIMS.COUNTY_NAME as COUNTY_NAME,
SQ_CAT_CLAIMS.CATASTROPHE_CODE as CATASTROPHE_CODE,
SQ_CAT_CLAIMS.LINE_OF_BUS_IND as LINE_OF_BUS_IND,
SQ_CAT_CLAIMS.CATASTROPHE_DESC as CATASTROPHE_DESC,
:PRCS_ID as PROCESS_ID,
SQ_CAT_CLAIMS.source_record_id
FROM
SQ_CAT_CLAIMS
);


-- Component CAT_CLAIMS1, Type TARGET 
INSERT INTO DB_T_PROD_STAG.CAT_CLAIMS
(
CLAIM_NUMBER,
TRAILER_NUMBER,
CREATION_TS,
POLICY_NUMBER,
CLM_LOSS_DT,
COMPANY,
STATE,
CLAIM_SEQ_NBR,
ACCOUNTING_DATE,
COVERAGE_CD,
CAUSE_LOSS_CODE,
REINSURANCE,
PAID_LOSS_AMT,
RESERVE_AMT,
SALVAGE_AMT,
DESCRIPTION,
LINE_OF_BUS,
LINE_OF_BUS_DESC,
BRANCH_NBR,
COUNTY_NBR,
COUNTY_NAME,
CATASTROPHE_CODE,
LINE_OF_BUS_IND,
CATASTROPHE_DESC,
PRCS_ID
)
SELECT
exp_pass_through.CLAIM_NUMBER as CLAIM_NUMBER,
exp_pass_through.TRAILER_NUMBER as TRAILER_NUMBER,
exp_pass_through.CREATION_TS as CREATION_TS,
exp_pass_through.POLICY_NUMBER as POLICY_NUMBER,
exp_pass_through.CLM_LOSS_DT as CLM_LOSS_DT,
exp_pass_through.COMPANY as COMPANY,
exp_pass_through.STATE as STATE,
exp_pass_through.CLAIM_SEQ_NBR as CLAIM_SEQ_NBR,
exp_pass_through.ACCOUNTING_DATE as ACCOUNTING_DATE,
exp_pass_through.COVERAGE_CD as COVERAGE_CD,
exp_pass_through.CAUSE_LOSS_CODE as CAUSE_LOSS_CODE,
exp_pass_through.REINSURANCE as REINSURANCE,
exp_pass_through.PAID_LOSS_AMT as PAID_LOSS_AMT,
exp_pass_through.RESERVE_AMT as RESERVE_AMT,
exp_pass_through.SALVAGE_AMT as SALVAGE_AMT,
exp_pass_through.DESCRIPTION as DESCRIPTION,
exp_pass_through.LINE_OF_BUS as LINE_OF_BUS,
exp_pass_through.LINE_OF_BUS_DESC as LINE_OF_BUS_DESC,
exp_pass_through.BRANCH_NBR as BRANCH_NBR,
exp_pass_through.COUNTY_NBR as COUNTY_NBR,
exp_pass_through.COUNTY_NAME as COUNTY_NAME,
exp_pass_through.CATASTROPHE_CODE as CATASTROPHE_CODE,
exp_pass_through.LINE_OF_BUS_IND as LINE_OF_BUS_IND,
exp_pass_through.CATASTROPHE_DESC as CATASTROPHE_DESC,
exp_pass_through.PROCESS_ID as PRCS_ID
FROM
exp_pass_through;


END; ';