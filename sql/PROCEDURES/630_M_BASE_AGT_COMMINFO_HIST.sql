-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_BASE_AGT_COMMINFO_HIST("WORKLET_NAME" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' DECLARE
  run_id STRING;
  workflow_name STRING;
  session_name STRING;
BEGIN
  run_id := public.func_get_scoped_param(:run_id, ''run_id'', :workflow_name, :worklet_name, :session_name);
  workflow_name := public.func_get_scoped_param(:run_id, ''workflow_name'', :workflow_name, :worklet_name, :session_name);
  session_name := public.func_get_scoped_param(:run_id, ''session_name'', :workflow_name, :worklet_name, :session_name);
 

-- Component SQ_AGT_COMMINFO_HIST, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_AGT_COMMINFO_HIST AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as AGENT,
$2 as ACCOUNTING_DT,
$3 as STATE,
$4 as DISTRICT,
$5 as REGION,
$6 as SVC,
$7 as INACTIVECD,
$8 as PAYAGT,
$9 as PAYROLLNO,
$10 as NAME,
$11 as ORIGINAL_CNTY,
$12 as TYPE_COMM,
$13 as AUTO_NB,
$14 as AUTO_RENEWAL,
$15 as AUTO_CO_COMP,
$16 as FIRE_NB,
$17 as FIRE_RENEWAL,
$18 as FIRE_CO_COMP,
$19 as BONUSCD,
$20 as EMP_MO,
$21 as EMP_YR,
$22 as VAL_MO,
$23 as VAL_YR,
$24 as STANDARD_CODE,
$25 as PREV_EXPER_CODE,
$26 as NBR_MTHS_LVL_1,
$27 as COMP_PLAN,
$28 as TERM_DATE,
$29 as ORIG_EMP_DATE,
$30 as VALIDATION_MONTHS,
$31 as PAY_RW_PRIOR_1ST_M,
$32 as PAY_RN_PRIOR_1ST_M,
$33 as FORCE_COMM_RATE_WH,
$34 as BENCHMARK_IND,
$35 as BENCHMARK_CUTOFF,
$36 as BENCHMARK_MONTHS,
$37 as BENCHMARK_MTH_PAST,
$38 as VALIDATING,
$39 as PARTICIPATING,
$40 as LIFE_SHORT_TERM,
$41 as MONTHS_INTO_VALIDA,
$42 as EMPLOYMENT_MONTHS,
$43 as PERSISTENCY_TYPE,
$44 as ASSOCAGT_IND,
$45 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT
AGT_COMMINFO_HIST.AGENT,
AGT_COMMINFO_HIST.ACCOUNTING_DT,
AGT_COMMINFO_HIST.STATE,
AGT_COMMINFO_HIST.DISTRICT,
AGT_COMMINFO_HIST.REGION,
AGT_COMMINFO_HIST.SVC,
AGT_COMMINFO_HIST.INACTIVECD,
AGT_COMMINFO_HIST.PAYAGT,
AGT_COMMINFO_HIST.PAYROLLNO,
AGT_COMMINFO_HIST.NAME,
AGT_COMMINFO_HIST.ORIGINAL_CNTY,
AGT_COMMINFO_HIST.TYPE_COMM,
AGT_COMMINFO_HIST.AUTO_NB,
AGT_COMMINFO_HIST.AUTO_RENEWAL,
AGT_COMMINFO_HIST.AUTO_CO_COMP,
AGT_COMMINFO_HIST.FIRE_NB,
AGT_COMMINFO_HIST.FIRE_RENEWAL,
AGT_COMMINFO_HIST.FIRE_CO_COMP,
AGT_COMMINFO_HIST.BONUSCD,
AGT_COMMINFO_HIST.EMP_MO,
AGT_COMMINFO_HIST.EMP_YR,
AGT_COMMINFO_HIST.VAL_MO,
AGT_COMMINFO_HIST.VAL_YR,
AGT_COMMINFO_HIST.STANDARD_CODE,
AGT_COMMINFO_HIST.PREV_EXPER_CODE,
AGT_COMMINFO_HIST.NBR_MTHS_LVL_1,
AGT_COMMINFO_HIST.COMP_PLAN,
AGT_COMMINFO_HIST.TERM_DATE,
AGT_COMMINFO_HIST.ORIG_EMP_DATE,
AGT_COMMINFO_HIST.VALIDATION_MONTHS,
AGT_COMMINFO_HIST.PAY_RW_PRIOR_1ST_M,
AGT_COMMINFO_HIST.PAY_RN_PRIOR_1ST_M,
AGT_COMMINFO_HIST.FORCE_COMM_RATE_WH,
AGT_COMMINFO_HIST.BENCHMARK_IND,
AGT_COMMINFO_HIST.BENCHMARK_CUTOFF,
AGT_COMMINFO_HIST.BENCHMARK_MONTHS,
AGT_COMMINFO_HIST.BENCHMARK_MTH_PAST,
AGT_COMMINFO_HIST.VALIDATING,
AGT_COMMINFO_HIST.PARTICIPATING,
AGT_COMMINFO_HIST.LIFE_SHORT_TERM,
AGT_COMMINFO_HIST.MONTHS_INTO_VALIDA,
AGT_COMMINFO_HIST.EMPLOYMENT_MONTHS,
AGT_COMMINFO_HIST.PERSISTENCY_TYPE,
AGT_COMMINFO_HIST.ASSOCAGT_IND
FROM db_t_prod_stag.AGT_COMMINFO_HIST
) SRC
)
);


-- Component EXPTRANS, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE EXPTRANS AS
(
SELECT
SQ_AGT_COMMINFO_HIST.AGENT as AGENT,
SQ_AGT_COMMINFO_HIST.ACCOUNTING_DT as ACCOUNTING_DT,
SQ_AGT_COMMINFO_HIST.STATE as STATE,
SQ_AGT_COMMINFO_HIST.DISTRICT as DISTRICT,
SQ_AGT_COMMINFO_HIST.REGION as REGION,
SQ_AGT_COMMINFO_HIST.SVC as SVC,
SQ_AGT_COMMINFO_HIST.INACTIVECD as INACTIVECD,
SQ_AGT_COMMINFO_HIST.PAYAGT as PAYAGT,
SQ_AGT_COMMINFO_HIST.PAYROLLNO as PAYROLLNO,
SQ_AGT_COMMINFO_HIST.NAME as NAME,
SQ_AGT_COMMINFO_HIST.ORIGINAL_CNTY as ORIGINAL_CNTY,
SQ_AGT_COMMINFO_HIST.TYPE_COMM as TYPE_COMM,
SQ_AGT_COMMINFO_HIST.AUTO_NB as AUTO_NB,
SQ_AGT_COMMINFO_HIST.AUTO_RENEWAL as AUTO_RENEWAL,
SQ_AGT_COMMINFO_HIST.AUTO_CO_COMP as AUTO_CO_COMP,
SQ_AGT_COMMINFO_HIST.FIRE_NB as FIRE_NB,
SQ_AGT_COMMINFO_HIST.FIRE_RENEWAL as FIRE_RENEWAL,
SQ_AGT_COMMINFO_HIST.FIRE_CO_COMP as FIRE_CO_COMP,
SQ_AGT_COMMINFO_HIST.BONUSCD as BONUSCD,
SQ_AGT_COMMINFO_HIST.EMP_MO as EMP_MO,
SQ_AGT_COMMINFO_HIST.EMP_YR as EMP_YR,
SQ_AGT_COMMINFO_HIST.VAL_MO as VAL_MO,
SQ_AGT_COMMINFO_HIST.VAL_YR as VAL_YR,
SQ_AGT_COMMINFO_HIST.STANDARD_CODE as STANDARD_CODE,
SQ_AGT_COMMINFO_HIST.PREV_EXPER_CODE as PREV_EXPER_CODE,
SQ_AGT_COMMINFO_HIST.NBR_MTHS_LVL_1 as NBR_MTHS_LVL_1,
SQ_AGT_COMMINFO_HIST.COMP_PLAN as COMP_PLAN,
SQ_AGT_COMMINFO_HIST.TERM_DATE as TERM_DATE,
SQ_AGT_COMMINFO_HIST.ORIG_EMP_DATE as ORIG_EMP_DATE,
SQ_AGT_COMMINFO_HIST.VALIDATION_MONTHS as VALIDATION_MONTHS,
SQ_AGT_COMMINFO_HIST.PAY_RW_PRIOR_1ST_M as PAY_RW_PRIOR_1ST_M,
SQ_AGT_COMMINFO_HIST.PAY_RN_PRIOR_1ST_M as PAY_RN_PRIOR_1ST_M,
SQ_AGT_COMMINFO_HIST.FORCE_COMM_RATE_WH as FORCE_COMM_RATE_WH,
SQ_AGT_COMMINFO_HIST.BENCHMARK_IND as BENCHMARK_IND,
SQ_AGT_COMMINFO_HIST.BENCHMARK_CUTOFF as BENCHMARK_CUTOFF,
SQ_AGT_COMMINFO_HIST.BENCHMARK_MONTHS as BENCHMARK_MONTHS,
SQ_AGT_COMMINFO_HIST.BENCHMARK_MTH_PAST as BENCHMARK_MTH_PAST,
SQ_AGT_COMMINFO_HIST.VALIDATING as VALIDATING,
SQ_AGT_COMMINFO_HIST.PARTICIPATING as PARTICIPATING,
SQ_AGT_COMMINFO_HIST.LIFE_SHORT_TERM as LIFE_SHORT_TERM,
SQ_AGT_COMMINFO_HIST.MONTHS_INTO_VALIDA as MONTHS_INTO_VALIDA,
SQ_AGT_COMMINFO_HIST.EMPLOYMENT_MONTHS as EMPLOYMENT_MONTHS,
SQ_AGT_COMMINFO_HIST.PERSISTENCY_TYPE as PERSISTENCY_TYPE,
SQ_AGT_COMMINFO_HIST.ASSOCAGT_IND as ASSOCAGT_IND,
SQ_AGT_COMMINFO_HIST.source_record_id
FROM
SQ_AGT_COMMINFO_HIST
);


-- Component AGT_COMMINFO_HST, Type TARGET 
INSERT INTO db_t_prod_comn.AGT_COMMINFO_HST
(
AGENT_NBR,
ACCOUNTING_DT,
STATE_NBR,
DSTRCT,
RGN,
SERVICE_CENTER,
INACTIVECD,
PAY_AGENT_NBR,
PAYROLLNO,
AGENT_NAME,
ORIGINAL_CNTY,
TYPE_COMM,
AUTO_NB,
AUTO_RENEWAL,
AUTO_CO_COMP,
FIRE_NB,
FIRE_RENEWAL,
FIRE_CO_COMP,
BONUSCD,
EMP_MO,
EMP_YR,
VAL_MO,
VAL_YR,
STANDARD_CODE,
PREV_EXPER_CODE,
NBR_MTHS_LVL_1,
COMP_PLAN,
TERM_DATE,
ORIG_EMP_DATE,
VALIDATION_MONTHS,
PAY_RW_PRIOR_1ST_MTH_PROD,
PAY_RN_PRIOR_1ST_MTH_PROD,
FORCE_COMM_RATE_WHILE_VAL,
BENCHMARK_IND,
BENCHMARK_CUTOFF,
BENCHMARK_MONTHS,
BENCHMARK_MTH_PAST,
VALIDATING,
PARTICIPATING,
LIFE_SHORT_TERM,
MONTHS_INTO_VALIDATION,
EMPLOYMENT_MONTHS,
PERSISTENCY_TYPE,
ASSOCAGT_IND
)
SELECT
EXPTRANS.AGENT as AGENT_NBR,
EXPTRANS.ACCOUNTING_DT as ACCOUNTING_DT,
EXPTRANS.STATE as STATE_NBR,
EXPTRANS.DISTRICT as DSTRCT,
EXPTRANS.REGION as RGN,
EXPTRANS.SVC as SERVICE_CENTER,
EXPTRANS.INACTIVECD as INACTIVECD,
EXPTRANS.PAYAGT as PAY_AGENT_NBR,
EXPTRANS.PAYROLLNO as PAYROLLNO,
EXPTRANS.NAME as AGENT_NAME,
EXPTRANS.ORIGINAL_CNTY as ORIGINAL_CNTY,
EXPTRANS.TYPE_COMM as TYPE_COMM,
EXPTRANS.AUTO_NB as AUTO_NB,
EXPTRANS.AUTO_RENEWAL as AUTO_RENEWAL,
EXPTRANS.AUTO_CO_COMP as AUTO_CO_COMP,
EXPTRANS.FIRE_NB as FIRE_NB,
EXPTRANS.FIRE_RENEWAL as FIRE_RENEWAL,
EXPTRANS.FIRE_CO_COMP as FIRE_CO_COMP,
EXPTRANS.BONUSCD as BONUSCD,
EXPTRANS.EMP_MO as EMP_MO,
EXPTRANS.EMP_YR as EMP_YR,
EXPTRANS.VAL_MO as VAL_MO,
EXPTRANS.VAL_YR as VAL_YR,
EXPTRANS.STANDARD_CODE as STANDARD_CODE,
EXPTRANS.PREV_EXPER_CODE as PREV_EXPER_CODE,
EXPTRANS.NBR_MTHS_LVL_1 as NBR_MTHS_LVL_1,
EXPTRANS.COMP_PLAN as COMP_PLAN,
EXPTRANS.TERM_DATE as TERM_DATE,
EXPTRANS.ORIG_EMP_DATE as ORIG_EMP_DATE,
EXPTRANS.VALIDATION_MONTHS as VALIDATION_MONTHS,
EXPTRANS.PAY_RW_PRIOR_1ST_M as PAY_RW_PRIOR_1ST_MTH_PROD,
EXPTRANS.PAY_RN_PRIOR_1ST_M as PAY_RN_PRIOR_1ST_MTH_PROD,
EXPTRANS.FORCE_COMM_RATE_WH as FORCE_COMM_RATE_WHILE_VAL,
EXPTRANS.BENCHMARK_IND as BENCHMARK_IND,
EXPTRANS.BENCHMARK_CUTOFF as BENCHMARK_CUTOFF,
EXPTRANS.BENCHMARK_MONTHS as BENCHMARK_MONTHS,
EXPTRANS.BENCHMARK_MTH_PAST as BENCHMARK_MTH_PAST,
EXPTRANS.VALIDATING as VALIDATING,
EXPTRANS.PARTICIPATING as PARTICIPATING,
EXPTRANS.LIFE_SHORT_TERM as LIFE_SHORT_TERM,
EXPTRANS.MONTHS_INTO_VALIDA as MONTHS_INTO_VALIDATION,
EXPTRANS.EMPLOYMENT_MONTHS as EMPLOYMENT_MONTHS,
EXPTRANS.PERSISTENCY_TYPE as PERSISTENCY_TYPE,
EXPTRANS.ASSOCAGT_IND as ASSOCAGT_IND
FROM
EXPTRANS;


END; ';