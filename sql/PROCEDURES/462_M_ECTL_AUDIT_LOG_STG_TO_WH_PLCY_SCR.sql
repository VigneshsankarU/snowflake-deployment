-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_ECTL_AUDIT_LOG_STG_TO_WH_PLCY_SCR("RUN_ID" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' DECLARE SRC_TBL_NM varchar;
TGT_TBL_NM varchar;
ACT_PROJ_ID varchar;
BATCH_ACTIVE_IND varchar;
PRGM_NM varchar;
BEGIN 

SRC_TBL_NM:=''DB_T_CTRL_FIN_PROD.ECTL_BATCH_INFO''; 
TGT_TBL_NM:=''DB_T_CTRL_FIN_PROD.ECTL_BATCH_INFO''; 
PRGM_NM:='' ''; 
BATCH_ACTIVE_IND:=(select ectl_active_ind from DB_T_CTRL_FIN_PROD.ECTL_BATCH_INFO where ECTL_BATCH_ID= :run_id); 
ACT_PROJ_ID:=(select ectl_proj_id from DB_T_CTRL_FIN_PROD.ECTL_BATCH_INFO where ECTL_BATCH_ID= :run_id); 

-- Component sq_Staging_table, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE sq_Staging_table AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as POL_NBR,
$2 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT COUNT(*) AS POL_NBR 
FROM
table(:SRC_TBL_NM)
) SRC
)
);


-- Component sq_Target_table, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE sq_Target_table AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as PLCY_NBR,
$2 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT 
A.INS_CNT FROM 
(SELECT COUNT(*) AS INS_CNT FROM table(:TGT_TBL_NM) A, DB_T_CTRL_FIN_PROD.ECTL_BATCH_INFO B WHERE b.ECTL_ACTIVE_IND=:BATCH_ACTIVE_IND AND b.ECTL_PROJ_ID=:ACT_PROJ_ID AND A.ECTL_BATCH_ID=B.ECTL_BATCH_ID) A
) SRC
)
);


-- Component exp_DUMMY_SRC_PORT, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_DUMMY_SRC_PORT AS
(
SELECT
TO_NUMBER(sq_Staging_table.POL_NBR) as out_SRC_CNT,
1 as out_DUMMY,
sq_Staging_table.source_record_id
FROM
sq_Staging_table
);


-- Component exp_DUMMY_TGT_PORT, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_DUMMY_TGT_PORT AS
(
SELECT
TO_NUMBER(sq_Target_table.PLCY_NBR) as out_TGT_INS_CNT,
1 as out_DUMMY,
sq_Target_table.source_record_id
FROM
sq_Target_table
);


-- Component jnr_SRC_TGT_TABLE, Type JOINER 
CREATE OR REPLACE TEMPORARY TABLE jnr_SRC_TGT_TABLE AS
(
SELECT
exp_DUMMY_SRC_PORT.out_SRC_CNT as SRC_CNT,
exp_DUMMY_SRC_PORT.out_DUMMY as DUMMY_SRC,
exp_DUMMY_TGT_PORT.out_TGT_INS_CNT as TGT_INS_CNT,
exp_DUMMY_TGT_PORT.out_DUMMY as DUMMY_TGT,
row_number() over (order by 1) AS source_record_id
FROM
exp_DUMMY_SRC_PORT
INNER JOIN exp_DUMMY_TGT_PORT ON exp_DUMMY_TGT_PORT.out_DUMMY = exp_DUMMY_SRC_PORT.out_DUMMY
);


-- Component exp_CREATE_ECTL_FIELDS, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_CREATE_ECTL_FIELDS AS
(
SELECT
jnr_SRC_TGT_TABLE.SRC_CNT as out_SRC_CNT,
jnr_SRC_TGT_TABLE.TGT_INS_CNT as out_TGT_INS_CNT,
:SRC_TBL_NM as out_SRC_TBL_NM,
:ACT_PROJ_ID as out_PROJ_ID,
:BATCH_ACTIVE_IND as out_BATCH_ACTIVE_IND,
:PRGM_NM as out_PRGM_NM,
:ACT_PROJ_ID as IN_ACT_PROJ_ID,
:BATCH_ACTIVE_IND as IN_BATCH_ACTIVE_IND,
''m_STG_FIN_CLM'' IN_PRGM_NM,
null IN_TABLE_NM,
0 as out_TGT_UPD_DEL_CNT,
jnr_SRC_TGT_TABLE.SRC_CNT - jnr_SRC_TGT_TABLE.TGT_INS_CNT as out_TGT_REJ_CNT,
:TGT_TBL_NM || '' -  AUDIT INFORMATION SUCCESSFULLY LOADED'' as out_MESSAGE_TXT,
CURRENT_TIMESTAMP as out_ECTL_ORIG_INS_TS,
jnr_SRC_TGT_TABLE.source_record_id
FROM
jnr_SRC_TGT_TABLE
);


-- Component mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE, Type MAPPLET 
--MAPPLET NOT REGISTERED: mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE, mapplet instance mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE;
call mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE(''exp_CREATE_ECTL_FIELDS'');

-- Component exp_ECTL_AUDIT_LOG_INPUTS, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_ECTL_AUDIT_LOG_INPUTS AS
(
SELECT
exp_CREATE_ECTL_FIELDS.out_SRC_CNT as out_SRC_CNT,
exp_CREATE_ECTL_FIELDS.out_TGT_INS_CNT as out_TGT_INS_CNT,
exp_CREATE_ECTL_FIELDS.out_TGT_UPD_DEL_CNT as out_TGT_UPD_DEL_CNT,
exp_CREATE_ECTL_FIELDS.out_TGT_REJ_CNT as out_TGT_REJ_CNT,
exp_CREATE_ECTL_FIELDS.out_MESSAGE_TXT as out_MESSAGE_TXT,
exp_CREATE_ECTL_FIELDS.out_ECTL_ORIG_INS_TS as out_ECTL_ORIG_INS_TS,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_PRGM_ID as out_ECTL_PRGM_ID,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_BATCH_ID as out_ECTL_BATCH_ID,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_TABLE_ID as out_ECTL_TABLE_ID,
exp_CREATE_ECTL_FIELDS.source_record_id
FROM
exp_CREATE_ECTL_FIELDS
INNER JOIN mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE ON exp_CREATE_ECTL_FIELDS.source_record_id = mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.source_record_id
);


-- Component ECTL_AUDIT_LOG_INS, Type TARGET 
INSERT INTO DB_T_CTRL_FIN_PROD.ECTL_AUDIT_LOG
(
ECTL_BATCH_ID,
ECTL_PRGM_ID,
ECTL_TABLE_ID,
ECTL_SRC_ROW_CNT,
ECTL_TRGT_INS_CNT,
ECTL_TRGT_UPD_CNT,
ECTL_TRGT_DEL_CNT,
ECTL_TRGT_REJ_CNT,
ECTL_MESSAGE_TXT,
ECTL_ORIG_INS_TS
)
SELECT
exp_ECTL_AUDIT_LOG_INPUTS.out_ECTL_BATCH_ID as ECTL_BATCH_ID,
exp_ECTL_AUDIT_LOG_INPUTS.out_ECTL_PRGM_ID as ECTL_PRGM_ID,
nvl(exp_ECTL_AUDIT_LOG_INPUTS.out_ECTL_TABLE_ID,-1) as ECTL_TABLE_ID,
exp_ECTL_AUDIT_LOG_INPUTS.out_SRC_CNT as ECTL_SRC_ROW_CNT,
exp_ECTL_AUDIT_LOG_INPUTS.out_TGT_INS_CNT as ECTL_TRGT_INS_CNT,
exp_ECTL_AUDIT_LOG_INPUTS.out_TGT_UPD_DEL_CNT as ECTL_TRGT_UPD_CNT,
exp_ECTL_AUDIT_LOG_INPUTS.out_TGT_UPD_DEL_CNT as ECTL_TRGT_DEL_CNT,
exp_ECTL_AUDIT_LOG_INPUTS.out_TGT_REJ_CNT as ECTL_TRGT_REJ_CNT,
exp_ECTL_AUDIT_LOG_INPUTS.out_MESSAGE_TXT as ECTL_MESSAGE_TXT,
exp_ECTL_AUDIT_LOG_INPUTS.out_ECTL_ORIG_INS_TS as ECTL_ORIG_INS_TS
FROM
exp_ECTL_AUDIT_LOG_INPUTS;


END; ';