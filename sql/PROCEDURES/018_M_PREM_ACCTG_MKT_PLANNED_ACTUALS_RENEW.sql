-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_PREM_ACCTG_MKT_PLANNED_ACTUALS_RENEW("PARAM_JSON" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' 
DECLARE
  RUN_DATE STRING;
  LOOKBACK_YR STRING;
BEGIN
  SELECT 
    TRY_PARSE_JSON(:param_json):RUN_DATE::STRING,
    TRY_PARSE_JSON(:param_json):LOOKBACK_YR::STRING
  INTO
    RUN_DATE,
    LOOKBACK_YR;

-- Component SQ_FIN_MANUAL_ENTRIES_PREMIUM_TXN, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_FIN_MANUAL_ENTRIES_PREMIUM_TXN AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as MTRC,
$2 as ST_CD,
$3 as SEGMENT,
$4 as LOB_GRP,
$5 as PRD,
$6 as YR,
$7 as ACTUAL_AMT,
$8 as PLND_AMT,
$9 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT MTRC, ST_CD, SEGMENT, LOB_GRP, PRD, YR, ACTUAL_AMT, Sum(PLND_AMT) AS PLND_AMT

FROM

(

SELECT  ACTL.MTRC AS MTRC, ACTL.ST_CD AS ST_CD, ACTL.SEGMENT AS SEGMENT, ACTL.LOB_GRP AS LOB_GRP, ACTL.PRD AS PRD, ACTL.YR AS YR, ACTL.ACTUAL_AMT AS ACTUAL_AMT, 

CASE WHEN (PLAN.PLND_AMT*-1) > 0 THEN (PLAN.PLND_AMT*-1) ELSE 0 END AS PLND_AMT

FROM

(SELECT RENEW.MTRC, RENEW.ST_CD, RENEW.LOB_GRP, RENEW.SEGMENT, RENEW.PRD, RENEW.YR, SUM(RENEW.ACTUAL_AMT) AS ACTUAL_AMT FROM (

SELECT ''RENEW'' AS MTRC, ST_CD,

CASE WHEN LOB_CD = ''PRIVATE PASSENGER AUTO'' THEN ''AUTO''

WHEN LOB_CD IN (''HOMEOWNER/MANUF HOME'',''FIRE'',''FARMOWNER'',''FARMOWNERS'',''FCL'',''Floater'') THEN ''PROPERTY'' /* Added ''FARMOWNERS'',''FCL'',''Floater'' as part of EIM-49071,EIM-50215 */
ELSE ''COMMERCIAL/OTHER'' END AS LOB_GRP, 

CASE WHEN CO_CD IN (''ASI'',''AVI'') THEN ''TREXIS'' ELSE ''CORE'' END AS SEGMENT,

ACCT_MO AS PRD, ACCT_YR AS YR, SUM(MNTARY_AMT) AS ACTUAL_AMT

FROM  DB_V_PROD_ACT.W_PREMIUM_INFO_ACT

WHERE ACCT_CD IN (400250,400254,400264,400300,400303,400324,402310,402204,402205) AND 

MO_ID >=cast(cast(extract( year from ADD_MONTHS(:RUN_DATE,-1) )-:LOOKBACK_YR as varchar(4)) ||''01'' as varchar(6))  

AND 

MO_ID <=TO_CHAR(DATEADD(MONTH, -1, :RUN_DATE), ''YYYYMM'') 

AND ST_CD IN (''AL'',''GA'',''MS'')

GROUP BY 2,3,4,5,6

UNION

SELECT  ''RENEW'' AS MTRC, DB_T_SHRD_PROD.STATE AS ST_CD, 

CASE WHEN SUBSTR(PRODUCT,1,1) = ''A'' THEN ''AUTO''

     WHEN SUBSTR(PRODUCT,1,1) IN (''H'') THEN ''PROPERTY''

ELSE ''COMMERCIAL/OTHER'' END AS LOB_GRP,

CASE WHEN SUBSTR(BUSINESS_UNIT,1,3) IN (''ASI'',''AVI'') THEN ''TREXIS'' ELSE ''CORE'' END AS SEGMENT,

MONTH_ID AS PRD, CAST(YEAR1 AS INTEGER) AS YR, SUM(MONETARY_AMOUNT * -1) AS ACTUAL_AMT

FROM  DB_T_CORE_FIN_PROD.FIN_MANUAL_ENTRIES_PREMIUM_TXN

WHERE ACCOUNT1 IN (400250,400254,400264,400300,400303,400324,402310,402204,402205) AND 

ltrim(rtrim(YEAR1))||lpad(ltrim(rtrim(MONTH_ID)),2,''0'') >=cast(cast(extract( year from ADD_MONTHS(:RUN_DATE,-1) )-:LOOKBACK_YR as varchar(4)) ||''01'' as varchar(6)) 

AND

ltrim(rtrim(YEAR1))||lpad(ltrim(rtrim(MONTH_ID)),2,''0'') <=TO_CHAR(DATEADD(MONTH, -1, :RUN_DATE), ''YYYYMM'') 

AND DB_T_SHRD_PROD.STATE IN (''AL'',''GA'',''MS'')

GROUP BY 2,3,4,5,6)RENEW

GROUP BY 1,2,3,4,5,6) ACTL

LEFT JOIN DB_T_CORE_FIN_PROD.PLANNED_PREM PLAN

ON PLAN.LOB_GRP = ACTL.LOB_GRP AND PLAN.MTRC = ACTL.MTRC AND PLAN.ST_CD = ACTL.ST_CD AND PLAN.SEGMENT = ACTL.SEGMENT AND PLAN.YR = ACTL.YR AND PLAN.PRD = ACTL.PRD 

WHERE ACTL.MTRC = ''RENEW''

AND

ltrim(rtrim(PLAN.YR))||lpad(ltrim(rtrim(PLAN.PRD)),2,''0'') >=cast(cast(extract( year from ADD_MONTHS(:RUN_DATE,-1) )-:LOOKBACK_YR as varchar(4)) ||''01'' as varchar(6)) 

AND

ltrim(rtrim(PLAN.YR))||lpad(ltrim(rtrim(PLAN.PRD)),2,''0'') <=TO_CHAR(DATEADD(MONTH, -1, :RUN_DATE), ''YYYYMM'') 



)MAIN

GROUP BY MTRC, ST_CD, SEGMENT, LOB_GRP, PRD, YR, ACTUAL_AMT

ORDER BY 6,5,1,2,3
) SRC
)
);


-- Component exp_src_tgt, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_src_tgt AS
(
SELECT
SQ_FIN_MANUAL_ENTRIES_PREMIUM_TXN.MTRC as MTRC,
SQ_FIN_MANUAL_ENTRIES_PREMIUM_TXN.ST_CD as ST_CD,
SQ_FIN_MANUAL_ENTRIES_PREMIUM_TXN.SEGMENT as SEGMENT,
SQ_FIN_MANUAL_ENTRIES_PREMIUM_TXN.LOB_GRP as LOB_GRP,
SQ_FIN_MANUAL_ENTRIES_PREMIUM_TXN.PRD as PRD,
SQ_FIN_MANUAL_ENTRIES_PREMIUM_TXN.YR as YR,
SQ_FIN_MANUAL_ENTRIES_PREMIUM_TXN.ACTUAL_AMT as ACTUAL_AMT,
SQ_FIN_MANUAL_ENTRIES_PREMIUM_TXN.PLND_AMT as PLND_AMT,
SQ_FIN_MANUAL_ENTRIES_PREMIUM_TXN.source_record_id
FROM
SQ_FIN_MANUAL_ENTRIES_PREMIUM_TXN
);


-- Component PREM_ACCTG_MKT_PLANNED_ACTUALS_RENEW, Type TARGET_EXPORT_PREPARE Stage data before exporting
CREATE OR REPLACE TEMPORARY TABLE PREM_ACCTG_MKT_PLANNED_ACTUALS_RENEW AS
(
SELECT
exp_src_tgt.MTRC as MTRC,
exp_src_tgt.ST_CD as ST_CD,
exp_src_tgt.SEGMENT as SEGMENT,
exp_src_tgt.LOB_GRP as LOB_GRP,
exp_src_tgt.PRD as PRD,
exp_src_tgt.YR as YR,
exp_src_tgt.ACTUAL_AMT as ACTUAL_AMT,
exp_src_tgt.PLND_AMT as PLND_AMT
FROM
exp_src_tgt
);


-- Component PREM_ACCTG_MKT_PLANNED_ACTUALS_RENEW, Type EXPORT_DATA Exporting data
;


END; ';