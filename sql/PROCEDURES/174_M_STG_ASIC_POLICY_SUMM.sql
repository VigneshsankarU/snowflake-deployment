-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_STG_ASIC_POLICY_SUMM("RUN_ID" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' BEGIN 

-- Component sq_STG_ASIC_POLICY_SUMM, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE sq_STG_ASIC_POLICY_SUMM AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as PLCY_SVC_NUMBER,
$2 as PLCY_NBR,
$3 as CHG_EFF_DT,
$4 as CHG_EXP_DT,
$5 as ALPHA_CODE,
$6 as EFF_DATE,
$7 as EXP_DATE,
$8 as FIRST_NAME,
$9 as LAST_NAME,
$10 as ADDL_FIRST_NAME,
$11 as ADDL_LAST_NAME,
$12 as ADDRESS_LINE_1,
$13 as ADDRESS_LINE_2,
$14 as CITY,
$15 as STATE_CD,
$16 as ZIP,
$17 as ZIP_EXT,
$18 as PC_TAX_CODE,
$19 as AGENCY_NBR,
$20 as MEMBER_NUMBER,
$21 as MEMB_TYPE,
$22 as ENCUMBRANCE,
$23 as COMPANY_CD,
$24 as STATUS_CD,
$25 as STATUS_DESC,
$26 as NM_1_SSN,
$27 as NM_2_SSN,
$28 as RISK_STATE,
$29 as PC_ALPHA_2,
$30 as MO_ID,
$31 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
WITH ECTL_HEADER_DATES AS(


SELECT
  FROM_DATE,
  TO_DATE,
  DATEADD (
    MONTH,
    1,
    DATE_TRUNC (''MONTH'', CAST(TO_DATE AS DATE))
  ) - 1 AS CAL_END_DATE,
  TO_DATE (TO_DATE) AS CAL_TO_DATE,
  (ACCOUNTING_YR * 100) + ACCOUNTING_MO AS MO_ID
FROM
  DB_T_CTRL_PROD.ECTL_MISPREM_HEADER 

 WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID

)



SELECT TRIM(CAST(A.PLCY_SVC_NUMBER AS VARCHAR(10))) PLCY_SVC_NUMBER,A.PLCY_NBR,A.CHG_EFF_DT,A.CHG_EXP_DT,A.ALPHA_CODE,A.EFF_DATE,A.EXP_DATE,

CASE WHEN  INDEX(A.NAME_1,'' '')>0 THEN SUBSTR(A.NAME_1,1,POSITION('' '' IN A.NAME_1)-1) 

WHEN INDEX(A.NAME_1,'' '')=0 AND INDEX(A.NAME_1,''.'')>0   THEN SUBSTR(A.NAME_1,1,POSITION(''.'' IN A.NAME_1)-1) ELSE A.NAME1 END AS FIRST_NAME, 

CASE WHEN  INDEX(A.NAME_1,'' '')>0 THEN SUBSTR(A.NAME_1,POSITION('' '' IN A.NAME_1)+1) 

WHEN INDEX(A.NAME_1,'' '')=0 AND INDEX(A.NAME_1,''.'')>0   THEN SUBSTR(A.NAME_1,POSITION('' '' IN A.NAME_1)+1) ELSE A.NAME1 END AS LAST_NAME,

CASE WHEN  INDEX(A.NAME_2,'' '')>0 THEN SUBSTR(A.NAME_2,1,POSITION('' '' IN A.NAME_2)-1) 

WHEN INDEX(A.NAME_2,'' '')=0 AND INDEX(A.NAME_2,''.'')>0   THEN SUBSTR(A.NAME_2,1,POSITION(''.'' IN A.NAME_2)-1) ELSE A.NAME2 END AS ADDL_FIRST_NAME, 

CASE WHEN  INDEX(A.NAME_2,'' '')>0 THEN SUBSTR(A.NAME_2,POSITION('' '' IN A.NAME_2)+1) 

WHEN INDEX(A.NAME_2,'' '')=0 AND INDEX(A.NAME_2,''.'')>0   THEN SUBSTR(A.NAME_2,POSITION('' '' IN A.NAME_2)+1) ELSE A.NAME2 END AS ADDL_LAST_NAME,A.ADDRESS_LINE_1,A.ADDRESS_LINE_2,A.CITY,A.STATE_CD,A.ZIP,A.ZIP_EXT,A.PC_TAX_CODE,TRIM(CAST(A.AGENCY_NBR AS VARCHAR(10))),

TRIM(CAST(A.MEMBER_NUMBER AS VARCHAR(10))) MEMB_CUST_NBR,DB_T_SHRD_PROD.MEMBER_TYPE MEMB_TYPE,A.ENCUMBRANCE,A.COMPANY_CD,A.STATUS_CD,

TRIM(B.SC_DESC) AS STATUS_DESC,A.NM_1_SSN,A.NM_2_SSN,A.RISK_STATE,A.PC_ALPHA_2,A.MO_ID

FROM (

SELECT SC_SERVICE_CENTER PLCY_SVC_NUMBER,SC_POLICY_NUM PLCY_NBR,CHG_EFF_DT,CHG_EXP_DT,PC_ALPHA_CODE ALPHA_CODE,PC_EFF_DATE EFF_DATE,

PC_EXP_DATE EXP_DATE, PC_NAME_1,PC_NAME_2,

CASE WHEN PC_NAME_1 LIKE ''%&%'' AND SUBSTR(TRIM(PC_NAME_1),CHARACTERS(TRIM(PC_NAME_1)),1)=''&'' THEN SUBSTR(TRIM(PC_NAME_1),1,POSITION(''&'' IN TRIM(PC_NAME_1))-1) 

WHEN PC_NAME_1 LIKE ''%&%'' AND SUBSTR(TRIM(PC_NAME_1),CHARACTERS(TRIM(PC_NAME_1)),1)<>''&'' THEN SUBSTR(TRIM(PC_NAME_1),1,POSITION(''&'' IN TRIM(PC_NAME_1))-1) 

ELSE PC_NAME_1 END  NAME1,

CASE 

WHEN PC_NAME_1 LIKE ''%&%'' AND SUBSTR(TRIM(PC_NAME_1),CHARACTERS(TRIM(PC_NAME_1)),1)<>''&'' AND INDEX(TRIM(PC_NAME_2),'' '')>0 

THEN TRIM(SUBSTR(TRIM(PC_NAME_1),POSITION(''&'' IN TRIM(PC_NAME_1))+1) )

WHEN PC_NAME_1 LIKE ''%&%'' AND SUBSTR(TRIM(PC_NAME_1),CHARACTERS(TRIM(PC_NAME_1)),1)<>''&'' AND INDEX(TRIM(PC_NAME_2),'' '')=0 

THEN TRIM(SUBSTR(TRIM(PC_NAME_1),POSITION(''&'' IN TRIM(PC_NAME_1))+1) )||'' ''||PC_NAME_2 

ELSE PC_NAME_2 END  NAME2,trim(name1) name_1, trim(name2) name_2,

CASE WHEN ( TRIM(SUBSTR(TRIM(PC_NAME_1),POSITION(''&'' IN TRIM(PC_NAME_1))+1) )||'' ''||PC_NAME_2  LIKE NAME2 

OR NAME2=PC_NAME_2)

THEN NULL  ELSE PC_NAME_2  END NAME3,CASE WHEN (NAME3 IS NOT NULL AND TRIM(PC_ADDRESS_2)='''' )THEN NAME3 ELSE PC_ADDRESS_1 END ADDRESS_LINE_1,

CASE WHEN (NAME3 IS NOT NULL AND TRIM(PC_ADDRESS_2)='''') THEN PC_ADDRESS_1 ELSE PC_ADDRESS_2 END  ADDRESS_LINE_2, 

--TRIM(SUBSTRING(TRIM(PC_CITYST) FROM 1 FOR CHARACTER_LENGTH(TRIM(PC_CITYST)) -2)) AS CITY,
TRIM(
  LEFT (TRIM(PC_CITYST), LENGTH (TRIM(PC_CITYST)) - 2)
) AS CITY,
RIGHT (TRIM(PC_CITYST), 2) AS STATE_CD,
PC_ZIP ZIP,PC_ZIP_EXT ZIP_EXT,PC_TAX_CODE,PC_AGENT AGENCY_NBR,

CAST(SUBSTR(PC_MEMBER_NUMBER,2) AS INTEGER) MEMBER_NUMBER,

RIGHT (TRIM(PC_CITYST), 2) AS STATE_CD,
CASE
  WHEN PC_STATE = ''AL'' THEN ''MBR''
  ELSE ''CST''
END AS MEMBER_TYPE,

PC_ENCUMBRANCE ENCUMBRANCE,PC_COMPANY COMPANY_CD,PC_STATUS STATUS_CD,

PC_SSNO_1 NM_1_SSN,PC_SSNO_2 NM_2_SSN,PC_STATE RISK_STATE,PC_ALPHA_2,

EXTRACT(YEAR FROM ECTL.CAL_END_DATE)*100+EXTRACT(MONTH FROM ECTL.CAL_END_DATE) MO_ID

FROM DB_T_CORE_MEMBXREF_PROD.ASICPOLS A,ECTL_HEADER_DATES ECTL

WHERE ECTL.CAL_END_DATE BETWEEN CHG_EFF_DT AND CHG_EXP_DT) A

LEFT OUTER JOIN

(SELECT * FROM DB_T_STAG_MEMBXREF_PROD.PS_LOOKUP  WHERE FIELD_NAME=''PC_STATUS'') B

ON CAST(A.STATUS_CD AS INTEGER)=CAST(B.FIELD_VALUE AS INTEGER)
) SRC
)
);


-- Component exp_STG_ASIC_POLICY_SUMM, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_STG_ASIC_POLICY_SUMM AS
(
SELECT
sq_STG_ASIC_POLICY_SUMM.PLCY_SVC_NUMBER as PLCY_SVC_NUMBER,
sq_STG_ASIC_POLICY_SUMM.PLCY_NBR as PLCY_NBR,
sq_STG_ASIC_POLICY_SUMM.CHG_EFF_DT as CHG_EFF_DT,
sq_STG_ASIC_POLICY_SUMM.CHG_EXP_DT as CHG_EXP_DT,
sq_STG_ASIC_POLICY_SUMM.ALPHA_CODE as ALPHA_CODE,
sq_STG_ASIC_POLICY_SUMM.EFF_DATE as EFF_DATE,
sq_STG_ASIC_POLICY_SUMM.EXP_DATE as EXP_DATE,
sq_STG_ASIC_POLICY_SUMM.FIRST_NAME as FIRST_NAME,
sq_STG_ASIC_POLICY_SUMM.LAST_NAME as LAST_NAME,
sq_STG_ASIC_POLICY_SUMM.ADDL_FIRST_NAME as ADDL_FIRST_NAME,
sq_STG_ASIC_POLICY_SUMM.ADDL_LAST_NAME as ADDL_LAST_NAME,
sq_STG_ASIC_POLICY_SUMM.ADDRESS_LINE_1 as ADDRESS_LINE_1,
sq_STG_ASIC_POLICY_SUMM.ADDRESS_LINE_2 as ADDRESS_LINE_2,
sq_STG_ASIC_POLICY_SUMM.CITY as CITY,
sq_STG_ASIC_POLICY_SUMM.STATE_CD as STATE_CD,
sq_STG_ASIC_POLICY_SUMM.ZIP as ZIP,
sq_STG_ASIC_POLICY_SUMM.ZIP_EXT as ZIP_EXT,
sq_STG_ASIC_POLICY_SUMM.PC_TAX_CODE as PC_TAX_CODE,
sq_STG_ASIC_POLICY_SUMM.AGENCY_NBR as AGENCY_NBR,
sq_STG_ASIC_POLICY_SUMM.MEMBER_NUMBER as MEMBER_NUMBER,
sq_STG_ASIC_POLICY_SUMM.MEMB_TYPE as MEMB_TYPE,
sq_STG_ASIC_POLICY_SUMM.ENCUMBRANCE as ENCUMBRANCE,
sq_STG_ASIC_POLICY_SUMM.COMPANY_CD as COMPANY_CD,
sq_STG_ASIC_POLICY_SUMM.STATUS_CD as STATUS_CD,
sq_STG_ASIC_POLICY_SUMM.STATUS_DESC as STATUS_DESC,
sq_STG_ASIC_POLICY_SUMM.NM_1_SSN as NM_1_SSN,
sq_STG_ASIC_POLICY_SUMM.NM_2_SSN as NM_2_SSN,
sq_STG_ASIC_POLICY_SUMM.RISK_STATE as RISK_STATE,
sq_STG_ASIC_POLICY_SUMM.PC_ALPHA_2 as PC_ALPHA_2,
sq_STG_ASIC_POLICY_SUMM.MO_ID as MO_ID,
sq_STG_ASIC_POLICY_SUMM.source_record_id
FROM
sq_STG_ASIC_POLICY_SUMM
);


-- Component STG_ASIC_POLICY_SUMM, Type TARGET 
INSERT INTO DB_T_STAG_PROD.STG_ASIC_POLICY_SUMM
(
PLCY_SVC_NUMBER,
PLCY_NBR,
CHG_EFF_DT,
CHG_EXP_DT,
ALPHA_CODE,
EFF_DATE,
EXP_DATE,
FIRST_NAME,
LAST_NAME,
ADDL_FIRST_NAME,
ADDL_LAST_NAME,
ADDRESS_LINE_1,
ADDRESS_LINE_2,
CITY,
STATE_CD,
ZIP,
ZIP_EXT,
PC_TAX_CODE,
AGENCY_NBR,
MEMBER_NUMBER,
MEMB_TYPE,
ENCUMBRANCE,
COMPANY_CD,
STATUS_CD,
STATUS_DESC,
NM_1_SSN,
NM_2_SSN,
RISK_STATE,
PC_ALPHA_2,
MO_ID
)
SELECT
exp_STG_ASIC_POLICY_SUMM.PLCY_SVC_NUMBER as PLCY_SVC_NUMBER,
exp_STG_ASIC_POLICY_SUMM.PLCY_NBR as PLCY_NBR,
exp_STG_ASIC_POLICY_SUMM.CHG_EFF_DT as CHG_EFF_DT,
exp_STG_ASIC_POLICY_SUMM.CHG_EXP_DT as CHG_EXP_DT,
exp_STG_ASIC_POLICY_SUMM.ALPHA_CODE as ALPHA_CODE,
exp_STG_ASIC_POLICY_SUMM.EFF_DATE as EFF_DATE,
exp_STG_ASIC_POLICY_SUMM.EXP_DATE as EXP_DATE,
exp_STG_ASIC_POLICY_SUMM.FIRST_NAME as FIRST_NAME,
exp_STG_ASIC_POLICY_SUMM.LAST_NAME as LAST_NAME,
exp_STG_ASIC_POLICY_SUMM.ADDL_FIRST_NAME as ADDL_FIRST_NAME,
exp_STG_ASIC_POLICY_SUMM.ADDL_LAST_NAME as ADDL_LAST_NAME,
exp_STG_ASIC_POLICY_SUMM.ADDRESS_LINE_1 as ADDRESS_LINE_1,
exp_STG_ASIC_POLICY_SUMM.ADDRESS_LINE_2 as ADDRESS_LINE_2,
exp_STG_ASIC_POLICY_SUMM.CITY as CITY,
exp_STG_ASIC_POLICY_SUMM.STATE_CD as STATE_CD,
exp_STG_ASIC_POLICY_SUMM.ZIP as ZIP,
exp_STG_ASIC_POLICY_SUMM.ZIP_EXT as ZIP_EXT,
exp_STG_ASIC_POLICY_SUMM.PC_TAX_CODE as PC_TAX_CODE,
exp_STG_ASIC_POLICY_SUMM.AGENCY_NBR as AGENCY_NBR,
exp_STG_ASIC_POLICY_SUMM.MEMBER_NUMBER as MEMBER_NUMBER,
exp_STG_ASIC_POLICY_SUMM.MEMB_TYPE as MEMB_TYPE,
exp_STG_ASIC_POLICY_SUMM.ENCUMBRANCE as ENCUMBRANCE,
exp_STG_ASIC_POLICY_SUMM.COMPANY_CD as COMPANY_CD,
exp_STG_ASIC_POLICY_SUMM.STATUS_CD as STATUS_CD,
exp_STG_ASIC_POLICY_SUMM.STATUS_DESC as STATUS_DESC,
exp_STG_ASIC_POLICY_SUMM.NM_1_SSN as NM_1_SSN,
exp_STG_ASIC_POLICY_SUMM.NM_2_SSN as NM_2_SSN,
exp_STG_ASIC_POLICY_SUMM.RISK_STATE as RISK_STATE,
exp_STG_ASIC_POLICY_SUMM.PC_ALPHA_2 as PC_ALPHA_2,
exp_STG_ASIC_POLICY_SUMM.MO_ID as MO_ID
FROM
exp_STG_ASIC_POLICY_SUMM;


END; ';