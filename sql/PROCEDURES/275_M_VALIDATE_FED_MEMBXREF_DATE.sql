-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_VALIDATE_FED_MEMBXREF_DATE("RUN_ID" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' BEGIN 

-- PIPELINE START FOR 1

-- Component SQ_STG_MEMBXREF_TRIGGER, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_STG_MEMBXREF_TRIGGER AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as CNT,
$2 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT 
	COUNT(DISTINCT FEED_DT) 
FROM 
	DB_T_STAG_MEMBXREF_PROD.STG_MEMBXREF_TRIGGER
) SRC
)
);


-- Component exp_ABORT, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_ABORT AS
(
SELECT
CASE WHEN SQ_STG_MEMBXREF_TRIGGER.CNT <> 1 THEN ''F'' ELSE ''S'' END as FLAG,
CASE WHEN SQ_STG_MEMBXREF_TRIGGER.CNT <> 1 THEN 
null --RAISE_ERROR(''FEED DT not available or mismatch in FEED_DT '') 
ELSE null END as ABORT,
SQ_STG_MEMBXREF_TRIGGER.source_record_id
FROM
SQ_STG_MEMBXREF_TRIGGER
);


-- Component exp_Pass_Through, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_Pass_Through AS
(
SELECT
exp_ABORT.FLAG as FLAG,
exp_ABORT.source_record_id
FROM
exp_ABORT
);


-- Component DUMMY, Type TARGET_EXPORT_PREPARE Stage data before exporting
CREATE OR REPLACE TEMPORARY TABLE DUMMY AS
(
SELECT
exp_Pass_Through.FLAG as FLAG
FROM
exp_Pass_Through
);


-- Component DUMMY, Type EXPORT_DATA Exporting data
;


-- PIPELINE END FOR 1

-- PIPELINE START FOR 2

-- Component SQ_STG_MEMBXREF_TRIGGER1, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_STG_MEMBXREF_TRIGGER1 AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as CNT1,
$2 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT COUNT(*) AS CNT1 FROM 
(SELECT CASE WHEN A.FED_LOAD >= B.MEMBXREF_LOAD THEN ''YES'' ELSE ''NO'' END AS CANLOAD 
FROM 
(SELECT CAST(ECTL_PARAM_VALUE AS DATE ) AS FED_LOAD 
FROM DB_T_CTRL_FIN_PROD.ECTL_PRGM_PARAM WHERE TRIM(ECTL_PARAM_DESC)=''Federation Last load Date'') a, 
(SELECT CASE WHEN A.DAY_OF_WEEK=1 THEN  FEED_DT-2 
WHEN A.DAY_OF_WEEK=7 THEN  FEED_DT-1 
ELSE FEED_DT END AS MEMBXREF_LOAD 
FROM DB_T_STAG_MEMBXREF_PROD.STG_MEMBXREF_TRIGGER STAG, DB_V_PROD_SMNTC.CALENDAR A 
WHERE STAG.FEED_DT=A.CALENDAR_DATE GROUP BY 1) b 
WHERE CANLOAD = ''NO'')c
) SRC
)
);


-- Component exp_ABORT1, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_ABORT1 AS
(
SELECT
CASE WHEN SQ_STG_MEMBXREF_TRIGGER1.CNT1 <> 0 THEN ''F'' ELSE ''S'' END as FLAG,
CASE WHEN SQ_STG_MEMBXREF_TRIGGER1.CNT1 <> 0 THEN 
null --RAISE_ERROR(''Mismatch between Federation and Membxref load month'') 
ELSE null END as ABORT,
SQ_STG_MEMBXREF_TRIGGER1.source_record_id
FROM
SQ_STG_MEMBXREF_TRIGGER1
);


-- Component exp_Pass_Through1, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_Pass_Through1 AS
(
SELECT
exp_ABORT1.FLAG as FLAG,
exp_ABORT1.source_record_id
FROM
exp_ABORT1
);


-- Component DUMMY1, Type TARGET_EXPORT_PREPARE Stage data before exporting
CREATE OR REPLACE TEMPORARY TABLE DUMMY1 AS
(
SELECT
exp_Pass_Through1.FLAG as FLAG
FROM
exp_Pass_Through1
);


-- Component DUMMY1, Type EXPORT_DATA Exporting data
;


-- PIPELINE END FOR 2

END; ';