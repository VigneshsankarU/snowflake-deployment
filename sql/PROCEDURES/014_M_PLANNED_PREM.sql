-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_PLANNED_PREM("PARAM_JSON" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' 
DECLARE
  PRCS_ID STRING;
BEGIN
  SELECT 
    TRY_PARSE_JSON(:param_json):PRCS_ID::STRING
  INTO
    PRCS_ID;

-- Component PLANNED_PREM, Type Pre SQL 
DELETE from PLANNED_PREM CORE where CORE.YR in(select YR from DB_STAG_FIN.STG_PLANNED_PREM);


-- Component SQ_STG_PLANNED_PREM, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_STG_PLANNED_PREM AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as MTRC,
$2 as STD_CD,
$3 as LOB_GRP,
$4 as SEGMENT,
$5 as UNIT,
$6 as PRD,
$7 as YR,
$8 as PLND_AMT,
$9 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT DISTINCT MTRC, ST_CD, LOB_GRP, SEGMENT, UNIT, PRD, YR, SUM(PLND_AMT) AS PLND_AMT FROM (

/* RENEW PLANNED METRIC */
SELECT DISTINCT ''RENEW'' AS MTRC , DB_T_SHRD_PROD.STATE AS ST_CD, 

	CASE WHEN SUBSTR(PROD,1,1) = ''A'' THEN ''AUTO''

	 WHEN SUBSTR(PROD,1,1) IN (''H'') THEN ''PROPERTY''

	ELSE ''COMMERCIAL/OTHER'' END AS LOB_GRP,

	CASE WHEN SUBSTR(UNIT,1,3) IN (''ASI'',''AVI'') THEN ''TREXIS'' ELSE ''CORE'' END AS SEGMENT, UNIT,

PRD, YR, SUM(TOTAL_AMT) AS PLND_AMT

FROM DB_T_STAG_FIN_PROD.STG_PLANNED_PREM STG

WHERE ACCT IN (400250,400254,400264,400300,400303,400324,402310,402204,402205) 

/* WHERE ACCT IN (400250,400254,400264,400300,400303,400324,402310)--,402204,402205) --TO TEST THE AMOUNTS MATCHING W/ OLD SB DATA LOAD */
GROUP BY MTRC, DB_T_SHRD_PROD.STATE, PROD, UNIT, SEGMENT, PRD, YR

UNION

/* EARNED PLANNED METRIC  */
SELECT ''EARN'' AS MTRC, DB_T_SHRD_PROD.STATE AS ST_CD, 

CASE WHEN SUBSTR(PROD,1,1) = ''A'' THEN ''AUTO''

	 WHEN SUBSTR(PROD,1,1) IN (''H'') THEN ''PROPERTY''

ELSE ''COMMERCIAL/OTHER'' END AS LOB_GRP,

CASE WHEN SUBSTR(UNIT,1,3) IN (''ASI'',''AVI'') THEN ''TREXIS'' ELSE ''CORE'' END AS SEGMENT, UNIT, 

PRD, YR, SUM(TOTAL_AMT) AS PLND_AMT

FROM DB_T_STAG_FIN_PROD.STG_PLANNED_PREM STG

/* NO WHERE CLAUSE B/C EARN IS ALL THE ACCOUNTS */
GROUP BY MTRC, DB_T_SHRD_PROD.STATE, PROD, UNIT, SEGMENT, PRD, YR

UNION

/* NEW BUSINESS PLANNED METRIC */
SELECT  ''NB'' AS MTRC, DB_T_SHRD_PROD.STATE AS ST_CD, 

CASE WHEN SUBSTR(PROD,1,1) = ''A'' THEN ''AUTO''

	 WHEN SUBSTR(PROD,1,1) IN (''H'') THEN ''PROPERTY''

ELSE ''COMMERCIAL/OTHER'' END AS LOB_GRP,

CASE WHEN SUBSTR(UNIT,1,3) IN (''ASI'',''AVI'') THEN ''TREXIS'' ELSE ''CORE'' END AS SEGMENT, UNIT, 

PRD, YR, SUM(TOTAL_AMT) AS PLND_AMT

FROM DB_T_STAG_FIN_PROD.STG_PLANNED_PREM STG

WHERE ACCT IN (400100,400064,402300,400050,400054,400314) 

GROUP BY MTRC, DB_T_SHRD_PROD.STATE, PROD, UNIT, SEGMENT, PRD, YR

UNION

/* WRITTEN PLANNED METRIC */
SELECT ''WRTN'' AS MTRC, DB_T_SHRD_PROD.STATE AS ST_CD, 

CASE WHEN SUBSTR(PROD,1,1) = ''A'' THEN ''AUTO''

	 WHEN SUBSTR(PROD,1,1) IN (''H'') THEN ''PROPERTY''

ELSE ''COMMERCIAL/OTHER'' END AS LOB_GRP,

CASE WHEN SUBSTR(UNIT,1,3) IN (''ASI'',''AVI'') THEN ''TREXIS'' ELSE ''CORE'' END AS SEGMENT, UNIT, 

PRD, YR, SUM(TOTAL_AMT) AS PLND_AMT

FROM DB_T_STAG_FIN_PROD.STG_PLANNED_PREM STG

WHERE ACCT IN (400050,400053,400054,400055,400064,400074,400100,400150,400200,400314,402300,402302,402304,400250,400253,400254,400264,400274,400300,400303,400324,401250,401300,402310,402204,402205) 

/* WHERE ACCT IN (400050,400053,400054,400055,400064,400074,400100,400150,400200,400314,402300,402302,402304,400250,400253,400254,400264,400274,400300,400303,400324,401250,401300,402310)--,402204,402205) --TO TEST THE AMOUNTS MATCHING W/ OLD SB DATA LOAD */
GROUP BY MTRC, DB_T_SHRD_PROD.STATE, PROD, UNIT, SEGMENT, PRD, YR

)A

GROUP BY A.MTRC, A.ST_CD, A.LOB_GRP, A.SEGMENT, A.UNIT, A.PRD, A.YR

/* )B --TO TEST THE TOTALS TO THE OLD SB DATA LOAD */
) SRC
)
);


-- Component exp_src_tgt, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_src_tgt AS
(
SELECT
SQ_STG_PLANNED_PREM.MTRC as MTRC,
SQ_STG_PLANNED_PREM.STD_CD as STD_CD,
SQ_STG_PLANNED_PREM.LOB_GRP as LOB_GRP,
SQ_STG_PLANNED_PREM.SEGMENT as SEGMENT,
SQ_STG_PLANNED_PREM.UNIT as UNIT,
SQ_STG_PLANNED_PREM.PRD as PRD,
SQ_STG_PLANNED_PREM.YR as YR,
SQ_STG_PLANNED_PREM.PLND_AMT as PLND_AMT,
:PRCS_ID as o_PRCS_ID,
CURRENT_TIMESTAMP as o_EDW_STRT_DT,
SQ_STG_PLANNED_PREM.source_record_id
FROM
SQ_STG_PLANNED_PREM
);


-- Component PLANNED_PREM, Type TARGET 
INSERT INTO DB_T_CORE_FIN_PROD.PLANNED_PREM
(
MTRC,
ST_CD,
LOB_GRP,
SEGMENT,
UNIT,
PRD,
YR,
PLND_AMT,
PRCS_ID,
EDW_STRT_DTTM
)
SELECT
exp_src_tgt.MTRC as MTRC,
exp_src_tgt.STD_CD as ST_CD,
exp_src_tgt.LOB_GRP as LOB_GRP,
exp_src_tgt.SEGMENT as SEGMENT,
exp_src_tgt.UNIT as UNIT,
exp_src_tgt.PRD as PRD,
exp_src_tgt.YR as YR,
exp_src_tgt.PLND_AMT as PLND_AMT,
exp_src_tgt.o_PRCS_ID as PRCS_ID,
exp_src_tgt.o_EDW_STRT_DT as EDW_STRT_DTTM
FROM
exp_src_tgt;


END; ';