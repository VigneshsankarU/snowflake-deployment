-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_BASE_AGT_ACCTBLY_BI_FEED("RUN_ID" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS '
DECLARE
  v_start_time STRING;
BEGIN
  v_start_time := CURRENT_TIMESTAMP(); 

-- Component SQ_ACCTBLY_DTL_COMM_FEED, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_ACCTBLY_DTL_COMM_FEED AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as AGENT_NBR,
$2 as ACCOUNTING_DT,
$3 as ACCTBLY_TYPE_CD_D,
$4 as ACCTBLY_VAL_D,
$5 as ACCTBLY_TYPE_CD_E,
$6 as ACCTBLY_VAL_E,
$7 as ACCTBLY_TYPE_CD_G,
$8 as ACCTBLY_VAL_G,
$9 as REPORTING_DT,
$10 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT
ACCTBLY_DTL_COMM_FEED.AGENT_NBR,
ACCTBLY_DTL_COMM_FEED.ACCOUNTING_DT,
ACCTBLY_DTL_COMM_FEED.ACCTBLY_TYPE_CD_D,
ACCTBLY_DTL_COMM_FEED.ACCTBLY_VAL_D,
ACCTBLY_DTL_COMM_FEED.ACCTBLY_TYPE_CD_E,
ACCTBLY_DTL_COMM_FEED.ACCTBLY_VAL_E,
ACCTBLY_DTL_COMM_FEED.ACCTBLY_TYPE_CD_G,
ACCTBLY_DTL_COMM_FEED.ACCTBLY_VAL_G,
ACCTBLY_DTL_COMM_FEED.REPORTING_DT
FROM db_t_prod_comn.ACCTBLY_DTL_COMM_FEED
) SRC
)
);


-- Component EXPTRANS, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE EXPTRANS AS
(
SELECT
SQ_ACCTBLY_DTL_COMM_FEED.AGENT_NBR as AGENT_NBR,
SQ_ACCTBLY_DTL_COMM_FEED.ACCOUNTING_DT as ACCOUNTING_DT,
SQ_ACCTBLY_DTL_COMM_FEED.ACCTBLY_TYPE_CD_D as ACCTBLY_TYPE_CD_D,
SQ_ACCTBLY_DTL_COMM_FEED.ACCTBLY_VAL_D as ACCTBLY_VAL_D,
SQ_ACCTBLY_DTL_COMM_FEED.ACCTBLY_TYPE_CD_E as ACCTBLY_TYPE_CD_E,
SQ_ACCTBLY_DTL_COMM_FEED.ACCTBLY_VAL_E as ACCTBLY_VAL_E,
SQ_ACCTBLY_DTL_COMM_FEED.ACCTBLY_TYPE_CD_G as ACCTBLY_TYPE_CD_G,
SQ_ACCTBLY_DTL_COMM_FEED.ACCTBLY_VAL_G as ACCTBLY_VAL_G,
SQ_ACCTBLY_DTL_COMM_FEED.REPORTING_DT as REPORTING_DT,
SQ_ACCTBLY_DTL_COMM_FEED.source_record_id
FROM
SQ_ACCTBLY_DTL_COMM_FEED
);


-- Component AGT_ACCTBLY_BI_FEED, Type TARGET 
INSERT INTO AGT_ACCTBLY_BI_FEED
(
AGENT_NBR,
DATE_WRITTEN,
DATE_USED,
BI_TYPE_MEMBERSHIP,
BI_AMT_MEMBERSHIP,
BI_TYPE_PC_PERSIS,
BI_AMT_PC_PERSIS,
BI_TYPE_LOSS_RATIO,
BI_AMT_LOSS_RATIO
)
SELECT
EXPTRANS.AGENT_NBR as AGENT_NBR,
EXPTRANS.ACCOUNTING_DT as DATE_WRITTEN,
EXPTRANS.REPORTING_DT as DATE_USED,
EXPTRANS.ACCTBLY_TYPE_CD_D as BI_TYPE_MEMBERSHIP,
EXPTRANS.ACCTBLY_VAL_D as BI_AMT_MEMBERSHIP,
EXPTRANS.ACCTBLY_TYPE_CD_E as BI_TYPE_PC_PERSIS,
EXPTRANS.ACCTBLY_VAL_E as BI_AMT_PC_PERSIS,
EXPTRANS.ACCTBLY_TYPE_CD_G as BI_TYPE_LOSS_RATIO,
EXPTRANS.ACCTBLY_VAL_G as BI_AMT_LOSS_RATIO
FROM
EXPTRANS;

INSERT INTO control_status (run_id, task_name, task_status, var_json)
SELECT :run_id, ''m_base_agt_acctbly_bi_feed'', ''SUCCEEDED'', OBJECT_CONSTRUCT(
  ''StartTime'', :v_start_time,
  ''SrcSuccessRows'', (SELECT COUNT(*) FROM SQ_ACCTBLY_DTL_COMM_FEED),
  ''TgtSuccessRows'', (SELECT COUNT(*) FROM EXPTRANS)
);

EXCEPTION WHEN OTHER THEN
    INSERT INTO control_status (run_id, task_name, task_status, var_json)
    SELECT :run_id, ''m_base_agt_acctbly_bi_feed'', ''FAILED'', OBJECT_CONSTRUCT(
        ''StartTime'', :v_start_time,
        ''SrcSuccessRows'', 0,
        ''TgtSuccessRows'', 0,
        ''SQLERRM'', :sqlerrm
    );

END; ';