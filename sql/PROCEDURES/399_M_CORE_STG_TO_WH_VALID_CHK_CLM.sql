-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_CORE_STG_TO_WH_VALID_CHK_CLM("RUN_ID" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' BEGIN 

-- Component sq_ECTL_ERR_LOG, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE sq_ECTL_ERR_LOG AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as ECTL_BATCH_ID,
$2 as ECTL_PROJ_ID,
$3 as ECTL_PRGM_ID,
$4 as ECTL_SRC_TABLE_ID,
$5 as ECTL_SRC_KEY_VAL,
$6 as ERR_COL_NM,
$7 as ERR_COL_VAL,
$8 as ERR_DESC,
$9 as ERR_TS,
$10 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT 	D.ECTL_BATCH_ID, 

	1 AS ECTL_PROJECT_ID, 

	E.ECTL_PRGM_ID,

	F.ECTL_TABLE_ID, 

	CAST((''ACCOUNT_NBR - ''||A.ACCOUNT_NBR||'' ALF_REC_COUNTER - ''||CAST(A.ALF_REC_COUNTER AS VARCHAR(10))||'' TRANSACTION_ID - ''||A.TRANSACTION_ID) AS VARCHAR(100)) AS ECTL_SRC_KEY_VAL,

	CAST(''BUSINESS_UNIT'' AS VARCHAR(30)) AS ERR_COL_NM, 

	CAST(A.BUSINESS_UNIT AS VARCHAR(100)) AS ERR_COL_VAL, 

	CAST(''Invalid Business Unit Code'' AS VARCHAR(250)) AS ERR_DESC,

	CURRENT_TIMESTAMP AS ERR_TS 

FROM 

	DB_T_STAG_FIN_PROD.STG_FIN_CLM A 

INNER JOIN 

	DB_T_SHRD_FIN_PROD.REPOS_FIN_ACCT_NBR_LKUP B 

ON	B.REPOS_CD = ''CLM'' 

	AND TRIM(A.ACCOUNT_NBR) = TRIM(B.ACCT_NBR) 

LEFT OUTER JOIN 

	DB_T_SHRD_FIN_PROD.FIN_CMPY_CD_LKUP C

ON	SUBSTR(A.BUSINESS_UNIT,1,3) = C.CMPY_CD 

INNER JOIN 

	(SELECT ECTL_BATCH_ID FROM DB_T_CTRL_FIN_PROD.ECTL_BATCH_INFO WHERE ECTL_PROJ_ID = 1 AND ECTL_ACTIVE_IND = ''Y'') D ON 

1=1 INNER JOIN 

	(SELECT ECTL_PRGM_ID FROM DB_T_CTRL_FIN_PROD.ECTL_PRGM_INFO WHERE ECTL_PRGM_NM  = ''m_CLM_FIN_LOSS_TXN'') E  ON 

1=1 INNER JOIN 

	(SELECT ECTL_TABLE_ID FROM DB_T_CTRL_FIN_PROD.ECTL_TABLE_XREF WHERE ECTL_TABLE_NM = ''STG_FIN_CLM'') F ON 

1=1 

WHERE 

	C.CMPY_CD  IS NULL AND TRIM(A.GL_DISTRIB_STATUS)=''D''

	

	UNION

	

SELECT 	D.ECTL_BATCH_ID, 

	1 AS ECTL_PROJECT_ID, 

	E.ECTL_PRGM_ID,F.ECTL_TABLE_ID, 

	CAST((''ACCOUNT_NBR - ''||A.ACCOUNT_NBR||'' ALF_REC_COUNTER - ''||CAST(A.ALF_REC_COUNTER AS VARCHAR(10))||'' TRANSACTION_ID - ''||A.TRANSACTION_ID) AS VARCHAR(100)) AS ECTL_SRC_KEY_VAL,

	CAST(''CHARTFIELD1'' AS VARCHAR(30)) AS ERR_COL_NM, 

	CAST(A.CHARTFIELD1 AS VARCHAR(100)) AS ERR_COL_VAL, 

	CAST(''Invalid DB_T_SHRD_PROD.State Code'' AS VARCHAR(250)) AS ERR_DESC,

	CURRENT_TIMESTAMP AS ERR_TS 

FROM 

	DB_T_STAG_FIN_PROD.STG_FIN_CLM A 

INNER JOIN 

	DB_T_SHRD_FIN_PROD.REPOS_FIN_ACCT_NBR_LKUP B 

ON	B.REPOS_CD = ''CLM'' 

	AND TRIM(A.ACCOUNT_NBR) = TRIM(B.ACCT_NBR) 

LEFT OUTER JOIN 

	DB_T_SHRD_PROD.STATE_LOOKUP C

ON	A.CHARTFIELD1 = C.ST_CD 

INNER JOIN 

	(SELECT ECTL_BATCH_ID FROM DB_T_CTRL_FIN_PROD.ECTL_BATCH_INFO WHERE ECTL_PROJ_ID = 1 AND ECTL_ACTIVE_IND = ''Y'') D ON 

1=1 INNER JOIN 

	(SELECT ECTL_PRGM_ID FROM DB_T_CTRL_FIN_PROD.ECTL_PRGM_INFO WHERE ECTL_PRGM_NM  = ''m_CLM_FIN_LOSS_TXN'') E  ON 

1=1 INNER JOIN 

	(SELECT ECTL_TABLE_ID FROM DB_T_CTRL_FIN_PROD.ECTL_TABLE_XREF WHERE ECTL_TABLE_NM = ''STG_FIN_CLM'') F ON 

1=1 

WHERE 

	C.ST_CD  IS NULL AND TRIM(A.GL_DISTRIB_STATUS)=''D''

	

	UNION



SELECT 	D.ECTL_BATCH_ID, 

	1 AS ECTL_PROJECT_ID, 

	E.ECTL_PRGM_ID,F.ECTL_TABLE_ID, 

	CAST((''ACCOUNT_NBR - ''||A.ACCOUNT_NBR||'' ALF_REC_COUNTER - ''||CAST(A.ALF_REC_COUNTER AS VARCHAR(10))||'' TRANSACTION_ID - ''||A.TRANSACTION_ID) AS VARCHAR(100)) AS ECTL_SRC_KEY_VAL,

	CAST(''ALF_SERV_CTR_NBR'' AS VARCHAR(30)) AS ERR_COL_NM, 

	CAST(A.ALF_SERV_CTR_NBR AS VARCHAR(100))   AS ERR_COL_VAL, 

	CAST(''Invalid Service center name'' AS VARCHAR(250)) AS ERR_DESC,

	CURRENT_TIMESTAMP AS ERR_TS 

FROM 

	DB_T_STAG_FIN_PROD.STG_FIN_CLM A 

INNER JOIN 

	DB_T_SHRD_FIN_PROD.REPOS_FIN_ACCT_NBR_LKUP B 

ON	B.REPOS_CD = ''CLM'' 

	AND TRIM(A.ACCOUNT_NBR) = TRIM(B.ACCT_NBR) 

LEFT OUTER JOIN 

	DB_T_SHRD_PROD.SVC_NM_LKUP C

ON	CAST(CAST(A.ALF_SERV_CTR_NBR AS INTEGER) AS VARCHAR(10)) = C.SVC_NM_CD 

INNER JOIN 

	(SELECT ECTL_BATCH_ID FROM DB_T_CTRL_FIN_PROD.ECTL_BATCH_INFO WHERE ECTL_PROJ_ID = 1 AND ECTL_ACTIVE_IND = ''Y'') D ON 

1=1 INNER JOIN 

	(SELECT ECTL_PRGM_ID FROM DB_T_CTRL_FIN_PROD.ECTL_PRGM_INFO WHERE ECTL_PRGM_NM  = ''m_CLM_FIN_LOSS_TXN'') E  ON 

1=1 INNER JOIN 

	(SELECT ECTL_TABLE_ID FROM DB_T_CTRL_FIN_PROD.ECTL_TABLE_XREF WHERE ECTL_TABLE_NM = ''STG_FIN_CLM'') F ON 

1=1 

WHERE 

	C.SVC_NM_CD  IS NULL AND TRIM(A.GL_DISTRIB_STATUS)=''D''

	

	UNION

	

SELECT 	E.ECTL_BATCH_ID, 

	1 AS ECTL_PROJECT_ID, 

	F.ECTL_PRGM_ID,G.ECTL_TABLE_ID, 

	CAST((''ACCOUNT_NBR - ''||A.ACCOUNT_NBR||'' ALF_REC_COUNTER - ''||CAST(A.ALF_REC_COUNTER AS VARCHAR(10))||'' TRANSACTION_ID - ''||A.TRANSACTION_ID) AS VARCHAR(100)) AS ECTL_SRC_KEY_VAL,

	CAST(''ALF_AGENT_NBR'' AS VARCHAR(30)) AS ERR_COL_NM, 

	CAST(A.ALF_AGENT_NBR AS VARCHAR(100))  AS ERR_COL_VAL, 

	CAST(''Invalid Agent Number'' AS VARCHAR(250))  AS ERR_DESC,

	CURRENT_TIMESTAMP AS ERR_TS 

FROM 

	DB_T_STAG_FIN_PROD.STG_FIN_CLM A 

INNER JOIN 

	DB_T_SHRD_FIN_PROD.REPOS_FIN_ACCT_NBR_LKUP B 

ON	B.REPOS_CD = ''CLM'' 

	AND TRIM(A.ACCOUNT_NBR) = TRIM(B.ACCT_NBR) 

LEFT OUTER JOIN 

(

	SELECT 	DISTINCT CAST(AGENCY_NBR AS INTEGER) AGENCY_NBR,

		AGNT_CLIENT_ID

	FROM 

		DB_T_CORE_PROD.AGENT_HIER 

	WHERE 

		AGENCY_NBR NOT IN (''MS99999'',''GA99999'',''AL99999'')

) C 

ON	A.ALF_AGENT_NBR  = C.AGENCY_NBR 

LEFT OUTER JOIN 

	DB_T_SHRD_PROD.AGNT_NAME_LKUP D 

ON	C.AGNT_CLIENT_ID = D.AGNT_CLIENT_ID 

INNER JOIN 

	(SELECT ECTL_BATCH_ID FROM DB_T_CTRL_FIN_PROD.ECTL_BATCH_INFO WHERE ECTL_PROJ_ID = 1 AND ECTL_ACTIVE_IND = ''Y'') E ON 

1=1 INNER JOIN 

	(SELECT ECTL_PRGM_ID FROM DB_T_CTRL_FIN_PROD.ECTL_PRGM_INFO WHERE ECTL_PRGM_NM  = ''m_CLM_FIN_LOSS_TXN'') F  ON 

1=1 INNER JOIN 

	(SELECT ECTL_TABLE_ID FROM DB_T_CTRL_FIN_PROD.ECTL_TABLE_XREF WHERE ECTL_TABLE_NM = ''STG_FIN_CLM'') G ON 

1=1 

WHERE 

	(C.AGENCY_NBR   IS NULL OR D.AGNT_CLIENT_ID IS NULL) AND TRIM(A.GL_DISTRIB_STATUS)=''D''

	

	UNION

	

SELECT 	

	D.ECTL_BATCH_ID, 

	1 AS ECTL_PROJECT_ID, 

	E.ECTL_PRGM_ID,

	F.ECTL_TABLE_ID, 

	CAST((''ACCOUNT_NBR - ''||A.ACCOUNT_NBR||'' ALF_REC_COUNTER - ''||CAST(A.ALF_REC_COUNTER AS VARCHAR(10))||'' TRANSACTION_ID - ''||A.TRANSACTION_ID) AS VARCHAR(100)) AS ECTL_SRC_KEY_VAL,

	CAST(''ALF_COMPANY_CD'' AS VARCHAR(30)) AS ERR_COL_NM, 

	CAST(A.ALF_COMPANY_CD AS VARCHAR(100)) AS ERR_COL_VAL, 

	CAST(''Invalid company type Code'' AS VARCHAR(250)) AS ERR_DESC,

	CURRENT_TIMESTAMP AS ERR_TS 

FROM 

	DB_T_STAG_FIN_PROD.STG_FIN_CLM A 

INNER JOIN 

	DB_T_SHRD_FIN_PROD.REPOS_FIN_ACCT_NBR_LKUP B 

ON	B.REPOS_CD = ''CLM'' 

	AND TRIM(A.ACCOUNT_NBR) = TRIM(B.ACCT_NBR) 

LEFT OUTER JOIN 

	DB_T_SHRD_FIN_PROD.FIN_CMPY_CD_LKUP C

ON	A.ALF_COMPANY_CD  = C.CMPY_TYPE_CD 

INNER JOIN 

	(SELECT ECTL_BATCH_ID FROM DB_T_CTRL_FIN_PROD.ECTL_BATCH_INFO WHERE ECTL_PROJ_ID = 1 AND ECTL_ACTIVE_IND = ''Y'') D ON 

1=1 INNER JOIN 

	(SELECT ECTL_PRGM_ID FROM DB_T_CTRL_FIN_PROD.ECTL_PRGM_INFO WHERE ECTL_PRGM_NM  = ''m_CLM_FIN_LOSS_TXN'') E  ON 

1=1 INNER JOIN 

	(SELECT ECTL_TABLE_ID FROM DB_T_CTRL_FIN_PROD.ECTL_TABLE_XREF WHERE ECTL_TABLE_NM = ''STG_FIN_CLM'') F ON 

1=1 

WHERE 

	C.CMPY_TYPE_CD  IS NULL AND TRIM(A.GL_DISTRIB_STATUS)=''D''

	UNION

SELECT 	D.ECTL_BATCH_ID, 

	1 AS ECTL_PROJECT_ID, 

	E.ECTL_PRGM_ID,F.ECTL_TABLE_ID, 

	CAST((''ACCOUNT_NBR - ''||A.ACCOUNT_NBR||'' ALF_REC_COUNTER - ''||CAST(A.ALF_REC_COUNTER AS VARCHAR(10))||'' TRANSACTION_ID - ''||A.TRANSACTION_ID) AS VARCHAR(100)) AS ECTL_SRC_KEY_VAL,

	CAST(''ALF_POL_NUMBER'' AS VARCHAR(30)) AS ERR_COL_NM, 

	CAST(A.ALF_POL_NUMBER  AS VARCHAR(100)) AS ERR_COL_VAL, 

	CAST(''Invalid DB_T_CORE_DM_PROD.Policy Number'' AS VARCHAR(250))  AS ERR_DESC,

	CURRENT_TIMESTAMP AS ERR_TS 

FROM 

	DB_T_STAG_FIN_PROD.STG_FIN_CLM A 

INNER JOIN 

	DB_T_SHRD_FIN_PROD.REPOS_FIN_ACCT_NBR_LKUP B 

ON	B.REPOS_CD = ''CLM'' 

	AND TRIM(A.ACCOUNT_NBR) = TRIM(B.ACCT_NBR)  

INNER JOIN 

	(SELECT ECTL_BATCH_ID FROM DB_T_CTRL_FIN_PROD.ECTL_BATCH_INFO WHERE ECTL_PROJ_ID = 1 AND ECTL_ACTIVE_IND = ''Y'') D ON 

1=1 INNER JOIN 

	(SELECT ECTL_PRGM_ID FROM DB_T_CTRL_FIN_PROD.ECTL_PRGM_INFO WHERE ECTL_PRGM_NM  = ''m_CLM_FIN_LOSS_TXN'') E  ON 

1=1 INNER JOIN 

	(SELECT ECTL_TABLE_ID FROM DB_T_CTRL_FIN_PROD.ECTL_TABLE_XREF WHERE ECTL_TABLE_NM = ''STG_FIN_CLM'') F ON 

1=1 

WHERE 

	((TRIM(A.ALF_POL_PREFIX)='''' AND A.ALF_POL_NUMBER=0) OR A.ALF_POL_NUMBER IS NULL) AND TRIM(A.GL_DISTRIB_STATUS)=''D''

	

	UNION

SELECT 	D.ECTL_BATCH_ID, 

	1 AS ECTL_PROJECT_ID, 

	E.ECTL_PRGM_ID,

	F.ECTL_TABLE_ID, 

	CAST((''ACCOUNT_NBR - ''||A.ACCOUNT_NBR||'' ALF_REC_COUNTER - ''||CAST(A.ALF_REC_COUNTER AS VARCHAR(10))||'' TRANSACTION_ID - ''||A.TRANSACTION_ID) AS VARCHAR(100)) AS ECTL_SRC_KEY_VAL,

	CAST(''PRODUCT''  AS VARCHAR(30)) AS ERR_COL_NM, 

	CAST(A.PRODUCT  AS VARCHAR(100)) AS ERR_COL_VAL, 

	CAST(''Invalid Product Code'' AS VARCHAR(250)) AS ERR_DESC,

	CURRENT_TIMESTAMP AS ERR_TS 

FROM 

	DB_T_STAG_FIN_PROD.STG_FIN_CLM A 

INNER JOIN 

	DB_T_SHRD_FIN_PROD.REPOS_FIN_ACCT_NBR_LKUP B 

ON	B.REPOS_CD = ''CLM'' 

	AND TRIM(A.ACCOUNT_NBR) = TRIM(B.ACCT_NBR) 

LEFT OUTER JOIN 

	DB_T_CORE_FIN_PROD.FIN_PRODUCT_HIER C

ON	A.PRODUCT  = C.PRODUCT_CD 

INNER JOIN 

	(SELECT ECTL_BATCH_ID FROM DB_T_CTRL_FIN_PROD.ECTL_BATCH_INFO WHERE ECTL_PROJ_ID = 1 AND ECTL_ACTIVE_IND = ''Y'') D ON 

1=1 INNER JOIN 

	(SELECT ECTL_PRGM_ID FROM DB_T_CTRL_FIN_PROD.ECTL_PRGM_INFO WHERE ECTL_PRGM_NM  = ''m_CLM_FIN_LOSS_TXN'') E  ON 

1=1 INNER JOIN 

	(SELECT ECTL_TABLE_ID FROM DB_T_CTRL_FIN_PROD.ECTL_TABLE_XREF WHERE ECTL_TABLE_NM = ''STG_FIN_CLM'') F ON 

1=1 

WHERE 

	C.PRODUCT_CD  IS NULL AND TRIM(A.GL_DISTRIB_STATUS)=''D''

	UNION

SELECT 	D.ECTL_BATCH_ID, 

	1 AS ECTL_PROJECT_ID, 

	E.ECTL_PRGM_ID,

	F.ECTL_TABLE_ID, 

	CAST((''ACCOUNT_NBR - ''||A.ACCOUNT_NBR||'' ALF_REC_COUNTER - ''||CAST(A.ALF_REC_COUNTER AS VARCHAR(10))||'' TRANSACTION_ID - ''||A.TRANSACTION_ID) AS VARCHAR(100)) AS ECTL_SRC_KEY_VAL,

	CAST(''CHARTFIELD2'' AS VARCHAR(30)) AS ERR_COL_NM, 

	CAST(A.CHARTFIELD2 AS VARCHAR(100)) AS ERR_COL_VAL, 

	CAST(''Invalid Pool code'' AS VARCHAR(250)) AS ERR_DESC,

	CURRENT_TIMESTAMP AS ERR_TS 

FROM 

	DB_T_STAG_FIN_PROD.STG_FIN_CLM A 

INNER JOIN 

	DB_T_SHRD_FIN_PROD.REPOS_FIN_ACCT_NBR_LKUP B 

ON	B.REPOS_CD = ''CLM'' 

	AND TRIM(A.ACCOUNT_NBR) = TRIM(B.ACCT_NBR) 

LEFT OUTER JOIN 

	DB_T_SHRD_FIN_PROD.FIN_POOL_CD_LKUP C

ON	A.CHARTFIELD2 = C.POOL_CD 

INNER JOIN 

	(SELECT ECTL_BATCH_ID FROM DB_T_CTRL_FIN_PROD.ECTL_BATCH_INFO WHERE ECTL_PROJ_ID = 1 AND ECTL_ACTIVE_IND = ''Y'') D ON 

1=1 INNER JOIN 

	(SELECT ECTL_PRGM_ID FROM DB_T_CTRL_FIN_PROD.ECTL_PRGM_INFO WHERE ECTL_PRGM_NM  = ''m_CLM_FIN_LOSS_TXN'') E  ON 

1=1 INNER JOIN 

	(SELECT ECTL_TABLE_ID FROM DB_T_CTRL_FIN_PROD.ECTL_TABLE_XREF WHERE ECTL_TABLE_NM = ''STG_FIN_CLM'') F ON 

1=1 

WHERE 

	C.POOL_CD  IS NULL AND TRIM(A.GL_DISTRIB_STATUS)=''D''

	UNION

SELECT 	D.ECTL_BATCH_ID, 

	1 AS ECTL_PROJECT_ID, 

	E.ECTL_PRGM_ID,

	F.ECTL_TABLE_ID, 

	CAST((''ACCOUNT_NBR - ''||A.ACCOUNT_NBR||'' ALF_REC_COUNTER - ''||CAST(A.ALF_REC_COUNTER AS VARCHAR(10))||'' TRANSACTION_ID - ''||A.TRANSACTION_ID) AS VARCHAR(100)) AS ECTL_SRC_KEY_VAL,

	CAST(''CHARTFIELD3'' AS VARCHAR(30)) AS ERR_COL_NM, 

	CAST(A.CHARTFIELD3 AS VARCHAR(100)) AS ERR_COL_VAL, 

	CAST(''Invalid Reinsurance code'' AS VARCHAR(250)) AS ERR_DESC,

	CURRENT_TIMESTAMP AS ERR_TS 

FROM 

	DB_T_STAG_FIN_PROD.STG_FIN_CLM A 

INNER JOIN 

	DB_T_SHRD_FIN_PROD.REPOS_FIN_ACCT_NBR_LKUP B 

ON	B.REPOS_CD = ''CLM'' 

	AND TRIM(A.ACCOUNT_NBR) = TRIM(B.ACCT_NBR) 

LEFT OUTER JOIN 

	DB_T_SHRD_FIN_PROD.FIN_REINSUR_CD_LKUP C

ON	A.CHARTFIELD3 = C.REINSUR_CD 

INNER JOIN 

	(SELECT ECTL_BATCH_ID FROM DB_T_CTRL_FIN_PROD.ECTL_BATCH_INFO WHERE ECTL_PROJ_ID = 1 AND ECTL_ACTIVE_IND = ''Y'') D ON 

1=1 INNER JOIN 

	(SELECT ECTL_PRGM_ID FROM DB_T_CTRL_FIN_PROD.ECTL_PRGM_INFO WHERE ECTL_PRGM_NM  = ''m_CLM_FIN_LOSS_TXN'') E  ON 

1=1 INNER JOIN 

	(SELECT ECTL_TABLE_ID FROM DB_T_CTRL_FIN_PROD.ECTL_TABLE_XREF WHERE ECTL_TABLE_NM = ''STG_FIN_CLM'') F ON 

1=1 

WHERE 

	C.REINSUR_CD  IS NULL AND TRIM(A.GL_DISTRIB_STATUS)=''D''

	UNION

	

SELECT D.ECTL_BATCH_ID, 

	1 AS ECTL_PROJECT_ID, 

	E.ECTL_PRGM_ID,

	F.ECTL_TABLE_ID, 

	CAST((''ACCOUNT_NBR - ''||A.ACCOUNT_NBR||'' ALF_REC_COUNTER - ''||CAST(A.ALF_REC_COUNTER AS VARCHAR(10))||'' TRANSACTION_ID - ''||A.TRANSACTION_ID) AS VARCHAR(100)) AS ECTL_SRC_KEY_VAL,

	CAST(''DEPTID'' AS VARCHAR(30)) AS ERR_COL_NM, 

	CAST(A.DEPTID  AS VARCHAR(100))      AS ERR_COL_VAL, 

	CAST(''Invalid Department Id'' AS VARCHAR(250)) AS ERR_DESC,

	CURRENT_TIMESTAMP AS ERR_TS 

FROM 

	DB_T_STAG_FIN_PROD.STG_FIN_CLM A INNER JOIN DB_T_SHRD_FIN_PROD.REPOS_FIN_ACCT_NBR_LKUP B 

ON	B.REPOS_CD = ''CLM''

	AND TRIM(A.ACCOUNT_NBR) = TRIM(B.ACCT_NBR) LEFT OUTER JOIN DB_T_SHRD_FIN_PROD.FIN_DEPT_LKUP C

ON	A.DEPTID   = C.DEPT_ID 

INNER JOIN 

	(SELECT ECTL_BATCH_ID FROM DB_T_CTRL_FIN_PROD.ECTL_BATCH_INFO WHERE ECTL_PROJ_ID = 1 AND ECTL_ACTIVE_IND = ''Y'') D ON 

1=1 INNER JOIN 

	(SELECT ECTL_PRGM_ID FROM DB_T_CTRL_FIN_PROD.ECTL_PRGM_INFO WHERE ECTL_PRGM_NM  = ''m_CLM_FIN_LOSS_TXN'') E  ON 

1=1 INNER JOIN 

	(SELECT ECTL_TABLE_ID FROM DB_T_CTRL_FIN_PROD.ECTL_TABLE_XREF WHERE ECTL_TABLE_NM = ''STG_FIN_CLM'') F ON 

1=1 

WHERE 

	C.DEPT_ID  IS NULL AND TRIM(A.GL_DISTRIB_STATUS)=''D''

	UNION

	

SELECT D.ECTL_BATCH_ID, 

	1 AS ECTL_PROJECT_ID, 

	E.ECTL_PRGM_ID,

	F.ECTL_TABLE_ID, 

	CAST((''ACCOUNT_NBR - ''||A.ACCOUNT_NBR||'' ALF_REC_COUNTER - ''||CAST(A.ALF_REC_COUNTER AS VARCHAR(10))||'' TRANSACTION_ID - ''||A.TRANSACTION_ID) AS VARCHAR(100)) AS ECTL_SRC_KEY_VAL,

	CAST(''ACCOUNT_NBR'' AS VARCHAR(30)) AS ERR_COL_NM, 

	CAST(A.ACCOUNT_NBR AS VARCHAR(100)) AS ERR_COL_VAL, 

	CAST(''Invalid Account Number'' AS VARCHAR(250)) AS ERR_DESC,

	CURRENT_TIMESTAMP AS ERR_TS 

FROM 

	DB_T_STAG_FIN_PROD.STG_FIN_CLM A INNER JOIN DB_T_SHRD_FIN_PROD.REPOS_FIN_ACCT_NBR_LKUP B 

ON	B.REPOS_CD = ''CLM'' 

	AND TRIM(A.ACCOUNT_NBR) = TRIM(B.ACCT_NBR) LEFT OUTER JOIN DB_T_SHRD_FIN_PROD.FIN_ACCT_NBR_LKUP C

ON	A.ACCOUNT_NBR   = C.ACCT_NBR 

INNER JOIN 

	(SELECT ECTL_BATCH_ID FROM DB_T_CTRL_FIN_PROD.ECTL_BATCH_INFO WHERE ECTL_PROJ_ID = 1 AND ECTL_ACTIVE_IND = ''Y'') D ON 

1=1 INNER JOIN 

	(SELECT ECTL_PRGM_ID FROM DB_T_CTRL_FIN_PROD.ECTL_PRGM_INFO WHERE ECTL_PRGM_NM  = ''m_CLM_FIN_LOSS_TXN'') E  ON 

1=1 INNER JOIN 

	(SELECT ECTL_TABLE_ID FROM DB_T_CTRL_FIN_PROD.ECTL_TABLE_XREF WHERE ECTL_TABLE_NM = ''STG_FIN_CLM'') F ON 

1=1 

WHERE 

	C.ACCT_NBR IS NULL AND TRIM(A.GL_DISTRIB_STATUS)=''D''

	

	UNION

SELECT D.ECTL_BATCH_ID, 

	1 AS ECTL_PROJ_ID, 

	E.ECTL_PRGM_ID,

	F.ECTL_TABLE_ID, 

	CAST((''ACCOUNT_NBR - ''||A.ACCOUNT_NBR||'' ALF_REC_COUNTER - ''||CAST(A.ALF_REC_COUNTER AS VARCHAR(10))||'' TRANSACTION_ID - ''||A.TRANSACTION_ID)AS VARCHAR(100))  AS ECTL_SRC_KEY_VAL,

	CAST(''ALF_DATE_OF_LOSS'' AS VARCHAR(30))  AS ERR_COL_NM, 

	CAST(A.ALF_DATE_OF_LOSS AS VARCHAR(100)) AS ERR_COL_VAL, 

	CAST(''Invalid Alfa Date Of Loss'' AS VARCHAR(250))  AS ERR_DESC,

	CURRENT_TIMESTAMP AS ERR_TS 

FROM 

	DB_T_STAG_FIN_PROD.STG_FIN_CLM A INNER JOIN DB_T_SHRD_FIN_PROD.REPOS_FIN_ACCT_NBR_LKUP B 

ON	B.REPOS_CD = ''CLM'' 

	AND TRIM(A.ACCOUNT_NBR) = TRIM(B.ACCT_NBR) 

INNER JOIN 

	(SELECT ECTL_BATCH_ID FROM DB_T_CTRL_FIN_PROD.ECTL_BATCH_INFO WHERE ECTL_PROJ_ID = 1 AND ECTL_ACTIVE_IND = ''Y'') D ON 

1=1 INNER JOIN 

	(SELECT ECTL_PRGM_ID FROM DB_T_CTRL_FIN_PROD.ECTL_PRGM_INFO WHERE ECTL_PRGM_NM  = ''m_CLM_FIN_LOSS_TXN'') E  ON 

1=1 INNER JOIN 

	(SELECT ECTL_TABLE_ID FROM DB_T_CTRL_FIN_PROD.ECTL_TABLE_XREF WHERE ECTL_TABLE_NM = ''STG_FIN_CLM'') F ON 

1=1 

WHERE 

	A.ALF_DATE_OF_LOSS IS NULL AND TRIM(A.GL_DISTRIB_STATUS)=''D''

	UNION

SELECT D.ECTL_BATCH_ID, 

	1 AS ECTL_PROJECT_ID, 

	E.ECTL_PRGM_ID,

	F.ECTL_TABLE_ID, 

	CAST((''ACCOUNT_NBR - ''||A.ACCOUNT_NBR||'' ALF_REC_COUNTER - ''||CAST(A.ALF_REC_COUNTER AS VARCHAR(10))||'' TRANSACTION_ID - ''||A.TRANSACTION_ID)AS VARCHAR(100))  AS ECTL_SRC_KEY_VAL,

	CAST(''PRODUCT_CD'' AS VARCHAR(30)) AS ERR_COL_NM, 

	CAST(A.PRODUCT AS VARCHAR(100)) AS ERR_COL_VAL, 

	CAST(''Invalid LOB Code for this product'' AS VARCHAR(250)) AS ERR_DESC,

	CURRENT_TIMESTAMP AS ERR_TS 

FROM 

	DB_T_STAG_FIN_PROD.STG_FIN_CLM A INNER JOIN DB_T_SHRD_FIN_PROD.REPOS_FIN_ACCT_NBR_LKUP B 

ON	B.REPOS_CD = ''CLM'' 

	AND TRIM(A.ACCOUNT_NBR) = TRIM(B.ACCT_NBR) LEFT OUTER JOIN DB_T_CORE_FIN_PROD.FIN_PRODUCT_HIER C

ON	A.PRODUCT  = C.PRODUCT_CD 

INNER JOIN 

	(SELECT ECTL_BATCH_ID FROM DB_T_CTRL_FIN_PROD.ECTL_BATCH_INFO WHERE ECTL_PROJ_ID = 1 AND ECTL_ACTIVE_IND = ''Y'') D ON 

1=1 INNER JOIN 

	(SELECT ECTL_PRGM_ID FROM DB_T_CTRL_FIN_PROD.ECTL_PRGM_INFO WHERE ECTL_PRGM_NM  = ''m_CLM_FIN_LOSS_TXN'') E  ON 

1=1 INNER JOIN 

	(SELECT ECTL_TABLE_ID FROM DB_T_CTRL_FIN_PROD.ECTL_TABLE_XREF WHERE ECTL_TABLE_NM = ''STG_FIN_CLM'') F ON 

1=1 

WHERE 

	C.PRODUCT_CD  IS NULL AND TRIM(A.GL_DISTRIB_STATUS)=''D'' AND NOT(TRIM(A.PRODUCT) IS NULL OR TRIM(A.PRODUCT)='''')
) SRC
)
);


-- Component exp_Pass_Through, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_Pass_Through AS
(
SELECT
sq_ECTL_ERR_LOG.ECTL_BATCH_ID as ECTL_BATCH_ID,
sq_ECTL_ERR_LOG.ECTL_PROJ_ID as ECTL_PROJ_ID,
sq_ECTL_ERR_LOG.ECTL_PRGM_ID as ECTL_PRGM_ID,
sq_ECTL_ERR_LOG.ECTL_SRC_TABLE_ID as ECTL_SRC_TABLE_ID,
sq_ECTL_ERR_LOG.ECTL_SRC_KEY_VAL as ECTL_SRC_KEY_VAL,
sq_ECTL_ERR_LOG.ERR_COL_NM as ERR_COL_NM,
sq_ECTL_ERR_LOG.ERR_COL_VAL as ERR_COL_VAL,
sq_ECTL_ERR_LOG.ERR_DESC as ERR_DESC,
sq_ECTL_ERR_LOG.ERR_TS as ERR_TS,
sq_ECTL_ERR_LOG.source_record_id
FROM
sq_ECTL_ERR_LOG
);


-- Component Shortcut_to_ECTL_ERR_LOG, Type TARGET 
INSERT INTO DB_T_CTRL_FIN_PROD.ECTL_ERR_LOG
(
ECTL_BATCH_ID,
ECTL_PROJ_ID,
ECTL_PRGM_ID,
ECTL_SRC_TABLE_ID,
ECTL_SRC_KEY_VAL,
ERR_COL_NM,
ERR_COL_VAL,
ERR_DESC,
ERR_TS
)
SELECT
exp_Pass_Through.ECTL_BATCH_ID as ECTL_BATCH_ID,
exp_Pass_Through.ECTL_PROJ_ID as ECTL_PROJ_ID,
exp_Pass_Through.ECTL_PRGM_ID as ECTL_PRGM_ID,
exp_Pass_Through.ECTL_SRC_TABLE_ID as ECTL_SRC_TABLE_ID,
exp_Pass_Through.ECTL_SRC_KEY_VAL as ECTL_SRC_KEY_VAL,
exp_Pass_Through.ERR_COL_NM as ERR_COL_NM,
exp_Pass_Through.ERR_COL_VAL as ERR_COL_VAL,
exp_Pass_Through.ERR_DESC as ERR_DESC,
exp_Pass_Through.ERR_TS as ERR_TS
FROM
exp_Pass_Through;


END; ';