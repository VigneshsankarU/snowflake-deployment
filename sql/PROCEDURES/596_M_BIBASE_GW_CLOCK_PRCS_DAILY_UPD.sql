-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_BIBASE_GW_CLOCK_PRCS_DAILY_UPD("WORKLET_NAME" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' DECLARE
  run_id STRING;
  workflow_name STRING;
  session_name STRING;
BEGIN
  run_id := public.func_get_scoped_param(:run_id, ''run_id'', :workflow_name, :worklet_name, :session_name);
  workflow_name := public.func_get_scoped_param(:run_id, ''workflow_name'', :workflow_name, :worklet_name, :session_name);
  session_name := public.func_get_scoped_param(:run_id, ''session_name'', :workflow_name, :worklet_name, :session_name);
 

-- Component SQ_ETL_PRCS_CTRL, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_ETL_PRCS_CTRL AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as PRCS_ID,
$2 as SUB_PRCS_NM,
$3 as SRC_EXTRACT_DT,
$4 as GW_CLOCK,
$5 as PRCS_STAG,
$6 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT 

A.PRCS_ID

,A.SUB_PRCS_NM

,A.SRC_EXTRACT_DT

,B.JOB_END_DT

,A.PRCS_STAG 

FROM db_t_prod_core.ETL_PRCS_CTRL A,

(

SELECT MAX(JOB_END_DT_NEW) JOB_END_DT 
FROM (  --2

SELECT JOB_START_DT,  JOB_END_DT,( (CAST((CAST(JOB_END_DT AS DATE)- CAST(JOB_START_DT AS DATE)) AS DECIMAL(18,6)) * 60*24)

  + ((EXTRACT(  HOUR, JOB_END_DT) - EXTRACT(  HOUR,JOB_START_DT))* 60)

  + ((EXTRACT(MINUTE,JOB_END_DT) - EXTRACT(MINUTE,JOB_START_DT))  )

  + ((EXTRACT(SECOND ,JOB_END_DT) - EXTRACT(SECOND , JOB_START_DT))/60))/60

AS DIFFERENCE_IN_HOURS ,

CASE

WHEN (DIFFERENCE_IN_HOURS>24 AND CAST(JOB_END_DT AS DATE)-CAST(JOB_START_DT AS DATE)>2) THEN (CAST(JOB_END_DT AS DATE)-2)

 WHEN (DIFFERENCE_IN_HOURS>24 AND CAST(JOB_END_DT AS DATE)-CAST(JOB_START_DT AS DATE)=2) THEN (CAST(JOB_END_DT AS DATE)-1)

 WHEN (DIFFERENCE_IN_HOURS>30 AND CAST(JOB_END_DT AS DATE)-CAST(JOB_START_DT AS DATE)=1) THEN (CAST(JOB_END_DT AS DATE)-1)

 WHEN (DIFFERENCE_IN_HOURS>24 AND CAST(JOB_END_DT AS DATE)-CAST(JOB_START_DT AS DATE)=1 and  EXTRACT(HOUR FROM JOB_END_DT) <=6) THEN (CAST(JOB_END_DT AS DATE)-1)

 WHEN (DIFFERENCE_IN_HOURS<24 AND CAST(JOB_END_DT AS DATE)-CAST(JOB_START_DT AS DATE)>1 ) THEN (CAST(JOB_END_DT AS DATE)-1)

 WHEN (DIFFERENCE_IN_HOURS<24 AND CAST(JOB_END_DT AS DATE)-CAST(JOB_START_DT AS DATE)<=1 ) and   EXTRACT(HOUR FROM JOB_END_DT) <=6 THEN (CAST(JOB_END_DT AS DATE)) -1

 WHEN (DIFFERENCE_IN_HOURS=24 AND CAST(JOB_END_DT AS DATE)-CAST(JOB_START_DT AS DATE)<=1 ) and   EXTRACT(HOUR FROM JOB_END_DT) <=6 THEN (CAST(JOB_END_DT AS DATE))  else (CAST(JOB_END_DT AS DATE)) 

  END JOB_END_DT_NEW,
  PRCS_STAG, PRCS_STS

  FROM

--TCORE.ETL_PRCS_CTRL 
db_t_prod_core.ETL_PRCS_CTRL

  WHERE 

  PRCS_STAG = ''EDW_DLY''

  AND PRCS_STS = ''SUCCEEDED''

  AND PRCS_NM =''WF_BIBASE_W_COMPOSITE_DAILY''

  AND SUB_PRCS_NM IN
  --1
   (SELECT SUB_PRCS_NM 
  FROM db_t_prod_core.ETL_PRCS_CTRL 
  WHERE PRCS_STAG = ''COMPSIT'' AND PRCS_STS = ''SUCCEEDED'')  --1

) a  --2

WHERE 

 PRCS_STAG = ''EDW_DLY''

 AND PRCS_STS = ''SUCCEEDED''  --)b

) B

WHERE 

A.PRCS_NM =''WF_BIBASE_W_COMPOSITE_DAILY'' AND A.PRCS_STS=''SUCCEEDED'' AND A.PRCS_STAG=''COMPSIT''



QUALIFY RANK() OVER (PARTITION BY A.SUB_PRCS_NM ORDER BY A.JOB_END_DT DESC) =1
) SRC
)
);


-- Component EXPTRANS, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE EXPTRANS AS
(
SELECT
SQ_ETL_PRCS_CTRL.PRCS_ID as PRCS_ID,
SQ_ETL_PRCS_CTRL.SUB_PRCS_NM as SUB_PRCS_NM,
SQ_ETL_PRCS_CTRL.GW_CLOCK as GW_CLOCK_CALC,
GW_CLOCK_CALC as SRC_EXTRACT_DT_OUT,
SQ_ETL_PRCS_CTRL.PRCS_STAG as PRCS_STAG,
SQ_ETL_PRCS_CTRL.source_record_id
FROM
SQ_ETL_PRCS_CTRL
);


-- Component upd_prcs_cntrl, Type UPDATE 
CREATE OR REPLACE TEMPORARY TABLE upd_prcs_cntrl AS
(
/* UPDATE_STRATEGY_ACTION = 0 FOR INSERT / UPDATE_STRATEGY_ACTION = 1 FOR UPDATE / UPDATE_STRATEGY_ACTION = 2 FOR DELETE / UPDATE_STRATEGY_ACTION = 3 FOR REJECT */
SELECT
EXPTRANS.PRCS_ID as PRCS_ID,
EXPTRANS.SUB_PRCS_NM as SUB_PRCS_NM,
EXPTRANS.SRC_EXTRACT_DT_OUT as SRC_EXTRACT_DT_OUT,
EXPTRANS.PRCS_STAG as PRCS_STAG,
--dd_update
  1 as UPDATE_STRATEGY_ACTION
FROM
EXPTRANS
);


-- Component ETL_PRCS_CTRL1, Type TARGET 
/* Perform Updates */
MERGE INTO db_t_prod_core.ETL_PRCS_CTRL 
USING upd_prcs_cntrl ON (UPDATE_STRATEGY_ACTION = 1 AND ETL_PRCS_CTRL.PRCS_ID = upd_prcs_cntrl.PRCS_ID AND ETL_PRCS_CTRL.PRCS_STAG = upd_prcs_cntrl.PRCS_STAG)
WHEN MATCHED THEN UPDATE
SET
SRC_EXTRACT_DT = upd_prcs_cntrl.SRC_EXTRACT_DT_OUT
;
  
END;
';