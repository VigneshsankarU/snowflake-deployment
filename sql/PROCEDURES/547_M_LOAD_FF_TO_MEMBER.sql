-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_LOAD_FF_TO_MEMBER("RUN_ID" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' BEGIN 

-- Component MEMBER_STAG, Type TRUNCATE_TABLE 
--TRUNCATE TABLE MEMBER_STAG;


-- Component SQ_MEMBER_SRC, Type TABLE_DDL Creating an empty table
CREATE OR REPLACE TEMPORARY TABLE SQ_MEMBER
(
MEMBER_NBR decimal,
NAME1 varchar(25),
NAME2 varchar(25),
ADDRESS1 varchar(25),
ADDRESS2 varchar(25),
CITY varchar(40),
STATE varchar(2),
ZIP varchar(10),
MEMBER_TYPE varchar(1),
COUNTY_CODE decimal,
STATUS varchar(1),
DUES_AMT decimal,
PAY_SOURCE varchar(1),
PAID_TO_DATE varchar(10),
POSTED_DATE1 varchar(10),
POSTED_DATE2 varchar(10),
POSTED_DATE3 varchar(10),
ALPHA_CODE varchar(5),
PARSED_NAME1_FIRSTNAME varchar(25),
PARSED_NAME1_LASTNAME varchar(25),
PARSED_NAME2_FIRSTNAME varchar(25),
PARSED_NAME2_LASTNAME varchar(25),
GW_BILL_REF varchar(11),
GW_DUE_DATE varchar(29),
COMB_BILL_IND varchar(1),
ALLOW_COMBINED_BILLING varchar(1),
FOUR_DAY_LTR_IND varchar(1),
COMM_CD1 varchar(1),
COMM_CD2 varchar(1),
COMM_CD3 varchar(1),
COMM_CD4 varchar(1),
COMM_CD5 varchar(1),
AGENT decimal,
SERVICE_CENTER decimal,
OUT_OF_STATE varchar(1),
COUNTY_CHG_IND varchar(1),
DATE_ISSUED varchar(29),
DATE_BILLED varchar(29),
FONTEVA_SALES_ORDER varchar(9),
DATE_PAID varchar(29),
DATE_CANCELLED varchar(29),
COUNTY_PAID_DT varchar(29),
LAST_UPDATE_TS varchar(29),
STD_COUNTY_CD decimal,
MAILABILITY varchar(1),
EXTENDED_ZIP varchar(15),
STD_COUNTY_NAME varchar(25),
COUNTY_NAME varchar(25),
USER_ID varchar(25),
MAGAZINE_IND varchar(1),
LOAD_DTTM varchar(29),
FONTEVA_STATUS varchar(9),
FONTEVA_ID varchar(18),
FONTEVA_INVOICED varchar(1),
TREX_BUS_WRT_AGT varchar(6),
AGT_CSR_EMAIL varchar(30),
TRANSACTION_TS varchar(29),
source_record_id number autoincrement start 1 increment 1
);


-- Component SQ_MEMBER_SRC, Type IMPORT_DATA Importing Data
;


-- Component exp_conversion, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_conversion AS
(
SELECT
SQ_MEMBER.MEMBER_NBR as MEMBER_NBR,
SQ_MEMBER.NAME1 as NAME1,
SQ_MEMBER.NAME2 as NAME2,
SQ_MEMBER.ADDRESS1 as ADDRESS1,
SQ_MEMBER.ADDRESS2 as ADDRESS2,
SQ_MEMBER.CITY as CITY,
SQ_MEMBER.STATE as STATE,
SQ_MEMBER.ZIP as ZIP,
SQ_MEMBER.MEMBER_TYPE as MEMBER_TYPE,
SQ_MEMBER.COUNTY_CODE as COUNTY_CODE,
SQ_MEMBER.STATUS as STATUS,
SQ_MEMBER.DUES_AMT as DUES_AMT,
SQ_MEMBER.PAY_SOURCE as PAY_SOURCE,
SQ_MEMBER.PAID_TO_DATE as PAID_TO_DATE,
SQ_MEMBER.POSTED_DATE1 as POSTED_DATE1,
SQ_MEMBER.POSTED_DATE2 as POSTED_DATE2,
SQ_MEMBER.POSTED_DATE3 as POSTED_DATE3,
SQ_MEMBER.ALPHA_CODE as ALPHA_CODE,
SQ_MEMBER.PARSED_NAME1_FIRSTNAME as PARSED_NAME1_FIRSTNAME,
SQ_MEMBER.PARSED_NAME1_LASTNAME as PARSED_NAME1_LASTNAME,
SQ_MEMBER.PARSED_NAME2_FIRSTNAME as PARSED_NAME2_FIRSTNAME,
SQ_MEMBER.PARSED_NAME2_LASTNAME as PARSED_NAME2_LASTNAME,
SQ_MEMBER.GW_BILL_REF as GW_BILL_REF,
TO_DATE ( substr ( SQ_MEMBER.GW_DUE_DATE , 1 , 10 ) , ''YYYY-MM-DD'' ) as GW_DUE_DATE,
SQ_MEMBER.COMB_BILL_IND as COMB_BILL_IND,
SQ_MEMBER.ALLOW_COMBINED_BILLING as ALLOW_COMBINED_BILLING,
SQ_MEMBER.FOUR_DAY_LTR_IND as FOUR_DAY_LTR_IND,
SQ_MEMBER.COMM_CD1 as COMM_CD1,
SQ_MEMBER.COMM_CD2 as COMM_CD2,
SQ_MEMBER.COMM_CD3 as COMM_CD3,
SQ_MEMBER.COMM_CD4 as COMM_CD4,
SQ_MEMBER.COMM_CD5 as COMM_CD5,
SQ_MEMBER.AGENT as AGENT,
SQ_MEMBER.SERVICE_CENTER as SERVICE_CENTER,
SQ_MEMBER.OUT_OF_STATE as OUT_OF_STATE,
SQ_MEMBER.COUNTY_CHG_IND as COUNTY_CHG_IND,
TO_DATE ( substr ( SQ_MEMBER.DATE_ISSUED , 1 , 10 ) , ''YYYY-MM-DD'' ) as DATE_ISSUED,
TO_DATE ( substr ( SQ_MEMBER.DATE_BILLED , 1 , 10 ) , ''YYYY-MM-DD'' ) as DATE_BILLED,
SQ_MEMBER.FONTEVA_SALES_ORDER as FONTEVA_SALES_ORDER,
TO_DATE ( substr ( SQ_MEMBER.DATE_PAID , 1 , 10 ) , ''YYYY-MM-DD'' ) as DATE_PAID,
TO_DATE ( substr ( SQ_MEMBER.DATE_CANCELLED , 1 , 10 ) , ''YYYY-MM-DD'' ) as DATE_CANCELLED,
TO_DATE ( substr ( SQ_MEMBER.COUNTY_PAID_DT , 1 , 10 ) , ''YYYY-MM-DD'' ) as COUNTY_PAID_DT,
TO_DATE ( SQ_MEMBER.LAST_UPDATE_TS , ''MM/DD/YYYY HH24:MI:SS.FF6'' ) as LAST_UPDATE_TS,
SQ_MEMBER.STD_COUNTY_CD as STD_COUNTY_CD,
SQ_MEMBER.MAILABILITY as MAILABILITY,
SQ_MEMBER.EXTENDED_ZIP as EXTENDED_ZIP,
SQ_MEMBER.STD_COUNTY_NAME as STD_COUNTY_NAME,
SQ_MEMBER.COUNTY_NAME as COUNTY_NAME,
SQ_MEMBER.USER_ID as USER_ID,
SQ_MEMBER.MAGAZINE_IND as MAGAZINE_IND,
to_date ( SQ_MEMBER.LOAD_DTTM , ''MM/DD/YYYY HH24:MI:SS.FF6'' ) as LOAD_DTTM,
SQ_MEMBER.FONTEVA_STATUS as FONTEVA_STATUS,
SQ_MEMBER.FONTEVA_ID as FONTEVA_ID,
SQ_MEMBER.FONTEVA_INVOICED as FONTEVA_INVOICED,
SQ_MEMBER.TREX_BUS_WRT_AGT as TREX_BUS_WRT_AGT,
SQ_MEMBER.AGT_CSR_EMAIL as AGT_CSR_EMAIL,
to_date ( SQ_MEMBER.TRANSACTION_TS , ''mm/dD/YYYY HH24:MI:SS.FF6'' ) as TRANSACTION_TS1,
SQ_MEMBER.source_record_id
FROM
SQ_MEMBER
);


-- Component MEMBER_STAG, Type TARGET 
INSERT INTO DB_T_STAG_MEMBXREF_PROD.MEMBER
(
MEMBER_NBR,
NAME1,
NAME2,
ADDRESS1,
ADDRESS2,
CITY,
STATE,
ZIP,
MEMBER_TYPE,
COUNTY_CODE,
STATUS,
DUES_AMT,
PAY_SOURCE,
PAID_TO_DATE,
POSTED_DATE1,
POSTED_DATE2,
POSTED_DATE3,
ALPHA_CODE,
PARSED_NAME1_FIRSTNAME,
PARSED_NAME1_LASTNAME,
PARSED_NAME2_FIRSTNAME,
PARSED_NAME2_LASTNAME,
GW_BILL_REF,
GW_DUE_DATE,
COMB_BILL_IND,
ALLOW_COMBINED_BILLING,
FOUR_DAY_LTR_IND,
COMM_CD1,
COMM_CD2,
COMM_CD3,
COMM_CD4,
COMM_CD5,
AGENT,
SERVICE_CENTER,
OUT_OF_STATE,
COUNTY_CHG_IND,
DATE_ISSUED,
DATE_BILLED,
FONTEVA_SALES_ORDER,
DATE_PAID,
DATE_CANCELLED,
COUNTY_PAID_DT,
LAST_UPDATE_TS,
STD_COUNTY_CD,
MAILABILITY,
EXTENDED_ZIP,
STD_COUNTY_NAME,
COUNTY_NAME,
USER_ID,
MAGAZINE_IND,
LOAD_DTTM,
FONTEVA_STATUS,
FONTEVA_ID,
FONTEVA_INVOICED,
TREX_BUS_WRT_AGT,
AGT_CSR_EMAIL,
TRANSACTION_TS
)
SELECT
exp_conversion.MEMBER_NBR as MEMBER_NBR,
exp_conversion.NAME1 as NAME1,
exp_conversion.NAME2 as NAME2,
exp_conversion.ADDRESS1 as ADDRESS1,
exp_conversion.ADDRESS2 as ADDRESS2,
exp_conversion.CITY as CITY,
exp_conversion.STATE as STATE,
exp_conversion.ZIP as ZIP,
exp_conversion.MEMBER_TYPE as MEMBER_TYPE,
exp_conversion.COUNTY_CODE as COUNTY_CODE,
exp_conversion.STATUS as STATUS,
exp_conversion.DUES_AMT as DUES_AMT,
exp_conversion.PAY_SOURCE as PAY_SOURCE,
exp_conversion.PAID_TO_DATE as PAID_TO_DATE,
exp_conversion.POSTED_DATE1 as POSTED_DATE1,
exp_conversion.POSTED_DATE2 as POSTED_DATE2,
exp_conversion.POSTED_DATE3 as POSTED_DATE3,
exp_conversion.ALPHA_CODE as ALPHA_CODE,
exp_conversion.PARSED_NAME1_FIRSTNAME as PARSED_NAME1_FIRSTNAME,
exp_conversion.PARSED_NAME1_LASTNAME as PARSED_NAME1_LASTNAME,
exp_conversion.PARSED_NAME2_FIRSTNAME as PARSED_NAME2_FIRSTNAME,
exp_conversion.PARSED_NAME2_LASTNAME as PARSED_NAME2_LASTNAME,
exp_conversion.GW_BILL_REF as GW_BILL_REF,
exp_conversion.GW_DUE_DATE as GW_DUE_DATE,
exp_conversion.COMB_BILL_IND as COMB_BILL_IND,
exp_conversion.ALLOW_COMBINED_BILLING as ALLOW_COMBINED_BILLING,
exp_conversion.FOUR_DAY_LTR_IND as FOUR_DAY_LTR_IND,
exp_conversion.COMM_CD1 as COMM_CD1,
exp_conversion.COMM_CD2 as COMM_CD2,
exp_conversion.COMM_CD3 as COMM_CD3,
exp_conversion.COMM_CD4 as COMM_CD4,
exp_conversion.COMM_CD5 as COMM_CD5,
exp_conversion.AGENT as AGENT,
exp_conversion.SERVICE_CENTER as SERVICE_CENTER,
exp_conversion.OUT_OF_STATE as OUT_OF_STATE,
exp_conversion.COUNTY_CHG_IND as COUNTY_CHG_IND,
exp_conversion.DATE_ISSUED as DATE_ISSUED,
exp_conversion.DATE_BILLED as DATE_BILLED,
exp_conversion.FONTEVA_SALES_ORDER as FONTEVA_SALES_ORDER,
exp_conversion.DATE_PAID as DATE_PAID,
exp_conversion.DATE_CANCELLED as DATE_CANCELLED,
exp_conversion.COUNTY_PAID_DT as COUNTY_PAID_DT,
exp_conversion.LAST_UPDATE_TS as LAST_UPDATE_TS,
exp_conversion.STD_COUNTY_CD as STD_COUNTY_CD,
exp_conversion.MAILABILITY as MAILABILITY,
exp_conversion.EXTENDED_ZIP as EXTENDED_ZIP,
exp_conversion.STD_COUNTY_NAME as STD_COUNTY_NAME,
exp_conversion.COUNTY_NAME as COUNTY_NAME,
exp_conversion.USER_ID as USER_ID,
exp_conversion.MAGAZINE_IND as MAGAZINE_IND,
exp_conversion.LOAD_DTTM as LOAD_DTTM,
exp_conversion.FONTEVA_STATUS as FONTEVA_STATUS,
exp_conversion.FONTEVA_ID as FONTEVA_ID,
exp_conversion.FONTEVA_INVOICED as FONTEVA_INVOICED,
exp_conversion.TREX_BUS_WRT_AGT as TREX_BUS_WRT_AGT,
exp_conversion.AGT_CSR_EMAIL as AGT_CSR_EMAIL,
exp_conversion.TRANSACTION_TS1 as TRANSACTION_TS
FROM
exp_conversion;


-- Component MEMBER_STAG, Type Post SQL 
INSERT INTO DB_T_STAG_MEMBXREF_PROD.MEMBER_ARCHIVE
SELECT * FROM DB_T_STAG_MEMBXREF_PROD.MEMBER;


END; ';