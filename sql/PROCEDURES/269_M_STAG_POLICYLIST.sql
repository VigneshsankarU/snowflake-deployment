-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_STAG_POLICYLIST("RUN_ID" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' DECLARE FEED_IND varchar;
FEED_DT date;
BEGIN 

FEED_IND:=(select DAILY_FEED_IND from DB_T_CTRL_PROD.ECTL_JOB_LOAD_STATUS_LOG where ECTL_BATCH_ID= :run_id); 
FEED_DT:=(select current_date); 

-- Component POLICYLIST1, Type TRUNCATE_TABLE 
TRUNCATE TABLE DB_T_STAG_MEMBXREF_PROD.POLICYLIST;


-- PIPELINE START FOR 1

-- Component SQ_POLICYLIST2, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_POLICYLIST2 AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as PL_POL_NUM,
$2 as PL_FLT_ITEM,
$3 as PL_MEMBER_NUM,
$4 as PL_ALPHA_CODE,
$5 as PL_NAME_1,
$6 as PL_NAME_2,
$7 as PL_ADDRESS_1,
$8 as PL_ADDRESS_2,
$9 as PL_CITY,
$10 as PL_STATE,
$11 as PL_ZIP,
$12 as PL_SSN,
$13 as PL_INSURED_SSN,
$14 as PL_2ND_INSURED_SSN,
$15 as PL_AGT_NUM,
$16 as PL_SC_NUM,
$17 as PL_STATUS,
$18 as PL_DESC,
$19 as PL_TYPE,
$20 as PL_EXP_DATE,
$21 as PL_ALPHA_CODE_2,
$22 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT
POLICYLIST.PL_POL_NUM,
POLICYLIST.PL_FLT_ITEM,
POLICYLIST.PL_MEMBER_NUM,
POLICYLIST.PL_ALPHA_CODE,
POLICYLIST.PL_NAME_1,
POLICYLIST.PL_NAME_2,
POLICYLIST.PL_ADDRESS_1,
POLICYLIST.PL_ADDRESS_2,
POLICYLIST.PL_CITY,
POLICYLIST.PL_STATE,
POLICYLIST.PL_ZIP,
POLICYLIST.PL_SSN,
POLICYLIST.PL_INSURED_SSN,
POLICYLIST.PL_2ND_INSURED_SSN,
POLICYLIST.PL_AGT_NUM,
POLICYLIST.PL_SC_NUM,
POLICYLIST.PL_STATUS,
POLICYLIST.PL_DESC,
POLICYLIST.PL_TYPE,
POLICYLIST.PL_EXP_DATE,
POLICYLIST.PL_ALPHA_CODE_2
FROM DB_T_STAG_MEMBXREF_PROD.POLICYLIST
) SRC
)
);


-- Component exp_pass_through, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_pass_through AS
(
SELECT
SQ_POLICYLIST2.PL_POL_NUM as PL_POL_NUM,
SQ_POLICYLIST2.PL_FLT_ITEM as PL_FLT_ITEM,
SQ_POLICYLIST2.PL_MEMBER_NUM as PL_MEMBER_NUM,
SQ_POLICYLIST2.PL_ALPHA_CODE as PL_ALPHA_CODE,
SQ_POLICYLIST2.PL_NAME_1 as PL_NAME_1,
SQ_POLICYLIST2.PL_NAME_2 as PL_NAME_2,
SQ_POLICYLIST2.PL_ADDRESS_1 as PL_ADDRESS_1,
SQ_POLICYLIST2.PL_ADDRESS_2 as PL_ADDRESS_2,
SQ_POLICYLIST2.PL_CITY as PL_CITY,
SQ_POLICYLIST2.PL_STATE as PL_STATE,
SQ_POLICYLIST2.PL_ZIP as PL_ZIP,
SQ_POLICYLIST2.PL_SSN as PL_SSN,
SQ_POLICYLIST2.PL_INSURED_SSN as PL_INSURED_SSN,
SQ_POLICYLIST2.PL_2ND_INSURED_SSN as PL_2ND_INSURED_SSN,
SQ_POLICYLIST2.PL_AGT_NUM as PL_AGT_NUM,
SQ_POLICYLIST2.PL_SC_NUM as PL_SC_NUM,
SQ_POLICYLIST2.PL_STATUS as PL_STATUS,
SQ_POLICYLIST2.PL_DESC as PL_DESC,
SQ_POLICYLIST2.PL_TYPE as PL_TYPE,
SQ_POLICYLIST2.PL_EXP_DATE as PL_EXP_DATE,
SQ_POLICYLIST2.PL_ALPHA_CODE_2 as PL_ALPHA_CODE_2,
SQ_POLICYLIST2.source_record_id
FROM
SQ_POLICYLIST2
);


-- Component POLICYLIST1, Type TARGET 
INSERT INTO DB_T_STAG_MEMBXREF_PROD.POLICYLIST
(
PL_POL_NUM,
PL_FLT_ITEM,
PL_MEMBER_NUM,
PL_ALPHA_CODE,
PL_NAME_1,
PL_NAME_2,
PL_ADDRESS_1,
PL_ADDRESS_2,
PL_CITY,
PL_STATE,
PL_ZIP,
PL_SSN,
PL_INSURED_SSN,
PL_2ND_INSURED_SSN,
PL_AGT_NUM,
PL_SC_NUM,
PL_STATUS,
PL_DESC,
PL_TYPE,
PL_EXP_DATE,
PL_ALPHA_CODE_2
)
SELECT
exp_pass_through.PL_POL_NUM as PL_POL_NUM,
exp_pass_through.PL_FLT_ITEM as PL_FLT_ITEM,
exp_pass_through.PL_MEMBER_NUM as PL_MEMBER_NUM,
exp_pass_through.PL_ALPHA_CODE as PL_ALPHA_CODE,
exp_pass_through.PL_NAME_1 as PL_NAME_1,
exp_pass_through.PL_NAME_2 as PL_NAME_2,
exp_pass_through.PL_ADDRESS_1 as PL_ADDRESS_1,
exp_pass_through.PL_ADDRESS_2 as PL_ADDRESS_2,
exp_pass_through.PL_CITY as PL_CITY,
exp_pass_through.PL_STATE as PL_STATE,
exp_pass_through.PL_ZIP as PL_ZIP,
exp_pass_through.PL_SSN as PL_SSN,
exp_pass_through.PL_INSURED_SSN as PL_INSURED_SSN,
exp_pass_through.PL_2ND_INSURED_SSN as PL_2ND_INSURED_SSN,
exp_pass_through.PL_AGT_NUM as PL_AGT_NUM,
exp_pass_through.PL_SC_NUM as PL_SC_NUM,
exp_pass_through.PL_STATUS as PL_STATUS,
exp_pass_through.PL_DESC as PL_DESC,
exp_pass_through.PL_TYPE as PL_TYPE,
exp_pass_through.PL_EXP_DATE as PL_EXP_DATE,
exp_pass_through.PL_ALPHA_CODE_2 as PL_ALPHA_CODE_2
FROM
exp_pass_through;


-- PIPELINE END FOR 1

-- PIPELINE START FOR 2

-- Component SQ_POLICYLIST3, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_POLICYLIST3 AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as record_ct,
$2 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT count(*) as record_count
FROM DB_T_STAG_MEMBXREF_PROD.POLICYLIST
) SRC
)
);


-- Component exp_rec_cnt1, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_rec_cnt1 AS
(
SELECT
SQ_POLICYLIST3.record_ct as record_count,
:feed_ind as feed_ind,
:feed_dt as feed_dt,
SQ_POLICYLIST3.source_record_id
FROM
SQ_POLICYLIST3
);


-- Component TRG_MEMBXREF, Type TARGET_EXPORT_PREPARE Stage data before exporting
CREATE OR REPLACE TEMPORARY TABLE TRG_MEMBXREF AS
(
SELECT
exp_rec_cnt1.feed_ind as feed_ind,
exp_rec_cnt1.feed_dt as feed_dt,
exp_rec_cnt1.record_count as record_cnt
FROM
exp_rec_cnt1
);


-- Component TRG_MEMBXREF, Type EXPORT_DATA Exporting data
;


-- PIPELINE END FOR 2

END; ';