-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_STAG_ACCTBLY_TGT("PARAM_JSON" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' 
DECLARE
  prcs_id STRING;
BEGIN
  SELECT 
    TRY_PARSE_JSON(:param_json):prcs_id::STRING
  INTO
    prcs_id;

-- Component SQ_ACCTBLY_TGT, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_ACCTBLY_TGT AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as DISTRICT,
$2 as REGION,
$3 as STATE_NBR,
$4 as AGENT_NBR,
$5 as EFFECTIVE_DATE,
$6 as EXPIRE_DATE,
$7 as POINT_1_HEADING,
$8 as POINT_1_TARGET,
$9 as POINT_2_HEADING,
$10 as POINT_2_TARGET,
$11 as POINT_3_HEADING,
$12 as POINT_3_TARGET,
$13 as POINT_4_HEADING,
$14 as POINT_4_TARGET,
$15 as POINT_5_HEADING,
$16 as POINT_5_TARGET,
$17 as POINT_6_HEADING,
$18 as POINT_6_TARGET,
$19 as POINT_7_HEADING,
$20 as POINT_7_TARGET,
$21 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT
ACCTBLY_TGT.DISTRICT,
ACCTBLY_TGT.REGION,
ACCTBLY_TGT.STATE_NBR,
ACCTBLY_TGT.AGENT_NBR,
ACCTBLY_TGT.EFFECTIVE_DATE,
ACCTBLY_TGT.EXPIRE_DATE,
ACCTBLY_TGT.POINT_1_HEADING,
ACCTBLY_TGT.POINT_1_TARGET,
ACCTBLY_TGT.POINT_2_HEADING,
ACCTBLY_TGT.POINT_2_TARGET,
ACCTBLY_TGT.POINT_3_HEADING,
ACCTBLY_TGT.POINT_3_TARGET,
ACCTBLY_TGT.POINT_4_HEADING,
ACCTBLY_TGT.POINT_4_TARGET,
ACCTBLY_TGT.POINT_5_HEADING,
ACCTBLY_TGT.POINT_5_TARGET,
ACCTBLY_TGT.POINT_6_HEADING,
ACCTBLY_TGT.POINT_6_TARGET,
ACCTBLY_TGT.POINT_7_HEADING,
ACCTBLY_TGT.POINT_7_TARGET
FROM DB_T_PROD_STAG.ACCTBLY_TGT
) SRC
)
);


-- Component EXPTRANS, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE EXPTRANS AS
(
SELECT
SQ_ACCTBLY_TGT.DISTRICT as DISTRICT,
SQ_ACCTBLY_TGT.REGION as REGION,
SQ_ACCTBLY_TGT.STATE_NBR as STATE_NBR,
SQ_ACCTBLY_TGT.AGENT_NBR as AGENT_NBR,
SQ_ACCTBLY_TGT.EFFECTIVE_DATE as EFFECTIVE_DATE,
SQ_ACCTBLY_TGT.EXPIRE_DATE as EXPIRE_DATE,
SQ_ACCTBLY_TGT.POINT_1_HEADING as POINT_1_HEADING,
SQ_ACCTBLY_TGT.POINT_1_TARGET as POINT_1_TARGET,
SQ_ACCTBLY_TGT.POINT_2_HEADING as POINT_2_HEADING,
SQ_ACCTBLY_TGT.POINT_2_TARGET as POINT_2_TARGET,
SQ_ACCTBLY_TGT.POINT_3_HEADING as POINT_3_HEADING,
SQ_ACCTBLY_TGT.POINT_3_TARGET as POINT_3_TARGET,
SQ_ACCTBLY_TGT.POINT_4_HEADING as POINT_4_HEADING,
SQ_ACCTBLY_TGT.POINT_4_TARGET as POINT_4_TARGET,
SQ_ACCTBLY_TGT.POINT_5_HEADING as POINT_5_HEADING,
SQ_ACCTBLY_TGT.POINT_5_TARGET as POINT_5_TARGET,
SQ_ACCTBLY_TGT.POINT_6_HEADING as POINT_6_HEADING,
SQ_ACCTBLY_TGT.POINT_6_TARGET as POINT_6_TARGET,
SQ_ACCTBLY_TGT.POINT_7_HEADING as POINT_7_HEADING,
SQ_ACCTBLY_TGT.POINT_7_TARGET as POINT_7_TARGET,
:prcs_id as prcs_id,
SQ_ACCTBLY_TGT.source_record_id
FROM
SQ_ACCTBLY_TGT
);


-- Component ACCTBLY_TGT_1, Type TARGET 
INSERT INTO DB_T_PROD_STAG.ACCTBLY_TGT
(
DISTRICT,
REGION,
STATE_NBR,
AGENT_NBR,
EFFECTIVE_DATE,
EXPIRE_DATE,
POINT_1_HEADING,
POINT_1_TARGET,
POINT_2_HEADING,
POINT_2_TARGET,
POINT_3_HEADING,
POINT_3_TARGET,
POINT_4_HEADING,
POINT_4_TARGET,
POINT_5_HEADING,
POINT_5_TARGET,
POINT_6_HEADING,
POINT_6_TARGET,
POINT_7_HEADING,
POINT_7_TARGET,
PRCS_ID
)
SELECT
EXPTRANS.DISTRICT as DISTRICT,
EXPTRANS.REGION as REGION,
EXPTRANS.STATE_NBR as STATE_NBR,
EXPTRANS.AGENT_NBR as AGENT_NBR,
EXPTRANS.EFFECTIVE_DATE as EFFECTIVE_DATE,
EXPTRANS.EXPIRE_DATE as EXPIRE_DATE,
EXPTRANS.POINT_1_HEADING as POINT_1_HEADING,
EXPTRANS.POINT_1_TARGET as POINT_1_TARGET,
EXPTRANS.POINT_2_HEADING as POINT_2_HEADING,
EXPTRANS.POINT_2_TARGET as POINT_2_TARGET,
EXPTRANS.POINT_3_HEADING as POINT_3_HEADING,
EXPTRANS.POINT_3_TARGET as POINT_3_TARGET,
EXPTRANS.POINT_4_HEADING as POINT_4_HEADING,
EXPTRANS.POINT_4_TARGET as POINT_4_TARGET,
EXPTRANS.POINT_5_HEADING as POINT_5_HEADING,
EXPTRANS.POINT_5_TARGET as POINT_5_TARGET,
EXPTRANS.POINT_6_HEADING as POINT_6_HEADING,
EXPTRANS.POINT_6_TARGET as POINT_6_TARGET,
EXPTRANS.POINT_7_HEADING as POINT_7_HEADING,
EXPTRANS.POINT_7_TARGET as POINT_7_TARGET,
EXPTRANS.prcs_id as PRCS_ID
FROM
EXPTRANS;


END; ';