-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_DW_AD_USERS("RUN_ID" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' DECLARE PMMAPPINGNAME varchar;
ACT_PROJ_ID varchar;
BATCH_ACTIVE_IND varchar;
PMSHORTCUT_TO_AD_USERSTABLENAME varchar;
BEGIN 

-- PIPELINE START FOR 1

-- Component SQ_Shortcut_to_AD_USERS, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_Shortcut_to_AD_USERS AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as USER_NAME,
$2 as AGENT_NUMBER,
$3 as SERVICE_CENTER_NBR,
$4 as FIRST_NAME,
$5 as LAST_NAME,
$6 as AD_TITLE,
$7 as USER_TYPE,
$8 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT DISTINCT TRIM(AD_USERS.USER_NAME), AD_USERS.AGENT_NUMBER, TRIM(AD_USERS.SERVICE_CENTER_NUMBER), TRIM(AD_USERS.FIRST_NAME), TRIM(AD_USERS.LAST_NAME), 
TRIM(AD_USERS.AD_TITLE), TRIM(AD_USERS.USER_TYPE) 
FROM DB_T_STAG_MEMBXREF_PROD.AD_USERS
) SRC
)
);


-- Component exp_CHG_EFF_DT, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_CHG_EFF_DT AS
(
SELECT
SQ_Shortcut_to_AD_USERS.USER_NAME as USER_NAME,
SQ_Shortcut_to_AD_USERS.AGENT_NUMBER as AGENT_NUMBER,
SQ_Shortcut_to_AD_USERS.FIRST_NAME as FIRST_NAME,
SQ_Shortcut_to_AD_USERS.LAST_NAME as LAST_NAME,
SQ_Shortcut_to_AD_USERS.AD_TITLE as AD_TITLE,
CURRENT_TIMESTAMP as out_AD_CHG_EFF_DT,
SQ_Shortcut_to_AD_USERS.USER_TYPE as USER_TYPE,
SQ_Shortcut_to_AD_USERS.SERVICE_CENTER_NBR as SERVICE_CENTER_NBR,
SQ_Shortcut_to_AD_USERS.source_record_id
FROM
SQ_Shortcut_to_AD_USERS
);


-- Component LKP_DW_AD_USERS, Type LOOKUP 
CREATE OR REPLACE TEMPORARY TABLE LKP_DW_AD_USERS AS
(
SELECT
LKP.USER_ID,
LKP.USER_TYPE,
LKP.AGENT_NBR,
LKP.SERVICE_CENTER_NBR,
LKP.FIRST_NAME,
LKP.LAST_NAME,
LKP.AD_TITLE,
LKP.AD_CHG_EFF_DT,
exp_CHG_EFF_DT.source_record_id,
ROW_NUMBER() OVER(PARTITION BY exp_CHG_EFF_DT.source_record_id ORDER BY LKP.USER_ID asc,LKP.USER_TYPE asc,LKP.AGENT_NBR asc,LKP.SERVICE_CENTER_NBR asc,LKP.FIRST_NAME asc,LKP.LAST_NAME asc,LKP.AD_TITLE asc,LKP.AD_CHG_EFF_DT asc) RNK
FROM
exp_CHG_EFF_DT
LEFT JOIN (
SELECT 
DW_AD_USERS.USER_ID as USER_ID,DW_AD_USERS.USER_TYPE as USER_TYPE,
DW_AD_USERS.AGENT_NBR as AGENT_NBR, 
DW_AD_USERS.SERVICE_CENTER_NBR as SERVICE_CENTER_NBR,
DW_AD_USERS.FIRST_NAME as FIRST_NAME, 
DW_AD_USERS.LAST_NAME as LAST_NAME,
DW_AD_USERS.AD_TITLE as AD_TITLE,
DW_AD_USERS.AD_CHG_EFF_DT as AD_CHG_EFF_DT  
FROM DB_T_CORE_PROD.DW_AD_USERS
WHERE DW_AD_USERS.ECTL_TX_CD=''NEW''
) LKP ON LKP.USER_ID = exp_CHG_EFF_DT.USER_NAME
QUALIFY RNK = 1
);


-- Component exp_DERIVE_FLAG, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_DERIVE_FLAG AS
(
SELECT
exp_CHG_EFF_DT.USER_NAME as USER_NAME,
exp_CHG_EFF_DT.AGENT_NUMBER as AGENT_NUMBER,
exp_CHG_EFF_DT.SERVICE_CENTER_NBR as SERVICE_CENTER_NBR,
exp_CHG_EFF_DT.FIRST_NAME as FIRST_NAME,
exp_CHG_EFF_DT.LAST_NAME as LAST_NAME,
exp_CHG_EFF_DT.AD_TITLE as AD_TITLE,
exp_CHG_EFF_DT.out_AD_CHG_EFF_DT as AD_CHG_EFF_DT,
exp_CHG_EFF_DT.USER_TYPE as in_USER_TYPE,
LKP_DW_AD_USERS.USER_ID as USER_ID_lkp,
CASE WHEN LKP_DW_AD_USERS.USER_ID IS NULL THEN ''INS'' ELSE CASE WHEN CASE WHEN exp_CHG_EFF_DT.AGENT_NUMBER IS NULL THEN - 999 ELSE exp_CHG_EFF_DT.AGENT_NUMBER END <> CASE WHEN LKP_DW_AD_USERS.AGENT_NBR IS NULL THEN - 999 ELSE LKP_DW_AD_USERS.AGENT_NBR END OR CASE WHEN exp_CHG_EFF_DT.FIRST_NAME IS NULL THEN ''~'' ELSE exp_CHG_EFF_DT.FIRST_NAME END <> CASE WHEN LKP_DW_AD_USERS.FIRST_NAME IS NULL THEN ''~'' ELSE LKP_DW_AD_USERS.FIRST_NAME END OR CASE WHEN exp_CHG_EFF_DT.USER_TYPE IS NULL THEN ''~'' ELSE exp_CHG_EFF_DT.USER_TYPE END <> CASE WHEN LKP_DW_AD_USERS.USER_TYPE IS NULL THEN ''~'' ELSE LKP_DW_AD_USERS.USER_TYPE END OR CASE WHEN exp_CHG_EFF_DT.LAST_NAME IS NULL THEN ''~'' ELSE exp_CHG_EFF_DT.LAST_NAME END <> CASE WHEN LKP_DW_AD_USERS.LAST_NAME IS NULL THEN ''~'' ELSE LKP_DW_AD_USERS.LAST_NAME END OR CASE WHEN exp_CHG_EFF_DT.AD_TITLE IS NULL THEN ''~'' ELSE exp_CHG_EFF_DT.AD_TITLE END <> CASE WHEN LKP_DW_AD_USERS.AD_TITLE IS NULL THEN ''~'' ELSE LKP_DW_AD_USERS.AD_TITLE END OR CASE WHEN exp_CHG_EFF_DT.SERVICE_CENTER_NBR IS NULL THEN ''~'' ELSE exp_CHG_EFF_DT.SERVICE_CENTER_NBR END <> CASE WHEN LKP_DW_AD_USERS.SERVICE_CENTER_NBR IS NULL THEN ''~'' ELSE LKP_DW_AD_USERS.SERVICE_CENTER_NBR END THEN ''UPD'' ELSE ''REJ'' END END as out_CHK,
:PMMappingName as out_PRGM_NM,
:ACT_PROJ_ID as out_ACT_PROJ_ID,
:BATCH_ACTIVE_IND as out_BATCH_ACTIVE_IND,
:PMShortcut_to_AD_USERSTableName as out_TABLE_NM,
:ACT_PROJ_ID as IN_ACT_PROJ_ID,
:BATCH_ACTIVE_IND as IN_BATCH_ACTIVE_IND,
''m_STG_FIN_CLM'' IN_PRGM_NM,
null IN_TABLE_NM,
LKP_DW_AD_USERS.AD_CHG_EFF_DT as AD_CHG_EFF_DT_lkp,
exp_CHG_EFF_DT.source_record_id
FROM
exp_CHG_EFF_DT
INNER JOIN LKP_DW_AD_USERS ON exp_CHG_EFF_DT.source_record_id = LKP_DW_AD_USERS.source_record_id
);


-- Component mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE, Type MAPPLET 
--MAPPLET NOT REGISTERED: mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE, mapplet instance mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE;
call mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE(''exp_DERIVE_FLAG'');

-- Component exp_ECTL_FIELDS, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_ECTL_FIELDS AS
(
SELECT
exp_DERIVE_FLAG.USER_NAME as USER_NAME,
exp_DERIVE_FLAG.in_USER_TYPE as USER_TYPE,
exp_DERIVE_FLAG.AGENT_NUMBER as AGENT_NUMBER,
exp_DERIVE_FLAG.SERVICE_CENTER_NBR as SERVICE_CENTER_NBR,
exp_DERIVE_FLAG.FIRST_NAME as FIRST_NAME,
exp_DERIVE_FLAG.LAST_NAME as LAST_NAME,
exp_DERIVE_FLAG.AD_TITLE as AD_TITLE,
exp_DERIVE_FLAG.AD_CHG_EFF_DT as AD_CHG_EFF_DT,
exp_DERIVE_FLAG.out_CHK as out_CHK,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_PRGM_ID as out_ECTL_PRGM_ID,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_SRC_ID as out_ECTL_SRC_ID,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_SRC_INST_ID as out_ECTL_SRC_INST_ID,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_BATCH_ID as out_ECTL_BATCH_ID,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ORIG_INS_TS as out_ORIG_INS_TS,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_BATCH_START_DATE as out_ECTL_BATCH_START_DATE,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_TABLE_ID as out_ECTL_TABLE_ID,
exp_DERIVE_FLAG.USER_ID_lkp as USER_ID_lkp,
exp_DERIVE_FLAG.AD_CHG_EFF_DT_lkp as AD_CHG_EFF_DT_lkp,
exp_DERIVE_FLAG.source_record_id
FROM
exp_DERIVE_FLAG
INNER JOIN mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE ON exp_DERIVE_FLAG.source_record_id = mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.source_record_id
);


-- Component rtr_INS_UPD_INSERT, Type ROUTER Output Group INSERT
create or replace temp table rtr_INS_UPD_INSERT as
SELECT
exp_ECTL_FIELDS.USER_NAME as USER_NAME,
exp_ECTL_FIELDS.USER_TYPE as USER_TYPE,
exp_ECTL_FIELDS.AGENT_NUMBER as AGENT_NUMBER,
exp_ECTL_FIELDS.SERVICE_CENTER_NBR as SERVICE_CENTER_NBR,
exp_ECTL_FIELDS.FIRST_NAME as FIRST_NAME,
exp_ECTL_FIELDS.LAST_NAME as LAST_NAME,
exp_ECTL_FIELDS.AD_TITLE as AD_TITLE,
exp_ECTL_FIELDS.AD_CHG_EFF_DT as AD_CHG_EFF_DT,
exp_ECTL_FIELDS.out_CHK as out_CHK,
exp_ECTL_FIELDS.out_ECTL_PRGM_ID as out_ECTL_PRGM_ID,
exp_ECTL_FIELDS.out_ECTL_SRC_ID as out_ECTL_SRC_ID,
exp_ECTL_FIELDS.out_ECTL_SRC_INST_ID as out_ECTL_SRC_INST_ID,
exp_ECTL_FIELDS.out_ECTL_BATCH_ID as out_ECTL_BATCH_ID,
exp_ECTL_FIELDS.out_ORIG_INS_TS as out_ORIG_INS_TS,
exp_ECTL_FIELDS.out_ECTL_BATCH_START_DATE as out_ECTL_BATCH_START_DATE,
exp_ECTL_FIELDS.out_ECTL_TABLE_ID as out_ECTL_TABLE_ID,
exp_ECTL_FIELDS.USER_ID_lkp as USER_ID_lkp,
exp_ECTL_FIELDS.AD_CHG_EFF_DT_lkp as AD_CHG_EFF_DT_lkp,
exp_ECTL_FIELDS.source_record_id
FROM
exp_ECTL_FIELDS
WHERE exp_ECTL_FIELDS.out_CHK = ''INS'' OR exp_ECTL_FIELDS.out_CHK = ''UPD'';


-- Component rtr_INS_UPD_UPDATE, Type ROUTER Output Group UPDATE
create or replace temp table RTR_INS_UPD_UPDATE as
SELECT
exp_ECTL_FIELDS.USER_NAME as USER_NAME,
exp_ECTL_FIELDS.USER_TYPE as USER_TYPE,
exp_ECTL_FIELDS.AGENT_NUMBER as AGENT_NUMBER,
exp_ECTL_FIELDS.SERVICE_CENTER_NBR as SERVICE_CENTER_NBR,
exp_ECTL_FIELDS.FIRST_NAME as FIRST_NAME,
exp_ECTL_FIELDS.LAST_NAME as LAST_NAME,
exp_ECTL_FIELDS.AD_TITLE as AD_TITLE,
exp_ECTL_FIELDS.AD_CHG_EFF_DT as AD_CHG_EFF_DT,
exp_ECTL_FIELDS.out_CHK as out_CHK,
exp_ECTL_FIELDS.out_ECTL_PRGM_ID as out_ECTL_PRGM_ID,
exp_ECTL_FIELDS.out_ECTL_SRC_ID as out_ECTL_SRC_ID,
exp_ECTL_FIELDS.out_ECTL_SRC_INST_ID as out_ECTL_SRC_INST_ID,
exp_ECTL_FIELDS.out_ECTL_BATCH_ID as out_ECTL_BATCH_ID,
exp_ECTL_FIELDS.out_ORIG_INS_TS as out_ORIG_INS_TS,
exp_ECTL_FIELDS.out_ECTL_BATCH_START_DATE as out_ECTL_BATCH_START_DATE,
exp_ECTL_FIELDS.out_ECTL_TABLE_ID as out_ECTL_TABLE_ID,
exp_ECTL_FIELDS.USER_ID_lkp as USER_ID_lkp,
exp_ECTL_FIELDS.AD_CHG_EFF_DT_lkp as AD_CHG_EFF_DT_lkp,
exp_ECTL_FIELDS.source_record_id
FROM
exp_ECTL_FIELDS
WHERE exp_ECTL_FIELDS.out_CHK = ''UPD'';


-- Component exp_AD_CHG_EXP_DT, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_AD_CHG_EXP_DT AS
(
SELECT
rtr_INS_UPD_UPDATE.USER_ID_lkp as USER_ID3,
rtr_INS_UPD_UPDATE.out_ECTL_BATCH_ID as out_ECTL_BATCH_ID3,
rtr_INS_UPD_UPDATE.out_ORIG_INS_TS as out_ORIG_INS_TS3,
rtr_INS_UPD_UPDATE.AD_CHG_EFF_DT_lkp as AD_CHG_EFF_DT_lkp3,
CURRENT_TIMESTAMP as out_ECTL_END_DATE,
''UPD'' as out_ECTL_TX_CD,
 to_date(rtr_INS_UPD_UPDATE.AD_CHG_EFF_DT)  - 1  as out_AD_CHG_EXP_DT,
rtr_INS_UPD_UPDATE.source_record_id
FROM
rtr_INS_UPD_UPDATE
);


-- Component exp_AD_CHG_EFF_DT, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_AD_CHG_EFF_DT AS
(
SELECT
rtr_INS_UPD_INSERT.USER_NAME as USER_NAME,
rtr_INS_UPD_INSERT.USER_TYPE as USER_TYPE,
rtr_INS_UPD_INSERT.AGENT_NUMBER as AGENT_NUMBER,
rtr_INS_UPD_INSERT.SERVICE_CENTER_NBR as SERVICE_CENTER_NBR,
rtr_INS_UPD_INSERT.FIRST_NAME as FIRST_NAME,
rtr_INS_UPD_INSERT.LAST_NAME as LAST_NAME,
rtr_INS_UPD_INSERT.AD_TITLE as AD_TITLE,
rtr_INS_UPD_INSERT.AD_CHG_EFF_DT as AD_CHG_EFF_DT,
rtr_INS_UPD_INSERT.out_ECTL_PRGM_ID as out_ECTL_PRGM_ID,
rtr_INS_UPD_INSERT.out_ECTL_SRC_ID as out_ECTL_SRC_ID,
rtr_INS_UPD_INSERT.out_ECTL_SRC_INST_ID as out_ECTL_SRC_INST_ID,
rtr_INS_UPD_INSERT.out_ECTL_BATCH_ID as out_ECTL_BATCH_ID,
rtr_INS_UPD_INSERT.out_ORIG_INS_TS as out_ORIG_INS_TS,
rtr_INS_UPD_INSERT.out_ECTL_BATCH_START_DATE as out_ECTL_BATCH_START_DATE,
''NEW'' as out_ECTL_TX_CD,
TO_DATE ( ''9999/12/31'' , ''YYYY/MM/DD'' ) as out_ECTL_END_DATE,
TO_DATE ( ''9999/12/31'' , ''YYYY/MM/DD'' ) as var_AD_CHG_EXP_DT,
var_AD_CHG_EXP_DT as out_AD_CHG_EXP_DT,
rtr_INS_UPD_INSERT.source_record_id
FROM
rtr_INS_UPD_INSERT
);


-- Component upd_DW_AD_USERS, Type UPDATE 
CREATE OR REPLACE TEMPORARY TABLE upd_DW_AD_USERS AS
(
/* UPDATE_STRATEGY_ACTION = 0 FOR INSERT / UPDATE_STRATEGY_ACTION = 1 FOR UPDATE / UPDATE_STRATEGY_ACTION = 2 FOR DELETE / UPDATE_STRATEGY_ACTION = 3 FOR REJECT */
SELECT
exp_AD_CHG_EXP_DT.USER_ID3 as USER_ID3,
exp_AD_CHG_EXP_DT.AD_CHG_EFF_DT_lkp3 as AD_CHG_EFF_DT3,
exp_AD_CHG_EXP_DT.out_AD_CHG_EXP_DT as out_AD_CHG_EXP_DT,
exp_AD_CHG_EXP_DT.out_ECTL_BATCH_ID3 as out_ECTL_BATCH_ID3,
exp_AD_CHG_EXP_DT.out_ORIG_INS_TS3 as out_ORIG_INS_TS3,
exp_AD_CHG_EXP_DT.out_ECTL_END_DATE as out_ECTL_END_DATE,
exp_AD_CHG_EXP_DT.out_ECTL_TX_CD as out_ECTL_TX_CD,
1 as UPDATE_STRATEGY_ACTION
FROM
exp_AD_CHG_EXP_DT
);


-- Component DW_AD_USERS_INS, Type TARGET 
INSERT INTO DB_T_CORE_PROD.DW_AD_USERS
(
USER_ID,
USER_TYPE,
AGENT_NBR,
SERVICE_CENTER_NBR,
FIRST_NAME,
LAST_NAME,
AD_TITLE,
AD_CHG_EFF_DT,
AD_CHG_EXP_DT,
ECTL_BATCH_ID,
ECTL_ORIG_INS_TS,
ECTL_MODIFY_TS,
ECTL_SRC_ID,
ECTL_SRC_INST_ID,
ECTL_PRGM_ID,
ECTL_TX_CD,
ECTL_START_DATE,
ECTL_END_DATE
)
SELECT
exp_AD_CHG_EFF_DT.USER_NAME as USER_ID,
exp_AD_CHG_EFF_DT.USER_TYPE as USER_TYPE,
exp_AD_CHG_EFF_DT.AGENT_NUMBER as AGENT_NBR,
exp_AD_CHG_EFF_DT.SERVICE_CENTER_NBR as SERVICE_CENTER_NBR,
exp_AD_CHG_EFF_DT.FIRST_NAME as FIRST_NAME,
exp_AD_CHG_EFF_DT.LAST_NAME as LAST_NAME,
exp_AD_CHG_EFF_DT.AD_TITLE as AD_TITLE,
exp_AD_CHG_EFF_DT.AD_CHG_EFF_DT as AD_CHG_EFF_DT,
exp_AD_CHG_EFF_DT.out_AD_CHG_EXP_DT as AD_CHG_EXP_DT,
exp_AD_CHG_EFF_DT.out_ECTL_BATCH_ID as ECTL_BATCH_ID,
exp_AD_CHG_EFF_DT.out_ORIG_INS_TS as ECTL_ORIG_INS_TS,
exp_AD_CHG_EFF_DT.out_ORIG_INS_TS as ECTL_MODIFY_TS,
exp_AD_CHG_EFF_DT.out_ECTL_SRC_ID as ECTL_SRC_ID,
exp_AD_CHG_EFF_DT.out_ECTL_SRC_INST_ID as ECTL_SRC_INST_ID,
exp_AD_CHG_EFF_DT.out_ECTL_PRGM_ID as ECTL_PRGM_ID,
exp_AD_CHG_EFF_DT.out_ECTL_TX_CD as ECTL_TX_CD,
exp_AD_CHG_EFF_DT.out_ECTL_BATCH_START_DATE as ECTL_START_DATE,
exp_AD_CHG_EFF_DT.out_ECTL_END_DATE as ECTL_END_DATE
FROM
exp_AD_CHG_EFF_DT;


-- Component DW_AD_USERS_UPD, Type TARGET 
/* Perform Updates */
MERGE INTO DB_T_CORE_PROD.DW_AD_USERS
USING upd_DW_AD_USERS
ON (USER_ID = upd_DW_AD_USERS.USER_ID3 AND AD_CHG_EFF_DT = upd_DW_AD_USERS.AD_CHG_EFF_DT3)
WHEN MATCHED THEN UPDATE SET
AD_CHG_EXP_DT = upd_DW_AD_USERS.out_AD_CHG_EXP_DT, ECTL_BATCH_ID = upd_DW_AD_USERS.out_ECTL_BATCH_ID3, ECTL_MODIFY_TS = upd_DW_AD_USERS.out_ORIG_INS_TS3, ECTL_TX_CD = upd_DW_AD_USERS.out_ECTL_TX_CD, ECTL_END_DATE = upd_DW_AD_USERS.out_ECTL_END_DATE;




-- PIPELINE END FOR 1

-- PIPELINE START FOR 2

-- Component SQ_Shortcut_to_DW_AD_USERS, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_Shortcut_to_DW_AD_USERS AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as USER_ID,
$2 as AD_CHG_EFF_DT,
$3 as ECTL_TX_CD,
$4 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT LTRIM(RTRIM(DW_AD_USERS.USER_ID)), DW_AD_USERS.AD_CHG_EFF_DT, DW_AD_USERS.ECTL_TX_CD 
FROM
DB_T_CORE_PROD.DW_AD_USERS
WHERE ECTL_TX_CD  =''NEW''
) SRC
)
);


-- Component LKP_AD_USERS, Type LOOKUP 
CREATE OR REPLACE TEMPORARY TABLE LKP_AD_USERS AS
(
SELECT
LKP.USER_NAME,
SQ_Shortcut_to_DW_AD_USERS.USER_ID as USER_ID,
SQ_Shortcut_to_DW_AD_USERS.source_record_id,
ROW_NUMBER() OVER(PARTITION BY SQ_Shortcut_to_DW_AD_USERS.source_record_id ORDER BY LKP.USER_NAME asc) RNK
FROM
SQ_Shortcut_to_DW_AD_USERS
LEFT JOIN (
SELECT LTRIM(RTRIM(AD_USERS.USER_NAME)) as USER_NAME FROM DB_T_STAG_MEMBXREF_PROD.AD_USERS
) LKP ON LKP.USER_NAME = SQ_Shortcut_to_DW_AD_USERS.USER_ID
QUALIFY RNK = 1
);


-- Component exp_derive_column_val, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_derive_column_val AS
(
SELECT
LKP_AD_USERS.USER_NAME as USER_NAME,
SQ_Shortcut_to_DW_AD_USERS.USER_ID as USER_ID,
SQ_Shortcut_to_DW_AD_USERS.AD_CHG_EFF_DT as AD_CHG_EFF_DT,
SQ_Shortcut_to_DW_AD_USERS.ECTL_TX_CD as ECTL_TX_CD,
CASE WHEN LKP_AD_USERS.USER_NAME IS NULL THEN to_date ( to_char ( CURRENT_TIMESTAMP () , ''MM/DD/YYYY HH:MM:SS'' ) ) ELSE NULL END as AD_CHG_EXP_DT,
CURRENT_TIMESTAMP () as ECTL_MODIFY_TS,
CASE WHEN LKP_AD_USERS.USER_NAME IS NULL THEN to_date ( to_char ( CURRENT_TIMESTAMP () , ''MM/DD/YYYY HH:MM:SS'' ) ) ELSE NULL END as ECTL_END_DATE,
''UPD'' as OUT_ECTL_TX_CD,
CASE WHEN LKP_AD_USERS.USER_NAME IS NULL THEN ''UPD'' ELSE ''REJ'' END as out_flag,
:PMMappingName as out_PRGM_NM,
:ACT_PROJ_ID as out_ACT_PROJ_ID,
:BATCH_ACTIVE_IND as out_BATCH_ACTIVE_IND,
:PMShortcut_to_AD_USERSTableName as out_TABLE_NM,
SQ_Shortcut_to_DW_AD_USERS.source_record_id
FROM
SQ_Shortcut_to_DW_AD_USERS
INNER JOIN LKP_AD_USERS ON SQ_Shortcut_to_DW_AD_USERS.source_record_id = LKP_AD_USERS.source_record_id
);


-- Component mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE1, Type MAPPLET 
--MAPPLET NOT REGISTERED: mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE, mapplet instance mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE1;


-- Component rtr_updt_reject_Record_Update, Type ROUTER Output Group Record_Update
create or replace temp table RTR_UPDT_REJECT_RECORD_UPDATE as
SELECT
exp_derive_column_val.USER_NAME as USER_NAME,
exp_derive_column_val.USER_ID as USER_ID,
exp_derive_column_val.AD_CHG_EFF_DT as AD_CHG_EFF_DT,
exp_derive_column_val.ECTL_TX_CD as ECTL_TX_CD,
exp_derive_column_val.AD_CHG_EXP_DT as AD_CHG_EXP_DT,
exp_derive_column_val.ECTL_MODIFY_TS as ECTL_MODIFY_TS,
exp_derive_column_val.ECTL_END_DATE as ECTL_END_DATE,
exp_derive_column_val.OUT_ECTL_TX_CD as OUT_ECTL_TX_CD,
exp_derive_column_val.out_flag as out_flag,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE1.out_ECTL_BATCH_ID as out_ECTL_BATCH_ID,
exp_derive_column_val.source_record_id
FROM
exp_derive_column_val
LEFT JOIN mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE1 ON exp_derive_column_val.source_record_id = mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE1.source_record_id
WHERE exp_derive_column_val.out_flag = ''UPD'';


-- Component updt_retierd_rcrd, Type UPDATE 
CREATE OR REPLACE TEMPORARY TABLE updt_retierd_rcrd AS
(
/* UPDATE_STRATEGY_ACTION = 0 FOR INSERT / UPDATE_STRATEGY_ACTION = 1 FOR UPDATE / UPDATE_STRATEGY_ACTION = 2 FOR DELETE / UPDATE_STRATEGY_ACTION = 3 FOR REJECT */
SELECT
rtr_updt_reject_Record_Update.USER_ID as USER_ID1,
rtr_updt_reject_Record_Update.AD_CHG_EFF_DT as AD_CHG_EFF_DT1,
rtr_updt_reject_Record_Update.ECTL_TX_CD as ECTL_TX_CD1,
rtr_updt_reject_Record_Update.AD_CHG_EXP_DT as AD_CHG_EXP_DT1,
rtr_updt_reject_Record_Update.out_ECTL_BATCH_ID as out_ECTL_BATCH_ID1,
rtr_updt_reject_Record_Update.ECTL_MODIFY_TS as ECTL_MODIFY_TS1,
rtr_updt_reject_Record_Update.OUT_ECTL_TX_CD as OUT_ECTL_TX_CD1,
rtr_updt_reject_Record_Update.ECTL_END_DATE as ECTL_END_DATE1,
1 as UPDATE_STRATEGY_ACTION
FROM
rtr_updt_reject_Record_Update
);


-- Component DW_AD_USERS_retrd_rcrd, Type TARGET 
/* Perform Updates */
MERGE INTO DB_T_CORE_PROD.DW_AD_USERS
USING updt_retierd_rcrd
ON (USER_ID = updt_retierd_rcrd.USER_ID1 AND AD_CHG_EFF_DT = updt_retierd_rcrd.AD_CHG_EFF_DT1)
WHEN MATCHED THEN UPDATE SET
AD_CHG_EXP_DT = updt_retierd_rcrd.AD_CHG_EXP_DT1, ECTL_BATCH_ID = updt_retierd_rcrd.out_ECTL_BATCH_ID1, ECTL_MODIFY_TS = updt_retierd_rcrd.ECTL_MODIFY_TS1, ECTL_TX_CD = updt_retierd_rcrd.OUT_ECTL_TX_CD1, ECTL_END_DATE = updt_retierd_rcrd.ECTL_END_DATE1;


-- PIPELINE END FOR 2

END; ';