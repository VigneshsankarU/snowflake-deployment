-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_MEMB_CUST("WORKLET_NAME" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS '
DECLARE
	run_id STRING;
	workflow_name STRING;
	session_name STRING;
	wf_MONTH_ID STRING;
	v_start_time TIMESTAMP;
BEGIN
	run_id := (SELECT run_id FROM control_run_id WHERE worklet_name = :worklet_name ORDER BY insert_ts DESC LIMIT 1);
	workflow_name := (SELECT workflow_name FROM control_run_id WHERE worklet_name = :worklet_name ORDER BY insert_ts DESC LIMIT 1);
	session_name := ''s_m_MEMB_CUST'';
	wf_MONTH_ID := public.func_get_scoped_param(:run_id, ''wf_MONTH_ID'', :workflow_name, :worklet_name, :session_name);
	v_start_time := CURRENT_TIMESTAMP();

-- PIPELINE START FOR 1
-- Component SQ_MEMB_MSTR, Type Pre SQL 
DELETE FROM ECOREANDB_LGCY.MEMB_CUST WHERE MO_ID=:wf_MONTH_ID;


-- Component SQ_MEMB_MSTR, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_MEMB_MSTR AS
(
WITH ECTL_HEADER_DATES AS(

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

FROM DB_T_CTRL_PROD.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)

,

 POLS_TO_ADD1 AS (

SELECT PC_MEMBER_NUMBER, 

SUM(AUTO) AS AUTO,

SUM(HOME) AS HOME,

SUM(PORT) AS PORT,

SUM(MANHOME) AS MANHOME,

SUM(FIRE) AS FIRE,

SUM(FARM) AS FARM,

SUM(ASIC) AS ASIC,

SUM(SMLN) AS SMLN,

SUM(FGM) AS FGM,

SUM(LIFE) AS LIFE,

SUM(VEH) AS VEH 

FROM

(

SELECT PC_MEMBER_NUMBER,

''0000'' AS PLCY_NUM,

0 AS AUTO,

SUM(HOME) AS HOME,

SUM(PORT) AS PORT,

SUM(MANHOME) AS MANHOME,

SUM(FIRE) AS FIRE,

SUM(FARM) AS FARM,

SUM(ASIC) AS ASIC,

SUM(SMLN) AS SMLN,

SUM(FGM) AS FGM,

SUM(LIFE) AS LIFE,

SUM(VEH) AS VEH 

FROM 

(

SELECT SUBSTR(LF_MEMBERSHIP,1,8) AS PC_MEMBER_NUMBER, 

SC_POLICY_NUM,

0 AS AUTO,

0 AS HOME,

0 AS PORT,

0 AS MANHOME,

0 AS FIRE,

0 AS FARM,

0 AS ASIC,

0 AS SMLN,

0 AS FGM,

1 AS LIFE,

0 AS VEH  

FROM 

DB_T_CORE_MEMBXREF_PROD.LIFEPOLS A, ECTL_HEADER_DATES ECTL 

WHERE LF_STATUS IN (''12'',''21'',''22'',''31'',''32'',''41'',''42'',''43'',''44'',''45'')

AND ECTL.CAL_END_DATE BETWEEN CHG_EFF_DT AND CHG_EXP_DT

UNION ALL

SELECT  SUBSTR(INSURED_MEMBER_NUM,1,8) AS PC_MEMBER_NUMBER, 

POL_ID,

0 AS AUTO,

0 AS HOME,

0 AS PORT,

0 AS MANHOME,

0 AS FIRE,

0 AS FARM,

0 AS ASIC,

0 AS SMLN,

0 AS FGM,

1 AS LIFE,

0 AS VEH 

FROM DB_T_CORE_MEMBXREF_PROD.ING_POL_LIST A, ECTL_HEADER_DATES ECTL 

WHERE POL_STATUS IN (''1'',''2'',''3'',''4'')

AND ECTL.CAL_END_DATE BETWEEN CHG_EFF_DT AND CHG_EXP_DT

) AS MYQ

WHERE CHARACTERS(TRIM(PC_MEMBER_NUMBER))= 8

GROUP BY 1

UNION ALL 

SELECT CAST(PC_MEMBER_NUMBER AS VARCHAR(20)) PC_MEMBER_NUMBER,

SC_POLICY_NUM,

0 AS AUTO,

0 AS HOME,

1 AS PORT,

0 AS MANHOME,

0 AS FIRE,

0 AS FARM,

0 AS ASIC,

0 AS SMLN,

0 AS FGM,

0 AS LIFE,

0 AS VEH 

FROM EVIEWMEMBDB_LGCY.PORTPOLS, ECTL_HEADER_DATES ECTL 

WHERE PC_STATUS IN (1,2,3,4)

AND ECTL.CAL_END_DATE BETWEEN CHG_EFF_DT AND CHG_EXP_DT

AND CHARACTERS(TRIM(PC_MEMBER_NUMBER))= 8

UNION ALL

SELECT  PC_MEMBER_NUMBER,

SC_POLICY_NUM,

0 AS AUTO,

0 AS HOME,

0 AS PORT,

1 AS MANHOME,

0 AS FIRE,

0 AS FARM,

0 AS ASIC,

0 AS SMLN,

0 AS FGM,

0 AS LIFE ,

0 AS VEH

FROM EVIEWMEMBDB_LGCY.MANHOMEPOLS, ECTL_HEADER_DATES ECTL 

WHERE PC_STATUS IN (1,2,3,4) 

AND ECTL.CAL_END_DATE BETWEEN CHG_EFF_DT AND CHG_EXP_DT 

AND CHARACTERS(TRIM(PC_MEMBER_NUMBER))  = 8

UNION ALL

SELECT PC_MEMBER_NUMBER,

SC_POLICY_NUM,

0 AS AUTO,

0 AS HOME,

0 AS PORT,

0 AS MANHOME,

1 AS FIRE,

0 AS FARM,

0 AS ASIC,

0 AS SMLN,

0 AS FGM,

0 AS LIFE,

0 AS VEH 

FROM EVIEWMEMBDB_LGCY.FIREPOLS, ECTL_HEADER_DATES ECTL 

WHERE PC_STATUS IN (1,2,3,4)

AND ECTL.CAL_END_DATE BETWEEN CHG_EFF_DT AND CHG_EXP_DT

AND CHARACTERS(TRIM(PC_MEMBER_NUMBER))=8

UNION ALL

SELECT PC_MEMBER_NUMBER,

SC_POLICY_NUM,

0 AS AUTO,

1 AS HOME,

0 AS PORT,

0 AS MANHOME,

0 AS FIRE,

0 AS FARM,

0 AS ASIC,

0 AS SMLN,

0 AS FGM,

0 AS LIFE,

0 AS VEH 

FROM EVIEWMEMBDB_LGCY.HOMEPOLS, ECTL_HEADER_DATES ECTL 

WHERE PC_STATUS IN (1,2,3,4)

AND ECTL.CAL_END_DATE BETWEEN CHG_EFF_DT AND CHG_EXP_DT

AND CHARACTERS(TRIM(PC_MEMBER_NUMBER))=8

UNION ALL

SELECT PC_MEMBER_NUMBER,

SC_POLICY_NUM,

0 AS AUTO,

0 AS HOME,

0 AS PORT,

0 AS MANHOME,

0 AS FIRE,

1 AS FARM,

0 AS ASIC,

0 AS SMLN,

0 AS FGM,

0 AS LIFE,

0 AS VEH 

FROM EVIEWMEMBDB_LGCY.FARMPOLS, ECTL_HEADER_DATES ECTL 

WHERE PC_STATUS IN (1,2,3,4) 

AND ECTL.CAL_END_DATE BETWEEN CHG_EFF_DT AND CHG_EXP_DT

AND CHARACTERS(TRIM(PC_MEMBER_NUMBER))= 8

/* EIM-50197 */
/*UNION ALL

SELECT PC_MEMBER_NUMBER,

SC_POLICY_NUM,

0 AS AUTO,

0 AS HOME,

0 AS PORT,

0 AS MANHOME,

0 AS FIRE,

0 AS FARM,

1 AS ASIC,

0 AS SMLN,

0 AS FGM,

0 AS LIFE,

0 AS VEH 

FROM EVIEWMEMBDB_LGCY.ASICPOLS, ECTL_HEADER_DATES ECTL 

WHERE PC_STATUS IN (1,2,3,4) 

AND ECTL.CAL_END_DATE BETWEEN CHG_EFF_DT AND CHG_EXP_DT

AND CHARACTERS(TRIM(PC_MEMBER_NUMBER))= 8*/ 

UNION ALL 

SELECT PC_MEMBER_NUMBER,

SC_POLICY_NUM,

0 AS AUTO,

0 AS HOME,

0 AS PORT,

0 AS MANHOME,

0 AS FIRE,

0 AS FARM,

0 AS ASIC,

1 AS SMLN,

0 AS FGM,

0 AS LIFE,

0 AS VEH 

FROM EVIEWMEMBDB_LGCY.SMLNPOLS, ECTL_HEADER_DATES ECTL 

WHERE PC_STATUS IN (1,2,3,4) 

AND ECTL.CAL_END_DATE BETWEEN CHG_EFF_DT AND CHG_EXP_DT

AND CHARACTERS(TRIM(PC_MEMBER_NUMBER))= 8

UNION ALL

SELECT PC_MEMBER_NUMBER,

SC_POLICY_NUM,

0 AS AUTO,

0 AS HOME,

0 AS PORT,

0 AS MANHOME,

0 AS FIRE,

0 AS FARM,

0 AS ASIC,

0 AS SMLN,

1 AS FGM,

0 AS LIFE,

0 AS VEH  

FROM EVIEWMEMBDB_LGCY.FGMPOLS, ECTL_HEADER_DATES ECTL 

WHERE PC_STATUS IN (1,2,3,4) 

AND ECTL.CAL_END_DATE BETWEEN CHG_EFF_DT AND CHG_EXP_DT

AND CHARACTERS(TRIM(PC_MEMBER_NUMBER))= 8

) AS MYQ

GROUP BY PC_MEMBER_NUMBER

UNION 

SELECT

COALESCE(CASE WHEN MBRSHP_TYPE_CD=''CUST'' THEN  ''C''||SUBSTR(LPAD(CAST(MBRSHP_NUM AS STRING), 8, ''0''),2,7)

WHEN MBRSHP_TYPE_CD=''MBRSHP'' THEN  LPAD(CAST(MBRSHP_NUM AS STRING), 8, ''0'')  END ,''000000000'')  CLIENT_REF_NBR,

SUM(CASE WHEN INSRNC_LOB_TYPE_CD =''PA''  THEN 1 ELSE 0 END)  AUTO_POLS,

SUM(CASE WHEN INSRNC_LOB_TYPE_CD LIKE ''HO%''  THEN 1 ELSE 0 END)  HOME_POLS,  

SUM(0)  PORT_POLS, 

SUM(CASE WHEN INSRNC_LOB_TYPE_CD LIKE ''MH%''  THEN 1 ELSE 0 END)  MFGH_POLS, 

SUM(CASE WHEN INSRNC_LOB_TYPE_CD LIKE ''SF%''  THEN 1 ELSE 0 END)  FIRE_POLS, 

SUM(0)  FARM_POLS, 

SUM(0)  ASIC_POLS, 

SUM(CASE WHEN ( INSRNC_LOB_TYPE_CD in (''COMPPERSL'',''PERSARTFL'',''WTC'',''PUP'',''BO'') AND ST=''AL'') THEN 1 ELSE 0 END)  SMLN_POLS,/* EIM-46986  */
SUM( CASE WHEN ( INSRNC_LOB_TYPE_CD in (''COMPPERSL'',''PERSARTFL'',''WTC'',''PUP'',''BO'') AND ST IN (''GA'',''MS'')) THEN 1 ELSE 0 END) FGM_POLS, /* EIM-46986 */


SUM(0) LIFE_POLS,

COALESCE(SUM(CASE WHEN INSRNC_LOB_TYPE_CD =''PA'' then VEH_CNT else 0 end ) ,0)VEH

FROM 

(SELECT DISTINCT A.HOST_AGMT_NUM PLCY_NUM ,D.INSRNC_LOB_TYPE_CD,AGMT_STS_CD,

CASE WHEN A.MODL_EFF_DTTM > A.MODL_CRTN_DTTM THEN A.MODL_EFF_DTTM 

ELSE A.MODL_CRTN_DTTM END AS NEW_AGMT_EFF_DTTM,A.AGMT_ID , A.AGMT_OPN_DTTM,A.TRANS_STRT_DTTM, A.AGMT_EFF_DTTM ,A.TRANS_END_dTTM,MBRSHP_TYPE_CD,MBRSHP_NUM,

A.AGMT_PLND_EXPN_DTTM

FROM  DB_T_PROD_CORE.AGMT AS A JOIN ECTL_HEADER_DATES ON 1=1

JOIN  DB_T_PROD_CORE.AGMT TRM 

ON TRM.HOST_AGMT_NUM=A.HOST_AGMT_NUM AND TRM.TERM_NUM=A.TERM_NUM 

AND    TRM.AGMT_TYPE_CD=''POLTRM''   AND CAST(CAST(CAL_END_DATE AS DATE)+1 AS TIMESTAMPNTZ) - INTERVAL ''1 microsecond'' 

BETWEEN TRM.AGMT_EFF_DTTM AND TRM.AGMT_PLND_EXPN_DTTM 

JOIN DB_T_PROD_CORE.AGMT_STS  AS AS1  ON  TRM.AGMT_ID=AS1.AGMT_ID AND AS1.AGMT_STS_STRT_DTTM <= CAST(CAST(CAL_END_DATE AS DATE)+1 AS TIMESTAMPNTZ) - INTERVAL ''1 microsecond'' 

AND NEW_AGMT_EFF_DTTM < CAST(CAST(CAL_END_DATE AS DATE)+1 AS TIMESTAMPNTZ) - INTERVAL ''1 microsecond''

AND A.AGMT_TYPE_CD = ''PPV'' AND AGMT_STS_CD <> ''CNFRMDDT'' 

LEFT JOIN DB_T_PROD_CORE.AGMT_PROD AP ON A.AGMT_ID=AP.AGMT_ID

LEFT JOIN DB_T_PROD_CORE.AGMT_MBRSHP  AS AM ON A.AGMT_ID=AM.AGMT_iD

LEFT JOIN DB_T_PROD_CORE.MBRSHP   AS M ON M.MBRSHP_ID=AM.MBRSHP_ID

JOIN DB_T_PROD_CORE.PROD P ON AP.PROD_ID=P.PROD_ID

JOIN DB_T_PROD_CORE.INSRNC_LOB_TYPE D ON D.INSRNC_LOB_TYPE_CD=P.INSRNC_LOB_TYPE_CD

QUALIFY ROW_NUMBER() OVER(PARTITION BY A.HOST_AGMT_NUM ORDER BY  A.MODL_CRTN_DTTM DESC,A.MODL_EFF_DTTM DESC, AS1.AGMT_STS_STRT_DTTM DESC) = 1 AND AGMT_STS_CD = ''INFORCE''

) AS A

LEFT OUTER JOIN( SELECT COUNT(DISTINCT PA.ASSET_HOST_ID_VAL) VEH_CNT,AGMT_ID  FROM DB_T_PROD_CORE.AGMT_ASSET AA  JOIN ECTL_HEADER_DATES ON 1=1

JOIN DB_T_PROD_CORE.PRTY_ASSET PA ON PA.PRTY_ASSET_ID=AA.PRTY_ASSET_ID 

WHERE PRTY_ASSET_SBTYPE_CD IN (''MV'',''MVEH'') AND CAST(AA.AGMT_ASSET_STRT_DTTM AS DATE)<=CAL_END_DATE  AND CAST(AA.AGMT_ASSET_END_DTTM AS DATE)>CAL_END_DATE

GROUP BY 2)V  ON V.AGMT_ID=A.AGMT_ID

LEFT OUTER JOIN 

(SELECT DISTINCT AGMT_ID, MAX(GEOGRCL_AREA_SHRT_NAME) ST FROM   DB_T_PROD_CORE.agmt_LOCTR AL 

JOIN DB_T_PROD_CORE.terr t ON Al.loc_id=t.terr_id WHERE AGMT_LOCTR_ROLE_TYPE_CD=''AGTWINST'' GROUP BY 1  ) AS PL

ON A.AGMT_ID = PL.AGMT_ID 

GROUP BY 1)



, CLIENT_NUMBERS AS (

SELECT DISTINCT CL.CLIENT_ID, ca.DW_CLIENT_sKEY,    CA.CLIENT_CHG_EFF_Dt, CA.CLIENT_CHG_END_DT,CL.ALFA_CUST_MEMB_NBR,CL.ALFA_CUST_MEMB_TYPE

FROM

(SELECT DISTINCT CLIENT_ID, dw_client_skey, CLIENT_CHG_EFF_Dt, CLIENT_CHG_END_DT,ALFA_CUST_MEMB_NBR,ALFA_CUST_MEMB_TYPE FROM DB_T_CORE_PROD.CLIENT WHERE ALFA_CUST_MEMB_NBR = '''') AS CA

INNER JOIN

(SELECT * FROM DB_T_CORE_PROD.CLIENT WHERE ALFA_CUST_MEMB_NBR <> '''') AS CL

ON CA.CLIENT_ID =CL.CLIENT_ID 

/*CL.CLIENT_CHG_EFF_Dt >= CA.CLIENT_CHG_EFF_Dt AND

CL.CLIENT_CHG_END_DT >= CA.CLIENT_CHG_END_DT*/

QUALIFY RANK() OVER (PARTITION BY CL.CLIENT_ID ORDER BY CL.CLIENT_CHG_EFF_DT ASC , CL.CLIENT_CHG_END_DT ASC) =1) 

, POLS_TO_ADD2 AS (

SELECT PC_MEMBER_NUMBER, 

SUM(AUTO) AS AUTO,

SUM(HOME) AS HOME,

SUM(PORT) AS PORT,

SUM(MANHOME) AS MANHOME,

SUM(FIRE) AS FIRE,

SUM(FARM) AS FARM,

SUM(ASIC) AS ASIC,

SUM(SMLN) AS SMLN,

SUM(FGM) AS FGM,

SUM(LIFE) AS LIFE,

SUM(VEH) AS VEH 

FROM

(

SELECT

PC_MEMBER_NUMBER,

''0000'' AS PLCY_NBR,

COUNT( DISTINCT AUTO) AS AUTO,

SUM(HOME) AS HOME,

SUM(PORT) AS PORT,

SUM(MANHOME) AS MANHOME,

SUM(FIRE) AS FIRE,

SUM(FARM) AS FARM,

SUM(ASIC) AS ASIC,

SUM(SMLN) AS SMLN,

SUM(FGM) AS FGM,

SUM(LIFE) AS LIFE,

SUM(VEH) AS VEH 

FROM (

SELECT PC_MEMBER_NUMBER, 

PLCY_NUM AS AUTO,

SUM(HOME) AS HOME,

SUM(PORT) AS PORT,

SUM(MANHOME) AS MANHOME,

SUM(FIRE) AS FIRE,

SUM(FARM) AS FARM,

SUM(ASIC) AS ASIC,

SUM(SMLN) AS SMLN,

SUM(FGM) AS FGM,

SUM(LIFE) AS LIFE,

SUM(VEH) AS VEH 

FROM

(

SELECT CASE WHEN (CL.ALFA_CUST_MEMB_TYPE=''MBR''   OR (CL.ALFA_CUST_MEMB_TYPE='''' AND CL1.ALFA_CUST_MEMB_TYPE=''MBR''))

THEN SUBSTR((TRIM(CASE WHEN Cl.ALFA_CUST_MEMB_NBR = '''' THEN CL1.ALFA_CUST_MEMB_NBR ELSE CL.ALFA_CUST_MEMB_NBR END)),2,8)  

WHEN (CL.ALFA_CUST_MEMB_TYPE=''CST''  OR (CL.ALFA_CUST_MEMB_TYPE='''' AND CL1.ALFA_CUST_MEMB_TYPE=''CST'')) THEN 

(''C''||SUBSTR((TRIM(CASE WHEN Cl.ALFA_CUST_MEMB_NBR='''' THEN CL1.ALFA_CUST_MEMB_NBR ELSE CL.ALFA_CUST_MEMB_NBR END)),3,7)) ELSE NULL END AS PC_MEMBER_NUMBER,  

POL.PLCY_NBR AS PLCY_NUM, 

SUBSTR((TRIM(CASE WHEN Cl.ALFA_CUST_MEMB_NBR = '''' THEN CL1.ALFA_CUST_MEMB_NBR ELSE CL.ALFA_CUST_MEMB_NBR END)),2,8)  AS ALFA_CUST_MEM_NBR,

0 AS HOME,

0 AS PORT,

0 AS MANHOME,

0 AS FIRE,

0 AS FARM,

0 AS ASIC,

0 AS SMLN,

0 AS FGM,

0 AS LIFE,

0 AS VEH    

FROM  DB_T_CORE_DM_PROD.POLICY POL

INNER JOIN ECTL_HEADER_DATES ECTL ON 1=1 

LEFT OUTER JOIN 

DB_T_CORE_PROD.CLIENT CL ON

POL.DW_CLIENT_SKEY =  CL.DW_CLIENT_SKEY

AND POL.DAILY_FEED_IND = CL.DAILY_FEED_IND

AND COALESCE(POL.UNDER_TRANSITION_IND,''Z'') = COALESCE(CL.UNDER_TRANSITION_IND,''Z'')

AND (CL.CLIENT_CHG_EFF_DT <=  CAST(CAL_END_DATE AS DATE) AND CL.CLIENT_CHG_END_DT >= CAST(CAL_END_DATE AS DATE) )

LEFT OUTER JOIN CLIENT_NUMBERS CL1

ON Cl.CLIENT_ID=CL1.CLIENT_ID AND Cl.DW_CLIENT_SKEy=CL1.DW_CLIENT_SKEY

WHERE 

PLCY_OGN_EFF_DT <=CAST(CAL_END_DATE AS DATE)  

AND     PLCY_PLN_EXP_DT >= CAST(CAL_END_DATE AS DATE) 

AND     CAST(ISSUE_ACT_TS AS DATE) <= CAL_TO_DATE

AND PLCY_CHG_EFF_DT <= CAST(CAL_END_DATE AS DATE)

AND LOB_CD = ''APV'' 

QUALIFY ROW_NUMBER() OVER(PARTITION BY PLCY_NBR ORDER BY ISSUE_ACT_TS DESC) =1  

AND RNL_STATUS_CD <> ''9'' and not (RNL_status_cd in (''6'',''8'') and PLCY_PLN_EXP_DT <=CAL_END_DATE)

) AS MYQ

GROUP BY 1,2

) AS MYQ1

WHERE CHARACTERS(TRIM(PC_MEMBER_NUMBER))  = 8

GROUP BY 1

UNION ALL 

SELECT

PC_MEMBER_NUMBER,

''0000'' AS PLCY_NBR,

SUM(AUTO) AS AUTO,

SUM(HOME) AS HOME,

SUM(PORT) AS PORT,

SUM(MANHOME) AS MANHOME,

SUM(FIRE) AS FIRE,

SUM(FARM) AS FARM,

SUM(ASIC) AS ASIC,

SUM(SMLN) AS SMLN,

SUM(FGM) AS FGM,

SUM(LIFE) AS LIFE,

COUNT(VEH) AS VEH  

FROM (

SELECT PC_MEMBER_NUMBER, 

SUM(AUTO) AS AUTO,

SUM(HOME) AS HOME,

SUM(PORT) AS PORT,

SUM(MANHOME) AS MANHOME,

SUM(FIRE) AS FIRE,

SUM(FARM) AS FARM,

SUM(ASIC) AS ASIC,

SUM(SMLN) AS SMLN,

SUM(FGM) AS FGM,

SUM(LIFE) AS LIFE,

DW_VEH_SKEY AS VEH  

FROM

(

SELECT CASE WHEN (CL.ALFA_CUST_MEMB_TYPE=''MBR''   OR (CL.ALFA_CUST_MEMB_TYPE='''' AND CL1.ALFA_CUST_MEMB_TYPE=''MBR''))

THEN SUBSTR((TRIM(CASE WHEN Cl.ALFA_CUST_MEMB_NBR = '''' THEN CL1.ALFA_CUST_MEMB_NBR ELSE CL.ALFA_CUST_MEMB_NBR END)),2,8)  

WHEN (CL.ALFA_CUST_MEMB_TYPE=''CST''  OR (CL.ALFA_CUST_MEMB_TYPE='''' AND CL1.ALFA_CUST_MEMB_TYPE=''CST'')) THEN 

(''C''||SUBSTR((TRIM(CASE WHEN Cl.ALFA_CUST_MEMB_NBR='''' THEN CL1.ALFA_CUST_MEMB_NBR ELSE CL.ALFA_CUST_MEMB_NBR END)),3,7)) ELSE NULL END AS PC_MEMBER_NUMBER,  

POL_VEH.RSK_POSTAL_CD AS ZIP, 

POL.SALES_AGENCY_NBR AS SVC, 

POL_VEH.PLCY_NBR AS PLCY_NUM, 

POL_VEH.DW_VEH_SKEY,

0 AS AUTO,

0 AS HOME,

0 AS PORT,

0 AS MANHOME,

0 AS FIRE,

0 AS FARM,

0 AS ASIC,

0 AS SMLN,

0 AS FGM,

0 AS LIFE   

FROM DB_T_CORE_PROD.POLICY_VEHICLE POL_VEH

INNER JOIN ECTL_HEADER_DATES ECTL ON 1=1

JOIN  DB_T_CORE_PROD.DRIVER_VEHICLE DRV_VEH

on  POL_VEH.DW_PLCY_SKEY = DRV_VEH.DW_PLCY_SKEY

AND POL_VEH.DW_VEH_SKEY = DRV_VEH.DW_VEH_SKEY

AND (DRV_VEH.DRVH_CHG_EFF_DT <= CAST(CAL_END_DATE AS DATE) AND DRV_VEH.DRVH_CHG_END_DT >= CAST(CAL_END_DATE AS DATE))

JOIN  DB_T_CORE_DM_PROD.POLICY POL

on POL.DW_PLCY_SKEY = POL_VEH.DW_PLCY_SKEY

AND POL.DAILY_FEED_IND = POL_VEH.DAILY_FEED_IND

AND COALESCE(POL.UNDER_TRANSITION_IND,''Z'') = COALESCE(POL_VEH.UNDER_TRANSITION_IND,''Z'')

JOIN  DB_T_CORE_PROD.CLIENT CL

ON POL.DW_CLIENT_SKEY =  CL.DW_CLIENT_SKEY

AND (CL.CLIENT_CHG_EFF_DT <=  CAST(CAL_END_DATE AS DATE) AND CL.CLIENT_CHG_END_DT >= CAST(CAL_END_DATE AS DATE) )

LEFT OUTER JOIN CLIENT_NUMBERS CL1

ON Cl.CLIENT_ID=CL1.CLIENT_ID AND Cl.DW_CLIENT_SKEy=CL1.DW_CLIENT_SKEY

WHERE 

COALESCE(POL_VEH.UNDER_TRANSITION_IND,''Z'') <> ''N''  

AND CAST(POL.ISSUE_ACT_TS AS DATE) <=  CAST(CAL_TO_DATE AS DATE)

AND POL.PLCY_CHG_EFF_DT <= CAST(CAL_END_DATE AS DATE)  

AND POL.PLCY_CHG_EXP_DT >= CAST(CAL_END_DATE AS DATE)

AND POL_VEH.VEH_CHG_EFF_DT <=CAST(CAL_END_DATE AS DATE) 

AND POL_VEH.VEH_CHG_EXP_DT >=CAST(CAL_END_DATE AS DATE)

AND POL_VEH.VEH_EXP_DT > CAST(CAL_END_DATE AS DATE) 

AND POL.LOB_CD = ''APV'' 

QUALIFY RANK() OVER(PARTITION BY POL_VEH.UNIT_REF_NBR ORDER BY POL.ISSUE_ACT_TS DESC 

, POL_VEH.VEH_CHG_EFF_DT DESC , POL_VEH.VEH_CHG_EXP_DT DESC,DRV_VEH.DRVH_CHG_EFF_DT DESC, DRV_VEH.DRVH_CHG_END_DT DESC

,CL.CLIENT_CHG_eff_DT DESC, CL.CLIENT_CHG_END_DT DESC )=1

) AS MYQ

GROUP BY 1,12

) AS MYQ1

WHERE CHARACTERS(TRIM(PC_MEMBER_NUMBER))  = 8

GROUP BY 1

) AS MYQ

GROUP BY PC_MEMBER_NUMBER),

/* EIM-46986 */
POLS_TO_ADD3 AS (

SELECT PC_MEMBER_NUMBER, 

SUM(AUTO) AS AUTO,

SUM(HOME) AS HOME,

SUM(PORT) AS PORT,

SUM(MANHOME) AS MANHOME,

SUM(FIRE) AS FIRE,

SUM(FARM) AS FARM,

SUM(ASIC) AS ASIC,

SUM(SMLN) AS SMLN,

SUM(FGM) AS FGM,

SUM(LIFE) AS LIFE,

SUM(VEH) AS VEH 

FROM

(

SELECT DISTINCT CASE WHEN MBRSHP_NUM = ''0'' THEN ''0'' ELSE LTRIM(MBRSHP_NUM, ''0'') END AS PC_MEMBER_NUMBER,

0 AUTO,

0 HOME,

0 PORT,

0 MANHOME,

0 FIRE,

0 FARM,

1 ASIC,

0 SMLN,

0 FGM,

0 LIFE,

0 VEH

FROM EVIEWDB_EDW.TREXIS_POLCY_DATA,ECTL_HEADER_DATES 

WHERE CAL_END_DATE BETWEEN TERM_EFF_DT AND EXPN_DT

AND PLCY_STS = ''INFORCE''

) AS MYQ WHERE PC_MEMBER_NUMBER <> ''0''

GROUP BY PC_MEMBER_NUMBER),

 POLS_TO_ADD AS (

SELECT PC_MEMBER_NUMBER, 

SUM(AUTO) AS AUTO,

SUM(HOME) AS HOME,

SUM(PORT) AS PORT,

SUM(MANHOME) AS MANHOME,

SUM(FIRE) AS FIRE,

SUM(FARM) AS FARM,

SUM(ASIC) AS ASIC,

SUM(SMLN) AS SMLN,

SUM(FGM) AS FGM,

SUM(LIFE) AS LIFE,

SUM(VEH) AS VEH 

FROM(

SELECT * FROM POLS_TO_ADD1 

UNION ALL

SELECT * FROM POLS_TO_ADD2

/* EIM-46986 */
UNION ALL

SELECT * FROM POLS_TO_ADD3

)AS MYQ

GROUP BY PC_MEMBER_NUMBER) ,

 PREP_EX_POLIST AS (

SELECT MEMB_NUM PC_MEMBER_NUMBER,

NAME1 EX_FIRST_NAME,

NAME2 EX_LAST_NAME,

ZIP_CD EX_ZIP,

ADDR_LINE_1 EX_ADDRESS_1,

ADDR_LINE_2 EX_ADDRESS_2,

DB_T_PROD_CORE.CITY EX_CITY,

ST_CD EX_STATE,

CAST(MEMB_PHONE AS VARCHAR(50)) EX_TELEPHONE_NBR,

MEMB_EMAIL EX_EMAIL

FROM

(

SELECT CAST(MEMB_MSTR.MEMB_NUM AS VARCHAR(20) ) AS MEMB_NUM,

MEMB_DETAILS.NAME1 NAME1,

MEMB_DETAILS.NAME2 NAME2,

cast(MEMB_DETAILS.CHG_EFF_DT as date) CHG_EFF_DT,

CAST(MEMB_DETAILS.CHG_EXP_DT AS DATE) CHG_EXP_DT,

CAST(ADDRES.ZIP_CD AS VARCHAR(20)) ZIP_CD,

ADDRES.ADDR_LINE_1 ADDR_LINE_1,

ADDRES.ADDR_LINE_2 ADDR_LINE_2,

ADDRES.CITY CITY,

ADDRES.ST_CD ST_CD,

MEMB_MSTR.MEMB_PHONE MEMB_PHONE ,

MEMB_MSTR. MEMB_EMAIL MEMB_EMAIL

FROM 

(SELECT MEMB_SKEY,MEMB_NUM,min(CAST(MEMB_EFF_DT AS DATE)) over(partition by memb_skey order by MEMB_EFF_DT ASC) MEMB_EFF_DT,

mAX(CAST(MEMB_EXP_DT AS DATE)) over(partition by memb_skey order by MEMB_EXP_DT DESC) MEMB_EXP_DT,

mAX(CAST(MEMB_EMAIL AS DATE)) over(partition by memb_skey order by MEMB_EXP_DT DESC) MEMB_EMAIL,

mAX(CAST(MEMB_PHONE AS DATE)) over(partition by memb_skey order by MEMB_EXP_DT DESC) MEMB_PHONE 

FROM DB_T_CORE_PROD.MEMBER_MSTR,ECTL_HEADER_DATES ECTL

WHERE CAST(MEMB_EFF_Dt AS DATE)<=ECTL.CAL_END_DATE 

QUALIFY RANK() OVER(PARTITION by MEMB_NUM ORDER BY CAST(MEMB_EFF_DT AS DATE) DESC, CAST(MEMB_EXP_DT AS DATE) DESC)=1

) MEMB_MSTR 

LEFT OUTER JOIN 

(SELECT MEMB_SKEY,CAST(CHG_EFF_Dt AS DATE) CHG_EFF_DT,CAST(CHG_EXP_Dt AS DATE) CHG_EXP_DT,NAME1,NAME2 FROM  EVIEWDB_LGCY.MEMBER_DETAILS,ECTL_HEADER_DATES ECTL

WHERE CAST(CHG_EFF_DT AS DATE)<=ECTL.CAL_END_DATE

GROUP BY 1,2,3,4,5

QUALIFY RANK() OVER(PARTITION by MEMB_SKEY ORDER BY CAST(CHG_EFF_DT AS DATE) DESC, CAST(CHG_EXP_DT AS DATE) DESC)=1

) MEMB_DETAILS

ON  MEMB_MSTR.MEMB_SKEY =  MEMB_DETAILS.MEMB_SKEY

LEFT OUTER JOIN (SELECT MEMB_SKEY,CAST(ADDR_EFF_DT AS DATE) ADDR_EFF_DT,CAST(ADDR_EXP_DT AS DATE)ADDR_EXP_DT,ADDR_SKEY 

FROM  EVIEWDB_LGCY.MEMBER_ADDRESS,ECTL_HEADER_DATES ECTL 

WHERE  CAST(ADDR_EFF_Dt AS DATE)<=ECTL.CAL_END_DATE

GROUP BY 1,2,3,4

QUALIFY RANK() OVER(PARTITION by MEMB_SKEY ORDER BY CAST(ADDR_EFF_DT AS DATE) DESC,CAST( ADDR_EXP_DT AS DATE) DESC)=1

) MEMB_ADDRESS

ON MEMB_MSTR.MEMB_SKEY = MEMB_ADDRESS.MEMB_SKEY 

LEFT OUTER JOIN  DB_T_CORE_PROD.ADDRESS  ADDRES

ON ADDRES.DW_ADDR_SKEY = MEMB_ADDRESS.ADDR_SKEY   GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12

) QRY

UNION



SELECT EX_MEMBER_NUM, 

MAX(EX_FIRST_NAME) EX_FIRST_NAME

,MAX(EX_LAST_NAME) EX_LAST_NAME

,MAX(EX_ZIP) EX_ZIP 

,MAX(EX_ADDRESS_1) EX_ADDRESS_1

,MAX(EX_ADDRESS_2) EX_ADDRESS_2

,MAX(EX_CITY) EX_CITY

,MAX(EX_STATE) EX_STATE

,MAX(EX_TELEPHONE_NBR) EX_TELEPHONE_NBR

,NULL AS EX_EMAIL FROM

(SELECT EX_MEMBER_NUM, 

EX_FIRST_NAME

,EX_LAST_NAME

,CHG_EFF_Dt,CHG_EXP_DT

,EX_ZIP

,EX_ADDRESS_1

,EX_ADDRESS_2

,EX_CITY

,EX_STATE

,EX_TELEPHONE_NBR,

EX_EFFECTIVE_Dt,EX_EXPIRATION_DT

,NULL AS EX_EMAIL

FROM DB_T_CORE_MEMBXREF_PROD.EXCEED_POL_LIST,ECTL_HEADER_DATES ECTL

WHERE SUBSTR(EX_MEMBER_NUM,1,1) =''C'' 

AND CHG_EFF_DT<=ECTL.CAL_END_DATE GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14

QUALIFY RANK() OVER (PARTITION BY EX_MEMBER_NUM 

ORDER BY EX_EFFECTIVE_Dt DESC,EX_EXPIRATION_Dt DESC,CHG_EFF_DT DESC,CHG_EXP_DT DESC)=1)A GROUP BY 1),

MEMBERS_EX_POLIST_REV1 AS (

SELECT 

(CASE WHEN SUBSTR(A.PC_MEMBER_NUMBER,1,1) =''C'' THEN ''CST'' ELSE ''MBR'' END) AS ALFA_CUST_MEMB_TYPE,

(CASE WHEN SUBSTR(A.PC_MEMBER_NUMBER,1,1) =''C'' THEN CAST(SUBSTR(A.PC_MEMBER_NUMBER,2,8) AS INTEGER) ELSE CAST (A.PC_MEMBER_NUMBER AS INTEGER) END)  

AS  PC_MEMBER_NUMBER,

A.PC_MEMBER_NUMBER MEM_NBR,

A.AUTO,

A.HOME,

A.PORT,

A.MANHOME,

A.FIRE,

A.FARM,

A.ASIC,

A.SMLN,

A.FGM,

DB_T_STAG_MEMBXREF_PROD.LIFE ,

A.VEH

,B.EX_FIRST_NAME

,B.EX_LAST_NAME

,B.EX_ZIP 

,B.EX_ADDRESS_1

,B.EX_ADDRESS_2

,B.EX_CITY

,B.EX_STATE

,B.EX_TELEPHONE_NBR

,B.EX_EMAIL

FROM

POLS_TO_ADD A

LEFT OUTER JOIN

PREP_EX_POLIST B ON 

A.PC_MEMBER_NUMBER=B.PC_MEMBER_NUMBER

WHERE CHARACTERS(TRIM(A.PC_MEMBER_NUMBER)) = 8

AND SUBSTR(A.PC_MEMBER_NUMBER,2,1) NOT IN (''C'',''O'')),

MEMBERS_EX_POLIST_REV2 AS (

SELECT 

(CASE WHEN SUBSTR(A.PC_MEMBER_NUMBER,1,1) =''C'' THEN ''CST'' ELSE ''MBR'' END) AS ALFA_CUST_MEMB_TYPE,

(CASE WHEN SUBSTR(A.PC_MEMBER_NUMBER,1,1) =''C'' THEN CAST(SUBSTR(A.PC_MEMBER_NUMBER,2,8) AS INTEGER) ELSE CAST (A.PC_MEMBER_NUMBER AS INTEGER) END)  

AS  PC_MEMBER_NUMBER,

A.PC_MEMBER_NUMBER MEM_NBR,

A.AUTO,

A.HOME,

A.PORT,

A.MANHOME,

A.FIRE,

A.FARM,

A.ASIC,

A.SMLN,

A.FGM,

DB_T_STAG_MEMBXREF_PROD.LIFE,

A.VEH 

,B.EX_FIRST_NAME

,B.EX_LAST_NAME

,B.EX_ZIP

,B.EX_ADDRESS_1

,B.EX_ADDRESS_2

,B.EX_CITY

,B.EX_STATE

,B.EX_TELEPHONE_NBR

,B.EX_EMAIL

FROM

POLS_TO_ADD A

LEFT  OUTER  JOIN

PREP_EX_POLIST B

ON  A.PC_MEMBER_NUMBER  =B.PC_MEMBER_NUMBER

WHERE SUBSTR(A.PC_MEMBER_NUMBER,2,1) NOT IN (''C'',''O'')  AND  CHARACTERS(TRIM(A.PC_MEMBER_NUMBER)) = 8 AND SUBSTR(A.PC_MEMBER_NUMBER,1,1)=''C''

UNION

SELECT 

(CASE WHEN SUBSTR(A.PC_MEMBER_NUMBER,1,1) =''C'' THEN ''CST'' ELSE ''MBR'' END) AS ALFA_CUST_MEMB_TYPE,

CAST (A.PC_MEMBER_NUMBER AS INTEGER)   AS MEM_NBR,

A.PC_MEMBER_NUMBER,

A.AUTO,

A.HOME,

A.PORT,

A.MANHOME,

A.FIRE,

A.FARM,

A.ASIC,

A.SMLN,

A.FGM,

DB_T_STAG_MEMBXREF_PROD.LIFE,

A.VEH

,B.EX_FIRST_NAME

,B.EX_LAST_NAME

,B.EX_ZIP

,B.EX_ADDRESS_1

,B.EX_ADDRESS_2

,B.EX_CITY

,B.EX_STATE

,B.EX_TELEPHONE_NBR

,B.EX_EMAIL

FROM

POLS_TO_ADD A

LEFT  OUTER  JOIN

PREP_EX_POLIST B

ON CAST(SUBSTR(A.PC_MEMBER_NUMBER,1,8) AS INTEGER)  =CAST(SUBSTR(B.PC_MEMBER_NUMBER,1,8) AS INTEGER)

WHERE SUBSTR(A.PC_MEMBER_NUMBER,2,1) NOT IN (''C'',''O'')  AND  CHARACTERS(TRIM(A.PC_MEMBER_NUMBER)) = 8 AND SUBSTR(A.PC_MEMBER_NUMBER,1,1)<>''C''

AND SUBSTR(B.PC_MEMBER_NUMBER,1,1)<>''C'')



,

MEMBERS_EX_POLIST_REV AS (

SELECT 

A.ALFA_CUST_MEMB_TYPE,

A.PC_MEMBER_NUMBER,

A.MEM_NBR,

A.AUTO,

A.HOME,

A.PORT,

A.MANHOME,

A.FIRE,

A.FARM,

A.ASIC,

A.SMLN,

A.FGM,

DB_T_STAG_MEMBXREF_PROD.LIFE ,

A.VEH

,COALESCE (A.EX_FIRST_NAME,B.EX_FIRST_NAME) EX_FIRST_NAME

,COALESCE (A.EX_LAST_NAME,B.EX_LAST_NAME) EX_LAST_NAME

,COALESCE (A.EX_ZIP,B.EX_ZIP) EX_ZIP

,COALESCE (A.EX_ADDRESS_1,B.EX_ADDRESS_1) EX_ADDRESS_1

,COALESCE (A.EX_ADDRESS_2,B.EX_ADDRESS_2) EX_ADDRESS_2

,COALESCE (A.EX_CITY,B.EX_CITY) EX_CITY

,COALESCE (A.EX_STATE,B.EX_STATE) EX_STATE

,COALESCE (A.EX_TELEPHONE_NBR,B.EX_TELEPHONE_NBR) EX_TELEPHONE_NBR

,COALESCE (A.EX_EMAIL,B.EX_EMAIL) EX_EMAIL

FROM MEMBERS_EX_POLIST_REV1 A

LEFT OUTER JOIN

MEMBERS_EX_POLIST_REV2 B

ON A.ALFA_CUST_MEMB_TYPE=B.ALFA_CUST_MEMB_TYPE 

AND A.PC_MEMBER_NUMBER=B.PC_MEMBER_NUMBER

AND B.EX_FIRST_NAME IS NOT NULL)

,

MEMBERSHIPS_IN_FORCE1 AS (

SELECT

A.MEMB_NUM,

A.MEMB_SKEY,

CAST(A.MEMB_EFF_DT AS DATE) MEMB_EFF_DT,

CAST(A.MEMB_EXP_DT AS DATE)MEMB_EXP_DT,

CAST(B.CHG_EFF_DT AS DATE) AS CHG_EFF_DT,

CAST(B.CHG_EXP_DT AS DATE) AS CHG_EXP_DT,

SUM(CASE WHEN CAST(A.MEMB_EXP_DT AS DATE)>ECTL.CAL_END_DATE AND CAST(B.CHG_EFF_DT AS DATE)<=ECTL.CAL_END_DATE

AND CAST(B.CHG_EXP_DT AS DATE)>ECTL.CAL_END_DATE THEN 1 ELSE 0 END) AS MIF

FROM (SELECT MEMB_NUM,MEMB_SKEY, MIN(MEMB_EFF_DT) MEMB_EFF_DT, MAX(MEMB_EXP_DT) MEMB_EXP_DT FROM DB_T_CORE_PROD.MEMBER_MSTR GROUP BY 1,2) A, DB_T_CORE_PROD.MEMBER_TRANS B, ECTL_HEADER_DATES ECTL

WHERE A.MEMB_SKEY = B.MEMB_SKEY 

AND ((B.STATUS_CD IN (0, 1, 9) /*AND B.COMM_CD1 || B.COMM_CD2 || B.COMM_CD3<> ''XXY''*/ AND B.MEMB_TYPE IN (''A'', ''C'')))

GROUP BY 1,2,3,4,5,6

HAVING MIF >0),

 MEMBER_ATTRIBUTES1 AS (

SELECT MEMB_SKEY,

MEMB_TYPE,

COUNTY_CD,

AMT_PAID AMT_PD,

CAST(CHG_EFF_DT AS DATE) CHG_EFF_DT,

ROW_NUMBER() OVER (PARTITION BY MEMB_SKEY ORDER BY CAST(CHG_EFF_DT AS DATE) DESC) AS RNK

FROM DB_T_CORE_PROD.MEMBER_TRANS

WHERE ((STATUS_CD IN (0, 1, 9)/* AND COMM_CD1 || COMM_CD2 || COMM_CD3 <> ''XXY''*/ AND MEMB_TYPE IN (''A'', ''C'')))

AND CAST(CHG_EFF_DT AS DATE)> ''2010-01-01''

GROUP BY 1,2,3,4,5 QUALIFY RNK=1)

,



 IN_FORCE_W_ATTRIBUTES1 AS (

SELECT ''MBR'' AS ALFA_CUST_MEMB_TYPE,

A.MEMB_NUM,

A.MEMB_SKEY,

A.MEMB_EFF_DT,

A.MEMB_EXP_DT,

A.CHG_EFF_DT,

A.CHG_EXP_DT

,C.EX_FIRST_NAME 

,C.EX_LAST_NAME 

,C.EX_ZIP 

,C.EX_ADDRESS_1 

,C.EX_ADDRESS_2 

,C.EX_CITY 

,C.EX_STATE 

,C.EX_TELEPHONE_NBR,

C.EX_EMAIL,

B.MEMB_TYPE,

B.COUNTY_CD,

B.AMT_PD,

A.MIF 

FROM MEMBERSHIPS_IN_FORCE1 A

LEFT OUTER JOIN 

MEMBER_ATTRIBUTES1 B ON 

A.MEMB_SKEY = B.MEMB_SKEY

LEFT OUTER JOIN

PREP_EX_POLIST C ON 

CAST(A.MEMB_NUM AS VARCHAR(20))=C.PC_MEMBER_NUMBER)



, EXCEED_POLS AS (

SELECT EX_MEMBER_NUM,

EX_EFFECTIVE_DT,

EX_EXPIRATION_DT,

CHG_EFF_DT,

CHG_EXP_DT

FROM DB_T_CORE_MEMBXREF_PROD.EXCEED_POL_LIST

QUALIFY RANK() OVER(PARTITION BY EX_MEMBER_NUM ORDER BY EX_EFFECTIVE_DT DESc,EX_EXPIRATION_DT DESC,CHG_EFF_DT DESC,CHG_EXP_DT DESC)=1)



,

MIF_TABLE AS (

SELECT A.MEMBER_NUMBER,

A.MEMBER_TYPE,

SUm(A.AUTO) AUTO,

SUM(A.HOME) HOME,

SUM(A.PORT) PORT,

SUM(A.MANHOME) MANHOME,

SUM(A.FIRE) FIRE,

SUM(A.FARM) FARM,

SUM(A.ASIC) ASIC,

SUM(A.SMLN) SMLN,

SUM(A.FGM) FGM,

SUM(A.LIFE) LIFE,

SUM(A.VEH) VEH,

A.EX_FIRST_NAME,

A.EX_LAST_NAME,

A.EX_ZIP,

A.EX_ADDRESS_1,

A.EX_ADDRESS_2,

A.EX_CITY,

A.EX_STATE,

A.EX_TELEPHONE_NBR,

A.EX_EMAIL,

A.MEMB_EFF_DT,

A.MEMB_EXP_DT,

A.CHG_EFF_DT,

A.CHG_EXP_DT,

CAST(A.COUNTY_CD AS VARCHAR(20)) COUNTY_CD,

A.AMT_PD,

A.MIF

FROM 

(SELECT  DISTINCT 

COALESCE(A.PC_MEMBER_NUMBER, B.MEMB_NUM) AS MEMBER_NUMBER,

COALESCE(A.ALFA_CUST_MEMB_TYPE, B.ALFA_CUST_MEMB_TYPE) AS MEMBER_TYPE,

A.AUTO,

A.HOME,

A.PORT,

A.MANHOME,

A.FIRE,

A.FARM,

A.ASIC,

A.SMLN,

A.FGM,

DB_T_STAG_MEMBXREF_PROD.LIFE,

A.VEH

,COALESCE(A.EX_FIRST_NAME,B.EX_FIRST_NAME) AS EX_FIRST_NAME

,COALESCE(A.EX_LAST_NAME,B.EX_LAST_NAME) AS EX_LAST_NAME

,COALESCE(A.EX_ZIP,B.EX_ZIP) AS EX_ZIP

,COALESCE(A.EX_ADDRESS_1,B.EX_ADDRESS_1)AS EX_ADDRESS_1

,COALESCE(A.EX_ADDRESS_2,B.EX_ADDRESS_2) AS EX_ADDRESS_2

,COALESCE(A.EX_CITY,B.EX_CITY) AS EX_CITY

,COALESCE(A.EX_STATE,B.EX_STATE) AS EX_STATE

,COALESCE(A.EX_TELEPHONE_NBR,B.EX_TELEPHONE_NBR) AS EX_TELEPHONE_NBR,

COALESCE(A.EX_EMAIL,B.EX_EMAIL) AS EX_EMAIL,

COALESCE(B.MEMB_EFF_DT, C.EX_EFFECTIVE_DT) AS MEMB_EFF_DT,

COALESCE(B.MEMB_EXP_DT,C.EX_EXPIRATION_DT) AS MEMB_EXP_DT,

COALESCE(B.CHG_EFF_DT,C.CHG_EFF_DT) AS CHG_EFF_DT,

COALESCE(B.CHG_EXP_DT,C.CHG_EXP_DT) AS CHG_EXP_DT,

B.COUNTY_CD,

B.AMT_PD,

ZEROIFNULL(B.MIF) AS MIF 

FROM

IN_FORCE_W_ATTRIBUTES1 B

FULL OUTER  JOIN

MEMBERS_EX_POLIST_REV A

ON A.PC_MEMBER_NUMBER=B.MEMB_NUM

AND A.ALFA_CUST_MEMB_TYPE=B.ALFA_CUST_MEMB_TYPE

LEFT OUTER JOIN EXCEED_POLS C

ON A.PC_MEMBER_NUMBER=SUBSTR(C.EX_MEMBER_NUM,2,8) 

AND SUBSTR(A.ALFA_CUST_MEMB_TYPE,1,1)=SUBSTR(EX_MEMBER_NUM,1,1)) A

GROUP by 1,2,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29)


SELECT /* adding column aliases to ensure proper downstream column references */
$1 as MEMBER_NUMBER,
$2 as MEMBER_TYPE,
$3 as INCEPT_DATE,
$4 as EFF_DATE,
$5 as EXP_DATE,
$6 as AUTO,
$7 as HOME,
$8 as PORT,
$9 as MANHOME,
$10 as FIRE,
$11 as FARM,
$12 as ASIC,
$13 as SMLN,
$14 as FGM,
$15 as LIFE,
$16 as VEH,
$17 as NAME1,
$18 as NAME2,
$19 as ZIP_CD,
$20 as ADDR_LINE_1,
$21 as ADDR_LINE_2,
$22 as CITY,
$23 as ST_CD,
$24 as ST_DESC,
$25 as RISK_ST_CD,
$26 as MEMBER_PHONE,
$27 as EMAIL,
$28 as COUNTY_CD,
$29 as COUNTY_DESC,
$30 as AMT_PD,
$31 as MIF,
$32 as MO_ID,
$33 as ECTL_BATCH_ID,
$34 as ECTL_SRC_ID,
$35 as ECTL_SRC_INST_ID,
$36 as ECTL_START_DATE,
$37 as ECTL_END_DATE,
$38 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (

SELECT DISTINCT 

MEMBER_NUMBER,

MEMBER_TYPE,

PC_INCEPT_DATE,

MEMB_EFF_DT,

MEMB_EXP_DT,

AUTO,

HOME,

PORT,

MANHOME,

FIRE,

FARM,

ASIC,

SMLN,

FGM,

DB_T_STAG_MEMBXREF_PROD.LIFE,

VEH,

EX_FIRST_NAME,

EX_LAST_NAME,

EX_ZIP,

EX_ADDRESS_1,

EX_ADDRESS_2,

EX_CITY,

EX_STATE,

STATE_DESC,

NULL AS RISK_ST_CD,

EX_TELEPHONE_NBR,

EX_EMAIL,

COUNTY_CD,

COUNTY_DESC,

AMT_PD,

MIF,

ECTL.MO_ID,

ECTL_BATCH.ECTL_BATCH_ID,

SRC.ECTL_SRC_ID,

SRC_INST.ECTL_SRC_INST_ID,

CAST(SUBSTR(CAST(ECTL_BATCH_START_TS AS VARCHAR(20)),1,10) AS DATE) AS ECTL_START_DT,

CAST(''9999-12-31'' AS DATE) AS ECTL_END_DT

FROM 

((SELECT DISTINCT  MEMBER_NUMBER,

MEMBER_TYPE,

MEMB_EFF_DT AS PC_INCEPT_DATE,

CHG_EFF_dT AS MEMB_EFF_DT,

CHG_EXP_DT AS MEMB_EXP_DT,

AUTO,

HOME,

PORT,

MANHOME,

FIRE,

FARM,

ASIC,

SMLN,

FGM,

DB_T_STAG_MEMBXREF_PROD.LIFE,

VEH,

EX_FIRST_NAME,

EX_LAST_NAME,

EX_ZIP,

EX_ADDRESS_1,

EX_ADDRESS_2,

EX_CITY,

EX_STATE,

E.ST_DESC AS STATE_DESC,

EX_TELEPHONE_NBR,

EX_EMAIL,

CAST(M.COUNTY_CD AS VARCHAR(20)) COUNTY_CD,

D.COUNTY_DESC AS COUNTY_DESC,

AMT_PD,

MIF 

FROM MIF_TABLE M LEFT OUTER JOIN DB_T_CORE_PROD.CLIENT C

ON CAST(C.ALFA_CUST_MEMB_NBR AS INTEGER)=CAST(M.MEMBER_NUMBER AS INTEGER)  LEFT OUTER JOIN DB_T_SHRD_PROD.COUNTY_LOOKUP D 

ON CAST( M.COUNTY_CD AS INTEGER) =CAST(D.COUNTY_CD AS INTEGER) AND D.COUNTY_CD<>''OTH'' AND EX_STATE=D.STATE_CD

LEFT OUTER JOIN DB_T_SHRD_PROD.STATE_LOOKUP E ON EX_STATE=E.ST_CD) A

INNER JOIN (SELECT MAX(ECTL_BATCH_ID) ECTL_BATCH_ID,MAX(ECTL_BATCH_START_TS)ECTL_BATCH_START_TS FROM DB_T_CTRL_FIN_PROD.ECTL_BATCH_INFO 

WHERE ECTL_PROJ_ID=12/* AND ECTL_ACTIVE_IND=''Y'' */) ECTL_BATCH ON 1=1

INNER JOIN (SELECT ECTL_SRC_ID FROM DB_T_CTRL_FIN_PROD.ECTL_SRC_XREF WHERE ECTL_SRC_ID=''6'') SRC ON 1=1

INNER JOIN (SELECT ECTL_SRC_INST_ID FROM DB_T_CTRL_FIN_PROD.ECTL_SRC_INST_XREF WHERE ECTL_SRC_INST_ID=''10'') SRC_INST ON 1=1

CROSS JOIN 

(SELECT MO_ID FROM ECTL_HEADER_DATES) ECTL)
) SRC
)
);


-- Component exp_MEMB_CUST, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_MEMB_CUST AS
(
SELECT
SQ_MEMB_MSTR.MEMBER_NUMBER as MEMBER_NUMBER,
SQ_MEMB_MSTR.MEMBER_TYPE as MEMBER_TYPE,
SQ_MEMB_MSTR.INCEPT_DATE as INCEPT_DATE,
SQ_MEMB_MSTR.EFF_DATE as EFF_DATE,
SQ_MEMB_MSTR.EXP_DATE as EXP_DATE,
SQ_MEMB_MSTR.AUTO as AUTO,
SQ_MEMB_MSTR.HOME as HOME,
SQ_MEMB_MSTR.PORT as PORT,
SQ_MEMB_MSTR.MANHOME as MANHOME,
SQ_MEMB_MSTR.FIRE as FIRE,
SQ_MEMB_MSTR.FARM as FARM,
SQ_MEMB_MSTR.ASIC as ASIC,
SQ_MEMB_MSTR.SMLN as SMLN,
SQ_MEMB_MSTR.FGM as FGM,
SQ_MEMB_MSTR.LIFE as LIFE,
SQ_MEMB_MSTR.VEH as VEH,
SQ_MEMB_MSTR.NAME1 as NAME1,
SQ_MEMB_MSTR.NAME2 as NAME2,
SQ_MEMB_MSTR.ZIP_CD as ZIP_CD,
SQ_MEMB_MSTR.ADDR_LINE_1 as ADDR_LINE_1,
SQ_MEMB_MSTR.ADDR_LINE_2 as ADDR_LINE_2,
SQ_MEMB_MSTR.CITY as CITY,
SQ_MEMB_MSTR.ST_CD as ST_CD,
SQ_MEMB_MSTR.ST_DESC as ST_DESC,
SQ_MEMB_MSTR.RISK_ST_CD as RISK_ST_CD,
SQ_MEMB_MSTR.MEMBER_PHONE as MEMBER_PHONE,
SQ_MEMB_MSTR.EMAIL as EMAIL,
SQ_MEMB_MSTR.COUNTY_CD as COUNTY_CD,
SQ_MEMB_MSTR.COUNTY_DESC as COUNTY_DESC,
SQ_MEMB_MSTR.AMT_PD as AMT_PD,
SQ_MEMB_MSTR.MIF as MIF,
SQ_MEMB_MSTR.MO_ID as MO_ID,
SQ_MEMB_MSTR.ECTL_BATCH_ID as ECTL_BATCH_ID,
SQ_MEMB_MSTR.ECTL_SRC_ID as ECTL_SRC_ID,
SQ_MEMB_MSTR.ECTL_SRC_INST_ID as ECTL_SRC_INST_ID,
SQ_MEMB_MSTR.ECTL_START_DATE as ECTL_START_DATE,
SQ_MEMB_MSTR.ECTL_END_DATE as ECTL_END_DATE,
SQ_MEMB_MSTR.source_record_id
FROM
SQ_MEMB_MSTR
);


-- Component MEMB_CUST_TPT, Type TARGET 
INSERT INTO DB_T_CORE_AN_PROD.MEMB_CUST
(
MEMBER_NUMBER,
MEMBER_TYPE,
INCEPT_DATE,
EFF_DATE,
EXP_DATE,
AUTO,
HOME,
PORT,
MANHOME,
FIRE,
FARM,
ASIC,
SMLN,
FGM,
LIFE,
VEH,
NAME1,
NAME2,
ZIP_CD,
ADDR_LINE_1,
ADDR_LINE_2,
CITY,
ST_CD,
ST_DESC,
RISK_ST_CD,
MEMBER_PHONE,
EMAIL,
COUNTY_CD,
COUNTY_DESC,
AMT_PD,
MIF,
MO_ID,
ECTL_BATCH_ID,
ECTL_SRC_ID,
ECTL_SRC_INST_ID,
ECTL_START_DATE,
ECTL_END_DATE
)
SELECT
exp_MEMB_CUST.MEMBER_NUMBER as MEMBER_NUMBER,
exp_MEMB_CUST.MEMBER_TYPE as MEMBER_TYPE,
exp_MEMB_CUST.INCEPT_DATE as INCEPT_DATE,
exp_MEMB_CUST.EFF_DATE as EFF_DATE,
exp_MEMB_CUST.EXP_DATE as EXP_DATE,
exp_MEMB_CUST.AUTO as AUTO,
exp_MEMB_CUST.HOME as HOME,
exp_MEMB_CUST.PORT as PORT,
exp_MEMB_CUST.MANHOME as MANHOME,
exp_MEMB_CUST.FIRE as FIRE,
exp_MEMB_CUST.FARM as FARM,
exp_MEMB_CUST.ASIC as ASIC,
exp_MEMB_CUST.SMLN as SMLN,
exp_MEMB_CUST.FGM as FGM,
exp_MEMB_CUST.LIFE as LIFE,
exp_MEMB_CUST.VEH as VEH,
exp_MEMB_CUST.NAME1 as NAME1,
exp_MEMB_CUST.NAME2 as NAME2,
exp_MEMB_CUST.ZIP_CD as ZIP_CD,
exp_MEMB_CUST.ADDR_LINE_1 as ADDR_LINE_1,
exp_MEMB_CUST.ADDR_LINE_2 as ADDR_LINE_2,
exp_MEMB_CUST.CITY as CITY,
exp_MEMB_CUST.ST_CD as ST_CD,
exp_MEMB_CUST.ST_DESC as ST_DESC,
exp_MEMB_CUST.RISK_ST_CD as RISK_ST_CD,
exp_MEMB_CUST.MEMBER_PHONE as MEMBER_PHONE,
exp_MEMB_CUST.EMAIL as EMAIL,
exp_MEMB_CUST.COUNTY_CD as COUNTY_CD,
exp_MEMB_CUST.COUNTY_DESC as COUNTY_DESC,
exp_MEMB_CUST.AMT_PD as AMT_PD,
exp_MEMB_CUST.MIF as MIF,
exp_MEMB_CUST.MO_ID as MO_ID,
exp_MEMB_CUST.ECTL_BATCH_ID as ECTL_BATCH_ID,
exp_MEMB_CUST.ECTL_SRC_ID as ECTL_SRC_ID,
exp_MEMB_CUST.ECTL_SRC_INST_ID as ECTL_SRC_INST_ID,
exp_MEMB_CUST.ECTL_START_DATE as ECTL_START_DATE,
exp_MEMB_CUST.ECTL_END_DATE as ECTL_END_DATE
FROM
exp_MEMB_CUST;


-- PIPELINE END FOR 1

-- PIPELINE START FOR 2

-- Component SQ_MEMB_MSTR_POSTSQL, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_MEMB_MSTR_POSTSQL AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as MEMBER_NUMBER,
$2 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT MEMBER_MSTR.MEMB_SKEY 

FROM

 DB_T_CORE_PROD.MEMBER_MSTR  WHERE 1=2
) SRC
)
);


-- Component exp_MEMB_CUST_POSTSQL, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_MEMB_CUST_POSTSQL AS
(
SELECT
SQ_MEMB_MSTR_POSTSQL.MEMBER_NUMBER as MEMBER_NUMBER,
SQ_MEMB_MSTR_POSTSQL.source_record_id
FROM
SQ_MEMB_MSTR_POSTSQL
);


-- Component MEMB_CUST_POSTSQL, Type TARGET 
INSERT INTO DB_T_CORE_AN_PROD.MEMB_CUST
(
MEMBER_NUMBER
)
SELECT
exp_MEMB_CUST_POSTSQL.MEMBER_NUMBER as MEMBER_NUMBER
FROM
exp_MEMB_CUST_POSTSQL;


-- PIPELINE END FOR 2
-- Component MEMB_CUST_POSTSQL, Type Post SQL 
--- INACTIVE MEMBERS ---- NAME & ADDRESS UPDATE-----------------------MEMBER TABLES

/* MO_ID filters has been added to the end to update the monthwise values from the corresponding core tables*/

UPDATE MEMB 

FROM ECOREANDB_LGCY.MEMB_CUST    MEMB,

(SELECT M.MEMBER_NUMBER  AS MEMB_NUM,

MEMBER_DETAILS.NAME1 NAME1,

MEMBER_DETAILS.NAME2 NAME2,

CAST(MEMBER_DETAILS.CHG_EFF_DT AS DATE) CHG_EFF_DT,

CAST(MEMBER_DETAILS.CHG_EXP_DT AS DATE) CHG_EXP_DT,

CAST(ADDRESS.ZIP_CD AS VARCHAR(20)) ZIP_CD,

ADDRESS.ADDR_LINE_1 ADDR_LINE_1,

ADDRESS.ADDR_LINE_2 ADDR_LINE_2,

ADDRESS.CITY CITY,

ADDRESS.ST_CD ST_CD,

CAST(MEMBER_ADDRESS.ADDR_EFF_DT AS DATE) ADDR_EFF_DT

FROM 

(SELECT MEMB_SKEY,MEMB_NUM,min(CAST(MEMB_EFF_DT AS DATE)) over(partition by memb_skey order by MEMB_EFF_DT ASC) MEMB_EFF_DT,

mAX(CAST(MEMB_EXP_DT AS DATE)) over(partition by memb_skey order by MEMB_EXP_DT DESC) MEMB_EXP_DT,

mAX(CAST(MEMB_EMAIL AS DATE)) over(partition by memb_skey order by MEMB_EXP_DT DESC) MEMB_EMAIL,

mAX(CAST(MEMB_PHONE AS DATE)) over(partition by memb_skey order by MEMB_EXP_DT DESC) MEMB_PHONE

FROM EVIEWDB_LGCY.MEMBER_MSTR MEMBER_MSTR,(

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID) ECTL

WHERE CAST(MEMB_EFF_Dt AS DATE)<=ECTL.CAL_END_DATE

QUALIFY RANK() OVER(PARTITION by MEMB_NUM ORDER BY CAST(MEMB_EFF_DT AS DATE) DESC, CAST(MEMB_EXP_DT AS DATE) DESC)=1

) MEMBER_MSTR 

LEFT OUTER JOIN 

(SELECT MEMB_SKEY,CAST(CHG_EFF_Dt AS DATE) CHG_EFF_Dt,CAST(CHG_EXP_Dt AS DATE) CHG_EXP_Dt,NAME1,NAME2 FROM  EVIEWDB_LGCY.MEMBER_DETAILS

WHERE EXTRACT(YEAR FROM CHG_EFF_Dt)*100 +EXTRACT(MONTH FROM CHG_EFF_Dt)<=(SELECT MAX(MO_ID) FROM ( 

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)A)

GROUP BY 1,2,3,4,5

QUALIFY RANK() OVER(PARTITION by MEMB_SKEY ORDER BY CAST(CHG_EFF_DT AS DATE) DESC, CAST(CHG_EXP_DT  AS DATE)DESC)=1) MEMBER_DETAILS

ON  MEMBER_MSTR.MEMB_SKEY =  MEMBER_DETAILS.MEMB_SKEY

LEFT OUTER JOIN (SELECT MEMB_SKEY,CAST(ADDR_EFF_DT AS DATE) ADDR_EFF_DT,CAST(ADDR_EXP_DT AS DATE) ADDR_EXP_DT,ADDR_SKEY FROM  EVIEWDB_LGCY.MEMBER_ADDRESS 

WHERE EXTRACT(YEAR FROM ADDR_EFF_DT)*100 +EXTRACT(MONTH FROM ADDR_EFF_DT)<=(SELECT MAX(MO_ID) FROM (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)A)

GROUP BY 1,2,3,4

QUALIFY RANK() OVER(PARTITION by MEMB_SKEY ORDER BY CAST(ADDR_EFF_DT AS DATE)DESC, CAST(ADDR_EXP_DT AS DATE) DESC)=1) MEMBER_ADDRESS

ON MEMBER_MSTR.MEMB_SKEY = MEMBER_ADDRESS.MEMB_SKEY 

LEFT OUTER JOIN  EVIEWDB_LGCY.ADDRESS  ADDRESS

ON ADDRESS.DW_ADDR_SKEY = MEMBER_ADDRESS.ADDR_SKEY  

INNER JOIN ECOREANDB_LGCY.MEMB_CUST    M

on MEMBER_MSTR.MEMB_NUM=M.MEMBER_NUMBER 

GROUP BY 1,2,3,4,5,6,7,8 ,9,10,11

)UPD_MEMB                      

SET NAME1=UPD_MEMB.NAME1,

NAME2=UPD_MEMB.NAME2,

ZIP_CD=UPD_MEMB.ZIP_CD,

ADDR_LINE_1=UPD_MEMB.ADDR_LINE_1,

ADDR_LINE_2=UPD_MEMB.ADDR_LINE_2,

CITY=UPD_MEMB.CITY,

ST_CD=UPD_MEMB.ST_CD                

WHERE MEMB.MEMBER_NUMBER=UPD_MEMB.MEMB_NUM AND MEMB.MEMBER_TYPE=''MBR'' 

AND EXTRACT(YEAR FROM UPD_MEMB.CHG_EFF_DT)*100 +EXTRACT(MONTH FROM UPD_MEMB.CHG_EFF_DT)<=MEMB.MO_ID

AND EXTRACT(YEAR FROM UPD_MEMB.ADDR_EFF_DT) *100 + EXTRACT(MONTH FROM UPD_MEMB.ADDR_EFF_DT)<=MEMB.MO_ID 

AND MEMB.MO_ID=:wf_MONTH_ID

AND MEMB.MIF=0 AND MEMB.NAME1 IS NULL AND MEMB.ADDR_LINE_1 IS NULL;



--- INACTIVE MEMBERS ---- NAME & ADDRESS UPDATE-----------------------MEMBER TABLES

/* MO_ID filters has been removed to update the records with the latest data which don''t have data in the source tables for the corresponding months*/

UPDATE MEMB 

FROM ECOREANDB_LGCY.MEMB_CUST    MEMB, 

(SELECT M.MEMBER_NUMBER  AS MEMB_NUM,

MEMBER_DETAILS.NAME1 NAME1,

MEMBER_DETAILS.NAME2 NAME2,

MEMBER_DETAILS.CHG_EFF_DT,

MEMBER_DETAILS.CHG_EXP_DT,

CAST(ADDRESS.ZIP_CD AS VARCHAR(20)) ZIP_CD,

ADDRESS.ADDR_LINE_1 ADDR_LINE_1,

ADDRESS.ADDR_LINE_2 ADDR_LINE_2,

ADDRESS.CITY CITY,

ADDRESS.ST_CD ST_CD,

MEMBER_ADDRESS.ADDR_EFF_DT

FROM 

(SELECT MEMB_SKEY,MEMB_NUM,MEMB_EFF_DT,MEMB_EXP_Dt,MEMB_EMAIL,MEMB_PHONE 

FROM EVIEWDB_LGCY.MEMBER_MSTR 

WHERE EXTRACT(YEAR FROM MEMB_EFF_DT)*100 +EXTRACT(MONTH FROM MEMB_EFF_DT)<=(SELECT MAX(MO_ID) FROM (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)a)

GROUP BY 1,2,3,4,5,6

QUALIFY RANK() OVER(PARTITION by MEMB_NUM ORDER BY MEMB_EFF_DT DESC, MEMB_EXP_DT DESC)=1 ) MEMBER_MSTR 

LEFT OUTER JOIN 

(SELECT MEMB_SKEY,CHG_EFF_Dt,CHG_EXP_Dt,NAME1,NAME2 FROM  EVIEWDB_LGCY.MEMBER_DETAILS

WHERE EXTRACT(YEAR FROM CHG_EFF_DT)*100 +EXTRACT(MONTH FROM CHG_EFF_DT)<=(SELECT MAX(MO_ID) FROM (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)A)

GROUP BY 1,2,3,4,5

QUALIFY RANK() OVER(PARTITION by MEMB_SKEY ORDER BY CHG_EFF_DT DESC, CHG_EXP_DT DESC)=1) MEMBER_DETAILS

ON  MEMBER_MSTR.MEMB_SKEY =  MEMBER_DETAILS.MEMB_SKEY

LEFT OUTER JOIN (SELECT MEMB_SKEY,ADDR_EFF_DT,ADDR_EXP_DT,ADDR_SKEY FROM  EVIEWDB_LGCY.MEMBER_ADDRESS 

WHERE EXTRACT(YEAR FROM ADDR_EFF_DT)*100 +EXTRACT(MONTH FROM ADDR_EFF_DT)<=(SELECT MAX(MO_ID) FROM (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)A)

GROUP BY 1,2,3,4

QUALIFY RANK() OVER(PARTITION by MEMB_SKEY ORDER BY ADDR_EFF_DT DESC, ADDR_EXP_DT DESC)=1) MEMBER_ADDRESS

ON MEMBER_MSTR.MEMB_SKEY = MEMBER_ADDRESS.MEMB_SKEY 

LEFT OUTER JOIN  EVIEWDB_LGCY.ADDRESS  ADDRESS

ON ADDRESS.DW_ADDR_SKEY = MEMBER_ADDRESS.ADDR_SKEY  

INNER JOIN ECOREANDB_LGCY.MEMB_CUST    M

on MEMBER_MSTR.MEMB_NUM=M.MEMBER_NUMBER 

GROUP BY 1,2,3,4,5,6,7,8 ,9,10,11

)UPD_MEMB                      

SET NAME1=UPD_MEMB.NAME1,

NAME2=UPD_MEMB.NAME2,

ZIP_CD=UPD_MEMB.ZIP_CD,

ADDR_LINE_1=UPD_MEMB.ADDR_LINE_1,

ADDR_LINE_2=UPD_MEMB.ADDR_LINE_2,

CITY=UPD_MEMB.CITY,

ST_CD=UPD_MEMB.ST_CD                

WHERE MEMB.MEMBER_NUMBER=UPD_MEMB.MEMB_NUM AND MEMB.MEMBER_TYPE=''MBR'' 

AND MEMB.MO_ID=:wf_MONTH_ID

--AND EXTRACT(YEAR FROM UPD_MEMB.CHG_EFF_DT)*100 +EXTRACT(MONTH FROM UPD_MEMB.CHG_EFF_DT)<=MEMB.MO_ID

--AND EXTRACT(YEAR FROM UPD_MEMB.ADDR_EFF_DT) *100 + EXTRACT(MONTH FROM UPD_MEMB.ADDR_EFF_DT)<=MEMB.MO_ID 

AND MEMB.MIF=0 AND MEMB.NAME1 IS NULL AND MEMB.ADDR_LINE_1 IS NULL;



--- INACTIVE MEMBERS---- NAME & ADDRESS UPDATE EXCEED_POL_LIST

/* MO_ID filters has been added to the end to update the monthwise values from the corresponding core tables*/



UPDATE MEMB 

FROM ECOREANDB_LGCY.MEMB_CUST   MEMB, 

(SELECT  DISTINCT B.MEMBER_NUMBER AS MEMB_NUM,EX_FIRST_NAME, EX_LAST_NAME, EX_ADDRESS_1,EX_ADDRESS_2, 

EX_CITY,EX_STATE, CAST(EX_ZIP AS VARCHAR(20)) ZIP_CD,EX_EFFECTIVE_DT

FROm EVIEWMEMBDB_LGCY.EXCEED_POL_LIST A,ECOREANDB_LGCY.MEMB_CUST  B

WHERE B.MIF=0 AND B.NAME1 IS NULL AND B.MEMBER_TYPE=''MBR''

AND B.MEMBER_NUMBER=CASt(SUBSTR(A.EX_MEMBER_NUM,2,8) AS INTEGER)

AND A.EX_MEMBER_NUM NOT LIKE ''C%''

AND  EXTRACT(YEAR FROM CHG_EFF_DT)*100 +EXTRACT(MONTH FROM CHG_EFF_DT)<=(SELECT MAX(MO_ID) FROM (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)A) 

QUALIFY ROW_NUMBER() OVER (PARTITION BY A.EX_MEMBER_NUM ORDER by EX_EFFECTIVE_DT DESc, EX_EXPIRATION_DT DESc,CHG_EFF_DT DESC, CHG_EXP_DT DESc)=1  )UPD_MEMB

SET NAME1=UPD_MEMB.EX_FIRST_NAME,

NAME2=UPD_MEMB.EX_LAST_NAME,

ZIP_CD=UPD_MEMB.ZIP_CD,

ADDR_LINE_1=UPD_MEMB.EX_ADDRESS_1,

ADDR_LINE_2=UPD_MEMB.EX_ADDRESS_2,

CITY=UPD_MEMB.EX_CITY,

ST_CD=UPD_MEMB.EX_STATE                

WHERE MEMB.MEMBER_NUMBER=UPD_MEMB.MEMB_NUM AND MEMB.MEMBER_TYPE=''MBR'' AND MEMB.MIF = 0 AND MEMB.NAME1 IS NULL  AND MEMB.ADDR_LINE_1 IS NULL

AND MEMB.MO_ID=:wf_MONTH_ID

AND EXTRACT(YEAR FROM UPD_MEMB.EX_EFFECTIVE_DT)*100 +EXTRACT(MONTH FROM UPD_MEMB.EX_EFFECTIVE_DT)<=MEMB.MO_ID;



--- INACTIVE MEMBERS---- NAME & ADDRESS UPDATE EXCEED_POL_LIST

/* MO_ID filters has been removed to update the records with the latest data which don''t have data in the source tables for the corresponding months*/

UPDATE MEMB 

FROM ECOREANDB_LGCY.MEMB_CUST   MEMB, 

(SELECT  DISTINCT B.MEMBER_NUMBER AS MEMB_NUM,EX_FIRST_NAME, EX_LAST_NAME, EX_ADDRESS_1,EX_ADDRESS_2, 

EX_CITY,EX_STATE, CAST(EX_ZIP AS VARCHAR(20)) ZIP_CD,EX_EFFECTIVE_DT

FROm EVIEWMEMBDB_LGCY.EXCEED_POL_LIST A,ECOREANDB_LGCY.MEMB_CUST  B

WHERE B.MIF=0 AND B.NAME1 IS NULL AND B.MEMBER_TYPE=''MBR''

AND B.MEMBER_NUMBER=CASt(SUBSTR(A.EX_MEMBER_NUM,2,8) AS INTEGER)

AND A.EX_MEMBER_NUM NOT LIKE ''C%'' 

AND  EXTRACT(YEAR FROM CHG_EFF_DT)*100 +EXTRACT(MONTH FROM CHG_EFF_DT)<=(SELECT MAX(MO_ID) FROM (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)ECTL)

QUALIFY ROW_NUMBER() OVER (PARTITION BY A.EX_MEMBER_NUM ORDER by EX_EFFECTIVE_DT DESc, EX_EXPIRATION_DT DESc,CHG_EFF_DT DESC, CHG_EXP_DT DESc)=1  )UPD_MEMB

SET NAME1=UPD_MEMB.EX_FIRST_NAME,

NAME2=UPD_MEMB.EX_LAST_NAME,

ZIP_CD=UPD_MEMB.ZIP_CD,

ADDR_LINE_1=UPD_MEMB.EX_ADDRESS_1,

ADDR_LINE_2=UPD_MEMB.EX_ADDRESS_2,

CITY=UPD_MEMB.EX_CITY,

ST_CD=UPD_MEMB.EX_STATE                

WHERE MEMB.MEMBER_NUMBER=UPD_MEMB.MEMB_NUM AND MEMB.MEMBER_TYPE=''MBR'' AND MEMB.MIF = 0 AND MEMB.NAME1 IS NULL  AND MEMB.ADDR_LINE_1 IS NULL

AND MEMB.MO_ID=:wf_MONTH_ID;

--AND EXTRACT(YEAR FROM UPD_MEMB.EX_EFFECTIVE_DT)*100 +EXTRACT(MONTH FROM UPD_MEMB.EX_EFFECTIVE_DT)<=MEMB.MO_ID;



--- INACTIVE MEMBERS---- NAME & ADDRESS UPDATE HOMEPOLS

/* MO_ID filters has been added to the end to update the monthwise values from the corresponding core tables*/

UPDATE MEMB 

FROM ECOREANDB_LGCY.MEMB_CUST   MEMB, 

(SELECT  DISTINCT B.MEMBER_NUMBER AS MEMB_NUM,PC_NAME_1, PC_NAME_2, PC_ADDRESS_1,PC_ADDRESS_2, 

LEFT(TRIM(A.PC_CITYST), LENGTH(TRIM(A.PC_CITYST)) - 2) AS CITY,

SUBSTR(TRIM(A.PC_CITYST), LENGTH(TRIM(A.PC_CITYST)) - 1, 2) AS ST_CD, 

CAST(PC_ZIP AS VARCHAR(20)) ZIP_CD,CHG_EFF_DT,CHG_EXP_DT

FROm EVIEWMEMBDB_LGCY.HOMEPOLS A,ECOREANDB_LGCY.MEMB_CUST    B

WHERE B.MIF=0 AND B.NAME1 IS NULL AND B.MEMBER_TYPE=''MBR''

AND B.MEMBER_NUMBER=CASt(SUBSTR(A.PC_MEMBER_NUMBER,2,8) AS INTEGER)

AND A.PC_MEMBER_NUMBER NOT LIKE ''C%'' 

AND EXTRACT(YEAR FROM CHG_EFF_DT)*100 +EXTRACT(MONTH FROM CHG_EFF_DT)<=(SELECT MAX(MO_ID) FROM (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)ECTL)

QUALIFY RANK() OVER (PARTITION BY A.PC_MEMBER_NUMBER ORDER by PC_EFF_DATE DESc, PC_EXP_DATE DESc,CHG_EFF_DT DESC, CHG_EXP_DT DESc)=1  )UPD_MEMB 

SET NAME1=UPD_MEMB.PC_NAME_1,

NAME2=UPD_MEMB.PC_NAME_2,

ZIP_CD=UPD_MEMB.ZIP_CD,

ADDR_LINE_1=UPD_MEMB.PC_ADDRESS_1,

ADDR_LINE_2=UPD_MEMB.PC_ADDRESS_2,

CITY=UPD_MEMB.CITY,

ST_CD=UPD_MEMB.ST_CD                

WHERE MEMB.MEMBER_NUMBER=UPD_MEMB.MEMB_NUM AND MEMB.MEMBER_TYPE=''MBR'' AND MEMB.MIF = 0 AND MEMB.NAME1 IS NULL AND MEMB.ADDR_LINE_1 IS NULL 

AND MEMB.MO_ID=:wf_MONTH_ID

AND EXTRACT(YEAR FROM UPD_MEMB.CHG_EFF_DT)*100 +EXTRACT(MONTH FROM UPD_MEMB.CHG_EFF_DT)<=MEMB.MO_ID

AND MEMB.MO_ID=:wf_MONTH_ID;



--- INACTIVE MEMBERS---- NAME & ADDRESS UPDATE HOMEPOLS

/* MO_ID filters has been removed to update the records with the latest data which don''t have data in the source tables for the corresponding months*/

UPDATE MEMB 

FROM ECOREANDB_LGCY.MEMB_CUST   MEMB, 

(SELECT  DISTINCT B.MEMBER_NUMBER AS MEMB_NUM,PC_NAME_1, PC_NAME_2, PC_ADDRESS_1,PC_ADDRESS_2, 

LEFT(TRIM(A.PC_CITYST), LENGTH(TRIM(A.PC_CITYST)) - 2) AS CITY,

SUBSTR(TRIM(A.PC_CITYST), LENGTH(TRIM(A.PC_CITYST)) - 1, 2) AS ST_CD, 

CAST(PC_ZIP AS VARCHAR(20)) ZIP_CD

FROm EVIEWMEMBDB_LGCY.HOMEPOLS A,ECOREANDB_LGCY.MEMB_CUST    B

WHERE B.MIF=0 AND B.NAME1 IS NULL AND B.MEMBER_TYPE=''MBR''

AND B.MEMBER_NUMBER=CASt(SUBSTR(A.PC_MEMBER_NUMBER,2,8) AS INTEGER)

AND A.PC_MEMBER_NUMBER NOT LIKE ''C%''

AND EXTRACT(YEAR FROM CHG_EFF_DT)*100 +EXTRACT(MONTH FROM CHG_EFF_DT)<=(SELECT MAX(MO_ID) FROM (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)ECTL) 

QUALIFY RANK() OVER (PARTITION BY A.PC_MEMBER_NUMBER ORDER by PC_EFF_DATE DESc, PC_EXP_DATE DESc,CHG_EFF_DT DESC, CHG_EXP_DT DESc)=1  )UPD_MEMB 

SET NAME1=UPD_MEMB.PC_NAME_1,

NAME2=UPD_MEMB.PC_NAME_2,

ZIP_CD=UPD_MEMB.ZIP_CD,

ADDR_LINE_1=UPD_MEMB.PC_ADDRESS_1,

ADDR_LINE_2=UPD_MEMB.PC_ADDRESS_2,

CITY=UPD_MEMB.CITY,

ST_CD=UPD_MEMB.ST_CD                

WHERE MEMB.MEMBER_NUMBER=UPD_MEMB.MEMB_NUM AND MEMB.MEMBER_TYPE=''MBR'' AND MEMB.MIF = 0 AND MEMB.NAME1 IS NULL AND MEMB.ADDR_LINE_1 IS NULL

AND MEMB.MO_ID=:wf_MONTH_ID; 

--AND EXTRACT(YEAR FROM UPD_MEMB.CHG_EFF_DT)*100 +EXTRACT(MONTH FROM UPD_MEMB.CHG_EFF_DT)<=MEMB.MO_ID;



--- INACTIVE CUSTOMERS---- NAME & ADDRESS UPDATE HOMEPOLS

/* MO_ID filters has been added to the end to update the monthwise values from the corresponding core tables*/

UPDATE MEMB 

FROM  ECOREANDB_LGCY.MEMB_CUST   MEMB, 

(SELECT  DISTINCT B.MEMBER_NUMBER AS MEMB_NUM,A.PC_MEMBER_NUMBER AS MN,PC_INCEPT_DATE,SC_TRANS_DATE,PC_EFF_DATE,PC_EXP_DATE,CHG_EFF_Dt,CHG_EXP_DT ,

MAX(PC_NAME_1) PC_NAME_1, MAX(PC_NAME_2) PC_NAME_2, MAX(PC_ADDRESS_1) PC_ADDRESS_1,MAX(PC_ADDRESS_2) AS PC_ADDRESS_2, 

MAX(LEFT(TRIM(A.PC_CITYST), LENGTH(TRIM(A.PC_CITYST)) - 2)) AS CITY,

MAX(SUBSTR(TRIM(A.PC_CITYST), LENGTH(TRIM(A.PC_CITYST)) - 1, 2)) AS ST_CD, 

MAX(CAST(PC_ZIP AS VARCHAR(20))) ZIP_CD

FROm EVIEWMEMBDB_LGCY.HOMEPOLS A,ECOREANDB_LGCY.MEMB_CUST  B

WHERE B.MIF=0 AND B.NAME1 IS NULL AND B.MEMBER_TYPE=''CST''

AND B.MEMBER_NUMBER=CASt(SUBSTR(A.PC_MEMBER_NUMBER,2,8) AS INTEGER)

AND A.PC_MEMBER_NUMBER  LIKE ''C%''

AND EXTRACT(YEAR FROM CHG_EFF_DT)*100 +EXTRACT(MONTH FROM CHG_EFF_DT)<=(SELECT MAX(MO_ID) FROM (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)ECTL) 

GROUP BY 1,2,3,4,5,6,7,8

QUALIFY RANK() OVER 

(PARTITION BY A.PC_MEMBER_NUMBER 

ORDER by PC_INCEPT_DATE DESC ,SC_TRANS_DATE DESc,PC_EFF_DATE DESc, PC_EXP_DATE DESc,CHG_EFF_DT DESC, CHG_EXP_DT DESc)=1

)UPD_MEMB                      

SET NAME1=UPD_MEMB.PC_NAME_1,

NAME2=UPD_MEMB.PC_NAME_2,

ZIP_CD=UPD_MEMB.ZIP_CD,

ADDR_LINE_1=UPD_MEMB.PC_ADDRESS_1,

ADDR_LINE_2=UPD_MEMB.PC_ADDRESS_2,

CITY=UPD_MEMB.CITY,

ST_CD=UPD_MEMB.ST_CD                

WHERE MEMB.MEMBER_NUMBER=UPD_MEMB.MEMB_NUM AND MEMB.MEMBER_TYPE=''CST'' AND MEMB.MIF = 0 AND MEMB.NAME1 IS NULL AND MEMB.ADDR_LINE_1 IS NULL 

AND MEMB.MO_ID=:wf_MONTH_ID

AND EXTRACT(YEAR FROM UPD_MEMB.CHG_EFF_DT)*100 +EXTRACT(MONTH FROM UPD_MEMB.CHG_EFF_DT)<=MEMB.MO_ID

AND MEMB.MO_ID=:wf_MONTH_ID;



/* MO_ID filters has been removed to update the records with the latest data which don''t have data in the source tables for the corresponding months*/

--- INACTIVE CUSTOMERS---- NAME & ADDRESS UPDATE HOMEPOLS

UPDATE MEMB 

FROM  ECOREANDB_LGCY.MEMB_CUST   MEMB, 

(SELECT  DISTINCT B.MEMBER_NUMBER AS MEMB_NUM,A.PC_MEMBER_NUMBER AS MN,PC_INCEPT_DATE,SC_TRANS_DATE,PC_EFF_DATE,PC_EXP_DATE,CHG_EFF_Dt,CHG_EXP_DT ,

MAX(PC_NAME_1) PC_NAME_1, MAX(PC_NAME_2) PC_NAME_2, MAX(PC_ADDRESS_1) PC_ADDRESS_1,MAX(PC_ADDRESS_2) AS PC_ADDRESS_2, 

MAX(LEFT(TRIM(A.PC_CITYST), LEN(TRIM(A.PC_CITYST)) - 2)) AS CITY,

MAX(SUBSTR(TRIM(A.PC_CITYST), LEN(TRIM(A.PC_CITYST)) - 1, 2)) AS ST_CD,

MAX(CAST(PC_ZIP AS VARCHAR(20))) ZIP_CD

FROm EVIEWMEMBDB_LGCY.HOMEPOLS A,ECOREANDB_LGCY.MEMB_CUST  B

WHERE B.MIF=0 AND B.NAME1 IS NULL AND B.MEMBER_TYPE=''CST''

AND B.MEMBER_NUMBER=CASt(SUBSTR(A.PC_MEMBER_NUMBER,2,8) AS INTEGER)

AND A.PC_MEMBER_NUMBER  LIKE ''C%'' 

AND EXTRACT(YEAR FROM CHG_EFF_DT)*100 +EXTRACT(MONTH FROM CHG_EFF_DT)<=(SELECT MAX(MO_ID) FROM (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)ECTL)

GROUP BY 1,2,3,4,5,6,7,8 

QUALIFY RANK() OVER 

(PARTITION BY A.PC_MEMBER_NUMBER 

ORDER by PC_INCEPT_DATE DESC ,SC_TRANS_DATE DESc,PC_EFF_DATE DESc, PC_EXP_DATE DESc,CHG_EFF_DT DESC, CHG_EXP_DT DESc)=1

)UPD_MEMB                      

SET NAME1=UPD_MEMB.PC_NAME_1,

NAME2=UPD_MEMB.PC_NAME_2,

ZIP_CD=UPD_MEMB.ZIP_CD,

ADDR_LINE_1=UPD_MEMB.PC_ADDRESS_1,

ADDR_LINE_2=UPD_MEMB.PC_ADDRESS_2,

CITY=UPD_MEMB.CITY,

ST_CD=UPD_MEMB.ST_CD                

WHERE MEMB.MEMBER_NUMBER=UPD_MEMB.MEMB_NUM AND MEMB.MEMBER_TYPE=''CST'' AND MEMB.MIF = 0 AND MEMB.NAME1 IS NULL AND MEMB.ADDR_LINE_1 IS NULL 

AND MEMB.MO_ID=:wf_MONTH_ID;

--AND EXTRACT(YEAR FROM UPD_MEMB.CHG_EFF_DT)*100 +EXTRACT(MONTH FROM UPD_MEMB.CHG_EFF_DT)<=MEMB.MO_ID;



--- INACTIVE CUSTOMERS---- NAME & ADDRESS UPDATE EXCEED_POL_LIST

/* MO_ID filters has been added to the end to update the monthwise values from the corresponding core tables*/

UPDATE MEMB 

FROM ECOREANDB_LGCY.MEMB_CUST   MEMB, 

(SELECT B.MEMBER_NUMBER AS MEMBER_NUMBER, 

MAX(EX_FIRST_NAME) AS NAME1

,MAX(EX_LAST_NAME) AS NAME2

,MAX(EX_ZIP) AS ZIP_CD

,MAX(EX_ADDRESS_1) AS ADDR_LINE_1

,MAX(EX_ADDRESS_2) AS ADDR_LINE_2

,MAX(EX_CITY) AS CITY 

,MAX(EX_STATE) AS ST_CD

,MAX(EX_TELEPHONE_NBR) AS MEMBER_PHONE

,MAX(EX_EFFECTIVE_DT) AS EX_EFFECTIVE_DT

,NULL AS EX_EMAIL FROM

(SELECT EX_MEMBER_NUM, 

EX_FIRST_NAME

,EX_LAST_NAME

,CHG_EFF_Dt,CHG_EXP_DT

,EX_ZIP

,EX_ADDRESS_1

,EX_ADDRESS_2

,EX_CITY

,EX_STATE

,EX_TELEPHONE_NBR,

EX_EFFECTIVE_Dt,EX_EXPIRATION_DT

,NULL AS EX_EMAIL

FROM EVIEWMEMBDB_LGCY.EXCEED_POL_LIST

WHERE SUBSTR(EX_MEMBER_NUM,1,1) =''C'' 

AND EXTRACT(YEAR FROM CHG_EFF_DT)*100 +EXTRACT(MONTH FROM CHG_EFF_DT)<=(SELECT MAX(MO_ID) FROM (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)ECTL)

GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14

QUALIFY ROW_NUMBER() OVER (PARTITION BY EX_MEMBER_NUM 

ORDER BY EX_EFFECTIVE_Dt DESC,EX_EXPIRATION_Dt DESC,CHG_EFF_DT DESC,CHG_EXP_DT DESC)=1)A

JOIN ECOREANDB_LGCY.MEMB_CUST  B

ON B.MEMBER_NUMBER=CASt(SUBSTR(A.EX_MEMBER_NUM,2,8) AS INTEGER)

GROUP BY 1 )UPD_MEMB                      

SET NAME1=UPD_MEMB.NAME1,

NAME2=UPD_MEMB.NAME2,

ZIP_CD=UPD_MEMB.ZIP_CD,

ADDR_LINE_1=UPD_MEMB.ADDR_LINE_1,

ADDR_LINE_2=UPD_MEMB.ADDR_LINE_2,

CITY=UPD_MEMB.CITY,

ST_CD=UPD_MEMB.ST_CD  ,

MEMBER_PHONE=UPD_MEMB.MEMBER_PHONE              

WHERE MEMB.MEMBER_NUMBER=UPD_MEMB.MEMBER_NUMBER AND MEMB.MEMBER_TYPE=''CST'' AND MEMB.MIF = 0 AND MEMB.NAME1 IS NULL AND MEMB.ADDR_LINE_1 IS NULL 

AND EXTRACT(YEAR FROM UPD_MEMB.EX_EFFECTIVE_DT)*100 +EXTRACT(MONTH FROM UPD_MEMB.EX_EFFECTIVE_DT)<=MEMB.MO_ID

AND MEMB.MO_ID=:wf_MONTH_ID;



/* MO_ID filters has been removed to update the records with the latest data which don''t have data in the source tables for the corresponding months*/

--- INACTIVE CUSTOMERS---- NAME & ADDRESS UPDATE EXCEED_POL_LIST

UPDATE MEMB 

FROM ECOREANDB_LGCY.MEMB_CUST   MEMB, 

(SELECT B.MEMBER_NUMBER AS MEMBER_NUMBER, 

MAX(EX_FIRST_NAME) AS NAME1

,MAX(EX_LAST_NAME) AS NAME2

,MAX(EX_ZIP) AS ZIP_CD

,MAX(EX_ADDRESS_1) AS ADDR_LINE_1

,MAX(EX_ADDRESS_2) AS ADDR_LINE_2

,MAX(EX_CITY) AS CITY 

,MAX(EX_STATE) AS ST_CD

,MAX(EX_TELEPHONE_NBR) AS MEMBER_PHONE

,MAX(EX_EFFECTIVE_DT) AS EX_EFFECTIVE_DT

,NULL AS EX_EMAIL FROM

(SELECT EX_MEMBER_NUM, 

EX_FIRST_NAME

,EX_LAST_NAME

,CHG_EFF_Dt,CHG_EXP_DT

,EX_ZIP

,EX_ADDRESS_1

,EX_ADDRESS_2

,EX_CITY

,EX_STATE

,EX_TELEPHONE_NBR,

EX_EFFECTIVE_Dt,EX_EXPIRATION_DT

,NULL AS EX_EMAIL

FROM EVIEWMEMBDB_LGCY.EXCEED_POL_LIST

WHERE SUBSTR(EX_MEMBER_NUM,1,1) =''C'' 

AND EXTRACT(YEAR FROM CHG_EFF_DT)*100 +EXTRACT(MONTH FROM CHG_EFF_DT)<=(SELECT MAX(MO_ID) FROM (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)ECTL)

GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14

QUALIFY ROW_NUMBER() OVER (PARTITION BY EX_MEMBER_NUM 

ORDER BY EX_EFFECTIVE_Dt DESC,EX_EXPIRATION_Dt DESC,CHG_EFF_DT DESC,CHG_EXP_DT DESC)=1)A

JOIN ECOREANDB_LGCY.MEMB_CUST  B

ON B.MEMBER_NUMBER=CASt(SUBSTR(A.EX_MEMBER_NUM,2,8) AS INTEGER)

GROUP BY 1 )UPD_MEMB                      

SET NAME1=UPD_MEMB.NAME1,

NAME2=UPD_MEMB.NAME2,

ZIP_CD=UPD_MEMB.ZIP_CD,

ADDR_LINE_1=UPD_MEMB.ADDR_LINE_1,

ADDR_LINE_2=UPD_MEMB.ADDR_LINE_2,

CITY=UPD_MEMB.CITY,

ST_CD=UPD_MEMB.ST_CD  ,

MEMBER_PHONE=UPD_MEMB.MEMBER_PHONE              

WHERE MEMB.MEMBER_NUMBER=UPD_MEMB.MEMBER_NUMBER AND MEMB.MEMBER_TYPE=''CST'' AND MEMB.MIF = 0 AND MEMB.NAME1 IS NULL AND MEMB.ADDR_LINE_1 IS NULL 

AND MEMB.MO_ID=:wf_MONTH_ID;

--AND EXTRACT(YEAR FROM UPD_MEMB.EX_EFFECTIVE_DT)*100 +EXTRACT(MONTH FROM UPD_MEMB.EX_EFFECTIVE_DT)<=MEMB.MO_ID;



--- INACTIVE MEMBERS ---- INCEPTION DATE UPDATE MEMBER TABLES

UPDATE MEMB 

FROM ECOREANDB_LGCY.MEMB_CUST   MEMB, (SELECT A.MEMBER_NUMBER AS MEMBER_NUMBER, MIN(B.MEMB_EFF_DT) AS INCEPT_DT 

FROM ECOREANDB_LGCY.MEMB_CUST  A, EVIEWDB_LGCY.MEMBER_MSTR B

WHERE A.MEMBER_TYPE=''MBR'' AND A.INCEPT_DATE IS NULL 

AND B.MEMB_NUM=A.MEMBER_NUMBER

GROUP BY 1  )UPD_MEMB                      

SET INCEPT_DATE=UPD_MEMB.INCEPT_DT                

WHERE MEMB.MEMBER_NUMBER=UPD_MEMB.MEMBER_NUMBER AND MEMB.MEMBER_TYPE=''MBR'' AND MIF=0 AND MEMB.INCEPT_DATE IS NULL 

AND MEMB.MO_ID=:wf_MONTH_ID;



--- INACTIVE CUSTOMERS ---- INCEPTION DATE UPDATE HOMEPOLS

UPDATE MEMB 

FROM ECOREANDB_LGCY.MEMB_CUST  MEMB,  

(SELECT A.MEMBER_NUMBER AS MEMBER_NUMBER, MIN(DISTINCT PC_INCEPT_DATE ) AS INCEPT_DT 

FROM ECOREANDB_LGCY.MEMB_CUST  A, EVIEWMEMBDB_LGCY.HOMEPOLS B

WHERE A.MEMBER_TYPE=''CST'' AND A.INCEPT_DATE IS NULL  AND MIF=0 AND PC_MEMBER_NUMBER LIKE''C%''

AND CASt(SUBSTR(B.PC_MEMBER_NUMBER,2,8) AS INTEGER)=A.MEMBER_NUMBER

GROUP BY 1 )UPD_MEMB                      

SET INCEPT_DATE=UPD_MEMB.INCEPT_DT                

WHERE MEMB.MEMBER_NUMBER=UPD_MEMB.MEMBER_NUMBER AND MEMB.MEMBER_TYPE=''CST'' AND MEMB.INCEPT_DATE IS NULL AND MEMB.MIF=0 

AND MEMB.MO_ID=:wf_MONTH_ID;



--- INACTIVE CUSTOMERS---- INCEPTION DATE UPDATE EXCEED_POL_LIST

UPDATE MEMB 

FROM ECOREANDB_LGCY.MEMB_CUST  MEMB, 

(SELECT A.MEMBER_NUMBER AS MEMBER_NUMBER,MIN(B.EX_EFFECTIVE_DT) AS INCEPT_DT 

FROM ECOREANDB_LGCY.MEMB_CUST  A,EVIEWMEMBDB_LGCY.EXCEED_POL_LIST B

WHERE A.MEMBER_TYPE=''CST'' AND A.INCEPT_DATE IS NULL AND B.EX_MEMBER_NUm  LIKE ''C%''

AND A.MEMBER_NUMBER=CASt(SUBSTR(EX_MEMBER_NUM,2,8) AS INTEGER)

GROUP BY 1  )UPD_MEMB                      

SET INCEPT_DATE=UPD_MEMB.INCEPT_DT                

WHERE MEMB.MEMBER_NUMBER=UPD_MEMB.MEMBER_NUMBER AND MEMB.MEMBER_TYPE=''CST'' AND MEMB.INCEPT_DATE IS NULL AND MEMB.MIF=0 

AND MEMB.MO_ID=:wf_MONTH_ID;



--- ALL MEMBERS & CUSTOMERS---- STATE CODE UPDATE

UPDATE MEMB 

FROM ECOREANDB_LGCY.MEMB_CUST   MEMB, 

(SELECT DISTINCT A.MEMBER_NUMBER MEMBER_NUMBER,A.MEMBER_TYPE, A.ST_CD ST_CD,B.ST_DESc FROm ECOREANDB_LGCY.MEMB_CUST  A,EVIEWDB_LGCY.STATE_LOOKUP B

WHERE A.ST_DESc IS NULL AND A.ST_CD IS NOT NULL

AND A.ST_CD= B.ST_CD )UPD_MEMB                      

SET ST_DESC=UPD_MEMB.ST_DESC             

WHERE MEMB.MEMBER_NUMBER=UPD_MEMB.MEMBER_NUMBER AND MEMB.MEMBER_TYPE=UPD_MEMB.MEMBER_TYPE AND MEMB.ST_CD=UPD_MEMB.ST_CD 

AND MEMB.MO_ID=:wf_MONTH_ID ;



--- INACTIVE MEMBERS ---- AMOUNT & COUNTY UPDATE

UPDATE MEMB 

FROM ECOREANDB_LGCY.MEMB_CUST   MEMB,

(SELECT  AMT_CTY.MEMBER_NUMBER AS MEMBER_NUMBER, MAX(AMT_CTY.COUNTY_CD) AS COUNTY_CD,MAX(AMT_CTY.AMT_PD) AS AMT_PD FROM 

(

SELECT 

B.MEMB_SKEY AS MEMB_SKEY,

B.MEMB_NUM AS MEMBER_NUMBER,

A.CHG_EFF_DT AS EFFECTIVE_DT,

MAX(COUNTY_CD) AS COUNTY_CD,

MAX(AMT_PAID) AS AMT_PD

FROM EVIEWDB_LGCY.MEMBER_TRANS A, EVIEWDB_LGCY.MEMBER_MSTR B

WHERE A.MEMB_SKEY = B.MEMB_SKEY

GROUP BY 1,2,3

QUALIFY RANK() OVER (PARTITION BY B.MEMB_SKEY ORDER BY CHG_EFF_DT DESC) = 1

) AMT_CTY,  ECOREANDB_LGCY.MEMB_CUST  B

WHERE AMT_CTY.MEMBER_NUMBER = B.MEMBER_NUMBER

AND  B.MEMBER_TYPE = ''MBR'' AND B.MIF = 0 AND B.AMT_PD IS NULL AND B.COUNTY_CD IS NULL

GROUP BY 1) UPD_MEMB

SET 

COUNTY_CD = CAST(UPD_MEMB.COUNTY_CD AS VARCHAR(20)),

AMT_PD = UPD_MEMB.AMT_PD

WHERE  MEMB.MEMBER_NUMBER=UPD_MEMB.MEMBER_NUMBER AND MEMB.MEMBER_TYPE = ''MBR'' AND MEMB.MIF = 0 AND MEMB.AMT_PD IS NULL AND MEMB.COUNTY_CD IS NULL

AND MEMB.MO_ID=:wf_MONTH_ID;



--- ACTIVE MEMBERS ---- AMOUNT & COUNTY UPDATE

UPDATE MEMB 

FROM ECOREANDB_LGCY.MEMB_CUST   MEMB,

(SELECT  AMT_CTY.MEMBER_NUMBER AS MEMBER_NUMBER, MAX(AMT_CTY.COUNTY_CD) AS COUNTY_CD,MAX(AMT_CTY.AMT_PD) AS AMT_PD FROM 

(

SELECT 

B.MEMB_SKEY AS MEMB_SKEY,

B.MEMB_NUM AS MEMBER_NUMBER,

A.CHG_EFF_DT AS EFFECTIVE_DT,

MAX(COUNTY_CD) AS COUNTY_CD,

MAX(AMT_PAID) AS AMT_PD

FROM EVIEWDB_LGCY.MEMBER_TRANS A, EVIEWDB_LGCY.MEMBER_MSTR B

WHERE A.MEMB_SKEY = B.MEMB_SKEY

GROUP BY 1,2,3

QUALIFY RANK() OVER (PARTITION BY B.MEMB_SKEY ORDER BY CHG_EFF_DT DESC) = 1

) AMT_CTY,  ECOREANDB_LGCY.MEMB_CUST  B

WHERE AMT_CTY.MEMBER_NUMBER = B.MEMBER_NUMBER

AND  B.MEMBER_TYPE = ''MBR'' AND B.MIF = 1 AND B.AMT_PD IS NULL AND B.COUNTY_CD IS NULL

GROUP BY 1) UPD_MEMB

SET 

COUNTY_CD = CAST(UPD_MEMB.COUNTY_CD AS VARCHAR(20)),

AMT_PD = UPD_MEMB.AMT_PD

WHERE  MEMB.MEMBER_NUMBER=UPD_MEMB.MEMBER_NUMBER AND MEMB.MEMBER_TYPE = ''MBR'' AND MEMB.MIF = 1 AND MEMB.AMT_PD IS NULL AND MEMB.COUNTY_CD IS NULL

AND MEMB.MO_ID=:wf_MONTH_ID;



--- ALL MEMBERS & CUSTOMERS---- COUNTY CODE UPDATE

UPDATE MEMB 

FROM ECOREANDB_LGCY.MEMB_CUST   MEMB, 

(SELECT DISTINCT A.MEMBER_NUMBER, A.MEMBER_TYPE, B.STATE_CD,A.COUNTY_CD,B.COUNTY_DESC FROm ECOREANDB_LGCY.MEMB_CUST  A,EVIEWDB_LGCY.COUNTY_LOOKUP B

WHERE A.COUNTY_DESC IS NULL AND A.COUNTY_CD IS NOT NULL

AND CAST( A.COUNTY_CD AS INTEGER) =CAST(B.COUNTY_CD AS INTEGER) AND B.COUNTY_CD<>''OTH'' )UPD_MEMB                      

SET COUNTY_DESC=UPD_MEMB.COUNTY_DESC             

WHERE MEMB.MEMBER_NUMBER=UPD_MEMB.MEMBER_NUMBER AND MEMB.MEMBER_TYPE=UPD_MEMB.MEMBER_TYPE

AND CAST(MEMB.COUNTY_CD AS INTEGER)=CAST(UPD_MEMB.COUNTY_CD AS INTEGER) AND MEMB.ST_CD=UPD_MEMB.STATE_CD 

AND MEMB.MO_ID=:wf_MONTH_ID;



---INCEPT DATE UPDATE FOR ALL CUSTOMERS FROM HOMEPOLS

UPDATE MEMB 

FROM ECOREANDB_LGCY.MEMB_CUST   MEMB, 

(SELECT A.MEMBER_NUMBER,A.MEMBER_TYPE,

MIN(CASE WHEN COALESCE(A.DATE1,TO_DATE(''9999-12-31'', ''YYYY-MM-DD''))<COALESCE(A.DATE2 ,TO_DATE(''9999-12-31'', ''YYYY-MM-DD'')) 

THEN A.DATE1 ELSE A.DATE2 END) AS INCEPT_DATE

FROM

(SELECT A.MEMBER_NUMBER AS MEMBER_NUMBER, A.MEMBER_TYPE AS MEMBER_TYPE, A.INCEPT_DATE AS DATE1,B.INCEPT_DATE AS DATE2

FROM ECOREANDB_LGCY.MEMB_CUST   A,  

(SELECT (CASE WHEN SUBSTR(A.PC_MEMBER_NUMBER,1,1) =''C'' THEN ''CST'' ELSE ''MBR'' END) AS ALFA_CUST_MEMB_TYPE,

(CASE WHEN SUBSTR(A.PC_MEMBER_NUMBER,1,1) =''C'' THEN 

CAST(SUBSTR(A.PC_MEMBER_NUMBER,2,8) AS INTEGER) ELSE CAST (A.PC_MEMBER_NUMBER AS INTEGER) END) AS MEMBER_NUMBER,

MIN(PC_INCEPT_DATE) AS INCEPT_DATE FROM EVIEWMEMBDB_LGCY.HOMEPOLS A 

WHERE CHARACTERS(TRIM(A.PC_MEMBER_NUMBER)) = 8

AND SUBSTR(A.PC_MEMBER_NUMBER,2,1) NOT IN (''C'',''O'')

GROUP by 1,2 

) B

WHERE A.MEMBER_NUMBER=B.MEMBER_NUMBER and A.MEMBER_TYPE=B.ALFA_CUST_MEMB_TYPE

AND A.HOME<>0 AND A.MEMBER_TYPE=''CST''

GROUP BY 1,2,3,4

)A GROUP by 1,2)UPD_MEMB                     

SET INCEPT_DATE=UPD_MEMB.INCEPT_DATE             

WHERE MEMB.MEMBER_NUMBER=UPD_MEMB.MEMBER_NUMBER 

AND MEMB.MEMBER_TYPE=UPD_MEMB.MEMBER_TYPE

AND MEMB.HOME<>0  AND MEMB.MEMBER_TYPE=''CST''

AND MEMB.MO_ID=:wf_MONTH_ID;



---INCEPT DATE UPDATE FOR ALL CUSTOMERS FROM LIFEPOLS

UPDATE MEMB 

FROM ECOREANDB_LGCY.MEMB_CUST   MEMB, 

(SELECT A.MEMBER_NUMBER,A.MEMBER_TYPE,

MIN(CASE WHEN COALESCE(A.DATE1,TO_DATE(''9999-12-31'', ''YYYY-MM-DD''))<COALESCE(A.DATE2 ,TO_DATE(''9999-12-31'', ''YYYY-MM-DD'')) 

THEN A.DATE1 ELSE A.DATE2 END) AS INCEPT_DATE

FROM

(SELECT A.MEMBER_TYPE, A.MEMBER_NUMBER,A. INCEPT_DATE AS DATE1, B.INCEPT_DATE AS DATE2 

FROM ECOREANDB_LGCY.MEMB_CUST  A,

(SELECT (CASE WHEN SUBSTR(LF_MEMBERSHIP,1,1) =''C'' THEN ''CST'' ELSE ''MBR'' END)

AS MEMBER_TYPE,(CASE WHEN SUBSTR(LF_MEMBERSHIP,1,1) =''C'' THEN 

CAST(SUBSTR(LF_MEMBERSHIP,2,8) AS INTEGER) ELSE CAST (LF_MEMBERSHIP AS INTEGER) END) AS MEMBER_NUMBER,

MIN(LF_ISSUE_DATE) AS INCEPT_DATE

FROM EVIEWMEMBDB_LGCY.LIFEPOLS WHERE CHARACTERS(TRIM(LF_MEMBERSHIP)) = 8

AND SUBSTR(LF_MEMBERSHIP,2,1) NOT IN (''C'',''O'') GROUP by 1,2

)B

WHERE A.MEMBER_NUMBER=B.MEMBER_NUMBER and A.MEMBER_TYPE=B.MEMBER_TYPE

AND A.LIFE<>0 AND A.MEMBER_TYPE=''CST''

GROUP BY 1,2,3,4

)A GROUP by 1,2)UPD_MEMB                     

SET INCEPT_DATE=UPD_MEMB.INCEPT_DATE             

WHERE MEMB.MEMBER_NUMBER=UPD_MEMB.MEMBER_NUMBER 

AND MEMB.MEMBER_TYPE=UPD_MEMB.MEMBER_TYPE

AND MEMB.LIFE<>0  AND MEMB.MEMBER_TYPE=''CST''

AND MEMB.MO_ID=:wf_MONTH_ID;



---INCEPT DATE UPDATE FOR ALL CUSTOMERS FROM ING_POL_LIST

UPDATE MEMB 

FROM ECOREANDB_LGCY.MEMB_CUST   MEMB, 

(SELECT A.MEMBER_NUMBER,A.MEMBER_TYPE,

MIN(CASE WHEN COALESCE(A.DATE1,TO_DATE(''9999-12-31'', ''YYYY-MM-DD''))<COALESCE(A.DATE2 ,TO_DATE(''9999-12-31'', ''YYYY-MM-DD'')) 

THEN A.DATE1 ELSE A.DATE2 END) AS INCEPT_DATE

FROM

(SELECT A.MEMBER_TYPE, A.MEMBER_NUMBER,A. INCEPT_DATE AS DATE1, B.INCEPT_DATE AS DATE2 

FROM ECOREANDB_LGCY.MEMB_CUST  A,

(SELECT (CASE WHEN SUBSTR(INSURED_MEMBER_NUM,1,1) =''C'' THEN ''CST'' ELSE ''MBR'' END)

AS MEMBER_TYPE,(CASE WHEN SUBSTR(INSURED_MEMBER_NUM,1,1) =''C'' THEN 

CAST(SUBSTR(INSURED_MEMBER_NUM,2,8) AS INTEGER) ELSE CAST (INSURED_MEMBER_NUM AS INTEGER) END) AS MEMBER_NUMBER,

MIN(POL_ISS_DT) AS INCEPT_DATE

FROM EVIEWMEMBDB_LGCY.ING_POL_LIST WHERE CHARACTERS(TRIM(INSURED_MEMBER_NUM)) = 8

AND SUBSTR(INSURED_MEMBER_NUM,2,1) NOT IN (''C'',''O'') GROUP by 1,2

)B

WHERE A.MEMBER_NUMBER=B.MEMBER_NUMBER and A.MEMBER_TYPE=B.MEMBER_TYPE

AND A.LIFE<>0 AND A.MEMBER_TYPE=''CST''

GROUP BY 1,2,3,4

)A GROUP by 1,2)UPD_MEMB                     

SET INCEPT_DATE=UPD_MEMB.INCEPT_DATE             

WHERE MEMB.MEMBER_NUMBER=UPD_MEMB.MEMBER_NUMBER 

AND MEMB.MEMBER_TYPE=UPD_MEMB.MEMBER_TYPE

AND MEMB.LIFE<>0  AND MEMB.MEMBER_TYPE=''CST''

AND MEMB.MO_ID=:wf_MONTH_ID;



---Update risk state for Members only------

UPDATE ECOREANDB_LGCY.MEMB_CUST 

SET RISK_ST_CD=''AL''

WHERE MEMBER_TYPE=''MBR''  AND RISK_ST_CD iS NULL

AND MO_ID=:wf_MONTH_ID ;



------Update risk state for GA and MS----------

UPDATE ECOREANDB_LGCY.MEMB_CUST 

SET RISK_ST_CD=ST_CD 

WHERE MEMBER_TYPE=''CST'' AND RISK_ST_CD iS NULL

AND ST_CD in (''GA'',''MS'')   AND MO_ID=:wf_MONTH_ID   ;



------Update Risk state using AUTO_POLICY_SUMM-------------

UPDATE A FROM ECOREANDB_LGCY.MEMB_CUST  A,

(SELECT MO_ID,CASt(ALFA_CUST_MEMB_NBR AS INTEGER) MEMBER_NUMBER,ALFA_CUST_MEMB_TYPE MEMBER_TYPE,PLCY_SVC_NBR,

CASE WHEN RSK_ST_CD in (''GA'',''MS'') THEN RSK_ST_CD ELSE NULL END  RSK_ST_CD 

FROM ECOREANDB_LGCY.AUTO_POLICY_SUMM 

WHERE MO_ID=:wf_MONTH_ID  AND MEMBER_TYPE=''CST'' AND RSK_ST_CD in (''AL'',''GA'',''MS'' )

QUALIFY RANK() oVER (PARTITION by MEMBER_NUMBER,MEMBER_TYPE 

ORDER BY PLCY_OGN_IPT_Dt DESC,PLCY_OGN_EFF_DT DESC,PLCY_CHG_EFF_DT DESC,PLCY_CHG_EXP_DT DESC,ISSUE_ACT_TS DESC)=1

) B

SET RISK_ST_CD=B.RSK_ST_CD

WHERE   A.MO_ID=:wf_MONTH_ID AND   A.RISK_ST_CD IS NULL AND A.MEMBER_TYPE=''CST''

AND A.MEMBER_TYPE=B.MEMBER_TYPE AND A.MEMBER_NUMBER=B.MEMBER_NUMBER 

AND A.auto>0 ;



-------Update Risk state using HOME_POLICY_SUMM & SERVICE_CENTER------

UPDATE A FROM ECOREANDB_LGCY.MEMB_CUST  A,

(SELECT HP.MO_ID MO_ID,CUST_MEMB_NUM MEMBER_NUMBER,CUST_MEMB_TYPE MEMBER_TYPE,

COALESCE(CASE WHEN HP.STATE_CD in (''GA'',''MS'') THEN HP.STATE_CD ELSE NULL END,SVC1.STATE) RSK_ST_CD

FROM 

ECOREANDB_LGCY.HOME_POLICY_SUMM HP

LEFT OUTER JOIN 

 EVIEWANDB_LGCY.SERVICE_CENTER SVC1

ON SVC1.SVC_NUM=CAST(HP.PLCY_SVC_NBR AS INTEGER) 

WHERE HP.MO_ID=:wf_MONTH_ID AND MEMBER_TYPE=''CST''  AND RSK_ST_CD in (''AL'',''GA'',''MS'' )

GROUP BY 1,2,3,4,PLCY_OGN_IPT_DT,PLCY_OGN_EFF_DT,PLCY_PLN_EXP_DT,PLCY_CHG_EFF_Dt,PLCY_CHG_EXP_DT

QUALIFY RANK() OVER (PARTITION BY MEMBER_NUMBER,MEMBER_TYPE ORDER BY PLCY_OGN_IPT_DT,PLCY_OGN_EFF_DT,PLCY_PLN_EXP_DT,PLCY_CHG_EFF_Dt,PLCY_CHG_EXP_DT)=1

) B

SET RISK_ST_CD=B.RSK_ST_CD

WHERE    A.RISK_ST_CD IS NULL AND A.MEMBER_TYPE=''CST''

AND A.MEMBER_TYPE=B.MEMBER_TYPE AND A.MEMBER_NUMBER=B.MEMBER_NUMBER

AND A.MO_ID=B.MO_ID

AND  A.MO_ID=:wf_MONTH_ID   AND A.HOME>0;



-------Update Risk state using ASICPOLS & SERVICE_CENTER------

UPDATE A FROM ECOREANDB_LGCY.MEMB_CUST  A,

(SELECT DISTINCT CASt(SUBSTR(ASP.PC_MEMBER_NUMBER,2) AS INTEGER) MEMBER_NUMBER,

CASE WHEN SUBSTR(ASP.PC_MEMBER_NUMBER,1,1)=''C'' THEN ''CST'' ELSE ''MBR'' END MEMBER_TYPE,

CASE WHEN ASP.PC_STATE in (''GA'',''MS'') THEN  ASP.PC_STATE ELSE NULL END ASP_PC_STATE,

COALESCE(ASP_PC_STATE,SVC2.STATE) RSK_ST_CD

FROM 

EVIEWMEMBDB_LGCY.ASICPOLS ASP

LEFT OUTER JOIN

 EVIEWANDB_LGCY.SERVICE_CENTER SVC2

ON SVC2.SVC_NUM=ASP.SC_SERVICE_CENTER 

INNER JOIN (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)  ECTL ON 1=1

WHERE  ECTL.CAL_END_DATE BETWEEN ASP.CHG_EFF_DT AND ASP.CHG_EXP_DT

AND (CASE WHEN SUBSTR(ASP.PC_MEMBER_NUMBER,1,1)=''C'' THEN ''CST'' ELSE ''MBR'' END)=''CST''

AND RSK_ST_CD IN (''AL'',''MS'',''GA'')

QUALIFY  RANK() OVER (PARTITION BY PC_MEMBER_NUMBER ORDER BY PC_EFF_DATE,PC_EXP_DATE,CHG_EFF_DT,CHG_EXP_DT)=1) B

SET RISK_ST_CD=B.RSK_ST_CD

WHERE   A.RISK_ST_CD IS NULL AND A.MEMBER_TYPE=''CST''

AND A.MEMBER_TYPE=B.MEMBER_TYPE AND A.MEMBER_NUMBER=B.MEMBER_NUMBER

AND A.MO_ID=:wf_MONTH_ID AND   A.ASIC>0;



-------Update Risk state using MANHOMEPOLS & SERVICE_CENTER------

UPDATE A FROM ECOREANDB_LGCY.MEMB_CUST  A,

(SELECT DISTINCT CASt(SUBSTR(MHP.PC_MEMBER_NUMBER,2) AS INTEGER) MEMBER_NUMBER,

CASE WHEN SUBSTR(MHP.PC_MEMBER_NUMBER,1,1)=''C'' THEN ''CST'' ELSE ''MBR'' END MEMBER_TYPE,

CASE WHEN SUBSTR(MHP.PC_CITYST,CHARACTERS(TRIM(MHP.PC_CITYST))-1,2) in (''GA'',''MS'') THEN 

SUBSTR(MHP.PC_CITYST,CHARACTERS(TRIM(MHP.PC_CITYST))-1,2) ELSE NULL END MH_STATE_CD,

COALESCE(MH_STATE_CD,SVC3.STATE) RSK_ST_CD

FROM 

EVIEWMEMBDB_LGCY.MANHOMEPOLS MHP

LEFT OUTER JOIN

 EVIEWANDB_LGCY.SERVICE_CENTER SVC3

ON SVC3.SVC_NUM=MHP.SC_SERVICE_CENTER 

INNER JOIN (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)  ECTL ON 1=1

WHERE  ECTL.CAL_END_DATE BETWEEN MHP.CHG_EFF_DT AND MHP.CHG_EXP_DT

AND (CASE WHEN SUBSTR(MHP.PC_MEMBER_NUMBER,1,1)=''C'' THEN ''CST'' ELSE ''MBR'' END)=''CST''

AND RSK_ST_CD IN (''AL'',''MS'',''GA'')

QUALIFY  RANK() OVER (PARTITION BY PC_MEMBER_NUMBER ORDER BY PC_EFF_DATE,PC_EXP_DATE,CHG_EFF_DT,CHG_EXP_DT)=1) B

SET RISK_ST_CD=B.RSK_ST_CD

WHERE    A.RISK_ST_CD IS NULL AND A.MEMBER_TYPE=''CST''

AND A.MEMBER_TYPE=B.MEMBER_TYPE AND A.MEMBER_NUMBER=B.MEMBER_NUMBER

AND A.MO_ID=:wf_MONTH_ID AND   A.MANHOME>0;



-------Update Risk state using FIREPOLS & SERVICE_CENTER------

UPDATE A FROM ECOREANDB_LGCY.MEMB_CUST  A,

(SELECT DISTINCT CASt(SUBSTR(FP.PC_MEMBER_NUMBER,2) AS INTEGER) MEMBER_NUMBER,

CASE WHEN SUBSTR(FP.PC_MEMBER_NUMBER,1,1)=''C'' THEN ''CST'' ELSE ''MBR'' END MEMBER_TYPE,

CASE WHEN SUBSTR(FP.PC_CITYST,CHARACTERS(TRIM(FP.PC_CITYST))-1,2) in (''GA'',''MS'') THEN 

SUBSTR(FP.PC_CITYST,CHARACTERS(TRIM(FP.PC_CITYST))-1,2) ELSE NULL END FIRE_RSK_ST_CD,

COALESCE(FIRE_RSK_ST_CD,SVC4.STATE) RSK_ST_CD

FROM 

EVIEWMEMBDB_LGCY.FIREPOLS FP

LEFT OUTER JOIN

 EVIEWANDB_LGCY.SERVICE_CENTER SVC4

ON SVC4.SVC_NUM=FP.SC_SERVICE_CENTER 

INNER JOIN (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)  ECTL ON 1=1

WHERE  ECTL.CAL_END_DATE BETWEEN FP.CHG_EFF_DT AND FP.CHG_EXP_DT

AND (CASE WHEN SUBSTR(FP.PC_MEMBER_NUMBER,1,1)=''C'' THEN ''CST'' ELSE ''MBR'' END)=''CST''

AND RSK_ST_CD IN (''AL'',''MS'',''GA'')

QUALIFY  RANK() OVER (PARTITION BY PC_MEMBER_NUMBER ORDER BY PC_EFF_DATE,PC_EXP_DATE,CHG_EFF_DT,CHG_EXP_DT)=1) B

SET RISK_ST_CD=B.RSK_ST_CD

WHERE   A.RISK_ST_CD IS NULL AND A.MEMBER_TYPE=''CST''

AND A.MEMBER_TYPE=B.MEMBER_TYPE AND A.MEMBER_NUMBER=B.MEMBER_NUMBER

AND A.MO_ID=:wf_MONTH_ID AND   A.FIRE>0;



-------Update Risk state using FGMPOLS & SERVICE_CENTER------

UPDATE A FROM ECOREANDB_LGCY.MEMB_CUST  A,

(SELECT DISTINCT CASt(SUBSTR(FP.PC_MEMBER_NUMBER,2) AS INTEGER) MEMBER_NUMBER,

CASE WHEN SUBSTR(FP.PC_MEMBER_NUMBER,1,1)=''C'' THEN ''CST'' ELSE ''MBR'' END MEMBER_TYPE,

CASE WHEN SUBSTR(FP.PC_CITYST,CHARACTERS(TRIM(FP.PC_CITYST))-1,2) in (''GA'',''MS'') THEN 

SUBSTR(FP.PC_CITYST,CHARACTERS(TRIM(FP.PC_CITYST))-1,2) ELSE NULL END FIRE_RSK_ST_CD,

COALESCE(FIRE_RSK_ST_CD,SVC4.STATE) RSK_ST_CD

FROM 

EVIEWMEMBDB_LGCY.FGMPOLS FP

LEFT OUTER JOIN

 EVIEWANDB_LGCY.SERVICE_CENTER SVC4

ON SVC4.SVC_NUM=FP.SC_SERVICE_CENTER 

INNER JOIN (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)  ECTL ON 1=1

WHERE  ECTL.CAL_END_DATE BETWEEN FP.CHG_EFF_DT AND FP.CHG_EXP_DT

AND (CASE WHEN SUBSTR(FP.PC_MEMBER_NUMBER,1,1)=''C'' THEN ''CST'' ELSE ''MBR'' END)=''CST''

AND RSK_ST_CD IN (''AL'',''MS'',''GA'')

QUALIFY  RANK() OVER (PARTITION BY PC_MEMBER_NUMBER ORDER BY PC_EFF_DATE,PC_EXP_DATE,CHG_EFF_DT,CHG_EXP_DT)=1) B

SET RISK_ST_CD=B.RSK_ST_CD

WHERE   A.RISK_ST_CD IS NULL AND A.MEMBER_TYPE=''CST''

AND A.MEMBER_TYPE=B.MEMBER_TYPE AND A.MEMBER_NUMBER=B.MEMBER_NUMBER

AND A.MO_ID=:wf_MONTH_ID AND   A.FGM>0;



-------Update Risk state using SMLNPOLS & SERVICE_CENTER------

UPDATE A FROM ECOREANDB_LGCY.MEMB_CUST  A,

(SELECT DISTINCT CASt(SUBSTR(SM.PC_MEMBER_NUMBER,2) AS INTEGER) MEMBER_NUMBER,

CASE WHEN SUBSTR(SM.PC_MEMBER_NUMBER,1,1)=''C'' THEN ''CST'' ELSE ''MBR'' END MEMBER_TYPE,

CASE WHEN SUBSTR(SM.PC_CITYST,CHARACTERS(TRIM(SM.PC_CITYST))-1,2) in (''GA'',''MS'') THEN 

SUBSTR(SM.PC_CITYST,CHARACTERS(TRIM(SM.PC_CITYST))-1,2) ELSE NULL END SMLN_RSK_ST_CD,

COALESCE(SMLN_RSK_ST_CD,SVC5.STATE) RSK_ST_CD

FROM 

EVIEWMEMBDB_LGCY.SMLNPOLS SM

LEFT OUTER JOIN

 EVIEWANDB_LGCY.SERVICE_CENTER SVC5

ON SVC5.SVC_NUM=SM.SC_SERVICE_CENTER 

INNER JOIN (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)  ECTL ON 1=1

WHERE  ECTL.CAL_END_DATE BETWEEN SM.CHG_EFF_DT AND SM.CHG_EXP_DT

AND (CASE WHEN SUBSTR(SM.PC_MEMBER_NUMBER,1,1)=''C'' THEN ''CST'' ELSE ''MBR'' END)=''CST''

AND RSK_ST_CD IN (''AL'',''MS'',''GA'')

QUALIFY  RANK() OVER (PARTITION BY PC_MEMBER_NUMBER ORDER BY PC_EFF_DATE,PC_EXP_DATE,CHG_EFF_DT,CHG_EXP_DT)=1) B

SET RISK_ST_CD=B.RSK_ST_CD

WHERE     A.RISK_ST_CD IS NULL AND A.MEMBER_TYPE=''CST''

AND A.MEMBER_TYPE=B.MEMBER_TYPE AND A.MEMBER_NUMBER=B.MEMBER_NUMBER

AND A.MO_ID=:wf_MONTH_ID AND   A.SMLN>0;



-------Update Risk state using PORTPOLS & SERVICE_CENTER------

UPDATE A FROM ECOREANDB_LGCY.MEMB_CUST  A,

(SELECT DISTINCT CASt(SUBSTR(PT.PC_MEMBER_NUMBER,2) AS INTEGER) MEMBER_NUMBER,

CASE WHEN SUBSTR(PT.PC_MEMBER_NUMBER,1,1)=''C'' THEN ''CST'' ELSE ''MBR'' END MEMBER_TYPE,

CASE WHEN SUBSTR(PT.PC_CITYST,CHARACTERS(TRIM(PT.PC_CITYST))-1,2) in (''GA'',''MS'') THEN 

SUBSTR(PT.PC_CITYST,CHARACTERS(TRIM(PT.PC_CITYST))-1,2) ELSE NULL END PORT_RSK_ST_CD,

COALESCE(PORT_RSK_ST_CD,SVC6.STATE) RSK_ST_CD

FROM 

EVIEWMEMBDB_LGCY.PORTPOLS PT

LEFT OUTER JOIN

 EVIEWANDB_LGCY.SERVICE_CENTER SVC6

ON SVC6.SVC_NUM=PT.SC_SERVICE_CENTER 

INNER JOIN (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)  ECTL ON 1=1

WHERE  ECTL.CAL_END_DATE BETWEEN PT.CHG_EFF_DT AND PT.CHG_EXP_DT

AND (CASE WHEN SUBSTR(PT.PC_MEMBER_NUMBER,1,1)=''C'' THEN ''CST'' ELSE ''MBR'' END)=''CST''

AND RSK_ST_CD IN (''AL'',''MS'',''GA'')

QUALIFY  RANK() OVER (PARTITION BY PC_MEMBER_NUMBER ORDER BY PC_EFF_DATE,PC_EXP_DATE,CHG_EFF_DT,CHG_EXP_DT)=1) B

SET RISK_ST_CD=B.RSK_ST_CD

WHERE  A.RISK_ST_CD IS NULL AND A.MEMBER_TYPE=''CST''

AND A.MEMBER_TYPE=B.MEMBER_TYPE AND A.MEMBER_NUMBER=B.MEMBER_NUMBER

AND A.MO_ID=:wf_MONTH_ID AND   A.PORT>0;



-------Update Risk state using LIFE_POLICY_SUMM & AGENT_HIER------

UPDATE A FROM ECOREANDB_LGCY.MEMB_CUST  A,

(SELECT DISTINCT  LSP.MEMBER_NUMBER MEMBER_NUMBER,

LSP.MEMBER_TYPE MEMBER_TYPE,

COALESCE(LIFE_RSK_ST_CD,SVC7.SALES_ST_CD) RSK_ST_CD

FROM 

(SELECT DISTINCT CASE WHEN TRIM(INSURED_MEMBER_NUM)='''' THEN NULL

WHEN SUBSTR(TRIM(INSURED_MEMBER_NUM),1,1)=''C'' THEN CAST (SUBSTR(TRIM(INSURED_MEMBER_NUM),2) AS INTEGER) 

ELSE CAST(TRIM(INSURED_MEMBER_NUM) AS INTEGER) END   MEMBER_NUMBER,

CASE WHEN TRIM(INSURED_MEMBER_NUM)='''' THEN  NULL

WHEN SUBSTR(TRIM(INSURED_MEMBER_NUM),1,1)=''C'' THEN ''CST'' ELSE ''MBR'' END AS MEMBER_TYPE,

CASE WHEN INSURED_STATE_CD IN (''GA'',''MS'') THEN INSURED_STATE_CD ELSE NULL END LIFE_RSK_ST_CD,

CHG_EFF_DT,CHG_EXP_DT,SERV_CENTER_NUM

FROM ECOREANDB_LGCY.LIFE_POLICY_SUMM WHERE MO_ID=:wf_MONTH_ID

AND MEMBER_TYPE=''CSt''  

UNION 

SELECT DISTINCT CASE WHEN TRIM(PAYOR_MEMBER_NUM)='''' THEN NULL

WHEN SUBSTR(TRIM(PAYOR_MEMBER_NUM),1,1)=''C'' THEN CAST (SUBSTR(TRIM(PAYOR_MEMBER_NUM),2) AS INTEGER) 

ELSE CAST(TRIM(PAYOR_MEMBER_NUM) AS INTEGER) END   MEMBER_NUMBER,

CASE WHEN TRIM(PAYOR_MEMBER_NUM)='''' THEN  NULL

WHEN SUBSTR(TRIM(PAYOR_MEMBER_NUM),1,1)=''C'' THEN ''CST'' ELSE ''MBR'' END AS MEMBER_TYPE,

CASE WHEN INSURED_STATE_CD IN (''GA'',''MS'') THEN INSURED_STATE_CD ELSE NULL END LIFE_RSK_ST_CD,

CHG_EFF_DT,CHG_EXP_DT,SERV_CENTER_NUM

FROM ECOREANDB_LGCY.LIFE_POLICY_SUMM WHERE MO_ID=:wf_MONTH_ID

AND MEMBER_TYPE=''CSt'' 

QUALIFy RANK() OVER (PARTITION by MEMBER_NUMBER ,MEMBER_TYPE ORDER BY CHG_EFF_DT,CHG_EXP_DT)=1)  LSP

LEFT OUTER JOIN

EVIEWDB_LGCY.AGENT_HIER SVC7

ON CAST(SVC7.SALES_SVC_CD AS INTEGER)=CASt(LSP.SERV_CENTER_NUM AS INTEGER) 

INNER JOIN (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)  ECTL ON 1=1

WHERE  ECTL.CAL_END_DATE BETWEEN LSP.CHG_EFF_DT AND LSP.CHG_EXP_DT

AND LSP.MEMBER_TYPE=''CST''

AND RSK_ST_CD IN (''AL'',''MS'',''GA'')  AND SVC7.SALES_SVC_CD NOT IN (''AL99999'',''GA99999'',''MS99999'') AND  ECTL.CAL_END_DATE Between SVC7.AGNT_EFF_DT and SVC7.AGNT_EXPIRY_DT

QUALIFY  ROW_NUMBER() OVER (PARTITION BY LSP.MEMBER_NUMBER,LSP.MEMBER_TYPE ORDER BY CHG_EFF_DT,CHG_EXP_DT)=1) B

SET RISK_ST_CD=B.RSK_ST_CD

WHERE    A.RISK_ST_CD IS NULL AND A.MEMBER_TYPE=''CST''

AND A.MEMBER_TYPE=B.MEMBER_TYPE AND A.MEMBER_NUMBER=B.MEMBER_NUMBER

AND A.MO_ID=:wf_MONTH_ID AND   A.LIFE>0 ;



-------Update Risk state using LIFE_POLICY_SUMM & SERVICE_CENTER------

UPDATE A FROM ECOREANDB_LGCY.MEMB_CUST  A,

(SELECT DISTINCT  LSP.MEMBER_NUMBER MEMBER_NUMBER,

LSP.MEMBER_TYPE MEMBER_TYPE,

COALESCE(LIFE_RSK_ST_CD,SVC7.STATE) RSK_ST_CD

FROM 

(SELECT DISTINCT CASE WHEN TRIM(INSURED_MEMBER_NUM)='''' THEN NULL

WHEN SUBSTR(TRIM(INSURED_MEMBER_NUM),1,1)=''C'' THEN CAST (SUBSTR(TRIM(INSURED_MEMBER_NUM),2) AS INTEGER) 

ELSE CAST(TRIM(INSURED_MEMBER_NUM) AS INTEGER) END   MEMBER_NUMBER,

CASE WHEN TRIM(INSURED_MEMBER_NUM)='''' THEN  NULL

WHEN SUBSTR(TRIM(INSURED_MEMBER_NUM),1,1)=''C'' THEN ''CST'' ELSE ''MBR'' END AS MEMBER_TYPE,

CASE WHEN INSURED_STATE_CD IN (''GA'',''MS'') THEN INSURED_STATE_CD ELSE NULL END LIFE_RSK_ST_CD,

CHG_EFF_DT,CHG_EXP_DT,SERV_CENTER_NUM

FROM ECOREANDB_LGCY.LIFE_POLICY_SUMM WHERE MO_ID=:wf_MONTH_ID

AND MEMBER_TYPE=''CSt''  

UNION 

SELECT DISTINCT CASE WHEN TRIM(PAYOR_MEMBER_NUM)='''' THEN NULL

WHEN SUBSTR(TRIM(PAYOR_MEMBER_NUM),1,1)=''C'' THEN CAST (SUBSTR(TRIM(PAYOR_MEMBER_NUM),2) AS INTEGER) 

ELSE CAST(TRIM(PAYOR_MEMBER_NUM) AS INTEGER) END   MEMBER_NUMBER,

CASE WHEN TRIM(PAYOR_MEMBER_NUM)='''' THEN  NULL

WHEN SUBSTR(TRIM(PAYOR_MEMBER_NUM),1,1)=''C'' THEN ''CST'' ELSE ''MBR'' END AS MEMBER_TYPE,

CASE WHEN INSURED_STATE_CD IN (''GA'',''MS'') THEN INSURED_STATE_CD ELSE NULL END LIFE_RSK_ST_CD,

CHG_EFF_DT,CHG_EXP_DT,SERV_CENTER_NUM

FROM ECOREANDB_LGCY.LIFE_POLICY_SUMM WHERE MO_ID=:wf_MONTH_ID

AND MEMBER_TYPE=''CSt'' 

QUALIFy RANK() OVER (PARTITION by MEMBER_NUMBER ,MEMBER_TYPE ORDER BY CHG_EFF_DT,CHG_EXP_DT)=1)  LSP

LEFT OUTER JOIN

 EVIEWANDB_LGCY.SERVICE_CENTER SVC7

ON SVC7.SVC_NUM=CASt(LSP.SERV_CENTER_NUM AS INTEGER) 

INNER JOIN (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)  ECTL ON 1=1

WHERE  ECTL.CAL_END_DATE BETWEEN LSP.CHG_EFF_DT AND LSP.CHG_EXP_DT

AND LSP.MEMBER_TYPE=''CST''

AND RSK_ST_CD IN (''AL'',''MS'',''GA'') 

QUALIFY  ROW_NUMBER() OVER (PARTITION BY LSP.MEMBER_NUMBER,LSP.MEMBER_TYPE ORDER BY CHG_EFF_DT,CHG_EXP_DT)=1) B

SET RISK_ST_CD=B.RSK_ST_CD

WHERE   A.RISK_ST_CD IS NULL AND A.MEMBER_TYPE=''CST''

AND A.MEMBER_TYPE=B.MEMBER_TYPE AND A.MEMBER_NUMBER=B.MEMBER_NUMBER

AND A.MO_ID=:wf_MONTH_ID AND   A.LIFE>0;



-------Update Risk state using ING_POL_LIST(INSURED_MEMB_NUM) & SERVICE_CENTER------

UPDATE A FROM ECOREANDB_LGCY.MEMB_CUST  A,

(SELECT DISTINCT LP.MEMBER_NUMBER,

LP.MEMBER_TYPE,

CASE WHEN INSURED_STATE_CD in (''GA'',''MS'') THEN 

INSURED_STATE_CD ELSE NULL END LIFE_RSK_ST_CD,

COALESCE(LIFE_RSK_ST_CD,SVC8.STATE) RSK_ST_CD,

CAST(SERV_CENTER_NUM AS INTEGER) SVC_NUM

FROM 

(SELECT A.INSURED_MEMBER INSURED_MEMBER,A.MEMBER_NUMBER MEMBER_NUMBER,A.MEMBER_TYPE MEMBER_TYPE,

CASE WHEN B.INSURED_MEMBER IS NULL THEN NULL ELSE A.INSURED_STATE_CD END INSURED_STATE_CD,

A.SERV_CENTER_NUM SERV_CENTER_NUM,CHG_EFF_DT,CHG_EXP_DT

FROM

(SELECT SUBSTR(INSURED_MEMBER_NUM,1,1)||

(CASE WHEN (SUBSTR(INSURED_MEMBER_NUM,2,1) = ''O'' OR SUBSTR(INSURED_MEMBER_NUM,2,1) = ''C'') THEN ''0'' ELSE SUBSTR(INSURED_MEMBER_NUM,2,1) END)||

(CASE WHEN (SUBSTR(INSURED_MEMBER_NUM,3,1) = ''O'' OR SUBSTR(INSURED_MEMBER_NUM,3,1) = ''C'') THEN ''0'' ELSE SUBSTR(INSURED_MEMBER_NUM,3,1) END)||

(CASE WHEN (SUBSTR(INSURED_MEMBER_NUM,4,1) = ''O'' OR SUBSTR(INSURED_MEMBER_NUM,4,1) = ''C'') THEN ''0'' ELSE SUBSTR(INSURED_MEMBER_NUM,4,1) END)||

(CASE WHEN (SUBSTR(INSURED_MEMBER_NUM,5,1) = ''O'' OR SUBSTR(INSURED_MEMBER_NUM,5,1) = ''C'') THEN ''0'' ELSE SUBSTR(INSURED_MEMBER_NUM,5,1) END)||

(CASE WHEN (SUBSTR(INSURED_MEMBER_NUM,6,1) = ''O'' OR SUBSTR(INSURED_MEMBER_NUM,6,1) = ''C'') THEN ''0'' ELSE SUBSTR(INSURED_MEMBER_NUM,6,1) END)||

(CASE WHEN (SUBSTR(INSURED_MEMBER_NUM,7,1) = ''O'' OR SUBSTR(INSURED_MEMBER_NUM,7,1) = ''C'') THEN ''0'' ELSE SUBSTR(INSURED_MEMBER_NUM,7,1) END)||

(CASE WHEN (SUBSTR(INSURED_MEMBER_NUM,8,1) = ''O'' OR SUBSTR(INSURED_MEMBER_NUM,8,1) = ''C'') THEN ''0'' ELSE SUBSTR(INSURED_MEMBER_NUM,8,1) END) INSURED_MEMBER,

CASt(SUBSTR(INSURED_MEMBER,2) AS INTEGER) MEMBER_NUMBER,

CASE WHEN SUBSTR(INSURED_MEMBER,1,1)=''C'' THEN ''CST'' ELSE ''MBR'' END MEMBER_TYPE,

INSURED_STATE_CD,SERV_CENTER_NUM,CHG_EFF_DT,CHG_EXP_DT

FROM EVIEWMEMBDB_LGCY.ING_POL_LIST

INNER JOIN (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)  ECTL ON 1=1

WHERE POL_STATUS IN (''1'',''2'',''3'',''4'')  

AND  ECTL.CAL_END_DATE BETWEEN CHG_EFF_DT AND CHG_EXP_DT) A

LEFT OUTER JOIN

(SELECT SUBSTR(INSURED_MEMBER_NUM,1,1)||

(CASE WHEN (SUBSTR(INSURED_MEMBER_NUM,2,1) = ''O'' OR SUBSTR(INSURED_MEMBER_NUM,2,1) = ''C'') THEN ''0'' ELSE SUBSTR(INSURED_MEMBER_NUM,2,1) END)||

(CASE WHEN (SUBSTR(INSURED_MEMBER_NUM,3,1) = ''O'' OR SUBSTR(INSURED_MEMBER_NUM,3,1) = ''C'') THEN ''0'' ELSE SUBSTR(INSURED_MEMBER_NUM,3,1) END)||

(CASE WHEN (SUBSTR(INSURED_MEMBER_NUM,4,1) = ''O'' OR SUBSTR(INSURED_MEMBER_NUM,4,1) = ''C'') THEN ''0'' ELSE SUBSTR(INSURED_MEMBER_NUM,4,1) END)||

(CASE WHEN (SUBSTR(INSURED_MEMBER_NUM,5,1) = ''O'' OR SUBSTR(INSURED_MEMBER_NUM,5,1) = ''C'') THEN ''0'' ELSE SUBSTR(INSURED_MEMBER_NUM,5,1) END)||

(CASE WHEN (SUBSTR(INSURED_MEMBER_NUM,6,1) = ''O'' OR SUBSTR(INSURED_MEMBER_NUM,6,1) = ''C'') THEN ''0'' ELSE SUBSTR(INSURED_MEMBER_NUM,6,1) END)||

(CASE WHEN (SUBSTR(INSURED_MEMBER_NUM,7,1) = ''O'' OR SUBSTR(INSURED_MEMBER_NUM,7,1) = ''C'') THEN ''0'' ELSE SUBSTR(INSURED_MEMBER_NUM,7,1) END)||

(CASE WHEN (SUBSTR(INSURED_MEMBER_NUM,8,1) = ''O'' OR SUBSTR(INSURED_MEMBER_NUM,8,1) = ''C'') THEN ''0'' ELSE SUBSTR(INSURED_MEMBER_NUM,8,1) END) INSURED_MEMBER,

COUNT(DISTINCT INSURED_STATE_CD) CNT

FROM EVIEWMEMBDB_LGCY.ING_POL_LIST 

INNER JOIN (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)  ECTL ON 1=1

WHERE POL_STATUS IN (''1'',''2'',''3'',''4'') 

AND  ECTL.CAL_END_DATE BETWEEN CHG_EFF_DT AND CHG_EXP_DT

GROUP BY 1 HAVING CNT=1) B

ON A.INSURED_MEMBER=B.INSURED_MEMBER

GROUP BY 1,2,3,4,5,6,7) LP

INNER JOIN 

(SELECT * FROM ECOREANDB_LGCY.MEMB_CUST  WHERE RISK_ST_CD IS NULL AND LIFE>0) B

ON B.MEMBER_NUMBER=LP.MEMBER_NUMBER AND B.MEMBER_TYPE=LP.MEMBER_TYPE

LEFT OUTER JOIN

 EVIEWANDB_LGCY.SERVICE_CENTER SVC8

ON SVC8.SVC_NUM=CAST(SERV_CENTER_NUM AS INTEGER) 

INNER JOIN (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)  ECTL ON 1=1

WHERE   ECTL.CAL_END_DATE  BETWEEN LP.CHG_EFF_DT AND LP.CHG_EXP_DT

AND (CASE WHEN SUBSTR(LP.INSURED_MEMBER,1,1)=''C'' THEN ''CST'' ELSE ''MBR'' END)=''CST''

AND RSK_ST_CD IN (''AL'',''MS'',''GA'')

GROUP BY 1,2,3,4,5,INSURED_MEMBER,CHG_EFF_DT,CHG_EXP_DT

QUALIFY  ROW_NUMBER() OVER (PARTITION BY LP.MEMBER_NUMBER,LP.MEMBER_TYPE ORDER BY CHG_EFF_DT,CHG_EXP_DT)=1

) B

SET RISK_ST_CD=B.RSK_ST_CD

WHERE    A.RISK_ST_CD IS NULL AND A.MEMBER_TYPE=''CST''

AND A.MEMBER_TYPE=B.MEMBER_TYPE AND A.MEMBER_NUMBER=B.MEMBER_NUMBER

AND A.MO_ID=:wf_MONTH_ID AND   A.LIFE>0;



-------Update Risk state using LIFEPOLS & SERVICE_CENTER------

UPDATE A FROM ECOREANDB_LGCY.MEMB_CUST  A,

(SELECT DISTINCT CASt(SUBSTR(LIF.INSURED_MEMBER,2) AS INTEGER) MEMBER_NUMBER,

CASE WHEN SUBSTR(LIF.INSURED_MEMBER,1,1)=''C'' THEN ''CST'' ELSE ''MBR'' END MEMBER_TYPE,

SC_SERVICE_CENTER,

SVC9.STATE  RSK_ST_CD

FROM 

(SELECT 

SUBSTR(LF_MEMBERSHIP,1,1)||

(CASE WHEN (SUBSTR(LF_MEMBERSHIP,2,1) = ''O'' OR SUBSTR(LF_MEMBERSHIP,2,1) = ''C'') THEN ''0'' ELSE SUBSTR(LF_MEMBERSHIP,2,1) END)||

(CASE WHEN (SUBSTR(LF_MEMBERSHIP,3,1) = ''O'' OR SUBSTR(LF_MEMBERSHIP,3,1) = ''C'') THEN ''0'' ELSE SUBSTR(LF_MEMBERSHIP,3,1) END)||

(CASE WHEN (SUBSTR(LF_MEMBERSHIP,4,1) = ''O'' OR SUBSTR(LF_MEMBERSHIP,4,1) = ''C'') THEN ''0'' ELSE SUBSTR(LF_MEMBERSHIP,4,1) END)||

(CASE WHEN (SUBSTR(LF_MEMBERSHIP,5,1) = ''O'' OR SUBSTR(LF_MEMBERSHIP,5,1) = ''C'') THEN ''0'' ELSE SUBSTR(LF_MEMBERSHIP,5,1) END)||

(CASE WHEN (SUBSTR(LF_MEMBERSHIP,6,1) = ''O'' OR SUBSTR(LF_MEMBERSHIP,6,1) = ''C'') THEN ''0'' ELSE SUBSTR(LF_MEMBERSHIP,6,1) END)||

(CASE WHEN (SUBSTR(LF_MEMBERSHIP,7,1) = ''O'' OR SUBSTR(LF_MEMBERSHIP,7,1) = ''C'') THEN ''0'' ELSE SUBSTR(LF_MEMBERSHIP,7,1) END)||

(CASE WHEN (SUBSTR(LF_MEMBERSHIP,8,1) = ''O'' OR SUBSTR(LF_MEMBERSHIP,8,1) = ''C'') THEN ''0'' ELSE SUBSTR(LF_MEMBERSHIP,8,1) END) INSURED_MEMBER,

SC_SERVICE_CENTER,

CHG_EFF_DT,CHG_EXP_DT

FROM 

EVIEWMEMBDB_LGCY.LIFEPOLS 

INNER JOIN (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)  ECTL ON 1=1

WHERE LF_STATUS IN (''12'',''21'',''22'',''31'',''32'',''41'',''42'',''43'',''44'',''45'')

AND ECTL.CAL_END_DATE BETWEEN CHG_EFF_DT AND CHG_EXP_DT GROUP By 1,2,3,4) LIF

LEFT OUTER JOIN

 EVIEWANDB_LGCY.SERVICE_CENTER SVC9

ON SVC9.SVC_NUM=LIF.SC_SERVICE_CENTER 

INNER JOIN (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)  ECTL ON 1=1

WHERE ECTL.CAL_END_DATE BETWEEN LIF.CHG_EFF_DT AND LIF.CHG_EXP_DT

AND (CASE WHEN SUBSTR(LIF.INSURED_MEMBER,1,1)=''C'' THEN ''CST'' ELSE ''MBR'' END)=''CST''

AND RSK_ST_CD IN (''AL'',''MS'',''GA'')

QUALIFY  ROW_NUMBER() OVER (PARTITION BY INSURED_MEMBER ORDER BY CHG_EFF_DT,CHG_EXP_DT)=1) B

SET RISK_ST_CD=B.RSK_ST_CD

WHERE   A.RISK_ST_CD IS NULL AND A.MEMBER_TYPE=''CST''

AND A.MEMBER_TYPE=B.MEMBER_TYPE AND A.MEMBER_NUMBER=B.MEMBER_NUMBER

AND A.MO_ID=:wf_MONTH_ID AND   A.LIFE>0;



-------Update Risk state usingING_POL_LIST(PAYOR_MEMB_NUM) & SERVICE_CENTER------

UPDATE A FROM ECOREANDB_LGCY.MEMB_CUST  A,

(SELECT DISTINCT LP.MEMBER_NUMBER,

LP.MEMBER_TYPE,

CASE WHEN INSURED_STATE_CD in (''GA'',''MS'') THEN 

INSURED_STATE_CD ELSE NULL END LIFE_RSK_ST_CD,

COALESCE(LIFE_RSK_ST_CD,SVC10.STATE) RSK_ST_CD,

CAST(SERV_CENTER_NUM AS INTEGER) SVC_NUM

FROM 

(SELECT A.INSURED_MEMBER INSURED_MEMBER,A.MEMBER_NUMBER MEMBER_NUMBER,A.MEMBER_TYPE MEMBER_TYPE,

CASE WHEN B.INSURED_MEMBER IS NULL THEN NULL ELSE A.INSURED_STATE_CD END INSURED_STATE_CD,

A.SERV_CENTER_NUM SERV_CENTER_NUM,CHG_EFF_DT,CHG_EXP_DT

FROM

(SELECT SUBSTR(PAYOR_MEMBER_NUM,1,1)||

(CASE WHEN (SUBSTR(PAYOR_MEMBER_NUM,2,1) = ''O'' OR SUBSTR(PAYOR_MEMBER_NUM,2,1) = ''C'') THEN ''0'' ELSE SUBSTR(PAYOR_MEMBER_NUM,2,1) END)||

(CASE WHEN (SUBSTR(PAYOR_MEMBER_NUM,3,1) = ''O'' OR SUBSTR(PAYOR_MEMBER_NUM,3,1) = ''C'') THEN ''0'' ELSE SUBSTR(PAYOR_MEMBER_NUM,3,1) END)||

(CASE WHEN (SUBSTR(PAYOR_MEMBER_NUM,4,1) = ''O'' OR SUBSTR(PAYOR_MEMBER_NUM,4,1) = ''C'') THEN ''0'' ELSE SUBSTR(PAYOR_MEMBER_NUM,4,1) END)||

(CASE WHEN (SUBSTR(PAYOR_MEMBER_NUM,5,1) = ''O'' OR SUBSTR(PAYOR_MEMBER_NUM,5,1) = ''C'') THEN ''0'' ELSE SUBSTR(PAYOR_MEMBER_NUM,5,1) END)||

(CASE WHEN (SUBSTR(PAYOR_MEMBER_NUM,6,1) = ''O'' OR SUBSTR(PAYOR_MEMBER_NUM,6,1) = ''C'') THEN ''0'' ELSE SUBSTR(PAYOR_MEMBER_NUM,6,1) END)||

(CASE WHEN (SUBSTR(PAYOR_MEMBER_NUM,7,1) = ''O'' OR SUBSTR(PAYOR_MEMBER_NUM,7,1) = ''C'') THEN ''0'' ELSE SUBSTR(PAYOR_MEMBER_NUM,7,1) END)||

(CASE WHEN (SUBSTR(PAYOR_MEMBER_NUM,8,1) = ''O'' OR SUBSTR(PAYOR_MEMBER_NUM,8,1) = ''C'') THEN ''0'' ELSE SUBSTR(PAYOR_MEMBER_NUM,8,1) END) INSURED_MEMBER,

CASt(SUBSTR(INSURED_MEMBER,2) AS INTEGER) MEMBER_NUMBER,

CASE WHEN SUBSTR(INSURED_MEMBER,1,1)=''C'' THEN ''CST'' ELSE ''MBR'' END MEMBER_TYPE,

INSURED_STATE_CD,SERV_CENTER_NUM,CHG_EFF_DT,CHG_EXP_DT

FROM EVIEWMEMBDB_LGCY.ING_POL_LIST

INNER JOIN (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)  ECTL ON 1=1

WHERE POL_STATUS IN (''1'',''2'',''3'',''4'')  

AND ECTL.CAL_END_DATE BETWEEN CHG_EFF_DT AND CHG_EXP_DT) A

LEFT OUTER JOIN

(SELECT SUBSTR(PAYOR_MEMBER_NUM,1,1)||

(CASE WHEN (SUBSTR(PAYOR_MEMBER_NUM,2,1) = ''O'' OR SUBSTR(PAYOR_MEMBER_NUM,2,1) = ''C'') THEN ''0'' ELSE SUBSTR(PAYOR_MEMBER_NUM,2,1) END)||

(CASE WHEN (SUBSTR(PAYOR_MEMBER_NUM,3,1) = ''O'' OR SUBSTR(PAYOR_MEMBER_NUM,3,1) = ''C'') THEN ''0'' ELSE SUBSTR(PAYOR_MEMBER_NUM,3,1) END)||

(CASE WHEN (SUBSTR(PAYOR_MEMBER_NUM,4,1) = ''O'' OR SUBSTR(PAYOR_MEMBER_NUM,4,1) = ''C'') THEN ''0'' ELSE SUBSTR(PAYOR_MEMBER_NUM,4,1) END)||

(CASE WHEN (SUBSTR(PAYOR_MEMBER_NUM,5,1) = ''O'' OR SUBSTR(PAYOR_MEMBER_NUM,5,1) = ''C'') THEN ''0'' ELSE SUBSTR(PAYOR_MEMBER_NUM,5,1) END)||

(CASE WHEN (SUBSTR(PAYOR_MEMBER_NUM,6,1) = ''O'' OR SUBSTR(PAYOR_MEMBER_NUM,6,1) = ''C'') THEN ''0'' ELSE SUBSTR(PAYOR_MEMBER_NUM,6,1) END)||

(CASE WHEN (SUBSTR(PAYOR_MEMBER_NUM,7,1) = ''O'' OR SUBSTR(PAYOR_MEMBER_NUM,7,1) = ''C'') THEN ''0'' ELSE SUBSTR(PAYOR_MEMBER_NUM,7,1) END)||

(CASE WHEN (SUBSTR(PAYOR_MEMBER_NUM,8,1) = ''O'' OR SUBSTR(PAYOR_MEMBER_NUM,8,1) = ''C'') THEN ''0'' ELSE SUBSTR(PAYOR_MEMBER_NUM,8,1) END) INSURED_MEMBER,

COUNT(DISTINCT INSURED_STATE_CD) CNT

FROM EVIEWMEMBDB_LGCY.ING_POL_LIST 

INNER JOIN (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)  ECTL ON 1=1

WHERE POL_STATUS IN (''1'',''2'',''3'',''4'') 

AND ECTL.CAL_END_DATE BETWEEN CHG_EFF_DT AND CHG_EXP_DT

GROUP BY 1 HAVING CNT=1) B

ON A.INSURED_MEMBER=B.INSURED_MEMBER

GROUP BY 1,2,3,4,5,6,7) LP

INNER JOIN 

(SELECT * FROM ECOREANDB_LGCY.MEMB_CUST  WHERE RISK_ST_CD IS NULL AND LIFE>0) B

ON B.MEMBER_NUMBER=LP.MEMBER_NUMBER AND B.MEMBER_TYPE=LP.MEMBER_TYPE

LEFT OUTER JOIN

 EVIEWANDB_LGCY.SERVICE_CENTER SVC10

ON SVC10.SVC_NUM=CAST(SERV_CENTER_NUM AS INTEGER) 

INNER JOIN (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)  ECTL ON 1=1

WHERE   ECTL.CAL_END_DATE BETWEEN LP.CHG_EFF_DT AND LP.CHG_EXP_DT

AND (CASE WHEN SUBSTR(LP.INSURED_MEMBER,1,1)=''C'' THEN ''CST'' ELSE ''MBR'' END)=''CST''

AND RSK_ST_CD IN (''AL'',''MS'',''GA'')

GROUP BY 1,2,3,4,5, /*6,*/INSURED_MEMBER,CHG_EFF_DT,CHG_EXP_DT

QUALIFY  ROW_NUMBER() OVER (PARTITION BY LP.MEMBER_NUMBER,LP.MEMBER_TYPE ORDER BY CHG_EFF_DT,CHG_EXP_DT)=1

) B

SET RISK_ST_CD=B.RSK_ST_CD

WHERE A.RISK_ST_CD IS NULL AND A.MEMBER_TYPE=''CST''

AND A.MEMBER_TYPE=B.MEMBER_TYPE AND A.MEMBER_NUMBER=B.MEMBER_NUMBER

AND A.MO_ID=:wf_MONTH_ID AND   A.LIFE>0;



-------Update Risk state using HOMEPOLS & SERVICE_CENTER------

UPDATE A FROM ECOREANDB_LGCY.MEMB_CUST  A,

(SELECT DISTINCT CASt(SUBSTR(HP.PC_MEMBER_NUMBER,2) AS INTEGER) MEMBER_NUMBER,

CASE WHEN SUBSTR(HP.PC_MEMBER_NUMBER,1,1)=''C'' THEN ''CST'' ELSE ''MBR'' END MEMBER_TYPE,

CASE WHEN SUBSTR(HP.PC_CITYST,CHARACTERS(TRIM(HP.PC_CITYST))-1,2) in (''GA'',''MS'') THEN 

SUBSTR(HP.PC_CITYST,CHARACTERS(TRIM(HP.PC_CITYST))-1,2) ELSE NULL END H_STATE_CD,

COALESCE(H_STATE_CD,SVC11.STATE) RSK_ST_CD

FROM 

EVIEWMEMBDB_LGCY.HOMEPOLS HP

LEFT OUTER JOIN

 EVIEWANDB_LGCY.SERVICE_CENTER SVC11

ON SVC11.SVC_NUM=HP.SC_SERVICE_CENTER 

INNER JOIN (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)  ECTL ON 1=1

WHERE   ECTL.CAL_END_DATE BETWEEN HP.CHG_EFF_DT AND HP.CHG_EXP_DT

AND (CASE WHEN SUBSTR(HP.PC_MEMBER_NUMBER,1,1)=''C'' THEN ''CST'' ELSE ''MBR'' END)=''CST''

AND RSK_ST_CD IN (''AL'',''MS'',''GA'')

QUALIFY  RANK() OVER (PARTITION BY PC_MEMBER_NUMBER ORDER BY PC_EFF_DATE,PC_EXP_DATE,CHG_EFF_DT,CHG_EXP_DT)=1) B

SET RISK_ST_CD=B.RSK_ST_CD

WHERE  A.RISK_ST_CD IS NULL AND A.MEMBER_TYPE=''CST''

AND A.MEMBER_TYPE=B.MEMBER_TYPE AND A.MEMBER_NUMBER=B.MEMBER_NUMBER

AND A.MO_ID=:wf_MONTH_ID AND   A.HOME>0;



-------Update Risk state using CLIENT & SERVICE_CENTER- for EX_POLS & EXCD-----

/*UPDATE A FROM ECOREANDB_LGCY.MEMB_CUST  A,

(SELECT MEMBER_NUMBER,MEMBER_TYPE,RSK_ST_CD  FROM 

(

SELECT CAST((CASE WHEN CL.ALFA_CUST_MEMB_NBR='''' THEN CL1.ALFA_CUST_MEMB_NBR ELSE CL.ALFA_CUST_MEMB_NBR END) AS INTEGER) MEMBER_NUMBER,

CASE WHEN CL.ALFA_CUST_MEMB_TYPE='''' THEN CL1.ALFA_CUST_MEMB_TYPE ELSE CL.ALFA_CUST_MEMB_TYPE END MEMBER_TYPE,

CL.ALFA_CUST_MEMB_NBR ALFA_CUST_MEMB_NBR,CL.ALFA_CUST_MEMB_TYPE ALFA_CUST_MEMB_type,

CL1.ALFA_CUST_MEMB_NBR ALFA_CUST_MEMB_NBR1 ,CL1.ALFA_CUST_MEMB_TYPE ALFA_CUST_MEMB_TYPE1,

CL.CLIENT_ID CLIENT_ID,CL.DW_CLIENT_SKEy DW_CLIENT_SKEy,

COALESCE(CASE WHEN P.RSK_ST_CD in (''GA'',''MS'') THEN P.RSK_ST_CD ELSE NULL END,SVC12.STATE) RSK_ST_CD,PLCY_SVC_NBR 

FROM EVIEWDB_LGCY.CLIENT CL

LEFT OUTER JOIN CLIENT_NUMBERS CL1

ON Cl.CLIENT_ID=CL1.CLIENT_ID AND Cl.DW_CLIENT_SKEy=CL1.DW_CLIENT_SKEY

LEFT OUTER JOIN

EVIEWDB_LGCY.POLICY P

ON P.DW_CLIENT_SKEY=CL.DW_CLIENT_SKEY

AND P.DAILY_FEED_IND = CL.DAILY_FEED_IND

AND COALESCE(P.UNDER_TRANSITION_IND,''Z'') = COALESCE(CL.UNDER_TRANSITION_IND,''Z'')

LEFT OUTER JOIN 

 EVIEWANDB_LGCY.SERVICE_CENTER SVC12

ON SVC12.SVC_NUM=CAST(P.PLCY_SVC_NBR AS INTEGER) 

INNER JOIN (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)  ECTL ON 1=1

WHERE 

PLCY_OGN_EFF_DT <=CAST(ECTL.CAL_END_DATE AS DATE)  

AND     PLCY_PLN_EXP_DT >= CAST(ECTL.CAL_END_DATE AS DATE) 

AND     CAST(ISSUE_ACT_TS AS DATE) <= ECTL.CAL_TO_DATE

AND PLCY_CHG_EFF_DT <= CAST(ECTL.CAL_END_DATE AS DATE)

AND LOB_CD = ''APV''  and MEMBER_TYPE=''CST'' 

AND RNL_STATUS_CD <> ''9'' and not (RNL_status_cd in (''6'',''8'') and PLCY_PLN_EXP_DT <=ECTL.CAL_END_DATE)

AND CL.CLIENT_CHG_EFF_DT <=  CAST(ECTL.CAL_END_DATE AS DATE) 

QUALIFY RANK() OVER (PARTITION BY MEMBER_NUMBER,MEMBER_TYPE

ORDER BY  PLCY_OGN_IPT_DT,PLCY_OGN_EFF_DT,PLCY_PLN_EXP_DT,PLCY_CHG_EFF_Dt,PLCY_CHG_EXP_DT,ISSUE_ACT_TS)=1

GROUP BY 1,2,3,4,5,6,7,8,9,10 ,PLCY_OGN_IPT_DT,PLCY_OGN_EFF_DT,PLCY_PLN_EXP_DT,PLCY_CHG_EFF_Dt,PLCY_CHG_EXP_DT,ISSUE_ACT_TS) A GROUP BY 1,2,3 ) B

SET RISK_ST_CD=B.RSK_ST_CD

WHERE     A.RISK_ST_CD IS NULL AND A.MEMBER_TYPE=''CST''

AND A.MEMBER_TYPE=B.MEMBER_TYPE AND A.MEMBER_NUMBER=B.MEMBER_NUMBER

AND A.MO_ID=:wf_MONTH_ID AND   (A.auto>0 OR A.veh>0);*/



----------------UPDATING new MBR records with Risk St Cd=''AL''--------

UPDATE ECOREANDB_LGCY.MEMB_CUST 

SET RISK_ST_CD=''AL'' WHERE MEMBER_TYPE=''MBR'' AND MO_ID=:wf_MONTH_ID;



-------Updating details from GW EDW tables for records missing information in Legacy tables /inactive member in federation

UPDATE MEMB FROM ECOREANDB_LGCY.MEMB_CUST  MEMB,

(SELECT MBRSHP_NUM,

MBRSHP_TYPE_CD,

INCEPTION_DT ,

POLICY_EFF_DT,

POLICY_EXP_DT,

NAME1,

NAME2,

ZIP,

ADDR1,

ADDR2,

CITY,	

ST_CD,

ST_DESC,

RSKST,

PHONE_NBR,

EML,

COUNTY_CD,

COUNTY_DESC  FROM (SELECT

CAST(MBRSHP_NUM AS INTEGER) MBRSHP_NUM,

CASE WHEN (MBRSHP_TYPE_CD LIKE ''%MBR%'') THEN ''MBR'' ELSE ''CST'' END MBRSHP_TYPE_CD,

A.AGMT_OPN_DTTM INCEPTION_DT ,

A.TRANS_STRT_DTTM POLICY_EFF_DT,

A.TRANS_END_DTTM POLICY_EXP_DT,

NAME1 AS NAME1,

NAME2 AS NAME2,

P.ZIP AS ZIP,

P.ADDR1 AS ADDR1,

P.ADDR2 AS ADDR2,

P.CITY  AS CITY,	

P.ST_CD AS ST_CD,

P.ST_DESC AS ST_DESC,

COALESCE(RSKST, ST_CD) RSKST,

P.HOME_NUM AS PHONE_NBR,

P.EML AS EML,

SUBSTR(SRC_IDNTFTN_VAL,4,30) AS COUNTY_CD,

COUNTY_DESC COUNTY_DESC ,

AGMT_EFF_DTTM

FROM 

(SELECT DISTINCT A.HOST_AGMT_NUM PLCY_NUM ,D.INSRNC_LOB_TYPE_CD,AGMT_STS_CD,

CASE WHEN A.MODL_EFF_DTTM > A.MODL_CRTN_DTTM THEN A.MODL_EFF_DTTM 

ELSE A.MODL_CRTN_DTTM END AS NEW_AGMT_EFF_DTTM,A.AGMT_ID , A.AGMT_OPN_DTTM,A.TRANS_STRT_DTTM, A.TRANS_END_DTTM,MBRSHP_TYPE_CD,MBRSHP_NUM,

A.AGMT_PLND_EXPN_DTTM,A.AGMT_EFF_DTTM

FROM  EVIEWDB_EDW.AGMT AS A JOIN (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)ECTL ON 1=1

JOIN  EVIEWDB_EDW.AGMT TRM 

ON TRM.HOST_AGMT_NUM=A.HOST_AGMT_NUM AND TRM.TERM_NUM=A.TERM_NUM 

AND    TRM.AGMT_TYPE_CD=''POLTRM''   AND CAST(CAST(CAL_END_DATE AS DATE)+1 AS TIMESTAMPNTZ) - INTERVAL ''1 microsecond'' 

BETWEEN TRM.AGMT_EFF_DTTM AND TRM.AGMT_PLND_EXPN_DTTM 

JOIN EVIEWDB_EDW.AGMT_STS  AS AS1  ON  TRM.AGMT_ID=AS1.AGMT_ID AND AS1.AGMT_STS_STRT_DTTM <= CAST(CAST(CAL_END_DATE AS DATE)+1 AS TIMESTAMPNTZ) - INTERVAL ''1 microsecond'' 

AND NEW_AGMT_EFF_DTTM < CAST(CAST(CAL_END_DATE AS DATE)+1 AS TIMESTAMPNTZ) - INTERVAL ''1 microsecond''

AND A.AGMT_TYPE_CD = ''PPV'' AND AGMT_STS_CD <> ''CNFRMDDT'' 

LEFT JOIN EVIEWDB_EDW.AGMT_PROD AP ON A.AGMT_ID=AP.AGMT_ID

LEFT JOIN EVIEWDB_EDW.AGMT_MBRSHP  AS AM ON A.AGMT_ID=AM.AGMT_ID

LEFT JOIN EVIEWDB_EDW.MBRSHP   AS M ON M.MBRSHP_ID=AM.MBRSHP_ID

JOIN EVIEWDB_EDW.PROD P ON AP.PROD_ID=P.PROD_ID

JOIN EVIEWDB_EDW.INSRNC_LOB_TYPE D ON D.INSRNC_LOB_TYPE_CD=P.INSRNC_LOB_TYPE_CD

QUALIFY ROW_NUMBER() OVER(PARTITION BY A.HOST_AGMT_NUM ORDER BY  A.MODL_CRTN_DTTM DESC,A.MODL_EFF_DTTM DESC, AS1.AGMT_STS_STRT_DTTM DESC) = 1 AND AGMT_STS_CD = ''INFORCE''

) AS A

LEFT OUTER JOIN 

(

SELECT AGMT_ID, MAX(NIN_PRTY_ID) NIN_PRTY_ID, MAX(NIN1_PRTY_ID) NIN1_PRTY_ID,

MAX(UPPER(TRIM(COALESCE(TRIM(INM.GVN_NAME),''''))||'' ''||COALESCE(TRIM(INM.FMLY_NAME),'''')) )AS NAME1,

MAX(UPPER(TRIM(COALESCE(TRIM(INM1.GVN_NAME),''''))||'' ''||COALESCE(TRIM(INM1.FMLY_NAME),'''')) )AS NAME2 FROM (

SELECT PA.AGMT_ID,

CASE WHEN  PA.PRTY_AGMT_ROLE_CD = ''PLCYPRININS'' THEN PA.PRTY_ID END NIN_PRTY_ID,

CASE WHEN  PA.PRTY_AGMT_ROLE_CD = ''PLCYADDNMINS'' THEN PA.PRTY_ID END AS NIN1_PRTY_ID

FROM  EVIEWDB_EDW.PRTY_AGMT AS PA JOIN (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)ECTL ON 1=1

WHERE CAST(PA.TRANS_STRT_DTTM AS DATE)<=TO_DATE(CAL_END_DATE, ''YYYY-MM-DD'')

AND PA.PRTY_AGMT_ROLE_CD IN (''PLCYPRININS'',''PLCYADDNMINS'') 

QUALIFY ROW_NUMBER() OVER(PARTITION BY PA.AGMT_ID,PA.PRTY_AGMT_ROLE_CD ORDER BY PA.PRTY_AGMT_STRT_DTTM DESC, PA.TRANS_STRT_DTTM  DESC)=1

) T1 

LEFT OUTER JOIN EVIEWDB_EDW.INDIV_NAME AS INM ON T1.NIN_PRTY_ID = INM.INDIV_PRTY_ID AND CAST(INM.EDW_END_DTTM AS DATE)=CAST( ''9999-12-31'' AS DATE)

LEFT OUTER JOIN EVIEWDB_EDW.INDIV_NAME AS INM1 ON T1.NIN1_PRTY_ID = INM1.INDIV_PRTY_ID AND CAST(INM1.EDW_END_DTTM AS DATE) = CAST(''9999-12-31'' AS DATE)

GROUP BY 1 ) PA

ON A.AGMT_ID = PA.AGMT_ID 

LEFT OUTER JOIN 

(SELECT PRTY_ID,

MAX(ADDR1) AS ADDR1,

MAX(ADDR2) AS ADDR2,

MAX(CITY) AS CITY,

MAX(ST_CD) AS ST_CD,

MAX(ST_DESC) AS ST_DESC,

MAX(ZIP) AS ZIP,

MAX(COUNTY_CD) AS COUNTY_CD,

MAX(COUNTY_DESC) AS COUNTY_DESC,

MAX(EML) AS EML ,

MAX(HOME_NUM) HOME_NUM

FROM (

SELECT 

PA.PRTY_ID,

CASE WHEN L.ADDR_SBTYPE_CD = ''STADR'' THEN SA.ADDR_LN_1_TXT END AS ADDR1,

CASE WHEN L.ADDR_SBTYPE_CD = ''STADR'' THEN SA.ADDR_LN_2_TXT END AS ADDR2,

CASE WHEN L.ADDR_SBTYPE_CD = ''STADR'' THEN C.GEOGRCL_AREA_NAME END AS CITY,

CASE WHEN L.ADDR_SBTYPE_CD = ''STADR'' THEN T.GEOGRCL_AREA_SHRT_NAME END AS ST_CD,

CASE WHEN L.ADDR_SBTYPE_CD = ''STADR'' THEN T.GEOGRCL_AREA_DESC END AS ST_DESC,

CASE WHEN L.ADDR_SBTYPE_CD = ''STADR'' THEN PC.POSTL_CD_NUM END AS ZIP,

CN.GEOGRCL_AREA_SHRT_NAME  AS COUNTY_CD,

CN.GEOGRCL_AREA_NAME  AS COUNTY_DESC,

COALESCE(CASE WHEN PA.PRTY_ADDR_USGE_TYPE_CD = ''PREMAIL'' THEN TRIM(EA.ELCTRNC_ADDR_TXT) END,CASE WHEN PA.PRTY_ADDR_USGE_TYPE_CD = ''SCEMAIL'' THEN TRIM(EA.ELCTRNC_ADDR_TXT) END) AS EML,

CASE WHEN PA.PRTY_ADDR_USGE_TYPE_CD = ''HOMEPHN'' THEN CAST(TN.TLPHN_NUM AS VARCHAR(15)) END AS HOME_NUM

FROM EVIEWDB_EDW.PRTY_ADDR AS PA   JOIN (

SELECT FROM_DATE,TO_DATE,

ADD_MONTHS((CAST(ECTL.TO_DATE AS DATE) - EXTRACT(DAY FROM CAST(ECTL.TO_DATE AS DATE))+1),1)-1 CAL_END_DATE,

TO_DATE(ECTL.TO_DATE, ''YYYY-MM-DD'') CAL_TO_DATE,

CASt((ACCOUNTING_YR*100)+(ACCOUNTING_MO) AS INTEGER) MO_ID

 FROM EVIEWDB_LGCY.ECTL_MISPREM_HEADER ECTL WHERE (ACCOUNTING_YR*100)+(ACCOUNTING_MO)=:wf_MONTH_ID)ectl ON 1=1

JOIN  EVIEWDB_EDW.LOCTR AS L ON PA.LOC_ID = L.LOCTR_ID AND L.ADDR_SBTYPE_CD IN (''STADR'',''EMLADR'',''TELNBR'') 

LEFT OUTER JOIN EVIEWDB_EDW.STREET_ADDR AS SA ON  PA.LOC_ID = SA.STREET_ADDR_ID AND L.LOCTR_SBTYPE_CD=''AD'' AND L.ADDR_SBTYPE_CD = ''STADR'' AND CAST(SA.EDW_END_DTTM AS DATE) = CAST(''9999-12-31'' AS DATE) 

LEFT OUTER JOIN EVIEWDB_EDW.CITY AS C ON  SA.CITY_ID = C.CITY_ID AND CAST(C.EDW_END_DTTM AS DATE) = CAST(''9999-12-31'' AS DATE) 

LEFT OUTER JOIN EVIEWDB_EDW.CNTY CN ON SA.CNTY_ID = CN.CNTY_ID  AND CAST(CN.EDW_END_DTTM AS DATE) = ''9999-12-31''

LEFT OUTER JOIN EVIEWDB_EDW.TERR AS T ON  SA.TERR_ID = T.TERR_ID AND CAST(T.EDW_END_DTTM AS DATE) = CAST(''9999-12-31'' AS DATE) 

LEFT OUTER JOIN EVIEWDB_EDW.POSTL_CD AS PC ON  SA.POSTL_CD_ID = PC.POSTL_CD_ID AND CAST(PC.EDW_END_DTTM AS DATE) = CAST(''9999-12-31'' AS DATE) 

LEFT OUTER JOIN EVIEWDB_EDW.ELCTRNC_ADDR AS EA ON PA.LOC_ID = EA.ELCTRNC_ADDR_ID AND L.ADDR_SBTYPE_CD = ''EMLADR'' 

LEFT OUTER JOIN EVIEWDB_EDW.TLPHN_NUM AS TN ON PA.LOC_ID = TN.TLPHN_NUM_ID AND L.ADDR_SBTYPE_CD = ''TELNBR'' 

WHERE PA.PRTY_ID <> 9999 AND CAST(PA.TRANS_STRT_DTTM AS DATE)<=CAL_END_DATE 

QUALIFY ROW_NUMBER() OVER(PARTITION BY PA.PRTY_ID,PRTY_ADDR_USGE_TYPE_CD ORDER BY  PA.TRANS_END_DTTM DESC,PA.PRTY_ADDR_STRT_DTTM DESC) = 1

) AS T GROUP BY PRTY_ID ) AS P

ON PA.NIN_PRTY_ID = P.PRTY_ID

LEFT OUTER JOIN (SELECT DISTINCT PAA.PRTY_ID, MAX(T.GEOGRCL_AREA_SHRT_NAME) RSKST FROM  EVIEWDB_EDW.PRTY_AGMT_ASSET  PAA

JOIN  EVIEWDB_EDW.PRTY_ASSET_LOCTR PAL ON PAA.PRTY_ASSET_ID=PAL.PRTY_ASSET_ID

JOIN  EVIEWDB_EDW.TERR T ON PAL.LOC_ID=T.TERR_ID

WHERE PRTY_ASSET_LOCTR_ROLE_CD=''RSKST'' GROUP BY 1) RSKST ON PA.NIN_PRTY_ID=RSKST.PRTY_ID

/* TO GET COUNTY_CD FROM LEGACY TABLE*/

LEFT JOIN (SELECT MAX(SRC_IDNTFTN_VAL) SRC_IDNTFTN_VAL,SUBSTR(SRC_IDNTFTN_VAL,1,2) XLAT_ST_CD ,TGT_IDNTFTN_VAL FROM  EVIEWDB_EDW.TERADATA_ETL_REF_XLAT XLAT 

WHERE  XLAT.SRC_IDNTFTN_SYS = ''DB2'' AND XLAT.SRC_IDNTFTN_NM = ''DB_T_SHRD_PROD.COUNTY_LOOKUP'' GROUP BY 2,3) XLAT ON COUNTY_DESC=XLAT.TGT_IDNTFTN_VAL AND 

SUBSTR(SRC_IDNTFTN_VAL,1,2)=ST_CD 

) AS A 

QUALIFY ROW_NUMBER() OVER(PARTITION BY MBRSHP_NUM,MBRSHP_TYPE_CD ORDER BY A.POLICY_EFF_DT DESC,A.AGMT_EFF_DTTM DESC)=1  

)UPD_TBLE 

SET

INCEPT_DATE= COALESCE(UPD_TBLE.INCEPTION_DT,MEMB.INCEPT_DATE)

,EFF_DATE=COALESCE(UPD_TBLE.POLICY_EFF_DT,MEMB.EFF_DATE)

,EXP_DATE=COALESCE(UPD_TBLE.POLICY_EXP_DT,MEMB.EXP_DATE)

,NAME1=COALESCE(UPD_TBLE.NAME1,MEMB.NAME1)

,NAME2=COALESCE(UPD_TBLE.NAME2,MEMB.NAME2)

,ZIP_CD=COALESCE(UPD_TBLE.ZIP,MEMB.ZIP_CD)

,ADDR_LINE_1=COALESCE(UPD_TBLE.ADDR1,MEMB.ADDR_LINE_1)

,ADDR_LINE_2=COALESCE(UPD_TBLE.ADDR2,MEMB.ADDR_LINE_2)

,CITY =COALESCE(UPD_TBLE.CITY,MEMB.CITY)

,ST_CD=COALESCE(UPD_TBLE.ST_CD,MEMB.ST_CD)

,ST_DESC =COALESCE(UPD_TBLE.ST_DESC,MEMB.ST_DESC)

,RISK_ST_CD=COALESCE(trim(UPD_TBLE.RSKST),trim(MEMB.RISK_ST_CD))

,MEMBER_PHONE=COALESCE(UPD_TBLE.PHONE_NBR,MEMB.MEMBER_PHONE)

,EMAIL=COALESCE(UPD_TBLE.EML,MEMB.EMAIL)

,COUNTY_CD=COALESCE(UPD_TBLE.COUNTY_CD,MEMB.COUNTY_CD)

,COUNTY_DESC=COALESCE(UPD_TBLE.COUNTY_DESC,MEMB.COUNTY_DESC)

WHERE MEMB.MEMBER_NUMBER =UPD_TBLE.MBRSHP_NUM AND MEMB.MEMBER_TYPE=UPD_TBLE.MBRSHP_TYPE_CD

AND MEMB.MO_ID=:wf_MONTH_ID;


END; ';