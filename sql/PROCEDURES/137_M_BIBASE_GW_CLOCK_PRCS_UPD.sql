-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_BIBASE_GW_CLOCK_PRCS_UPD("RUN_ID" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' BEGIN 

-- Component SQ_ETL_PRCS_CTRL, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_ETL_PRCS_CTRL AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as PRCS_ID,
$2 as SUB_PRCS_NM,
$3 as SRC_EXTRACT_DT,
$4 as GW_CLOCK,
$5 as PRCS_STAG,
$6 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT 

A.PRCS_ID

,A.SUB_PRCS_NM

,A.SRC_EXTRACT_DT

,B.JOB_END_DT

,A.PRCS_STAG 

FROM DB_T_PROD_CORE.ETL_PRCS_CTRL A,

(

SELECT MAX(CAST(JOB_END_DT AS DATE)) JOB_END_DT  FROM

DB_T_PROD_CORE.ETL_PRCS_CTRL 

WHERE 

 PRCS_STAG = ''EDW_DLY''

 AND PRCS_STS = ''SUCCEEDED''

) B

WHERE 

A.PRCS_NM in (''WF_BASE_COMPOSITE_MONTHLY'',''WF_BIBASE_SMNTC_MONTHLY'') 

AND A.PRCS_STS=''SUCCEEDED'' AND A.PRCS_STAG in (''COMPSIT'',''SMNTC'')

QUALIFY RANK() OVER (PARTITION BY A.SUB_PRCS_NM ORDER BY A.JOB_END_DT DESC) =1
) SRC
)
);


-- Component EXPTRANS, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE EXPTRANS AS
(
SELECT
SQ_ETL_PRCS_CTRL.PRCS_ID as PRCS_ID,
SQ_ETL_PRCS_CTRL.SUB_PRCS_NM as SUB_PRCS_NM,
CASE WHEN SQ_ETL_PRCS_CTRL.GW_CLOCK = LAST_DAY ( SQ_ETL_PRCS_CTRL.GW_CLOCK ) THEN SQ_ETL_PRCS_CTRL.GW_CLOCK ELSE LAST_DAY ( dateadd ( month, -1, SQ_ETL_PRCS_CTRL.GW_CLOCK  ) ) END as GW_CLOCK_CALC,
GW_CLOCK_CALC as SRC_EXTRACT_DT_OUT,
SQ_ETL_PRCS_CTRL.PRCS_STAG as PRCS_STAG,
SQ_ETL_PRCS_CTRL.source_record_id
FROM
SQ_ETL_PRCS_CTRL
);


-- Component upd_prcs_cntrl, Type UPDATE 
CREATE OR REPLACE TEMPORARY TABLE upd_prcs_cntrl AS
(
/* UPDATE_STRATEGY_ACTION = 0 FOR INSERT / UPDATE_STRATEGY_ACTION = 1 FOR UPDATE / UPDATE_STRATEGY_ACTION = 2 FOR DELETE / UPDATE_STRATEGY_ACTION = 3 FOR REJECT */
SELECT
EXPTRANS.PRCS_ID as PRCS_ID,
EXPTRANS.SUB_PRCS_NM as SUB_PRCS_NM,
EXPTRANS.SRC_EXTRACT_DT_OUT as SRC_EXTRACT_DT_OUT,
EXPTRANS.PRCS_STAG as PRCS_STAG,
EXPTRANS.source_record_id,
1 as UPDATE_STRATEGY_ACTION
FROM
EXPTRANS
);


-- Component ETL_PRCS_CTRL1, Type TARGET 
/* Perform Updates */
MERGE INTO DB_T_PROD_CORE.ETL_PRCS_CTRL
USING upd_prcs_cntrl ON (UPDATE_STRATEGY_ACTION = 1 AND ETL_PRCS_CTRL.PRCS_ID = upd_prcs_cntrl.PRCS_ID AND ETL_PRCS_CTRL.PRCS_STAG = upd_prcs_cntrl.PRCS_STAG)
WHEN MATCHED THEN UPDATE
SET
SRC_EXTRACT_DT = upd_prcs_cntrl.SRC_EXTRACT_DT_OUT
;


END; ';