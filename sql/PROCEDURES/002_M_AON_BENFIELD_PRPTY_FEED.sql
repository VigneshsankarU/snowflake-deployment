-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_AON_BENFIELD_PRPTY_FEED("PARAM_JSON" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' 
DECLARE
  v_prcs_id STRING;
  p_feed_date STRING;
  PMWorkflowName STRING;
  PMSessionName STRING;
BEGIN
  SELECT 
    TRY_PARSE_JSON(:param_json):v_prcs_id::STRING,
    TRY_PARSE_JSON(:param_json):p_feed_date::STRING,
    TRY_PARSE_JSON(:param_json):PMWorkflowName::STRING,
    ''s_m_aon_benfield_prpty_feed''
  INTO
    v_prcs_id,
    p_feed_date,
    PMWorkflowName,
    PMSessionName;

-- Component SQ_AGMT, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_AGMT AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as MOID,
$2 as Feed_date,
$3 as CompanyCode,
$4 as PolicyNumber,
$5 as AnnualPremium,
$6 as LineOfBusiness,
$7 as PolicyType,
$8 as PolicyLimit,
$9 as PolicyInceptionDate,
$10 as ExpiredDate,
$11 as PolicyDeductible,
$12 as EQ_ENDOR_DED,
$13 as EQ_ENDOR_DESC,
$14 as WIND_HAIL_ENDOR_DED,
$15 as HURRICANE_ENDOR_DED,
$16 as PropertyTerritory,
$17 as DwellingCoverageLimit,
$18 as OtherStructureCoverageLimit,
$19 as PersonalPropertyCoverageLimit,
$20 as LossOfUseCoverageLimit,
$21 as InsuranceValue,
$22 as State,
$23 as ZipCode,
$24 as ConstructionClass,
$25 as PROP_ADDR_LOC,
$26 as Address1,
$27 as City,
$28 as County,
$29 as NumberofStories,
$30 as YearBuilt,
$31 as OccupancyType,
$32 as SquareFootage,
$33 as EXWIND_ENDOR_DESC,
$34 as AgentNumber,
$35 as SaleServiceCenter,
$36 as RoofYear,
$37 as FoundationType,
$38 as ContentsGrade,
$39 as PolicyStatus,
$40 as SRC_SYS_CD,
$41 as IBHS_Level,
$42 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT DISTINCT  MO_ID

                , FEED_DATE

                ,CO_CD AS COMPANYCODE

                ,A.PLCY_NUM AS POLICYNUMBER

                ,ANNUAL_PREM AS ANNUALPREMIUM

                ,LOB AS LINEOFBUSINESS

                ,PLCY_TYPE AS POLICYTYPE

                ,PLCY_LMT AS POLICYLIMIT

                ,PLCY_INCPTN_DT AS POLICYINCEPTIONDATE

                ,PLCY_EXPRD_DT AS EXPIREDDATE

                ,PLCY_DEDCTB AS POLICYDEDUCTIBLE

                ,TO_CHAR(EAQK_ENDRSMT_DEDCTB, ''9999.99'') EQ_ENDOR_DED

                ,EQ_ENDORS_DESC

                ,CAST(WIND_HAIL_ENDRSMT_DEDCTB AS VARCHAR(10)) WIND_HAIL_ENDOR_DED

                ,TO_CHAR(HURCN_ENDRSMT_DEDCTB, ''9999.99'') HURRICANE_ENDOR_DED

                ,A.ASSET_DTL_TXT AS PROPERTYTERRITORY

                ,BLDG_LMT AS DWELLINGCOVERAGELIMIT

                ,OTHR_STRC_LMT AS OTHERSTRUCTURECOVERAGELIMIT

                ,CNTNTS_LMT AS CONTENTSLIMIT

                ,LOSS_USE_LMT AS LOSSOFUSECOVERAGELIMIT

                ,INSRNC_VAL AS INSURANCEVALUE

                ,STATE AS STATE

                ,ZIPCD AS ZIPCODE

                ,CNSTRCTN_CLAS AS CONSTRUCTIONCLASS

                ,PRPTY_ADDR_LOC AS PROPERTYADDRESSLOCATION

                ,ADDR_1 AS ADDRESS1

                ,CITY AS CITY

                ,CNTY_CD AS COUNTYCODE

,CAST(NBR_OF_STORIES AS VARCHAR(100)) NUMBEROFSTORIES/* EIM-50235 */
                ,CAST(YR_BUILT AS VARCHAR(100)) YEARBUILT

                ,DB_T_PROD_CORE.OCCPY_TYPE AS OCCUPANCYTYPE

                ,CAST(SQ_FOOTAGE AS DECIMAL(18, 4))  AS SQUAREFOOTAGE

                ,CAST(EXWIND_ENDORS_DESC AS VARCHAR(15)) EXWIND_ENDORS_DESC

                ,AGNT_CD AS AGENTNUMBER

				,SL_SRVC_CTR AS SALESERVICECENTER

                ,CAST(ROOF_YEAR AS VARCHAR(100)) ROOFYEAR

,CAST(A.ASSET_DTL_DESC AS VARCHAR(100)) AS FOUNDATIONTYPE   /*  EIM- 33807 Put Source Back IN */
                ,CNTNTS_GRADE AS CONTENTSGRADE

                ,PLCY_STS AS POLICYSTATUS

                ,SRC_CD

				,IBHS_LEVEL

                

FROM (

                SELECT DISTINCT EXTRACT(YEAR FROM TO_DATE(:p_feed_date)) * 100 + EXTRACT(MONTH FROM TO_DATE(:p_feed_date)) MO_ID

,CAST(:p_feed_date AS DATE) FEED_DATE

,CMP.COMPANY CO_CD

,A.HOST_AGMT_NUM PLCY_NUM

,COALESCE(PM.PLCY_AMT,0) ANNUAL_PREM

,CASE 

                WHEN ADDR.SHRT_STATE=''MS'' AND LOB_POLICY.INSRNC_LOB_TYPE_CD =''HO'' AND LOB_POLICY.POL_DESC=''HO2'' THEN ''12''

               WHEN ADDR.SHRT_STATE IN (''GL'',''AL'') AND LOB_POLICY.INSRNC_LOB_TYPE_CD=''HO'' AND LOB_POLICY.POL_DESC= ''HO2'' THEN ''02''

               WHEN LOB_POLICY.INSRNC_LOB_TYPE_CD =''HO'' AND LOB_POLICY.POL_DESC IN (''HO3'',''HO5'') THEN ''02''

               WHEN LOB_POLICY.INSRNC_LOB_TYPE_CD=''HO'' AND LOB_POLICY.POL_DESC IN (''HO4'',''HO6'') THEN ''03''

               WHEN LOB_POLICY.INSRNC_LOB_TYPE_CD=''HO'' AND LOB_POLICY.POL_DESC=''HO8'' THEN ''13''

               WHEN LOB_POLICY.INSRNC_LOB_TYPE_CD = ''MH''

THEN ''04''

               WHEN LOB_POLICY.INSRNC_LOB_TYPE_CD = ''SF''

THEN ''01''

               ELSE ''NULL''

               END LOB

,LOB_POLICY.POL_DESC PLCY_TYPE

,COALESCE(BUILD_LIMIT.AMT, 0) + COALESCE(OTH_STRUCT.AGMT_FEAT_AMT, 0) + COALESCE(CNT_LIMIT.CONTENTS_LIMIT, 0) + COALESCE(LOSS_USE.AGMT_FEAT_AMT, 0) PLCY_LMT

,CAST(A.AGMT_OPN_DTTM AS DATE) PLCY_INCPTN_DT

,CAST(A.AGMT_PLND_EXPN_DTTM AS DATE) PLCY_EXPRD_DT

,CAST(POL_DED.DEDUCTIBLE_AMT AS DECIMAL(12, 4)) PLCY_DEDCTB

,EQ_ENDORS.AGMT_FEAT_AMT EAQK_ENDRSMT_DEDCTB

               ,EQ_ENDORS.COMN_FEAT_NAME EQ_ENDORS_DESC

,CASE 

                WHEN WIND_HAIL_ENDORS.FEAT_DTL_VAL_TYPE = ''PERCENT''

THEN REGEXP_REPLACE(CAST(CAST(WIND_HAIL_ENDORS.FEAT_DTL_CD_NAME AS DECIMAL(5, 4)) / 100 AS VARCHAR(10)), ''(?<!\\D)(\\.)'', ''0\\1'')

               ELSE WIND_HAIL_ENDORS.FEAT_DTL_CD_NAME

END WIND_HAIL_ENDRSMT_DEDCTB

,HURRICANE_ENDORS.FEAT_DTL_CD_NAME HURCN_ENDRSMT_DEDCTB

,PROP_TERR.ASSET_DTL_TXT

,BUILD_LIMIT.AMT BLDG_LMT

,OTH_STRUCT.AGMT_FEAT_AMT OTHR_STRC_LMT

,CNT_LIMIT.CONTENTS_LIMIT CNTNTS_LMT

,LOSS_USE.AGMT_FEAT_AMT LOSS_USE_LMT

,''100%'' INSRNC_VAL

,STATE STATE

,ADDR.POSTL_CD_NUM ZIPCD

,CNSTRCTN_OCCPY.CNSTRCTN_TYPE_DESC CNSTRCTN_CLAS

,CAST(NULL AS VARCHAR(1000)) PRPTY_ADDR_LOC

,ADDR.ADDR_LN_1_TXT ADDR_1

,CITY CITY

,ADDR.COUNTY CNTY_CD

,NBR_STORY.PRTY_ASSET_SPEC_VAL NBR_OF_STORIES/* EIM-50235 */
,CNSTRCTN_OCCPY.CNSTRCTN_DATE YR_BUILT

,CNSTRCTN_OCCPY.REAL_ESTAT_TYPE_CD OCCPY_TYPE

,SQFT.PRTY_ASSET_SPEC_MEAS SQ_FOOTAGE

,CASE 

                WHEN WIND_HAIL_EXCLUSION.AGMT_FEAT_IND = 1

THEN ''YES''

               ELSE ''NO''

               END EXWIND_ENDORS_DESC

,AGENT.INTRNL_ORG_NUM AGNT_CD

,SERVICE_CENTER.INTRNL_ORG_NUM SL_SRVC_CTR

,CNSTRCTN_OCCPY.ROOF_YR ROOF_YEAR

/* EIM- 33807 */
,FNDN.ASSET_DTL_DESC

,CASE 

                WHEN LOB_POLICY.INSRNC_LOB_TYPE_CD = ''SF''

AND COALESCE(CNT_LIMIT.CONTENTS_LIMIT, 0) = 0

THEN 0

               ELSE 3

               END CNTNTS_GRADE

,A.AGMT_STS_CD PLCY_STS

,''GW'' SRC_CD

,IBHS_LEVEL

                FROM (

SELECT PPV.AGMT_ID

               ,PPV.HOST_AGMT_NUM

               ,PPV.AGMT_OPN_DTTM

               ,PPV.AGMT_PLND_EXPN_DTTM

               ,PPV.TERM_NUM

               ,A_S.AGMT_STS_CD

               ,PPV.LGCY_PLCY_IND

FROM (

/* EIM-14304 - PULLING THE NEW DB_T_PROD_CORE.AGMT_STS */
               SELECT A.AGMT_ID

,A.HOST_AGMT_NUM

,A.AGMT_OPN_DTTM

,A.AGMT_PLND_EXPN_DTTM

,A.TERM_NUM

,A.LGCY_PLCY_IND

               FROM  DB_T_PROD_CORE.AGMT A

               WHERE A.AGMT_TYPE_CD = ''PPV''

  AND CAST(A.AGMT_EFF_DTTM AS DATE) <= :p_feed_date

AND CAST(A.AGMT_PLND_EXPN_DTTM AS DATE) >= :p_feed_date

AND CASE 

                WHEN A.MODL_EFF_DTTM > A.MODL_CRTN_DTTM

  THEN A.MODL_EFF_DTTM

               ELSE A.MODL_CRTN_DTTM

               END <=CAST(CAST(:p_feed_date AS DATE)+1 AS TIMESTAMPNTZ) - INTERVAL ''1 microsecond''

AND A.TRANS_STRT_DTTM < CAST(CAST(:p_feed_date AS DATE)+1 AS TIMESTAMPNTZ) - INTERVAL ''1 microsecond''

QUALIFY ROW_NUMBER() OVER (

               PARTITION BY HOST_AGMT_NUM ORDER BY TERM_NUM DESC

  ,MODL_NUM DESC

               ) = 1

               ) PPV

INNER JOIN (

               SELECT HOST_AGMT_NUM

,TERM_NUM

,AGMT_ID

               FROM   DB_T_PROD_CORE.AGMT

               WHERE AGMT_TYPE_CD = ''POLTRM''

AND CAST(CAST(:p_feed_date AS DATE)+1 AS TIMESTAMPNTZ) - INTERVAL ''1 microsecond''

BETWEEN AGMT_EFF_DTTM

               AND AGMT_PLND_EXPN_DTTM

               GROUP BY 1 ,2 ,3

               ) TRM ON PPV.HOST_AGMT_NUM = TRM.HOST_AGMT_NUM

               AND PPV.TERM_NUM = TRM.TERM_NUM

INNER JOIN   DB_T_PROD_CORE.AGMT_STS A_S ON TRM.AGMT_ID = A_S.AGMT_ID

               AND A_S.AGMT_STS_STRT_DTTM <= CAST(CAST(:p_feed_date AS DATE)+1 AS TIMESTAMPNTZ) - INTERVAL ''1 microsecond''

               AND A_S.AGMT_STS_CD <> ''CNFRMDDT'' 

                WHERE PPV.LGCY_PLCY_IND=''N''

               QUALIFY ROW_NUMBER() OVER ( PARTITION BY PPV.AGMT_ID ORDER BY A_S.AGMT_STS_STRT_DTTM DESC ) = 1

) A



/* PROPERTY TERRITORY */
                LEFT JOIN (

SELECT DISTINCT ADC.AGMT_ID, AA.PRTY_ASSET_ID, AGMT_ASSET_DTL_TXT as ASSET_DTL_TXT/* EIM-35987 */
FROM DB_T_PROD_CORE.AGMT_ASSET_DTL_CD_XREF ADC/*  EIM-35987 */
INNER JOIN DB_T_PROD_CORE.PRTY_ASSET PA ON ADC.PRTY_ASSET_ID = PA.PRTY_ASSET_ID

JOIN DB_T_PROD_CORE.AGMT_ASSET AA ON PA.PRTY_ASSET_ID = AA.PRTY_ASSET_ID

WHERE ADC.ASSET_DTL_CD = ''HOTC'' /* TC */
                AND CAST(ADC.EDW_END_DTTM AS DATE)=''9999-12-31''

QUALIFY ROW_NUMBER() OVER(PARTITION BY ADC.AGMT_ID,PA.PRTY_ASSET_ID ORDER BY ADC.EDW_STRT_DTTM DESC)=1/*  EIM-35987 */
  ) PROP_TERR ON A.AGMT_ID = PROP_TERR.AGMT_ID

/* OCCUPANCY TYPE, ROOF YEAR AND CONSTRUCTION TYPE */
                LEFT JOIN (

SELECT DISTINCT AGMT_ID

               ,AA.PRTY_ASSET_ID

               ,MAX(CASE  WHEN RE.CNSTRCTN_TYPE_CD = ''UNK''      THEN NULL ELSE RE.CNSTRCTN_TYPE_CD END) CNSTRCTN_TYPE_DESC

               ,MAX(CASE  WHEN RE.REAL_ESTAT_TYPE_CD NOT IN (  ''FMLY1''  ,''FMLY2''  ,''FAM3-4''  ,''FAM5P''  ,''ADDON''  ,''APT''  ,''CONDO''  ,''TWNHS''  ,''MBLHM''  ,''MODHM''  )

               THEN NULL

ELSE RE.REAL_ESTAT_TYPE_CD

END) REAL_ESTAT_TYPE_CD

               ,MAX(RED.ROOF_YR) ROOF_YR

               ,MAX(EXTRACT(YEAR FROM RE.CNSTRCTN_DT)) CNSTRCTN_DATE

               

 FROM   DB_T_PROD_CORE.AGMT_ASSET AA



LEFT JOIN DB_T_PROD_CORE.REAL_ESTAT RE ON AA.PRTY_ASSET_ID = RE.PRTY_ASSET_ID

AND CAST(RE.EDW_END_DTTM AS DATE) = ''9999-12-31''

INNER JOIN DB_T_PROD_CORE.REAL_ESTAT_DTL RED ON AA.PRTY_ASSET_ID = RED.PRTY_ASSET_ID

AND CAST(RED.EDW_END_DTTM AS DATE) = ''9999-12-31''

LEFT JOIN DB_T_PROD_CORE.CNSTRCTN_TYPE CT1 ON RE.CNSTRCTN_TYPE_CD = CT1.CNSTRCTN_TYPE_CD

/* WHERE RE.REAL_ESTAT_TYPE_CD IS NOT NULL  */
  AND CAST(AA.EDW_END_DTTM AS DATE) = ''9999-12-31''

  GROUP BY 1,2

) CNSTRCTN_OCCPY ON A.AGMT_ID = CNSTRCTN_OCCPY.AGMT_ID

/* COMPANYCODE */
                LEFT JOIN (

SELECT PA.AGMT_ID

               ,INTRNL_ORG_NUM COMPANY

               ,PRTY_AGMT_ROLE_CD

FROM   DB_T_PROD_CORE.PRTY_AGMT PA

LEFT JOIN   DB_T_PROD_CORE.INTRNL_ORG IO ON PA.PRTY_ID = IO.INTRNL_ORG_PRTY_ID

               AND CAST(IO.EDW_END_DTTM AS DATE) = ''9999-12-31''

WHERE PA.PRTY_AGMT_ROLE_CD = ''CMP''

               AND INTRNL_ORG_SBTYPE_CD = ''CO''

               AND CAST(PA.EDW_END_DTTM AS DATE) = ''9999-12-31''

) CMP ON A.AGMT_ID = CMP.AGMT_ID

/* CONTENTSLIMIT */
                LEFT JOIN (

SELECT AGMT_ID

               ,AGMT_FEAT_AMT AS  CONTENTS_LIMIT

FROM   DB_T_PROD_CORE.AGMT_FEAT AF

INNER JOIN   DB_T_PROD_CORE.FEAT F ON AF.FEAT_ID = F.FEAT_ID

WHERE INSRNC_CVGE_TYPE_CD IN (''PP'') /* ,''PPOR'',''PPORI'',''PPOP'',''PPRCE'',''PPSLE'' ) --PERSONAL PROPERTY LIMITS */
               AND FEAT_NAME = ''LIMIT''

               AND CAST(AF.EDW_END_DTTM AS DATE) = ''9999-12-31''

               QUALIFY ROW_NUMBER() OVER (PARTITION BY AGMT_ID ORDER BY AF.EDW_END_DTTM  DESC) = 1

) CNT_LIMIT ON A.AGMT_ID = CNT_LIMIT.AGMT_ID

/* OTHER STRUCTURE */
/*  OTHER STRUCTURE DB_T_CORE_DM_PROD.COVERAGE + BUSINESS CONDUCTED ON THE RESIDENCE PREMISES DB_T_CORE_DM_PROD.ENDORSEMENT + SPECIFIC OTHER STRUCTURE ITEM DB_T_CORE_DM_PROD.ENDORSEMENT */
                LEFT JOIN (

SELECT AGMT_ID

               ,AGMT_FEAT_AMT AS AGMT_FEAT_AMT

FROM   DB_T_PROD_CORE.AGMT_FEAT AF

INNER JOIN   DB_T_PROD_CORE.FEAT F ON AF.FEAT_ID = F.FEAT_ID

WHERE INSRNC_CVGE_TYPE_CD IN ( ''BUSCRPP'' ,''SOSI'' ,''OS'' )    

 AND FEAT_DTL_MODL_TYPE_NAME = ''LIMIT'' 

 AND F.FEAT_INSRNC_SBTYPE_CD = ''COV''

AND FEAT_COVERABLE_TYPE_TXT=''DWELLING_HOE''

AND CAST(AF.EDW_END_DTTM AS DATE) = ''9999-12-31''

                QUALIFY ROW_NUMBER() OVER (PARTITION BY AGMT_ID ORDER BY AF.EDW_END_DTTM  DESC) = 1

) OTH_STRUCT ON A.AGMT_ID = OTH_STRUCT.AGMT_ID

/* BUILDING LIMIT */
                LEFT JOIN (

SELECT AGMT_ID

               ,AGMT_FEAT_AMT AS AMT

FROM   DB_T_PROD_CORE.AGMT_FEAT AF

INNER JOIN   DB_T_PROD_CORE.FEAT F ON AF.FEAT_ID = F.FEAT_ID

WHERE INSRNC_CVGE_TYPE_CD IN ( ''DW'' ,''DWELL'' )

AND COMN_FEAT_NAME =''LIMIT-LIMIT''

               AND FEAT_DTL_MODL_TYPE_NAME = ''LIMIT''

               AND CAST(AF.EDW_END_DTTM AS DATE) = ''9999-12-31''

    QUALIFY ROW_NUMBER() OVER (PARTITION BY AGMT_ID ORDER BY AF.EDW_END_DTTM  DESC) = 1

) BUILD_LIMIT ON A.AGMT_ID = BUILD_LIMIT.AGMT_ID

/* DB_T_CORE_DM_PROD.POLICY DEDUCTIBLE */
                LEFT JOIN (

SELECT AF.AGMT_ID

               ,MAX(CAST(AF.AGMT_FEAT_NUM AS DECIMAL(12, 4))) DEDUCTIBLE_AMT

FROM   DB_T_PROD_CORE.AGMT_FEAT AF

INNER JOIN   DB_T_PROD_CORE.FEAT F ON F.FEAT_ID = AF.FEAT_ID

WHERE F.COMN_FEAT_NAME LIKE  ''ALL PERILS-OTHER%''

                AND CAST(AF.EDW_END_DTTM AS DATE) = ''9999-12-31''

GROUP BY AF.AGMT_ID

) POL_DED ON A.AGMT_ID = POL_DED.AGMT_ID

/* LOSS OF USE */
                LEFT JOIN (

SELECT DISTINCT AGMT_ID

               ,AGMT_FEAT_AMT

FROM   DB_T_PROD_CORE.AGMT_FEAT AF

INNER JOIN   DB_T_PROD_CORE.FEAT F ON AF.FEAT_ID = F.FEAT_ID

WHERE INSRNC_CVGE_TYPE_CD = ''LOU''

               AND FEAT_DTL_MODL_TYPE_NAME = ''LIMIT''

               AND CAST(AF.EDW_END_DTTM AS DATE) = ''9999-12-31''

QUALIFY ROW_NUMBER() OVER (PARTITION BY AGMT_ID ORDER BY AF.EDW_END_DTTM  DESC) = 1

) LOSS_USE ON A.AGMT_ID = LOSS_USE.AGMT_ID

/* LOB AND DB_T_CORE_DM_PROD.POLICY TYPE */
                INNER JOIN (

SELECT DISTINCT AGMT_ID

               ,PRD.PROD_NAME POL_DESC

               ,PRD.INSRNC_LOB_TYPE_CD

FROM   DB_T_PROD_CORE.AGMT_PROD APRD

LEFT JOIN   DB_T_PROD_CORE.PROD PRD ON APRD.PROD_ID = PRD.PROD_ID

WHERE PRD.INSRNC_TYPE_CD = ''PROPTY'' AND APRD.AGMT_PROD_ROLE_CD=''PLCYTYPE''

               AND PRD.INSRNC_LOB_TYPE_CD IN ( ''HO'' ,''MH'' ,''SF'' )

               AND CAST(APRD.EDW_END_DTTM AS DATE) = ''9999-12-31''

               AND CAST(PRD.EDW_END_DTTM AS DATE) = ''9999-12-31''

  ) LOB_POLICY ON LOB_POLICY.AGMT_ID = A.AGMT_ID

/* EQ DB_T_CORE_DM_PROD.ENDORSEMENT DEDUCTIBLE */
                LEFT JOIN (

SELECT DISTINCT B.AGMT_ID

               ,C.FEAT_DTL_VAL AGMT_FEAT_AMT

               ,C.COMN_FEAT_NAME

FROM   DB_T_PROD_CORE.AGMT_INSRD_ASSET_FEAT B /* ON B.AGMT_ID = A.AGMT_ID */
INNER JOIN   DB_T_PROD_CORE.FEAT C ON C.FEAT_ID = B.FEAT_ID

INNER JOIN   DB_T_PROD_CORE.FEAT_RLTD D ON D.RLTD_FEAT_ID = C.FEAT_ID

               AND D.FEAT_RLTNSHP_TYPE_CD = ''COVOPTT''

INNER JOIN   DB_T_PROD_CORE.FEAT E ON E.FEAT_ID = D.FEAT_ID

WHERE C.FEAT_DTL_MODL_TYPE_NAME = ''DEDUCTIBLE''

               AND E.COMN_FEAT_NAME = ''EARTHQUAKE COVERAGE''

               AND CAST(B.EDW_END_DTTM AS DATE) = ''9999-12-31''

) EQ_ENDORS ON A.AGMT_ID = EQ_ENDORS.AGMT_ID

/* SERVICE CENTER */
                LEFT JOIN (

SELECT DISTINCT PA.AGMT_ID

               ,INTRNL_ORG_NUM

FROM   DB_T_PROD_CORE.PRTY_AGMT PA

LEFT JOIN   DB_T_PROD_CORE.INTRNL_ORG IO ON IO.INTRNL_ORG_PRTY_ID = PA.PRTY_ID

WHERE PA.PRTY_AGMT_ROLE_CD = ''SVC''

               AND INTRNL_ORG_SBTYPE_CD = ''SRVCCTR''

                AND CAST(:p_feed_date AS DATE) BETWEEN CAST(PA.PRTY_AGMT_STRT_DTTM AS DATE)

AND COALESCE(CAST(PA.PRTY_AGMT_END_DTTM AS DATE), CAST(''9999-12-31'' AS DATE))

               AND CAST(PA.EDW_END_DTTM AS DATE) = ''9999-12-31''

) SERVICE_CENTER ON A.AGMT_ID = SERVICE_CENTER.AGMT_ID

/* AGENT NUMBER */
                LEFT JOIN (

SELECT DISTINCT PA.AGMT_ID

               ,INTRNL_ORG_NUM

  FROM   DB_T_PROD_CORE.PRTY_AGMT PA

LEFT JOIN   DB_T_PROD_CORE.INTRNL_ORG IO ON IO.INTRNL_ORG_PRTY_ID = PA.PRTY_ID

WHERE PA.PRTY_AGMT_ROLE_CD = ''PRDA''

               AND INTRNL_ORG_SBTYPE_CD = ''PRDA''

                AND CAST(:p_feed_date AS DATE) BETWEEN CAST(PA.PRTY_AGMT_STRT_DTTM AS DATE)

AND COALESCE(CAST(PA.PRTY_AGMT_END_DTTM AS DATE), CAST(''9999-12-31'' AS DATE))

               AND CAST(PA.EDW_END_DTTM AS DATE) = ''9999-12-31''

) AGENT ON A.AGMT_ID = AGENT.AGMT_ID

/* WRITTEN DB_T_PROD_COMN.PREMIUM --EIM-20773 */
                LEFT JOIN  (SELECT HOST_AGMT_NUM,TERM_NUM,SUM(TRANS_PREM_AMT)  AS PLCY_AMT FROM DB_T_PROD_COMN.GW_PREM_TRANS_GL_INFO AS GL_PREM

INNER JOIN 

(SELECT DISTINCT PLCY_INFO_ID,PLCY_NUM,PLCY_TERM_NUM,PLCY_MODL_NUM FROM ECOMNDB_EDW.GW_PREM_TRANS_PLCY_INFO) AS GL_POL

ON GL_PREM.PLCY_INFO_ID = GL_POL.PLCY_INFO_ID

INNER JOIN DB_T_PROD_CORE.AGMT A ON A.HOST_AGMT_NUM=GL_POL.PLCY_NUM AND A.TERM_NUM=GL_POL.PLCY_TERM_NUM AND A.MODL_NUM=GL_POL.PLCY_MODL_NUM 

AND CAST(A.EDW_END_DTTM AS DATE)=''9999-12-31''

WHERE BUS_ACT_TRNS_ACT IN (''WRT'',''NEF'')   AND CVGE_CD<>''SEC2'' 

GROUP BY 1,2)PM ON A.host_agmt_num = PM.host_agmt_num and a.term_num =pm.term_num /* EIM 20773 Joined based on HOST_AGMT_NUM and TERM_NUM instead of AGMT_ID */




/*  SQUARE FOOTAGE  */
                LEFT JOIN (

SELECT DISTINCT AGMT_ID

               ,AA.PRTY_ASSET_ID

               ,PRTY_ASSET_SPEC_MEAS

               ,PRTY_ASSET_SPEC_VAL

FROM   DB_T_PROD_CORE.AGMT_ASSET AA

LEFT JOIN   DB_T_PROD_CORE.PRTY_ASSET_SPEC PAS ON AA.PRTY_ASSET_ID = PAS.PRTY_ASSET_ID

WHERE PAS.PRTY_ASSET_SPEC_TYPE_CD = ''SIZE''

               AND PRTY_ASSET_SPEC_UOM_CD = ''SQFT''

               AND PAS.EDW_END_DTTM = ''9999-12-31 23:59:59.999999''

/* QUALIFY RANK() OVER (  PARTITION BY AGMT_ID  ,PAS.PRTY_ASSET_ID ORDER BY PAS.PRTY_ASSET_SPEC_STRT_DTTM DESC  ) = 1  */
                 ) SQFT ON A.AGMT_ID = SQFT.AGMT_ID

AND CNSTRCTN_OCCPY.PRTY_ASSET_ID = SQFT.PRTY_ASSET_ID

/* STORIESNUMBER */
                LEFT JOIN (

SELECT DISTINCT AGMT_ID

               ,AA.PRTY_ASSET_ID

,PRTY_ASSET_SPEC_VAL/* EIM-50235  */
FROM   DB_T_PROD_CORE.AGMT_ASSET AA

LEFT JOIN   DB_T_PROD_CORE.PRTY_ASSET_SPEC PAS ON AA.PRTY_ASSET_ID = PAS.PRTY_ASSET_ID

WHERE PRTY_ASSET_SPEC_TYPE_CD = ''FLOOR''

AND PAS.EDW_END_DTTM = ''9999-12-31 23:59:59.999999''

/* QUALIFY ROW_NUMBER() OVER (PARTITION BY AA.AGMT_ID , PAS.PRTY_ASSET_ID ORDER BY PAS.EDW_END_DTTM DESC,PAS.PRTY_ASSET_SPEC_STRT_DTTM DESC) = 1 */
) NBR_STORY ON A.AGMT_ID = NBR_STORY.AGMT_ID

AND CNSTRCTN_OCCPY.PRTY_ASSET_ID = NBR_STORY.PRTY_ASSET_ID

/* STREETADDRESS, RISK STATE, RISK CITY, COUNTY, ZIP */
/* CHANGES FOR EIM-14537 - STARTS */
                LEFT JOIN (

                SELECT AGMT_ID,MAX(ADDR_LN_1_TXT) AS ADDR_LN_1_TXT,MAX(ADDR_LN_2_TXT) AS ADDR_LN_2_TXT,MAX(STATE) AS STATE,MAX(SHRT_STATE) AS SHRT_STATE,MAX(CITY) AS CITY

                ,MAX(COUNTY) AS COUNTY,MAX(POSTL_CD_NUM) AS POSTL_CD_NUM,MAX(RSK_ST_CD) AS RSK_ST_CD FROM (

SELECT DISTINCT PAL.AGMT_ID

/*     ,PAL.PRTY_ASSET_ID */
               ,MAX(CASE 

                WHEN PAL.PRTY_ASSET_LOCTR_ROLE_CD IN (

                ''GARSTRTADDRSS''

                ,''RSKSTADRS''

                )

  THEN SA.ADDR_LN_1_TXT

               ELSE NULL

               END) AS ADDR_LN_1_TXT

               ,MAX(CASE 

                WHEN PAL.PRTY_ASSET_LOCTR_ROLE_CD IN (

                ''GARSTRTADDRSS''

                ,''RSKSTADRS''

                )

  THEN SA.ADDR_LN_2_TXT

               ELSE NULL

               END) AS ADDR_LN_2_TXT

               ,MAX(CASE 

                WHEN PAL.PRTY_ASSET_LOCTR_ROLE_CD IN (

                ''GARST''

                ,''RSKST''

                )

  THEN T.GEOGRCL_AREA_NAME

               ELSE NULL

               END) AS STATE

  ,MAX(CASE 

                WHEN PAL.PRTY_ASSET_LOCTR_ROLE_CD IN (

                ''GARST''

                ,''RSKST''

                )

  THEN T.GEOGRCL_AREA_SHRT_NAME

               ELSE NULL

               END) AS SHRT_STATE

               ,MAX(CASE 

                WHEN PAL.PRTY_ASSET_LOCTR_ROLE_CD IN (

                ''GARCTY''

                ,''RSKCTY''

                )

  THEN CI.GEOGRCL_AREA_NAME

               ELSE NULL

               END) AS CITY

               ,MAX(CASE 

                WHEN PAL.PRTY_ASSET_LOCTR_ROLE_CD IN (''RSKCNTY'')

  THEN CN.GEOGRCL_AREA_NAME

               ELSE NULL

               END) AS COUNTY

               ,MAX(CASE 

                WHEN PAL.PRTY_ASSET_LOCTR_ROLE_CD IN (

                ''GARPC''

                ,''RSKPC''

                )

  THEN PC.POSTL_CD_NUM

               ELSE NULL

               END) AS POSTL_CD_NUM

               ,MAX(CASE 

                WHEN PAL.PRTY_ASSET_LOCTR_ROLE_CD IN (

                ''GARST''

                ,''RSKST''

                )

  THEN T.GEOGRCL_AREA_SHRT_NAME

               ELSE NULL

               END) AS RSK_ST_CD

FROM (

               SELECT AA.AGMT_ID

               ,PAL.PRTY_ASSET_ID

               ,LOC_ID

               ,PAL.PRTY_ASSET_LOCTR_ROLE_CD FROM DB_T_PROD_CORE.AGMT_ASSET AA 

INNER  JOIN DB_T_PROD_CORE.PRTY_ASSET PA ON PA.PRTY_ASSET_ID=AA.PRTY_ASSET_ID/*  Identified the issue as part of EIM-15525  testing */
  INNER JOIN DB_T_PROD_CORE.PRTY_ASSET_LOCTR PAL ON AA.PRTY_ASSET_ID = PAL.PRTY_ASSET_ID

JOIN DB_T_PROD_CORE.AGMT_PROD AP ON AA.AGMT_ID=AP.AGMT_ID AND AP.AGMT_PROD_ROLE_CD=''PLCYTYPE'' 

JOIN DB_T_PROD_CORE.PROD P ON AP.PROD_ID=P.PROD_ID AND P.INSRNC_LOB_TYPE_CD IN (''HO'',''MH'',''SF'') 

WHERE PA. PRTY_ASSET_SBTYPE_CD=''REALDW'' AND PA.PRTY_ASSET_CLASFCN_CD=''MAIN'' /*  added as part of EIM-15525  */
  QUALIFY ROW_NUMBER() OVER (PARTITION BY AA.AGMT_ID,PAL.PRTY_ASSET_LOCTR_ROLE_CD  ORDER BY PAL.PRTY_ASSET_ID ASC,AA.EDW_END_DTTM DESC,PAL.EDW_END_DTTM DESC) = 1

                ) PAL

LEFT JOIN   DB_T_PROD_CORE.STREET_ADDR SA ON PAL.LOC_ID = SA.STREET_ADDR_ID /*  AND CAST(SA.EDW_END_DTTM AS DATE)=''9999-12-31'' --COMMENTED AS WORK AROUND FOR EIM-14537 */
LEFT JOIN   CITY CI ON PAL.LOC_ID = CI.CITY_ID

               AND CAST(CI.EDW_END_DTTM AS DATE) = ''9999-12-31''

LEFT JOIN   DB_T_PROD_CORE.TERR T ON PAL.LOC_ID = T.TERR_ID

               AND CAST(T.EDW_END_DTTM AS DATE) = ''9999-12-31''

LEFT JOIN   DB_T_PROD_CORE.POSTL_CD PC ON PAL.LOC_ID = PC.POSTL_CD_ID

               AND CAST(PC.EDW_END_DTTM AS DATE) = ''9999-12-31''

LEFT JOIN   DB_T_PROD_CORE.CNTY CN ON PAL.LOC_ID = CN.CNTY_ID

               AND CAST(CN.EDW_END_DTTM AS DATE) = ''9999-12-31''

GROUP BY PAL.AGMT_ID  ) AS A GROUP BY 1

/* CHANGES FOR EIM-14537 - ENDS */
) ADDR ON A.AGMT_ID = ADDR.AGMT_ID

/* AND CNSTRCTN_OCCPY.PRTY_ASSET_ID = ADDR.PRTY_ASSET_ID */
/*  WIND HAIL DB_T_CORE_DM_PROD.ENDORSEMENT */
                LEFT JOIN (

SELECT DISTINCT AIAF.AGMT_ID

               ,AIAF.PRTY_ASSET_ID

               ,FEAT_DTL_CD_NAME

               ,FEAT_DTL_VAL_TYPE

FROM   DB_T_PROD_CORE.AGMT_INSRD_ASSET_FEAT AIAF

INNER JOIN   DB_T_PROD_CORE.FEAT F ON AIAF.FEAT_ID = F.FEAT_ID

WHERE LOWER(COMN_FEAT_NAME) LIKE ''%STORM%''

               AND FEAT_COVERABLE_TYPE_TXT = ''DWELLING_HOE''

               AND FEAT_SBTYPE_CD = ''OPT''

               AND CAST(AIAF.EDW_END_DTTM AS DATE) = ''9999-12-31''

) WIND_HAIL_ENDORS ON A.AGMT_ID = WIND_HAIL_ENDORS.AGMT_ID

AND CNSTRCTN_OCCPY.PRTY_ASSET_ID = WIND_HAIL_ENDORS.PRTY_ASSET_ID

/*  HURRICANE DB_T_CORE_DM_PROD.ENDORSEMENT */
                LEFT JOIN (

SELECT DISTINCT AIAF.AGMT_ID AGMT_ID

               ,AIAF.PRTY_ASSET_ID PRTY_ASSET_ID

               ,CASE 

 WHEN FEAT_DTL_CD_NAME LIKE ''%K''

               THEN SUBSTR(FEAT_DTL_CD_NAME, 0, POSITION(''K'' IN FEAT_DTL_CD_NAME)) * 1000

WHEN FEAT_DTL_CD_NAME LIKE ''%%%''

               THEN FEAT_DTL_CD_NAME / 100

ELSE 0

END AS FEAT_DTL_CD_NAME

FROM   DB_T_PROD_CORE.AGMT_INSRD_ASSET_FEAT AIAF

INNER JOIN   DB_T_PROD_CORE.FEAT F ON AIAF.FEAT_ID = F.FEAT_ID

WHERE LOWER(COMN_FEAT_NAME) LIKE ''%HURRICANE%''

               AND FEAT_COVERABLE_TYPE_TXT = ''DWELLING_HOE''

               AND FEAT_SBTYPE_CD = ''OPT''

               AND CAST(AIAF.EDW_END_DTTM AS DATE) = ''9999-12-31''

) HURRICANE_ENDORS ON A.AGMT_ID = HURRICANE_ENDORS.AGMT_ID

AND CNSTRCTN_OCCPY.PRTY_ASSET_ID = HURRICANE_ENDORS.PRTY_ASSET_ID

/*  WIND HAIL EXCLUSION */
                LEFT JOIN (

SELECT DISTINCT AGMT_ID

               ,AGMT_FEAT_IND

FROM   DB_T_PROD_CORE.AGMT_FEAT AF

INNER JOIN   DB_T_PROD_CORE.FEAT F ON AF.FEAT_ID = F.FEAT_ID

WHERE F.FEAT_NAME = ''IS WIND, WINDSTORM AND HAIL EXCLUDED?''

               AND F.FEAT_COVERABLE_TYPE_TXT = ''DWELLING_HOE''

               AND FEAT_SBTYPE_CD = ''TERM''

                AND CAST(AF.EDW_END_DTTM AS DATE) = ''9999-12-31''

) WIND_HAIL_EXCLUSION ON A.AGMT_ID = WIND_HAIL_EXCLUSION.AGMT_ID

/* FOUNDATION */
 



/* EIM- 33807 START - Put Back Foundation type column from feed using DB_T_PROD_CORE.AGMT_ASSET_DTL_CD_XREF ------------  GKT */
 

                LEFT JOIN (

SELECT DISTINCT ADC.AGMT_ID

               ,ADC.PRTY_ASSET_ID PRTY_ASSET_ID

               , ADT.ASSET_DTL_DESC

FROM   DB_T_PROD_CORE.AGMT_ASSET_DTL_CD_XREF ADC 

INNER JOIN   DB_T_PROD_CORE.ASSET_DTL_TYPE ADT ON ADC.ASSET_DTL_CD = ADT.ASSET_DTL_CD

               AND CAST(AGMT_ASSET_DTL_XREF_STRT_DTTM AS DATE) <= :p_feed_date

               AND COALESCE(CAST(AGMT_ASSET_DTL_XREF_END_DTTM AS DATE), CAST(''9999-12-31'' AS DATE)) >= :p_feed_date

AND CAST(ADC.EDW_END_DTTM AS DATE) = ''9999-12-31''

AND CAST(ADT.EDW_END_DTTM AS DATE) = ''9999-12-31''

/* INNER JOIN   DB_T_PROD_CORE.AGMT_ASSET AA ON ADC.PRTY_ASSET_ID = AA.PRTY_ASSET_ID */
/* AND CAST(AA.TRANS_STRT_DTTM AS DATE) <= :p_feed_date */
/*                AND COALESCE(CAST(AA.TRANS_END_DTTM AS DATE), CAST(''9999-12-31'' AS DATE)) >= :p_feed_date */
/*                AND CAST(AGMT_ASSET_STRT_DTTM AS DATE) <= :p_feed_date */
/*                AND CAST(AGMT_ASSET_END_DTTM AS DATE) >= :p_feed_date */
WHERE ASSET_DTL_SCHM_TYPE_CD = ''FOUND''

               

 ) FNDN ON A.AGMT_ID = FNDN.AGMT_ID

AND CNSTRCTN_OCCPY.PRTY_ASSET_ID = FNDN.PRTY_ASSET_ID 



/* EIM- 33807  END -- Put Back  Foundation type column from feed  -------- GKT */
 

/* IBHS */


LEFT JOIN (

SELECT DISTINCT  e.AGMT_ID, APLCTN_RSPNS_TXT IBHS_LEVEL  FROM  DB_T_PROD_CORE.APLCTN_QUES_RSPNS A 

 JOIN  DB_T_PROD_CORE.APLCTN B ON A.APLCTN_ID=B.APLCTN_ID 

                AND CAST(A.TRANS_STRT_DTTM AS DATE) <= :p_feed_date

               AND COALESCE(CAST(A.TRANS_END_DTTM AS DATE), CAST(''9999-12-31'' AS DATE)) >= :p_feed_date

               AND CAST(B.TRANS_STRT_DTTM AS DATE) <= :p_feed_date

               AND COALESCE(CAST(B.TRANS_END_DTTM AS DATE), CAST(''9999-12-31'' AS DATE)) >= :p_feed_date

JOIN  DB_T_PROD_CORE.INSRNC_QUOTN C ON B.APLCTN_ID=C.APLCTN_ID

JOIN  DB_T_PROD_CORE.QUOTN_AGMT D ON C.QUOTN_ID=D.QUOTN_ID

               AND CAST(C.TRANS_STRT_DTTM AS DATE) <= :p_feed_date

               AND COALESCE(CAST(C.TRANS_END_DTTM AS DATE), CAST(''9999-12-31'' AS DATE)) >= :p_feed_date

               AND CAST(D.TRANS_STRT_DTTM AS DATE) <= :p_feed_date

               AND COALESCE(CAST(D.TRANS_END_DTTM AS DATE), CAST(''9999-12-31'' AS DATE)) >= :p_feed_date

JOIN  DB_T_PROD_CORE.AGMT E ON D.AGMT_ID=E.AGMT_ID

               AND CAST(E.TRANS_STRT_DTTM AS DATE) <= :p_feed_date

               AND COALESCE(CAST(E.TRANS_END_DTTM AS DATE), CAST(''9999-12-31'' AS DATE)) >= :p_feed_date

               WHERE APLCTN_FRM_QUES_NUM = ''HODWELLINGCONSTRUCTIONMITIGATIONCERTLEVEL'' 

 AND APLCTN_RSPNS_TXT IS NOT NULL ) IBHS ON IBHS.AGMT_ID =A.AGMT_ID

                

                

/*  AGREEMENT STATUS FILTER FOR ACTIVE POLICIES */
                WHERE A.AGMT_STS_CD IN (

               ''INFORCE''



               )



/* EIM- 33807 Put Back in - Foundation Type & BCEG info . Also use DB_T_PROD_CORE.AGMT_ASSET_DTL_CD_XREF instead of DB_T_PROD_CORE.ASSET_DTL_CD_XREF for Foundation */
/*  FIXED  THE AGENT ID BY REPLACING INSRNC_AGNT_PRTY_ID WITH INSRNC_AGNT_CD */
/*  ADDDED BUSINESS ON PREMISE AND SPECIFIC OTHER STRUCTURE ENDORSEMENTS TO OTHER STRUCTURE DB_T_CORE_DM_PROD.COVERAGE */
/*  DB_T_CORE_DM_PROD.POLICY LIMIT IS CALCULATED AS SUM OF BULDING LIMIT, LOSS OF USE LIMIT, CONTENTS LIMIT AND  OTHER STRUCTURE LIMIT  */
/*  UPDATED THE BUDLING LIMIT QUERY TO USE DWELLING LIMITS AND DELLING ADDITIONAL LIMITS */
/*  2016/08/10 - BINIL */
/*  RISK AND GARAGE DB_T_CORE_PROD.ADDRESS CODE CHANGED TO ''RSKSTADRS'' AND ''GARSTRTADDRSS'' FROM ''RSKLCTN'' AND ''GRGLCTN'' */
/*  PROPERTY TERRYTORY FILETR CHANGED FROM TC TO HOTC */
/*  CHANGED THE ORIGINAL INCEPTION DATE TO AGMT_OPN_DTTM FROM AGMT_SIGND_DTTM */
/*  ADDED FILTER AND PRTY_ASSET_SPEC.EDW_END_DTTM =''9999-12-31 00:00:00.000'' IN SQUAREFOOTAGE AND WRITTEN DB_T_PROD_COMN.PREMIUM QUERY */
/* CHANGED ALIAS NAME */
/* CHANGED AGENT CD QUERY AS MORE NULL VALUES ARE POPULATED FROM DB_T_PROD_CORE.INSRNC_AGNT TABLE */
/* --2017-11-09 -- BINIL - EIM-14537 */
/*  CHANGED ADDR SUBQUERY  TO USE DIFFERENT LOCATOR ROLE CODES FOR CITY,COUNT ,STATE AND POSTAL CODE INADDITION TO STREET DB_T_CORE_PROD.ADDRESS */
                ) A
) SRC
)
);


-- Component exp_HOLD_DATA, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_HOLD_DATA AS
(
SELECT
:v_prcs_id as out_PRCS_ID,
SQ_AGMT.MOID as MOID,
SQ_AGMT.Feed_date as var_Feed_date,
LTRIM ( RTRIM ( SQ_AGMT.CompanyCode ) ) as out_COMPANY_CODE,
LTRIM ( RTRIM ( SQ_AGMT.PolicyNumber ) ) as out_POL_NBR,
SQ_AGMT.AnnualPremium as ANNUL_PREM,
LTRIM ( RTRIM ( SQ_AGMT.LineOfBusiness ) ) as out_LOB,
LTRIM ( RTRIM ( SQ_AGMT.PolicyType ) ) as out_POL_TYPE,
SQ_AGMT.PolicyLimit as POL_LIMIT,
SQ_AGMT.PolicyInceptionDate as POL_INCPT_DT,
SQ_AGMT.ExpiredDate as EXPIRED_DT,
SQ_AGMT.PolicyDeductible as POL_DED,
SQ_AGMT.EQ_ENDOR_DED as EQ_ENDOR_DED,
SQ_AGMT.WIND_HAIL_ENDOR_DED as WIND_HAIL_ENDOR_DED,
SQ_AGMT.HURRICANE_ENDOR_DED as HURRICANE_ENDOR_DED,
LTRIM ( RTRIM ( SQ_AGMT.PropertyTerritory ) ) as out_PROP_TERR,
SQ_AGMT.DwellingCoverageLimit as BUILDING_LIMIT,
SQ_AGMT.OtherStructureCoverageLimit as OTHER_STRUCT_LIMIT,
SQ_AGMT.PersonalPropertyCoverageLimit as CONTENTS_LIMIT,
SQ_AGMT.LossOfUseCoverageLimit as LOSS_USE_LIMIT,
LTRIM ( RTRIM ( SQ_AGMT.InsuranceValue ) ) as out_INSRNC_VALUE,
LTRIM ( RTRIM ( SQ_AGMT.State ) ) as out_STATE,
SQ_AGMT.ZipCode as ZIPCODE,
LTRIM ( RTRIM ( SQ_AGMT.ConstructionClass ) ) as out_CNSTRNC_CLASS,
LTRIM ( RTRIM ( SQ_AGMT.PROP_ADDR_LOC ) ) as out_PROP_ADDR_LOC,
LTRIM ( RTRIM ( SQ_AGMT.Address1 ) ) as out_STREET_ADDR,
LTRIM ( RTRIM ( SQ_AGMT.City ) ) as out_CITY,
LTRIM ( RTRIM ( SQ_AGMT.County ) ) as out_CNTY_CD,
SQ_AGMT.NumberofStories as NBR_STORIES,
SQ_AGMT.YearBuilt as YR_BUILT,
LTRIM ( RTRIM ( SQ_AGMT.OccupancyType ) ) as out_OCCPNCY_TYPE,
SQ_AGMT.SquareFootage as SQ_FOOTAGE,
LTRIM ( RTRIM ( SQ_AGMT.EXWIND_ENDOR_DESC ) ) as out_EXWND_ENDOR_DESC,
SQ_AGMT.AgentNumber as AGENT_NBR,
LTRIM ( RTRIM ( SQ_AGMT.SaleServiceCenter ) ) as out_SALE_SERVICE_CENTER,
LTRIM ( RTRIM ( SQ_AGMT.RoofYear ) ) as out_ROOF_YEAR,
LTRIM ( RTRIM ( SQ_AGMT.FoundationType ) ) as out_FOUNDATION_TYPE,
SQ_AGMT.ContentsGrade as CONTENTS_GRADE,
LTRIM ( RTRIM ( SQ_AGMT.PolicyStatus ) ) as out_PLCY_STATUS,
SQ_AGMT.IBHS_Level as IBHS_Level,
SQ_AGMT.source_record_id
FROM
SQ_AGMT
);


-- Component AON_BENFIELD_PRPTY_FEED, Type TARGET 
INSERT INTO DB_T_PROD_WRK.AON_BENFIELD_PRPTY_FEED
(
PRCS_ID,
MO_ID,
CO_CD,
PLCY_NUM,
ANNUAL_PREM,
LOB,
PLCY_TYPE,
PLCY_LMT,
PLCY_INCPTN_DT,
PLCY_EXPRD_DT,
PLCY_DEDCTB,
EAQK_ENDRSMT_DEDCTB,
WIND_HAIL_ENDRSMT_DEDCTB,
HURCN_ENDRSMT_DEDCTB,
PRPTY_TERR,
BLDG_LMT,
OTHR_STRC_LMT,
CNTNTS_LMT,
LOSS_USE_LMT,
INSRNC_VAL,
STATE,
ZIPCD,
CNSTRCTN_CLAS,
PRPTY_ADDR_LOC,
ADDR_1,
CITY,
CNTY_CD,
NBR_OF_STORIES,
YR_BUILT,
OCCPY_TYPE,
SQ_FOOTAGE,
EXWND_ENDRSMT_DESC,
AGNT_CD,
SL_SRVC_CTR,
ROOF_YEAR,
FNDTN_TYPE,
CNTNTS_GRADE,
PLCY_STS,
IBHS_LEVEL
)
SELECT
exp_HOLD_DATA.out_PRCS_ID as PRCS_ID,
exp_HOLD_DATA.MOID as MO_ID,
exp_HOLD_DATA.out_COMPANY_CODE as CO_CD,
exp_HOLD_DATA.out_POL_NBR as PLCY_NUM,
exp_HOLD_DATA.ANNUL_PREM as ANNUAL_PREM,
exp_HOLD_DATA.out_LOB as LOB,
exp_HOLD_DATA.out_POL_TYPE as PLCY_TYPE,
exp_HOLD_DATA.POL_LIMIT as PLCY_LMT,
exp_HOLD_DATA.POL_INCPT_DT as PLCY_INCPTN_DT,
exp_HOLD_DATA.EXPIRED_DT as PLCY_EXPRD_DT,
exp_HOLD_DATA.POL_DED as PLCY_DEDCTB,
exp_HOLD_DATA.EQ_ENDOR_DED as EAQK_ENDRSMT_DEDCTB,
exp_HOLD_DATA.WIND_HAIL_ENDOR_DED as WIND_HAIL_ENDRSMT_DEDCTB,
exp_HOLD_DATA.HURRICANE_ENDOR_DED as HURCN_ENDRSMT_DEDCTB,
exp_HOLD_DATA.out_PROP_TERR as PRPTY_TERR,
exp_HOLD_DATA.BUILDING_LIMIT as BLDG_LMT,
exp_HOLD_DATA.OTHER_STRUCT_LIMIT as OTHR_STRC_LMT,
exp_HOLD_DATA.CONTENTS_LIMIT as CNTNTS_LMT,
exp_HOLD_DATA.LOSS_USE_LIMIT as LOSS_USE_LMT,
exp_HOLD_DATA.out_INSRNC_VALUE as INSRNC_VAL,
exp_HOLD_DATA.out_STATE as STATE,
exp_HOLD_DATA.ZIPCODE as ZIPCD,
exp_HOLD_DATA.out_CNSTRNC_CLASS as CNSTRCTN_CLAS,
exp_HOLD_DATA.out_PROP_ADDR_LOC as PRPTY_ADDR_LOC,
exp_HOLD_DATA.out_STREET_ADDR as ADDR_1,
exp_HOLD_DATA.out_CITY as CITY,
exp_HOLD_DATA.out_CNTY_CD as CNTY_CD,
exp_HOLD_DATA.NBR_STORIES as NBR_OF_STORIES,
exp_HOLD_DATA.YR_BUILT as YR_BUILT,
exp_HOLD_DATA.out_OCCPNCY_TYPE as OCCPY_TYPE,
exp_HOLD_DATA.SQ_FOOTAGE as SQ_FOOTAGE,
exp_HOLD_DATA.out_EXWND_ENDOR_DESC as EXWND_ENDRSMT_DESC,
exp_HOLD_DATA.AGENT_NBR as AGNT_CD,
exp_HOLD_DATA.out_SALE_SERVICE_CENTER as SL_SRVC_CTR,
exp_HOLD_DATA.out_ROOF_YEAR as ROOF_YEAR,
exp_HOLD_DATA.out_FOUNDATION_TYPE as FNDTN_TYPE,
exp_HOLD_DATA.CONTENTS_GRADE as CNTNTS_GRADE,
exp_HOLD_DATA.out_PLCY_STATUS as PLCY_STS,
exp_HOLD_DATA.IBHS_Level as IBHS_LEVEL
FROM
exp_HOLD_DATA;


END; ';