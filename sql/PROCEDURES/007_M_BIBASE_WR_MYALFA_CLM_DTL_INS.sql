-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_BIBASE_WR_MYALFA_CLM_DTL_INS("PARAM_JSON" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' 
DECLARE
  PMWorkflowName STRING;
  PMSessionName STRING;
BEGIN
  SELECT 
    TRY_PARSE_JSON(:param_json):PMWorkflowName::STRING,
    ''s_m_bibase_wr_myalfa_clm_dtl_ins''
  INTO
    PMWorkflowName,
    PMSessionName;

-- Component SQ_WR_MYALFA_CLM_DTL, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_WR_MYALFA_CLM_DTL AS (
SELECT  /* adding column aliases to ensure proper downstream column references */ $1 AS SRC_IDNTFTN_SYS
       ,$2                                                                           AS V_TYPE
       ,$3                                                                           AS PLCY_FRM
       ,$4                                                                           AS MBRSHP_NUM
       ,$5                                                                           AS PLCY_NUM
       ,$6                                                                           AS PLCY_STS_CD
       ,$7                                                                           AS PLCY_STS_DESC
       ,$8                                                                           AS CLM_NUM
       ,$9                                                                           AS CLM_STS_DESC
       ,$10                                                                          AS CLM_LOSS_DT
       ,$11                                                                          AS LINE_CD
       ,$12                                                                          AS CAUS_CD
       ,$13                                                                          AS CAUS_DESC
       ,$14                                                                          AS CLM_AMT1
       ,$15                                                                          AS source_record_id
FROM
(
	SELECT  SRC.*
	       ,ROW_NUMBER() OVER (order by 1) AS source_record_id
	FROM
	(
		SELECT  *
		FROM
		(
			SELECT  CAST(''GW'' AS VARCHAR(10)) AS SRC_IDNTFTN_SYS
			       ,E. *
			FROM
			(
				SELECT  DISTINCT CAST( CASE WHEN A.INSRNC_LOB_TYPE_CD = ''HO'' THEN ''Home'' WHEN A.INSRNC_LOB_TYPE_CD = ''MH'' THEN ''MH'' WHEN A.INSRNC_LOB_TYPE_CD = ''SF'' THEN ''Fire'' END AS VARCHAR(50)) AS V_TYPE
				       ,A.PLCY_FRM
				       ,CAST(MBRSHP_NUM                                                                                                         AS VARCHAR(8)) MBRSHP_NUM
				       ,CAST(POL_NBR AS VARCHAR(25))                                                                                            AS PLCY_NUM
				       ,CASE WHEN AGMT_STS_CD IN (''ACTIVE'',''CNFRMD'',''INFORCE'',''SCHEDULED'') THEN ''1''  ELSE ''5'' END                               AS PLCY_STS_CD
				       ,COALESCE(CAST( CASE WHEN (AGMT_STS_CD IN (''INFORCE'' )) THEN ''INFORCE'' else AGMT_STS_DESC end AS VARCHAR(50)),''EXPIRED'') AS PLCY_STS_DESC
				       ,C.CLM_NUM                                                                                                               AS CLM_NUM
				       ,C.CLM_STS_TYPE_DESC                                                                                                     AS CLM_STS_DESC
				       ,TO_CHAR(C.CLM_LOSS_DT,''YYYY-MM-DD'')                                                                                     AS CLM_LOSS_DT
				       ,CAST(initcap(LINE_CD)                                                                                                   AS VARCHAR(150)) LINE_CD
				       ,CAST((PERIL_TYPE_CD)                                                                                                    AS VARCHAR(50) )AS CAUS_CD
				       ,CAST(REGEXP_REPLACE(SUBSTR(PERIL_TYPE_CD,2),''^0+'','''') ||'' - ''|| initcap(PERIL_TYPE_DESC) AS VARCHAR(250))               AS CAUS_DESC
				       ,CAST(DB_T_PROD_CORE.CLM_AMT                                                                                             AS DECIMAL(15,2)) CLM_AMT1
				FROM
				(
					SELECT  C.CLM_ID
					       ,C.CLM_NUM
					       ,AC.AGMT_ID
					       ,CLM_DT.CLM_DTTM CLM_LOSS_DT
					       ,ST.CLM_STS_TYPE_DESC
					       ,DB_T_PROD_CORE.CLM_AMT
					       ,CP.PERIL_TYPE_CD
					       ,PERIL_TYPE_DESC
					       ,HOST_AGMT_NUM
					FROM DB_T_PROD_CORE.CLM C
					JOIN
					(
						SELECT  MAX(JOB_END_DT) AS FEED_DTTM
						FROM DB_T_PROD_CORE.ETL_PRCS_CTRL
						WHERE PRCS_STS = ''SUCCEEDED''
						AND PRCS_STAG = ''EDW_DLY''
						AND SRC_NM = ''GW''
					) ECTL
					ON 1 = 1
					JOIN DB_T_PROD_CORE.AGMT_CLM AC
					ON C.CLM_ID = AC.CLM_ID AND CAST(AC.EDW_END_DTTM AS DATE) = CAST(''9999-12-31'' AS DATE)
					JOIN DB_T_PROD_CORE.AGMT AG
					ON AC.AGMT_ID = AG.AGMT_ID AND AG.AGMT_TYPE_CD = ''PPV''
					JOIN DB_T_PROD_CORE.CLM_DT CLM_DT
					ON CLM_DT.CLM_ID = C.CLM_ID AND CLM_DT.CLM_DT_TYPE_CD = ''LOSS'' AND CAST(CLM_DT.EDW_END_DTTM AS DATE) = CAST(''9999-12-31'' AS DATE)
					LEFT OUTER JOIN DB_T_PROD_CORE.CLM_STS S
					ON C.CLM_ID = S.CLM_ID AND CAST(S.EDW_END_DTTM AS DATE) = CAST(''9999-12-31'' AS DATE)
					LEFT OUTER JOIN DB_T_PROD_CORE.CLM_STS_TYPE ST
					ON S.CLM_STS_TYPE_CD = ST.CLM_STS_TYPE_CD
					LEFT OUTER JOIN
					(
						SELECT  CLM_ID
						       ,SUM(TOTAL_INCURRED) CLM_AMT
						FROM
						(
							SELECT  A.CLM_ID
							       ,SUM ( CASE WHEN (CLMTRANS.CLM_EXPSR_TRANS_SBTYPE_CD = ''PYMNT'' AND CLMTRANS.EXPSR_COST_TYPE_CD IN (''PDL'') AND CLMTRANS.EXPSR_COST_CTGY_TYPE_CD IN (''LOSS'') AND CLMLINEITM.LNITM_CTGY_TYPE_CD IN ( ''LOSS'',''DED'',''DEDRFND'',''FRMRDED'') ) THEN (CLMLINEITM.CLM_EXPSR_LNITM_AMT) ELSE 0 END ) AS LOSS_PMT_AMT
							       ,SUM ( CASE WHEN (CLMTRANS.CLM_EXPSR_TRANS_SBTYPE_CD = ''PYMNT'' AND CLMTRANS.EXPSR_COST_TYPE_CD IN (''PDL'') AND CLMTRANS.EXPSR_COST_CTGY_TYPE_CD IN (''LOSS'') AND CLMTRANS.DOES_NOT_ERODE_RSERV_IND = ''F'' ) THEN (CLMLINEITM.CLM_EXPSR_LNITM_AMT) ELSE 0 END ) AS LOSS_PMT_ERODING_AMT
							       ,(SUM ( CASE WHEN ( CLMTRANS.CLM_EXPSR_TRANS_SBTYPE_CD = ''RESRV'' ) AND CLMTRANS.EXPSR_COST_TYPE_CD = ''PDL'' AND CLMTRANS.EXPSR_COST_CTGY_TYPE_CD = ''LOSS'' THEN (CLMLINEITM.CLM_EXPSR_LNITM_AMT) ELSE 0 END ) )-LOSS_PMT_ERODING_AMT AS RSERV_AMT
							       ,(SUM( CASE WHEN (CLMTRANS.CLM_EXPSR_TRANS_SBTYPE_CD = ''PYMNT'' AND CLMTRANS.EXPSR_COST_TYPE_CD IN (''EXPNS'') AND CLMTRANS.EXPSR_COST_CTGY_TYPE_CD IN (''EXPNS'') AND CLMLINEITM.LNITM_CTGY_TYPE_CD IN ( ''SALVEXP'',''SUBROEXP'',''IAENG'',''LEGCOV'',''LEGDEF'',''RPRTS'' ) ) THEN (CLMLINEITM.CLM_EXPSR_LNITM_AMT) ELSE 0 END ) )EXPENSE_PAID
							       ,SUM( CASE WHEN ( CLMTRANS.CLM_EXPSR_TRANS_SBTYPE_CD = ''RCVRY'' AND CLMTRANS.RCVRY_CTGY_TYPE_CD IN (''SUBRO'' ,''SALVAGE'') AND CLMTRANS.EXPSR_COST_TYPE_CD IN (''EXPNS'') AND CLMTRANS.EXPSR_COST_CTGY_TYPE_CD IN (''EXPNS'') AND CLMLINEITM.LNITM_CTGY_TYPE_CD IN ( ''RCVRY'',''SALVEXP'',''SUBROEXP'' ,''IAENG'',''LEGCOV'',''LEGDEF'',''RPRTS'' ) )THEN (CLMLINEITM.CLM_EXPSR_LNITM_AMT) ELSE 0 END )+ SUM( CASE WHEN ( CLMTRANS.CLM_EXPSR_TRANS_SBTYPE_CD = ''RCVRY'' AND CLMTRANS.RCVRY_CTGY_TYPE_CD IN (''SUBRO'' ,''SALVAGE'') AND CLMTRANS.EXPSR_COST_TYPE_CD IN (''PDL'') AND CLMTRANS.EXPSR_COST_CTGY_TYPE_CD IN (''LOSS'') AND CLMLINEITM.LNITM_CTGY_TYPE_CD IN ( ''RCVRY'',''SALVEXP'',''SUBROEXP'' ) )THEN (CLMLINEITM.CLM_EXPSR_LNITM_AMT) ELSE 0 END )+SUM( CASE WHEN ( CLMTRANS.CLM_EXPSR_TRANS_SBTYPE_CD = ''RCVRY'' AND CLMTRANS.RCVRY_CTGY_TYPE_CD IN (''CREXP'') AND CLMTRANS.EXPSR_COST_TYPE_CD IN (''EXPNS'') AND CLMTRANS.EXPSR_COST_CTGY_TYPE_CD IN (''EXPNS'') AND CLMLINEITM.LNITM_CTGY_TYPE_CD IN ( ''RCVRY'',''SALVEXP'',''SUBROEXP'' ,''IAENG'',''LEGCOV'',''LEGDEF'',''RPRTS'' ) )THEN (CLMLINEITM.CLM_EXPSR_LNITM_AMT) ELSE 0 END )+SUM( CASE WHEN ( CLMTRANS.CLM_EXPSR_TRANS_SBTYPE_CD = ''RCVRY'' AND CLMTRANS.RCVRY_CTGY_TYPE_CD IN (''CRLOSS'') AND CLMTRANS.EXPSR_COST_TYPE_CD IN (''PDL'') AND CLMTRANS.EXPSR_COST_CTGY_TYPE_CD IN (''LOSS'') )THEN (CLMLINEITM.CLM_EXPSR_LNITM_AMT) ELSE 0 END )RECOVERY
							       ,(LOSS_PMT_AMT+RSERV_AMT+EXPENSE_PAID-RECOVERY) TOTAL_INCURRED
							FROM DB_T_PROD_CORE.CLM_EXPSR A
							JOIN DB_T_PROD_CORE.CLM B
							ON A.CLM_ID = B.CLM_ID
							JOIN DB_T_PROD_CORE.CLM_EXPSR_TRANS CLMTRANS
							ON A.CLM_EXPSR_ID = CLMTRANS.CLM_EXPSR_ID
							JOIN DB_T_PROD_CORE.CLM_EXPSR_TRANS_LNITM CLMLINEITM
							ON CLMTRANS.CLM_EXPSR_TRANS_ID = CLMLINEITM.CLM_EXPSR_TRANS_ID
							WHERE CAST(A.EDW_END_DTTM AS DATE) = ''9999-12-31''
							AND CAST(B.EDW_END_DTTM AS DATE) = ''9999-12-31''
							AND CAST(CLMTRANS.EDW_END_DTTM AS DATE) = ''9999-12-31''
							AND CAST(CLMLINEITM.EDW_END_DTTM AS DATE) = ''9999-12-31''
							GROUP BY  1
						)a
						GROUP BY  1
					) CA
					ON CA.CLM_ID = C.CLM_ID
					LEFT OUTER JOIN DB_T_PROD_CORE.CLM_PERIL CP
					ON C.CLM_ID = CP.CLM_ID AND CAST(CP.EDW_END_DTTM AS DATE) = CAST(''9999-12-31'' AS DATE)
					LEFT OUTER JOIN DB_T_PROD_CORE.PERIL_TYPE PT
					ON CP.PERIL_TYPE_CD = PT.PERIL_TYPE_CD AND cast(PT.EDW_END_DTTM AS DATE) = CAST(''9999-12-31'' AS DATE)
					WHERE C.CLM_STRT_DTTM <= ECTL.FEED_DTTM QUALIFY ROW_NUMBER() OVER(PARTITION BY C.CLM_NUM, CLM_LOSS_DT ORDER BY C.CLM_END_DTTM DESC, C.EDW_END_DTTM DESC) = 1
				)C
				JOIN
				(
					SELECT  A.AGMT_ID
					       ,CASE WHEN MBRSHP_TYPE_CD = ''CUST'' THEN ''C'' || LPAD(SUBSTR(LPAD(REGEXP_REPLACE(MBRSHP_NUM,''^0+'',''''),8,''0''),2,7),7,''0'')
					             WHEN MBRSHP_TYPE_CD = ''MBRSHP'' THEN LPAD(REGEXP_REPLACE(MBRSHP_NUM,''^0+'',''''),8,''0'') END AS MBRSHP_NUM
					       ,A.HOST_AGMT_NUM                                                                              AS POL_NBR
					       ,A.MODL_EFF_DTTM                                                                              AS EFF_DT
					       ,A.MODL_ACTL_END_DTTM                                                                         AS EXPN_DT
					       ,D.INSRNC_LOB_TYPE_CD                                                                         AS INSRNC_LOB_TYPE_CD
					       ,P.PROD_NAME                                                                                  AS PLCY_FRM
					       ,AS1.AGMT_STS_CD AGMT_STS_CD
					       ,AS2.AGMT_STS_DESC AGMT_STS_DESC
					       ,CASE WHEN a.MODL_EFF_DTTM > a.MODL_CRTN_DTTM THEN a.MODL_EFF_DTTM  ELSE a.MODL_CRTN_DTTM END AS NEW_AGMT_EFF_DTTM
					FROM DB_T_PROD_CORE.AGMT AS A
					JOIN
					(
						SELECT  MAX(JOB_END_DT) AS FEED_DTTM
						FROM DB_T_PROD_CORE.ETL_PRCS_CTRL
						WHERE PRCS_STS = ''SUCCEEDED''
						AND PRCS_STAG = ''EDW_DLY''
						AND SRC_NM = ''GW''
					) ECTL
					ON 1 = 1
					JOIN DB_T_PROD_CORE.AGMT TRM
					ON TRM.HOST_AGMT_NUM = A.HOST_AGMT_NUM AND TRM.TERM_NUM = A.TERM_NUM AND A.AGMT_TYPE_CD = ''PPV'' AND TRM.AGMT_TYPE_CD = ''POLTRM''
					JOIN DB_T_PROD_CORE.AGMT_STS AS AS1
					ON TRM.AGMT_ID = AS1.AGMT_ID AND AS1.AGMT_STS_STRT_DTTM <= CAST(CAST(FEED_DTTM AS DATE)+1 AS TIMESTAMPNTZ) - INTERVAL ''1 microsecond''
					JOIN DB_T_PROD_CORE.AGMT_PROD AP
					ON A.AGMT_ID = AP.AGMT_ID
					JOIN DB_T_PROD_CORE.PROD P
					ON AP.PROD_ID = P.PROD_ID
					LEFT OUTER JOIN DB_T_PROD_CORE.INSRNC_LOB_TYPE D
					ON D.INSRNC_LOB_TYPE_CD = P.INSRNC_LOB_TYPE_CD
					LEFT OUTER JOIN DB_T_PROD_CORE.AGMT_STS_TYPE AS AS2
					ON AS1.AGMT_STS_CD = AS2.AGMT_STS_CD
					LEFT OUTER JOIN DB_T_PROD_CORE.AGMT_MBRSHP AS AM
					ON A.AGMT_ID = AM.AGMT_ID AND AM.AGMT_MBRSHP_STRT_DTTM <= ECTL.FEED_DTTM AND AM.AGMT_MBRSHP_END_DTTM >= ECTL.FEED_DTTM
					LEFT OUTER JOIN DB_T_PROD_CORE.MBRSHP AS M
					ON M.MBRSHP_ID = AM.MBRSHP_ID
					WHERE p.INSRNC_LOB_TYPE_CD IN (''HO'', ''MH'', ''SF'')
					AND NEW_AGMT_EFF_DTTM <= CAST(CAST(FEED_DTTM AS DATE)+1 AS TIMESTAMPNTZ) - INTERVAL ''1 microsecond''
					AND AS1.AGMT_STS_CD <> ''CNFRMDDT'' QUALIFY ROW_NUMBER() OVER(PARTITION BY POL_NBR ORDER BY A.MODL_CRTN_DTTM DESC, A.MODL_EFF_DTTM DESC, AS1.AGMT_STS_STRT_DTTM DESC) = 1 
				)A
				ON A.POL_NBR = C.HOST_AGMT_NUM
				LEFT OUTER JOIN
				(
					SELECT  DISTINCT CLM_ID
					       ,REGEXP_REPLACE(TRIM(MAX( CASE WHEN ENDRSMNT_RNK = 1 THEN ''ENDORSEMENT, '' ELSE '''' END ) || MAX( CASE WHEN ENDRSMNT_RNK = 2 THEN ''ENDORSEMENT 2, '' ELSE '''' END ) || MAX( CASE WHEN DWLNG <> '''' or DWLNG is not null THEN ''DWELLING, '' ELSE '''' END )|| MAX( CASE WHEN OTHR_STRC <> '''' OR OTHR_STRC IS NOT NULL THEN ''OTHER STRUCTURE, '' ELSE '''' END )|| MAX( CASE WHEN PERSNL_PRPTY <> '''' OR PERSNL_PRPTY IS NOT NULL THEN ''PERSONAL PROPERTY, '' ELSE '''' END )|| MAX( CASE WHEN LOSS_OF_USE <> '''' OR LOSS_OF_USE IS NOT NULL THEN ''LOSS OF USE, '' ELSE '''' END )|| MAX( CASE WHEN PHY_DAM <> '''' OR PHY_DAM IS NOT NULL THEN ''PHYSICAL DAMAGE, '' ELSE '''' END )|| MAX( CASE WHEN THEFT <> '''' OR THEFT IS NOT NULL THEN ''THEFT, '' ELSE '''' END ) || MAX( CASE WHEN noclaim <> '''' OR noclaim IS NOT NULL THEN ''NO CLAIM, '' ELSE '''' END )|| MAX( CASE WHEN MEDCL_PMTS <> '''' OR MEDCL_PMTS IS NOT NULL THEN ''MEDICAL, '' ELSE '''' END )|| MAX( CASE WHEN LIABTY_LMTS <> '''' OR LIABTY_LMTS IS NOT NULL THEN ''PERSONAL LIABILITY, '' ELSE '''' END )|| MAX( CASE WHEN VENDOR <> '''' OR VENDOR IS NOT NULL THEN ''VENDORS SINGLE INTEREST, '' ELSE '''' END )|| MAX( CASE WHEN SCH_OTH_STR <> '''' OR SCH_OTH_STR IS NOT NULL THEN ''SCHEDULED OTHER STRUCTURE, '' ELSE '''' END )|| MAX( CASE WHEN SCH_PP <> '''' OR SCH_PP IS NOT NULL THEN ''SCHEDULED PERSONAL PROPERTY, '' ELSE '''' END )|| MAX( CASE WHEN TRIP <> '''' OR TRIP IS NOT NULL THEN ''TRIP, '' ELSE '''' END ) || MAX( CASE WHEN UNSCHEDULED <> '''' OR UNSCHEDULED IS NOT NULL THEN ''UNSCHEDULED, '' ELSE '''' END )|| MAX( CASE WHEN ADDITIONAL <> '''' OR ADDITIONAL IS NOT NULL THEN ''ADDITIONAL, '' ELSE '''' END ) || MAX( CASE WHEN OUTBULDING <> '''' OR OUTBULDING IS NOT NULL THEN ''OUTBULDING, '' ELSE '''' END )|| MAX( CASE WHEN LIVESTOCK <> '''' OR LIVESTOCK IS NOT NULL THEN ''LIVESTOCK, '' ELSE '''' END ) || MAX( CASE WHEN MACHINERY <> '''' OR MACHINERY IS NOT NULL THEN ''MACHINERY, '' ELSE '''' END )),'',+$'','''') LINE_CD
					FROM
					(
						SELECT  T1.CLM_ID
						       ,CASE WHEN F.INSRNC_CVGE_TYPE_CD = ''DRCE'' AND T1.INSRNC_LOB_TYPE_CD IN (''HO'',''MH'') AND FEAT_SBTYPE_CD = ''CL'' THEN 1
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''SD'' AND T1.INSRNC_LOB_TYPE_CD = ''MH'' AND FEAT_SBTYPE_CD = ''OPT'' AND TRIM(FEAT_DESC) = ''Hurricane-Other-5.0k'' THEN 2
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''LFCL'' AND T1.INSRNC_LOB_TYPE_CD = ''HO'' AND FEAT_SBTYPE_CD = ''CL'' THEN 3
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''SD'' AND T1.INSRNC_LOB_TYPE_CD = ''MH'' AND FEAT_SBTYPE_CD = ''OPT'' AND TRIM(FEAT_DESC) = ''Hurricane-Other-2.5k'' THEN 4  WHEN F.INSRNC_CVGE_TYPE_CD = ''TRNEND'' AND T1.INSRNC_LOB_TYPE_CD = ''MH'' AND FEAT_SBTYPE_CD = ''CL'' THEN 5
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''SD'' AND T1.INSRNC_LOB_TYPE_CD IN (''HO'',''SF'') AND FEAT_SBTYPE_CD = ''OPT'' AND TRIM(FEAT_DESC) = ''Hurricane-Other-10%'' THEN 6
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''SD'' AND T1.INSRNC_LOB_TYPE_CD = ''MH'' AND FEAT_SBTYPE_CD = ''OPT'' AND TRIM(FEAT_DESC) = ''Hurricane-Other-2.0k'' THEN 6
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''SD'' AND T1.INSRNC_LOB_TYPE_CD IN (''HO'',''SF'') AND FEAT_SBTYPE_CD = ''OPT'' AND TRIM(FEAT_DESC) = ''Hurricane-Other-5%'' THEN 8
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''SD'' AND T1.INSRNC_LOB_TYPE_CD = ''MH'' AND FEAT_SBTYPE_CD = ''OPT'' AND TRIM(FEAT_DESC) = ''Hurricane-Other-1.5k'' THEN 8
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''SD'' AND T1.INSRNC_LOB_TYPE_CD IN (''HO'',''SF'') AND FEAT_SBTYPE_CD = ''OPT'' AND TRIM(FEAT_DESC) = ''Hurricane-Other-2%'' THEN 10
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''SD'' AND T1.INSRNC_LOB_TYPE_CD = ''MH'' AND FEAT_SBTYPE_CD = ''OPT'' AND TRIM(FEAT_DESC) = ''Hurricane-Other-1.0k'' THEN 10
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''BLDRSK'' AND T1.INSRNC_LOB_TYPE_CD = ''HO'' AND FEAT_SBTYPE_CD = ''CL'' THEN 13
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''LFCL'' AND T1.INSRNC_LOB_TYPE_CD = ''MH'' AND FEAT_SBTYPE_CD = ''CL'' THEN 13
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''TENCD'' AND T1.INSRNC_LOB_TYPE_CD = ''HO'' AND FEAT_SBTYPE_CD = ''CL'' THEN 14
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''ME'' AND T1.INSRNC_LOB_TYPE_CD = ''SF'' AND FEAT_SBTYPE_CD = ''TERM'' THEN 16
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''SPCE'' AND T1.INSRNC_LOB_TYPE_CD = ''HO'' AND FEAT_SBTYPE_CD = ''CL'' THEN 17
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''EDPE'' AND T1.INSRNC_LOB_TYPE_CD = ''MH'' AND FEAT_SBTYPE_CD = ''CL'' THEN 17
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''EDPE'' AND T1.INSRNC_LOB_TYPE_CD = ''HO'' AND FEAT_SBTYPE_CD = ''CL'' THEN 19
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''SPCE'' AND T1.INSRNC_LOB_TYPE_CD = ''MH'' AND FEAT_SBTYPE_CD = ''CL'' THEN 19
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''SD'' AND T1.INSRNC_LOB_TYPE_CD = ''SF'' AND FEAT_SBTYPE_CD = ''OPT'' AND TRIM(FEAT_DESC) = ''Hurricane-Other-1.0k'' THEN 21
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''PPSLE'' AND T1.INSRNC_LOB_TYPE_CD = ''HO'' AND FEAT_SBTYPE_CD = ''OPT'' AND TRIM(FEAT_DESC) = ''Limit-Limit-2.5k'' THEN 21
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''SD'' AND T1.INSRNC_LOB_TYPE_CD = ''SF'' AND FEAT_SBTYPE_CD = ''TERM'' AND NK_SRC_KEY = ''HODW_SectionI_DedWindAndHailExcl_alfa'' THEN 22
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''PPSLE'' AND T1.INSRNC_LOB_TYPE_CD = ''HO'' AND FEAT_SBTYPE_CD = ''OPT'' AND TRIM(FEAT_DESC) = ''Limit-Limit-5k'' THEN 22
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''COVDRE'' AND T1.INSRNC_LOB_TYPE_CD = ''HO'' AND FEAT_SBTYPE_CD = ''TERM'' THEN 23
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''UOROE'' AND T1.INSRNC_LOB_TYPE_CD = ''HO'' AND FEAT_SBTYPE_CD = ''CL'' THEN 33
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''LACE'' AND T1.INSRNC_LOB_TYPE_CD = ''HO'' AND FEAT_SBTYPE_CD = ''OPT'' THEN 35
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''SOSRORP'' AND T1.INSRNC_LOB_TYPE_CD = ''HO'' AND FEAT_SBTYPE_CD = ''CL'' THEN 40
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''BUSCRPL'' AND T1.INSRNC_LOB_TYPE_CD IN (''HO'',''MH'') AND FEAT_SBTYPE_CD = ''CL'' THEN 42
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''PPRCE'' AND T1.INSRNC_LOB_TYPE_CD IN (''HO'',''MH'') AND FEAT_SBTYPE_CD = ''CL'' THEN 45
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''SOSACVLSE'' AND T1.INSRNC_LOB_TYPE_CD = ''HO'' AND FEAT_SBTYPE_CD = ''CL'' THEN 46
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''SOSACVLSE'' AND T1.INSRNC_LOB_TYPE_CD = ''MH'' AND FEAT_SBTYPE_CD = ''CL'' THEN 47
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''BUSCRPP'' AND T1.INSRNC_LOB_TYPE_CD IN (''HO'',''MH'') AND FEAT_SBTYPE_CD = ''TERM'' THEN 49
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''PPOR'' AND T1.INSRNC_LOB_TYPE_CD = ''HO'' AND FEAT_SBTYPE_CD = ''CL'' THEN 50
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''CLE'' AND T1.INSRNC_LOB_TYPE_CD = ''HO'' AND FEAT_SBTYPE_CD = ''CL'' THEN 52
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''UUFCCII'' AND T1.INSRNC_LOB_TYPE_CD = ''HO'' AND FEAT_SBTYPE_CD = ''OPT'' THEN 53
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''EQC'' AND T1.INSRNC_LOB_TYPE_CD = ''HO'' AND FEAT_SBTYPE_CD = ''OPT'' AND TRIM(FEAT_DESC) = ''Deductible-Deductible-2'' THEN 54
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''EQC'' AND T1.INSRNC_LOB_TYPE_CD = ''HO'' AND FEAT_SBTYPE_CD = ''OPT'' AND TRIM(FEAT_DESC) = ''Deductible-Deductible-5'' THEN 55
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''EQC'' AND T1.INSRNC_LOB_TYPE_CD = ''HO'' AND FEAT_SBTYPE_CD = ''OPT'' AND TRIM(FEAT_DESC) = ''Deductible-Deductible-10'' THEN 56
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''EQC'' AND T1.INSRNC_LOB_TYPE_CD = ''MH'' AND FEAT_SBTYPE_CD = ''OPT'' AND TRIM(FEAT_DESC) = ''Deductible-Deductible-10'' THEN 56
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''SPP'' AND T1.INSRNC_LOB_TYPE_CD IN (''HO'',''MH'') AND FEAT_SBTYPE_CD = ''CL'' THEN 61
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''DAEI'' AND T1.INSRNC_LOB_TYPE_CD = ''HO'' AND FEAT_SBTYPE_CD = ''OPT'' THEN 66
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''PPOR'' AND T1.INSRNC_LOB_TYPE_CD = ''MH'' AND FEAT_SBTYPE_CD = ''CL'' THEN 66
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''RROS'' AND T1.INSRNC_LOB_TYPE_CD IN (''HO'',''MH'') AND FEAT_SBTYPE_CD = ''CL'' THEN 70
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''OL'' AND T1.INSRNC_LOB_TYPE_CD IN (''HO'',''MH'') AND FEAT_SBTYPE_CD = ''CL'' THEN 71
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''FCPLNFALE'' AND T1.INSRNC_LOB_TYPE_CD IN (''HO'',''MH'') AND FEAT_SBTYPE_CD = ''TERM'' THEN 72
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''SD'' AND T1.INSRNC_LOB_TYPE_CD = ''HO'' AND FEAT_SBTYPE_CD = ''OPT'' AND TRIM(FEAT_DESC) = ''Wind, Windstorm or Hail-Other-1'' THEN 76
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''SD'' AND T1.INSRNC_LOB_TYPE_CD = ''HO'' AND FEAT_SBTYPE_CD = ''OPT'' AND TRIM(FEAT_DESC) = ''Wind, Windstorm or Hail-Other-2'' THEN 77
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''SD'' AND T1.INSRNC_LOB_TYPE_CD = ''HO'' AND FEAT_SBTYPE_CD = ''OPT'' AND TRIM(FEAT_DESC) = ''Wind, Windstorm or Hail-Other-5'' THEN 78
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''SD'' AND T1.INSRNC_LOB_TYPE_CD = ''HO'' AND FEAT_SBTYPE_CD = ''OPT'' AND TRIM(FEAT_DESC) = ''Wind, Windstorm or Hail-Other-10'' THEN 79
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''ACVROOF'' AND T1.INSRNC_LOB_TYPE_CD = ''HO'' AND FEAT_SBTYPE_CD = ''CL'' THEN 85
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''PI'' AND T1.INSRNC_LOB_TYPE_CD IN (''HO'',''MH'') AND FEAT_SBTYPE_CD = ''TERM'' THEN 87
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''SDRE'' AND T1.INSRNC_LOB_TYPE_CD IN (''HO'',''MH'',''SF'') AND FEAT_SBTYPE_CD = ''CL'' THEN 88
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''SD'' AND T1.INSRNC_LOB_TYPE_CD IN (''HO'',''MH'') AND FEAT_SBTYPE_CD = ''TERM'' AND NK_SRC_KEY = ''HODW_SectionI_DedWindAndHailExcl_alfa'' THEN 90
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''ME'' AND T1.INSRNC_LOB_TYPE_CD IN (''HO'',''MH'') AND FEAT_SBTYPE_CD = ''TERM'' THEN 91
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''HDCL'' AND T1.INSRNC_LOB_TYPE_CD IN (''HO'',''MH'') AND FEAT_SBTYPE_CD = ''OPT'' THEN 93
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''FIL'' AND T1.INSRNC_LOB_TYPE_CD IN (''HO'',''MH'') AND FEAT_SBTYPE_CD = ''CL'' THEN 92
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''HCIL'' AND T1.INSRNC_LOB_TYPE_CD IN (''HO'',''MH'') AND FEAT_SBTYPE_CD = ''CL'' THEN 95
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''SNKHL'' AND T1.INSRNC_LOB_TYPE_CD = ''HO'' AND FEAT_SBTYPE_CD = ''CL'' THEN 96
						             WHEN F.INSRNC_CVGE_TYPE_CD = ''ADDRPL'' AND T1.INSRNC_LOB_TYPE_CD IN (''HO'',''MH'') AND FEAT_SBTYPE_CD = ''CL'' THEN 99 END         AS ENDRSMNT_NUM
						       ,CASE WHEN ENDRSMNT_NUM IS NOT NULL THEN ''E''  ELSE ''N'' END ENDRSMNT_CD
						       ,CASE WHEN F.INSRNC_CVGE_TYPE_CD = ''MED'' AND NK_SRC_KEY = ''HOLI_Med_Pay_HOE'' THEN ''MED'' END                                        AS MEDCL_PMTS
						       ,CASE WHEN F.INSRNC_CVGE_TYPE_CD = ''LOU'' AND NK_SRC_KEY = ''HODW_Loss_Of_Use_HOE'' THEN ''LOU'' END                                    AS LOSS_OF_USE
						       ,CASE WHEN F.INSRNC_CVGE_TYPE_CD = ''DWELL'' AND NK_SRC_KEY = ''HODW_Dwelling_Cov_HOE'' THEN ''DWL'' END                                 AS DWLNG
						       ,CASE WHEN F.INSRNC_CVGE_TYPE_CD = ''OS'' AND NK_SRC_KEY = ''HODW_Other_Structures_HOE'' THEN ''OS'' END                                 AS OTHR_STRC
						       ,CASE WHEN F.INSRNC_CVGE_TYPE_CD = ''PP'' AND NK_SRC_KEY = ''HODW_Personal_Property_HOE'' THEN ''PP'' END                                AS PERSNL_PRPTY
						       ,CASE WHEN F.INSRNC_CVGE_TYPE_CD = ''LIAB'' AND NK_SRC_KEY = ''HOLI_Personal_Liability_HOE'' THEN ''LIAB'' END                           AS LIABTY_LMTS
						       ,CASE WHEN F.INSRNC_CVGE_TYPE_CD = ''SD'' AND NK_SRC_KEY IN (''HODW_OtherPerilsDedValue_alfa'',''HODW_WindHailDedValue_alfa'',''HODW_HurricaneDedValue_alfa'') THEN ''SD'' END AS DEDCTB
						       ,CASE WHEN F.INSRNC_CVGE_TYPE_CD = ''PD'' AND NK_SRC_KEY LIKE ''%HOLI_PhysDamToPropertyOfOthers_alfa%'' THEN ''PHYSICAL DAMAGE, '' END PHY_DAM
						       ,CASE WHEN F.INSRNC_CVGE_TYPE_CD = ''THFT'' AND NK_SRC_KEY LIKE ''%HODW_TheftLimit_alfa%'' THEN ''THEFT, '' END THEFT
						       ,CASE WHEN NK_SRC_KEY LIKE ''%NOCLAIM%'' THEN ''NO CLAIM, '' END noclaim
						       ,CASE WHEN NK_SRC_KEY LIKE ''%VENDOR%'' THEN ''VENDORS SINGLE INTEREST, '' END VENDOR
						       ,CASE WHEN NK_SRC_KEY LIKE ''%SCHEDULED%other%'' THEN ''SCHEDULED OTHER STRUCTURE, '' END SCH_OTH_STR
						       ,CASE WHEN NK_SRC_KEY LIKE ''%HOSI_ScheduledProperty %'' THEN ''SCHEDULED PERSONAL PROPERTY, '' END SCH_PP
						       ,CASE WHEN NK_SRC_KEY LIKE ''%TRIP%'' THEN ''TRIP, '' END TRIP
						       ,CASE WHEN NK_SRC_KEY LIKE ''%UNSCHEDULE%'' THEN ''UNSCHEDULED, '' END UNSCHEDULED
						       ,CASE WHEN NK_SRC_KEY LIKE ''%ADDITIONAL%'' THEN ''ADDITIONAL, '' END ADDITIONAL
						       ,CASE WHEN NK_SRC_KEY LIKE ''%HOLI_FarmersCompLiabSchedHasFarmOutbuildings_alfa%'' THEN ''OUTBULDING, '' END OUTBULDING
						       ,CASE WHEN NK_SRC_KEY LIKE ''%HOLI_FarmersCompLiabSchedHasAnimals_alfa%'' THEN ''LIVESTOCK, '' END LIVESTOCK
						       ,CASE WHEN NK_SRC_KEY LIKE ''%MACHINERY%'' THEN ''MACHINERY, '' END MACHINERY
						       ,CASE WHEN ENDRSMNT_NUM IS NOT NULL THEN ROW_NUMBER() OVER (PARTITION BY CLM_ID,ENDRSMNT_CD ORDER BY ENDRSMNT_NUM ASC)  ELSE 0 END AS ENDRSMNT_RNK
						FROM
						(
							SELECT  CC.CLM_ID
							       ,CVGE_FEAT_ID FEAT_ID
							       ,AC.AGMT_ID AGMT_ID
							       ,PROD_NAME
							       ,P.INSRNC_LOB_TYPE_CD
							FROM DB_T_PROD_CORE.CLM_CVGE CC
							JOIN
							(
								SELECT  MAX(JOB_END_DT) AS FEED_DTTM
								FROM DB_T_PROD_CORE.ETL_PRCS_CTRL
								WHERE PRCS_STS = ''SUCCEEDED''
								AND PRCS_STAG = ''EDW_DLY''
								AND SRC_NM = ''GW''
							)ECTL
							ON 1 = 1
							JOIN DB_T_PROD_CORE.AGMT_CLM AS AC
							ON CC.CLM_ID = AC.CLM_ID AND CLM_CVGE_STRT_DTTM <= ECTL.FEED_DTTM
							JOIN DB_T_PROD_CORE.AGMT_PROD AS AP
							ON AP.AGMT_ID = AC.AGMT_ID
							JOIN DB_T_PROD_CORE.PROD P
							ON AP.PROD_ID = P.PROD_ID
							WHERE P.INSRNC_LOB_TYPE_CD IN (''HO'', ''MH'', ''SF'') QUALIFY ROW_NUMBER() OVER(PARTITION BY CC.CLM_ID, CC.CVGE_FEAT_ID ORDER BY CC.EDW_END_dTTM DESC, CC.TRANS_STRT_DTTM DESC ) = 1
						) T1
						JOIN DB_T_PROD_CORE.FEAT AS F
						ON T1.FEAT_ID = F.FEAT_ID
					) AS T2
					GROUP BY  1
				)COV
				ON C.CLM_ID = COV.CLM_ID
			) AS E
			UNION ALL
			SELECT  ''DB2'' AS SRC_IDNTFTN_SYS
			       ,V_TYPE
			       ,PLCY_FRM
			       ,MBRSHP_NUM
			       ,L.PLCY_NUM
			       ,CASE WHEN (E.PLCY_NUM IS NOT NULL) THEN E.PLCY_STS_CD  ELSE L.PLCY_STS_CD END PLCY_STS_CD
			       ,CASE WHEN (E.PLCY_NUM IS NOT NULL) THEN E.PLCY_STS_DESC  ELSE L.PLCY_STS_DESC END PLCY_STS_DESC
			       ,CLM_NUM
			       ,CLM_STS_DESC
			       ,CLM_LOSS_DT
			       ,LINE_CD
			       ,CAUS_CD
			       ,CAUS_DESC
			       ,CLM_AMT1
			FROM
			(
				SELECT  V_TYPE
				       ,PLCY_FRM
				       ,MBRSHP_NUM
				       ,PLCY_NUM
				       ,CAST(PLCY_STS_CD AS VARCHAR(2))                                                                       AS PLCY_STS_CD
				       ,CASE WHEN UPPER(TRIM(PS_STS.DESC1)) = ''INFORCE'' THEN ''IN FORCE''
				             WHEN UPPER(TRIM(PS_STS.DESC1)) = ''CANCELLED'' THEN ''CANCELED''  ELSE UPPER(TRIM(PS_STS.DESC1)) END AS PLCY_STS_DESC
				       ,CAST('''' AS VARCHAR(50))                                                                               AS CLM_NUM
				       ,CAST('''' AS VARCHAR(50))                                                                               AS CLM_STS_DESC
				       ,CLM_LOSS_DT
				       ,INITCAP( CASE WHEN TRIM(LINE_CD) = '''' THEN NULL ELSE LINE_CD END )                                    AS LINE_CD
				       ,T.CAUS_CD
				       ,CASE WHEN V_TYPE = ''Fire'' THEN CAST(REGEXP_REPLACE(CAUS_CD,''^0+'','''')||'' - ''||INITCAP(TRIM(FIRE_CAUS.DESC1)) AS VARCHAR(250))  ELSE CAST(REGEXP_REPLACE(CAUS_CD,''^0+'','''')||'' - ''||INITCAP(TRIM(PS_CAUS.DESC1)) AS VARCHAR(250)) END AS CAUS_DESC
				       ,CLM_AMT1
				FROM
				(
					SELECT  DISTINCT CAST(''Home'' AS VARCHAR(50))          AS V_TYPE
					       ,CAST( CASE WHEN SUBSTR(TRIM(HO_PRI_CLASS),1,1) IN (''2'') THEN ''HO2'' WHEN SUBSTR(TRIM(HO_PRI_CLASS),1,1) IN (''3'',''H'') THEN ''HO3'' WHEN SUBSTR(TRIM(HO_PRI_CLASS),1,1) IN (''4'') THEN ''HO4'' WHEN SUBSTR(TRIM(HO_PRI_CLASS),1,1) IN (''5'',''E'') THEN ''HO5'' WHEN SUBSTR(TRIM(HO_PRI_CLASS),1,1) IN (''6'',''F'') THEN ''HO6'' WHEN SUBSTR(TRIM(HO_PRI_CLASS),1,1) IN (''8'',''C'') THEN ''HO8'' END AS VARCHAR(20)) AS PLCY_FRM
					       ,COALESCE(POL.PC_MEMBER_NUMBER,''99999999'')     AS MBRSHP_NUM
					       ,CAST(DB_T_CORE_DM_PROD.POLICY AS VARCHAR(25)) AS PLCY_NUM
					       ,POL.PC_STATUS                                 AS PLCY_STS_CD
					       ,TO_CHAR(DATE(ACCIDENT_DT_CYMD),''YYYY-MM-DD'')  AS CLM_LOSS_DT
					       ,REGEXP_REPLACE(TRIM( CASE WHEN TRIM(END_NBR_CLM) <> '''' THEN ''ENDORSEMENT, '' ELSE '''' END || CASE WHEN TRIM(END_NBR2_CLM) <> '''' THEN ''ENDORSEMENT 2, '' ELSE '''' END || CASE WHEN TRIM(DWL_CLM) <> '''' THEN ''DWELLING, '' ELSE '''' END || CASE WHEN TRIM(OTH_STRUC_CLM) <> '''' THEN ''OTHER STRUCTURE, '' ELSE '''' END || CASE WHEN TRIM(PERS_PROP_CLM) <> '''' THEN ''PERSONAL PROPERTY, '' ELSE '''' END || CASE WHEN TRIM(LOSS_OF_USE_CLM) <> '''' THEN ''LOSS OF USE, '' ELSE '''' END || CASE WHEN TRIM(PHYS_DMG_CLM) <> '''' THEN ''PHYSICAL DAMAGE, '' ELSE '''' END || CASE WHEN TRIM(THEFT_CLM) <> '''' THEN ''THEFT, '' ELSE '''' END || CASE WHEN TRIM(NO_CLM_CD) <> '''' THEN ''NO CLAIM, '' ELSE '''' END || CASE WHEN TRIM(MED_CLM) <> '''' THEN ''MEDICAL, '' ELSE '''' END || CASE WHEN TRIM(PERS_LIAB_CLM) <> '''' THEN ''PERSONAL LIABILITY, '' ELSE '''' END ),'',+$'','''') AS LINE_CD
					       ,CAST(CAUSE_CD AS VARCHAR(4))                  AS CAUS_CD
					       ,CAST(CLM_AMOUNT AS DECIMAL(15,2))             AS CLM_AMT1
					FROM DB_T_STAG_MEMBXREF_PROD.HO_MST_CLMDET AS CLM
					LEFT OUTER JOIN DB_T_CORE_MEMBXREF_PROD.HOMEPOLS AS POL
					ON DB_T_CORE_DM_PROD.POLICY = POL.SC_POLICY_NUM
					WHERE SUBSTR(DB_T_CORE_DM_PROD.POLICY, 1, 1) = ''H''
					AND (CLM_LOSS_DT IS NOT NULL OR CLM_AMT1 <> 0) 
					UNION ALL
					SELECT  DISTINCT CAST(''MH'' AS VARCHAR(50))                                              AS V_TYPE
					       ,CASE WHEN MH_CLASS_FORM IN (''3'',''4'',''7'',''9'') THEN ''MH''||TRIM(MH_CLASS_FORM) END AS PLCY_FRM
					       ,COALESCE(POL.PC_MEMBER_NUMBER,''99999999'')                                       AS MBRSHP_NUM
					       ,CLM.SC_POLICY_NUM                                                               AS PLCY_NUM
					       ,POL.PC_STATUS                                                                   AS PLCY_STS_CD
					       ,TO_CHAR(DATE(MH_ACCIDENT_DT_MDY),''YYYY-MM-DD'')                                  AS CLM_LOSS_DT
					       ,REGEXP_REPLACE(TRIM( CASE WHEN TRIM(MH_END_NBR_CLM) <> '''' THEN ''ENDORSEMENT, '' ELSE '''' END || CASE WHEN TRIM(MH_END_NBR2_CLM) <> '''' THEN ''ENDORSEMENT 2, '' ELSE '''' END || CASE WHEN TRIM(MH_DWL_CLM) <> '''' THEN ''DWELLING, '' ELSE '''' END || CASE WHEN TRIM(MH_OTH_STRUC_CLM) <> '''' THEN ''OTHER STRUCTURE, '' ELSE '''' END || CASE WHEN TRIM(MH_PERS_PROP_CLM) <> '''' THEN ''PERSONAL PROPERTY, '' ELSE '''' END || CASE WHEN TRIM(MH_LOSS_OF_USE_CLM) <> '''' THEN ''LOSS OF USE, '' ELSE '''' END || CASE WHEN TRIM(MH_LIAB_MED_CLM) <> '''' THEN ''MEDICAL LIABILITY, '' ELSE '''' END || CASE WHEN TRIM(MH_VENDOR_SI_CLM) <> '''' THEN ''VENDORS SINGLE INTEREST, '' ELSE '''' END || CASE WHEN TRIM(MH_SCH_OS_CLM) <> '''' THEN ''SCHEDULED OTHER STRUCTURE, '' ELSE '''' END || CASE WHEN TRIM(MH_SCH_PP_CLM) <> '''' THEN ''SCHEDULED PERSONAL PROPERTY, '' ELSE '''' END || CASE WHEN TRIM(MH_TRIP_CLM) <> '''' THEN ''TRIP, '' ELSE '''' END || CASE WHEN TRIM(MH_NO_CLM) <> '''' THEN ''NO CLAIM, '' ELSE '''' END ),'',+$'','''') AS LINE_CD
					       ,MH_CAUSE_CD                                                                     AS CAUS_CD
					       ,MH_UNP_CLM_AMOUNT                                                               AS CLM_AMT1
					FROM DB_T_STAG_MEMBXREF_PROD.MANHOMECLAIMDET AS CLM
					LEFT OUTER JOIN DB_T_CORE_MEMBXREF_PROD.MANHOMEPOLS AS POL
					ON CLM.SC_POLICY_NUM = POL.SC_POLICY_NUM
					WHERE (CLM_LOSS_DT IS NOT NULL OR CLM_AMT1 <> 0) 
					UNION ALL
					SELECT  DISTINCT CAST(''Farm'' AS VARCHAR(50))                           AS V_TYPE
					       ,CAST(NULL AS VARCHAR(20))                                      AS PLCY_FRM
					       ,COALESCE(POL.PC_MEMBER_NUMBER,''99999999'')                      AS MBRSHP_NUM
					       ,CLM.SC_POLICY_NUM                                              AS PLCY_NUM
					       ,POL.PC_STATUS                                                  AS PLCY_STS_CD
					       ,CASE WHEN CAST(SUBSTR(TO_VARCHAR(RFD_DOL),5,2) AS INTEGER) > 70 THEN ''19'' || SUBSTR(TO_VARCHAR(RFD_DOL),5,2) || ''-'' || SUBSTR(TO_VARCHAR(RFD_DOL),1,2) || ''-'' || SUBSTR(TO_VARCHAR(RFD_DOL),3,2)  ELSE ''20'' || SUBSTR(TO_VARCHAR(RFD_DOL),5,2) || ''-'' || SUBSTR(TO_VARCHAR(RFD_DOL),1,2) || ''-'' || SUBSTR(TO_VARCHAR(RFD_DOL),3,2) END AS CLM_LOSS_DT
					       ,REGEXP_REPLACE(TRIM( CASE WHEN TRIM(RFD_DWELL_CLM) <> '''' THEN ''DWELLING, '' ELSE '''' END || CASE WHEN TRIM(RFD_UNSCH_CLM) <> '''' THEN ''UNSCHEDULED, '' ELSE '''' END || CASE WHEN TRIM(RFD_ADDL_CLM) <> '''' THEN ''ADDITIONAL, '' ELSE '''' END || CASE WHEN TRIM(RFD_LIAB_CLM) <> '''' THEN ''LIABILITY, '' ELSE '''' END || CASE WHEN TRIM(RFD_MED_CLM) <> '''' THEN ''MEDICAL, '' ELSE '''' END || CASE WHEN TRIM(RFD_OUTBLDG_CLM) <> '''' THEN ''OUTBULDING, '' ELSE '''' END || CASE WHEN TRIM(RFD_PD_CLM) <> '''' THEN ''PROPERTY DAMAGE, '' ELSE '''' END || CASE WHEN TRIM(RFD_NMED_CLM) <> '''' THEN ''NAMED MEDICAL, '' ELSE '''' END || CASE WHEN TRIM(RFD_LVSTK_CLM) <> '''' THEN ''LIVESTOCK, '' ELSE '''' END || CASE WHEN TRIM(RFD_MACH_CLM) <> '''' THEN ''MACHINERY, '' ELSE '''' END ),'',+$'','''') AS LINE_CD
					       ,CASE WHEN TRIM(RFD_DWELL_CLM) <> '''' THEN TRIM(RFD_DWELL_CLM)
					             WHEN TRIM(RFD_UNSCH_CLM) <> '''' THEN TRIM(RFD_UNSCH_CLM)
					             WHEN TRIM(RFD_ADDL_CLM) <> '''' THEN TRIM(RFD_ADDL_CLM)
					             WHEN TRIM(RFD_LIAB_CLM) <> '''' THEN TRIM(RFD_LIAB_CLM)
					             WHEN TRIM(RFD_MED_CLM) <> '''' THEN TRIM(RFD_MED_CLM)
					             WHEN TRIM(RFD_OUTBLDG_CLM) <> '''' THEN TRIM(RFD_OUTBLDG_CLM)
					             WHEN TRIM(RFD_PD_CLM) <> '''' THEN TRIM(RFD_PD_CLM)
					             WHEN TRIM(RFD_NMED_CLM) <> '''' THEN TRIM(RFD_NMED_CLM)
					             WHEN TRIM(RFD_LVSTK_CLM) <> '''' THEN TRIM(RFD_LVSTK_CLM)
					             WHEN TRIM(RFD_MACH_CLM) <> '''' THEN TRIM(RFD_MACH_CLM) END AS CAUS_CD
					       ,CAST(RFD_AMT_PYMNT AS DECIMAL(15,2))                           AS CLM_AMT1
					FROM DB_T_STAG_MEMBXREF_PROD.FARMPOLCLM AS CLM
					LEFT OUTER JOIN DB_T_CORE_MEMBXREF_PROD.FARMPOLS POL
					ON CLM.SC_POLICY_NUM = POL.SC_POLICY_NUM
					WHERE (CLM_LOSS_DT IS NOT NULL OR CLM_AMT1 <> 0) 
					UNION ALL
					SELECT  DISTINCT CAST(''Fire'' AS VARCHAR(50))      AS V_TYPE
					       ,CAST(PSL_FRM.DESC1 AS VARCHAR(150))       AS PLCY_FRM
					       ,COALESCE(POL.PC_MEMBER_NUMBER,''99999999'') AS MBRSHP_NUM
					       ,CLM.SC_POLICY_NUM                         AS PLCY_NUM
					       ,POL.PC_STATUS                             AS PLCY_STS_CD
					       ,TO_CHAR(DATE(FI_CLAIM_DOL),''YYYY-MM-DD'')  AS CLM_LOSS_DT
					       ,REGEXP_REPLACE(TRIM( CASE WHEN FI_PART_FIRE <> 1 THEN '''' ELSE ''PARTIAL FIRE, '' END || CASE WHEN FI_EXT_COV <> 1 THEN '''' ELSE ''EXTENDED COVERAGE, '' END || CASE WHEN FI_LIGHTN <> 1 THEN '''' ELSE ''LIGHTNING, '' END || CASE WHEN FI_TOT_FIRE <> 1 THEN '''' ELSE ''TOTAL FIRE, '' END || CASE WHEN FI_OTHER_PER <> 1 THEN '''' ELSE ''OTHER PERIL, '' END ),'',+$'','''') AS LINE_CD
					       ,FI_CAUSE_CD                               AS CAUS_CD
					       ,FI_CLAIM_AMT                              AS CLM_AMT1
					FROM DB_T_STAG_MEMBXREF_PROD.FIREPOLCLMDETAILS AS CLM
					LEFT OUTER JOIN DB_T_CORE_MEMBXREF_PROD.FIREPOLS AS POL
					ON CLM.SC_POLICY_NUM = POL.SC_POLICY_NUM
					LEFT OUTER JOIN DB_T_STAG_MEMBXREF_PROD.FIREPOLITEMS AS ITEMS
					ON POL.SC_POLICY_NUM = ITEMS.SC_POLICY_NUM AND ITEMS.FI_CLASS <> ''''
					LEFT OUTER JOIN DB_T_STAG_MEMBXREF_PROD.PS_LOOKUP PSL_FRM
					ON PSL_FRM.FIELD_VALUE = SUBSTR(ITEMS.FI_CLASS, 4, 1) AND PSL_FRM.FIELD_NAME = ''FI_FORM''
					WHERE CLM_LOSS_DT IS NOT NULL OR CLM_AMT1 <> 0 
				) T
				LEFT OUTER JOIN DB_T_STAG_MEMBXREF_PROD.PS_LOOKUP AS PS_STS
				ON T.PLCY_STS_CD = PS_STS.FIELD_VALUE AND PS_STS.FIELD_NAME = ''PC_STATUS''
				LEFT OUTER JOIN DB_T_STAG_MEMBXREF_PROD.PS_LOOKUP AS PS_CAUS
				ON REGEXP_REPLACE(T.CAUS_CD, ''^0+'', '''') = REGEXP_REPLACE(PS_CAUS.FIELD_VALUE, ''^0+'', '''') AND PS_CAUS.FIELD_NAME = ''CAUSE_CD''
				LEFT OUTER JOIN DB_T_STAG_MEMBXREF_PROD.PS_LOOKUP AS FIRE_CAUS
				ON REGEXP_REPLACE(T.CAUS_CD, ''^0+'', '''') = REGEXP_REPLACE(FIRE_CAUS.FIELD_VALUE, ''^0+'', '''') AND FIRE_CAUS.FIELD_NAME = ''FIRE_CAUSE_CD''
			) AS L
			LEFT OUTER JOIN
			(
				SELECT  PPV.HOST_AGMT_NUM                                                                                           AS PLCY_NUM
				       ,CASE WHEN COALESCE(A_S.AGMT_STS_CD,''~'') IN (''ACTIVE'',''CNFRMD'',''INFORCE'',''SCHEDULED'') THEN ''1''  ELSE ''5'' END AS PLCY_STS_CD
				       ,STS_TYPE.AGMT_STS_DESC PLCY_STS_DESC
				FROM
				(
					SELECT  T1.HOST_AGMT_NUM
					       ,T1.TERM_NUM
					       ,T1.AGMT_ID
					       ,T1.MODL_CRTN_DTTM
					       ,T1.MODL_EFF_DTTM
					       ,T1.AGMT_EFF_DTTM
					       ,CASE WHEN T1.MODL_EFF_DTTM > T1.MODL_CRTN_DTTM THEN T1.MODL_EFF_DTTM  ELSE T1.MODL_CRTN_DTTM END AS NEW_AGMT_EFF_DTTM
					FROM DB_T_PROD_CORE.AGMT T1,
					(
						SELECT  CAST(CAST(MAX(JOB_END_DT) AS DATE)+1 AS TIMESTAMP(6)) - INTERVAL ''0.000001 SECONDS'' AS FEED_DTTM
						FROM DB_T_PROD_CORE.ETL_PRCS_CTRL
						WHERE PRCS_STS = ''SUCCEEDED''
						AND PRCS_STAG = ''EDW_DLY''
						AND SRC_NM = ''GW''
					) E
					WHERE T1.AGMT_TYPE_CD = ''PPV''
					AND T1.SRC_SYS_CD = ''GWPC''
					AND E.FEED_DTTM BETWEEN AGMT_EFF_DTTM AND AGMT_PLND_EXPN_DTTM
					AND T1.TRANS_STRT_DTTM = (
					SELECT  MIN(T2.TRANS_STRT_DTTM)
					FROM DB_T_PROD_CORE.AGMT T2
					WHERE T1.AGMT_ID = T2.AGMT_ID) AND NEW_AGMT_EFF_DTTM <= E.FEED_DTTM QUALIFY ROW_NUMBER() OVER(PARTITION BY T1.HOST_AGMT_NUM ORDER BY T1.MODL_CRTN_DTTM DESC ) = 1
				) PPV
				INNER JOIN
				(
					SELECT  HOST_AGMT_NUM
					       ,TERM_NUM
					       ,AGMT_ID
					       ,FEED_DTTM
					FROM DB_T_PROD_CORE.AGMT A,
					(
						SELECT  CAST(CAST(MAX(JOB_END_DT) AS DATE)+1 AS TIMESTAMP(6)) - INTERVAL ''0.000001 SECONDS'' AS FEED_DTTM
						FROM DB_T_PROD_CORE.ETL_PRCS_CTRL
						WHERE PRCS_STS = ''SUCCEEDED''
						AND PRCS_STAG = ''EDW_DLY''
						AND SRC_NM = ''GW''
					) E
					WHERE AGMT_TYPE_CD = ''POLTRM''
					AND E.FEED_DTTM BETWEEN AGMT_EFF_DTTM AND AGMT_PLND_EXPN_DTTM
					GROUP BY  1
					         ,2
					         ,3
				) TRM
				ON PPV.HOST_AGMT_NUM = TRM.HOST_AGMT_NUM AND PPV.TERM_NUM = TRM.TERM_NUM
				INNER JOIN DB_T_PROD_CORE.AGMT_STS A_S
				ON TRM.AGMT_ID = A_S.AGMT_ID AND A_S.AGMT_STS_STRT_DTTM <= TRM.FEED_DTTM AND A_S.AGMT_STS_CD <> ''CNFRMDDT''
				INNER JOIN DB_T_PROD_CORE.AGMT_STS_TYPE STS_TYPE
				ON A_S.AGMT_STS_CD = STS_TYPE.AGMT_STS_CD AND STS_TYPE.EDW_END_DTTM = ''9999-12-31 23:59:59.999999'' QUALIFY ROW_NUMBER() OVER(PARTITION BY PPV.AGMT_ID ORDER BY A_S.AGMT_STS_STRT_DTTM DESC) = 1
			) E
			ON L.PLCY_NUM = E.PLCY_NUM
		) CMP
	) SRC
) );


-- Component exp_pass_src_to_tgt, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_pass_src_to_tgt AS
(
SELECT
SQ_WR_MYALFA_CLM_DTL.SRC_IDNTFTN_SYS as SRC_IDNTFTN_SYS,
SQ_WR_MYALFA_CLM_DTL.V_TYPE as V_TYPE,
SQ_WR_MYALFA_CLM_DTL.PLCY_FRM as PLCY_FRM,
SQ_WR_MYALFA_CLM_DTL.MBRSHP_NUM as MBRSHP_NUM,
SQ_WR_MYALFA_CLM_DTL.PLCY_NUM as PLCY_NUM,
SQ_WR_MYALFA_CLM_DTL.PLCY_STS_CD as PLCY_STS_CD,
SQ_WR_MYALFA_CLM_DTL.PLCY_STS_DESC as PLCY_STS_DESC,
SQ_WR_MYALFA_CLM_DTL.CLM_NUM as CLM_NUM,
SQ_WR_MYALFA_CLM_DTL.CLM_STS_DESC as CLM_STS_DESC,
SQ_WR_MYALFA_CLM_DTL.CLM_LOSS_DT as CLM_LOSS_DT,
SQ_WR_MYALFA_CLM_DTL.LINE_CD as LINE_CD,
SQ_WR_MYALFA_CLM_DTL.CAUS_CD as CAUS_CD,
SQ_WR_MYALFA_CLM_DTL.CAUS_DESC as CAUS_DESC,
SQ_WR_MYALFA_CLM_DTL.CLM_AMT1 as CLM_AMT1,
SQ_WR_MYALFA_CLM_DTL.source_record_id
FROM
SQ_WR_MYALFA_CLM_DTL
);


-- Component WR_MYALFA_CLM_DTL, Type TARGET 
INSERT INTO DB_V_PROD_PRES.WR_MYALFA_CLM_DTL
(
SRC_IDNTFTN_SYS,
V_TYPE,
PLCY_FRM,
MBRSHP_NUM,
PLCY_NUM,
PLCY_STS_CD,
PLCY_STS_DESC,
CLM_NUM,
CLM_STS_DESC,
CLM_LOSS_DT,
LINE_CD,
CAUS_CD,
CAUS_DESC,
CLM_AMT1
)
SELECT
exp_pass_src_to_tgt.SRC_IDNTFTN_SYS as SRC_IDNTFTN_SYS,
exp_pass_src_to_tgt.V_TYPE as V_TYPE,
exp_pass_src_to_tgt.PLCY_FRM as PLCY_FRM,
exp_pass_src_to_tgt.MBRSHP_NUM as MBRSHP_NUM,
exp_pass_src_to_tgt.PLCY_NUM as PLCY_NUM,
exp_pass_src_to_tgt.PLCY_STS_CD as PLCY_STS_CD,
exp_pass_src_to_tgt.PLCY_STS_DESC as PLCY_STS_DESC,
exp_pass_src_to_tgt.CLM_NUM as CLM_NUM,
exp_pass_src_to_tgt.CLM_STS_DESC as CLM_STS_DESC,
exp_pass_src_to_tgt.CLM_LOSS_DT as CLM_LOSS_DT,
exp_pass_src_to_tgt.LINE_CD as LINE_CD,
exp_pass_src_to_tgt.CAUS_CD as CAUS_CD,
exp_pass_src_to_tgt.CAUS_DESC as CAUS_DESC,
exp_pass_src_to_tgt.CLM_AMT1 as CLM_AMT1
FROM
exp_pass_src_to_tgt;


END; ';