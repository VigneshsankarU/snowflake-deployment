-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_ECTL_MISPREM_HEADER("RUN_ID" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' DECLARE RUN_DATE date;
 PMMAPPINGNAME varchar;
  ACT_PROJ_ID varchar;
    BATCH_ACTIVE_IND varchar;
BEGIN 

RUN_DATE:=''2025-09-08''; 
PMMAPPINGNAME:=''M_ECTL_MISPREM_HEADER''; 
BATCH_ACTIVE_IND:=(select ectl_active_ind from DB_T_CTRL_FIN_PROD.ECTL_BATCH_INFO where ECTL_BATCH_ID= :run_id); 
ACT_PROJ_ID:=(select ectl_proj_id from DB_T_CTRL_FIN_PROD.ECTL_BATCH_INFO where ECTL_BATCH_ID= :run_id); 

-- Component SQ_Shortcut_to_ECTL_MISPREM_HEADER, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_Shortcut_to_ECTL_MISPREM_HEADER AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as DAILY_FEED_IND,
$2 as FROM_DATE,
$3 as TO_DATE,
$4 as RUN_DATE,
$5 as HDR_IDENTIFIER,
$6 as PRGM_NAME,
$7 as PRGM_LEVEL,
$8 as CREATE_TS,
$9 as ACCOUNTING_YR,
$10 as ACCOUNTING_MO,
$11 as CLOSEOUT_SEQ_NBR,
$12 as CYC_END_DT,
$13 as END_TS,
$14 as ACL_RUN_TS,
$15 as CYCLE_CD,
$16 as PRI_END_TS,
$17 as PRI_ACL_RUN_TS,
$18 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
Select Distinct
''M'' as DAILY_FEED_IND,
Cast(LAST_DAY(ADD_MONTHS(cast(RUN_DATE as date), -2)) as varchar(12)) as FROM_DATE,
Cast ((ADD_MONTHS(cast(RUN_DATE as date)  - EXTRACT(DAY FROM cast(RUN_DATE as date))+0, -0) ) AS VARCHAR(12)) AS TO_DATE,
Cast ((ADD_MONTHS(cast(RUN_DATE as date)  - EXTRACT(DAY FROM cast(RUN_DATE as date))+0, -0) ) AS VARCHAR(12)) as RUN_DATE,
''$CH'' as HDR_IDENTIFIER,
''MISBPCO'' as PRGM_NAME,
''R8.0'' as PRGM_LEVEL,
Cast((ADD_MONTHS(cast(RUN_DATE as date)  - EXTRACT(DAY FROM cast(RUN_DATE as date))+0, -0)) as Varchar(11))||''-23.59.59.999999'' as CREATE_TS, 
Extract(year from (ADD_MONTHS(cast(RUN_DATE as date)  - EXTRACT(DAY FROM cast(RUN_DATE as date))+0, -0))) AS ACCOUNTING_YR,  
Extract(Month from (ADD_MONTHS(cast(RUN_DATE as date)  - EXTRACT(DAY FROM cast(RUN_DATE as date))+0, -0))) AS ACCOUNTING_MO, 
''1'' as CLOSEOUT_SEQ_NBR,
Cast ((ADD_MONTHS(cast(RUN_DATE as date)  - EXTRACT(DAY FROM cast(RUN_DATE as date))+0, -0) ) AS VARCHAR(12)) as CYC_END_DT,
Cast((ADD_MONTHS(cast(RUN_DATE as date) - EXTRACT(DAY FROM cast(RUN_DATE as date))+1, 0) ) AS varchar(11))||''-00.00.00.000000'' as END_TS,
''0001-01-01-00.00.00.000000'' as ACL_RUN_TS,
''F''as CYCLE_CD,
Cast((ADD_MONTHS(cast(RUN_DATE as date) - EXTRACT(DAY FROM cast(RUN_DATE as date))+1, -1) ) AS varchar(11))||''-00.00.00.000000'' as PRI_END_TS,
LAST_DAY(ADD_MONTHS(cast(RUN_DATE as date), -2))||''-23.59.59.999999'' as PRI_ACL_RUN_TS
From 
DB_T_CTRL_PROD.ECTL_MISPREM_HEADER
) SRC
)
);


-- Component exp_PREM_HEADER, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_PREM_HEADER AS
(
SELECT
0 as out_ECTL_PRGM_ID,
2 as out_ECTL_FROM_DATE_PARAM_ID,
3 as out_ECTL_TO_DATE_PARAM_ID,
4 as out_ECTL_RUN_DATE_PARAM_ID,
5 as out_ECTL_BATCH_ID_PARAM_ID1,
CURRENT_TIMESTAMP as out_ECTL_ORIG_INS_TS,
:PMMappingName as out_PRGM_NM,
:ACT_PROJ_ID as out_ACT_PROJ_ID,
:BATCH_ACTIVE_IND as out_BATCH_ACTIVE_IND,
:ACT_PROJ_ID as IN_ACT_PROJ_ID,
:BATCH_ACTIVE_IND as IN_BATCH_ACTIVE_IND,
''m_STG_FIN_CLM'' IN_PRGM_NM,
null IN_TABLE_NM,
SQ_Shortcut_to_ECTL_MISPREM_HEADER.DAILY_FEED_IND as DAILY_FEED_IND,
SQ_Shortcut_to_ECTL_MISPREM_HEADER.FROM_DATE as FROM_DATE,
SQ_Shortcut_to_ECTL_MISPREM_HEADER.TO_DATE as TO_DATE,
SQ_Shortcut_to_ECTL_MISPREM_HEADER.RUN_DATE as RUN_DATE,
SQ_Shortcut_to_ECTL_MISPREM_HEADER.HDR_IDENTIFIER as HDR_IDENTIFIER,
SQ_Shortcut_to_ECTL_MISPREM_HEADER.PRGM_NAME as PRGM_NAME,
SQ_Shortcut_to_ECTL_MISPREM_HEADER.PRGM_LEVEL as PRGM_LEVEL,
SQ_Shortcut_to_ECTL_MISPREM_HEADER.CREATE_TS as CREATE_TS,
SQ_Shortcut_to_ECTL_MISPREM_HEADER.ACCOUNTING_YR as ACCOUNTING_YR,
SQ_Shortcut_to_ECTL_MISPREM_HEADER.ACCOUNTING_MO as ACCOUNTING_MO,
SQ_Shortcut_to_ECTL_MISPREM_HEADER.CLOSEOUT_SEQ_NBR as CLOSEOUT_SEQ_NBR,
SQ_Shortcut_to_ECTL_MISPREM_HEADER.CYC_END_DT as CYC_END_DT,
SQ_Shortcut_to_ECTL_MISPREM_HEADER.END_TS as END_TS,
SQ_Shortcut_to_ECTL_MISPREM_HEADER.ACL_RUN_TS as ACL_RUN_TS,
SQ_Shortcut_to_ECTL_MISPREM_HEADER.CYCLE_CD as CYCLE_CD,
SQ_Shortcut_to_ECTL_MISPREM_HEADER.PRI_END_TS as PRI_END_TS,
SQ_Shortcut_to_ECTL_MISPREM_HEADER.PRI_ACL_RUN_TS as PRI_ACL_RUN_TS,
SQ_Shortcut_to_ECTL_MISPREM_HEADER.source_record_id
FROM
SQ_Shortcut_to_ECTL_MISPREM_HEADER
);


-- Component upd_UPATE_FROM_DATE, Type UPDATE 
CREATE OR REPLACE TEMPORARY TABLE upd_UPATE_FROM_DATE AS
(
/* UPDATE_STRATEGY_ACTION = 0 FOR INSERT / UPDATE_STRATEGY_ACTION = 1 FOR UPDATE / UPDATE_STRATEGY_ACTION = 2 FOR DELETE / UPDATE_STRATEGY_ACTION = 3 FOR REJECT */
SELECT
exp_PREM_HEADER.out_ECTL_PRGM_ID as ECTL_PRGM_ID,
exp_PREM_HEADER.out_ECTL_FROM_DATE_PARAM_ID as ECTL_FROM_DATE_PARAM_ID,
exp_PREM_HEADER.FROM_DATE as FROM_DATE,
exp_PREM_HEADER.out_ECTL_ORIG_INS_TS as ECTL_ORIG_INS_TS,
CASE WHEN ECTL_PRGM_ID=0 THEN 1 ELSE 0 END as UPDATE_STRATEGY_ACTION
FROM
exp_PREM_HEADER
);


-- Component mplt_LKP_ECTL_BATCH_PRGM_VALIDATION, Type MAPPLET 
--MAPPLET NOT REGISTERED: mplt_LKP_ECTL_BATCH_PRGM_VALIDATION, mapplet instance mplt_LKP_ECTL_BATCH_PRGM_VALIDATION;
call mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_core(''exp_PREM_HEADER'');

-- Component upd_UPDATE_TO_DATE, Type UPDATE 
CREATE OR REPLACE TEMPORARY TABLE upd_UPDATE_TO_DATE AS
(
/* UPDATE_STRATEGY_ACTION = 0 FOR INSERT / UPDATE_STRATEGY_ACTION = 1 FOR UPDATE / UPDATE_STRATEGY_ACTION = 2 FOR DELETE / UPDATE_STRATEGY_ACTION = 3 FOR REJECT */
SELECT
exp_PREM_HEADER.out_ECTL_PRGM_ID as ECTL_PRGM_ID,
exp_PREM_HEADER.out_ECTL_TO_DATE_PARAM_ID as ECTL_TO_DATE_PARAM_ID,
exp_PREM_HEADER.TO_DATE as TO_DATE,
exp_PREM_HEADER.out_ECTL_ORIG_INS_TS as ECTL_ORIG_INS_TS,
CASE WHEN ECTL_PRGM_ID=0 THEN 1 ELSE 0 END as UPDATE_STRATEGY_ACTION
FROM
exp_PREM_HEADER
);


-- Component upd_UPDATE_RUN_DATE, Type UPDATE 
CREATE OR REPLACE TEMPORARY TABLE upd_UPDATE_RUN_DATE AS
(
/* UPDATE_STRATEGY_ACTION = 0 FOR INSERT / UPDATE_STRATEGY_ACTION = 1 FOR UPDATE / UPDATE_STRATEGY_ACTION = 2 FOR DELETE / UPDATE_STRATEGY_ACTION = 3 FOR REJECT */
SELECT
exp_PREM_HEADER.out_ECTL_PRGM_ID as ECTL_PRGM_ID,
exp_PREM_HEADER.out_ECTL_RUN_DATE_PARAM_ID as ECTL_TO_DATE_PARAM_ID,
exp_PREM_HEADER.RUN_DATE as RUN_DATE,
exp_PREM_HEADER.out_ECTL_ORIG_INS_TS as ECTL_ORIG_INS_TS,
CASE WHEN ECTL_PRGM_ID=0 THEN 1 ELSE 0 END as UPDATE_STRATEGY_ACTION
FROM
exp_PREM_HEADER
);

--insert into DB_T_CTRL_FIN_PROD.ECTL_PRGM_PARAM select * from public.ECTL_PRGM_PARAM2025
--create table public.ECTL_PRGM_PARAM2025 as select * from 
--truncate table DB_T_CTRL_FIN_PROD.ECTL_PRGM_PARAM
--select * from DB_T_CTRL_FIN_PROD.ECTL_PRGM_PARAM where ECTL_PARAM_VALUE=''2006-02-28'' ;
--Row Values: [0, 4, "2006-01-31", NULL, 1757318332177000]
-- Component ECTL_PRGM_PARAM_UPD2, Type TARGET 
MERGE INTO DB_T_CTRL_FIN_PROD.ECTL_PRGM_PARAM
USING upd_UPDATE_RUN_DATE ON (ECTL_PRGM_PARAM.ECTL_PRGM_ID = upd_UPDATE_RUN_DATE.ECTL_PRGM_ID AND ECTL_PRGM_PARAM.ECTL_PARAM_ID = upd_UPDATE_RUN_DATE.ECTL_TO_DATE_PARAM_ID)
WHEN MATCHED
THEN UPDATE SET
ECTL_PRGM_ID = upd_UPDATE_RUN_DATE.ECTL_PRGM_ID,
ECTL_PARAM_ID = upd_UPDATE_RUN_DATE.ECTL_TO_DATE_PARAM_ID,
ECTL_PARAM_VALUE = upd_UPDATE_RUN_DATE.RUN_DATE,
ECTL_ORIG_INS_TS = upd_UPDATE_RUN_DATE.ECTL_ORIG_INS_TS
WHEN NOT MATCHED THEN INSERT
(
ECTL_PRGM_ID,
ECTL_PARAM_ID,
ECTL_PARAM_VALUE,
ECTL_ORIG_INS_TS
)
VALUES(
upd_UPDATE_RUN_DATE.ECTL_PRGM_ID/* ECTL_PRGM_ID */,
upd_UPDATE_RUN_DATE.ECTL_TO_DATE_PARAM_ID/* ECTL_PARAM_ID */,
upd_UPDATE_RUN_DATE.RUN_DATE/* ECTL_PARAM_VALUE */,
upd_UPDATE_RUN_DATE.ECTL_ORIG_INS_TS/* ECTL_ORIG_INS_TS */
);

/* Perform Updates */
MERGE INTO DB_T_CTRL_FIN_PROD.ECTL_PRGM_PARAM
USING upd_UPDATE_RUN_DATE ON (UPDATE_STRATEGY_ACTION = 1 AND ECTL_PRGM_PARAM.ECTL_PRGM_ID = upd_UPDATE_RUN_DATE.ECTL_PRGM_ID AND ECTL_PRGM_PARAM.ECTL_PARAM_ID = upd_UPDATE_RUN_DATE.ECTL_TO_DATE_PARAM_ID)
WHEN MATCHED THEN UPDATE
SET
ECTL_PARAM_VALUE = upd_UPDATE_RUN_DATE.RUN_DATE,
ECTL_ORIG_INS_TS = upd_UPDATE_RUN_DATE.ECTL_ORIG_INS_TS;
--;
/* Perform Deletes */
DELETE FROM DB_T_CTRL_FIN_PROD.ECTL_PRGM_PARAM
WHERE EXISTS (SELECT 1 FROM upd_UPDATE_RUN_DATE WHERE UPDATE_STRATEGY_ACTION = 2 AND ECTL_PRGM_PARAM.ECTL_PRGM_ID = upd_UPDATE_RUN_DATE.ECTL_PRGM_ID AND ECTL_PRGM_PARAM.ECTL_PARAM_ID = upd_UPDATE_RUN_DATE.ECTL_TO_DATE_PARAM_ID)
;


-- Component ECTL_MISPREM_HEADER_INS, Type TARGET 
INSERT INTO DB_T_CTRL_PROD.ECTL_MISPREM_HEADER
(
DAILY_FEED_IND,
FROM_DATE,
TO_DATE,
RUN_DATE,
HDR_IDENTIFIER,
PRGM_NAME,
PRGM_LEVEL,
CREATE_TS,
ACCOUNTING_YR,
ACCOUNTING_MO,
CLOSEOUT_SEQ_NBR,
CYC_END_DT,
END_TS,
ACL_RUN_TS,
CYCLE_CD,
PRI_END_TS,
PRI_ACL_RUN_TS,
ECTL_BATCH_ID,
ECTL_ORIG_INS_TS,
ECTL_MODIFY_TS,
ECTL_SRC_ID,
ECTL_SRC_INST_ID,
ECTL_PRGM_ID
)
SELECT
exp_PREM_HEADER.DAILY_FEED_IND as DAILY_FEED_IND,
exp_PREM_HEADER.FROM_DATE as FROM_DATE,
exp_PREM_HEADER.TO_DATE as TO_DATE,
exp_PREM_HEADER.RUN_DATE as RUN_DATE,
exp_PREM_HEADER.HDR_IDENTIFIER as HDR_IDENTIFIER,
exp_PREM_HEADER.PRGM_NAME as PRGM_NAME,
exp_PREM_HEADER.PRGM_LEVEL as PRGM_LEVEL,
exp_PREM_HEADER.CREATE_TS as CREATE_TS,
exp_PREM_HEADER.ACCOUNTING_YR as ACCOUNTING_YR,
exp_PREM_HEADER.ACCOUNTING_MO as ACCOUNTING_MO,
exp_PREM_HEADER.CLOSEOUT_SEQ_NBR as CLOSEOUT_SEQ_NBR,
exp_PREM_HEADER.CYC_END_DT as CYC_END_DT,
exp_PREM_HEADER.END_TS as END_TS,
exp_PREM_HEADER.ACL_RUN_TS as ACL_RUN_TS,
exp_PREM_HEADER.CYCLE_CD as CYCLE_CD,
exp_PREM_HEADER.PRI_END_TS as PRI_END_TS,
exp_PREM_HEADER.PRI_ACL_RUN_TS as PRI_ACL_RUN_TS,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION.out_ECTL_BATCH_ID as ECTL_BATCH_ID,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION.out_ORIG_INS_TS as ECTL_ORIG_INS_TS,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION.out_ORIG_INS_TS as ECTL_MODIFY_TS,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION.out_ECTL_SRC_ID as ECTL_SRC_ID,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION.out_ECTL_SRC_INST_ID as ECTL_SRC_INST_ID,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION.out_ECTL_PRGM_ID as ECTL_PRGM_ID
FROM
exp_PREM_HEADER
INNER JOIN mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_core mplt_LKP_ECTL_BATCH_PRGM_VALIDATION ON exp_PREM_HEADER.source_record_id = mplt_LKP_ECTL_BATCH_PRGM_VALIDATION.source_record_id;


-- Component ECTL_PRGM_PARAM_UPD1, Type TARGET 
MERGE INTO DB_T_CTRL_FIN_PROD.ECTL_PRGM_PARAM
USING upd_UPATE_FROM_DATE ON (ECTL_PRGM_PARAM.ECTL_PRGM_ID = upd_UPATE_FROM_DATE.ECTL_PRGM_ID AND ECTL_PRGM_PARAM.ECTL_PARAM_ID = upd_UPATE_FROM_DATE.ECTL_FROM_DATE_PARAM_ID)
WHEN MATCHED
THEN UPDATE SET
ECTL_PRGM_ID = upd_UPATE_FROM_DATE.ECTL_PRGM_ID,
ECTL_PARAM_ID = upd_UPATE_FROM_DATE.ECTL_FROM_DATE_PARAM_ID,
ECTL_PARAM_VALUE = upd_UPATE_FROM_DATE.FROM_DATE,
ECTL_ORIG_INS_TS = upd_UPATE_FROM_DATE.ECTL_ORIG_INS_TS
WHEN NOT MATCHED THEN INSERT
(
ECTL_PRGM_ID,
ECTL_PARAM_ID,
ECTL_PARAM_VALUE,
ECTL_ORIG_INS_TS
)
VALUES(
upd_UPATE_FROM_DATE.ECTL_PRGM_ID/* ECTL_PRGM_ID */,
upd_UPATE_FROM_DATE.ECTL_FROM_DATE_PARAM_ID/* ECTL_PARAM_ID */,
upd_UPATE_FROM_DATE.FROM_DATE/* ECTL_PARAM_VALUE */,
upd_UPATE_FROM_DATE.ECTL_ORIG_INS_TS/* ECTL_ORIG_INS_TS */
);

/* Perform Updates */
MERGE INTO DB_T_CTRL_FIN_PROD.ECTL_PRGM_PARAM
USING upd_UPATE_FROM_DATE ON (UPDATE_STRATEGY_ACTION = 1 AND ECTL_PRGM_PARAM.ECTL_PRGM_ID = upd_UPATE_FROM_DATE.ECTL_PRGM_ID AND ECTL_PRGM_PARAM.ECTL_PARAM_ID = upd_UPATE_FROM_DATE.ECTL_FROM_DATE_PARAM_ID)
WHEN MATCHED THEN UPDATE
SET
ECTL_PARAM_VALUE = upd_UPATE_FROM_DATE.FROM_DATE,
ECTL_ORIG_INS_TS = upd_UPATE_FROM_DATE.ECTL_ORIG_INS_TS;
--;
/* Perform Deletes */
DELETE FROM DB_T_CTRL_FIN_PROD.ECTL_PRGM_PARAM
WHERE EXISTS (SELECT 1 FROM upd_UPATE_FROM_DATE WHERE UPDATE_STRATEGY_ACTION = 2 AND ECTL_PRGM_PARAM.ECTL_PRGM_ID = upd_UPATE_FROM_DATE.ECTL_PRGM_ID AND ECTL_PRGM_PARAM.ECTL_PARAM_ID = upd_UPATE_FROM_DATE.ECTL_FROM_DATE_PARAM_ID)
;


-- Component upd_UPATE_FROM_DATE1, Type UPDATE 
CREATE OR REPLACE TEMPORARY TABLE upd_UPATE_FROM_DATE1 AS
(
/* UPDATE_STRATEGY_ACTION = 0 FOR INSERT / UPDATE_STRATEGY_ACTION = 1 FOR UPDATE / UPDATE_STRATEGY_ACTION = 2 FOR DELETE / UPDATE_STRATEGY_ACTION = 3 FOR REJECT */
SELECT
exp_PREM_HEADER.out_ECTL_PRGM_ID as ECTL_PRGM_ID,
exp_PREM_HEADER.out_ECTL_BATCH_ID_PARAM_ID1 as ECTL_BATCH_ID_PARAM_ID,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION.out_ECTL_BATCH_ID as BATCH_ID,
exp_PREM_HEADER.out_ECTL_ORIG_INS_TS as ECTL_ORIG_INS_TS,
CASE WHEN ECTL_PRGM_ID=0 THEN 1 ELSE 0 END as UPDATE_STRATEGY_ACTION
FROM
exp_PREM_HEADER
LEFT JOIN mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_core mplt_LKP_ECTL_BATCH_PRGM_VALIDATION ON exp_PREM_HEADER.source_record_id = mplt_LKP_ECTL_BATCH_PRGM_VALIDATION.source_record_id
);


-- Component ECTL_PRGM_PARAM_UPD, Type TARGET 
MERGE INTO DB_T_CTRL_FIN_PROD.ECTL_PRGM_PARAM
USING upd_UPDATE_TO_DATE ON (ECTL_PRGM_PARAM.ECTL_PRGM_ID = upd_UPDATE_TO_DATE.ECTL_PRGM_ID AND ECTL_PRGM_PARAM.ECTL_PARAM_ID = upd_UPDATE_TO_DATE.ECTL_TO_DATE_PARAM_ID)
WHEN MATCHED
THEN UPDATE SET
ECTL_PRGM_ID = upd_UPDATE_TO_DATE.ECTL_PRGM_ID,
ECTL_PARAM_ID = upd_UPDATE_TO_DATE.ECTL_TO_DATE_PARAM_ID,
ECTL_PARAM_VALUE = upd_UPDATE_TO_DATE.TO_DATE,
ECTL_ORIG_INS_TS = upd_UPDATE_TO_DATE.ECTL_ORIG_INS_TS
WHEN NOT MATCHED THEN INSERT
(
ECTL_PRGM_ID,
ECTL_PARAM_ID,
ECTL_PARAM_VALUE,
ECTL_ORIG_INS_TS
)
VALUES(
upd_UPDATE_TO_DATE.ECTL_PRGM_ID/* ECTL_PRGM_ID */,
upd_UPDATE_TO_DATE.ECTL_TO_DATE_PARAM_ID/* ECTL_PARAM_ID */,
upd_UPDATE_TO_DATE.TO_DATE/* ECTL_PARAM_VALUE */,
upd_UPDATE_TO_DATE.ECTL_ORIG_INS_TS/* ECTL_ORIG_INS_TS */
);

/* Perform Updates */
MERGE INTO DB_T_CTRL_FIN_PROD.ECTL_PRGM_PARAM
USING upd_UPDATE_TO_DATE ON (UPDATE_STRATEGY_ACTION = 1 AND ECTL_PRGM_PARAM.ECTL_PRGM_ID = upd_UPDATE_TO_DATE.ECTL_PRGM_ID AND ECTL_PRGM_PARAM.ECTL_PARAM_ID = upd_UPDATE_TO_DATE.ECTL_TO_DATE_PARAM_ID)
WHEN MATCHED THEN UPDATE
SET
ECTL_PARAM_VALUE = upd_UPDATE_TO_DATE.TO_DATE,
ECTL_ORIG_INS_TS = upd_UPDATE_TO_DATE.ECTL_ORIG_INS_TS;
--;
/* Perform Deletes */
DELETE FROM DB_T_CTRL_FIN_PROD.ECTL_PRGM_PARAM
WHERE EXISTS (SELECT 1 FROM upd_UPDATE_TO_DATE WHERE UPDATE_STRATEGY_ACTION = 2 AND ECTL_PRGM_PARAM.ECTL_PRGM_ID = upd_UPDATE_TO_DATE.ECTL_PRGM_ID AND ECTL_PRGM_PARAM.ECTL_PARAM_ID = upd_UPDATE_TO_DATE.ECTL_TO_DATE_PARAM_ID)
;


-- Component ECTL_PRGM_PARAM_UPD11, Type TARGET 
MERGE INTO DB_T_CTRL_FIN_PROD.ECTL_PRGM_PARAM
USING upd_UPATE_FROM_DATE1 ON (ECTL_PRGM_PARAM.ECTL_PRGM_ID = upd_UPATE_FROM_DATE1.ECTL_PRGM_ID AND ECTL_PRGM_PARAM.ECTL_PARAM_ID = upd_UPATE_FROM_DATE1.ECTL_BATCH_ID_PARAM_ID)
WHEN MATCHED
THEN UPDATE SET
ECTL_PRGM_ID = upd_UPATE_FROM_DATE1.ECTL_PRGM_ID,
ECTL_PARAM_ID = upd_UPATE_FROM_DATE1.ECTL_BATCH_ID_PARAM_ID,
ECTL_PARAM_VALUE = upd_UPATE_FROM_DATE1.BATCH_ID,
ECTL_ORIG_INS_TS = upd_UPATE_FROM_DATE1.ECTL_ORIG_INS_TS
WHEN NOT MATCHED THEN INSERT
(
ECTL_PRGM_ID,
ECTL_PARAM_ID,
ECTL_PARAM_VALUE,
ECTL_ORIG_INS_TS
)
VALUES(
upd_UPATE_FROM_DATE1.ECTL_PRGM_ID/* ECTL_PRGM_ID */,
upd_UPATE_FROM_DATE1.ECTL_BATCH_ID_PARAM_ID/* ECTL_PARAM_ID */,
upd_UPATE_FROM_DATE1.BATCH_ID/* ECTL_PARAM_VALUE */,
upd_UPATE_FROM_DATE1.ECTL_ORIG_INS_TS/* ECTL_ORIG_INS_TS */
);

/* Perform Updates */
MERGE INTO DB_T_CTRL_FIN_PROD.ECTL_PRGM_PARAM
USING upd_UPATE_FROM_DATE1 ON (UPDATE_STRATEGY_ACTION = 1 AND ECTL_PRGM_PARAM.ECTL_PRGM_ID = upd_UPATE_FROM_DATE1.ECTL_PRGM_ID AND ECTL_PRGM_PARAM.ECTL_PARAM_ID = upd_UPATE_FROM_DATE1.ECTL_BATCH_ID_PARAM_ID)
WHEN MATCHED THEN UPDATE
SET
ECTL_PARAM_VALUE = upd_UPATE_FROM_DATE1.BATCH_ID,
ECTL_ORIG_INS_TS = upd_UPATE_FROM_DATE1.ECTL_ORIG_INS_TS;
--;
/* Perform Deletes */
DELETE FROM DB_T_CTRL_FIN_PROD.ECTL_PRGM_PARAM
WHERE EXISTS (SELECT 1 FROM upd_UPATE_FROM_DATE1 WHERE UPDATE_STRATEGY_ACTION = 2 AND ECTL_PRGM_PARAM.ECTL_PRGM_ID = upd_UPATE_FROM_DATE1.ECTL_PRGM_ID AND ECTL_PRGM_PARAM.ECTL_PARAM_ID = upd_UPATE_FROM_DATE1.ECTL_BATCH_ID_PARAM_ID)
;


END; ';