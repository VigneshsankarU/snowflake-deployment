-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_POLICIES_BY_MEMBER_INS("RUN_ID" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' BEGIN 

-- Component POLICIES_BY_MEMBER, Type TRUNCATE_TABLE 
TRUNCATE TABLE DB_T_STAG_MEMBXREF_PROD.POLICIES_BY_MEMBER;


-- Component SQTRANS, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQTRANS AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as POLICY_NUM,
$2 as MEMBER_NUM,
$3 as NAME_1,
$4 as NAME_2,
$5 as ADDRESS_1,
$6 as ADDRESS_2,
$7 as CITY,
$8 as STATE,
$9 as ZIP,
$10 as POLICY_DESCRIPTION,
$11 as AGENT_NUM,
$12 as POLICY_STATUS,
$13 as SC_NUM,
$14 as POLICY_TYPE,
$15 as EXPIRATION_DATE,
$16 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT     
			CAST(PL_POL_NUM AS VARCHAR(25)) AS POLICY_NUM,     
			CAST(PL_MEMBER_NUM AS VARCHAR(8)) AS MEMBER_NUM,     
			CAST(PL_NAME_1 AS VARCHAR(60)) AS NAME_1,     
			CAST(PL_NAME_2 AS VARCHAR(60)) AS NAME_2,     
			CAST(PL_ADDRESS_1 AS VARCHAR(45)) AS ADDRESS_1,     
			CAST(PL_ADDRESS_2 AS VARCHAR(45)) AS ADDRESS_2,     
			CAST(PL_CITY AS VARCHAR(30)) AS CITY,     
			CAST(PL_STATE AS VARCHAR(3)) AS STATE,     
			CAST(PL_ZIP AS VARCHAR(13)) AS ZIP,     
			CAST(PL_DESC AS VARCHAR(60)) AS POLICY_DESCRIPTION,     
			CAST(PL_AGT_NUM AS INTEGER) AS AGT_NUM,     
			CAST(PL_STATUS AS VARCHAR(9)) AS POLICY_STATUS,     
			CAST(PL_SC_NUM AS INTEGER) AS SC_NUM,    
			CAST(PL_TYPE AS VARCHAR(3)) AS POLICY_TYPE,    
			CAST(PL_EXP_DATE AS DATE) AS EXPIRATION_DATE    
		FROM DB_T_STAG_MEMBXREF_PROD.POLICYLIST    
		UNION       
		SELECT    
			CAST(EXC.EX_POL_NUM AS VARCHAR(25)) AS POLICY_NUM,     
			CAST(EXC.EX_MEMBER_NUM AS VARCHAR(8)) AS MEMBER_NUM,     
			CAST(EXC.EX_LONG_NAME AS VARCHAR(60)) AS NAME_1,     
			CAST('''' AS VARCHAR(60)) AS NAME_2,     
			CAST(EXC.EX_ADDRESS_1 AS VARCHAR(45)) AS ADDRESS_1,     
			CAST(EXC.EX_ADDRESS_2 AS VARCHAR(45)) AS ADDRESS_2,     
			CAST(EXC.EX_CITY AS VARCHAR(30)) AS CITY,     
			CAST(EXC.EX_STATE AS VARCHAR(3)) AS STATE,     
			CAST(EXC.EX_ZIP AS VARCHAR(13)) AS ZIP,     
			CAST(''Exceed Policy'' AS VARCHAR(60)) AS POLICY_DESCRIPTION,     
			CAST(EXC.EX_AGT_NUM AS INTEGER) AS AGT_NUM,     
			CAST(EXC2.POLICY_STATUS AS VARCHAR(9)) AS POLICY_STATUS,     
			CAST(EXC.EX_SC_NUM AS INTEGER) AS SC_NUM,    
			CAST(''APV'' AS VARCHAR(3)) AS POLICY_TYPE,    
			CAST(EXC.EX_EXPIRATION_DT AS DATE) AS EXPIRATION_DATE    
		FROM DB_T_CORE_MEMBXREF_PROD.EXCEED_POL_LIST EXC   
		JOIN   
		(    
			SELECT EXC.EX_POL_NUM AS POL_NUM,       
				1 AS POLICY_STATUS   
			FROM DB_T_CORE_MEMBXREF_PROD.EXCEED_POL_LIST EXC    
			JOIN 
			(SELECT DISTINCT POL_NBR      
				FROM DB_T_STAG_MEMBXREF_PROD.POL_VEH_LIST)  EXC2 ON EXC.EX_POL_NUM = EXC2.POL_NBR      
			UNION      
			SELECT 
				EXC.EX_POL_NUM AS POL_NUM,       
				5 AS POLICY_STATUS    
			FROM DB_T_CORE_MEMBXREF_PROD.EXCEED_POL_LIST EXC    
			LEFT JOIN 
			(SELECT DISTINCT POL_NBR                
				FROM DB_T_STAG_MEMBXREF_PROD.POL_VEH_LIST)  EXC2 ON EXC.EX_POL_NUM = EXC2.POL_NBR    
				WHERE EXC2.POL_NBR IS NULL    
			) EXC2 ON EXC.EX_POL_NUM = EXC2.POL_NUM    
			UNION     
			SELECT    
				CAST(POL_ID AS VARCHAR(25)) AS POLICY_NUM,     
				CAST(INSURED_MEMBER_NUM AS VARCHAR(8)) AS MEMBER_NUM,     
				CAST(TRIM(INSURED_FIRST_NM) || '' '' || TRIM(INSURED_MID_NM) || '' '' || TRIM(INSURED_LAST_NM) AS VARCHAR(60)) AS NAME_1,     
				CAST('''' AS VARCHAR(60)) AS NAME_2,     
				CAST(INSURED_ADDR_LN_1 AS VARCHAR(45)) AS ADDRESS_1,     
				CAST(INSURED_ADDR_LN_2 AS VARCHAR(45)) AS ADDRESS_2,     
				CAST(INSURED_CITY_NM AS VARCHAR(30)) AS CITY,     
				CAST(INSURED_STATE_CD AS VARCHAR(3)) AS STATE,     
				CAST(INSURED_ZIP_CD AS VARCHAR(13)) AS ZIP,     
				CAST(''Ingenium DB_T_STAG_MEMBXREF_PROD.Life Policy'' AS VARCHAR(60)) AS POLICY_DESCRIPTION,     
				CASE 
					WHEN AGT_ID > ''0'' AND AGT_ID < ''99999999'' THEN CAST(AGT_ID AS INTEGER) 
					ELSE 0 
				END AS AGT_NUM,     
				CAST(POL_STATUS AS VARCHAR(9)) AS POLICY_STATUS,     
				CAST(SERV_CENTER_NUM AS INTEGER) AS SC_NUM,    
				CAST(''ING'' AS VARCHAR(3)) AS POLICY_TYPE,    
				NULL AS EXPIRATION_DATE    
			FROM DB_T_CORE_MEMBXREF_PROD.ING_POL_LIST
) SRC
)
);


-- Component EXPTRANS, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE EXPTRANS AS
(
SELECT
SQTRANS.POLICY_NUM as POLICY_NUM,
SQTRANS.MEMBER_NUM as MEMBER_NUM,
SQTRANS.NAME_1 as NAME_1,
SQTRANS.NAME_2 as NAME_2,
SQTRANS.ADDRESS_1 as ADDRESS_1,
SQTRANS.ADDRESS_2 as ADDRESS_2,
SQTRANS.CITY as CITY,
SQTRANS.STATE as STATE,
SQTRANS.ZIP as ZIP,
SQTRANS.POLICY_DESCRIPTION as POLICY_DESCRIPTION,
SQTRANS.AGENT_NUM as AGENT_NUM,
SQTRANS.POLICY_STATUS as POLICY_STATUS,
SQTRANS.SC_NUM as SC_NUM,
SQTRANS.POLICY_TYPE as POLICY_TYPE,
SQTRANS.EXPIRATION_DATE as EXPIRATION_DATE,
SQTRANS.source_record_id
FROM
SQTRANS
);


-- Component POLICIES_BY_MEMBER, Type TARGET 
INSERT INTO DB_T_STAG_MEMBXREF_PROD.POLICIES_BY_MEMBER
(
POLICY_NUM,
MEMBER_NUM,
NAME_1,
NAME_2,
ADDRESS_1,
ADDRESS_2,
CITY,
STATE,
ZIP,
POLICY_DESCRIPTION,
AGT_NUM,
POLICY_STATUS,
SC_NUM,
POLICY_TYPE,
EXPIRATION_DATE
)
SELECT
EXPTRANS.POLICY_NUM as POLICY_NUM,
EXPTRANS.MEMBER_NUM as MEMBER_NUM,
EXPTRANS.NAME_1 as NAME_1,
EXPTRANS.NAME_2 as NAME_2,
EXPTRANS.ADDRESS_1 as ADDRESS_1,
EXPTRANS.ADDRESS_2 as ADDRESS_2,
EXPTRANS.CITY as CITY,
EXPTRANS.STATE as STATE,
EXPTRANS.ZIP as ZIP,
EXPTRANS.POLICY_DESCRIPTION as POLICY_DESCRIPTION,
EXPTRANS.AGENT_NUM as AGT_NUM,
EXPTRANS.POLICY_STATUS as POLICY_STATUS,
EXPTRANS.SC_NUM as SC_NUM,
EXPTRANS.POLICY_TYPE as POLICY_TYPE,
EXPTRANS.EXPIRATION_DATE as EXPIRATION_DATE
FROM
EXPTRANS;


END; ';