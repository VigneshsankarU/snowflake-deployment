-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_WRK_EDW_EBLM_VEH_COV_EXTRACT("PARAM_JSON" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' 
DECLARE
  PRCS_ID STRING;
  CAL_END_DT STRING;
BEGIN
  SELECT 
    TRY_PARSE_JSON(:param_json):PRCS_ID::STRING,
	TRY_PARSE_JSON(:param_json):CAL_END_DT::STRING
  INTO
    PRCS_ID,
	CAL_END_DT;

-- Component SQ_AGMT, Type Pre SQL 
DELETE FROM DB_WRK.EDW_EBLM_VEH_COV WHERE MO_ID=EXTRACT(YEAR FROM CAST('':CAL_END_DT'' AS DATE))*100+EXTRACT(MONTH FROM CAST('':CAL_END_DT'' AS DATE));


-- Component SQ_AGMT, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_AGMT AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as MO_ID,
$2 as HOST_AGMT_NUM,
$3 as MOTR_VEH_SER_NUM,
$4 as POL_VEH_NUM,
$5 as AGMT_ID,
$6 as MOTR_VEH_DTL_STRT_DTTM,
$7 as MOTR_VEH_DTL_END_DTTM,
$8 as AGMT_FEAT_AMT,
$9 as AGMT_FEAT_AMT1,
$10 as AGMT_FEAT_AMT2,
$11 as AGMT_FEAT_AMT3,
$12 as AGMT_FEAT_AMT4,
$13 as AGMT_FEAT_AMT5,
$14 as AGMT_FEAT_AMT6,
$15 as AGMT_FEAT_AMT7,
$16 as AGMT_FEAT_AMT8,
$17 as AGMT_FEAT_AMT9,
$18 as AGMT_FEAT_AMT9A,
$19 as AGMT_FEAT_AMT9B,
$20 as AGMT_FEAT_AMT10,
$21 as UNB_ADDON_IND,
$22 as UNB_RED_IND,
$23 as AGMT_FEAT_AMT11,
$24 as AGMT_FEAT_AMT12,
$25 as AGMT_FEAT_AMT13,
$26 as AGMT_FEAT_AMT14,
$27 as UNSL_ADDON_IND,
$28 as AGMT_FEAT_AMT15,
$29 as AGMT_FEAT_AMT16,
$30 as AGMT_FEAT_AMT17,
$31 as AGMT_FEAT_AMT18,
$32 as AGMT_FEAT_AMT19,
$33 as AGMT_FEAT_AMT20,
$34 as AGMT_FEAT_AMT21,
$35 as AGMT_FEAT_AMT22,
$36 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT EXTRACT(YEAR FROM '':CAL_END_DT'')*100+EXTRACT(MONTH FROM '':CAL_END_DT'') MO_ID,

AGMT.HOST_AGMT_NUM,

MOTR_VEH_SER_NUM, /* contvcatination of host DB_T_PROD_CORE.AGMT num and motr veh serl num */
CAST(AGMT.HOST_AGMT_NUM||MOTR_VEH_SER_NUM AS VARCHAR(51)) AS POL_VEH_NUM,

AGMT.AGMT_ID,

	agmt_asset.agmt_asset_strt_dttm, 

	agmt_asset.agmt_asset_end_dttm, 

	max (case when acl.cov_type_cd = ''BI''then acl.val2 else ''0''end) as BI_LIMIT,

	max(case 	when ACL.COV_TYPE_CD=''PD''  	then CAST(ACL.VAL4 AS DECIMAL(12,2))	else 0.00 	end ) as PD_LIMIT,

	max(case	when ACL.COV_TYPE_CD=''MED''  	then CAST(ACL.VAL3 AS DECIMAL(12,2))	else 0.00 	end ) as MED_LIMIT,

sum(case 	when ACL.COV_TYPE_CD=''COMP''  	then CAST(ACL.VAL AS DECIMAL(12,2))	else 0.00 	end ) as CMP_LIMIT ,

sum(case 	when ACL.COV_TYPE_CD=''COLL''  	then CAST(ACL.VAL AS DECIMAL(12,2))	else 0.00 End ) as COL_LIMIT,

SUM(CASE 	WHEN DED.INSRNC_CVGE_TYPE_CD=''COMP''  	THEN CAST(DED.FEAT_DTL_VAL AS DECIMAL(12,2))	ELSE 0.00 	END ) AS CMP_DED 	,

max(CASE	WHEN DED.INSRNC_CVGE_TYPE_CD=''COLL''  	THEN CAST(DED.FEAT_DTL_VAL AS DECIMAL(12,2))	ELSE 0.00 	END ) AS COL_DED,

SUM(CASE 	WHEN DED.INSRNC_CVGE_TYPE_CD=''ERS''  	THEN CAST(DED.FEAT_DTL_VAL AS DECIMAL(12,2))	ELSE 0.00 	END ) AS ERS_DED ,

sum(case 	when ACL.COV_TYPE_CD=''LOI''  	then CAST(ACL.VAL AS DECIMAL(12,2))	else 0.00 	end ) as LOI_LIMIT ,

sum(case 	when ACL.COV_TYPE_CD=''LOU''  	then CAST(ACL.VAL AS DECIMAL(12,2))	else 0.00 	end ) as LOU_LIMIT ,

MAX( case when ACL.COV_TYPE_CD=''CS'' then ''Y''else ''N'' end) as CS_IND ,

MAX( case when ACL.COV_TYPE_CD=''CUS''  then ''Y''else ''N'' end) as CUS_IND,

sum(case 	when ACL.COV_TYPE_CD=''UMUIM''  	then CAST(ACL.VAL AS DECIMAL(12,2))	else 0.00 	end ) as UNB_LIMIT ,

MAX(case when UNB.FEAT_NAME=''Addedon'' then ''Y''  else ''N'' end) as UNB_ADDON_IND ,

 MAX(case when UNB.FEAT_NAME=''Reduced'' then ''Y''  else ''N'' end) as UNB_RED_IND ,

SUM(case when ACL.COV_NAME=''UNINSURED MOTORIST - COMMON TERMS'' 	then CAST(ACL.VAL AS DECIMAL(12,2))	else 0.00 end ) AS UND_DED,

SUM(CASE	WHEN DED.INSRNC_CVGE_TYPE_CD=''UMPD''  	THEN CAST(DED.FEAT_DTL_VAL AS DECIMAL(12,2))	ELSE 0.00 	END ) AS UNP_DED 	,

SUM(case when ACL.COV_TYPE_CD=''SL'' 	then CAST(ACL.VAL AS DECIMAL(12,2))	else 0.00 end ) AS SL_LIMIT,

SUM(case when ACL.COV_TYPE_CD=''UNS'' 	then CAST(ACL.VAL AS DECIMAL(12,2))	else 0.00 end ) AS UNSL_LIMIT,

 MAX(case when UNB.COMN_FEAT_NAME =''Uninsured Motorist - Common Terms''  and UNB.FEAT_SBTYPE_CD =''Term'' and UNB.FEAT_CLASFCN_CD =''Addedon''  and UNB.VAL_TYPE_CD =''Addedon'' then ''Y'' else ''N''

 end) AS UNSL_ADDON_IND,

 MAX(case when ACL.COV_TYPE_CD=''LOI'' AND ACL.VAL IS NOT NULL Then ''Y'' else  ''N'' end)  as LOI_IND ,

MAX(case when DED.INSRNC_CVGE_TYPE_CD=''ERS'' AND DED.FEAT_DTL_VAL IS NOT NULL then ''Y''else  ''N'' end)  as ERS_IND ,

MAX(case when ACL.COV_TYPE_CD=''LOU'' AND ACL.VAL IS NOT NULL then ''Y'' else  ''N'' end)  as LOU_IND ,

SUM(case when ACL.COV_TYPE_CD=''CS''  AND ACL.VAL IS NOT NULL 	then CAST(ACL.VAL AS DECIMAL(12,2))	else 0.00 end) as CS_LIMIT, 

MAX(case when ACL.COV_TYPE_CD=''SG''  AND ACL.VAL IS NOT NULL then ''Y'' else ''N'' end) as  SG_IND,

MAX(case when ACL.COV_TYPE_CD=''EXN''  AND ACL.VAL IS NOT NULL then ''Y'' else ''N'' end) as  EXN_IND,

MAX(case when ACL.COV_TYPE_CD=''CUS''  AND ACL.VAL IS NOT NULL 	then CAST(ACL.VAL AS DECIMAL(12,2))	else 0.00 end) as  CUS_LIMIT,

MAX(case when ACL.COV_NAME=''LEASE/LOAN''  AND ACL.VAL IS NOT NULL then ''Y''else ''N'' end) as  GAP_IND

	

		

FROM (SELECT * FROM 

(SELECT  PPV.HOST_AGMT_NUM,PPV.AGMT_ID,PPV.AGMT_SRC_CD,MODL_CRTN_DTTM,  A_S.AGMT_STS_CD,A_S.AGMT_STS_RSN_CD,

CASE WHEN A_S.AGMT_STS_CD = ''CNCLD''  AND A_S.AGMT_STS_RSN_CD = ''CHGUWCMPY'' THEN ''Y'' END AS C2C_CANC_IND ,PPV.AGMT_EFF_DTTM,

PPV.AGMT_SIGND_DTTM,PPV.MODL_ACTL_END_DTTM,PPV.MODL_EFF_DTTM,PPV.CNTNUS_SRVC_DTTM,PPV.AGMT_PLND_EXPN_DTTM,AGMT_OPN_DTTM

FROM (SELECT  T1.HOST_AGMT_NUM,T1.TERM_NUM,T1.AGMT_ID,T1.MODL_CRTN_DTTM,T1.AGMT_SRC_CD,

  T1.MODL_EFF_DTTM,T1.AGMT_EFF_DTTM,T1.AGMT_SIGND_DTTM,T1.MODL_ACTL_END_DTTM,T1.CNTNUS_SRVC_DTTM,

  T1.AGMT_PLND_EXPN_DTTM,T1.AGMT_OPN_DTTM,

CASE WHEN T1.MODL_EFF_DTTM > T1.MODL_CRTN_DTTM THEN T1.MODL_EFF_DTTM ELSE T1.MODL_CRTN_DTTM END AS NEW_AGMT_EFF_DTTM

FROM DB_T_PROD_CORE.AGMT T1 WHERE   T1.AGMT_TYPE_CD = ''PPV''  AND T1.SRC_SYS_CD = ''GWPC'' 

 AND CAST('':CAL_END_DT'' AS DATE)  BETWEEN CAST(AGMT_EFF_DTTM AS DATE) AND CAST(AGMT_PLND_EXPN_DTTM AS DATE)

 AND T1.TRANS_STRT_DTTM = (SELECT  MIN(T2.TRANS_STRT_DTTM) FROM DB_T_PROD_CORE.AGMT T2 WHERE   T1.AGMT_ID = T2.AGMT_ID) 

 AND CAST(NEW_AGMT_EFF_DTTM AS DATE) <=  CAST('':CAL_END_DT'' AS DATE)  ) PPV 

INNER JOIN 

(SELECT  HOST_AGMT_NUM, TERM_NUM,AGMT_ID FROM DB_T_PROD_CORE.AGMT WHERE   AGMT_TYPE_CD = ''POLTRM'' 

 AND CAST('':CAL_END_DT'' AS DATE)  BETWEEN CAST(AGMT_EFF_DTTM AS DATE) AND CAST(AGMT_PLND_EXPN_DTTM AS DATE) GROUP   BY 1,2,3) TRM 

 ON  PPV.HOST_AGMT_NUM = TRM.HOST_AGMT_NUM  AND PPV.TERM_NUM = TRM.TERM_NUM  

INNER JOIN DB_T_PROD_CORE.AGMT_STS A_S 

 ON  TRM.AGMT_ID = A_S.AGMT_ID   AND CAST(A_S.AGMT_STS_STRT_DTTM AS DATE) <= CAST('':CAL_END_DT'' AS DATE)   AND A_S.AGMT_STS_CD <> ''CNFRMDDT'' 

QUALIFY ROW_NUMBER() OVER(PARTITION BY PPV.AGMT_ID ORDER   BY A_S.AGMT_STS_STRT_DTTM DESC) = 1 

)  A  QUALIFY ROW_NUMBER() OVER(PARTITION BY HOST_AGMT_NUM ORDER   BY  CASE WHEN (AGMT_STS_CD=''INFORCE'') THEN 1 ELSE 2 END ,MODL_CRTN_DTTM DESC ) = 1)AGMT

JOIN DB_T_PROD_CORE.AGMT_PROD  ON AGMT.AGMT_ID=AGMT_PROD.AGMT_ID AND AGMT_PROD.EDW_END_DTTM=''9999-12-31 23:59:59.999999''     

and AGMT_STS_CD=''INFORCE''

JOIN DB_T_PROD_CORE.PROD  ON AGMT_PROD.PROD_ID=PROD.PROD_ID AND PROD.EDW_END_DTTM=''9999-12-31 23:59:59.999999'' 

 and PROD.PROD_NAME IN (''PPV'', ''AUTO'',''PPV2'', ''COMMERCIAL'', ''PERSONAL AUTO'') 

LEFT JOIN DB_T_PROD_CORE.AGMT_ASSET ON AGMT.AGMT_ID=AGMT_ASSET.AGMT_ID 

 AND CAST(AGMT_ASSET.TRANS_STRT_DTTM AS DATE)<=CAST('':CAL_END_DT'' AS DATE) AND CAST(AGMT_ASSET.TRANS_END_DTTM AS DATE)>CAST('':CAL_END_DT'' AS DATE)

/* AND AGMT_ASSET.EDW_END_DTTM=''9999-12-31 23:59:59.999999''        */
LEFT JOIN DB_T_PROD_CORE.MOTR_VEH  ON AGMT_ASSET.PRTY_ASSET_ID=MOTR_VEH.PRTY_ASSET_ID AND MOTR_VEH.EDW_END_DTTM=''9999-12-31 23:59:59.999999''        

LEFT JOIN (

SELECT distinct AGMT_INSRD_ASSET_FEAT.AGMT_ID, AGMT_INSRD_ASSET_FEAT.PRTY_ASSET_ID,

CASE 

WHEN f.FEAT_SBTYPE_CD=''OPT'' THEN f2.FEAT_NAME

WHEN f.FEAT_SBTYPE_CD=''TERM'' THEN f.FEAT_NAME

WHEN f.FEAT_SBTYPE_CD=''PKG'' THEN f4.FEAT_NAME

END TERM_NAME, 

CASE WHEN f.FEAT_SBTYPE_CD=''TERM'' THEN f1.FEAT_NAME

WHEN f.FEAT_SBTYPE_CD=''OPT'' THEN f3.FEAT_NAME

WHEN f.FEAT_SBTYPE_CD=''PKG'' THEN f5.FEAT_NAME

END COV_NAME, 

CASE WHEN f.FEAT_SBTYPE_CD=''TERM'' THEN f1.NK_SRC_KEY

WHEN f.FEAT_SBTYPE_CD=''OPT'' THEN f3.NK_SRC_KEY

WHEN f.FEAT_SBTYPE_CD=''PKG'' THEN f5.NK_SRC_KEY

END COV_PATTERNCODE, 

CASE WHEN f.FEAT_SBTYPE_CD=''OPT'' THEN f2.NK_SRC_KEY

WHEN f.FEAT_SBTYPE_CD=''TERM'' THEN f.NK_SRC_KEY

WHEN f.FEAT_SBTYPE_CD=''PKG'' THEN f4.NK_SRC_KEY

END TERM_PATTERNCODE, 

CASE WHEN f.FEAT_SBTYPE_CD=''TERM'' THEN f1.INSRNC_CVGE_TYPE_CD

WHEN f.FEAT_SBTYPE_CD=''OPT'' THEN f3.INSRNC_CVGE_TYPE_CD

WHEN f.FEAT_SBTYPE_CD=''PKG'' THEN f5.INSRNC_CVGE_TYPE_CD

END COV_TYPE_CD, 

CASE 

WHEN f.FEAT_SBTYPE_CD=''OPT'' THEN CAST(f.FEAT_DTL_VAL AS DECIMAL(18,4)) 

WHEN f.FEAT_SBTYPE_CD=''TERM'' THEN CAST(AGMT_INSRD_ASSET_FEAT.AGMT_ASSET_FEAT_AMT AS DECIMAL(18,4)) 

/*  removed code for defect 18736 EQ-A054: BI_LIMIT  START */
/* WHEN f.FEAT_SBTYPE_CD=''PKG'' THEN  f.FEAT_DTL_CD_NAME */
/*  removed code for defect 18736 EQ-A054: BI_LIMIT  END */
END VAL,

/*  added code for defect 18736 EQ-A054: BI_LIMIT  START */
CASE

WHEN f.FEAT_SBTYPE_CD=''PKG'' THEN  f.FEAT_DTL_CD_NAME

END val2

/*  added code for defect 18736 EQ-A054: BI_LIMIT  END */
/*  added code for defect 19121 EQ-A62: MED_LIMIT  START */
,CASE 

WHEN f.INSRNC_CVGE_TYPE_CD=''MED''THEN CAST(f.FEAT_DTL_VAL AS DECIMAL(18,4))

WHEN f.INSRNC_LOB_TYPE_CD=''PAWTC''THEN CAST(f.FEAT_DTL_VAL AS DECIMAL(18,4))  

END VAL3

/*  added code for defect 19121 EQ-A62: MED_LIMIT  END */
/* added code for defect 19119   START */
,CASE 

WHEN f.INSRNC_CVGE_TYPE_CD=''PD'' THEN CAST(f.FEAT_DTL_VAL AS DECIMAL(18,4))  

END VAL4

/* added code for defect 19119   END */
FROM DB_T_PROD_CORE.FEAT f

JOIN DB_T_PROD_CORE.AGMT_INSRD_ASSET_FEAT ON f.FEAT_ID=AGMT_INSRD_ASSET_FEAT.FEAT_ID AND	AGMT_INSRD_ASSET_FEAT.EDW_END_DTTM = ''9999-12-31 23:59:59.999999''

LEFT JOIN DB_T_PROD_CORE.FEAT_RLTD fr1 ON f.FEAT_ID=fr1.RLTD_FEAT_ID AND fr1.FEAT_RLTNSHP_TYPE_CD =''COVT'' AND fr1.EDW_END_DTTM = ''9999-12-31 23:59:59.999999''

LEFT JOIN DB_T_PROD_CORE.FEAT f1 ON fr1.FEAT_ID=f1.FEAT_ID AND f1.EDW_END_DTTM = ''9999-12-31 23:59:59.999999''

LEFT JOIN DB_T_PROD_CORE.FEAT_RLTD fr2 ON f.FEAT_ID=fr2.RLTD_FEAT_ID AND fr2.FEAT_RLTNSHP_TYPE_CD =''TERMOPT'' AND fr2.EDW_END_DTTM = ''9999-12-31 23:59:59.999999''

LEFT JOIN DB_T_PROD_CORE.FEAT f2 ON fr2.FEAT_ID=f2.FEAT_ID AND f2.EDW_END_DTTM = ''9999-12-31 23:59:59.999999''

LEFT JOIN DB_T_PROD_CORE.FEAT_RLTD fr3 ON f.FEAT_ID=fr3.RLTD_FEAT_ID AND fr3.FEAT_RLTNSHP_TYPE_CD =''COVOPTT'' AND fr3.EDW_END_DTTM = ''9999-12-31 23:59:59.999999''

LEFT JOIN DB_T_PROD_CORE.FEAT f3 ON fr3.FEAT_ID=f3.FEAT_ID AND f3.EDW_END_DTTM = ''9999-12-31 23:59:59.999999''

LEFT JOIN DB_T_PROD_CORE.FEAT_RLTD fr4 ON f.FEAT_ID=fr4.RLTD_FEAT_ID AND fr4.FEAT_RLTNSHP_TYPE_CD =''TERMPKG'' AND fr4.EDW_END_DTTM = ''9999-12-31 23:59:59.999999''

LEFT JOIN DB_T_PROD_CORE.FEAT f4 ON fr4.FEAT_ID=f4.FEAT_ID AND f4.EDW_END_DTTM = ''9999-12-31 23:59:59.999999''

LEFT JOIN DB_T_PROD_CORE.FEAT_RLTD fr5 ON f.FEAT_ID=fr5.RLTD_FEAT_ID AND fr5.FEAT_RLTNSHP_TYPE_CD =''COVPKG'' AND fr5.EDW_END_DTTM = ''9999-12-31 23:59:59.999999''

LEFT JOIN DB_T_PROD_CORE.FEAT f5 ON fr5.FEAT_ID=f5.FEAT_ID AND f5.EDW_END_DTTM = ''9999-12-31 23:59:59.999999''

WHERE f.FEAT_SBTYPE_CD IN (''TERM'', ''OPT'', ''PKG'')



AND CASE WHEN f.FEAT_SBTYPE_CD=''TERM'' THEN f1.NK_SRC_KEY

WHEN f.FEAT_SBTYPE_CD=''OPT'' THEN f3.NK_SRC_KEY

/*  added code for defect 18736 EQ-A054: BI_LIMIT  START */
WHEN f.FEAT_SBTYPE_CD=''PKG'' THEN f4.NK_SRC_KEY

/*  added code for defect 18736 EQ-A054: BI_LIMIT  END */
END  NOT IN (''HOLI_SCHEDULEDPROPERTYDEDUCTIBLESITEM_ALFA'', ''HOSI_SCHEDULEDPROPERTYITEM_ALFA'')

AND TERM_NAME=''LIMIT''

) ACL

ON ACL.AGMT_ID=AGMT.AGMT_ID AND ACL.PRTY_ASSET_ID=AGMT_ASSET.PRTY_ASSET_ID

LEFT OUTER JOIN   

(SELECT DISTINCT AGMT.AGMT_ID,FEAT.FEAT_ID,AGMT_INSRD_ASSET_FEAT.PRTY_ASSET_ID,FEAT.INSRNC_CVGE_TYPE_CD,FEAT.FEAT_NAME,FEAT.COMN_FEAT_NAME,FEAT.FEAT_DTL_VAL   FROM DB_T_PROD_CORE.AGMT

JOIN DB_T_PROD_CORE.AGMT_INSRD_ASSET_FEAT ON AGMT.AGMT_ID=AGMT_INSRD_ASSET_FEAT.AGMT_ID AND AGMT_INSRD_ASSET_FEAT.EDW_END_DTTM=''9999-12-31 23:59:59.999999'' 

JOIN DB_T_PROD_CORE.FEAT ON AGMT_INSRD_ASSET_FEAT.FEAT_ID=FEAT.FEAT_ID AND FEAT.EDW_END_DTTM=''9999-12-31 23:59:59.999999''

WHERE

AGMT.EDW_END_DTTM=''9999-12-31 23:59:59.999999''



	AND  feat_dtl_col_name like ''%Choice%''   AND FEAT_DTL_MODL_TYPE_NAME=''Deductible''

)	DED ON DED.AGMT_ID=AGMT.AGMT_ID AND DED.PRTY_ASSET_ID=AGMT_ASSET.PRTY_ASSET_ID



/* Added  below code for defect 18734  EQ-A028 */


LEFT OUTER JOIN

(SELECT DISTINCT AG.HOST_AGMT_NUM,FT.FEAT_NAME,AG.AGMT_ID,AGFT.PRTY_ASSET_ID,FT.COMN_FEAT_NAME,FT.FEAT_SBTYPE_CD,FT.FEAT_CLASFCN_CD,FT.VAL_TYPE_CD FROM DB_T_PROD_CORE.AGMT_INSRD_ASSET_FEAT AGFT

INNER JOIN DB_T_PROD_CORE.FEAT FT ON AGFT.FEAT_ID=FT.FEAT_ID

INNER JOIN DB_T_PROD_CORE.AGMT AG ON AGFT.AGMT_ID=AG.AGMT_ID

WHERE FT.INSRNC_CVGE_TYPE_CD=''UMUIM'' AND FT.FEAT_NAME IN (''Reduced'',''AddedOn'') AND FT.FEAT_DTL_CD_NAME IN (''Reduced'',''AddedOn'') 

and

AG.EDW_END_DTTM=''9999-12-31 23:59:59.999999''

  

)UNB ON UNB.AGMT_ID=AGMT.AGMT_ID AND UNB.PRTY_ASSET_ID=AGMT_ASSET.PRTY_ASSET_ID



WHERE

	POL_VEH_NUM IS NOT NULL AND MOTR_VEH.MOTR_VEH_SER_NUM <> ''UNK''

	

GROUP BY 1,2,3,4,5,6,7
) SRC
)
);


-- Component exp_pass_through, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_pass_through AS
(
SELECT
SQ_AGMT.HOST_AGMT_NUM as HOST_AGMT_NUM,
SQ_AGMT.POL_VEH_NUM as plcy_veh_key,
SQ_AGMT.AGMT_ID as AGMT_ID,
SQ_AGMT.MOTR_VEH_DTL_STRT_DTTM as MOTR_VEH_DTL_STRT_DTTM,
SQ_AGMT.MOTR_VEH_DTL_END_DTTM as MOTR_VEH_DTL_END_DTTM,
SQ_AGMT.AGMT_FEAT_AMT as AGMT_FEAT_AMT,
SQ_AGMT.AGMT_FEAT_AMT1 as AGMT_FEAT_AMT1,
SQ_AGMT.AGMT_FEAT_AMT2 as AGMT_FEAT_AMT2,
SQ_AGMT.AGMT_FEAT_AMT3 as AGMT_FEAT_AMT3,
SQ_AGMT.AGMT_FEAT_AMT4 as AGMT_FEAT_AMT4,
SQ_AGMT.AGMT_FEAT_AMT5 as AGMT_FEAT_AMT5,
SQ_AGMT.AGMT_FEAT_AMT6 as AGMT_FEAT_AMT6,
SQ_AGMT.AGMT_FEAT_AMT7 as AGMT_FEAT_AMT7,
SQ_AGMT.AGMT_FEAT_AMT8 as AGMT_FEAT_AMT8,
SQ_AGMT.AGMT_FEAT_AMT9 as AGMT_FEAT_AMT9,
SQ_AGMT.AGMT_FEAT_AMT9A as a9,
SQ_AGMT.AGMT_FEAT_AMT9B as b9,
SQ_AGMT.AGMT_FEAT_AMT10 as AGMT_FEAT_AMT10,
SQ_AGMT.UNB_ADDON_IND as UNB_ADDON_IND,
SQ_AGMT.UNB_RED_IND as UNB_RED_IND,
SQ_AGMT.AGMT_FEAT_AMT11 as AGMT_FEAT_AMT11,
SQ_AGMT.AGMT_FEAT_AMT12 as AGMT_FEAT_AMT12,
SQ_AGMT.AGMT_FEAT_AMT13 as AGMT_FEAT_AMT13,
SQ_AGMT.AGMT_FEAT_AMT14 as AGMT_FEAT_AMT14,
SQ_AGMT.UNSL_ADDON_IND as UNSL_ADDON_IND,
CASE WHEN SQ_AGMT.AGMT_FEAT_AMT14 IS NOT NULL THEN ''Y'' ELSE ''N'' END as AGMT_FEAT_AMT141,
SQ_AGMT.AGMT_FEAT_AMT15 as AGMT_FEAT_AMT15,
SQ_AGMT.AGMT_FEAT_AMT16 as AGMT_FEAT_AMT16,
SQ_AGMT.AGMT_FEAT_AMT17 as AGMT_FEAT_AMT17,
SQ_AGMT.AGMT_FEAT_AMT18 as AGMT_FEAT_AMT18,
SQ_AGMT.AGMT_FEAT_AMT19 as AGMT_FEAT_AMT19,
SQ_AGMT.AGMT_FEAT_AMT20 as AGMT_FEAT_AMT20,
SQ_AGMT.AGMT_FEAT_AMT21 as AGMT_FEAT_AMT21,
SQ_AGMT.AGMT_FEAT_AMT22 as AGMT_FEAT_AMT22,
:PRCS_ID as PRCS_ID,
CURRENT_TIMESTAMP as LOAD_DT,
SQ_AGMT.MO_ID as MO_ID,
SQ_AGMT.source_record_id
FROM
SQ_AGMT
);


-- Component EDW_EBLM_VEH_COV, Type TARGET 
INSERT INTO DB_T_PROD_WRK.EDW_EBLM_VEH_COV
(
MO_ID,
PLCY_NBR,
PLCY_VEH_KEY,
DW_PLCY_SKEY,
VEH_CHG_EFF_DT,
VEH_CHG_EXP_DT,
BI_LIMIT,
PD_LIMIT,
MED_LIMIT,
CMP_LIMIT,
COL_LIMIT,
CMP_DED,
COL_DED,
ERS_DED,
LOI_LIMIT,
LOU_LIMIT,
CS_IND,
CUS_IND,
UNB_LIMIT,
UNB_ADDON_IND,
UNB_RED_IND,
UND_DED,
UNP_LIMIT,
SL_LIMIT,
UNSL_LIMIT,
UNSL_ADDON_IND,
UNSL_RED_IND,
UNSL_DED,
LOI_IND,
ERS_IND,
LOU_IND,
CS_LIMIT,
SG_IND,
EXN_IND,
CUS_LIMIT,
GAP_IND,
PRCS_ID,
LOAD_DT
)
SELECT
exp_pass_through.MO_ID as MO_ID,
exp_pass_through.HOST_AGMT_NUM as PLCY_NBR,
exp_pass_through.plcy_veh_key as PLCY_VEH_KEY,
exp_pass_through.AGMT_ID as DW_PLCY_SKEY,
exp_pass_through.MOTR_VEH_DTL_STRT_DTTM as VEH_CHG_EFF_DT,
exp_pass_through.MOTR_VEH_DTL_END_DTTM as VEH_CHG_EXP_DT,
exp_pass_through.AGMT_FEAT_AMT as BI_LIMIT,
exp_pass_through.AGMT_FEAT_AMT1 as PD_LIMIT,
exp_pass_through.AGMT_FEAT_AMT2 as MED_LIMIT,
exp_pass_through.AGMT_FEAT_AMT3 as CMP_LIMIT,
exp_pass_through.AGMT_FEAT_AMT4 as COL_LIMIT,
exp_pass_through.AGMT_FEAT_AMT5 as CMP_DED,
exp_pass_through.AGMT_FEAT_AMT6 as COL_DED,
exp_pass_through.AGMT_FEAT_AMT7 as ERS_DED,
exp_pass_through.AGMT_FEAT_AMT8 as LOI_LIMIT,
exp_pass_through.AGMT_FEAT_AMT9 as LOU_LIMIT,
exp_pass_through.a9 as CS_IND,
exp_pass_through.b9 as CUS_IND,
exp_pass_through.AGMT_FEAT_AMT10 as UNB_LIMIT,
exp_pass_through.UNB_ADDON_IND as UNB_ADDON_IND,
exp_pass_through.UNB_RED_IND as UNB_RED_IND,
exp_pass_through.AGMT_FEAT_AMT11 as UND_DED,
exp_pass_through.AGMT_FEAT_AMT12 as UNP_LIMIT,
exp_pass_through.AGMT_FEAT_AMT13 as SL_LIMIT,
exp_pass_through.AGMT_FEAT_AMT14 as UNSL_LIMIT,
exp_pass_through.UNSL_ADDON_IND as UNSL_ADDON_IND,
exp_pass_through.AGMT_FEAT_AMT141 as UNSL_RED_IND,
exp_pass_through.AGMT_FEAT_AMT14 as UNSL_DED,
exp_pass_through.AGMT_FEAT_AMT15 as LOI_IND,
exp_pass_through.AGMT_FEAT_AMT16 as ERS_IND,
exp_pass_through.AGMT_FEAT_AMT17 as LOU_IND,
exp_pass_through.AGMT_FEAT_AMT18 as CS_LIMIT,
exp_pass_through.AGMT_FEAT_AMT19 as SG_IND,
exp_pass_through.AGMT_FEAT_AMT20 as EXN_IND,
exp_pass_through.AGMT_FEAT_AMT21 as CUS_LIMIT,
exp_pass_through.AGMT_FEAT_AMT22 as GAP_IND,
exp_pass_through.PRCS_ID as PRCS_ID,
exp_pass_through.LOAD_DT as LOAD_DT
FROM
exp_pass_through;


END; ';