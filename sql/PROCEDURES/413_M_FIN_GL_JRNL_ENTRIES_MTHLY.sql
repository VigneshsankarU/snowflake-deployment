-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_FIN_GL_JRNL_ENTRIES_MTHLY("RUN_ID" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' BEGIN 

-- Component AGG_COUNT_BALANCE, Type Pre SQL 
DELETE FROM AGG_COUNT_BALANCE WHERE MO_ID = :wf_MONTH_ID  AND CALC_SRC = ''JRNL'';


-- Component LKP_ECTL_BATCH_INFO, Type Prerequisite Lookup Object 
CREATE OR REPLACE TEMPORARY TABLE LKP_ECTL_BATCH_INFO AS
(
SELECT ECTL_BATCH_INFO.ECTL_BATCH_ID as ECTL_BATCH_ID, 1 as DUMMY FROM ECTL_BATCH_INFO
WHERE  ECTL_BATCH_INFO.ECTL_ACTIVE_IND =''Y''  AND   ECTL_BATCH_INFO.ECTL_PROJ_ID = :ACT_PROJ_ID
);


-- Component LKP_FIN_METRIC_ACCT_NBR_LKUP, Type Prerequisite Lookup Object 
CREATE OR REPLACE TEMPORARY TABLE LKP_FIN_METRIC_ACCT_NBR_LKUP AS
(
SELECT * FROM(SELECT DISTINCT FIN_METRIC_ACCT_NBR_LKUP.METRIC_SHORT_NM as METRIC_SHORT_NM, FIN_METRIC_ACCT_NBR_LKUP.ACCT_NBR as ACCT_NBR FROM FIN_METRIC_ACCT_NBR_LKUP
WHERE METRIC_SHORT_NM IN (''DWP'',''PL'',''LOSSRES'',''UEP'',''PLAE'')
UNION 
SELECT DISTINCT  ''UEP'' as METRIC_SHORT_NM,''400353''  as ACCT_NBR FROM FIN_METRIC_ACCT_NBR_LKUP)A
);


-- Component sq_PS_JRNL_LN, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE sq_PS_JRNL_LN AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as MO_ID,
$2 as JOURNAL_ID,
$3 as CMPY_CD,
$4 as ST_CD,
$5 as PRODUCT,
$6 as ACCOUNT,
$7 as LINE_DESCR,
$8 as LEDGER,
$9 as SRC_CD,
$10 as REINS_CD,
$11 as MONETARY_AMOUNT,
$12 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT  

B.FISCAL_YEAR*100+B.ACCOUNTING_PERIOD AS MO_ID,

A.JOURNAL_ID AS JOURNAL_ID,

B.BUSINESS_UNIT AS CMPY_CD,

A.CHARTFIELD1 AS ST_CD,

A.PRODUCT ,

A.ACCOUNT,

A.LINE_DESCR,

A.LEDGER,

B.SOURCE AS SRC_CD,

A.CHARTFIELD3 AS REINS_CD,

SUM(A.MONETARY_AMOUNT) AS MONETARY_AMOUNT 

FROM DBNAME.PS_DB2_OWNER.PS_JRNL_LN A, DBNAME.PS_DB2_OWNER.PS_JRNL_HEADER B 

WHERE 

A.BUSINESS_UNIT = B.BUSINESS_UNIT 

AND A.JOURNAL_ID = B.JOURNAL_ID 

AND A.JOURNAL_DATE = B.JOURNAL_DATE 

AND A.UNPOST_SEQ = B.UNPOST_SEQ 

AND B.FISCAL_YEAR*100+B.ACCOUNTING_PERIOD = :wf_MONTH_ID

AND B.ACCOUNTING_PERIOD BETWEEN 1 AND 12

AND B.JRNL_HDR_STATUS IN (''P'',''U'') 

AND A.LEDGER IN (''ACTUALS'',''GAAP'',''STATUTORY'') 

AND A.CHARTFIELD1 IN (''AL'',''GA'',''MS'')

GROUP BY 

B.FISCAL_YEAR*100+B.ACCOUNTING_PERIOD,

A.JOURNAL_ID,

B.BUSINESS_UNIT,

B.FISCAL_YEAR,

B.ACCOUNTING_PERIOD,

A.CHARTFIELD1,

A.ACCOUNT,

A.LINE_DESCR,

A.PRODUCT,

A.LEDGER,

B.SOURCE,

A.CHARTFIELD3
) SRC
)
);


-- Component exp_DATA_CLEANSE_JRNL, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_DATA_CLEANSE_JRNL AS
(
SELECT
sq_PS_JRNL_LN.MO_ID as MO_ID,
LTRIM ( RTRIM ( sq_PS_JRNL_LN.JOURNAL_ID ) ) as out_JOURNAL_ID,
LTRIM ( RTRIM ( sq_PS_JRNL_LN.ST_CD ) ) as out_ST_CD,
CASE WHEN LTRIM ( RTRIM ( sq_PS_JRNL_LN.PRODUCT ) ) IS NULL OR LTRIM ( RTRIM ( sq_PS_JRNL_LN.PRODUCT ) ) = '''' THEN ''NO_PRD'' ELSE sq_PS_JRNL_LN.PRODUCT END as out_PRODUCT,
TO_NUMBER(LTRIM ( RTRIM ( sq_PS_JRNL_LN.ACCOUNT ) )) as out_ACCOUNT,
LTRIM ( RTRIM ( sq_PS_JRNL_LN.LINE_DESCR ) ) as out_LINE_DESCR,
LTRIM ( RTRIM ( sq_PS_JRNL_LN.LEDGER ) ) as out_LEDGER,
LTRIM ( RTRIM ( sq_PS_JRNL_LN.SRC_CD ) ) as out_SRC_CD,
LTRIM ( RTRIM ( sq_PS_JRNL_LN.REINS_CD ) ) as out_REINS_CD,
1 as var_DUMMY,
LKP_1.ECTL_BATCH_ID /* replaced lookup LKP_ECTL_BATCH_INFO */ as var_ECTL_BATCH_ID,
CASE WHEN var_ECTL_BATCH_ID IS NULL THEN RAISE_ERROR(''There is no active financial ECTL batch for the month '' || TO_CHAR ( sq_PS_JRNL_LN.MO_ID ) || '', The mapping is aborted'') ELSE $3 END as var_ECTL_BATCH_ID_ABORT,
var_ECTL_BATCH_ID as out_ECTL_BATCH_ID,
sq_PS_JRNL_LN.MONETARY_AMOUNT as MONETARY_AMOUNT,
sq_PS_JRNL_LN.source_record_id,
row_number() over (partition by sq_PS_JRNL_LN.source_record_id order by sq_PS_JRNL_LN.source_record_id) as RNK
FROM
sq_PS_JRNL_LN
LEFT JOIN LKP_ECTL_BATCH_INFO LKP_1 ON LKP_1.DUMMY = var_DUMMY
QUALIFY RNK = 1
);


-- Component exp_DERIVE_FLAG_STATE, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_DERIVE_FLAG_STATE AS
(
SELECT
exp_DATA_CLEANSE_JRNL.out_ECTL_BATCH_ID as ECTL_BATCH_ID,
exp_DATA_CLEANSE_JRNL.MO_ID as MO_ID,
LKP_1.METRIC_SHORT_NM /* replaced lookup LKP_FIN_METRIC_ACCT_NBR_LKUP */ as var_METRIC_SHORT_NM,
CASE
  WHEN var_METRIC_SHORT_NM = ''DWP''
  AND exp_DATA_CLEANSE_JRNL.out_REINS_CD = ''D'' THEN exp_DATA_CLEANSE_JRNL.out_ST_CD || '': '' || ''WP: '' || exp_DATA_CLEANSE_JRNL.out_PRODUCT || '': GL Query of P&C Premiums''
  WHEN var_METRIC_SHORT_NM = ''UEP''
  AND exp_DATA_CLEANSE_JRNL.out_REINS_CD = ''D'' THEN exp_DATA_CLEANSE_JRNL.out_ST_CD || '': '' || ''UP: '' || exp_DATA_CLEANSE_JRNL.out_PRODUCT || '': GL Query of P&C Premiums''
  WHEN var_METRIC_SHORT_NM = ''PL''
  AND exp_DATA_CLEANSE_JRNL.out_REINS_CD IN ('''', ''D'')
  AND exp_DATA_CLEANSE_JRNL.out_LEDGER IN (''ACTUALS'', ''STATUTORY'') THEN exp_DATA_CLEANSE_JRNL.out_ST_CD || '': '' || ''PL: '' || exp_DATA_CLEANSE_JRNL.out_PRODUCT || '': GL Query of P&C Losses''
  WHEN var_METRIC_SHORT_NM = ''LOSSRES''
  AND exp_DATA_CLEANSE_JRNL.out_REINS_CD IN ('''', ''D'')
  AND exp_DATA_CLEANSE_JRNL.out_LEDGER IN (''ACTUALS'', ''STATUTORY'') THEN exp_DATA_CLEANSE_JRNL.out_ST_CD || '': '' || ''CR: '' || exp_DATA_CLEANSE_JRNL.out_PRODUCT || '': GL Query of P&C Losses''
  ELSE NULL
END AS out_METRIC_SHORT_NM,

exp_DATA_CLEANSE_JRNL.MONETARY_AMOUNT as MONETARY_AMOUNT,
exp_DATA_CLEANSE_JRNL.source_record_id,
row_number() over (partition by exp_DATA_CLEANSE_JRNL.source_record_id order by exp_DATA_CLEANSE_JRNL.source_record_id) as RNK
FROM
exp_DATA_CLEANSE_JRNL
LEFT JOIN LKP_FIN_METRIC_ACCT_NBR_LKUP LKP_1 ON LKP_1.ACCT_NBR = exp_DATA_CLEANSE_JRNL.out_ACCOUNT
QUALIFY RNK = 1
);


-- Component LKP_FIN_PRODUCT_HIER, Type LOOKUP 
CREATE OR REPLACE TEMPORARY TABLE LKP_FIN_PRODUCT_HIER AS
(
SELECT
LKP.LOB_ROLLUP,
LKP.DTL_LOB_ROLLUP,
exp_DATA_CLEANSE_JRNL.source_record_id,
ROW_NUMBER() OVER(PARTITION BY exp_DATA_CLEANSE_JRNL.source_record_id ORDER BY LKP.LOB_ROLLUP asc,LKP.DTL_LOB_ROLLUP asc) RNK
FROM
exp_DATA_CLEANSE_JRNL
LEFT JOIN (
SELECT DISTINCT FIN_PRODUCT_HIER.LOB_ROLLUP as LOB_ROLLUP,
		FIN_PRODUCT_HIER.DTL_LOB_ROLLUP as DTL_LOB_ROLLUP, 
		FIN_PRODUCT_HIER.PRODUCT_CD as PRODUCT_CD 
FROM	FIN_PRODUCT_HIER
) LKP ON LKP.PRODUCT_CD = exp_DATA_CLEANSE_JRNL.out_PRODUCT
QUALIFY RNK = 1
);


-- Component sq_PS_ALF_REPOS_CLM_S, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE sq_PS_ALF_REPOS_CLM_S AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as SRC,
$2 as CHARTFIELD1,
$3 as FISCAL_YEAR,
$4 as ACCOUNTING_PERIOD,
$5 as ACCOUNT,
$6 as PRODUCT,
$7 as MONETARY_AMOUNT,
$8 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT 

''CLM'' AS SRC,

A.CHARTFIELD1,

A.FISCAL_YEAR,

A.ACCOUNTING_PERIOD,

A.ACCOUNT,

A.PRODUCT,

SUM(MONETARY_AMOUNT)

FROM DBNAME.DB_T_STAG_FIN_PROD.PS_ALF_REPOS_CLM_S AS A 

WHERE A.FISCAL_YEAR*100+A.ACCOUNTING_PERIOD  = :wf_MONTH_ID

AND A.CHARTFIELD1 IN (''AL'',''GA'',''MS'') 

AND A.GL_DISTRIB_STATUS = ''D'' 

GROUP BY 

A.CHARTFIELD1,

A.FISCAL_YEAR,

A.ACCOUNTING_PERIOD,

A.ACCOUNT,

A.PRODUCT

UNION ALL 

SELECT 

''S3C'' AS SRC,

A.CHARTFIELD1,

A.FISCAL_YEAR,

A.ACCOUNTING_PERIOD,

A.ACCOUNT,

A.PRODUCT,

SUM(MONETARY_AMOUNT)

FROM DBNAME.DB_T_STAG_FIN_PROD.PS_ALF_REPOS_S3C_S AS A 

WHERE A.FISCAL_YEAR*100+A.ACCOUNTING_PERIOD  = :wf_MONTH_ID

AND A.CHARTFIELD1 IN (''AL'',''GA'',''MS'') 

AND A.GL_DISTRIB_STATUS = ''D'' 

GROUP BY 

A.CHARTFIELD1,

A.FISCAL_YEAR,

A.ACCOUNTING_PERIOD,

A.ACCOUNT,

A.PRODUCT
) SRC
)
);


-- Component exp_DATA_CLEANSE_REPOS, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_DATA_CLEANSE_REPOS AS
(
SELECT
LTRIM ( RTRIM ( sq_PS_ALF_REPOS_CLM_S.CHARTFIELD1 ) ) as out_CHARTFIELD1,
TO_NUMBER(LTRIM ( RTRIM ( sq_PS_ALF_REPOS_CLM_S.ACCOUNT ) )) as out_ACCOUNT,
CASE WHEN LTRIM ( RTRIM ( sq_PS_ALF_REPOS_CLM_S.PRODUCT ) ) IS NULL OR LTRIM ( RTRIM ( sq_PS_ALF_REPOS_CLM_S.PRODUCT ) ) = '''' THEN ''NO_PRD'' ELSE sq_PS_ALF_REPOS_CLM_S.PRODUCT END as out_PRODUCT,
1 as var_DUMMY,
sq_PS_ALF_REPOS_CLM_S.FISCAL_YEAR * 100 + sq_PS_ALF_REPOS_CLM_S.ACCOUNTING_PERIOD as var_MO_ID,
var_MO_ID as out_MO_ID,
LKP_1.ECTL_BATCH_ID /* replaced lookup LKP_ECTL_BATCH_INFO */ as var_ECTL_BATCH_ID,
CASE WHEN var_ECTL_BATCH_ID IS NULL THEN RAISE_ERROR(''There is no active financial ECTL batch for the month '' || TO_CHAR ( var_MO_ID ) || '', The mapping is aborted'') ELSE $3 END as var_ECTL_BATCH_ID_ABORT,
var_ECTL_BATCH_ID as out_ECTL_BATCH_ID,
sq_PS_ALF_REPOS_CLM_S.MONETARY_AMOUNT as MONETARY_AMOUNT,
sq_PS_ALF_REPOS_CLM_S.source_record_id,
row_number() over (partition by sq_PS_ALF_REPOS_CLM_S.source_record_id order by sq_PS_ALF_REPOS_CLM_S.source_record_id) as RNK
FROM
sq_PS_ALF_REPOS_CLM_S
LEFT JOIN LKP_ECTL_BATCH_INFO LKP_1 ON LKP_1.DUMMY = var_DUMMY
QUALIFY RNK = 1
);


-- Component exp_DERIVE_FLAG_AE, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_DERIVE_FLAG_AE AS
(
SELECT
exp_DATA_CLEANSE_REPOS.out_ECTL_BATCH_ID as ECTL_BATCH_ID,
exp_DATA_CLEANSE_REPOS.out_MO_ID as MO_ID,
LKP_1.METRIC_SHORT_NM /* replaced lookup LKP_FIN_METRIC_ACCT_NBR_LKUP */ as var_METRIC_SHORT_NM,
DECODE ( TRUE , var_METRIC_SHORT_NM = ''PLAE'' , exp_DATA_CLEANSE_REPOS.out_CHARTFIELD1 || '': '' || ''AE: '' || exp_DATA_CLEANSE_REPOS.out_PRODUCT || '': Loss Adjustment Expense'' , NULL ) as out_METRIC_SHORT_NM,
exp_DATA_CLEANSE_REPOS.MONETARY_AMOUNT as MONETARY_AMOUNT,
exp_DATA_CLEANSE_REPOS.source_record_id,
row_number() over (partition by exp_DATA_CLEANSE_REPOS.source_record_id order by exp_DATA_CLEANSE_REPOS.source_record_id) as RNK
FROM
exp_DATA_CLEANSE_REPOS
LEFT JOIN LKP_FIN_METRIC_ACCT_NBR_LKUP LKP_1 ON LKP_1.ACCT_NBR = exp_DATA_CLEANSE_REPOS.out_ACCOUNT
QUALIFY RNK = 1
);


-- Component exp_DERIVE_FLAG_EP, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_DERIVE_FLAG_EP AS
(
SELECT
exp_DATA_CLEANSE_JRNL.out_ECTL_BATCH_ID as ECTL_BATCH_ID,
exp_DATA_CLEANSE_JRNL.MO_ID as MO_ID,
LKP_1.METRIC_SHORT_NM /* replaced lookup LKP_FIN_METRIC_ACCT_NBR_LKUP */ as var_METRIC_SHORT_NM,
CASE
  WHEN exp_DATA_CLEANSE_JRNL.out_REINS_CD ILIKE ''%D%''
  AND var_METRIC_SHORT_NM IN (''DWP'', ''UEP'') THEN exp_DATA_CLEANSE_JRNL.out_ST_CD || '': '' || ''EP: '' || exp_DATA_CLEANSE_JRNL.out_PRODUCT || '': GL Query of P&C Premiums''
  ELSE NULL
END AS out_METRIC_SHORT_NM,
exp_DATA_CLEANSE_JRNL.MONETARY_AMOUNT as MONETARY_AMOUNT,
exp_DATA_CLEANSE_JRNL.source_record_id,
row_number() over (partition by exp_DATA_CLEANSE_JRNL.source_record_id order by exp_DATA_CLEANSE_JRNL.source_record_id) as RNK
FROM
exp_DATA_CLEANSE_JRNL
LEFT JOIN LKP_FIN_METRIC_ACCT_NBR_LKUP LKP_1 ON LKP_1.ACCT_NBR = exp_DATA_CLEANSE_JRNL.out_ACCOUNT
QUALIFY RNK = 1
);


-- Component exp_DERIVE_FLAG_PRODUCT, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_DERIVE_FLAG_PRODUCT AS
(
SELECT
exp_DATA_CLEANSE_JRNL.out_ECTL_BATCH_ID as ECTL_BATCH_ID,
exp_DATA_CLEANSE_JRNL.MO_ID as MO_ID,
LKP_1.METRIC_SHORT_NM /* replaced lookup LKP_FIN_METRIC_ACCT_NBR_LKUP */ as var_METRIC_SHORT_NM,
CASE
    WHEN exp_DATA_CLEANSE_JRNL.out_REINS_CD = ''D'' AND var_METRIC_SHORT_NM = ''DWP'' AND POSITION(''EO'', exp_DATA_CLEANSE_JRNL.out_PRODUCT) > 0 THEN
        ''WP: '' || exp_DATA_CLEANSE_JRNL.out_PRODUCT || '': Other Liability - Claims Made - E&O''
    WHEN exp_DATA_CLEANSE_JRNL.out_REINS_CD = ''D'' AND var_METRIC_SHORT_NM = ''DWP'' AND POSITION(''AD'', exp_DATA_CLEANSE_JRNL.out_PRODUCT) > 0 THEN
        ''WP: '' || exp_DATA_CLEANSE_JRNL.out_PRODUCT || '': Other A&H - Accidental Death''
    WHEN exp_DATA_CLEANSE_JRNL.out_REINS_CD = ''D'' AND exp_DATA_CLEANSE_JRNL.out_ACCOUNT = 549200 THEN
        ''WP: '' || exp_DATA_CLEANSE_JRNL.out_PRODUCT || '': Credit - Nonrecorded Mortgage''
    WHEN exp_DATA_CLEANSE_JRNL.out_REINS_CD = ''D'' AND exp_DATA_CLEANSE_JRNL.out_ACCOUNT = 400250 AND POSITION(''ARWP'', exp_DATA_CLEANSE_JRNL.out_JOURNAL_ID) > 0 THEN
        ''WP: '' || exp_DATA_CLEANSE_JRNL.out_PRODUCT || '': Assigned Risk Policies''
    WHEN exp_DATA_CLEANSE_JRNL.out_REINS_CD = ''D'' AND exp_DATA_CLEANSE_JRNL.out_ACCOUNT = 400300 AND POSITION(''W/P'', exp_DATA_CLEANSE_JRNL.out_LINE_DESCR) = 0 AND POSITION(''Interface'', exp_DATA_CLEANSE_JRNL.out_LINE_DESCR) = 0 THEN
        ''WP: '' || exp_DATA_CLEANSE_JRNL.out_PRODUCT || '': Account 400300 Return Premium''
    WHEN exp_DATA_CLEANSE_JRNL.out_REINS_CD = ''D'' AND exp_DATA_CLEANSE_JRNL.out_ACCOUNT = 400303 THEN
        ''WP: '' || exp_DATA_CLEANSE_JRNL.out_PRODUCT || '': Credits outside Exceed (manual JE)''
    WHEN exp_DATA_CLEANSE_JRNL.out_REINS_CD = ''D'' AND POSITION(''ASIOO Premium Feed'', exp_DATA_CLEANSE_JRNL.out_LINE_DESCR) > 0 AND var_METRIC_SHORT_NM = ''DWP'' AND exp_DATA_CLEANSE_JRNL.out_ACCOUNT NOT IN (402300, 402310) THEN
        ''WP: '' || exp_DATA_CLEANSE_JRNL.out_PRODUCT || '': ASI-Non-Core Auto Premium''
    WHEN exp_DATA_CLEANSE_JRNL.out_REINS_CD = ''D'' AND exp_DATA_CLEANSE_JRNL.out_ACCOUNT = 402300 AND exp_DATA_CLEANSE_JRNL.out_ST_CD = ''GA'' THEN
        ''WP: '' || exp_DATA_CLEANSE_JRNL.out_PRODUCT || '': Account 402300 - Fees''
    WHEN exp_DATA_CLEANSE_JRNL.out_REINS_CD = ''D'' AND exp_DATA_CLEANSE_JRNL.out_ACCOUNT = 402310 AND exp_DATA_CLEANSE_JRNL.out_ST_CD = ''GA'' THEN
        ''WP: '' || exp_DATA_CLEANSE_JRNL.out_PRODUCT || '': Account 402310 - Fees''
    WHEN exp_DATA_CLEANSE_JRNL.out_REINS_CD = ''D'' AND exp_DATA_CLEANSE_JRNL.out_ACCOUNT = 402300 AND exp_DATA_CLEANSE_JRNL.out_ST_CD = ''MS'' AND POSITION(''Fees'', exp_DATA_CLEANSE_JRNL.out_LINE_DESCR) > 0 THEN
        ''WP: '' || exp_DATA_CLEANSE_JRNL.out_PRODUCT || '': Account 402300 - Fees''
    WHEN exp_DATA_CLEANSE_JRNL.out_REINS_CD = ''D'' AND exp_DATA_CLEANSE_JRNL.out_ACCOUNT = 402310 AND exp_DATA_CLEANSE_JRNL.out_ST_CD = ''MS'' AND POSITION(''Fees'', exp_DATA_CLEANSE_JRNL.out_LINE_DESCR) > 0 THEN
        ''WP: '' || exp_DATA_CLEANSE_JRNL.out_PRODUCT || '': Account 402310 - Fees''
    WHEN exp_DATA_CLEANSE_JRNL.out_REINS_CD = ''D'' AND var_METRIC_SHORT_NM = ''DWP'' AND (
        POSITION(''EBUB'', exp_DATA_CLEANSE_JRNL.out_LINE_DESCR) > 0 OR 
        (POSITION(''W/P'', exp_DATA_CLEANSE_JRNL.out_LINE_DESCR) > 0 AND POSITION(''EO'', exp_DATA_CLEANSE_JRNL.out_PRODUCT) = 0 AND LKP_FIN_PRODUCT_HIER.LOB_ROLLUP != ''Private Passenger Auto'')
    ) THEN
        ''WP: '' || exp_DATA_CLEANSE_JRNL.out_PRODUCT || '': YE EBUB adjustments''
    WHEN exp_DATA_CLEANSE_JRNL.out_REINS_CD = ''D'' AND var_METRIC_SHORT_NM = ''DWP'' AND LKP_FIN_PRODUCT_HIER.DTL_LOB_ROLLUP = ''Calf'' THEN
        ''WP: '' || exp_DATA_CLEANSE_JRNL.out_PRODUCT || '': Inland Marine - Calf''
    WHEN exp_DATA_CLEANSE_JRNL.out_REINS_CD = ''D'' AND var_METRIC_SHORT_NM = ''UEP'' AND POSITION(''ARUP'', exp_DATA_CLEANSE_JRNL.out_JOURNAL_ID) > 0 THEN
        ''UP: '' || exp_DATA_CLEANSE_JRNL.out_PRODUCT || '': Assigned Risk Policies''
    WHEN exp_DATA_CLEANSE_JRNL.out_REINS_CD = ''D'' AND var_METRIC_SHORT_NM = ''UEP'' AND POSITION(''EO'', exp_DATA_CLEANSE_JRNL.out_PRODUCT) > 0 THEN
        ''UP: '' || exp_DATA_CLEANSE_JRNL.out_PRODUCT || '': Other Liability - Claims Made - E&O''
    WHEN exp_DATA_CLEANSE_JRNL.out_REINS_CD = ''D'' AND var_METRIC_SHORT_NM = ''UEP'' AND POSITION(''AD'', exp_DATA_CLEANSE_JRNL.out_PRODUCT) > 0 THEN
        ''UP: '' || exp_DATA_CLEANSE_JRNL.out_PRODUCT || '': Other A&H - Accidental Death''
    WHEN exp_DATA_CLEANSE_JRNL.out_REINS_CD = ''D'' AND var_METRIC_SHORT_NM = ''UEP'' AND LKP_FIN_PRODUCT_HIER.DTL_LOB_ROLLUP = ''Calf'' THEN
        ''UP: '' || exp_DATA_CLEANSE_JRNL.out_PRODUCT || '': Inland Marine - Calf''
    WHEN exp_DATA_CLEANSE_JRNL.out_REINS_CD = ''D'' AND var_METRIC_SHORT_NM = ''UEP'' AND exp_DATA_CLEANSE_JRNL.out_ST_CD = ''GA'' AND POSITION(''ASIOO Premium Feed'', exp_DATA_CLEANSE_JRNL.out_LINE_DESCR) > 0 THEN
        ''UP: '' || exp_DATA_CLEANSE_JRNL.out_PRODUCT || '': Brentwood UEP - GA E&O - ASI Noncore''
    WHEN exp_DATA_CLEANSE_JRNL.out_REINS_CD = ''D'' AND var_METRIC_SHORT_NM = ''UEP'' AND exp_DATA_CLEANSE_JRNL.out_ST_CD = ''GA'' AND exp_DATA_CLEANSE_JRNL.out_LINE_DESCR = ''UEP Policy Fees'' THEN
        ''UP: '' || exp_DATA_CLEANSE_JRNL.out_PRODUCT || '': Brentwood UEP - GA AVI''
    WHEN var_METRIC_SHORT_NM = ''PL'' AND exp_DATA_CLEANSE_JRNL.out_REINS_CD IN ('''', ''D'') AND exp_DATA_CLEANSE_JRNL.out_LEDGER IN (''ACTUALS'', ''STATUTORY'') AND exp_DATA_CLEANSE_JRNL.out_SRC_CD NOT IN (''CLM'', ''S3C'', ''GW'') THEN
        ''PL: '' || exp_DATA_CLEANSE_JRNL.out_PRODUCT || '': GL P&C Losses other than CLM and S3C''
    WHEN var_METRIC_SHORT_NM = ''LOSSRES'' AND exp_DATA_CLEANSE_JRNL.out_REINS_CD IN ('''', ''D'') AND exp_DATA_CLEANSE_JRNL.out_LEDGER IN (''ACTUALS'', ''STATUTORY'') AND exp_DATA_CLEANSE_JRNL.out_SRC_CD NOT IN (''CLM'', ''S3C'', ''GW'') THEN
        ''CR: '' || exp_DATA_CLEANSE_JRNL.out_PRODUCT || '': GL P&C Losses other than CLM and S3C''
    ELSE NULL
END AS var_METRIC_NM1,

CASE WHEN var_METRIC_NM1 IS NOT NULL THEN LTRIM ( RTRIM ( exp_DATA_CLEANSE_JRNL.out_ST_CD ) ) || '': '' || var_METRIC_NM1 ELSE NULL END as out_METRIC_SHORT_NM,
exp_DATA_CLEANSE_JRNL.MONETARY_AMOUNT as MONETARY_AMOUNT,
exp_DATA_CLEANSE_JRNL.source_record_id,
row_number() over (partition by exp_DATA_CLEANSE_JRNL.source_record_id order by exp_DATA_CLEANSE_JRNL.source_record_id) as RNK
FROM
exp_DATA_CLEANSE_JRNL
INNER JOIN LKP_FIN_PRODUCT_HIER ON exp_DATA_CLEANSE_JRNL.source_record_id = LKP_FIN_PRODUCT_HIER.source_record_id
LEFT JOIN LKP_FIN_METRIC_ACCT_NBR_LKUP LKP_1 ON LKP_1.ACCT_NBR = exp_DATA_CLEANSE_JRNL.out_ACCOUNT
QUALIFY RNK = 1
);


-- Component un_MERGE_RECORDS, Type UNION_TRANSFORMATION 
CREATE OR REPLACE TEMPORARY TABLE un_MERGE_RECORDS AS
(
/* Union Group ST */
SELECT
exp_DERIVE_FLAG_STATE.ECTL_BATCH_ID,
exp_DERIVE_FLAG_STATE.MO_ID,
exp_DERIVE_FLAG_STATE.out_METRIC_SHORT_NM as METRIC_SHORT_NM,
exp_DERIVE_FLAG_STATE.MONETARY_AMOUNT,
exp_DERIVE_FLAG_STATE.source_record_id
FROM exp_DERIVE_FLAG_STATE
UNION ALL
/* Union Group PRODUCT */
SELECT
exp_DERIVE_FLAG_PRODUCT.ECTL_BATCH_ID,
exp_DERIVE_FLAG_PRODUCT.MO_ID,
exp_DERIVE_FLAG_PRODUCT.out_METRIC_SHORT_NM as METRIC_SHORT_NM,
exp_DERIVE_FLAG_PRODUCT.MONETARY_AMOUNT,
exp_DERIVE_FLAG_PRODUCT.source_record_id
FROM exp_DERIVE_FLAG_PRODUCT
UNION ALL
/* Union Group REPOS */
SELECT
exp_DERIVE_FLAG_AE.ECTL_BATCH_ID,
exp_DERIVE_FLAG_AE.MO_ID,
exp_DERIVE_FLAG_AE.out_METRIC_SHORT_NM as METRIC_SHORT_NM,
exp_DERIVE_FLAG_AE.MONETARY_AMOUNT,
exp_DERIVE_FLAG_AE.source_record_id
FROM exp_DERIVE_FLAG_AE
UNION ALL
/* Union Group EP */
SELECT
exp_DERIVE_FLAG_EP.ECTL_BATCH_ID,
exp_DERIVE_FLAG_EP.MO_ID,
exp_DERIVE_FLAG_EP.out_METRIC_SHORT_NM as METRIC_SHORT_NM,
exp_DERIVE_FLAG_EP.MONETARY_AMOUNT,
exp_DERIVE_FLAG_EP.source_record_id
FROM exp_DERIVE_FLAG_EP
);


-- Component fil_REJECT_NULL_METRIC_NM_JRNL, Type FILTER 
CREATE OR REPLACE TEMPORARY TABLE fil_REJECT_NULL_METRIC_NM_JRNL AS
(
SELECT
un_MERGE_RECORDS.ECTL_BATCH_ID as ECTL_BATCH_ID,
un_MERGE_RECORDS.MO_ID as MO_ID,
un_MERGE_RECORDS.METRIC_SHORT_NM as METRIC_SHORT_NM,
un_MERGE_RECORDS.MONETARY_AMOUNT as MONETARY_AMOUNT,
un_MERGE_RECORDS.source_record_id
FROM
un_MERGE_RECORDS
WHERE un_MERGE_RECORDS.METRIC_SHORT_NM IS NOT NULL
);


-- Component agg_METRIC_CNT, Type AGGREGATOR 
CREATE OR REPLACE TEMPORARY TABLE agg_METRIC_CNT AS
(
SELECT
fil_REJECT_NULL_METRIC_NM_JRNL.ECTL_BATCH_ID as ECTL_BATCH_ID,
fil_REJECT_NULL_METRIC_NM_JRNL.MO_ID as MO_ID,
fil_REJECT_NULL_METRIC_NM_JRNL.METRIC_SHORT_NM as METRIC_SHORT_NM,
MIN(fil_REJECT_NULL_METRIC_NM_JRNL.MONETARY_AMOUNT) as in_MONETARY_AMOUNT,
sum(in_MONETARY_AMOUNT) as out_MONETARY_AMOUNT,
MIN(fil_REJECT_NULL_METRIC_NM_JRNL.source_record_id) as source_record_id
FROM
fil_REJECT_NULL_METRIC_NM_JRNL
GROUP BY
fil_REJECT_NULL_METRIC_NM_JRNL.ECTL_BATCH_ID,
fil_REJECT_NULL_METRIC_NM_JRNL.MO_ID,
fil_REJECT_NULL_METRIC_NM_JRNL.METRIC_SHORT_NM
);


-- Component fil_REJECT_NULL_METRIC_AMT_JRNL, Type FILTER 
CREATE OR REPLACE TEMPORARY TABLE fil_REJECT_NULL_METRIC_AMT_JRNL AS
(
SELECT
agg_METRIC_CNT.ECTL_BATCH_ID as ECTL_BATCH_ID,
agg_METRIC_CNT.MO_ID as MO_ID,
agg_METRIC_CNT.METRIC_SHORT_NM as METRIC_SHORT_NM,
agg_METRIC_CNT.out_MONETARY_AMOUNT as MONETARY_AMOUNT,
agg_METRIC_CNT.source_record_id
FROM
agg_METRIC_CNT
WHERE agg_METRIC_CNT.out_MONETARY_AMOUNT <> 0
);


-- Component exp_ASSIGN_DEFAULT_VALUE, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_ASSIGN_DEFAULT_VALUE AS
(
SELECT
fil_REJECT_NULL_METRIC_AMT_JRNL.ECTL_BATCH_ID as ECTL_BATCH_ID,
fil_REJECT_NULL_METRIC_AMT_JRNL.MO_ID as MO_ID,
''JRNL'' as out_CALC_SRC,
''ALL'' as out_TBL_NM,
fil_REJECT_NULL_METRIC_AMT_JRNL.METRIC_SHORT_NM as METRIC_SHORT_NM,
fil_REJECT_NULL_METRIC_AMT_JRNL.MONETARY_AMOUNT as MONETARY_AMOUNT,
fil_REJECT_NULL_METRIC_AMT_JRNL.source_record_id
FROM
fil_REJECT_NULL_METRIC_AMT_JRNL
);


-- Component AGG_COUNT_BALANCE, Type TARGET 
INSERT INTO DB_T_CORE_FIN_PROD.AGG_COUNT_BALANCE
(
ECTL_BATCH_ID,
MO_ID,
CALC_SRC,
TBL_NM,
METRIC_NM,
METRIC_CNT
)
SELECT
exp_ASSIGN_DEFAULT_VALUE.ECTL_BATCH_ID as ECTL_BATCH_ID,
exp_ASSIGN_DEFAULT_VALUE.MO_ID as MO_ID,
exp_ASSIGN_DEFAULT_VALUE.out_CALC_SRC as CALC_SRC,
exp_ASSIGN_DEFAULT_VALUE.out_TBL_NM as TBL_NM,
exp_ASSIGN_DEFAULT_VALUE.METRIC_SHORT_NM as METRIC_NM,
exp_ASSIGN_DEFAULT_VALUE.MONETARY_AMOUNT as METRIC_CNT
FROM
exp_ASSIGN_DEFAULT_VALUE;


END; ';