-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_LOAD_STG_MEMBER("RUN_ID" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' BEGIN 

-- Component SQ_MEMBER, Type Pre SQL 
DELETE  FROM DB_T_STAG_MEMBXREF_PROD.STG_MEMBER where load_dt in
(select distinct a.load_dt from	DB_T_STAG_MEMBXREF_PROD.STG_MEMBER A
	,DB_T_STAG_MEMBXREF_PROD.STG_MEMBXREF_TRIGGER B
WHERE
	A.LOAD_DT = B.FEED_DT
	AND B.TABLENAME = ''MEMBER'');


-- Component SQ_MEMBER, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_MEMBER AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as MEMBER_NBR,
$2 as NAME1,
$3 as NAME2,
$4 as ADDRESS1,
$5 as ADDRESS2,
$6 as CITY,
$7 as STATE,
$8 as ZIP,
$9 as MEMBER_TYPE,
$10 as COUNTY_CODE,
$11 as STATUS,
$12 as DUES_AMT,
$13 as PAY_SOURCE,
$14 as PAID_TO_DATE,
$15 as POSTED_DATE1,
$16 as POSTED_DATE2,
$17 as POSTED_DATE3,
$18 as ALPHA_CODE,
$19 as PARSED_NAME1_FIRSTNAME,
$20 as PARSED_NAME1_LASTNAME,
$21 as PARSED_NAME2_FIRSTNAME,
$22 as PARSED_NAME2_LASTNAME,
$23 as GW_BILL_REF,
$24 as GW_DUE_DATE,
$25 as COMB_BILL_IND,
$26 as ALLOW_COMBINED_BILLING,
$27 as FOUR_DAY_LTR_IND,
$28 as LOAD_DTTM,
$29 as FEED_IND,
$30 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT 	
A.MEMBER_NBR,A.NAME1,A.NAME2,A.ADDRESS1,A.ADDRESS2,A.CITY,
	A.STATE,A.ZIP,A.MEMBER_TYPE,A.COUNTY_CODE,A.STATUS,A.DUES_AMT,
	A.PAY_SOURCE,A.PAID_TO_DATE,A.POSTED_DATE1,A.POSTED_DATE2,A.POSTED_DATE3,
	A.ALPHA_CODE,A.PARSED_NAME1_FIRSTNAME,A.PARSED_NAME1_LASTNAME,A.PARSED_NAME2_FIRSTNAME,A.PARSED_NAME2_LASTNAME,
	A.GW_BILL_REF,A.GW_DUE_DATE,A.COMB_BILL_IND,A.ALLOW_COMBINED_BILLING,A.FOUR_DAY_LTR_IND
	,B.FEED_DT,B.FEED_IND
FROM 
	DB_T_STAG_MEMBXREF_PROD.MEMBER A
	JOIN
	DB_T_STAG_MEMBXREF_PROD.STG_MEMBXREF_TRIGGER B
	ON 1=1
WHERE
	TABLENAME = ''MEMBER''
) SRC
)
);


-- Component Exp_trans, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE Exp_trans AS
(
SELECT
SQ_MEMBER.MEMBER_NBR as MEMBER_NBR,
SQ_MEMBER.NAME1 as NAME1,
SQ_MEMBER.NAME2 as NAME2,
SQ_MEMBER.ADDRESS1 as ADDRESS1,
SQ_MEMBER.ADDRESS2 as ADDRESS2,
SQ_MEMBER.CITY as CITY,
SQ_MEMBER.STATE as STATE,
SQ_MEMBER.ZIP as ZIP,
SQ_MEMBER.MEMBER_TYPE as MEMBER_TYPE,
SQ_MEMBER.COUNTY_CODE as COUNTY_CODE,
SQ_MEMBER.STATUS as STATUS,
SQ_MEMBER.DUES_AMT as DUES_AMT,
SQ_MEMBER.PAY_SOURCE as PAY_SOURCE,
SQ_MEMBER.PAID_TO_DATE as PAID_TO_DATE,
SQ_MEMBER.POSTED_DATE1 as POSTED_DATE1,
SQ_MEMBER.POSTED_DATE2 as POSTED_DATE2,
SQ_MEMBER.POSTED_DATE3 as POSTED_DATE3,
SQ_MEMBER.ALPHA_CODE as ALPHA_CODE,
SQ_MEMBER.PARSED_NAME1_FIRSTNAME as PARSED_NAME1_FIRSTNAME,
SQ_MEMBER.PARSED_NAME1_LASTNAME as PARSED_NAME1_LASTNAME,
SQ_MEMBER.PARSED_NAME2_FIRSTNAME as PARSED_NAME2_FIRSTNAME,
SQ_MEMBER.PARSED_NAME2_LASTNAME as PARSED_NAME2_LASTNAME,
SQ_MEMBER.GW_BILL_REF as GW_BILL_REF,
SQ_MEMBER.GW_DUE_DATE as GW_DUE_DATE,
SQ_MEMBER.COMB_BILL_IND as COMB_BILL_IND,
SQ_MEMBER.ALLOW_COMBINED_BILLING as ALLOW_COMBINED_BILLING,
SQ_MEMBER.FOUR_DAY_LTR_IND as FOUR_DAY_LTR_IND,
SQ_MEMBER.LOAD_DTTM as LOAD_DTTM,
SQ_MEMBER.FEED_IND as FEED_IND,
SQ_MEMBER.source_record_id
FROM
SQ_MEMBER
);


-- Component STG_MEMBER, Type TARGET 
INSERT INTO DB_T_STAG_MEMBXREF_PROD.STG_MEMBER
(
MEMBER_NBR,
NAME1,
NAME2,
ADDRESS1,
ADDRESS2,
CITY,
STATE,
ZIP,
MEMBER_TYPE,
COUNTY_CODE,
STATUS,
DUES_AMT,
PAY_SOURCE,
PAID_TO_DATE,
POSTED_DATE1,
POSTED_DATE2,
POSTED_DATE3,
ALPHA_CODE,
PARSED_NAME1_FIRSTNAME,
PARSED_NAME1_LASTNAME,
PARSED_NAME2_FIRSTNAME,
PARSED_NAME2_LASTNAME,
GW_BILL_REF,
GW_DUE_DATE,
COMB_BILL_IND,
ALLOW_COMBINED_BILLING,
FOUR_DAY_LTR_IND,
LOAD_DT,
FEED_IND
)
SELECT
Exp_trans.MEMBER_NBR as MEMBER_NBR,
Exp_trans.NAME1 as NAME1,
Exp_trans.NAME2 as NAME2,
Exp_trans.ADDRESS1 as ADDRESS1,
Exp_trans.ADDRESS2 as ADDRESS2,
Exp_trans.CITY as CITY,
Exp_trans.STATE as STATE,
Exp_trans.ZIP as ZIP,
Exp_trans.MEMBER_TYPE as MEMBER_TYPE,
Exp_trans.COUNTY_CODE as COUNTY_CODE,
Exp_trans.STATUS as STATUS,
Exp_trans.DUES_AMT as DUES_AMT,
Exp_trans.PAY_SOURCE as PAY_SOURCE,
Exp_trans.PAID_TO_DATE as PAID_TO_DATE,
Exp_trans.POSTED_DATE1 as POSTED_DATE1,
Exp_trans.POSTED_DATE2 as POSTED_DATE2,
Exp_trans.POSTED_DATE3 as POSTED_DATE3,
Exp_trans.ALPHA_CODE as ALPHA_CODE,
Exp_trans.PARSED_NAME1_FIRSTNAME as PARSED_NAME1_FIRSTNAME,
Exp_trans.PARSED_NAME1_LASTNAME as PARSED_NAME1_LASTNAME,
Exp_trans.PARSED_NAME2_FIRSTNAME as PARSED_NAME2_FIRSTNAME,
Exp_trans.PARSED_NAME2_LASTNAME as PARSED_NAME2_LASTNAME,
Exp_trans.GW_BILL_REF as GW_BILL_REF,
Exp_trans.GW_DUE_DATE as GW_DUE_DATE,
Exp_trans.COMB_BILL_IND as COMB_BILL_IND,
Exp_trans.ALLOW_COMBINED_BILLING as ALLOW_COMBINED_BILLING,
Exp_trans.FOUR_DAY_LTR_IND as FOUR_DAY_LTR_IND,
Exp_trans.LOAD_DTTM as LOAD_DT,
Exp_trans.FEED_IND as FEED_IND
FROM
Exp_trans;


END; ';