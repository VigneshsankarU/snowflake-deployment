-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_TREXIS_PREM_LOSS("RUN_ID" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' 

DECLARE 
PRGM_NM varchar;
ACT_PROJ_ID integer;
BATCH_ACTIVE_IND varchar;
PMTREXIS_PREM_LOSS_TableName varchar;
BEGIN 
PRGM_NM:=''m_TREXIS_PREM_LOSS''; 
ACT_PROJ_ID:=1; 
BATCH_ACTIVE_IND:='' ''; 
PMTREXIS_PREM_LOSS_TableName := '' '';


-- Component sq_STG_TREXIS_PREM_LOSS, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE sq_STG_TREXIS_PREM_LOSS AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as MONTH_ID,
$2 as PLCY_NBR,
$3 as LOB,
$4 as LOB_DESC,
$5 as TERM_EFF_DT,
$6 as LOSS_DT_MNTH,
$7 as CAT_CD,
$8 as WRIT_PREM,
$9 as ERND_PREM,
$10 as INCUR_LOSS,
$11 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT
STG_VISION_PREM_LOSS.MONTH_ID,
STG_VISION_PREM_LOSS.PLCY_NBR,
STG_VISION_PREM_LOSS.LOB,
STG_VISION_PREM_LOSS.LOB_DESC,
STG_VISION_PREM_LOSS.TERM_EFF_DT,
STG_VISION_PREM_LOSS.LOSS_DT_MNTH,
STG_VISION_PREM_LOSS.CAT_CD,
STG_VISION_PREM_LOSS.WRIT_PREM,
STG_VISION_PREM_LOSS.ERND_PREM,
STG_VISION_PREM_LOSS.INCUR_LOSS
FROM DB_T_STAG_PROD.STG_VISION_PREM_LOSS
) SRC
)
);


-- Component exp_CONVERT_DT, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_CONVERT_DT AS
(
SELECT
sq_STG_TREXIS_PREM_LOSS.MONTH_ID as MONTH_ID,
sq_STG_TREXIS_PREM_LOSS.PLCY_NBR as PLCY_NBR,
LTRIM ( RTRIM ( sq_STG_TREXIS_PREM_LOSS.LOB ) ) as out_LOB,
LTRIM ( RTRIM ( sq_STG_TREXIS_PREM_LOSS.LOB_DESC ) ) as out_LOB_DESC,
CASE WHEN LTRIM ( RTRIM ( sq_STG_TREXIS_PREM_LOSS.TERM_EFF_DT ) ) = '''' OR LTRIM ( RTRIM ( sq_STG_TREXIS_PREM_LOSS.TERM_EFF_DT ) ) IS NULL THEN null ELSE COALESCE(TRY_TO_DATE ( sq_STG_TREXIS_PREM_LOSS.TERM_EFF_DT , ''YYYY-MM-DD HH24:MI:SS'' ), TRY_TO_DATE ( sq_STG_TREXIS_PREM_LOSS.TERM_EFF_DT , ''YYYY-MM-DD'' )) END as out_TERM_EFF_DT,
CASE WHEN LTRIM ( RTRIM ( sq_STG_TREXIS_PREM_LOSS.LOSS_DT_MNTH ) ) IS NULL OR LTRIM ( RTRIM ( sq_STG_TREXIS_PREM_LOSS.LOSS_DT_MNTH ) ) = '''' THEN null ELSE TO_NUMBER(sq_STG_TREXIS_PREM_LOSS.LOSS_DT_MNTH) END as out_LOSS_DT_MNTH,
LTRIM ( RTRIM ( sq_STG_TREXIS_PREM_LOSS.CAT_CD ) ) as out_CAT_CD,
sq_STG_TREXIS_PREM_LOSS.WRIT_PREM as WRIT_PREM,
sq_STG_TREXIS_PREM_LOSS.ERND_PREM as ERND_PREM,
sq_STG_TREXIS_PREM_LOSS.INCUR_LOSS as INCUR_LOSS,
LTRIM ( RTRIM ( :PRGM_NM ) ) as in_PRGM_NM,
:ACT_PROJ_ID as in_ACT_PROJ_ID,
:BATCH_ACTIVE_IND as in_BATCH_ACTIVE_IND,
LTRIM ( RTRIM ( :PMTREXIS_PREM_LOSS_TableName ) ) as in_TABLE_NM,
TO_DATE ( ''9999-12-31'' , ''YYYY-MM-DD'' ) as out_ECTL_END_DATE,
sq_STG_TREXIS_PREM_LOSS.source_record_id
FROM
sq_STG_TREXIS_PREM_LOSS
);


-- Component LKP_VISION_PREM_LOSS, Type LOOKUP 
CREATE OR REPLACE TEMPORARY TABLE LKP_VISION_PREM_LOSS AS
(
SELECT
LKP.PLCY_NBR,
exp_CONVERT_DT.source_record_id,
ROW_NUMBER() OVER(PARTITION BY exp_CONVERT_DT.source_record_id ORDER BY LKP.PLCY_NBR asc) RNK
FROM
exp_CONVERT_DT
LEFT JOIN (
SELECT
PLCY_NBR,
MO_ID,
LOB,
LOB_DESC,
TERM_EFF_DT,
LOSS_DT_MNTH,
CAT_CD,
WRIT_PREM,
ERND_PREM,
INCUR_LOSS
FROM db_t_core_prod.VISION_PREM_LOSS
) LKP ON LKP.MO_ID = exp_CONVERT_DT.MONTH_ID AND LKP.PLCY_NBR = exp_CONVERT_DT.PLCY_NBR AND LKP.LOB = exp_CONVERT_DT.out_LOB AND LKP.LOB_DESC = exp_CONVERT_DT.out_LOB_DESC AND LKP.TERM_EFF_DT = exp_CONVERT_DT.out_TERM_EFF_DT AND LKP.LOSS_DT_MNTH = exp_CONVERT_DT.out_LOSS_DT_MNTH AND LKP.CAT_CD = exp_CONVERT_DT.out_CAT_CD AND LKP.WRIT_PREM = exp_CONVERT_DT.WRIT_PREM AND LKP.ERND_PREM = exp_CONVERT_DT.ERND_PREM AND LKP.INCUR_LOSS = exp_CONVERT_DT.INCUR_LOSS
QUALIFY RNK = 1
);


-- Component mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE, Type MAPPLET 
--MAPPLET NOT REGISTERED: mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE, mapplet instance mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE;
call mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE(''exp_CONVERT_DT'');

-- Component fil_ALLOW_NEW_ROWS, Type FILTER 
CREATE OR REPLACE TEMPORARY TABLE fil_ALLOW_NEW_ROWS AS
(
SELECT
exp_CONVERT_DT.MONTH_ID as MONTH_ID,
exp_CONVERT_DT.PLCY_NBR as PLCY_NBR,
exp_CONVERT_DT.out_LOB as LOB,
exp_CONVERT_DT.out_LOB_DESC as LOB_DESC,
exp_CONVERT_DT.out_TERM_EFF_DT as TERM_EFF_DT,
exp_CONVERT_DT.out_LOSS_DT_MNTH as LOSS_DT_MNTH,
exp_CONVERT_DT.out_CAT_CD as CAT_CD,
exp_CONVERT_DT.WRIT_PREM as WRIT_PREM,
exp_CONVERT_DT.ERND_PREM as ERND_PREM,
exp_CONVERT_DT.INCUR_LOSS as INCUR_LOSS,
LKP_VISION_PREM_LOSS.PLCY_NBR as PLCY_NBR_lkp,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_PRGM_ID as ECTL_PRGM_ID,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_SRC_ID as ECTL_SRC_ID,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_SRC_INST_ID as ECTL_SRC_INST_ID,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_BATCH_ID as ECTL_BATCH_ID,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_BATCH_START_DATE as ECTL_BATCH_START_DATE,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_TABLE_ID as ECTL_TABLE_ID,
exp_CONVERT_DT.out_ECTL_END_DATE as ECTL_END_DATE,
exp_CONVERT_DT.source_record_id
FROM
exp_CONVERT_DT
LEFT JOIN LKP_VISION_PREM_LOSS ON exp_CONVERT_DT.source_record_id = LKP_VISION_PREM_LOSS.source_record_id
LEFT JOIN mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE ON LKP_VISION_PREM_LOSS.source_record_id = mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.source_record_id
WHERE LKP_VISION_PREM_LOSS.PLCY_NBR IS NULL AND ECTL_BATCH_ID IS NOT NULL
);


-- Component TREXIS_PREM_LOSS, Type TARGET 
INSERT INTO DB_T_CORE_PROD.VISION_PREM_LOSS
(
MO_ID,
PLCY_NBR,
LOB,
LOB_DESC,
TERM_EFF_DT,
LOSS_DT_MNTH,
CAT_CD,
WRIT_PREM,
ERND_PREM,
INCUR_LOSS,
ECTL_BATCH_ID,
ECTL_PRGM_ID,
ECTL_TABLE_ID,
ECTL_SRC_ID,
ECTL_SRC_INST_ID,
ECTL_START_DATE,
ECTL_END_DATE
)
SELECT
fil_ALLOW_NEW_ROWS.MONTH_ID as MO_ID,
fil_ALLOW_NEW_ROWS.PLCY_NBR as PLCY_NBR,
fil_ALLOW_NEW_ROWS.LOB as LOB,
fil_ALLOW_NEW_ROWS.LOB_DESC as LOB_DESC,
fil_ALLOW_NEW_ROWS.TERM_EFF_DT as TERM_EFF_DT,
fil_ALLOW_NEW_ROWS.LOSS_DT_MNTH as LOSS_DT_MNTH,
fil_ALLOW_NEW_ROWS.CAT_CD as CAT_CD,
fil_ALLOW_NEW_ROWS.WRIT_PREM as WRIT_PREM,
fil_ALLOW_NEW_ROWS.ERND_PREM as ERND_PREM,
fil_ALLOW_NEW_ROWS.INCUR_LOSS as INCUR_LOSS,
fil_ALLOW_NEW_ROWS.ECTL_BATCH_ID as ECTL_BATCH_ID,
fil_ALLOW_NEW_ROWS.ECTL_PRGM_ID as ECTL_PRGM_ID,
fil_ALLOW_NEW_ROWS.ECTL_TABLE_ID as ECTL_TABLE_ID,
fil_ALLOW_NEW_ROWS.ECTL_SRC_ID as ECTL_SRC_ID,
fil_ALLOW_NEW_ROWS.ECTL_SRC_INST_ID as ECTL_SRC_INST_ID,
fil_ALLOW_NEW_ROWS.ECTL_BATCH_START_DATE as ECTL_START_DATE,
fil_ALLOW_NEW_ROWS.ECTL_END_DATE as ECTL_END_DATE
FROM
fil_ALLOW_NEW_ROWS;


END; ';