-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_BASE_ASSET_DTL_CD_XREF_INSUPD("PARAM_JSON" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS '
BEGIN
  -- PIPELINE START FOR 1
  -- Component sq_pcx_dwelling_hoe, Type SOURCE
  CREATE
  OR
  replace TEMPORARY TABLE sq_pcx_dwelling_hoe AS
  (
         SELECT
                /* adding column aliases to ensure proper downstream column references */
                $1 AS rank,
                $2 AS asset_dtl_cd,
                $3 AS eff_dt,
                $4 AS end_dt,
                $5 AS asset_dtl_txt,
                $6 AS party_asset_id,
                $7 AS ins_upd_flag,
                $8 AS source_record_id
         FROM   (
                         SELECT   src.*,
                                  row_number() over (ORDER BY 1) AS source_record_id
                         FROM     (
                                         SELECT rank,
                                                asset_dtl_cd1,
                                                eff_dt,
                                                end_dt1,
                                                asset_dtl_txt,
                                                party_asset_id,
                                                ins_upd_flag
                                         FROM   (
                                                                SELECT DISTINCT sq.rnk AS rank,
                                                                                src_nm,
                                                                                to_char(sq.id)         AS fixedid,
                                                                                sq.typecode            AS prty_asset_sbtype_cd,
                                                                                sq.classification_code AS class_cd,
                                                                                CASE
                                                                                                WHEN tgt_etl_ref_xlat_asset.tgt_idntftn_val IS NULL THEN sq.asset_dtl_cd
                                                                                                ELSE tgt_etl_ref_xlat_asset.tgt_idntftn_val
                                                                                END AS asset_dtl_cd1,
                                                                                /* SQ.src_cd, */
                                                                                CASE
                                                                                                WHEN tgt_etl_ref_xlat_sys.tgt_idntftn_val IS NULL THEN ''UNK''
                                                                                                ELSE tgt_etl_ref_xlat_sys.tgt_idntftn_val
                                                                                END                                                                  AS sys_src_cd ,
                                                                                coalesce(sq.strt_dt,cast(''1900-01-01 00:00:00.000000'' AS timestamp)) AS eff_dt,
                                                                                coalesce(sq.end_dt,cast(''9999-12-31 23:59:59.999999'' AS timestamp))  AS end_dt1,
                                                                                sq.updatetime,
                                                                                sq.asset_dtl_txt,
                                                                                sq.asset_dtl_schm_type_cd,
                                                                                CASE
                                                                                                WHEN tgt_etl_xlat_sbtype.tgt_idntftn_val IS NULL THEN ''UNK''
                                                                                                ELSE tgt_etl_xlat_sbtype.tgt_idntftn_val
                                                                                END AS out_prty_asset_sbtype_cd,
                                                                                CASE
                                                                                                WHEN tgt_etl_xlat_class.tgt_idntftn_val IS NULL THEN ''UNK''
                                                                                                ELSE tgt_etl_xlat_class.tgt_idntftn_val
                                                                                END AS out_class_cd,
                                                                                /* CASE WHEN TGT_ETL_REF_XLAT_ASSET.TGT_IDNTFTN_VAL is null then SQ.ASSET_DTL_CD ELSE TGT_ETL_REF_XLAT_ASSET.TGT_IDNTFTN_VAL END as ASSET_DTL_CDS, */
                                                                                tgt_asset_dtl.prty_asset_id            AS tgt_prty_asset_id,
                                                                                tgt_asset_dtl.asset_dtl_cd             AS tgt_asset_dtl_cd,
                                                                                tgt_asset_dtl.asset_dtl_schm_type_cd   AS tgt_asset_dtl_schm_type_cd,
                                                                                tgt_asset_dtl.asset_dtl_xref_strt_dttm AS tgt_asset_dtl_xref_strt_dttm,
                                                                                tgt_asset_dtl.asset_dtl_xref_end_dttm  AS tgt_asset_dtl_xref_end_dttm,
                                                                                tgt_asset_dtl.asset_dtl_txt            AS tgt_asset_dtl_txt,
                                                                                tgt_party.prty_asset_id                AS party_asset_id,
                                                                                /*SOURCEMD5DATA*/
                                                                                cast(concat(coalesce(trim(cast(eff_dt AS VARCHAR(100))),''''), coalesce(trim(cast(end_dt1 AS VARCHAR(100))),''''), coalesce(trim(sq.asset_dtl_txt),''''), coalesce(trim(asset_dtl_cd1),'''')) AS VARCHAR(1000)) AS sourcedata,
                                                                                /*TARGETMD5DATA*/
                                                                                cast(concat(coalesce(trim(cast(tgt_asset_dtl_xref_strt_dttm AS VARCHAR(100))),''''), coalesce(trim(cast(tgt_asset_dtl_xref_end_dttm AS VARCHAR(100))),''''), coalesce(trim(tgt_asset_dtl_txt),''''), coalesce(trim(tgt_asset_dtl_cd),'''')) AS VARCHAR(1000)) AS targetdata,
                                                                                /*FLAG*/
                                                                                CASE
                                                                                                WHEN trim(targetdata) IS NULL THEN ''|''
                                                                                                WHEN trim(targetdata) <> trim(sourcedata) THEN ''U''
                                                                                                ELSE ''R''
                                                                                END AS ins_upd_flag
                                                                FROM            (
                                                                                                /*SOURCE_QUERY*/
                                                                                                SELECT DISTINCT rank() over (PARTITION BY id,typecode,classification_code,asset_dtl_cd ORDER BY strt_dt) rnk,
                                                                                                                b.*
                                                                                                FROM            (
                                                                                                                         SELECT   id,
                                                                                                                                  typecode,
                                                                                                                                  classification_code,
                                                                                                                                  asset_dtl_cd,
                                                                                                                                  src_cd,
                                                                                                                                  src_nm ,
                                                                                                                                  cast(strt_dt AS timestamp)    strt_dt,
                                                                                                                                  cast(end_dt AS timestamp)     end_dt,
                                                                                                                                  cast(updatetime AS timestamp) updatetime,
                                                                                                                                  asset_dtl_txt,
                                                                                                                                  asset_dtl_schm_type_cd
                                                                                                                         FROM     (
                                                                                                                                                  SELECT DISTINCT pcx_dwelling_hoe.fixedid                 AS id,
                                                                                                                                                                  cast(''PRTY_ASSET_SBTYPE5'' AS VARCHAR(50))AS typecode ,
                                                                                                                                                                  /*  Added casting EIM-22873 */
                                                                                                                                                                  cast(''PRTY_ASSET_CLASFCN1'' AS VARCHAR(50)) AS classification_code,
                                                                                                                                                                  /*  Added casting EIM-22873 */
                                                                                                                                                                  ''SRC_SYS4''                                              AS src_cd,
                                                                                                                                                                  cast(''PCTL_DWELLINGUSAGE_HOE.TYPECODE'' AS VARCHAR(100))    src_nm,
                                                                                                                                                                  pctl_dwellingusage_hoe.typecode_stg                        asset_dtl_cd,
                                                                                                                                                                  cast(pcx_dwelling_hoe.effectivedate AS timestamp)          strt_dt,
                                                                                                                                                                  cast(pcx_dwelling_hoe.expirationdate AS timestamp)         end_dt ,
                                                                                                                                                                  cast(pcx_dwelling_hoe.updatetime AS timestamp)             updatetime ,
                                                                                                                                                                  cast('' '' AS VARCHAR(255))                               AS asset_dtl_txt ,
                                                                                                                                                                  ''DWELUSE''                                               AS asset_dtl_schm_type_cd
                                                                                                                                                  FROM            (
                                                                                                                                                                                  SELECT DISTINCT pcx_dwelling_hoe.updatetime_stg                                              AS updatetime,
                                                                                                                                                                                                  pcx_dwelling_hoe.fixedid_stg                                                 AS fixedid,
                                                                                                                                                                                                  coalesce(pcx_dwelling_hoe.effectivedate_stg,pc_policyperiod.periodstart_stg) AS effectivedate,
                                                                                                                                                                                                  coalesce(pcx_dwelling_hoe.expirationdate_stg,pc_policyperiod.periodend_stg)  AS expirationdate,
                                                                                                                                                                                                  pcx_dwelling_hoe.dwellingusage_stg                                           AS dwellingusage
                                                                                                                                                                                  FROM            db_t_prod_stag.pcx_dwelling_hoe
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_policyperiod
                                                                                                                                                                                  ON              pc_policyperiod.id_stg = pcx_dwelling_hoe.branchid_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_policy
                                                                                                                                                                                  ON              pc_policy.id_stg =pc_policyperiod.policyid_stg
                                                                                                                                                                                                  /* left outer join DB_T_PROD_STAG.pcx_dwellingratingfactor_alfa on pc_policyperiod.id = pcx_dwellingratingfactor_alfa.branchid */
                                                                                                                                                                                                  /* left outer join DB_T_PROD_STAG.pcx_dwellingratingfactor_alfa on pcx_Dwelling_hoe.id = pcx_dwellingratingfactor_alfa.Dwelling_HOE and pc_policyperiod.id = pcx_dwelling_hoe.branchid */
                                                                                                                                                                                  left outer join
                                                                                                                                                                                                  (
                                                                                                                                                                                                        SELECT     pcx_dwelling_hoe.fixedid_stg  AS homealerfixedid,
                                                                                                                                                                                                        pcx_dwelling_hoe.branchid_stg AS branchid,
                                                                                                                                                                                                        homealertcode_stg             AS homealert_cd,
                                                                                                                                                                                                        hurrmitigationcreditamt_stg
                                                                                                                                                                                                        FROM       db_t_prod_stag.pc_policyperiod
                                                                                                                                                                                                        inner join db_t_prod_stag.pcx_dwelling_hoe
                                                                                                                                                                                                        ON         pcx_dwelling_hoe.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                                        inner join db_t_prod_stag.pcx_dwellingratingfactor_alfa
                                                                                                                                                                                                        ON         pcx_dwelling_hoe.fixedid_stg = pcx_dwellingratingfactor_alfa.dwelling_hoe_stg
                                                                                                                                                                                                        AND        pcx_dwellingratingfactor_alfa.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                                        WHERE      pcx_dwelling_hoe.expirationdate_stg IS NULL
                                                                                                                                                                                                        AND        pcx_dwellingratingfactor_alfa.expirationdate_stg IS NULL ) homealert
                                                                                                                                                                                  ON              pcx_dwelling_hoe.fixedid_stg=homealert.homealerfixedid
                                                                                                                                                                                  AND             pcx_dwelling_hoe.branchid_stg=homealert.branchid
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_rooftype
                                                                                                                                                                                  ON              pcx_dwelling_hoe.rooftype_stg=pctl_rooftype.id_stg
                                                                                                                                                                                  join            db_t_prod_stag.pcx_holocation_hoe
                                                                                                                                                                                  ON              pcx_dwelling_hoe.holocation_stg = pcx_holocation_hoe.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_holocation_hoe
                                                                                                                                                                                  ON              pcx_holocation_hoe.subtype_stg = pctl_holocation_hoe.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_addlinterestdetail
                                                                                                                                                                                  ON              pc_addlinterestdetail.dwelling_stg = pcx_dwelling_hoe.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_additionalinteresttype
                                                                                                                                                                                  ON              pc_addlinterestdetail.additionalinteresttype_stg=pctl_additionalinteresttype.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_constructiontype_hoe
                                                                                                                                                                                  ON              pctl_constructiontype_hoe.id_stg= pcx_dwelling_hoe.constructiontype_stg
                                                                                                                                                                                  left outer join
                                                                                                                                                                                                  (
                                                                                                                                                                                                        SELECT   dwelling_hoe_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.questioncode_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.booleananswer_stg ,
                                                                                                                                                                                                        max(pcx_dwellinganswer_alf.updatetime_stg) AS updatetime
                                                                                                                                                                                                        FROM     db_t_prod_stag.pcx_dwellinganswer_alf
                                                                                                                                                                                                        WHERE    pcx_dwellinganswer_alf.booleananswer_stg IS NOT NULL
                                                                                                                                                                                                        GROUP BY dwelling_hoe_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.questioncode_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.booleananswer_stg ) dwellinganswer
                                                                                                                                                                                  ON              dwellinganswer.dwelling_hoe_stg=pcx_dwelling_hoe.id_stg
                                                                                                                                                                                                  /* left outer join DB_T_PROD_STAG.pcx_dwellinganswer_alf on pcx_dwellinganswer_alf.Dwelling_HOE=pcx_dwelling_hoe.id */
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_coolingtype_alfa
                                                                                                                                                                                  ON              pctl_coolingtype_alfa.id_stg=pcx_dwelling_hoe.primarycooling_alfa_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_policylocation
                                                                                                                                                                                  ON              pc_policylocation.id_stg=pcx_holocation_hoe.policylocation_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pc_territorycode
                                                                                                                                                                                  ON              pc_territorycode.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pc_policyline
                                                                                                                                                                                  ON              pc_policyline.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_hopolicytype_hoe
                                                                                                                                                                                  ON              pctl_hopolicytype_hoe.id_stg=pc_policyline.hopolicytype_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_territorycode
                                                                                                                                                                                  ON              pctl_territorycode.id_stg=pc_territorycode.subtype_stg
                                                                                                                                                                                  WHERE           pcx_dwelling_hoe.expirationdate_stg IS NULL
                                                                                                                                                                                  AND             pcx_dwelling_hoe.updatetime_stg>($start_dttm)
                                                                                                                                                                                  AND             pcx_dwelling_hoe.updatetime_stg <= ($end_dttm) ) pcx_dwelling_hoe
                                                                                                                                                  inner join      db_t_prod_stag.pctl_dwellingusage_hoe
                                                                                                                                                  ON              pctl_dwellingusage_hoe.id_stg =pcx_dwelling_hoe.dwellingusage qualify row_number () over (PARTITION BY pcx_dwelling_hoe.fixedid,pctl_dwellingusage_hoe.typecode_stg ORDER BY pcx_dwelling_hoe.updatetime DESC)=1
                                                                                                                                                  UNION
                                                                                                                                                  SELECT DISTINCT pcx_dwelling_hoe.fixedid                           AS id,
                                                                                                                                                                  ''PRTY_ASSET_SBTYPE5''                               AS typecode ,
                                                                                                                                                                  ''PRTY_ASSET_CLASFCN1''                              AS classification_code,
                                                                                                                                                                  ''SRC_SYS4''                                         AS src_cd,
                                                                                                                                                                  ''PCTL_HEATINGTYPE_HOE.TYPECODE''                       src_nm,
                                                                                                                                                                  pctl_heatingtype_hoe.typecode_stg                     asset_dtl_cd,
                                                                                                                                                                  cast(pcx_dwelling_hoe.effectivedate AS timestamp)     strt_dt,
                                                                                                                                                                  cast(pcx_dwelling_hoe.expirationdate AS timestamp)    end_dt ,
                                                                                                                                                                  cast(pcx_dwelling_hoe.updatetime AS timestamp)        updatetime ,
                                                                                                                                                                  cast('' '' AS VARCHAR(255))                          AS asset_dtl_txt ,
                                                                                                                                                                  ''HEAT''                                             AS asset_dtl_schm_type_cd
                                                                                                                                                  FROM            (
                                                                                                                                                                                  SELECT DISTINCT pcx_dwelling_hoe.updatetime_stg                                              AS updatetime,
                                                                                                                                                                                                  pcx_dwelling_hoe.fixedid_stg                                                 AS fixedid,
                                                                                                                                                                                                  coalesce(pcx_dwelling_hoe.effectivedate_stg,pc_policyperiod.periodstart_stg) AS effectivedate,
                                                                                                                                                                                                  coalesce(pcx_dwelling_hoe.expirationdate_stg,pc_policyperiod.periodend_stg)  AS expirationdate,
                                                                                                                                                                                                  pcx_dwelling_hoe.primaryheating_stg                                          AS primaryheating
                                                                                                                                                                                  FROM            db_t_prod_stag.pcx_dwelling_hoe
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_policyperiod
                                                                                                                                                                                  ON              pc_policyperiod.id_stg = pcx_dwelling_hoe.branchid_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_policy
                                                                                                                                                                                  ON              pc_policy.id_stg =pc_policyperiod.policyid_stg
                                                                                                                                                                                                  /* left outer join DB_T_PROD_STAG.pcx_dwellingratingfactor_alfa on pc_policyperiod.id = pcx_dwellingratingfactor_alfa.branchid */
                                                                                                                                                                                                  /* left outer join DB_T_PROD_STAG.pcx_dwellingratingfactor_alfa on pcx_Dwelling_hoe.id = pcx_dwellingratingfactor_alfa.Dwelling_HOE and pc_policyperiod.id = pcx_dwelling_hoe.branchid  */
                                                                                                                                                                                  left outer join
                                                                                                                                                                                                  (
                                                                                                                                                                                                        SELECT     pcx_dwelling_hoe.fixedid_stg  AS homealerfixedid,
                                                                                                                                                                                                        pcx_dwelling_hoe.branchid_stg AS branchid,
                                                                                                                                                                                                        homealertcode_stg             AS homealert_cd,
                                                                                                                                                                                                        hurrmitigationcreditamt_stg
                                                                                                                                                                                                        FROM       db_t_prod_stag.pc_policyperiod
                                                                                                                                                                                                        inner join db_t_prod_stag.pcx_dwelling_hoe
                                                                                                                                                                                                        ON         pcx_dwelling_hoe.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                                        inner join db_t_prod_stag.pcx_dwellingratingfactor_alfa
                                                                                                                                                                                                        ON         pcx_dwelling_hoe.fixedid_stg = pcx_dwellingratingfactor_alfa.dwelling_hoe_stg
                                                                                                                                                                                                        AND        pcx_dwellingratingfactor_alfa.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                                        WHERE      pcx_dwelling_hoe.expirationdate_stg IS NULL
                                                                                                                                                                                                        AND        pcx_dwellingratingfactor_alfa.expirationdate_stg IS NULL ) homealert
                                                                                                                                                                                  ON              pcx_dwelling_hoe.fixedid_stg=homealert.homealerfixedid
                                                                                                                                                                                  AND             pcx_dwelling_hoe.branchid_stg=homealert.branchid
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_rooftype
                                                                                                                                                                                  ON              pcx_dwelling_hoe.rooftype_stg=pctl_rooftype.id_stg
                                                                                                                                                                                  join            db_t_prod_stag.pcx_holocation_hoe
                                                                                                                                                                                  ON              pcx_dwelling_hoe.holocation_stg = pcx_holocation_hoe.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_holocation_hoe
                                                                                                                                                                                  ON              pcx_holocation_hoe.subtype_stg = pctl_holocation_hoe.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_addlinterestdetail
                                                                                                                                                                                  ON              pc_addlinterestdetail.dwelling_stg = pcx_dwelling_hoe.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_additionalinteresttype
                                                                                                                                                                                  ON              pc_addlinterestdetail.additionalinteresttype_stg=pctl_additionalinteresttype.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_constructiontype_hoe
                                                                                                                                                                                  ON              pctl_constructiontype_hoe.id_stg= pcx_dwelling_hoe.constructiontype_stg
                                                                                                                                                                                  left outer join
                                                                                                                                                                                                  (
                                                                                                                                                                                                        SELECT   dwelling_hoe_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.questioncode_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.booleananswer_stg ,
                                                                                                                                                                                                        max(pcx_dwellinganswer_alf.updatetime_stg) AS updatetime
                                                                                                                                                                                                        FROM     db_t_prod_stag.pcx_dwellinganswer_alf
                                                                                                                                                                                                        WHERE    pcx_dwellinganswer_alf.booleananswer_stg IS NOT NULL
                                                                                                                                                                                                        GROUP BY dwelling_hoe_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.questioncode_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.booleananswer_stg ) dwellinganswer
                                                                                                                                                                                  ON              dwellinganswer.dwelling_hoe_stg=pcx_dwelling_hoe.id_stg
                                                                                                                                                                                                  /* left outer join DB_T_PROD_STAG.pcx_dwellinganswer_alf on pcx_dwellinganswer_alf.Dwelling_HOE=pcx_dwelling_hoe.id */
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_coolingtype_alfa
                                                                                                                                                                                  ON              pctl_coolingtype_alfa.id_stg=pcx_dwelling_hoe.primarycooling_alfa_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_policylocation
                                                                                                                                                                                  ON              pc_policylocation.id_stg=pcx_holocation_hoe.policylocation_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pc_territorycode
                                                                                                                                                                                  ON              pc_territorycode.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pc_policyline
                                                                                                                                                                                  ON              pc_policyline.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_hopolicytype_hoe
                                                                                                                                                                                  ON              pctl_hopolicytype_hoe.id_stg=pc_policyline.hopolicytype_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_territorycode
                                                                                                                                                                                  ON              pctl_territorycode.id_stg=pc_territorycode.subtype_stg
                                                                                                                                                                                  WHERE           pcx_dwelling_hoe.expirationdate_stg IS NULL
                                                                                                                                                                                  AND             pcx_dwelling_hoe.updatetime_stg>($start_dttm)
                                                                                                                                                                                  AND             pcx_dwelling_hoe.updatetime_stg <= ($end_dttm) ) pcx_dwelling_hoe
                                                                                                                                                  inner join      db_t_prod_stag.pctl_heatingtype_hoe
                                                                                                                                                  ON              pctl_heatingtype_hoe.id_stg=pcx_dwelling_hoe.primaryheating qualify row_number () over (PARTITION BY pcx_dwelling_hoe.fixedid,pctl_heatingtype_hoe.typecode_stg ORDER BY pcx_dwelling_hoe.updatetime DESC)=1
                                                                                                                                                  UNION
                                                                                                                                                  SELECT DISTINCT b.fixedid_stg                           AS id,
                                                                                                                                                                  ''PRTY_ASSET_SBTYPE13''                   AS typecode,
                                                                                                                                                                  b.classification_name                   AS classification_code ,
                                                                                                                                                                  ''SRC_SYS4''                              AS src_cd,
                                                                                                                                                                  b.                                         src_nm,
                                                                                                                                                                  b.heatingtype                           AS asset_dtl_cd,
                                                                                                                                                                  cast(b.effectivedate_stg AS timestamp)  AS strt_dt ,
                                                                                                                                                                  cast(b.expirationdate_stg AS timestamp) AS end_dt,
                                                                                                                                                                  cast(b.updatetime_stg AS timestamp)     AS updatetime,
                                                                                                                                                                  cast('' '' AS VARCHAR(255))               AS asset_dtl_txt ,
                                                                                                                                                                  ''HEAT''                                  AS asset_dtl_schm_type_cd
                                                                                                                                                  FROM            (
                                                                                                                                                                                  SELECT DISTINCT c.fixedid_stg ,
                                                                                                                                                                                                  c.effectivedate_stg ,
                                                                                                                                                                                                  c.updatetime_stg ,
                                                                                                                                                                                                  c.expirationdate_stg ,
                                                                                                                                                                                                  cast(''pctl_bp7heatingtype_alfa.typecode'' AS VARCHAR(100))    src_nm ,
                                                                                                                                                                                                  hta.typecode_stg                                          AS heatingtype ,
                                                                                                                                                                                                  cp.typecode_stg                                           AS classification_name
                                                                                                                                                                                  FROM            db_t_prod_stag.pcx_bp7classification c
                                                                                                                                                                                  inner join
                                                                                                                                                                                                  (
                                                                                                                                                                                                        SELECT   b.*,
                                                                                                                                                                                                        rank() over (PARTITION BY b.fixedid_stg ORDER BY b.updatetime_stg DESC) r
                                                                                                                                                                                                        FROM     db_t_prod_stag.pcx_bp7building b) pb
                                                                                                                                                                                  ON              c.building_stg = pb.fixedid_stg
                                                                                                                                                                                  AND             c.branchid_stg =pb.branchid_stg
                                                                                                                                                                                  AND             pb.r = 1
                                                                                                                                                                                                  /** EIM-15651 INCLUDED DB_T_PROD_STAG.PC_BUILDING table to have Building description column ****/
                                                                                                                                                                                  inner join      db_t_prod_stag.pc_building building
                                                                                                                                                                                  ON              building.id_stg = pb.building_stg
                                                                                                                                                                                  inner join      db_t_prod_stag.pctl_bp7classificationproperty cp
                                                                                                                                                                                  ON              cp.id_stg = c.bp7classpropertytype_stg
                                                                                                                                                                                  join            db_t_prod_stag.pctl_bp7classdescription cdes
                                                                                                                                                                                  ON              c.bp7classdescription_stg = cdes.id_stg
                                                                                                                                                                                  inner join      db_t_prod_stag.pc_policyperiod pp
                                                                                                                                                                                  ON              pp.id_stg = pb.branchid_stg
                                                                                                                                                                                  inner join      db_t_prod_stag.pc_policy p
                                                                                                                                                                                  ON              p.id_stg = pp.policyid_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_rooftype rt
                                                                                                                                                                                  ON              pb.bp7rooftype_alfa_stg = rt.id_stg
                                                                                                                                                                                  inner join
                                                                                                                                                                                                  (
                                                                                                                                                                                                        SELECT   l.*,
                                                                                                                                                                                                        rank() over (PARTITION BY l.fixedid_stg ORDER BY l.updatetime_stg DESC) r
                                                                                                                                                                                                        FROM     db_t_prod_stag.pcx_bp7location l) l
                                                                                                                                                                                  ON              pb.location_stg = l.fixedid_stg
                                                                                                                                                                                  AND             l.r = 1
                                                                                                                                                                                  left join       db_t_prod_stag.pc_addlinterestdetail aid
                                                                                                                                                                                  ON              aid.bp7building_stg = pb.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_additionalinteresttype ait
                                                                                                                                                                                  ON              aid.additionalinteresttype_stg = ait.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_bp7constructiontype ctst
                                                                                                                                                                                  ON              ctst.id_stg = pb.bp7constructiontype_stg
                                                                                                                                                                                  left join
                                                                                                                                                                                                  (
                                                                                                                                                                                                        SELECT   ba.bp7building_stg,
                                                                                                                                                                                                        ba.questioncode_stg,
                                                                                                                                                                                                        ba.booleananswer_stg,
                                                                                                                                                                                                        max( ba.updatetime_stg) AS updatetime_stg
                                                                                                                                                                                                        FROM     db_t_prod_stag.pcx_bp7buildinganswer_alfa ba
                                                                                                                                                                                                        WHERE    ba.booleananswer_stg IS NOT NULL
                                                                                                                                                                                                        GROUP BY ba.bp7building_stg,
                                                                                                                                                                                                        ba.questioncode_stg,
                                                                                                                                                                                                        ba.booleananswer_stg )ba
                                                                                                                                                                                  ON              ba.bp7building_stg = pb.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_bp7coolingtype_alfa cta
                                                                                                                                                                                  ON              cta.id_stg = pb.bp7pricoolingtype_alfa_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_bp7heatingtype_alfa hta
                                                                                                                                                                                  ON              hta.id_stg = pb.bp7priheatingtype_alfa_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pc_territorycode tc
                                                                                                                                                                                  ON              tc.branchid_stg = pp.id_stg
                                                                                                                                                                                  inner join      db_t_prod_stag.pc_policyline pol
                                                                                                                                                                                  ON              pol.branchid_stg = pp.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_bp7policytype_alfa pta
                                                                                                                                                                                  ON              pta.id_stg = pol.bp7policytype_alfa_stg
                                                                                                                                                                                  WHERE           pb.expirationdate_stg IS NULL
                                                                                                                                                                                  AND             c.expirationdate_stg IS NULL
                                                                                                                                                                                  AND             l.expirationdate_stg IS NULL
                                                                                                                                                                                  AND             ((
                                                                                                                                                                                                        c.updatetime_stg > ($start_dttm)
                                                                                                                                                                                                        AND             c.updatetime_stg <= ($end_dttm))
                                                                                                                                                                                                  OR              (
                                                                                                                                                                                                        pb.updatetime_stg > ($start_dttm)
                                                                                                                                                                                                        AND             pb.updatetime_stg <= ($end_dttm))
                                                                                                                                                                                                  OR              (
                                                                                                                                                                                                        l.updatetime_stg > ($start_dttm)
                                                                                                                                                                                                        AND             l.updatetime_stg <= ($end_dttm))) ) b qualify row_number () over (PARTITION BY b.fixedid_stg,b.classification_name,b.heatingtype ORDER BY b.updatetime_stg DESC)=1
                                                                                                                                                  UNION
                                                                                                                                                  SELECT DISTINCT pcx_dwelling_hoe.fixedid                                        AS id,
                                                                                                                                                                  cast(''PRTY_ASSET_SBTYPE5'' AS  VARCHAR(19))                      AS typecode ,
                                                                                                                                                                  cast(''PRTY_ASSET_CLASFCN1'' AS VARCHAR(35))                      AS classification_code,
                                                                                                                                                                  ''SRC_SYS4''                                                      AS src_cd,
                                                                                                                                                                  cast(''pctl_dwellingoccupancytype_hoe.TYPECODE'' AS VARCHAR(100))    src_nm,
                                                                                                                                                                  pctl_dwellingoccupancytype_hoe.typecode_stg                        asset_dtl_cd,
                                                                                                                                                                  cast(pcx_dwelling_hoe.effectivedate AS timestamp)                  strt_dt,
                                                                                                                                                                  cast(pcx_dwelling_hoe.expirationdate AS timestamp)                 end_dt ,
                                                                                                                                                                  cast(pcx_dwelling_hoe.updatetime AS timestamp)                     updatetime ,
                                                                                                                                                                  cast('' '' AS VARCHAR(255))                                       AS asset_dtl_txt ,
                                                                                                                                                                  ''OCC''                                                           AS asset_dtl_schm_type_cd
                                                                                                                                                  FROM            (
                                                                                                                                                                                  SELECT DISTINCT pcx_dwelling_hoe.updatetime_stg                                              AS updatetime,
                                                                                                                                                                                                  pcx_dwelling_hoe.fixedid_stg                                                 AS fixedid,
                                                                                                                                                                                                  coalesce(pcx_dwelling_hoe.effectivedate_stg,pc_policyperiod.periodstart_stg) AS effectivedate,
                                                                                                                                                                                                  coalesce(pcx_dwelling_hoe.expirationdate_stg,pc_policyperiod.periodend_stg)  AS expirationdate,
                                                                                                                                                                                                  pcx_dwelling_hoe.occupancy_stg                                               AS occupancy
                                                                                                                                                                                  FROM            db_t_prod_stag.pcx_dwelling_hoe
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_policyperiod
                                                                                                                                                                                  ON              pc_policyperiod.id_stg = pcx_dwelling_hoe.branchid_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_policy
                                                                                                                                                                                  ON              pc_policy.id_stg =pc_policyperiod.policyid_stg
                                                                                                                                                                                                  /* left outer join DB_T_PROD_STAG.pcx_dwellingratingfactor_alfa on pc_policyperiod.id = pcx_dwellingratingfactor_alfa.branchid */
                                                                                                                                                                                                  /* left outer join DB_T_PROD_STAG.pcx_dwellingratingfactor_alfa on pcx_Dwelling_hoe.id = pcx_dwellingratingfactor_alfa.Dwelling_HOE and pc_policyperiod.id = pcx_dwelling_hoe.branchid  */
                                                                                                                                                                                  left outer join
                                                                                                                                                                                                  (
                                                                                                                                                                                                        SELECT     pcx_dwelling_hoe.fixedid_stg  AS homealerfixedid,
                                                                                                                                                                                                        pcx_dwelling_hoe.branchid_stg AS branchid,
                                                                                                                                                                                                        homealertcode_stg             AS homealert_cd,
                                                                                                                                                                                                        hurrmitigationcreditamt_stg
                                                                                                                                                                                                        FROM       db_t_prod_stag.pc_policyperiod
                                                                                                                                                                                                        inner join db_t_prod_stag.pcx_dwelling_hoe
                                                                                                                                                                                                        ON         pcx_dwelling_hoe.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                                        inner join db_t_prod_stag.pcx_dwellingratingfactor_alfa
                                                                                                                                                                                                        ON         pcx_dwelling_hoe.fixedid_stg = pcx_dwellingratingfactor_alfa.dwelling_hoe_stg
                                                                                                                                                                                                        AND        pcx_dwellingratingfactor_alfa.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                                        WHERE      pcx_dwelling_hoe.expirationdate_stg IS NULL
                                                                                                                                                                                                        AND        pcx_dwellingratingfactor_alfa.expirationdate_stg IS NULL ) homealert
                                                                                                                                                                                  ON              pcx_dwelling_hoe.fixedid_stg=homealert.homealerfixedid
                                                                                                                                                                                  AND             pcx_dwelling_hoe.branchid_stg=homealert.branchid
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_rooftype
                                                                                                                                                                                  ON              pcx_dwelling_hoe.rooftype_stg=pctl_rooftype.id_stg
                                                                                                                                                                                  join            db_t_prod_stag.pcx_holocation_hoe
                                                                                                                                                                                  ON              pcx_dwelling_hoe.holocation_stg = pcx_holocation_hoe.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_holocation_hoe
                                                                                                                                                                                  ON              pcx_holocation_hoe.subtype_stg = pctl_holocation_hoe.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_addlinterestdetail
                                                                                                                                                                                  ON              pc_addlinterestdetail.dwelling_stg = pcx_dwelling_hoe.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_additionalinteresttype
                                                                                                                                                                                  ON              pc_addlinterestdetail.additionalinteresttype_stg=pctl_additionalinteresttype.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_constructiontype_hoe
                                                                                                                                                                                  ON              pctl_constructiontype_hoe.id_stg= pcx_dwelling_hoe.constructiontype_stg
                                                                                                                                                                                  left outer join
                                                                                                                                                                                                  (
                                                                                                                                                                                                        SELECT   dwelling_hoe_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.questioncode_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.booleananswer_stg ,
                                                                                                                                                                                                        max(pcx_dwellinganswer_alf.updatetime_stg) AS updatetime
                                                                                                                                                                                                        FROM     db_t_prod_stag.pcx_dwellinganswer_alf
                                                                                                                                                                                                        WHERE    pcx_dwellinganswer_alf.booleananswer_stg IS NOT NULL
                                                                                                                                                                                                        GROUP BY dwelling_hoe_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.questioncode_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.booleananswer_stg ) dwellinganswer
                                                                                                                                                                                  ON              dwellinganswer.dwelling_hoe_stg=pcx_dwelling_hoe.id_stg
                                                                                                                                                                                                  /* left outer join DB_T_PROD_STAG.pcx_dwellinganswer_alf on pcx_dwellinganswer_alf.Dwelling_HOE=pcx_dwelling_hoe.id */
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_coolingtype_alfa
                                                                                                                                                                                  ON              pctl_coolingtype_alfa.id_stg=pcx_dwelling_hoe.primarycooling_alfa_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_policylocation
                                                                                                                                                                                  ON              pc_policylocation.id_stg=pcx_holocation_hoe.policylocation_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pc_territorycode
                                                                                                                                                                                  ON              pc_territorycode.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pc_policyline
                                                                                                                                                                                  ON              pc_policyline.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_hopolicytype_hoe
                                                                                                                                                                                  ON              pctl_hopolicytype_hoe.id_stg=pc_policyline.hopolicytype_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_territorycode
                                                                                                                                                                                  ON              pctl_territorycode.id_stg=pc_territorycode.subtype_stg
                                                                                                                                                                                  WHERE           pcx_dwelling_hoe.expirationdate_stg IS NULL
                                                                                                                                                                                  AND             pcx_dwelling_hoe.updatetime_stg>($start_dttm)
                                                                                                                                                                                  AND             pcx_dwelling_hoe.updatetime_stg <= ($end_dttm) ) pcx_dwelling_hoe
                                                                                                                                                  inner join      db_t_prod_stag.pctl_dwellingoccupancytype_hoe
                                                                                                                                                  ON              pctl_dwellingoccupancytype_hoe.id_stg=pcx_dwelling_hoe.occupancy qualify row_number () over (PARTITION BY pcx_dwelling_hoe.fixedid,pctl_dwellingoccupancytype_hoe.typecode_stg ORDER BY pcx_dwelling_hoe.updatetime DESC)=1
                                                                                                                                                  UNION
                                                                                                                                                  SELECT DISTINCT b.fixedid_stg                                                   AS id,
                                                                                                                                                                  ''PRTY_ASSET_SBTYPE13''                                           AS typecode,
                                                                                                                                                                  b.classification_name                                           AS classification_code,
                                                                                                                                                                  ''SRC_SYS4''                                                      AS src_cd,
                                                                                                                                                                  cast(''pctl_dwellingoccupancytype_hoe.typecode'' AS VARCHAR(100))    src_nm,
                                                                                                                                                                  CASE
                                                                                                                                                                                  WHEN b.bp7pctowneroccupied_stg = 10001 THEN ''tenant''
                                                                                                                                                                                  WHEN b.bp7pctowneroccupied_stg = 10002 THEN ''owner''
                                                                                                                                                                                  ELSE NULL
                                                                                                                                                                  END                                     AS asset_dtl_cd,
                                                                                                                                                                  cast(b.effectivedate_stg AS timestamp)  AS strt_dt ,
                                                                                                                                                                  cast(b.expirationdate_stg AS timestamp) AS end_dt,
                                                                                                                                                                  cast(b.updatetime_stg AS timestamp)     AS updatetime,
                                                                                                                                                                  cast('' '' AS VARCHAR(255))               AS asset_dtl_txt ,
                                                                                                                                                                  ''OCC''                                   AS asset_dtl_schm_type_cd
                                                                                                                                                  FROM            (
                                                                                                                                                                                  SELECT DISTINCT c.fixedid_stg ,
                                                                                                                                                                                                  c.effectivedate_stg ,
                                                                                                                                                                                                  c.updatetime_stg ,
                                                                                                                                                                                                  c.expirationdate_stg ,
                                                                                                                                                                                                  pb.bp7pctowneroccupied_stg ,
                                                                                                                                                                                                  cp.typecode_stg AS classification_name
                                                                                                                                                                                  FROM            db_t_prod_stag.pcx_bp7classification c
                                                                                                                                                                                  inner join
                                                                                                                                                                                                  (
                                                                                                                                                                                                        SELECT   b.*,
                                                                                                                                                                                                        rank() over (PARTITION BY b.fixedid_stg ORDER BY b.updatetime_stg DESC) r
                                                                                                                                                                                                        FROM     db_t_prod_stag.pcx_bp7building b) pb
                                                                                                                                                                                  ON              c.building_stg = pb.fixedid_stg
                                                                                                                                                                                  AND             c.branchid_stg =pb.branchid_stg
                                                                                                                                                                                  AND             pb.r = 1
                                                                                                                                                                                                  /** EIM-15651 INCLUDED DB_T_PROD_STAG.PC_BUILDING table to have Building description column ****/
                                                                                                                                                                                  inner join      db_t_prod_stag.pc_building building
                                                                                                                                                                                  ON              building.id_stg = pb.building_stg
                                                                                                                                                                                  inner join      db_t_prod_stag.pctl_bp7classificationproperty cp
                                                                                                                                                                                  ON              cp.id_stg = c.bp7classpropertytype_stg
                                                                                                                                                                                  join            db_t_prod_stag.pctl_bp7classdescription cdes
                                                                                                                                                                                  ON              c.bp7classdescription_stg = cdes.id_stg
                                                                                                                                                                                  inner join      db_t_prod_stag.pc_policyperiod pp
                                                                                                                                                                                  ON              pp.id_stg = pb.branchid_stg
                                                                                                                                                                                  inner join      db_t_prod_stag.pc_policy p
                                                                                                                                                                                  ON              p.id_stg = pp.policyid_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_rooftype rt
                                                                                                                                                                                  ON              pb.bp7rooftype_alfa_stg = rt.id_stg
                                                                                                                                                                                  inner join
                                                                                                                                                                                                  (
                                                                                                                                                                                                        SELECT   l.*,
                                                                                                                                                                                                        rank() over (PARTITION BY l.fixedid_stg ORDER BY l.updatetime_stg DESC) r
                                                                                                                                                                                                        FROM     db_t_prod_stag.pcx_bp7location l) l
                                                                                                                                                                                  ON              pb.location_stg = l.fixedid_stg
                                                                                                                                                                                  AND             l.r = 1
                                                                                                                                                                                  left join       db_t_prod_stag.pc_addlinterestdetail aid
                                                                                                                                                                                  ON              aid.bp7building_stg = pb.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_additionalinteresttype ait
                                                                                                                                                                                  ON              aid.additionalinteresttype_stg = ait.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_bp7constructiontype ctst
                                                                                                                                                                                  ON              ctst.id_stg = pb.bp7constructiontype_stg
                                                                                                                                                                                  left join
                                                                                                                                                                                                  (
                                                                                                                                                                                                        SELECT   ba.bp7building_stg,
                                                                                                                                                                                                        ba.questioncode_stg,
                                                                                                                                                                                                        ba.booleananswer_stg,
                                                                                                                                                                                                        max( ba.updatetime_stg) AS updatetime_stg
                                                                                                                                                                                                        FROM     db_t_prod_stag.pcx_bp7buildinganswer_alfa ba
                                                                                                                                                                                                        WHERE    ba.booleananswer_stg IS NOT NULL
                                                                                                                                                                                                        GROUP BY ba.bp7building_stg,
                                                                                                                                                                                                        ba.questioncode_stg,
                                                                                                                                                                                                        ba.booleananswer_stg )ba
                                                                                                                                                                                  ON              ba.bp7building_stg = pb.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_bp7coolingtype_alfa cta
                                                                                                                                                                                  ON              cta.id_stg = pb.bp7pricoolingtype_alfa_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_bp7heatingtype_alfa hta
                                                                                                                                                                                  ON              hta.id_stg = pb.bp7priheatingtype_alfa_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pc_territorycode tc
                                                                                                                                                                                  ON              tc.branchid_stg = pp.id_stg
                                                                                                                                                                                  inner join      db_t_prod_stag.pc_policyline pol
                                                                                                                                                                                  ON              pol.branchid_stg = pp.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_bp7policytype_alfa pta
                                                                                                                                                                                  ON              pta.id_stg = pol.bp7policytype_alfa_stg
                                                                                                                                                                                  WHERE           pb.expirationdate_stg IS NULL
                                                                                                                                                                                  AND             c.expirationdate_stg IS NULL
                                                                                                                                                                                  AND             l.expirationdate_stg IS NULL
                                                                                                                                                                                  AND             ((
                                                                                                                                                                                                        c.updatetime_stg > ($start_dttm)
                                                                                                                                                                                                        AND             c.updatetime_stg <= ($end_dttm))
                                                                                                                                                                                                  OR              (
                                                                                                                                                                                                        pb.updatetime_stg > ($start_dttm)
                                                                                                                                                                                                        AND             pb.updatetime_stg <= ($end_dttm))
                                                                                                                                                                                                  OR              (
                                                                                                                                                                                                        l.updatetime_stg > ($start_dttm)
                                                                                                                                                                                                        AND             l.updatetime_stg <= ($end_dttm))) ) b
                                                                                                                                                  WHERE           b.bp7pctowneroccupied_stg IN (10001,
                                                                                                                                                                                                10002) qualify row_number() over (PARTITION BY b.fixedid_stg,b.classification_name, b.bp7pctowneroccupied_stg ORDER BY b.updatetime_stg DESC) = 1
                                                                                                                                                  UNION
                                                                                                                                                  SELECT DISTINCT pcx_dwelling_hoe.fixedid AS id,
                                                                                                                                                                  ''PRTY_ASSET_SBTYPE5''     AS typecode ,
                                                                                                                                                                  ''PRTY_ASSET_CLASFCN1''    AS classification_code,
                                                                                                                                                                  ''SRC_SYS4''               AS src_cd,
                                                                                                                                                                  src_nm,
                                                                                                                                                                  typecode_coolingtype_alfa                             asset_dtl_cd,
                                                                                                                                                                  cast(pcx_dwelling_hoe.effectivedate AS timestamp)     strt_dt,
                                                                                                                                                                  cast(pcx_dwelling_hoe.expirationdate AS timestamp)    end_dt ,
                                                                                                                                                                  cast(pcx_dwelling_hoe.updatetime AS timestamp)        updatetime ,
                                                                                                                                                                  cast('' '' AS VARCHAR(255))                          AS asset_dtl_txt ,
                                                                                                                                                                  ''COOL''                                             AS asset_dtl_schm_type_cd
                                                                                                                                                  FROM            (
                                                                                                                                                                                  SELECT DISTINCT pcx_dwelling_hoe.updatetime_stg                                              AS updatetime,
                                                                                                                                                                                                  pcx_dwelling_hoe.fixedid_stg                                                 AS fixedid,
                                                                                                                                                                                                  coalesce(pcx_dwelling_hoe.effectivedate_stg,pc_policyperiod.periodstart_stg) AS effectivedate,
                                                                                                                                                                                                  coalesce(pcx_dwelling_hoe.expirationdate_stg,pc_policyperiod.periodend_stg)  AS expirationdate,
                                                                                                                                                                                                  pcx_dwelling_hoe.occupancy_stg                                               AS occupancy ,
                                                                                                                                                                                                  cast(''pctl_coolingtype_alfa.TYPECODE'' AS VARCHAR(100))                          src_nm,
                                                                                                                                                                                                  pctl_coolingtype_alfa.typecode_stg                                           AS typecode_coolingtype_alfa
                                                                                                                                                                                  FROM            db_t_prod_stag.pcx_dwelling_hoe
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_policyperiod
                                                                                                                                                                                  ON              pc_policyperiod.id_stg = pcx_dwelling_hoe.branchid_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_policy
                                                                                                                                                                                  ON              pc_policy.id_stg =pc_policyperiod.policyid_stg
                                                                                                                                                                                                  /* left outer join DB_T_PROD_STAG.pcx_dwellingratingfactor_alfa on pc_policyperiod.id = pcx_dwellingratingfactor_alfa.branchid */
                                                                                                                                                                                                  /* left outer join DB_T_PROD_STAG.pcx_dwellingratingfactor_alfa on pcx_Dwelling_hoe.id = pcx_dwellingratingfactor_alfa.Dwelling_HOE and pc_policyperiod.id = pcx_dwelling_hoe.branchid  */
                                                                                                                                                                                  left outer join
                                                                                                                                                                                                  (
                                                                                                                                                                                                        SELECT     pcx_dwelling_hoe.fixedid_stg  AS homealerfixedid,
                                                                                                                                                                                                        pcx_dwelling_hoe.branchid_stg AS branchid,
                                                                                                                                                                                                        homealertcode_stg             AS homealert_cd,
                                                                                                                                                                                                        hurrmitigationcreditamt_stg
                                                                                                                                                                                                        FROM       db_t_prod_stag.pc_policyperiod
                                                                                                                                                                                                        inner join db_t_prod_stag.pcx_dwelling_hoe
                                                                                                                                                                                                        ON         pcx_dwelling_hoe.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                                        inner join db_t_prod_stag.pcx_dwellingratingfactor_alfa
                                                                                                                                                                                                        ON         pcx_dwelling_hoe.fixedid_stg = pcx_dwellingratingfactor_alfa.dwelling_hoe_stg
                                                                                                                                                                                                        AND        pcx_dwellingratingfactor_alfa.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                                        WHERE      pcx_dwelling_hoe.expirationdate_stg IS NULL
                                                                                                                                                                                                        AND        pcx_dwellingratingfactor_alfa.expirationdate_stg IS NULL ) homealert
                                                                                                                                                                                  ON              pcx_dwelling_hoe.fixedid_stg=homealert.homealerfixedid
                                                                                                                                                                                  AND             pcx_dwelling_hoe.branchid_stg=homealert.branchid
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_rooftype
                                                                                                                                                                                  ON              pcx_dwelling_hoe.rooftype_stg=pctl_rooftype.id_stg
                                                                                                                                                                                  join            db_t_prod_stag.pcx_holocation_hoe
                                                                                                                                                                                  ON              pcx_dwelling_hoe.holocation_stg = pcx_holocation_hoe.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_holocation_hoe
                                                                                                                                                                                  ON              pcx_holocation_hoe.subtype_stg = pctl_holocation_hoe.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_addlinterestdetail
                                                                                                                                                                                  ON              pc_addlinterestdetail.dwelling_stg = pcx_dwelling_hoe.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_additionalinteresttype
                                                                                                                                                                                  ON              pc_addlinterestdetail.additionalinteresttype_stg=pctl_additionalinteresttype.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_constructiontype_hoe
                                                                                                                                                                                  ON              pctl_constructiontype_hoe.id_stg= pcx_dwelling_hoe.constructiontype_stg
                                                                                                                                                                                  left outer join
                                                                                                                                                                                                  (
                                                                                                                                                                                                        SELECT   dwelling_hoe_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.questioncode_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.booleananswer_stg ,
                                                                                                                                                                                                        max(pcx_dwellinganswer_alf.updatetime_stg) AS updatetime
                                                                                                                                                                                                        FROM     db_t_prod_stag.pcx_dwellinganswer_alf
                                                                                                                                                                                                        WHERE    pcx_dwellinganswer_alf.booleananswer_stg IS NOT NULL
                                                                                                                                                                                                        GROUP BY dwelling_hoe_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.questioncode_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.booleananswer_stg ) dwellinganswer
                                                                                                                                                                                  ON              dwellinganswer.dwelling_hoe_stg=pcx_dwelling_hoe.id_stg
                                                                                                                                                                                                  /* left outer join DB_T_PROD_STAG.pcx_dwellinganswer_alf on pcx_dwellinganswer_alf.Dwelling_HOE=pcx_dwelling_hoe.id */
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_coolingtype_alfa
                                                                                                                                                                                  ON              pctl_coolingtype_alfa.id_stg=pcx_dwelling_hoe.primarycooling_alfa_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_policylocation
                                                                                                                                                                                  ON              pc_policylocation.id_stg=pcx_holocation_hoe.policylocation_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pc_territorycode
                                                                                                                                                                                  ON              pc_territorycode.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pc_policyline
                                                                                                                                                                                  ON              pc_policyline.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_hopolicytype_hoe
                                                                                                                                                                                  ON              pctl_hopolicytype_hoe.id_stg=pc_policyline.hopolicytype_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_territorycode
                                                                                                                                                                                  ON              pctl_territorycode.id_stg=pc_territorycode.subtype_stg
                                                                                                                                                                                  WHERE           pcx_dwelling_hoe.expirationdate_stg IS NULL
                                                                                                                                                                                  AND             pcx_dwelling_hoe.updatetime_stg>($start_dttm)
                                                                                                                                                                                  AND             pcx_dwelling_hoe.updatetime_stg <= ($end_dttm) ) pcx_dwelling_hoe
                                                                                                                                                                  /*  inner join DB_T_PROD_STAG.pctl_coolingtype_alfa on pctl_coolingtype_alfa.id=pcx_dwelling_hoe.PrimaryCooling_alfa */
                                                                                                                                                                  qualify row_number () over (PARTITION BY pcx_dwelling_hoe.fixedid,typecode_coolingtype_alfa ORDER BY pcx_dwelling_hoe.updatetime DESC)=1
                                                                                                                                                  UNION
                                                                                                                                                  SELECT DISTINCT b.fixedid_stg         AS id,
                                                                                                                                                                  ''PRTY_ASSET_SBTYPE13'' AS typecode,
                                                                                                                                                                  b.classification_name AS classification_code ,
                                                                                                                                                                  ''SRC_SYS4''            AS src_cd,
                                                                                                                                                                  src_nm,
                                                                                                                                                                  b.coolingtype                           AS asset_dtl_cd,
                                                                                                                                                                  cast(b.effectivedate_stg AS timestamp)  AS strt_dt ,
                                                                                                                                                                  cast(b.expirationdate_stg AS timestamp) AS end_dt,
                                                                                                                                                                  cast(b.updatetime_stg AS timestamp)     AS updatetime,
                                                                                                                                                                  cast('' '' AS VARCHAR(255))               AS asset_dtl_txt ,
                                                                                                                                                                  ''COOL''                                  AS asset_dtl_schm_type_cd
                                                                                                                                                  FROM            (
                                                                                                                                                                                  SELECT DISTINCT c.fixedid_stg ,
                                                                                                                                                                                                  c.effectivedate_stg ,
                                                                                                                                                                                                  c.updatetime_stg ,
                                                                                                                                                                                                  c.expirationdate_stg ,
                                                                                                                                                                                                  pb.bp7pctowneroccupied_stg ,
                                                                                                                                                                                                  cp.typecode_stg                     AS classification_name,
                                                                                                                                                                                                  ''pctl_bp7coolingtype_alfa.typecode''    src_nm ,
                                                                                                                                                                                                  cta.typecode_stg                    AS coolingtype ,
                                                                                                                                                                                                  hta.typecode_stg                    AS heatingtype
                                                                                                                                                                                  FROM            db_t_prod_stag.pcx_bp7classification c
                                                                                                                                                                                  inner join
                                                                                                                                                                                                  (
                                                                                                                                                                                                        SELECT   b.*,
                                                                                                                                                                                                        rank() over (PARTITION BY b.fixedid_stg ORDER BY b.updatetime_stg DESC) r
                                                                                                                                                                                                        FROM     db_t_prod_stag.pcx_bp7building b) pb
                                                                                                                                                                                  ON              c.building_stg = pb.fixedid_stg
                                                                                                                                                                                  AND             c.branchid_stg =pb.branchid_stg
                                                                                                                                                                                  AND             pb.r = 1
                                                                                                                                                                                                  /** EIM-15651 INCLUDED DB_T_PROD_STAG.PC_BUILDING table to have Building description column ****/
                                                                                                                                                                                  inner join      db_t_prod_stag.pc_building building
                                                                                                                                                                                  ON              building.id_stg = pb.building_stg
                                                                                                                                                                                  inner join      db_t_prod_stag.pctl_bp7classificationproperty cp
                                                                                                                                                                                  ON              cp.id_stg = c.bp7classpropertytype_stg
                                                                                                                                                                                  join            db_t_prod_stag.pctl_bp7classdescription cdes
                                                                                                                                                                                  ON              c.bp7classdescription_stg = cdes.id_stg
                                                                                                                                                                                  inner join      db_t_prod_stag.pc_policyperiod pp
                                                                                                                                                                                  ON              pp.id_stg = pb.branchid_stg
                                                                                                                                                                                  inner join      db_t_prod_stag.pc_policy p
                                                                                                                                                                                  ON              p.id_stg = pp.policyid_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_rooftype rt
                                                                                                                                                                                  ON              pb.bp7rooftype_alfa_stg = rt.id_stg
                                                                                                                                                                                  inner join
                                                                                                                                                                                                  (
                                                                                                                                                                                                        SELECT   l.*,
                                                                                                                                                                                                        rank() over (PARTITION BY l.fixedid_stg ORDER BY l.updatetime_stg DESC) r
                                                                                                                                                                                                        FROM     db_t_prod_stag.pcx_bp7location l) l
                                                                                                                                                                                  ON              pb.location_stg = l.fixedid_stg
                                                                                                                                                                                  AND             l.r = 1
                                                                                                                                                                                  left join       db_t_prod_stag.pc_addlinterestdetail aid
                                                                                                                                                                                  ON              aid.bp7building_stg = pb.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_additionalinteresttype ait
                                                                                                                                                                                  ON              aid.additionalinteresttype_stg = ait.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_bp7constructiontype ctst
                                                                                                                                                                                  ON              ctst.id_stg = pb.bp7constructiontype_stg
                                                                                                                                                                                  left join
                                                                                                                                                                                                  (
                                                                                                                                                                                                        SELECT   ba.bp7building_stg,
                                                                                                                                                                                                        ba.questioncode_stg,
                                                                                                                                                                                                        ba.booleananswer_stg,
                                                                                                                                                                                                        max( ba.updatetime_stg) AS updatetime_stg
                                                                                                                                                                                                        FROM     db_t_prod_stag.pcx_bp7buildinganswer_alfa ba
                                                                                                                                                                                                        WHERE    ba.booleananswer_stg IS NOT NULL
                                                                                                                                                                                                        GROUP BY ba.bp7building_stg,
                                                                                                                                                                                                        ba.questioncode_stg,
                                                                                                                                                                                                        ba.booleananswer_stg )ba
                                                                                                                                                                                  ON              ba.bp7building_stg = pb.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_bp7coolingtype_alfa cta
                                                                                                                                                                                  ON              cta.id_stg = pb.bp7pricoolingtype_alfa_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_bp7heatingtype_alfa hta
                                                                                                                                                                                  ON              hta.id_stg = pb.bp7priheatingtype_alfa_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pc_territorycode tc
                                                                                                                                                                                  ON              tc.branchid_stg = pp.id_stg
                                                                                                                                                                                  inner join      db_t_prod_stag.pc_policyline pol
                                                                                                                                                                                  ON              pol.branchid_stg = pp.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_bp7policytype_alfa pta
                                                                                                                                                                                  ON              pta.id_stg = pol.bp7policytype_alfa_stg
                                                                                                                                                                                  WHERE           pb.expirationdate_stg IS NULL
                                                                                                                                                                                  AND             c.expirationdate_stg IS NULL
                                                                                                                                                                                  AND             l.expirationdate_stg IS NULL
                                                                                                                                                                                  AND             ((
                                                                                                                                                                                                        c.updatetime_stg > ($start_dttm)
                                                                                                                                                                                                        AND             c.updatetime_stg <= ($end_dttm))
                                                                                                                                                                                                  OR              (
                                                                                                                                                                                                        pb.updatetime_stg > ($start_dttm)
                                                                                                                                                                                                        AND             pb.updatetime_stg <= ($end_dttm))
                                                                                                                                                                                                  OR              (
                                                                                                                                                                                                        l.updatetime_stg > ($start_dttm)
                                                                                                                                                                                                        AND             l.updatetime_stg <= ($end_dttm)))) b qualify row_number () over (PARTITION BY b.fixedid_stg,b.classification_name,b.heatingtype ORDER BY b.updatetime_stg DESC)=1
                                                                                                                                                  UNION
                                                                                                                                                  SELECT DISTINCT pcx_dwelling_hoe.fixedid                           AS id,
                                                                                                                                                                  ''PRTY_ASSET_SBTYPE5''                               AS typecode ,
                                                                                                                                                                  ''PRTY_ASSET_CLASFCN1''                              AS classification_code,
                                                                                                                                                                  ''SRC_SYS4''                                         AS src_cd,
                                                                                                                                                                  ''pctl_dwellinglocationtype_hoe.TYPECODE''              src_nm,
                                                                                                                                                                  pctl_dwellinglocationtype_hoe.typecode_stg            asset_dtl_cd,
                                                                                                                                                                  cast(pcx_dwelling_hoe.effectivedate AS timestamp)     strt_dt,
                                                                                                                                                                  cast(pcx_dwelling_hoe.expirationdate AS timestamp)    end_dt ,
                                                                                                                                                                  cast(pcx_dwelling_hoe.updatetime AS timestamp)        updatetime ,
                                                                                                                                                                  cast('' '' AS VARCHAR(255))                          AS asset_dtl_txt ,
                                                                                                                                                                  ''DWEL''                                             AS asset_dtl_schm_type_cd
                                                                                                                                                  FROM            (
                                                                                                                                                                                  SELECT DISTINCT pcx_dwelling_hoe.updatetime_stg                                              AS updatetime,
                                                                                                                                                                                                  pcx_dwelling_hoe.fixedid_stg                                                 AS fixedid,
                                                                                                                                                                                                  coalesce(pcx_dwelling_hoe.effectivedate_stg,pc_policyperiod.periodstart_stg) AS effectivedate,
                                                                                                                                                                                                  coalesce(pcx_dwelling_hoe.expirationdate_stg,pc_policyperiod.periodend_stg)  AS expirationdate,
                                                                                                                                                                                                  pcx_dwelling_hoe.dwellinglocation_stg                                        AS dwellinglocation
                                                                                                                                                                                  FROM            db_t_prod_stag.pcx_dwelling_hoe
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_policyperiod
                                                                                                                                                                                  ON              pc_policyperiod.id_stg = pcx_dwelling_hoe.branchid_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_policy
                                                                                                                                                                                  ON              pc_policy.id_stg =pc_policyperiod.policyid_stg
                                                                                                                                                                                                  /* left outer join DB_T_PROD_STAG.pcx_dwellingratingfactor_alfa on pc_policyperiod.id = pcx_dwellingratingfactor_alfa.branchid */
                                                                                                                                                                                                  /* left outer join DB_T_PROD_STAG.pcx_dwellingratingfactor_alfa on pcx_Dwelling_hoe.id = pcx_dwellingratingfactor_alfa.Dwelling_HOE and pc_policyperiod.id = pcx_dwelling_hoe.branchid  */
                                                                                                                                                                                  left outer join
                                                                                                                                                                                                  (
                                                                                                                                                                                                        SELECT     pcx_dwelling_hoe.fixedid_stg  AS homealerfixedid,
                                                                                                                                                                                                        pcx_dwelling_hoe.branchid_stg AS branchid,
                                                                                                                                                                                                        homealertcode_stg             AS homealert_cd,
                                                                                                                                                                                                        hurrmitigationcreditamt_stg
                                                                                                                                                                                                        FROM       db_t_prod_stag.pc_policyperiod
                                                                                                                                                                                                        inner join db_t_prod_stag.pcx_dwelling_hoe
                                                                                                                                                                                                        ON         pcx_dwelling_hoe.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                                        inner join db_t_prod_stag.pcx_dwellingratingfactor_alfa
                                                                                                                                                                                                        ON         pcx_dwelling_hoe.fixedid_stg = pcx_dwellingratingfactor_alfa.dwelling_hoe_stg
                                                                                                                                                                                                        AND        pcx_dwellingratingfactor_alfa.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                                        WHERE      pcx_dwelling_hoe.expirationdate_stg IS NULL
                                                                                                                                                                                                        AND        pcx_dwellingratingfactor_alfa.expirationdate_stg IS NULL ) homealert
                                                                                                                                                                                  ON              pcx_dwelling_hoe.fixedid_stg=homealert.homealerfixedid
                                                                                                                                                                                  AND             pcx_dwelling_hoe.branchid_stg=homealert.branchid
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_rooftype
                                                                                                                                                                                  ON              pcx_dwelling_hoe.rooftype_stg=pctl_rooftype.id_stg
                                                                                                                                                                                  join            db_t_prod_stag.pcx_holocation_hoe
                                                                                                                                                                                  ON              pcx_dwelling_hoe.holocation_stg = pcx_holocation_hoe.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_holocation_hoe
                                                                                                                                                                                  ON              pcx_holocation_hoe.subtype_stg = pctl_holocation_hoe.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_addlinterestdetail
                                                                                                                                                                                  ON              pc_addlinterestdetail.dwelling_stg = pcx_dwelling_hoe.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_additionalinteresttype
                                                                                                                                                                                  ON              pc_addlinterestdetail.additionalinteresttype_stg=pctl_additionalinteresttype.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_constructiontype_hoe
                                                                                                                                                                                  ON              pctl_constructiontype_hoe.id_stg= pcx_dwelling_hoe.constructiontype_stg
                                                                                                                                                                                  left outer join
                                                                                                                                                                                                  (
                                                                                                                                                                                                        SELECT   dwelling_hoe_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.questioncode_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.booleananswer_stg ,
                                                                                                                                                                                                        max(pcx_dwellinganswer_alf.updatetime_stg) AS updatetime
                                                                                                                                                                                                        FROM     db_t_prod_stag.pcx_dwellinganswer_alf
                                                                                                                                                                                                        WHERE    pcx_dwellinganswer_alf.booleananswer_stg IS NOT NULL
                                                                                                                                                                                                        GROUP BY dwelling_hoe_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.questioncode_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.booleananswer_stg ) dwellinganswer
                                                                                                                                                                                  ON              dwellinganswer.dwelling_hoe_stg=pcx_dwelling_hoe.id_stg
                                                                                                                                                                                                  /* left outer join DB_T_PROD_STAG.pcx_dwellinganswer_alf on pcx_dwellinganswer_alf.Dwelling_HOE=pcx_dwelling_hoe.id */
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_coolingtype_alfa
                                                                                                                                                                                  ON              pctl_coolingtype_alfa.id_stg=pcx_dwelling_hoe.primarycooling_alfa_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_policylocation
                                                                                                                                                                                  ON              pc_policylocation.id_stg=pcx_holocation_hoe.policylocation_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pc_territorycode
                                                                                                                                                                                  ON              pc_territorycode.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pc_policyline
                                                                                                                                                                                  ON              pc_policyline.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_hopolicytype_hoe
                                                                                                                                                                                  ON              pctl_hopolicytype_hoe.id_stg=pc_policyline.hopolicytype_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_territorycode
                                                                                                                                                                                  ON              pctl_territorycode.id_stg=pc_territorycode.subtype_stg
                                                                                                                                                                                  WHERE           pcx_dwelling_hoe.expirationdate_stg IS NULL
                                                                                                                                                                                  AND             pcx_dwelling_hoe.updatetime_stg>($start_dttm)
                                                                                                                                                                                  AND             pcx_dwelling_hoe.updatetime_stg <= ($end_dttm)) pcx_dwelling_hoe
                                                                                                                                                  inner join      db_t_prod_stag.pctl_dwellinglocationtype_hoe
                                                                                                                                                  ON              pctl_dwellinglocationtype_hoe.id_stg=pcx_dwelling_hoe.dwellinglocation qualify row_number () over (PARTITION BY pcx_dwelling_hoe.fixedid, pctl_dwellinglocationtype_hoe.typecode_stg ORDER BY pcx_dwelling_hoe.updatetime DESC)=1
                                                                                                                                                  UNION
                                                                                                                                                  SELECT DISTINCT pcx_dwelling_hoe.fixedid                           AS id,
                                                                                                                                                                  ''PRTY_ASSET_SBTYPE5''                               AS typecode ,
                                                                                                                                                                  ''PRTY_ASSET_CLASFCN1''                              AS classification_code,
                                                                                                                                                                  ''SRC_SYS4''                                         AS src_cd,
                                                                                                                                                                  ''pctl_residencetype_hoe.TYPECODE''                  AS src_nm,
                                                                                                                                                                  pctl_residencetype_hoe.typecode_stg                AS asset_dtl_cd,
                                                                                                                                                                  cast(pcx_dwelling_hoe.effectivedate AS timestamp)     strt_dt,
                                                                                                                                                                  cast(pcx_dwelling_hoe.expirationdate AS timestamp)    end_dt ,
                                                                                                                                                                  cast(pcx_dwelling_hoe.updatetime AS timestamp)        updatetime ,
                                                                                                                                                                  cast('' '' AS VARCHAR(255))                          AS asset_dtl_txt ,
                                                                                                                                                                  ''RESD''                                             AS asset_dtl_schm_type_cd
                                                                                                                                                  FROM            (
                                                                                                                                                                                  SELECT DISTINCT pcx_dwelling_hoe.updatetime_stg                                              AS updatetime,
                                                                                                                                                                                                  pcx_dwelling_hoe.fixedid_stg                                                 AS fixedid,
                                                                                                                                                                                                  coalesce(pcx_dwelling_hoe.effectivedate_stg,pc_policyperiod.periodstart_stg) AS effectivedate,
                                                                                                                                                                                                  coalesce(pcx_dwelling_hoe.expirationdate_stg,pc_policyperiod.periodend_stg)  AS expirationdate,
                                                                                                                                                                                                  pcx_dwelling_hoe.residencetype_stg                                           AS residencetype
                                                                                                                                                                                  FROM            db_t_prod_stag.pcx_dwelling_hoe
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_policyperiod
                                                                                                                                                                                  ON              pc_policyperiod.id_stg = pcx_dwelling_hoe.branchid_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_policy
                                                                                                                                                                                  ON              pc_policy.id_stg =pc_policyperiod.policyid_stg
                                                                                                                                                                                                  /* left outer join DB_T_PROD_STAG.pcx_dwellingratingfactor_alfa on pc_policyperiod.id = pcx_dwellingratingfactor_alfa.branchid */
                                                                                                                                                                                                  /* left outer join DB_T_PROD_STAG.pcx_dwellingratingfactor_alfa on pcx_Dwelling_hoe.id = pcx_dwellingratingfactor_alfa.Dwelling_HOE and pc_policyperiod.id = pcx_dwelling_hoe.branchid  */
                                                                                                                                                                                  left outer join
                                                                                                                                                                                                  (
                                                                                                                                                                                                        SELECT     pcx_dwelling_hoe.fixedid_stg  AS homealerfixedid,
                                                                                                                                                                                                        pcx_dwelling_hoe.branchid_stg AS branchid,
                                                                                                                                                                                                        homealertcode_stg             AS homealert_cd,
                                                                                                                                                                                                        hurrmitigationcreditamt_stg
                                                                                                                                                                                                        FROM       db_t_prod_stag.pc_policyperiod
                                                                                                                                                                                                        inner join db_t_prod_stag.pcx_dwelling_hoe
                                                                                                                                                                                                        ON         pcx_dwelling_hoe.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                                        inner join db_t_prod_stag.pcx_dwellingratingfactor_alfa
                                                                                                                                                                                                        ON         pcx_dwelling_hoe.fixedid_stg = pcx_dwellingratingfactor_alfa.dwelling_hoe_stg
                                                                                                                                                                                                        AND        pcx_dwellingratingfactor_alfa.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                                        WHERE      pcx_dwelling_hoe.expirationdate_stg IS NULL
                                                                                                                                                                                                        AND        pcx_dwellingratingfactor_alfa.expirationdate_stg IS NULL ) homealert
                                                                                                                                                                                  ON              pcx_dwelling_hoe.fixedid_stg=homealert.homealerfixedid
                                                                                                                                                                                  AND             pcx_dwelling_hoe.branchid_stg=homealert.branchid
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_rooftype
                                                                                                                                                                                  ON              pcx_dwelling_hoe.rooftype_stg=pctl_rooftype.id_stg
                                                                                                                                                                                  join            db_t_prod_stag.pcx_holocation_hoe
                                                                                                                                                                                  ON              pcx_dwelling_hoe.holocation_stg = pcx_holocation_hoe.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_holocation_hoe
                                                                                                                                                                                  ON              pcx_holocation_hoe.subtype_stg = pctl_holocation_hoe.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_addlinterestdetail
                                                                                                                                                                                  ON              pc_addlinterestdetail.dwelling_stg = pcx_dwelling_hoe.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_additionalinteresttype
                                                                                                                                                                                  ON              pc_addlinterestdetail.additionalinteresttype_stg=pctl_additionalinteresttype.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_constructiontype_hoe
                                                                                                                                                                                  ON              pctl_constructiontype_hoe.id_stg= pcx_dwelling_hoe.constructiontype_stg
                                                                                                                                                                                  left outer join
                                                                                                                                                                                                  (
                                                                                                                                                                                                        SELECT   dwelling_hoe_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.questioncode_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.booleananswer_stg ,
                                                                                                                                                                                                        max(pcx_dwellinganswer_alf.updatetime_stg) AS updatetime
                                                                                                                                                                                                        FROM     db_t_prod_stag.pcx_dwellinganswer_alf
                                                                                                                                                                                                        WHERE    pcx_dwellinganswer_alf.booleananswer_stg IS NOT NULL
                                                                                                                                                                                                        GROUP BY dwelling_hoe_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.questioncode_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.booleananswer_stg ) dwellinganswer
                                                                                                                                                                                  ON              dwellinganswer.dwelling_hoe_stg=pcx_dwelling_hoe.id_stg
                                                                                                                                                                                                  /* left outer join DB_T_PROD_STAG.pcx_dwellinganswer_alf on pcx_dwellinganswer_alf.Dwelling_HOE=pcx_dwelling_hoe.id */
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_coolingtype_alfa
                                                                                                                                                                                  ON              pctl_coolingtype_alfa.id_stg=pcx_dwelling_hoe.primarycooling_alfa_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_policylocation
                                                                                                                                                                                  ON              pc_policylocation.id_stg=pcx_holocation_hoe.policylocation_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pc_territorycode
                                                                                                                                                                                  ON              pc_territorycode.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pc_policyline
                                                                                                                                                                                  ON              pc_policyline.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_hopolicytype_hoe
                                                                                                                                                                                  ON              pctl_hopolicytype_hoe.id_stg=pc_policyline.hopolicytype_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_territorycode
                                                                                                                                                                                  ON              pctl_territorycode.id_stg=pc_territorycode.subtype_stg
                                                                                                                                                                                  WHERE           pcx_dwelling_hoe.expirationdate_stg IS NULL
                                                                                                                                                                                  AND             pcx_dwelling_hoe.updatetime_stg>($start_dttm)
                                                                                                                                                                                  AND             pcx_dwelling_hoe.updatetime_stg <= ($end_dttm) ) pcx_dwelling_hoe
                                                                                                                                                  inner join      db_t_prod_stag.pctl_residencetype_hoe
                                                                                                                                                  ON              pctl_residencetype_hoe.id_stg=pcx_dwelling_hoe.residencetype qualify row_number () over (PARTITION BY pcx_dwelling_hoe.fixedid,pctl_residencetype_hoe.typecode_stg ORDER BY pcx_dwelling_hoe.updatetime DESC)=1
                                                                                                                                                  UNION
                                                                                                                                                  SELECT DISTINCT pcx_dwelling_hoe.fixedid                           AS id,
                                                                                                                                                                  ''PRTY_ASSET_SBTYPE5''                               AS typecode ,
                                                                                                                                                                  ''PRTY_ASSET_CLASFCN1''                              AS classification_code,
                                                                                                                                                                  ''SRC_SYS4''                                         AS src_cd,
                                                                                                                                                                  ''pctl_foundationtype_hoe.TYPECODE''                    src_nm,
                                                                                                                                                                  pctl_foundationtype_hoe.typecode_stg                  asset_dtl_cd,
                                                                                                                                                                  cast(pcx_dwelling_hoe.effectivedate AS timestamp)     strt_dt,
                                                                                                                                                                  cast(pcx_dwelling_hoe.expirationdate AS timestamp)    end_dt ,
                                                                                                                                                                  cast(pcx_dwelling_hoe.updatetime AS timestamp)        updatetime ,
                                                                                                                                                                  cast('' '' AS VARCHAR(255))                          AS asset_dtl_txt ,
                                                                                                                                                                  ''FOUND''                                            AS asset_dtl_schm_type_cd
                                                                                                                                                  FROM            (
                                                                                                                                                                                  SELECT DISTINCT pcx_dwelling_hoe.updatetime_stg                                              AS updatetime,
                                                                                                                                                                                                  pcx_dwelling_hoe.fixedid_stg                                                 AS fixedid,
                                                                                                                                                                                                  coalesce(pcx_dwelling_hoe.effectivedate_stg,pc_policyperiod.periodstart_stg) AS effectivedate,
                                                                                                                                                                                                  coalesce(pcx_dwelling_hoe.expirationdate_stg,pc_policyperiod.periodend_stg)  AS expirationdate,
                                                                                                                                                                                                  pcx_dwelling_hoe.foundation_stg                                              AS foundation
                                                                                                                                                                                  FROM            db_t_prod_stag.pcx_dwelling_hoe
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_policyperiod
                                                                                                                                                                                  ON              pc_policyperiod.id_stg = pcx_dwelling_hoe.branchid_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_policy
                                                                                                                                                                                  ON              pc_policy.id_stg =pc_policyperiod.policyid_stg
                                                                                                                                                                                                  /* left outer join DB_T_PROD_STAG.pcx_dwellingratingfactor_alfa on pc_policyperiod.id = pcx_dwellingratingfactor_alfa.branchid */
                                                                                                                                                                                                  /* left outer join DB_T_PROD_STAG.pcx_dwellingratingfactor_alfa on pcx_Dwelling_hoe.id = pcx_dwellingratingfactor_alfa.Dwelling_HOE and pc_policyperiod.id = pcx_dwelling_hoe.branchid  */
                                                                                                                                                                                  left outer join
                                                                                                                                                                                                  (
                                                                                                                                                                                                        SELECT     pcx_dwelling_hoe.fixedid_stg  AS homealerfixedid,
                                                                                                                                                                                                        pcx_dwelling_hoe.branchid_stg AS branchid,
                                                                                                                                                                                                        homealertcode_stg             AS homealert_cd,
                                                                                                                                                                                                        hurrmitigationcreditamt_stg
                                                                                                                                                                                                        FROM       db_t_prod_stag.pc_policyperiod
                                                                                                                                                                                                        inner join db_t_prod_stag.pcx_dwelling_hoe
                                                                                                                                                                                                        ON         pcx_dwelling_hoe.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                                        inner join db_t_prod_stag.pcx_dwellingratingfactor_alfa
                                                                                                                                                                                                        ON         pcx_dwelling_hoe.fixedid_stg = pcx_dwellingratingfactor_alfa.dwelling_hoe_stg
                                                                                                                                                                                                        AND        pcx_dwellingratingfactor_alfa.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                                        WHERE      pcx_dwelling_hoe.expirationdate_stg IS NULL
                                                                                                                                                                                                        AND        pcx_dwellingratingfactor_alfa.expirationdate_stg IS NULL ) homealert
                                                                                                                                                                                  ON              pcx_dwelling_hoe.fixedid_stg=homealert.homealerfixedid
                                                                                                                                                                                  AND             pcx_dwelling_hoe.branchid_stg=homealert.branchid
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_rooftype
                                                                                                                                                                                  ON              pcx_dwelling_hoe.rooftype_stg=pctl_rooftype.id_stg
                                                                                                                                                                                  join            db_t_prod_stag.pcx_holocation_hoe
                                                                                                                                                                                  ON              pcx_dwelling_hoe.holocation_stg = pcx_holocation_hoe.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_holocation_hoe
                                                                                                                                                                                  ON              pcx_holocation_hoe.subtype_stg = pctl_holocation_hoe.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_addlinterestdetail
                                                                                                                                                                                  ON              pc_addlinterestdetail.dwelling_stg = pcx_dwelling_hoe.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_additionalinteresttype
                                                                                                                                                                                  ON              pc_addlinterestdetail.additionalinteresttype_stg=pctl_additionalinteresttype.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_constructiontype_hoe
                                                                                                                                                                                  ON              pctl_constructiontype_hoe.id_stg= pcx_dwelling_hoe.constructiontype_stg
                                                                                                                                                                                  left outer join
                                                                                                                                                                                                  (
                                                                                                                                                                                                        SELECT   dwelling_hoe_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.questioncode_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.booleananswer_stg ,
                                                                                                                                                                                                        max(pcx_dwellinganswer_alf.updatetime_stg) AS updatetime
                                                                                                                                                                                                        FROM     db_t_prod_stag.pcx_dwellinganswer_alf
                                                                                                                                                                                                        WHERE    pcx_dwellinganswer_alf.booleananswer_stg IS NOT NULL
                                                                                                                                                                                                        GROUP BY dwelling_hoe_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.questioncode_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.booleananswer_stg ) dwellinganswer
                                                                                                                                                                                  ON              dwellinganswer.dwelling_hoe_stg=pcx_dwelling_hoe.id_stg
                                                                                                                                                                                                  /* left outer join DB_T_PROD_STAG.pcx_dwellinganswer_alf on pcx_dwellinganswer_alf.Dwelling_HOE=pcx_dwelling_hoe.id */
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_coolingtype_alfa
                                                                                                                                                                                  ON              pctl_coolingtype_alfa.id_stg=pcx_dwelling_hoe.primarycooling_alfa_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_policylocation
                                                                                                                                                                                  ON              pc_policylocation.id_stg=pcx_holocation_hoe.policylocation_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pc_territorycode
                                                                                                                                                                                  ON              pc_territorycode.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pc_policyline
                                                                                                                                                                                  ON              pc_policyline.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_hopolicytype_hoe
                                                                                                                                                                                  ON              pctl_hopolicytype_hoe.id_stg=pc_policyline.hopolicytype_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_territorycode
                                                                                                                                                                                  ON              pctl_territorycode.id_stg=pc_territorycode.subtype_stg
                                                                                                                                                                                  WHERE           pcx_dwelling_hoe.expirationdate_stg IS NULL
                                                                                                                                                                                  AND             pcx_dwelling_hoe.updatetime_stg>($start_dttm)
                                                                                                                                                                                  AND             pcx_dwelling_hoe.updatetime_stg <= ($end_dttm) ) pcx_dwelling_hoe
                                                                                                                                                  inner join      db_t_prod_stag.pctl_foundationtype_hoe
                                                                                                                                                  ON              pctl_foundationtype_hoe.id_stg=pcx_dwelling_hoe.foundation qualify row_number () over (PARTITION BY pcx_dwelling_hoe.fixedid,pctl_foundationtype_hoe.typecode_stg ORDER BY pcx_dwelling_hoe.updatetime DESC)=1
                                                                                                                                                  UNION
                                                                                                                                                  SELECT DISTINCT b.fixedid             AS id,
                                                                                                                                                                  ''PRTY_ASSET_SBTYPE13'' AS typecode,
                                                                                                                                                                  b.classificationcode  AS classification_code ,
                                                                                                                                                                  ''SRC_SYS4''            AS src_cd,
                                                                                                                                                                  src_nm,
                                                                                                                                                                  ft.typecode_stg                     AS asset_dtl_cd,
                                                                                                                                                                  cast(b.effectivedate AS timestamp)  AS strt_dt ,
                                                                                                                                                                  cast(b.expirationdate AS timestamp) AS end_dt,
                                                                                                                                                                  cast(b.updatetime AS timestamp)     AS updatetime,
                                                                                                                                                                  cast('' '' AS VARCHAR(255))           AS asset_dtl_txt ,
                                                                                                                                                                  ''FOUND''                             AS asset_dtl_schm_type_cd
                                                                                                                                                  FROM            (
                                                                                                                                                                                  SELECT DISTINCT c.fixedid_stg                          AS fixedid ,
                                                                                                                                                                                                  c.effectivedate_stg                    AS effectivedate ,
                                                                                                                                                                                                  c.updatetime_stg                       AS updatetime ,
                                                                                                                                                                                                  c.expirationdate_stg                   AS expirationdate ,
                                                                                                                                                                                                  ''pctl_bp7foundationtype_alfa.typecode'' AS src_nm ,
                                                                                                                                                                                                  hta.typecode_stg                       AS heatingtype ,
                                                                                                                                                                                                  cp.typecode_stg                        AS classificationcode,
                                                                                                                                                                                                  pb.bp7foundationtype_alfa_stg          AS bp7foundationtype_alfa
                                                                                                                                                                                  FROM            db_t_prod_stag.pcx_bp7classification c
                                                                                                                                                                                  inner join
                                                                                                                                                                                                  (
                                                                                                                                                                                                        SELECT   b.*,
                                                                                                                                                                                                        rank() over (PARTITION BY b.fixedid_stg ORDER BY b.updatetime_stg DESC) r
                                                                                                                                                                                                        FROM     db_t_prod_stag.pcx_bp7building b) pb
                                                                                                                                                                                  ON              c.building_stg = pb.fixedid_stg
                                                                                                                                                                                  AND             c.branchid_stg =pb.branchid_stg
                                                                                                                                                                                  AND             pb.r = 1
                                                                                                                                                                                                  /** EIM-15651 INCLUDED DB_T_PROD_STAG.PC_BUILDING table to have Building description column ****/
                                                                                                                                                                                  inner join      db_t_prod_stag.pc_building building
                                                                                                                                                                                  ON              building.id_stg = pb.building_stg
                                                                                                                                                                                  inner join      db_t_prod_stag.pctl_bp7classificationproperty cp
                                                                                                                                                                                  ON              cp.id_stg = c.bp7classpropertytype_stg
                                                                                                                                                                                  join            db_t_prod_stag.pctl_bp7classdescription cdes
                                                                                                                                                                                  ON              c.bp7classdescription_stg = cdes.id_stg
                                                                                                                                                                                  inner join      db_t_prod_stag.pc_policyperiod pp
                                                                                                                                                                                  ON              pp.id_stg = pb.branchid_stg
                                                                                                                                                                                  inner join      db_t_prod_stag.pc_policy p
                                                                                                                                                                                  ON              p.id_stg = pp.policyid_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_rooftype rt
                                                                                                                                                                                  ON              pb.bp7rooftype_alfa_stg = rt.id_stg
                                                                                                                                                                                  inner join
                                                                                                                                                                                                  (
                                                                                                                                                                                                        SELECT   l.*,
                                                                                                                                                                                                        rank() over (PARTITION BY l.fixedid_stg ORDER BY l.updatetime_stg DESC) r
                                                                                                                                                                                                        FROM     db_t_prod_stag.pcx_bp7location l) l
                                                                                                                                                                                  ON              pb.location_stg = l.fixedid_stg
                                                                                                                                                                                  AND             l.r = 1
                                                                                                                                                                                  left join       db_t_prod_stag.pc_addlinterestdetail aid
                                                                                                                                                                                  ON              aid.bp7building_stg = pb.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_additionalinteresttype ait
                                                                                                                                                                                  ON              aid.additionalinteresttype_stg = ait.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_bp7constructiontype ctst
                                                                                                                                                                                  ON              ctst.id_stg = pb.bp7constructiontype_stg
                                                                                                                                                                                  left join
                                                                                                                                                                                                  (
                                                                                                                                                                                                        SELECT   ba.bp7building_stg,
                                                                                                                                                                                                        ba.questioncode_stg,
                                                                                                                                                                                                        ba.booleananswer_stg,
                                                                                                                                                                                                        max( ba.updatetime_stg) AS updatetime_stg
                                                                                                                                                                                                        FROM     db_t_prod_stag.pcx_bp7buildinganswer_alfa ba
                                                                                                                                                                                                        WHERE    ba.booleananswer_stg IS NOT NULL
                                                                                                                                                                                                        GROUP BY ba.bp7building_stg,
                                                                                                                                                                                                        ba.questioncode_stg,
                                                                                                                                                                                                        ba.booleananswer_stg )ba
                                                                                                                                                                                  ON              ba.bp7building_stg = pb.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_bp7coolingtype_alfa cta
                                                                                                                                                                                  ON              cta.id_stg = pb.bp7pricoolingtype_alfa_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_bp7heatingtype_alfa hta
                                                                                                                                                                                  ON              hta.id_stg = pb.bp7priheatingtype_alfa_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pc_territorycode tc
                                                                                                                                                                                  ON              tc.branchid_stg = pp.id_stg
                                                                                                                                                                                  inner join      db_t_prod_stag.pc_policyline pol
                                                                                                                                                                                  ON              pol.branchid_stg = pp.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_bp7policytype_alfa pta
                                                                                                                                                                                  ON              pta.id_stg = pol.bp7policytype_alfa_stg
                                                                                                                                                                                  WHERE           pb.expirationdate_stg IS NULL
                                                                                                                                                                                  AND             c.expirationdate_stg IS NULL
                                                                                                                                                                                  AND             l.expirationdate_stg IS NULL
                                                                                                                                                                                  AND             ((
                                                                                                                                                                                                        c.updatetime_stg > ($start_dttm)
                                                                                                                                                                                                        AND             c.updatetime_stg <= ($end_dttm))
                                                                                                                                                                                                  OR              (
                                                                                                                                                                                                        pb.updatetime_stg > ($start_dttm)
                                                                                                                                                                                                        AND             pb.updatetime_stg <= ($end_dttm))
                                                                                                                                                                                                  OR              (
                                                                                                                                                                                                        l.updatetime_stg > ($start_dttm)
                                                                                                                                                                                                        AND             l.updatetime_stg <= ($end_dttm))) ) b
                                                                                                                                                  inner join      db_t_prod_stag.pctl_foundationtype_hoe ft
                                                                                                                                                  ON              ft.id_stg=b.bp7foundationtype_alfa qualify row_number() over (PARTITION BY b.fixedid,b.classificationcode,ft.typecode_stg ORDER BY b.updatetime DESC)=1
                                                                                                                                                  UNION
                                                                                                                                                  /* EIM-22873 Property DB_T_PROD_CORE.TERR Query */
                                                                                                                                                  SELECT DISTINCT pcx_dwelling_hoe.fixedid_stg                                                                   AS id,
                                                                                                                                                                  ''PRTY_ASSET_SBTYPE5''                                                                           AS typecode ,
                                                                                                                                                                  ''PRTY_ASSET_CLASFCN1''                                                                          AS classification_code,
                                                                                                                                                                  ''SRC_SYS4''                                                                                     AS src_cd,
                                                                                                                                                                  ''pctl_territorycode.TYPECODE''                                                                     src_nm,
                                                                                                                                                                  pctl_territorycode.typecode_stg                                                                AS asset_dtl_cd,
                                                                                                                                                                  coalesce(pcx_dwelling_hoe.effectivedate_stg,pc_policyperiod.periodstart_stg)                   AS strt_dt,
                                                                                                                                                                  cast(coalesce(pcx_dwelling_hoe.expirationdate_stg,pc_policyperiod.periodend_stg) AS timestamp) AS end_dt,
                                                                                                                                                                  cast(pcx_dwelling_hoe.updatetime_stg AS timestamp)                                             AS updatetime,
                                                                                                                                                                  pc_territorycode.code_stg                                                                      AS asset_dtl_txt,
                                                                                                                                                                  ''TERR''                                                                                         AS asset_dtl_schm_type_cd
                                                                                                                                                  FROM            db_t_prod_stag.pc_policyperiod 
                                                                                                                                                  join            db_t_prod_stag.pc_territorycode 
                                                                                                                                                  ON              pc_territorycode.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                  join            db_t_prod_stag.pctl_territorycode 
                                                                                                                                                  ON              pctl_territorycode.id_stg=pc_territorycode.subtype_stg
                                                                                                                                                  join            db_t_prod_stag.pc_policylocation 
                                                                                                                                                  ON              pc_policylocation.fixedid_stg = pc_territorycode.policylocation_stg
                                                                                                                                                  AND             pc_policylocation.branchid_stg = pc_policyperiod.id_stg
                                                                                                                                                  join            db_t_prod_stag.pcx_holocation_hoe 
                                                                                                                                                  ON              pcx_holocation_hoe.policylocation_stg = pc_territorycode.policylocation_stg
                                                                                                                                                  AND             pcx_holocation_hoe.branchid_stg = pc_policyperiod.id_stg
                                                                                                                                                  join            db_t_prod_stag.pcx_dwelling_hoe 
                                                                                                                                                  ON              pcx_dwelling_hoe.holocation_stg = pcx_holocation_hoe.fixedid_stg
                                                                                                                                                  AND             pcx_dwelling_hoe.branchid_stg = pc_policyperiod.id_stg
                                                                                                                                                  WHERE           pcx_dwelling_hoe.expirationdate_stg IS NULL
                                                                                                                                                  AND             pc_policylocation.expirationdate_stg IS NULL
                                                                                                                                                  AND             pc_territorycode.expirationdate_stg IS NULL
                                                                                                                                                  AND             pcx_holocation_hoe.expirationdate_stg IS NULL
                                                                                                                                                  AND             pcx_dwelling_hoe.updatetime_stg>($start_dttm)
                                                                                                                                                  AND             pcx_dwelling_hoe.updatetime_stg <= ($end_dttm) qualify row_number () over (PARTITION BY pcx_dwelling_hoe.fixedid_stg,pctl_territorycode.typecode_stg ORDER BY pcx_dwelling_hoe.updatetime_stg DESC)=1
                                                                                                                                                  UNION
                                                                                                                                                  /*  EM-22873  BOP and CHURCH DB_T_PROD_CORE.TERR Query */
                                                                                                                                                  SELECT DISTINCT b.fixedid             AS id,
                                                                                                                                                                  ''PRTY_ASSET_SBTYPE13'' AS typecode,
                                                                                                                                                                  b.classificationcode  AS classification_code ,
                                                                                                                                                                  ''SRC_SYS4''            AS src_cd,
                                                                                                                                                                  src_nm,
                                                                                                                                                                  b.typecode_territorycode AS asset_dtl_cd,
                                                                                                                                                                  /*  changes done according to other union block */
                                                                                                                                                                  cast(b.effectivedate AS timestamp)  AS strt_dt ,
                                                                                                                                                                  cast(b.expirationdate AS timestamp) AS end_dt,
                                                                                                                                                                  cast(b.updatetime AS timestamp)     AS updatetime,
                                                                                                                                                                  cast(b.code AS VARCHAR(255))        AS asset_dtl_txt
                                                                                                                                                                  /* changes done according to other union block */
                                                                                                                                                                  ,
                                                                                                                                                                  ''TERR'' AS asset_dtl_schm_type_cd
                                                                                                                                                  FROM            (
                                                                                                                                                                                  SELECT DISTINCT c.fixedid_stg AS fixedid,
                                                                                                                                                                                                  pp.policynumber_stg,
                                                                                                                                                                                                  pp.publicid_stg ,
                                                                                                                                                                                                  c.effectivedate_stg                                 AS effectivedate ,
                                                                                                                                                                                                  c.updatetime_stg                                    AS updatetime ,
                                                                                                                                                                                                  c.expirationdate_stg                                AS expirationdate ,
                                                                                                                                                                                                  cast(''pctl_territorycode.typecode'' AS VARCHAR(200)) AS src_nm ,
                                                                                                                                                                                                  hta.typecode_stg                                    AS heatingtype ,
                                                                                                                                                                                                  cp.typecode_stg                                     AS classificationcode ,
                                                                                                                                                                                                  tc.code_stg                                         AS code ,
                                                                                                                                                                                                  pctl.typecode_stg                                   AS typecode_territorycode
                                                                                                                                                                                  FROM            db_t_prod_stag.pcx_bp7classification c
                                                                                                                                                                                  inner join
                                                                                                                                                                                                  (
                                                                                                                                                                                                        SELECT   b.*,
                                                                                                                                                                                                        rank() over (PARTITION BY b.fixedid_stg ORDER BY b.updatetime_stg DESC) r
                                                                                                                                                                                                        FROM     db_t_prod_stag.pcx_bp7building b) pb
                                                                                                                                                                                  ON              c.building_stg = pb.fixedid_stg
                                                                                                                                                                                  AND             c.branchid_stg =pb.branchid_stg
                                                                                                                                                                                  AND             pb.r = 1
                                                                                                                                                                                                  /** EIM-15651 INCLUDED DB_T_PROD_STAG.PC_BUILDING table to have Building description column ****/
                                                                                                                                                                                  inner join      db_t_prod_stag.pc_building building
                                                                                                                                                                                  ON              building.id_stg = pb.building_stg
                                                                                                                                                                                  inner join      db_t_prod_stag.pctl_bp7classificationproperty cp
                                                                                                                                                                                  ON              cp.id_stg = c.bp7classpropertytype_stg
                                                                                                                                                                                  inner join      db_t_prod_stag.pctl_bp7classdescription cdes
                                                                                                                                                                                  ON              c.bp7classdescription_stg = cdes.id_stg
                                                                                                                                                                                  inner join      db_t_prod_stag.pc_policyperiod pp
                                                                                                                                                                                  ON              pp.id_stg = pb.branchid_stg
                                                                                                                                                                                  inner join      db_t_prod_stag.pc_territorycode tc
                                                                                                                                                                                  ON              tc.branchid_stg = pp.id_stg
                                                                                                                                                                                  inner join      db_t_prod_stag.pctl_territorycode pctl
                                                                                                                                                                                  ON              pctl.id_stg=tc.subtype_stg
                                                                                                                                                                                  inner join      db_t_prod_stag.pc_policylocation pl
                                                                                                                                                                                  ON              pl.fixedid_stg = tc.policylocation_stg
                                                                                                                                                                                  AND             pl.branchid_stg = pp.id_stg
                                                                                                                                                                                  inner join      db_t_prod_stag.pc_policy p
                                                                                                                                                                                  ON              p.id_stg = pp.policyid_stg
                                                                                                                                                                                  inner join
                                                                                                                                                                                                  (
                                                                                                                                                                                                        SELECT   l.*,
                                                                                                                                                                                                        rank() over (PARTITION BY l.fixedid_stg, l.branchid_stg ORDER BY l.updatetime_stg DESC) r
                                                                                                                                                                                                        FROM     db_t_prod_stag.pcx_bp7location l) l
                                                                                                                                                                                  ON              pb.location_stg = l.fixedid_stg
                                                                                                                                                                                  AND             l.r = 1
                                                                                                                                                                                  AND             l.location_stg=tc.policylocation_stg
                                                                                                                                                                                  AND             l.branchid_stg=pp.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_bp7heatingtype_alfa hta
                                                                                                                                                                                  ON              hta.id_stg = pb.bp7priheatingtype_alfa_stg
                                                                                                                                                                                  inner join      db_t_prod_stag.pc_policyline pol
                                                                                                                                                                                  ON              pol.branchid_stg = pp.id_stg
                                                                                                                                                                                  WHERE           pb.expirationdate_stg IS NULL
                                                                                                                                                                                  AND             c.expirationdate_stg IS NULL
                                                                                                                                                                                  AND             l.expirationdate_stg IS NULL
                                                                                                                                                                                  AND             pl.expirationdate_stg IS NULL
                                                                                                                                                                                  AND             ((
                                                                                                                                                                                                        c.updatetime_stg > ($start_dttm)
                                                                                                                                                                                                        AND             c.updatetime_stg <= ($end_dttm))
                                                                                                                                                                                                  OR              (
                                                                                                                                                                                                        pb.updatetime_stg > ($start_dttm)
                                                                                                                                                                                                        AND             pb.updatetime_stg <= ($end_dttm))
                                                                                                                                                                                                  OR              (
                                                                                                                                                                                                        l.updatetime_stg > ($start_dttm)
                                                                                                                                                                                                        AND             l.updatetime_stg <= ($end_dttm)))
                                                                                                                                                                                  AND             tc.subtype_stg = 3 )b qualify row_number() over (PARTITION BY b.fixedid,b.classificationcode ORDER BY b.updatetime DESC,b.code DESC)=1
                                                                                                                                                  UNION
                                                                                                                                                  SELECT DISTINCT pc_personalvehicle.fixedid AS id,
                                                                                                                                                                  ''PRTY_ASSET_SBTYPE4''       AS typecode ,
                                                                                                                                                                  ''PRTY_ASSET_CLASFCN3''      AS classification_code,
                                                                                                                                                                  ''SRC_SYS4''                 AS src_cd,
                                                                                                                                                                  src_nm,
                                                                                                                                                                  pc_personalvehicle.typecode_territorycode               asset_dtl_cd,
                                                                                                                                                                  pc_personalvehicle.effectivedate                        strt_dt,
                                                                                                                                                                  cast(pc_personalvehicle.expirationdate AS timestamp)    end_dt ,
                                                                                                                                                                  cast(pc_personalvehicle.updatetime AS timestamp)        updatetime ,
                                                                                                                                                                  pc_personalvehicle.territorycode                     AS asset_dtl_txt ,
                                                                                                                                                                  ''TERR''                                               AS asset_dtl_schm_type_cd
                                                                                                                                                  FROM            (
                                                                                                                                                                                  SELECT          pc_personalvehicle.fixedid_stg        AS fixedid,
                                                                                                                                                                                                  pc_personalvehicle.effectivedate_stg  AS effectivedate,
                                                                                                                                                                                                  pc_personalvehicle.updatetime_stg     AS updatetime,
                                                                                                                                                                                                  pc_personalvehicle.expirationdate_stg AS expirationdate,
                                                                                                                                                                                                  ''pctl_territorycode.TYPECODE''            src_nm,
                                                                                                                                                                                                  pctl_territorycode.typecode_stg       AS typecode_territorycode,
                                                                                                                                                                                                  pc_territorycode.code_stg             AS territorycode
                                                                                                                                                                                  FROM            db_t_prod_stag.pc_personalvehicle
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_policylocation
                                                                                                                                                                                  ON              pc_personalvehicle.garagelocation_stg =pc_policylocation.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_territorycode
                                                                                                                                                                                  ON              pc_policylocation.id_stg=pc_territorycode.policylocation_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_territorycode
                                                                                                                                                                                  ON              pctl_territorycode.id_stg=pc_territorycode.subtype_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_policyperiod
                                                                                                                                                                                  ON              pc_personalvehicle.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                  WHERE           pc_personalvehicle.updatetime_stg> ($start_dttm)
                                                                                                                                                                                  AND             pc_personalvehicle.updatetime_stg <= ($end_dttm)
                                                                                                                                                                                  AND             (
                                                                                                                                                                                                        pc_personalvehicle.expirationdate_stg IS NULL
                                                                                                                                                                                                  OR              pc_personalvehicle.expirationdate_stg >$start_dttm)
                                                                                                                                                                                                  /* EIM-15097 Added Expiration_date filter */
                                                                                                                                                                  ) pc_personalvehicle qualify row_number () over (PARTITION BY pc_personalvehicle.fixedid,pc_personalvehicle.typecode_territorycode ORDER BY pc_personalvehicle.updatetime DESC)=1
                                                                                                                                                  UNION
                                                                                                                                                  SELECT DISTINCT pc_personalvehicle.fixedid AS id,
                                                                                                                                                                  ''PRTY_ASSET_SBTYPE4''       AS typecode ,
                                                                                                                                                                  ''PRTY_ASSET_CLASFCN3''      AS classification_code,
                                                                                                                                                                  ''SRC_SYS4''                 AS src_cd,
                                                                                                                                                                  CASE
                                                                                                                                                                                  WHEN primaryuse IN (''10001'',
                                                                                                                                                                                                      ''10002'',
                                                                                                                                                                                                      ''10003'',
                                                                                                                                                                                                      ''10007'') THEN ''pctl_vehicleprimaryuse.typecode''
                                                                                                                                                                                  ELSE ''derived''
                                                                                                                                                                  END src_nm,
                                                                                                                                                                  CASE
                                                                                                                                                                                  WHEN primaryuse=''10001'' THEN ''COMMUTER''
                                                                                                                                                                                  WHEN primaryuse=''10002'' THEN ''pleasure''
                                                                                                                                                                                  WHEN primaryuse=''10003'' THEN ''BUSINESS''
                                                                                                                                                                                  WHEN primaryuse=''10007'' THEN ''FARMING''
                                                                                                                                                                                  ELSE ''UNKVEH''
                                                                                                                                                                  END                                                     asset_dtl_cd,
                                                                                                                                                                  cast(pc_personalvehicle.effectivedate AS timestamp)     strt_dt,
                                                                                                                                                                  cast(pc_personalvehicle.expirationdate AS timestamp)    end_dt ,
                                                                                                                                                                  cast(pc_personalvehicle.updatetime AS timestamp)        updatetime ,
                                                                                                                                                                  cast('' '' AS VARCHAR(255))                            AS asset_dtl_txt ,
                                                                                                                                                                  ''VEHUSE''                                             AS asset_dtl_schm_type_cd
                                                                                                                                                  FROM            (
                                                                                                                                                                                  SELECT          pc_personalvehicle.fixedid_stg        AS fixedid,
                                                                                                                                                                                                  pc_personalvehicle.effectivedate_stg  AS effectivedate,
                                                                                                                                                                                                  pc_personalvehicle.updatetime_stg     AS updatetime,
                                                                                                                                                                                                  pc_personalvehicle.expirationdate_stg AS expirationdate,
                                                                                                                                                                                                  pc_personalvehicle.primaryuse_stg     AS primaryuse
                                                                                                                                                                                  FROM            db_t_prod_stag.pc_personalvehicle
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_policylocation
                                                                                                                                                                                  ON              pc_personalvehicle.garagelocation_stg =pc_policylocation.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_territorycode
                                                                                                                                                                                  ON              pc_policylocation.id_stg=pc_territorycode.policylocation_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_territorycode
                                                                                                                                                                                  ON              pctl_territorycode.id_stg=pc_territorycode.subtype_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_policyperiod
                                                                                                                                                                                  ON              pc_personalvehicle.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                  WHERE           pc_personalvehicle.updatetime_stg> ($start_dttm)
                                                                                                                                                                                  AND             pc_personalvehicle.updatetime_stg <= ($end_dttm)
                                                                                                                                                                                  AND             (
                                                                                                                                                                                                        pc_personalvehicle.expirationdate_stg IS NULL
                                                                                                                                                                                                  OR              pc_personalvehicle.expirationdate_stg >$start_dttm)
                                                                                                                                                                                                  /* EIM-15097 Added Expiration_date filter */
                                                                                                                                                                  ) pc_personalvehicle
                                                                                                                                                                  /*  inner join DB_T_PROD_STAG.pctl_vehicleprimaryuse on pctl_vehicleprimaryuse.id=pc_personalvehicle.primaryuse */
                                                                                                                                                                  qualify row_number () over (PARTITION BY pc_personalvehicle.fixedid,primaryuse,asset_dtl_cd ORDER BY pc_personalvehicle.updatetime DESC)=1
                                                                                                                                                  UNION
                                                                                                                                                  SELECT DISTINCT pcx_dwelling_hoe.fixedid                           AS id,
                                                                                                                                                                  ''PRTY_ASSET_SBTYPE5''                               AS typecode ,
                                                                                                                                                                  ''PRTY_ASSET_CLASFCN1''                              AS classification_code,
                                                                                                                                                                  ''SRC_SYS4''                                         AS src_cd,
                                                                                                                                                                  ''pcx_dwellingratingfactor_alfa.homealertcode''      AS src_nm,
                                                                                                                                                                  pcx_dwelling_hoe.homealertcode                     AS asset_dtl_cd,
                                                                                                                                                                  cast(pcx_dwelling_hoe.effectivedate AS timestamp)     strt_dt,
                                                                                                                                                                  cast(pcx_dwelling_hoe.expirationdate AS timestamp)    end_dt ,
                                                                                                                                                                  cast(pcx_dwelling_hoe.updatetime AS timestamp)        updatetime ,
                                                                                                                                                                  cast('' '' AS VARCHAR(255))                          AS asset_dtl_txt ,
                                                                                                                                                                  ''HMALRT''                                           AS asset_dtl_schm_type_cd
                                                                                                                                                  FROM            (
                                                                                                                                                                                  SELECT DISTINCT pcx_dwelling_hoe.updatetime_stg                                              AS updatetime,
                                                                                                                                                                                                  pcx_dwelling_hoe.fixedid_stg                                                 AS fixedid,
                                                                                                                                                                                                  coalesce(pcx_dwelling_hoe.effectivedate_stg,pc_policyperiod.periodstart_stg) AS effectivedate,
                                                                                                                                                                                                  coalesce(pcx_dwelling_hoe.expirationdate_stg,pc_policyperiod.periodend_stg)  AS expirationdate,
                                                                                                                                                                                                  homealert.homealert_cd                                                       AS homealertcode,
                                                                                                                                                                                                  pc_policy.productcode_stg                                                    AS productcode
                                                                                                                                                                                  FROM            db_t_prod_stag.pcx_dwelling_hoe
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_policyperiod
                                                                                                                                                                                  ON              pc_policyperiod.id_stg = pcx_dwelling_hoe.branchid_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_policy
                                                                                                                                                                                  ON              pc_policy.id_stg =pc_policyperiod.policyid_stg
                                                                                                                                                                                                  /* left outer join DB_T_PROD_STAG.pcx_dwellingratingfactor_alfa on pc_policyperiod.id = pcx_dwellingratingfactor_alfa.branchid */
                                                                                                                                                                                                  /* left outer join DB_T_PROD_STAG.pcx_dwellingratingfactor_alfa on pcx_Dwelling_hoe.id = pcx_dwellingratingfactor_alfa.Dwelling_HOE and pc_policyperiod.id = pcx_dwelling_hoe.branchid  */
                                                                                                                                                                                  left outer join
                                                                                                                                                                                                  (
                                                                                                                                                                                                        SELECT     pcx_dwelling_hoe.fixedid_stg  AS homealerfixedid,
                                                                                                                                                                                                        pcx_dwelling_hoe.branchid_stg AS branchid,
                                                                                                                                                                                                        homealertcode_stg             AS homealert_cd,
                                                                                                                                                                                                        hurrmitigationcreditamt_stg
                                                                                                                                                                                                        FROM       db_t_prod_stag.pc_policyperiod
                                                                                                                                                                                                        inner join db_t_prod_stag.pcx_dwelling_hoe
                                                                                                                                                                                                        ON         pcx_dwelling_hoe.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                                        inner join db_t_prod_stag.pcx_dwellingratingfactor_alfa
                                                                                                                                                                                                        ON         pcx_dwelling_hoe.fixedid_stg = pcx_dwellingratingfactor_alfa.dwelling_hoe_stg
                                                                                                                                                                                                        AND        pcx_dwellingratingfactor_alfa.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                                        WHERE      pcx_dwelling_hoe.expirationdate_stg IS NULL
                                                                                                                                                                                                        AND        pcx_dwellingratingfactor_alfa.expirationdate_stg IS NULL ) homealert
                                                                                                                                                                                  ON              pcx_dwelling_hoe.fixedid_stg=homealert.homealerfixedid
                                                                                                                                                                                  AND             pcx_dwelling_hoe.branchid_stg=homealert.branchid
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_rooftype
                                                                                                                                                                                  ON              pcx_dwelling_hoe.rooftype_stg=pctl_rooftype.id_stg
                                                                                                                                                                                  join            db_t_prod_stag.pcx_holocation_hoe
                                                                                                                                                                                  ON              pcx_dwelling_hoe.holocation_stg = pcx_holocation_hoe.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_holocation_hoe
                                                                                                                                                                                  ON              pcx_holocation_hoe.subtype_stg = pctl_holocation_hoe.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_addlinterestdetail
                                                                                                                                                                                  ON              pc_addlinterestdetail.dwelling_stg = pcx_dwelling_hoe.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_additionalinteresttype
                                                                                                                                                                                  ON              pc_addlinterestdetail.additionalinteresttype_stg=pctl_additionalinteresttype.id_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_constructiontype_hoe
                                                                                                                                                                                  ON              pctl_constructiontype_hoe.id_stg= pcx_dwelling_hoe.constructiontype_stg
                                                                                                                                                                                  left outer join
                                                                                                                                                                                                  (
                                                                                                                                                                                                        SELECT   dwelling_hoe_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.questioncode_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.booleananswer_stg ,
                                                                                                                                                                                                        max(pcx_dwellinganswer_alf.updatetime_stg) AS updatetime
                                                                                                                                                                                                        FROM     db_t_prod_stag.pcx_dwellinganswer_alf
                                                                                                                                                                                                        WHERE    pcx_dwellinganswer_alf.booleananswer_stg IS NOT NULL
                                                                                                                                                                                                        GROUP BY dwelling_hoe_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.questioncode_stg,
                                                                                                                                                                                                        pcx_dwellinganswer_alf.booleananswer_stg ) dwellinganswer
                                                                                                                                                                                  ON              dwellinganswer.dwelling_hoe_stg=pcx_dwelling_hoe.id_stg
                                                                                                                                                                                                  /* left outer join DB_T_PROD_STAG.pcx_dwellinganswer_alf on pcx_dwellinganswer_alf.Dwelling_HOE=pcx_dwelling_hoe.id */
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_coolingtype_alfa
                                                                                                                                                                                  ON              pctl_coolingtype_alfa.id_stg=pcx_dwelling_hoe.primarycooling_alfa_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pc_policylocation
                                                                                                                                                                                  ON              pc_policylocation.id_stg=pcx_holocation_hoe.policylocation_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pc_territorycode
                                                                                                                                                                                  ON              pc_territorycode.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pc_policyline
                                                                                                                                                                                  ON              pc_policyline.branchid_stg=pc_policyperiod.id_stg
                                                                                                                                                                                  left join       db_t_prod_stag.pctl_hopolicytype_hoe
                                                                                                                                                                                  ON              pctl_hopolicytype_hoe.id_stg=pc_policyline.hopolicytype_stg
                                                                                                                                                                                  left outer join db_t_prod_stag.pctl_territorycode
                                                                                                                                                                                  ON              pctl_territorycode.id_stg=pc_territorycode.subtype_stg
                                                                                                                                                                                  WHERE           pcx_dwelling_hoe.expirationdate_stg IS NULL
                                                                                                                                                                                  AND             pcx_dwelling_hoe.updatetime_stg>($start_dttm)
                                                                                                                                                                                  AND             pcx_dwelling_hoe.updatetime_stg <= ($end_dttm) ) pcx_dwelling_hoe
                                                                                                                                                  WHERE           pcx_dwelling_hoe.productcode IN (''Homeowners'') qualify row_number () over (PARTITION BY pcx_dwelling_hoe.fixedid,pcx_dwelling_hoe.homealertcode ORDER BY pcx_dwelling_hoe.updatetime DESC)=1
                                                                                                                                                  UNION
                                                                                                                                                  SELECT DISTINCT pcx_fopdwelling.fixedid_stg                                                                    AS id,
                                                                                                                                                                  ''PRTY_ASSET_SBTYPE37''                                                                          AS typecode ,
                                                                                                                                                                  ''PRTY_ASSET_CLASFCN15''                                                                         AS classification_code,
                                                                                                                                                                  ''SRC_SYS4''                                                                                     AS src_cd,
                                                                                                                                                                  ''pctl_territorycode.TYPECODE''                                                                     src_nm,
                                                                                                                                                                  pctl_territorycode.typecode_stg                                                                AS asset_dtl_cd,
                                                                                                                                                                  cast(coalesce(pcx_fopdwelling.effectivedate_stg,pc_policyperiod.periodstart_stg) AS timestamp) AS strt_dt,
                                                                                                                                                                  cast(coalesce(pcx_fopdwelling.expirationdate_stg,pc_policyperiod.periodend_stg) AS timestamp)  AS end_dt,
                                                                                                                                                                  cast(pcx_fopdwelling.updatetime_stg AS timestamp)                                              AS updatetime,
                                                                                                                                                                  pc_territorycode.code_stg                                                                      AS asset_dtl_txt,
                                                                                                                                                                  ''TERR''                                                                                         AS asset_dtl_schm_type_cd
                                                                                                                                                  FROM            db_t_prod_stag.pc_policyperiod
                                                                                                                                                  join            db_t_prod_stag.pcx_fopdwelling
                                                                                                                                                  ON              pcx_fopdwelling.branchid_stg = pc_policyperiod.id_stg
                                                                                                                                                  join            db_t_prod_stag.pcx_foplocation
                                                                                                                                                  ON              pcx_fopdwelling.location_stg = pcx_foplocation.fixedid_stg
                                                                                                                                                  AND             pcx_foplocation.branchid_stg=pcx_fopdwelling.branchid_stg
                                                                                                                                                  join            db_t_prod_stag.pc_policylocation
                                                                                                                                                  ON              pcx_foplocation.policylocationid_stg = pc_policylocation.fixedid_stg
                                                                                                                                                  AND             pc_policylocation.branchid_stg=pcx_foplocation.branchid_stg
                                                                                                                                                  join            db_t_prod_stag.pc_territorycode
                                                                                                                                                  ON              pc_territorycode.policylocation_stg = pc_policylocation.fixedid_stg
                                                                                                                                                  AND             pc_territorycode.branchid_stg=pcx_fopdwelling.branchid_stg
                                                                                                                                                  join            db_t_prod_stag.pctl_territorycode
                                                                                                                                                  ON              pctl_territorycode.id_stg = pc_territorycode.subtype_stg
                                                                                                                                                  WHERE           ((
                                                                                                                                                                                                  pcx_fopdwelling.expirationdate_stg IS NULL
                                                                                                                                                                                  OR              pcx_fopdwelling.expirationdate_stg>pc_policyperiod.editeffectivedate_stg )
                                                                                                                                                                  AND             (
                                                                                                                                                                                                  pcx_foplocation.expirationdate_stg IS NULL
                                                                                                                                                                                  OR              pcx_foplocation.expirationdate_stg>pc_policyperiod.editeffectivedate_stg )
                                                                                                                                                                  AND             (
                                                                                                                                                                                                  pc_policylocation.expirationdate_stg IS NULL
                                                                                                                                                                                  OR              pc_policylocation.expirationdate_stg>pc_policyperiod.editeffectivedate_stg )
                                                                                                                                                                  AND             (
                                                                                                                                                                                                  pc_territorycode.expirationdate_stg IS NULL
                                                                                                                                                                                  OR              pc_territorycode.expirationdate_stg>pc_policyperiod.editeffectivedate_stg ))
                                                                                                                                                  AND             pcx_fopdwelling.updatetime_stg>($start_dttm)
                                                                                                                                                  AND             pcx_fopdwelling.updatetime_stg <= ($end_dttm) qualify row_number () over (PARTITION BY pcx_fopdwelling.fixedid_stg,pctl_territorycode.typecode_stg ORDER BY pcx_fopdwelling.updatetime_stg DESC)=1
                                                                                                                                                  UNION
                                                                                                                                                  SELECT DISTINCT pcx_fopoutbuilding.fixedid_stg                                                                    AS id,
                                                                                                                                                                  ''PRTY_ASSET_SBTYPE36''                                                                             AS typecode ,
                                                                                                                                                                  ''PRTY_ASSET_CLASFCN13''                                                                            AS classification_code,
                                                                                                                                                                  ''SRC_SYS4''                                                                                        AS src_cd,
                                                                                                                                                                  ''pctl_territorycode.TYPECODE''                                                                        src_nm,
                                                                                                                                                                  pctl_territorycode.typecode_stg                                                                   AS asset_dtl_cd,
                                                                                                                                                                  cast(coalesce(pcx_fopoutbuilding.effectivedate_stg,pc_policyperiod.periodstart_stg) AS timestamp) AS strt_dt,
                                                                                                                                                                  cast(coalesce(pcx_fopoutbuilding.expirationdate_stg,pc_policyperiod.periodend_stg) AS timestamp)  AS end_dt,
                                                                                                                                                                  cast(pcx_fopoutbuilding.updatetime_stg AS timestamp)                                              AS updatetime,
                                                                                                                                                                  pc_territorycode.code_stg                                                                         AS asset_dtl_txt,
                                                                                                                                                                  ''TERR''                                                                                            AS asset_dtl_schm_type_cd
                                                                                                                                                  FROM            db_t_prod_stag.pc_policyperiod
                                                                                                                                                  join            db_t_prod_stag.pcx_fopoutbuilding
                                                                                                                                                  ON              pcx_fopoutbuilding.branchid_stg = pc_policyperiod.id_stg
                                                                                                                                                  join            db_t_prod_stag.pcx_foplocation
                                                                                                                                                  ON              pcx_fopoutbuilding.location_stg = pcx_foplocation.fixedid_stg
                                                                                                                                                  AND             pcx_fopoutbuilding.branchid_stg=pcx_foplocation.branchid_stg
                                                                                                                                                  join            db_t_prod_stag.pc_policylocation
                                                                                                                                                  ON              pcx_foplocation.policylocationid_stg = pc_policylocation.fixedid_stg
                                                                                                                                                  AND             pc_policylocation.branchid_stg=pcx_foplocation.branchid_stg
                                                                                                                                                  join            db_t_prod_stag.pc_territorycode
                                                                                                                                                  ON              pc_territorycode.policylocation_stg = pc_policylocation.fixedid_stg
                                                                                                                                                  AND             pc_territorycode.branchid_stg=pc_policylocation.branchid_stg
                                                                                                                                                  join            db_t_prod_stag.pctl_territorycode
                                                                                                                                                  ON              pctl_territorycode.id_stg = pc_territorycode.subtype_stg
                                                                                                                                                  WHERE           ((
                                                                                                                                                                                                  pcx_fopoutbuilding.expirationdate_stg IS NULL
                                                                                                                                                                                  OR              pcx_fopoutbuilding.expirationdate_stg>pc_policyperiod.editeffectivedate_stg )
                                                                                                                                                                  AND             (
                                                                                                                                                                                                  pcx_foplocation.expirationdate_stg IS NULL
                                                                                                                                                                                  OR              pcx_foplocation.expirationdate_stg>pc_policyperiod.editeffectivedate_stg )
                                                                                                                                                                  AND             (
                                                                                                                                                                                                  pc_policylocation.expirationdate_stg IS NULL
                                                                                                                                                                                  OR              pc_policylocation.expirationdate_stg>pc_policyperiod.editeffectivedate_stg )
                                                                                                                                                                  AND             (
                                                                                                                                                                                                  pc_territorycode.expirationdate_stg IS NULL
                                                                                                                                                                                  OR              pc_territorycode.expirationdate_stg>pc_policyperiod.editeffectivedate_stg ))
                                                                                                                                                  AND             pcx_fopoutbuilding.updatetime_stg>($start_dttm)
                                                                                                                                                  AND             pcx_fopoutbuilding.updatetime_stg <= ($end_dttm) qualify row_number () over (PARTITION BY pcx_fopoutbuilding.fixedid_stg,pctl_territorycode.typecode_stg ORDER BY pcx_fopoutbuilding.updatetime_stg DESC)=1
                                                                                                                                                  UNION
                                                                                                                                                  SELECT DISTINCT pcx_fopdwelling.fixedid_stg       AS id,
                                                                                                                                                                  ''PRTY_ASSET_SBTYPE37''             AS typecode ,
                                                                                                                                                                  ''PRTY_ASSET_CLASFCN15''            AS classification_code,
                                                                                                                                                                  ''SRC_SYS4''                        AS src_cd,
                                                                                                                                                                  ''pctl_fopfoundationtype.TYPECODE''    src_nm,
                                                                                                                                                                  CASE
                                                                                                                                                                                  WHEN pcx_fopdwelling.foundationtype_stg =''10001'' THEN ''BaseBlwGrd''
                                                                                                                                                                                  WHEN pcx_fopdwelling.foundationtype_stg =''10002'' THEN ''BaseDayLt''
                                                                                                                                                                                  WHEN pcx_fopdwelling.foundationtype_stg =''10003'' THEN ''BaseWalkout''
                                                                                                                                                                                  WHEN pcx_fopdwelling.foundationtype_stg =''10004'' THEN ''CrawlRaised''
                                                                                                                                                                                  WHEN pcx_fopdwelling.foundationtype_stg =''10005'' THEN ''Hillside''
                                                                                                                                                                                  WHEN pcx_fopdwelling.foundationtype_stg =''10006'' THEN ''Piers''
                                                                                                                                                                                  WHEN pcx_fopdwelling.foundationtype_stg =''10007'' THEN ''Slab''
                                                                                                                                                                  END                                                                                            AS asset_dtl_cd,
                                                                                                                                                                  cast(coalesce(pcx_fopdwelling.effectivedate_stg,pc_policyperiod.periodstart_stg) AS timestamp) AS strt_dt,
                                                                                                                                                                  cast(coalesce(pcx_fopdwelling.expirationdate_stg,pc_policyperiod.periodend_stg) AS timestamp)  AS end_dt,
                                                                                                                                                                  cast(pcx_fopdwelling.updatetime_stg AS timestamp)                                              AS updatetime,
                                                                                                                                                                  cast('' '' AS VARCHAR(255))                                                                      AS asset_dtl_txt,
                                                                                                                                                                  ''FOUND''                                                                                        AS asset_dtl_schm_type_cd
                                                                                                                                                  FROM            db_t_prod_stag.pc_policyperiod
                                                                                                                                                  join            db_t_prod_stag.pcx_fopdwelling
                                                                                                                                                  ON              pcx_fopdwelling.branchid_stg = pc_policyperiod.id_stg
                                                                                                                                                  join            db_t_prod_stag.pcx_foplocation
                                                                                                                                                  ON              pcx_fopdwelling.location_stg = pcx_foplocation.fixedid_stg
                                                                                                                                                  AND             pcx_foplocation.branchid_stg=pcx_fopdwelling.branchid_stg
                                                                                                                                                  join            db_t_prod_stag.pc_policylocation
                                                                                                                                                  ON              pcx_foplocation.policylocationid_stg = pc_policylocation.fixedid_stg
                                                                                                                                                  AND             pc_policylocation.branchid_stg=pcx_foplocation.branchid_stg
                                                                                                                                                  join            db_t_prod_stag.pctl_fopfoundationtype
                                                                                                                                                  ON              pctl_fopfoundationtype.id_stg = pcx_fopdwelling.foundationtype_stg
                                                                                                                                                  WHERE           ((
                                                                                                                                                                                                  pcx_fopdwelling.expirationdate_stg IS NULL
                                                                                                                                                                                  OR              pcx_fopdwelling.expirationdate_stg>pc_policyperiod.editeffectivedate_stg )
                                                                                                                                                                  AND             (
                                                                                                                                                                                                  pcx_foplocation.expirationdate_stg IS NULL
                                                                                                                                                                                  OR              pcx_foplocation.expirationdate_stg>pc_policyperiod.editeffectivedate_stg )
                                                                                                                                                                  AND             (
                                                                                                                                                                                                  pc_policylocation.expirationdate_stg IS NULL
                                                                                                                                                                                  OR              pc_policylocation.expirationdate_stg>pc_policyperiod.editeffectivedate_stg ) )
                                                                                                                                                  AND             pcx_fopdwelling.updatetime_stg>($start_dttm)
                                                                                                                                                  AND             pcx_fopdwelling.updatetime_stg <= ($end_dttm) qualify row_number () over (PARTITION BY pcx_fopdwelling.fixedid_stg,pcx_fopdwelling.foundationtype_stg,asset_dtl_cd ORDER BY pcx_fopdwelling.updatetime_stg DESC)=1
                                                                                                                                                  UNION
                                                                                                                                                  SELECT DISTINCT pcx_fopoutbuilding.fixedid_stg    AS id,
                                                                                                                                                                  ''PRTY_ASSET_SBTYPE36''             AS typecode ,
                                                                                                                                                                  ''PRTY_ASSET_CLASFCN13''            AS classification_code,
                                                                                                                                                                  ''SRC_SYS4''                        AS src_cd,
                                                                                                                                                                  ''pctl_fopfoundationtype.TYPECODE''    src_nm,
                                                                                                                                                                  CASE
                                                                                                                                                                                  WHEN pcx_fopoutbuilding.foundtype_stg =''10001'' THEN ''BaseBlwGrd''
                                                                                                                                                                                  WHEN pcx_fopoutbuilding.foundtype_stg =''10002'' THEN ''BaseDayLt''
                                                                                                                                                                                  WHEN pcx_fopoutbuilding.foundtype_stg =''10003'' THEN ''BaseWalkout''
                                                                                                                                                                                  WHEN pcx_fopoutbuilding.foundtype_stg =''10004'' THEN ''CrawlRaised''
                                                                                                                                                                                  WHEN pcx_fopoutbuilding.foundtype_stg =''10005'' THEN ''Hillside''
                                                                                                                                                                                  WHEN pcx_fopoutbuilding.foundtype_stg =''10006'' THEN ''Piers''
                                                                                                                                                                                  WHEN pcx_fopoutbuilding.foundtype_stg =''10007'' THEN ''Slab''
                                                                                                                                                                  END                                                                                               AS asset_dtl_cd,
                                                                                                                                                                  cast(coalesce(pcx_fopoutbuilding.effectivedate_stg,pc_policyperiod.periodstart_stg) AS timestamp) AS strt_dt,
                                                                                                                                                                  cast(coalesce(pcx_fopoutbuilding.expirationdate_stg,pc_policyperiod.periodend_stg) AS timestamp)  AS end_dt,
                                                                                                                                                                  cast(pcx_fopoutbuilding.updatetime_stg AS timestamp)                                              AS updatetime,
                                                                                                                                                                  cast('' '' AS VARCHAR(255))                                                                         AS asset_dtl_txt,
                                                                                                                                                                  ''FOUND''                                                                                           AS asset_dtl_schm_type_cd
                                                                                                                                                  FROM            db_t_prod_stag.pc_policyperiod
                                                                                                                                                  join            db_t_prod_stag.pcx_fopoutbuilding
                                                                                                                                                  ON              pcx_fopoutbuilding.branchid_stg = pc_policyperiod.id_stg
                                                                                                                                                  join            db_t_prod_stag.pcx_foplocation
                                                                                                                                                  ON              pcx_fopoutbuilding.location_stg = pcx_foplocation.fixedid_stg
                                                                                                                                                  AND             pcx_fopoutbuilding.branchid_stg=pcx_foplocation.branchid_stg
                                                                                                                                                  join            db_t_prod_stag.pc_policylocation
                                                                                                                                                  ON              pcx_foplocation.policylocationid_stg = pc_policylocation.fixedid_stg
                                                                                                                                                  AND             pc_policylocation.branchid_stg=pcx_foplocation.branchid_stg
                                                                                                                                                  join            db_t_prod_stag.pctl_fopfoundationtype
                                                                                                                                                  ON              pctl_fopfoundationtype.id_stg = pcx_fopoutbuilding.foundtype_stg
                                                                                                                                                  WHERE           ((
                                                                                                                                                                                                  pcx_fopoutbuilding.expirationdate_stg IS NULL
                                                                                                                                                                                  OR              pcx_fopoutbuilding.expirationdate_stg>pc_policyperiod.editeffectivedate_stg )
                                                                                                                                                                  AND             (
                                                                                                                                                                                                  pcx_foplocation.expirationdate_stg IS NULL
                                                                                                                                                                                  OR              pcx_foplocation.expirationdate_stg>pc_policyperiod.editeffectivedate_stg )
                                                                                                                                                                  AND             (
                                                                                                                                                                                                  pc_policylocation.expirationdate_stg IS NULL
                                                                                                                                                                                  OR              pc_policylocation.expirationdate_stg>pc_policyperiod.editeffectivedate_stg ) )
                                                                                                                                                  AND             pcx_fopoutbuilding.updatetime_stg>($start_dttm)
                                                                                                                                                  AND             pcx_fopoutbuilding.updatetime_stg <= ($end_dttm) qualify row_number () over (PARTITION BY pcx_fopoutbuilding.fixedid_stg,pcx_fopoutbuilding.foundtype_stg,asset_dtl_cd ORDER BY pcx_fopoutbuilding.updatetime_stg DESC)=1
                                                                                                                                                  UNION
                                                                                                                                                  SELECT DISTINCT pcx_fopdwelling.fixedid_stg      AS id,
                                                                                                                                                                  ''PRTY_ASSET_SBTYPE37''            AS typecode ,
                                                                                                                                                                  ''PRTY_ASSET_CLASFCN15''           AS classification_code,
                                                                                                                                                                  ''SRC_SYS4''                       AS src_cd,
                                                                                                                                                                  ''pctl_fopresidencetype.TYPECODE''    src_nm,
                                                                                                                                                                  CASE
                                                                                                                                                                                  WHEN pcx_fopdwelling.residencetype_stg =''10001'' THEN ''SingleFamilyResidence''
                                                                                                                                                                                  WHEN pcx_fopdwelling.residencetype_stg =''10002'' THEN ''TwoFamilyResidence''
                                                                                                                                                                                  WHEN pcx_fopdwelling.residencetype_stg =''10003'' THEN ''TownhouseOrRowhouse''
                                                                                                                                                                                  WHEN pcx_fopdwelling.residencetype_stg =''10004'' THEN ''AddOn''
                                                                                                                                                                                  WHEN pcx_fopdwelling.residencetype_stg =''10005'' THEN ''MobileHome''
                                                                                                                                                                                  WHEN pcx_fopdwelling.residencetype_stg =''10006'' THEN ''ModularOrPrefabricatedHome''
                                                                                                                                                                  END                                                                                            AS asset_dtl_cd,
                                                                                                                                                                  cast(coalesce(pcx_fopdwelling.effectivedate_stg,pc_policyperiod.periodstart_stg) AS timestamp) AS strt_dt,
                                                                                                                                                                  cast(coalesce(pcx_fopdwelling.expirationdate_stg,pc_policyperiod.periodend_stg) AS timestamp)  AS end_dt,
                                                                                                                                                                  cast(pcx_fopdwelling.updatetime_stg AS timestamp)                                              AS updatetime,
                                                                                                                                                                  cast('' '' AS VARCHAR(255))                                                                      AS asset_dtl_txt,
                                                                                                                                                                  ''RESD''                                                                                         AS asset_dtl_schm_type_cd
                                                                                                                                                  FROM            db_t_prod_stag.pc_policyperiod
                                                                                                                                                  join            db_t_prod_stag.pcx_fopdwelling
                                                                                                                                                  ON              pcx_fopdwelling.branchid_stg = pc_policyperiod.id_stg
                                                                                                                                                  join            db_t_prod_stag.pcx_foplocation
                                                                                                                                                  ON              pcx_fopdwelling.location_stg = pcx_foplocation.fixedid_stg
                                                                                                                                                  AND             pcx_foplocation.branchid_stg=pcx_fopdwelling.branchid_stg
                                                                                                                                                  join            db_t_prod_stag.pc_policylocation
                                                                                                                                                  ON              pcx_foplocation.policylocationid_stg = pc_policylocation.fixedid_stg
                                                                                                                                                  AND             pc_policylocation.branchid_stg=pcx_foplocation.branchid_stg
                                                                                                                                                  join            db_t_prod_stag.pctl_fopresidencetype
                                                                                                                                                  ON              pctl_fopresidencetype.id_stg = pcx_fopdwelling.residencetype_stg
                                                                                                                                                  WHERE           ((
                                                                                                                                                                                                  pcx_fopdwelling.expirationdate_stg IS NULL
                                                                                                                                                                                  OR              pcx_fopdwelling.expirationdate_stg>pc_policyperiod.editeffectivedate_stg )
                                                                                                                                                                  AND             (
                                                                                                                                                                                                  pcx_foplocation.expirationdate_stg IS NULL
                                                                                                                                                                                  OR              pcx_foplocation.expirationdate_stg>pc_policyperiod.editeffectivedate_stg )
                                                                                                                                                                  AND             (
                                                                                                                                                                                                  pc_policylocation.expirationdate_stg IS NULL
                                                                                                                                                                                  OR              pc_policylocation.expirationdate_stg>pc_policyperiod.editeffectivedate_stg ) )
                                                                                                                                                  AND             pcx_fopdwelling.updatetime_stg>($start_dttm)
                                                                                                                                                  AND             pcx_fopdwelling.updatetime_stg <= ($end_dttm) qualify row_number () over (PARTITION BY pcx_fopdwelling.fixedid_stg,pcx_fopdwelling.residencetype_stg,asset_dtl_cd ORDER BY pcx_fopdwelling.updatetime_stg DESC)=1
                                                                                                                                                  UNION
                                                                                                                                                  SELECT DISTINCT pcx_fopoutbuilding.fixedid_stg   AS id,
                                                                                                                                                                  ''PRTY_ASSET_SBTYPE36''            AS typecode ,
                                                                                                                                                                  ''PRTY_ASSET_CLASFCN13''           AS classification_code,
                                                                                                                                                                  ''SRC_SYS4''                       AS src_cd,
                                                                                                                                                                  ''pctl_fopresidencetype.TYPECODE''    src_nm,
                                                                                                                                                                  CASE
                                                                                                                                                                                  WHEN pcx_fopoutbuilding.outbldgrestype_stg =''10001'' THEN ''SingleFamilyResidence''
                                                                                                                                                                                  WHEN pcx_fopoutbuilding.outbldgrestype_stg =''10002'' THEN ''TwoFamilyResidence''
                                                                                                                                                                                  WHEN pcx_fopoutbuilding.outbldgrestype_stg =''10003'' THEN ''TownhouseOrRowhouse''
                                                                                                                                                                                  WHEN pcx_fopoutbuilding.outbldgrestype_stg =''10004'' THEN ''AddOn''
                                                                                                                                                                                  WHEN pcx_fopoutbuilding.outbldgrestype_stg =''10005'' THEN ''MobileHome''
                                                                                                                                                                                  WHEN pcx_fopoutbuilding.outbldgrestype_stg =''10006'' THEN ''ModularOrPrefabricatedHome''
                                                                                                                                                                  END                                                                                               AS asset_dtl_cd,
                                                                                                                                                                  cast(coalesce(pcx_fopoutbuilding.effectivedate_stg,pc_policyperiod.periodstart_stg) AS timestamp) AS strt_dt,
                                                                                                                                                                  cast(coalesce(pcx_fopoutbuilding.expirationdate_stg,pc_policyperiod.periodend_stg) AS timestamp)  AS end_dt,
                                                                                                                                                                  cast(pcx_fopoutbuilding.updatetime_stg AS timestamp)                                              AS updatetime,
                                                                                                                                                                  cast('' '' AS VARCHAR(255))                                                                         AS asset_dtl_txt,
                                                                                                                                                                  ''RESD''                                                                                            AS asset_dtl_schm_type_cd
                                                                                                                                                  FROM            db_t_prod_stag.pc_policyperiod
                                                                                                                                                  join            db_t_prod_stag.pcx_fopoutbuilding
                                                                                                                                                  ON              pcx_fopoutbuilding.branchid_stg = pc_policyperiod.id_stg
                                                                                                                                                  join            db_t_prod_stag.pcx_foplocation
                                                                                                                                                  ON              pcx_fopoutbuilding.location_stg = pcx_foplocation.fixedid_stg
                                                                                                                                                  AND             pcx_fopoutbuilding.branchid_stg=pcx_foplocation.branchid_stg
                                                                                                                                                  join            db_t_prod_stag.pc_policylocation
                                                                                                                                                  ON              pcx_foplocation.policylocationid_stg = pc_policylocation.fixedid_stg
                                                                                                                                                  AND             pc_policylocation.branchid_stg=pcx_foplocation.branchid_stg
                                                                                                                                                  join            db_t_prod_stag.pctl_fopresidencetype
                                                                                                                                                  ON              pctl_fopresidencetype.id_stg = pcx_fopoutbuilding.outbldgrestype_stg
                                                                                                                                                  WHERE           ((
                                                                                                                                                                                                  pcx_fopoutbuilding.expirationdate_stg IS NULL
                                                                                                                                                                                  OR              pcx_fopoutbuilding.expirationdate_stg>pc_policyperiod.editeffectivedate_stg )
                                                                                                                                                                  AND             (
                                                                                                                                                                                                  pcx_foplocation.expirationdate_stg IS NULL
                                                                                                                                                                                  OR              pcx_foplocation.expirationdate_stg>pc_policyperiod.editeffectivedate_stg )
                                                                                                                                                                  AND             (
                                                                                                                                                                                                  pc_policylocation.expirationdate_stg IS NULL
                                                                                                                                                                                  OR              pc_policylocation.expirationdate_stg>pc_policyperiod.editeffectivedate_stg ) )
                                                                                                                                                  AND             pcx_fopoutbuilding.updatetime_stg>($start_dttm)
                                                                                                                                                  AND             pcx_fopoutbuilding.updatetime_stg <= ($end_dttm) qualify row_number () over (PARTITION BY pcx_fopoutbuilding.fixedid_stg,pcx_fopoutbuilding.outbldgrestype_stg,asset_dtl_cd ORDER BY pcx_fopoutbuilding.updatetime_stg DESC)=1 )x
                                                                                                                         WHERE    asset_dtl_cd IS NOT NULL qualify row_number () over (PARTITION BY id,typecode,classification_code,asset_dtl_cd,src_cd ORDER BY updatetime DESC)=1 )b) sq
                                                                left outer join
                                                                                (
                                                                                       SELECT src_idntftn_nm,
                                                                                              trim(teradata_etl_ref_xlat.tgt_idntftn_val) AS tgt_idntftn_val,
                                                                                              trim(teradata_etl_ref_xlat.src_idntftn_val) AS src_idntftn_val
                                                                                       FROM   db_t_prod_core.teradata_etl_ref_xlat
                                                                                       WHERE  teradata_etl_ref_xlat.tgt_idntftn_nm= ''ASSET_DTL_TYPE'') tgt_etl_ref_xlat_asset
                                                                                /* QUALIFY      ROW_NUMBER()  */
                                                                                /* OVER(PARTITION BY  TERADATA_ETL_REF_XLAT.SRC_IDNTFTN_VAL order by TERADATA_ETL_REF_XLAT.SRC_IDNTFTN_VAL,TERADATA_ETL_REF_XLAT.TGT_IDNTFTN_VAL DESC )=1) TGT_ETL_REF_XLAT_ASSET */
                                                                ON              sq.asset_dtl_cd=tgt_etl_ref_xlat_asset.src_idntftn_val
                                                                AND             upper(src_nm) =upper(tgt_etl_ref_xlat_asset.src_idntftn_nm)
                                                                left outer join
                                                                                (
                                                                                       SELECT teradata_etl_ref_xlat.tgt_idntftn_val AS tgt_idntftn_val ,
                                                                                              teradata_etl_ref_xlat.src_idntftn_val AS src_idntftn_val
                                                                                       FROM   db_t_prod_core.teradata_etl_ref_xlat
                                                                                       WHERE  teradata_etl_ref_xlat.tgt_idntftn_nm= ''SRC_SYS''
                                                                                       AND    teradata_etl_ref_xlat.src_idntftn_nm= ''derived''
                                                                                       AND    teradata_etl_ref_xlat.src_idntftn_sys= ''DS''
                                                                                       AND    teradata_etl_ref_xlat.expn_dt=''9999-12-31'') tgt_etl_ref_xlat_sys
                                                                ON              sq.src_cd=tgt_etl_ref_xlat_sys.src_idntftn_val
                                                                left outer join
                                                                                (
                                                                                       SELECT teradata_etl_ref_xlat.tgt_idntftn_val AS tgt_idntftn_val ,
                                                                                              teradata_etl_ref_xlat.src_idntftn_val AS src_idntftn_val
                                                                                       FROM   db_t_prod_core.teradata_etl_ref_xlat
                                                                                       WHERE  teradata_etl_ref_xlat.tgt_idntftn_nm= ''PRTY_ASSET_CLASFCN''
                                                                                       AND    teradata_etl_ref_xlat.src_idntftn_nm IN ( ''derived'' ,
                                                                                                                                       ''pcx_holineschcovitemcov_alfa.ChoiceTerm1'',
                                                                                                                                       ''contentlineitemschedule.typecode'',
                                                                                                                                       ''pctl_bp7classificationproperty.typecode'')
                                                                                       AND    teradata_etl_ref_xlat.src_idntftn_sys IN (''DS'',
                                                                                                                                        ''GW'')
                                                                                       AND    teradata_etl_ref_xlat.expn_dt=''9999-12-31'') tgt_etl_xlat_class
                                                                ON              sq.classification_code=tgt_etl_xlat_class.src_idntftn_val
                                                                left outer join
                                                                                (
                                                                                       SELECT teradata_etl_ref_xlat.tgt_idntftn_val AS tgt_idntftn_val ,
                                                                                              teradata_etl_ref_xlat.src_idntftn_val AS src_idntftn_val
                                                                                       FROM   db_t_prod_core.teradata_etl_ref_xlat
                                                                                       WHERE  teradata_etl_ref_xlat.tgt_idntftn_nm= ''PRTY_ASSET_SBTYPE''
                                                                                       AND    teradata_etl_ref_xlat.src_idntftn_nm= ''derived''
                                                                                       AND    teradata_etl_ref_xlat.src_idntftn_sys=''DS''
                                                                                       AND    teradata_etl_ref_xlat.expn_dt=''9999-12-31'') tgt_etl_xlat_sbtype
                                                                ON              sq.typecode=tgt_etl_xlat_sbtype.src_idntftn_val
                                                                left outer join
                                                                                (
                                                                                       SELECT prty_asset.prty_asset_id             AS prty_asset_id,
                                                                                              prty_asset.asset_insrnc_hist_type_cd AS asset_insrnc_hist_type_cd,
                                                                                              prty_asset.asset_desc                AS asset_desc,
                                                                                              prty_asset.prty_asset_name           AS prty_asset_name,
                                                                                              prty_asset.prty_asset_strt_dttm      AS prty_asset_strt_dttm,
                                                                                              prty_asset.prty_asset_end_dttm       AS prty_asset_end_dttm,
                                                                                              prty_asset.edw_strt_dttm             AS edw_strt_dttm,
                                                                                              prty_asset.edw_end_dttm              AS edw_end_dttm,
                                                                                              prty_asset.src_sys_cd                AS src_sys_cd,
                                                                                              prty_asset.asset_host_id_val         AS asset_host_id_val,
                                                                                              prty_asset.prty_asset_sbtype_cd      AS prty_asset_sbtype_cd,
                                                                                              prty_asset.prty_asset_clasfcn_cd     AS prty_asset_clasfcn_cd
                                                                                       FROM   db_t_prod_core.prty_asset
                                                                                       WHERE  cast(prty_asset.edw_end_dttm AS DATE)=''9999-12-31'') tgt_party
                                                                ON              tgt_party.asset_host_id_val=to_char(sq.id)
                                                                AND             tgt_party.prty_asset_sbtype_cd=out_prty_asset_sbtype_cd
                                                                AND             tgt_party.prty_asset_clasfcn_cd=out_class_cd
                                                                left outer join
                                                                                (
                                                                                           SELECT     asset_dtl_cd_xref.asset_dtl_cd             AS asset_dtl_cd,
                                                                                                      asset_dtl_cd_xref.asset_dtl_xref_strt_dttm AS asset_dtl_xref_strt_dttm,
                                                                                                      asset_dtl_cd_xref.asset_dtl_xref_end_dttm  AS asset_dtl_xref_end_dttm,
                                                                                                      asset_dtl_cd_xref.asset_dtl_txt            AS asset_dtl_txt,
                                                                                                      asset_dtl_cd_xref.prty_asset_id            AS prty_asset_id,
                                                                                                      asset_dtl_type.asset_dtl_schm_type_cd      AS asset_dtl_schm_type_cd
                                                                                           FROM       db_t_prod_core.asset_dtl_cd_xref 
                                                                                           inner join db_t_prod_core.asset_dtl_type 
                                                                                           ON         asset_dtl_cd_xref.asset_dtl_cd= asset_dtl_type.asset_dtl_cd
                                                                                           WHERE      asset_dtl_type.asset_dtl_schm_type_cd IN (''DWELUSE'',
                                                                                                                                                ''HEAT'',
                                                                                                                                                ''OCC'',
                                                                                                                                                ''COOL'',
                                                                                                                                                ''DWEL'',
                                                                                                                                                ''RESD'',
                                                                                                                                                ''FOUND'',
                                                                                                                                                ''TERR'',
                                                                                                                                                ''VEHUSE'',
                                                                                                                                                ''HMALRT'' )
                                                                                           AND        cast(asset_dtl_type.edw_end_dttm AS    DATE)=''9999-12-31''
                                                                                           AND        cast(asset_dtl_cd_xref.edw_end_dttm AS DATE)=''9999-12-31'') tgt_asset_dtl
                                                                ON              tgt_asset_dtl.prty_asset_id=tgt_party.prty_asset_id
                                                                AND             tgt_asset_dtl.asset_dtl_schm_type_cd=sq.asset_dtl_schm_type_cd )sq2
                                                /* ------ */
                                  ) src ) );
  -- Component exp_data_transformation, Type EXPRESSION
  CREATE
  OR
  replace TEMPORARY TABLE exp_data_transformation AS
  (
         SELECT sq_pcx_dwelling_hoe.rank                                               AS rank,
                sq_pcx_dwelling_hoe.asset_dtl_cd                                       AS asset_dtl_cd,
                sq_pcx_dwelling_hoe.eff_dt                                             AS eff_dt,
                sq_pcx_dwelling_hoe.end_dt                                             AS end_dt,
                sq_pcx_dwelling_hoe.asset_dtl_txt                                      AS asset_dtl_txt,
                sq_pcx_dwelling_hoe.party_asset_id                                     AS party_asset_id,
                sq_pcx_dwelling_hoe.ins_upd_flag                                       AS ins_upd_flag,
                $prcs_id                                                               AS out_prcs_id,
                to_timestamp_ntz( ''12/31/9999 23:59:59.999999''  , ''MM/DD/YYYY HH24:MI:SS.FF6'' ) AS edw_end_dttm,
                sq_pcx_dwelling_hoe.source_record_id
         FROM   sq_pcx_dwelling_hoe );
  -- Component flt_asset_dtl_cd_xref, Type FILTER
  CREATE
  OR
  replace TEMPORARY TABLE flt_asset_dtl_cd_xref AS
  (
         SELECT exp_data_transformation.rank           AS rank,
                exp_data_transformation.party_asset_id AS party_asset_id,
                exp_data_transformation.asset_dtl_txt  AS in_asset_dtl_txt,
                exp_data_transformation.asset_dtl_cd   AS src_asst_dtl_cd,
                exp_data_transformation.eff_dt         AS eff_dt,
                exp_data_transformation.edw_end_dttm   AS edw_end_dttm,
                exp_data_transformation.out_prcs_id    AS out_prcs_id,
                exp_data_transformation.ins_upd_flag   AS ins_upd_flag,
                exp_data_transformation.end_dt         AS asset_dtl_xref_end_dttm,
                exp_data_transformation.source_record_id
         FROM   exp_data_transformation
         WHERE
                CASE
                       WHEN (
                                     exp_data_transformation.ins_upd_flag = ''I''
                              AND    exp_data_transformation.party_asset_id IS NOT NULL
                              AND    exp_data_transformation.asset_dtl_cd IS NOT NULL )
                       OR     exp_data_transformation.ins_upd_flag = ''U'' THEN TRUE
                       ELSE FALSE
                END );
  -- Component updstg_ins, Type UPDATE
  CREATE
  OR
  replace TEMPORARY TABLE updstg_ins AS
  (
         /* UPDATE_STRATEGY_ACTION = 0 FOR INSERT / UPDATE_STRATEGY_ACTION = 1 FOR UPDATE / UPDATE_STRATEGY_ACTION = 2 FOR DELETE / UPDATE_STRATEGY_ACTION = 3 FOR REJECT */
         SELECT flt_asset_dtl_cd_xref.party_asset_id          AS party_asset_id,
                flt_asset_dtl_cd_xref.src_asst_dtl_cd         AS asst_dtl_cd,
                flt_asset_dtl_cd_xref.eff_dt                  AS eff_dt,
                flt_asset_dtl_cd_xref.out_prcs_id             AS in_prcs_id,
                flt_asset_dtl_cd_xref.edw_end_dttm            AS edw_end_dttm1,
                flt_asset_dtl_cd_xref.asset_dtl_xref_end_dttm AS asset_dtl_xref_end_dttm,
                flt_asset_dtl_cd_xref.in_asset_dtl_txt        AS in_asset_dtl_txt,
                flt_asset_dtl_cd_xref.rank                    AS rank1,
                0                                             AS update_strategy_action,
                flt_asset_dtl_cd_xref.source_record_id
         FROM   flt_asset_dtl_cd_xref );
  -- Component exp_pass_to_tgt_ins, Type EXPRESSION
  CREATE
  OR
  replace TEMPORARY TABLE exp_pass_to_tgt_ins AS
  (
         SELECT updstg_ins.party_asset_id                                          AS party_asset_id,
                updstg_ins.asst_dtl_cd                                             AS asst_dtl_cd,
                updstg_ins.eff_dt                                                  AS eff_dt,
                updstg_ins.in_prcs_id                                              AS in_prcs_id,
                updstg_ins.edw_end_dttm1                                           AS edw_end_dttm1,
                updstg_ins.asset_dtl_xref_end_dttm                                 AS asset_dtl_xref_end_dttm,
                updstg_ins.in_asset_dtl_txt                                        AS in_asset_dtl_txt,
                dateadd(''second'', ( 2 * ( updstg_ins.rank1 - 1 ) ), current_timestamp) AS out_edw_start_dt,
                updstg_ins.source_record_id
         FROM   updstg_ins );
  -- Component tgt_ASSET_DTL_CD_XREF_ins, Type TARGET
  INSERT INTO db_t_prod_core.asset_dtl_cd_xref
              (
                          prty_asset_id,
                          asset_dtl_cd,
                          asset_dtl_xref_strt_dttm,
                          asset_dtl_xref_end_dttm,
                          asset_dtl_txt,
                          prcs_id,
                          edw_strt_dttm,
                          edw_end_dttm
              )
  SELECT exp_pass_to_tgt_ins.party_asset_id          AS prty_asset_id,
         exp_pass_to_tgt_ins.asst_dtl_cd             AS asset_dtl_cd,
         exp_pass_to_tgt_ins.eff_dt                  AS asset_dtl_xref_strt_dttm,
         exp_pass_to_tgt_ins.asset_dtl_xref_end_dttm AS asset_dtl_xref_end_dttm,
         exp_pass_to_tgt_ins.in_asset_dtl_txt        AS asset_dtl_txt,
         exp_pass_to_tgt_ins.in_prcs_id              AS prcs_id,
         exp_pass_to_tgt_ins.out_edw_start_dt        AS edw_strt_dttm,
         exp_pass_to_tgt_ins.edw_end_dttm1           AS edw_end_dttm
  FROM   exp_pass_to_tgt_ins;
  
  -- PIPELINE END FOR 1
  -- PIPELINE START FOR 2
  -- Component sq_pcx_dwelling_hoe1, Type SOURCE
  CREATE
  OR
  replace TEMPORARY TABLE sq_pcx_dwelling_hoe1 AS
  (
         SELECT
                /* adding column aliases to ensure proper downstream column references */
                $1 AS fixedid,
                $2 AS source_record_id
         FROM   (
                         SELECT   src.*,
                                  row_number() over (ORDER BY 1) AS source_record_id
                         FROM     (
                                         SELECT fixedid_stg
                                         FROM   db_t_prod_stag.pcx_dwelling_hoe
                                         WHERE  1=2 ) src ) );
  -- Component tgt_ASSET_DTL_CD_XREF_ins1, Type TARGET
  INSERT INTO db_t_prod_core.asset_dtl_cd_xref
              (
                          prty_asset_id
              )
  SELECT sq_pcx_dwelling_hoe1.fixedid AS prty_asset_id
  FROM   sq_pcx_dwelling_hoe1;
  
  -- PIPELINE END FOR 2
  -- Component tgt_ASSET_DTL_CD_XREF_ins1, Type Post SQL
  UPDATE db_t_prod_core.asset_dtl_cd_xref
 SET    edw_end_dttm=a.lead
  FROM   (
                         SELECT DISTINCT prty_asset_id,
                                         d.asset_dtl_schm_type_cd ,
                                         adx.asset_dtl_cd,
                                         adx.edw_strt_dttm,
                                         asset_dtl_xref_strt_dttm,
                                         max(adx.edw_strt_dttm) over (PARTITION BY prty_asset_id,d.asset_dtl_schm_type_cd ORDER BY adx.edw_strt_dttm ASC ROWS BETWEEN 1 following AND             1 following) - interval ''1 second'' AS lead
                         FROM            db_t_prod_core.asset_dtl_cd_xref adx
                         inner join      db_t_prod_core.asset_dtl_type d
                         ON              adx.asset_dtl_cd= d.asset_dtl_cd
                         WHERE           d.asset_dtl_schm_type_cd IN (''DWELUSE'',
                                                                      ''HEAT'',
                                                                      ''OCC'',
                                                                      ''COOL'',
                                                                      ''DWEL'',
                                                                      ''RESD'',
                                                                      ''FOUND'',
                                                                      ''TERR'',
                                                                      ''VEHUSE'',
                                                                      ''HMALRT'' )
                         AND             cast(d.edw_end_dttm AS DATE)=''9999-12-31'' ) a
 
  WHERE  asset_dtl_cd_xref.edw_strt_dttm = a.edw_strt_dttm
  AND    asset_dtl_cd_xref.prty_asset_id=a.prty_asset_id
  AND    asset_dtl_cd_xref.asset_dtl_cd=a.asset_dtl_cd
         --and ASSET_DTL_CD_XREF.ASSET_DTL_SCHM_TYPE_CD=A.ASSET_DTL_SCHM_TYPE_CD
  AND    asset_dtl_cd_xref.asset_dtl_xref_strt_dttm=a.asset_dtl_xref_strt_dttm
  AND    cast(asset_dtl_cd_xref.edw_end_dttm AS DATE)=''9999-12-31''
  AND    lead IS NOT NULL;

END;
';