-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_BIBASE_W_ADJSTR_WRKLD_INS("WORKLET_NAME" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' BEGIN 

-- Component SQ_AGMT, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_AGMT AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as CLM_DIST,
$2 as CAT_CODE,
$3 as CLM_NUM,
$4 as POL_NUM,
$5 as UNIT_CNT,
$6 as EXPSR_CNT,
$7 as INSRNC_LOB_TYPE_CD,
$8 as ADJ_DIST,
$9 as SVC,
$10 as ADJ_SYM,
$11 as ADJ_FIRST_NAME,
$12 as ADJ_LAST_NAME,
$13 as CAUSE_OF_LOSS,
$14 as RPTD_DT,
$15 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
/* GW */
SELECT DISTINCT

CAST(IO.INTRNL_ORG_NUM AS CHAR(1)) AS CLM_DIST

,CAST(CAT.CTSTRPH_NAME AS CHAR(5)) AS CAT_CODE

,CAST(CLM_NUM AS CHAR(20))

,CAST(HOST_AGMT_NUM AS CHAR(20)) AS POL_NUM

,CAST(UIF.UNIT_CNT AS INT) 

,CAST(EXPSR.EXPSR_CNT AS INT)

,CAST(LOB.INSRNC_LOB_TYPE_CD AS CHAR(20))

,CAST(IO.INTRNL_ORG_NUM AS CHAR(1)) AS ADJ_DIST

, CAST(REGEXP_REPLACE(ORG_NAME, ''^0+'', '''') AS VARCHAR(5)) AS SVC

,CAST(PI.PRTY_IDNTFTN_NUM AS CHAR(2)) AS ADJ_SYM

,CAST(I.GVN_NAME AS CHAR(50)) AS ADJ_FIRST_NAME

,CAST(I.FMLY_NAME AS CHAR(50)) AS ADJ_LAST_NAME

,CAST(PT.PERIL_TYPE_CD AS CHAR(20)) AS CAUSE_OF_LOSS

,cast(CDT.CLM_DTTM as CHAR(10)) AS RPTD_DT



FROM DB_T_PROD_CORE.CLM C

JOIN DB_T_PROD_CORE.CLM_PERIL CP ON CP.CLM_ID = C.CLM_ID AND CP.TRANS_END_DTTM = ''9999/12/31 23:59:59.999999''

JOIN DB_T_PROD_CORE.PERIL_TYPE PT ON CP.PERIL_TYPE_CD = PT.PERIL_TYPE_CD AND PERIL_TYPE_DESC <> ''ERA'' AND PERIL_TYPE_DESC <> ''GLASS BREAKAGE''

JOIN DB_T_PROD_CORE.CLM_DT CDT ON CDT.CLM_ID = C.CLM_ID AND CDT.CLM_DT_TYPE_CD = ''REPORTED''

JOIN DB_T_PROD_CORE.AGMT_CLM AC ON AC.CLM_ID = C.CLM_ID 

JOIN DB_T_PROD_CORE.AGMT A ON A.AGMT_ID = AC.AGMT_ID

JOIN (SELECT AGMT_ID, COUNT(PRTY_ASSET_ID) AS UNIT_CNT FROM DB_T_PROD_CORE.AGMT_ASSET AA GROUP BY 1) UIF ON UIF.AGMT_ID = A.AGMT_ID 

JOIN DB_T_PROD_CORE.PRTY_CLM PC ON PC.CLM_ID = C.CLM_ID AND PC.PRTY_CLM_ROLE_CD = ''ASGNADJSTR'' AND PC.TRANS_END_DTTM = ''9999/12/31 23:59:59.999999''

JOIN DB_T_PROD_CORE.PRTY_IDNTFTN PI ON PC.PRTY_ID = PI.PRTY_ID AND PRTY_IDNTFTN_TYPE_CD = ''ADJ''

JOIN DB_T_PROD_CORE.PRTY_RLTD PR ON PR.RLTD_PRTY_ID = PC.PRTY_ID

JOIN DB_T_PROD_CORE.INTRNL_ORG IO ON IO.INTRNL_ORG_PRTY_ID= PR.PRTY_ID

LEFT JOIN DB_T_PROD_CORE.INDIV_NAME I ON PI.PRTY_ID = I.INDIV_PRTY_ID AND PI.PRTY_IDNTFTN_TYPE_CD = ''ADJ'' AND I.TRANS_END_DTTM = ''9999/12/31 23:59:59.999999''

JOIN (SELECT DISTINCT CLM_ID, COUNT(CLM_EXPSR_ID) AS EXPSR_CNT FROM DB_T_PROD_CORE.CLM_EXPSR CE  WHERE EDW_END_DTTM = ''9999/12/31 23:59:59.999999'' GROUP BY 1) EXPSR ON EXPSR.CLM_ID = C.CLM_ID 

LEFT JOIN  (SELECT CLM_ID, CTSTRPH_NAME FROM DB_T_PROD_CORE.INCDT I

		   JOIN DB_T_PROD_CORE.CLM_EV CE ON CE.EV_ID = I.INCDT_EV_ID AND CE.TRANS_END_DTTM = ''9999/12/31 23:59:59.999999'') CAT ON CAT.CLM_ID = C.CLM_ID                                                                                                                                                                                                                                                

LEFT JOIN   (SELECT DISTINCT PA.AGMT_ID ,ORG_NAME FROM  DB_T_PROD_CORE.PRTY_AGMT PA

		  					JOIN DB_T_PROD_CORE.ORG_NAME O ON PA.PRTY_ID = O.PRTY_ID AND PA.PRTY_AGMT_ROLE_CD = ''SVC'') SVC 

		  					ON AC.AGMT_ID = SVC.AGMT_ID                                                                                         

JOIN  (SELECT AP.AGMT_ID, AP.PROD_ID, P.INSRNC_LOB_TYPE_CD, P.PROD_DESC FROM DB_T_PROD_CORE.AGMT_PROD AP 

							JOIN DB_T_PROD_CORE.PROD P ON P.PROD_ID = AP.PROD_ID

/* -BECAUSE THERE ARE 2 ROWS, 1 FOR PAP AND PAF, WE SHOULD EXCLUDE ONE */
							WHERE P.PROD_DESC <> ''PERSONAL ARTICLES DB_T_CORE_DM_PROD.POLICY (PAP)''	AND PROD_SBTYPE_CD = ''PLCYTYPE'' 	AND INSRNC_TYPE_CD <> ''COMRCL'') LOB	

							ON A.AGMT_ID = LOB.AGMT_ID

WHERE C.TRANS_END_DTTM = ''9999/12/31 23:59:59.999999''

AND PI.TRANS_END_DTTM = ''9999/12/31 23:59:59.999999''

AND PR.TRANS_END_DTTM = ''9999/12/31 23:59:59.999999''

AND cast(CDT.CLM_DTTM as date) >= $CAL_START_DT

AND cast(CDT.CLM_DTTM as date) <= $CAL_END_DT



UNION



/* LEGACY */
select 

CAST(CLM_DIST AS CHAR(1))

,CASE CAST(CAT_CODE AS CHAR(5)) WHEN '''' THEN NULL ELSE CAST(CAT_CODE AS CHAR(5)) END AS CAT_CD

,	CAST(LTRIM(RTRIM(POLICY_NUMBER))

||to_char(loss_date, ''mmddyy'') /* loss_date */
	||CASE STATE

	WHEN ''AL'' THEN ''01''

	WHEN ''GA'' THEN ''10''

	WHEN ''MS'' THEN ''28''

	ELSE NULL

	END  AS CHAR(20)) AS CLM_NUM

,CAST(POLICY_NUMBER AS CHAR(20)) AS POL_NUM

,CAST('''' AS INT) AS UNIT_CNT

,CAST('''' AS INT) AS EXPSR_CNT

,CAST(SYSTEM_CODE AS CHAR(20)) AS INSRNC_LOB_TYPE_CD

,CAST(ADJ_DIST AS CHAR(1))

,CAST(SC_NUMBER AS CHAR(5)) AS SVC

,CAST(ADJ_SYM AS CHAR(2))

, CAST(TRIM(SUBSTR(ADJUSTER, 1, NULLIF(POSITION('' '' IN ADJUSTER) - 1, -1))) AS VARCHAR(50)) AS ADJ_FIRST_NAME

, CAST(TRIM(SUBSTR(ADJUSTER, POSITION('' '' IN ADJUSTER) + 1)) AS VARCHAR(50)) AS ADJ_LAST_NAME

,CAST(CLAIM_TYPE AS CHAR(20)) AS CAUSE_OF_LOSS

,CAST(DATE_REPORTED AS CHAR(10)) AS RPTD_DT



from 

DB_T_ML_PROD.CTS_CLAIMS_INFO cci

join 

(

SELECT

case plcy_prefix

when 10 THEN ''A'' 

when 12 then ''CP''

when 13 then ''FC''

when 14 then ''GL''

when 15 then ''H''

when 17 then ''R''

when 18 then ''SC''

when 19 then ''SM''

when 20 then ''SP''

when 21 then ''T''

when 22 then ''WC''

when 23 then ''B''

when 26 then ''AD''

when 60 then ''F''

when 61 then ''M''

when 70 then ''G''

else null

end as prefix,

RTRIM(
  prefix
  || CASE LENGTH(prefix)
       WHEN 1 THEN LPAD(CAST(PLCY_NBR AS VARCHAR), 7, ''0'')
       WHEN 2 THEN LPAD(CAST(PLCY_NBR AS VARCHAR), 6, ''0'')
     END
)
|| TO_CHAR(loss_date, ''MMDDYY'')
|| LPAD(CAST(PLCY_ST AS VARCHAR), 2, ''0'')
AS CLAIM_NUM

,DIST_CD AS CLM_DIST, DIST_CD AS ADJ_DIST, ADJ_SYM/* , ectl_start_date, ectl_end_date */


from 

DB_T_CORE_PROD.clmf_claim_core

where 

((PLCY_NBR,PLCY_PREFIX,PLCY_ST,LOSS_DT, SEQ_NBR) IN (SELECT PLCY_NBR,PLCY_PREFIX,PLCY_ST,LOSS_DT, max(SEQ_NBR) FROM DB_T_CORE_PROD.clmf_claim_core A GROUP BY 1,2,3,4))

and ectl_end_date = to_date(''9999/12/31'',''yyyy/mm/dd'')

) DIST ON DIST.CLAIM_NUM = LTRIM(RTRIM(POLICY_NUMBER))

||to_char(loss_date, ''mmddyy'') /* loss_date */
||CASE STATE

WHEN ''AL'' THEN ''01''

WHEN ''GA'' THEN ''10''

WHEN ''MS'' THEN ''28''

ELSE NULL

END

where claim_type <> ''ERA''

AND claim_type not like ''GL%''

AND POLICY_NUMBER NOT LIKE ''SM%''

AND DATE_REPORTED >= $CAL_START_DT

AND DATE_REPORTED <= $CAL_END_DT



UNION



/* EXCEED */
SELECT DISTINCT 

CAST(SUBSTR(ADJ.CAJ_ADJ_INITIALS,1,1) AS CHAR(1)) AS CLM_DIST /* DEFAULTED TO ADJ DISTRICT SINCE DB_T_PROD_CORE.CLM DISTRICT DOESNT EXIST FOR EXCEED  */
, CAST(TRIM(COC_CATASTROPHE_CD) || TO_CHAR(CLM_REPORTED_DT, ''YY'') AS VARCHAR(5)) AS CAT_CD

,CAST(CLM_CSR_CLAIM_NBR AS CHAR(20)) AS CLM_NUM

,CAST(CTD.POLICY_NBR AS CHAR(20)) AS POL_NUM

,CAST('''' AS INT) AS UNIT_CNT

,CAST('''' AS INT) AS EXPSR_CNT

,CAST(''PA'' AS CHAR(20)) AS INSRNC_LOB_TYPE_CD

,CAST(SUBSTR(ADJ.CAJ_ADJ_INITIALS,1,1) AS CHAR(1)) AS ADJ_DIST

,CAST(CTD.POL_BRANCH_NBR AS CHAR(5)) AS SVC

,CAST(SUBSTR(ADJ.CAJ_ADJ_INITIALS,2,1) AS CHAR(2)) AS ADJ_SYM

,CAST(FIRST_NAME AS CHAR(50)) AS ADJ_FIRST_NAME

,CAST(LAST_NAME AS CHAR(50)) AS ADJ_LAST_NAME

,CAST(CLM_CAUSE_LOSS_CD AS CHAR(20)) AS CAUSE_OF_LOSS

,CAST(CLM_REPORTED_DT AS CHAR(10)) AS RPTD_DT



FROM DB_T_ONSITE_PROD.CLAIM_TAB CLMT

JOIN DB_T_ONSITE_PROD.CLAIM_CLIENT CC ON CLMT.CLM_CLAIM_NBR = CC.CCI_CLAIM_NBR

JOIN (SELECT DISTINCT POLICY_NBR, CLM_NBR, POL_BRANCH_NBR, CTX_ADJUSTER_NBR FROM  DB_T_CORE_PROD.CLAIM_TRANS_DTL WHERE

							((CLM_NBR, TRANS_DT, CREATE_TS,POL_DTL_SEQ_NBR) IN (SELECT A.CLM_NBR, MAX(A.TRANS_DT), MAX(A.CREATE_TS), MAX(A.POL_DTL_SEQ_NBR)

							 FROM DB_T_CORE_PROD.CLAIM_TRANS_DTL A GROUP BY A.CLM_NBR))) AS CTD 

							ON CTD.CLM_NBR=CLMT.CLM_CSR_CLAIM_NBR

JOIN DB_T_ONSITE_PROD.ADJUSTER_TAB ADJ ON CTD.CTX_ADJUSTER_NBR=ADJ.CAJ_ADJUSTER_NBR

LEFT JOIN DB_T_CORE_PROD.DW_AD_USERS ADU ON ADJ.CAJ_USER_ID =ADU.USER_ID AND  ECTL_END_DATE = to_date(''9999/12/31'',''yyyy/mm/dd'')

LEFT JOIN DB_T_ONSITE_PROD.LOSS_OCCURRENCE LO ON LO.COC_OCCURRENCE_ID = CLMT.CLM_OCCURRENCE_ID

WHERE CLM_CSR_CLAIM_NBR NOT LIKE ''GL%''

AND CLM_CSR_CLAIM_NBR NOT LIKE ''ER%''

AND CLM_REPORTED_DT >= $CAL_START_DT

AND CLM_REPORTED_DT <= $CAL_END_DT
) SRC
)
);


-- Component EXPTRANS, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE EXPTRANS AS
(
SELECT
SQ_AGMT.CLM_DIST as CLM_DIST,
SQ_AGMT.CAT_CODE as CAT_CODE,
SQ_AGMT.CLM_NUM as CLM_NUM,
SQ_AGMT.POL_NUM as POL_NUM,
SQ_AGMT.UNIT_CNT as UNIT_CNT,
SQ_AGMT.EXPSR_CNT as EXPSR_CNT,
SQ_AGMT.INSRNC_LOB_TYPE_CD as INSRNC_LOB_TYPE_CD,
SQ_AGMT.ADJ_DIST as ADJ_DIST,
SQ_AGMT.SVC as SVC,
SQ_AGMT.ADJ_SYM as ADJ_SYM,
SQ_AGMT.ADJ_FIRST_NAME as ADJ_FIRST_NAME,
SQ_AGMT.ADJ_LAST_NAME as ADJ_LAST_NAME,
SQ_AGMT.CAUSE_OF_LOSS as CAUSE_OF_LOSS,
TO_DATE ( SQ_AGMT.RPTD_DT , ''YYYY/MM/DD'' ) as OUT_RPTD_DT,
SQ_AGMT.source_record_id
FROM
SQ_AGMT
);


-- Component WR_ADJSTR_WRKLD, Type TARGET 
INSERT INTO DB_V_PROD_PRES.WR_ADJSTR_WRKLD
(
CLM_DIST,
CAT_CODE,
CLM_NUM,
POL_NUM,
UNIT_CNT,
EXPSR_CNT,
INSRNC_LOB_TYPE_CD,
ADJ_DIST,
SVC,
ADJ_SYM,
ADJ_FIRST_NAME,
ADJ_LAST_NAME,
CAUSE_OF_LOSS,
RPTD_DT
)
SELECT
EXPTRANS.CLM_DIST as CLM_DIST,
EXPTRANS.CAT_CODE as CAT_CODE,
EXPTRANS.CLM_NUM as CLM_NUM,
EXPTRANS.POL_NUM as POL_NUM,
EXPTRANS.UNIT_CNT as UNIT_CNT,
EXPTRANS.EXPSR_CNT as EXPSR_CNT,
EXPTRANS.INSRNC_LOB_TYPE_CD as INSRNC_LOB_TYPE_CD,
EXPTRANS.ADJ_DIST as ADJ_DIST,
EXPTRANS.SVC as SVC,
EXPTRANS.ADJ_SYM as ADJ_SYM,
EXPTRANS.ADJ_FIRST_NAME as ADJ_FIRST_NAME,
EXPTRANS.ADJ_LAST_NAME as ADJ_LAST_NAME,
EXPTRANS.CAUSE_OF_LOSS as CAUSE_OF_LOSS,
EXPTRANS.OUT_RPTD_DT as RPTD_DT
FROM
EXPTRANS;


END; ';