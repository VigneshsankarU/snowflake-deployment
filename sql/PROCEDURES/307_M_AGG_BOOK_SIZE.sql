-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_AGG_BOOK_SIZE("RUN_ID" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' DECLARE ESTAGMEMBDB_LGCY varchar;
BEGIN 

ESTAGMEMBDB_LGCY:=''DB_T_STAG_MEMBXREF_PROD'';  

-- PIPELINE START FOR 1

-- Component src_book_size_count, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE src_book_size_count AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as CNT,
$2 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
select count(*) as CNT from (
SELECT DISTINCT CAST(FEED_DT AS DATE ) AS CAL_END_DATE, 
EXTRACT(YEAR FROM CAST(FEED_DT AS DATE))*100 + EXTRACT(MONTH  FROM CAST(FEED_DT AS DATE)) AS MO_ID
FROM DB_T_STAG_MEMBXREF_PROD.STG_MEMBXREF_TRIGGER)c
) SRC
)
);


-- Component expr_book_size_abort, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE expr_book_size_abort AS
(
SELECT
CASE WHEN src_book_size_count.CNT = 0 THEN 
null --RAISE_ERROR(''There are no records'') 
ELSE '''' END as o_ABORT_MESSAGE,
src_book_size_count.source_record_id
FROM
src_book_size_count
);


-- Component BOOK_SIZE_ABORT, Type TARGET_EXPORT_PREPARE Stage data before exporting
CREATE OR REPLACE TEMPORARY TABLE BOOK_SIZE_ABORT AS
(
SELECT
expr_book_size_abort.o_ABORT_MESSAGE as ABORT_MESSAGE
FROM
expr_book_size_abort
);


-- Component BOOK_SIZE_ABORT, Type EXPORT_DATA Exporting data
;


-- PIPELINE END FOR 1

-- PIPELINE START FOR 2
-- Component BOOK_SIZE, Type Pre SQL 
DELETE FROM DB_T_CORE_MEMBXREF_PROD.BOOK_SIZE where MO_ID in (
SELECT distinct EXTRACT(YEAR FROM CAST(FEED_DT AS DATE))*100 + EXTRACT(MONTH  FROM CAST(FEED_DT AS DATE)) AS MO_ID
FROM  DB_T_STAG_MEMBXREF_PROD.STG_MEMBXREF_TRIGGER) AND BOOK_SIZE.LOB_TYPE in (''FARMPOLS'',''FGMPOLS'',''PORTPOLS'',''SMLNPOLS'');


-- Component src_book_size, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE src_book_size AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as MO_ID,
$2 as LOB_TYPE,
$3 as SC_SERVICE_CENTER,
$4 as PC_AGENT,
$5 as UWCO,
$6 as COMS_PLCY_SYMB,
$7 as BOOK_SIZE,
$8 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
with TRG_DATE as(
SELECT DISTINCT CAST(FEED_DT AS DATE ) AS CAL_END_DATE, 
EXTRACT(YEAR FROM CAST(FEED_DT AS DATE))*100 + EXTRACT(MONTH  FROM CAST(FEED_DT AS DATE)) AS MO_ID
FROM DB_T_STAG_MEMBXREF_PROD.STG_MEMBXREF_TRIGGER)


/* ------------COMMISIONS DB_T_CORE_DM_PROD.POLICY SYMBOL FOR FARM POLS IS ALWAYS R0 */
SELECT mo_id,  ''FARMPOLS'' LOB_TYPE, SC_SERVICE_CENTER SVC, PC_AGENT AGENT , ''AMI'' AS UWCO,CAST( ''R0'' AS VARCHAR(3))AS COMM_POL_SYM, SUM(RFD_TOT_PREM ) BOOK_SIZE FROM 
DB_T_CORE_MEMBXREF_PROD.FARMPOLS A JOIN TRG_DATE C ON 1=1 
WHERE CAL_END_DATE BETWEEN CHG_EFF_DT AND CHG_EXP_DT AND PC_STATUS NOT IN (''5'',''6'')
GROUP BY LOB_TYPE, SVC, AGENT,UWCO, mo_id
UNION
/* -------------------------------------------NEW DB_T_CORE_MEMBXREF_PROD.FGMPOLS START------------------------------------------------------- */
/* ------------COMMISIONS DB_T_CORE_DM_PROD.POLICY SYMBOL FOR FGM POLS IS BASED ON FIRST 2 CHARS OF POLICYNUMBER */
SELECT mo_id,A.LOB_TYPE, A.SVC, A.AGENT, A.UWCO, A.COMM_POL_SYM, BOOK_SIZE
FROM
(SELECT MO_ID,''FGMPOLS'' LOB_TYPE,SC_SERVICE_CENTER  SVC, PC_AGENT AGENT, ''AIC'' AS UWCO,
	CASE WHEN SUBSTR(SC_POLICY_NUM,1,2) = ''GL''  THEN (SELECT DISTINCT(PTC.COMM_POL_SYM_stg) FROM DB_T_PROD_STAG.GW_POLTYPE_CONV PTC WHERE PTC.LGCY_PFX_ALPHA_stg = ''GL'' ) 
				WHEN SUBSTR(SC_POLICY_NUM,1,2) = ''M0'' THEN ( SELECT PTC.COMM_POL_SYM_stg FROM DB_T_PROD_STAG.GW_POLTYPE_CONV PTC WHERE PTC.LGCY_PFX_ALPHA_stg = ''M'')
				WHEN SUBSTR(SC_POLICY_NUM,1,2) = ''FC'' THEN ( SELECT PTC.COMM_POL_SYM_stg FROM DB_T_PROD_STAG.GW_POLTYPE_CONV PTC WHERE PTC.LGCY_PFX_ALPHA_stg = ''FC'')
				WHEN SUBSTR(SC_POLICY_NUM,1,2) = ''SM'' AND FGM_SM_POLICY_IND = ''B''  THEN ( SELECT PTC.COMM_POL_SYM_stg FROM DB_T_PROD_STAG.GW_POLTYPE_CONV PTC WHERE PTC.LGCY_PFX_ALPHA_stg = ''SM'' AND EDM_LOB_stg = ''BUSINESS OWNER'')
				WHEN SUBSTR(SC_POLICY_NUM,1,2) = ''SM'' AND FGM_SM_POLICY_IND = ''C''  THEN ( SELECT PTC.COMM_POL_SYM_stg FROM DB_T_PROD_STAG.GW_POLTYPE_CONV PTC WHERE PTC.LGCY_PFX_ALPHA_stg = ''SM'' AND EDM_LOB_stg = ''CHURCH'')
END AS COMM_POL_SYM ,
	SUM(FGM_TOT_PREM ) BOOK_SIZE
FROM DB_T_CORE_MEMBXREF_PROD.FGMPOLS A JOIN TRG_DATE C ON 1=1 
	WHERE  CAL_END_DATE  BETWEEN CHG_EFF_DT AND  CHG_EXP_DT AND PC_STATUS NOT IN (''5'',''6'') 
GROUP BY 1,2,3,4,5,6
)A
UNION
/* ------------COMMISIONS DB_T_CORE_DM_PROD.POLICY SYMBOL FOR PORT POLS IS ALWAYS SC */
SELECT MO_ID, ''PORTPOLS'' LOB_TYPE,SC_SERVICE_CENTER SVC, PC_AGENT AGENT, CASE WHEN PORT_STATE = ''AL'' THEN ''AMI'' ELSE ''AIC'' END AS UWCO, ''SC'' AS COMM_POL_SYM,  SUM(PORT_TOT_PREM ) BOOK_SIZE FROM 
DB_T_CORE_MEMBXREF_PROD.PORTPOLS A JOIN TRG_DATE C ON 1=1 
WHERE  CAL_END_DATE  BETWEEN CHG_EFF_DT AND  CHG_EXP_DT AND PC_STATUS NOT IN (''5'',''6'') 
GROUP BY  LOB_TYPE, SVC, AGENT,UWCO,MO_ID
UNION
/* -------------------------------------------NEW DB_T_CORE_MEMBXREF_PROD.SMLNPOLS START------------------------------------------------------- */
/* ------------COMMISIONS DB_T_CORE_DM_PROD.POLICY SYMBOL FOR SMLN POLS IS BASED ON FIRST 2 CHARS OF POLICYNUMBER */
SELECT MO_ID, A.LOB_TYPE, A.SVC, A.AGENT, A.UWCO, A.COMM_POL_SYM, BOOK_SIZE
FROM
(SELECT MO_ID,''SMLNPOLS'' LOB_TYPE,SC_SERVICE_CENTER  SVC, PC_AGENT AGENT, ''AMI'' AS UWCO,
	CASE WHEN SUBSTR(SC_POLICY_NUM,1,2) = ''GL''  THEN (SELECT DISTINCT(PTC.COMM_POL_SYM_stg) FROM DB_T_PROD_STAG.GW_POLTYPE_CONV PTC WHERE PTC.LGCY_PFX_ALPHA_stg = ''GL'' ) 
				WHEN SUBSTR(SC_POLICY_NUM,1,2) = ''M0'' THEN ( SELECT PTC.COMM_POL_SYM_stg FROM DB_T_PROD_STAG.GW_POLTYPE_CONV PTC WHERE PTC.LGCY_PFX_ALPHA_stg = ''M'')
				WHEN SUBSTR(SC_POLICY_NUM,1,2) = ''FC'' THEN ( SELECT PTC.COMM_POL_SYM_stg FROM DB_T_PROD_STAG.GW_POLTYPE_CONV PTC WHERE PTC.LGCY_PFX_ALPHA_stg = ''FC'')
				WHEN SUBSTR(SC_POLICY_NUM,1,2) = ''SM'' AND SMLN_POL_TYPE = ''B''  THEN ( SELECT PTC.COMM_POL_SYM_stg FROM DB_T_PROD_STAG.GW_POLTYPE_CONV PTC WHERE PTC.LGCY_PFX_ALPHA_stg = ''SM'' AND EDM_LOB_stg = ''BUSINESS OWNER'')
				WHEN SUBSTR(SC_POLICY_NUM,1,2) = ''SM'' AND SMLN_POL_TYPE = ''C''  THEN ( SELECT PTC.COMM_POL_SYM_stg FROM DB_T_PROD_STAG.GW_POLTYPE_CONV PTC WHERE PTC.LGCY_PFX_ALPHA_stg = ''SM'' AND EDM_LOB_stg = ''CHURCH'')
	END AS COMM_POL_SYM, 
	SUM(SMLN_TOT_PREM ) BOOK_SIZE 
FROM DB_T_CORE_MEMBXREF_PROD.SMLNPOLS A JOIN TRG_DATE C ON 1=1 
	WHERE  CAL_END_DATE  BETWEEN CHG_EFF_DT AND  CHG_EXP_DT AND PC_STATUS NOT IN (''5'',''6'') 
/* HAVING SUM(SMLN_TOT_PREM) =999.99 */
GROUP BY 1,2,3,4,5,6
)A
) SRC
)
);


-- Component exp_book_size, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_book_size AS
(
SELECT
src_book_size.MO_ID as MO_ID,
src_book_size.LOB_TYPE as LOB_TYPE,
src_book_size.SC_SERVICE_CENTER as SC_SERVICE_CENTER,
src_book_size.PC_AGENT as PC_AGENT,
src_book_size.UWCO as UWCO,
src_book_size.COMS_PLCY_SYMB as COMS_PLCY_SYMB,
src_book_size.BOOK_SIZE as BOOK_SIZE,
src_book_size.source_record_id
FROM
src_book_size
);


-- Component BOOK_SIZE, Type TARGET 
INSERT INTO DB_T_CORE_MEMBXREF_PROD.BOOK_SIZE
(
MO_ID,
LOB_TYPE,
SC_SERVICE_CENTER,
PC_AGENT,
UWCO,
COMS_PLCY_SYMB,
BOOK_SIZE
)
SELECT
exp_book_size.MO_ID as MO_ID,
exp_book_size.LOB_TYPE as LOB_TYPE,
exp_book_size.SC_SERVICE_CENTER as SC_SERVICE_CENTER,
exp_book_size.PC_AGENT as PC_AGENT,
exp_book_size.UWCO as UWCO,
exp_book_size.COMS_PLCY_SYMB as COMS_PLCY_SYMB,
exp_book_size.BOOK_SIZE as BOOK_SIZE
FROM
exp_book_size;


-- PIPELINE END FOR 2

END; ';