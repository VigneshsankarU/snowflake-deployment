-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_STG_ARS_BILL_INFO("RUN_ID" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' BEGIN 

-- Component LKP_ECTL_PRGM_PARAM, Type Prerequisite Lookup Object 
CREATE OR REPLACE TEMPORARY TABLE LKP_ECTL_PRGM_PARAM AS
(
SELECT
ECTL_PARAM_VALUE,
ECTL_PARAM_DESC
FROM DB_T_CTRL_FIN_PROD.ECTL_PRGM_PARAM
);


-- PIPELINE START FOR 1

-- Component SQ_SRC_DUMMY, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_SRC_DUMMY AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as DUMMY,
$2 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT COUNT(*) AS DUMMY FROM DB_T_STAG_PROD.ALFA_ARS_BILL_INFO
) SRC
)
);


-- Component fil_DUMMY, Type FILTER 
CREATE OR REPLACE TEMPORARY TABLE fil_DUMMY AS
(
SELECT
SQ_SRC_DUMMY.DUMMY as DUMMY,
SQ_SRC_DUMMY.source_record_id
FROM
SQ_SRC_DUMMY
WHERE 1 = 2
);


-- Component STG_ARS_BILL_INFO_DUMMY_TRUNCATE, Type TARGET 
INSERT INTO DB_T_STAG_PROD.STG_ARS_BILL_INFO
(
BIL_ACCOUNT_ID
)
SELECT
fil_DUMMY.DUMMY as BIL_ACCOUNT_ID
FROM
fil_DUMMY;


-- PIPELINE END FOR 1

-- PIPELINE START FOR 2

-- Component SQ_ALFA_ARS_BILL_INFO, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_ALFA_ARS_BILL_INFO AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as BIL_ACCOUNT_ID,
$2 as BIL_ACCOUNT_NBR,
$3 as POLICY_NBR,
$4 as BIL_PLAN_CD,
$5 as LATE_IND_3YR,
$6 as LATE_COUNT_1YR,
$7 as LATE_COUNT_2YR,
$8 as LATE_COUNT_3YR,
$9 as LATE_COUNT_4YR,
$10 as LATE_COUNT_5YR,
$11 as TEN_DAY_LATE_COUNT,
$12 as LOB,
$13 as MEM_CUST_TYPE,
$14 as MEM_CUST_NBR,
$15 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT
ALFA_ARS_BILL_INFO.BIL_ACCOUNT_ID,
ALFA_ARS_BILL_INFO.BIL_ACCOUNT_NBR,
ALFA_ARS_BILL_INFO.POLICY_NBR,
ALFA_ARS_BILL_INFO.BIL_PLAN_CD,
ALFA_ARS_BILL_INFO.LATE_IND_3YR,
ALFA_ARS_BILL_INFO.LATE_COUNT_1YR,
ALFA_ARS_BILL_INFO.LATE_COUNT_2YR,
ALFA_ARS_BILL_INFO.LATE_COUNT_3YR,
ALFA_ARS_BILL_INFO.LATE_COUNT_4YR,
ALFA_ARS_BILL_INFO.LATE_COUNT_5YR,
ALFA_ARS_BILL_INFO.TEN_DAY_LATE_COUNT,
ALFA_ARS_BILL_INFO.LOB,
ALFA_ARS_BILL_INFO.MEM_CUST_TYPE,
ALFA_ARS_BILL_INFO.MEM_CUST_NBR
FROM DB_T_STAG_PROD.ALFA_ARS_BILL_INFO
) SRC
)
);


-- Component exp_HOLD_CLEANSE_DATA, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_HOLD_CLEANSE_DATA AS
(
SELECT
LTRIM ( RTRIM ( SQ_ALFA_ARS_BILL_INFO.BIL_ACCOUNT_ID ) ) as o_BIL_ACCOUNT_ID,
LTRIM ( RTRIM ( SQ_ALFA_ARS_BILL_INFO.BIL_ACCOUNT_NBR ) ) as o_BIL_ACCOUNT_NBR,
LTRIM ( RTRIM ( SQ_ALFA_ARS_BILL_INFO.POLICY_NBR ) ) as o_POLICY_NBR,
LKP_1.ECTL_PARAM_VALUE /* replaced lookup LKP_ECTL_PRGM_PARAM */ as var_FEED_DT,
TO_NUMBER(substr ( var_FEED_DT , 1 , 4 ) || substr ( var_FEED_DT , 6 , 2 ) || substr ( var_FEED_DT , 9 , 2 )) as o_FEED_DT_ID,
LTRIM ( RTRIM ( SQ_ALFA_ARS_BILL_INFO.BIL_PLAN_CD ) ) as o_BIL_PLAN_CD,
LTRIM ( RTRIM ( SQ_ALFA_ARS_BILL_INFO.LATE_IND_3YR ) ) as o_LATE_IND_3YR,
SQ_ALFA_ARS_BILL_INFO.LATE_COUNT_1YR as LATE_COUNT_1YR,
SQ_ALFA_ARS_BILL_INFO.LATE_COUNT_2YR as LATE_COUNT_2YR,
SQ_ALFA_ARS_BILL_INFO.LATE_COUNT_3YR as LATE_COUNT_3YR,
SQ_ALFA_ARS_BILL_INFO.LATE_COUNT_4YR as LATE_COUNT_4YR,
SQ_ALFA_ARS_BILL_INFO.LATE_COUNT_5YR as LATE_COUNT_5YR,
SQ_ALFA_ARS_BILL_INFO.TEN_DAY_LATE_COUNT as TEN_DAY_LATE_COUNT,
LTRIM ( RTRIM ( SQ_ALFA_ARS_BILL_INFO.LOB ) ) as o_LOB,
LTRIM ( RTRIM ( SQ_ALFA_ARS_BILL_INFO.MEM_CUST_TYPE ) ) as o_MEM_CUST_TYPE,
LTRIM ( RTRIM ( SQ_ALFA_ARS_BILL_INFO.MEM_CUST_NBR ) ) as o_MEM_CUST_NBR,
SQ_ALFA_ARS_BILL_INFO.source_record_id,
row_number() over (partition by SQ_ALFA_ARS_BILL_INFO.source_record_id order by SQ_ALFA_ARS_BILL_INFO.source_record_id) as RNK
FROM
SQ_ALFA_ARS_BILL_INFO
LEFT JOIN LKP_ECTL_PRGM_PARAM LKP_1 ON LKP_1.ECTL_PARAM_DESC = ''ALFA ARS BILL INFO FEED DATE''
QUALIFY RNK = 1
);


-- Component STG_ARS_BILL_INFO_INS, Type TARGET 
INSERT INTO DB_T_STAG_PROD.STG_ARS_BILL_INFO
(
BIL_ACCOUNT_ID,
BIL_ACCOUNT_NBR,
POLICY_NBR,
FEED_DT_ID,
BIL_PLAN_CD,
LATE_IND_3YR,
LATE_COUNT_1YR,
LATE_COUNT_2YR,
LATE_COUNT_3YR,
LATE_COUNT_4YR,
LATE_COUNT_5YR,
TEN_DAY_LATE_COUNT,
LOB,
MEM_CUST_TYPE,
MEM_CUST_NBR
)
SELECT
exp_HOLD_CLEANSE_DATA.o_BIL_ACCOUNT_ID as BIL_ACCOUNT_ID,
exp_HOLD_CLEANSE_DATA.o_BIL_ACCOUNT_NBR as BIL_ACCOUNT_NBR,
exp_HOLD_CLEANSE_DATA.o_POLICY_NBR as POLICY_NBR,
exp_HOLD_CLEANSE_DATA.o_FEED_DT_ID as FEED_DT_ID,
exp_HOLD_CLEANSE_DATA.o_BIL_PLAN_CD as BIL_PLAN_CD,
exp_HOLD_CLEANSE_DATA.o_LATE_IND_3YR as LATE_IND_3YR,
exp_HOLD_CLEANSE_DATA.LATE_COUNT_1YR as LATE_COUNT_1YR,
exp_HOLD_CLEANSE_DATA.LATE_COUNT_2YR as LATE_COUNT_2YR,
exp_HOLD_CLEANSE_DATA.LATE_COUNT_3YR as LATE_COUNT_3YR,
exp_HOLD_CLEANSE_DATA.LATE_COUNT_4YR as LATE_COUNT_4YR,
exp_HOLD_CLEANSE_DATA.LATE_COUNT_5YR as LATE_COUNT_5YR,
exp_HOLD_CLEANSE_DATA.TEN_DAY_LATE_COUNT as TEN_DAY_LATE_COUNT,
exp_HOLD_CLEANSE_DATA.o_LOB as LOB,
exp_HOLD_CLEANSE_DATA.o_MEM_CUST_TYPE as MEM_CUST_TYPE,
exp_HOLD_CLEANSE_DATA.o_MEM_CUST_NBR as MEM_CUST_NBR
FROM
exp_HOLD_CLEANSE_DATA;


-- PIPELINE END FOR 2

END; ';