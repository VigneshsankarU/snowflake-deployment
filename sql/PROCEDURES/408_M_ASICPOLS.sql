-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_ASICPOLS("RUN_ID" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' DECLARE PMMAPPINGNAME varchar;
PROJ_ID varchar;
BATCH_ACTIVE_IND varchar;
BEGIN 

PMMAPPINGNAME:=''M_ASICPOLS''; 
BATCH_ACTIVE_IND:=(select ectl_active_ind from DB_T_CTRL_PROD.ECTL_BATCH_INFO where ECTL_BATCH_ID= :run_id); 
PROJ_ID:=(select ectl_proj_id from DB_T_CTRL_PROD.ECTL_BATCH_INFO where ECTL_BATCH_ID= :run_id); 

-- Component LKP_STG_MEMBXREF_TRIGGER, Type Prerequisite Lookup Object 
CREATE OR REPLACE TEMPORARY TABLE LKP_STG_MEMBXREF_TRIGGER AS
(
SELECT
TABLENAME,
FEED_DT
FROM DB_T_stag_MEMBXREF_PROD.STG_MEMBXREF_TRIGGER
);


-- PIPELINE START FOR 1

-- Component SQ_ASICPOLS, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_ASICPOLS AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as SC_POLICY_NUM,
$2 as CHG_EFF_DT,
$3 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT ASICPOLS.SC_POLICY_NUM ,ASICPOLS.CHG_EFF_DT 
FROM
 DB_T_CORE_MEMBXREF_PROD.ASICPOLS WHERE CHG_EXP_DT = CAST(''9999-12-31'' AS DATE )  
) SRC
)
);


-- Component exp_ASSIGN_DUMMY_TG, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_ASSIGN_DUMMY_TG AS
(
SELECT
SQ_ASICPOLS.SC_POLICY_NUM as SC_POLICY_NUM,
SQ_ASICPOLS.CHG_EFF_DT as CHG_EFF_DT,
''ASICPOLS'' as var_TABLENAME,
LKP_1.FEED_DT /* replaced lookup LKP_STG_MEMBXREF_TRIGGER */ as var_FEED_DT,
var_FEED_DT as out_FEED_DT,
SQ_ASICPOLS.source_record_id,
row_number() over (partition by SQ_ASICPOLS.source_record_id order by SQ_ASICPOLS.source_record_id) as RNK
FROM
SQ_ASICPOLS
LEFT JOIN LKP_STG_MEMBXREF_TRIGGER LKP_1 ON LKP_1.TABLENAME = var_TABLENAME
QUALIFY RNK = 1
);


-- Component LKP_STG_ASICPOLS, Type LOOKUP 
CREATE OR REPLACE TEMPORARY TABLE LKP_STG_ASICPOLS AS
(
SELECT
LKP.SC_POLICY_NUM,
exp_ASSIGN_DUMMY_TG.source_record_id,
ROW_NUMBER() OVER(PARTITION BY exp_ASSIGN_DUMMY_TG.source_record_id ORDER BY LKP.SC_POLICY_NUM asc) RNK
FROM
exp_ASSIGN_DUMMY_TG
LEFT JOIN (
SELECT LTRIM(RTRIM(STG_ASICPOLS.SC_POLICY_NUM)) as SC_POLICY_NUM FROM DB_T_STAG_MEMBXREF_PROD.STG_ASICPOLS WHERE
 STG_ASICPOLS. LOAD_DT=(SELECT FEED_DT FROM DB_T_STAG_MEMBXREF_PROD.STG_MEMBXREF_TRIGGER WHERE TABLENAME=''ASICPOLS'')
) LKP ON LKP.SC_POLICY_NUM = exp_ASSIGN_DUMMY_TG.SC_POLICY_NUM
QUALIFY RNK = 1
);


-- Component fil_EXPIRED_POLS, Type FILTER 
CREATE OR REPLACE TEMPORARY TABLE fil_EXPIRED_POLS AS
(
SELECT
LKP_STG_ASICPOLS.SC_POLICY_NUM as SC_POLICY_NUM_tgt,
exp_ASSIGN_DUMMY_TG.CHG_EFF_DT as CHG_EFF_DT,
exp_ASSIGN_DUMMY_TG.SC_POLICY_NUM as SC_POLICY_NUM_src,
exp_ASSIGN_DUMMY_TG.out_FEED_DT as LOAD_DT,
exp_ASSIGN_DUMMY_TG.source_record_id
FROM
exp_ASSIGN_DUMMY_TG
LEFT JOIN LKP_STG_ASICPOLS ON exp_ASSIGN_DUMMY_TG.source_record_id = LKP_STG_ASICPOLS.source_record_id
WHERE LKP_STG_ASICPOLS.SC_POLICY_NUM IS NULL
);


-- Component exp_INPUT_ECTL_FIELDS, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_INPUT_ECTL_FIELDS AS
(
SELECT
:BATCH_ACTIVE_IND IN_BATCH_ACTIVE_IND,
:PROJ_ID IN_ACT_PROJ_ID,
null IN_PRGM_NM,
null IN_TABLE_NM,
fil_EXPIRED_POLS.CHG_EFF_DT as CHG_EFF_DT,
fil_EXPIRED_POLS.SC_POLICY_NUM_src as SC_POLICY_NUM_src,
LTRIM ( RTRIM ( :PMMappingName ) ) as out_PROJ_NAME,
:PROJ_ID as out_PROJ_ID,
:BATCH_ACTIVE_IND as out_BATCH_ACTIVE_IND,
''UPD'' as ECTL_TX_CD,
TO_CHAR ( ( DATE_PART(''YYYY'', TO_TIMESTAMP(fil_EXPIRED_POLS.LOAD_DT)) * 10000 ) + ( DATE_PART(''MM'', TO_TIMESTAMP(fil_EXPIRED_POLS.LOAD_DT)) * 100 ) + 1 ) as var_FIRST_DAY_EFF_DT,
 TO_DATE ( var_FIRST_DAY_EFF_DT  )  - 1  as var_CHG_EXP_DT_NEW,
CASE WHEN fil_EXPIRED_POLS.CHG_EFF_DT >= var_CHG_EXP_DT_NEW THEN fil_EXPIRED_POLS.CHG_EFF_DT ELSE var_CHG_EXP_DT_NEW END as out_CHG_EXP_DT_NEW,
CURRENT_TIMESTAMP as out_ECTL_END_DATE,
fil_EXPIRED_POLS.source_record_id
FROM
fil_EXPIRED_POLS
);


-- Component mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE1, Type MAPPLET 
--MAPPLET NOT REGISTERED: mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE, mapplet instance mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE1;
call mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE(''exp_INPUT_ECTL_FIELDS'');


-- Component upd_ASICPOLS_EXPIRED_POLS, Type UPDATE 
CREATE OR REPLACE TEMPORARY TABLE upd_ASICPOLS_EXPIRED_POLS AS
(
/* UPDATE_STRATEGY_ACTION = 0 FOR INSERT / UPDATE_STRATEGY_ACTION = 1 FOR UPDATE / UPDATE_STRATEGY_ACTION = 2 FOR DELETE / UPDATE_STRATEGY_ACTION = 3 FOR REJECT */
SELECT
--''1'' as ECTL_BATCH_ID,
--''1900-01-01'' as ECTL_MODIFY_TS,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE1.out_ECTL_BATCH_ID as ECTL_BATCH_ID,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE1.out_ORIG_INS_TS as ECTL_MODIFY_TS,
exp_INPUT_ECTL_FIELDS.out_ECTL_END_DATE as ECTL_END_DATE,
exp_INPUT_ECTL_FIELDS.SC_POLICY_NUM_src as SC_POLICY_NUM,
exp_INPUT_ECTL_FIELDS.CHG_EFF_DT as CHG_EFF_DT,
exp_INPUT_ECTL_FIELDS.ECTL_TX_CD as ECTL_TX_CD,
exp_INPUT_ECTL_FIELDS.out_CHG_EXP_DT_NEW as CHG_EXP_DT,
1 as UPDATE_STRATEGY_ACTION
FROM
exp_INPUT_ECTL_FIELDS
LEFT JOIN mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE1 ON exp_INPUT_ECTL_FIELDS.source_record_id = mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE1.source_record_id
);


-- Component ASICPOLS_UPD_EXPIRED_POLS, Type TARGET 
INSERT INTO DB_T_CORE_MEMBXREF_PROD.ASICPOLS
(
SC_POLICY_NUM,
CHG_EFF_DT,
CHG_EXP_DT,
ECTL_BATCH_ID,
ECTL_MODIFY_TS,
ECTL_TX_CD,
ECTL_END_DATE
)
SELECT
upd_ASICPOLS_EXPIRED_POLS.SC_POLICY_NUM as SC_POLICY_NUM,
upd_ASICPOLS_EXPIRED_POLS.CHG_EFF_DT as CHG_EFF_DT,
upd_ASICPOLS_EXPIRED_POLS.CHG_EXP_DT as CHG_EXP_DT,
upd_ASICPOLS_EXPIRED_POLS.ECTL_BATCH_ID as ECTL_BATCH_ID,
upd_ASICPOLS_EXPIRED_POLS.ECTL_MODIFY_TS as ECTL_MODIFY_TS,
upd_ASICPOLS_EXPIRED_POLS.ECTL_TX_CD as ECTL_TX_CD,
upd_ASICPOLS_EXPIRED_POLS.ECTL_END_DATE as ECTL_END_DATE
FROM
upd_ASICPOLS_EXPIRED_POLS
WHERE UPDATE_STRATEGY_ACTION = 0;

/* Perform Updates */
MERGE INTO DB_T_CORE_MEMBXREF_PROD.ASICPOLS
USING upd_ASICPOLS_EXPIRED_POLS ON (UPDATE_STRATEGY_ACTION = 1 )
WHEN MATCHED THEN UPDATE
SET
SC_POLICY_NUM = upd_ASICPOLS_EXPIRED_POLS.SC_POLICY_NUM,
CHG_EFF_DT = upd_ASICPOLS_EXPIRED_POLS.CHG_EFF_DT,
CHG_EXP_DT = upd_ASICPOLS_EXPIRED_POLS.CHG_EXP_DT,
ECTL_BATCH_ID = upd_ASICPOLS_EXPIRED_POLS.ECTL_BATCH_ID,
ECTL_MODIFY_TS = upd_ASICPOLS_EXPIRED_POLS.ECTL_MODIFY_TS,
ECTL_TX_CD = upd_ASICPOLS_EXPIRED_POLS.ECTL_TX_CD,
ECTL_END_DATE = upd_ASICPOLS_EXPIRED_POLS.ECTL_END_DATE
;


-- PIPELINE END FOR 1

-- PIPELINE START FOR 2

-- Component SQ_STG_ASICPOLS, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_STG_ASICPOLS AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as SC_SERVICE_CENTER,
$2 as SC_POLICY_NUM,
$3 as PC_ALPHA_CODE,
$4 as PC_EFF_DATE,
$5 as PC_EXP_DATE,
$6 as PC_NAME_1,
$7 as PC_NAME_2,
$8 as PC_ADDRESS_1,
$9 as PC_ADDRESS_2,
$10 as PC_CITYST,
$11 as PC_ZIP,
$12 as PC_ZIP_EXT,
$13 as PC_TAX_CODE,
$14 as PC_AGENT,
$15 as PC_MEMBER_NUMBER,
$16 as PC_ENCUMBRANCE,
$17 as PC_COMPANY,
$18 as PC_STATUS,
$19 as PC_SSNO_1,
$20 as PC_SSNO_2,
$21 as PC_STATE,
$22 as PC_ALPHA_2,
$23 as LOAD_DT,
$24 as FEED_IND,
$25 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT STG_ASICPOLS.SC_SERVICE_CENTER, 
LTRIM(RTRIM(STG_ASICPOLS.SC_POLICY_NUM)), 
LTRIM(RTRIM(STG_ASICPOLS.PC_ALPHA_CODE)), 
STG_ASICPOLS.PC_EFF_DATE, 
STG_ASICPOLS.PC_EXP_DATE, 
LTRIM(RTRIM(STG_ASICPOLS.PC_NAME_1)), 
LTRIM(RTRIM(STG_ASICPOLS.PC_NAME_2)), 
LTRIM(RTRIM(STG_ASICPOLS.PC_ADDRESS_1)), 
LTRIM(RTRIM(STG_ASICPOLS.PC_ADDRESS_2)), 
LTRIM(RTRIM(STG_ASICPOLS.PC_CITYST)), 
LTRIM(RTRIM(STG_ASICPOLS.PC_ZIP)), 
LTRIM(RTRIM(STG_ASICPOLS.PC_ZIP_EXT)), 
LTRIM(RTRIM(STG_ASICPOLS.PC_TAX_CODE)), 
STG_ASICPOLS.PC_AGENT, 
LTRIM(RTRIM(STG_ASICPOLS.PC_MEMBER_NUMBER)), 
LTRIM(RTRIM(STG_ASICPOLS.PC_ENCUMBRANCE)), 
LTRIM(RTRIM(STG_ASICPOLS.PC_COMPANY)), 
LTRIM(RTRIM(STG_ASICPOLS.PC_STATUS)), 
LTRIM(RTRIM(STG_ASICPOLS.PC_SSNO_1)), 
LTRIM(RTRIM(STG_ASICPOLS.PC_SSNO_2)), 
LTRIM(RTRIM(STG_ASICPOLS.PC_STATE)), 
LTRIM(RTRIM(STG_ASICPOLS.PC_ALPHA_2)), 
STG_ASICPOLS.LOAD_DT, 
STG_ASICPOLS.FEED_IND 
FROM
 DB_T_STAG_MEMBXREF_PROD.STG_ASICPOLS 
WHERE
 STG_ASICPOLS. LOAD_DT=(SELECT FEED_DT FROM DB_T_STAG_MEMBXREF_PROD.STG_MEMBXREF_TRIGGER WHERE TABLENAME=''ASICPOLS'')
) SRC
)
);


-- Component exp_HOLD_DATA, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_HOLD_DATA AS
(
SELECT
SQ_STG_ASICPOLS.SC_SERVICE_CENTER as SC_SERVICE_CENTER,
SQ_STG_ASICPOLS.SC_POLICY_NUM as SC_POLICY_NUM,
SQ_STG_ASICPOLS.PC_ALPHA_CODE as PC_ALPHA_CODE,
SQ_STG_ASICPOLS.PC_EFF_DATE as PC_EFF_DATE,
SQ_STG_ASICPOLS.PC_EXP_DATE as PC_EXP_DATE,
SQ_STG_ASICPOLS.PC_NAME_1 as PC_NAME_1,
SQ_STG_ASICPOLS.PC_NAME_2 as PC_NAME_2,
SQ_STG_ASICPOLS.PC_ADDRESS_1 as PC_ADDRESS_1,
SQ_STG_ASICPOLS.PC_ADDRESS_2 as PC_ADDRESS_2,
SQ_STG_ASICPOLS.PC_CITYST as PC_CITYST,
SQ_STG_ASICPOLS.PC_ZIP as PC_ZIP,
SQ_STG_ASICPOLS.PC_ZIP_EXT as PC_ZIP_EXT,
SQ_STG_ASICPOLS.PC_TAX_CODE as PC_TAX_CODE,
SQ_STG_ASICPOLS.PC_AGENT as PC_AGENT,
SQ_STG_ASICPOLS.PC_MEMBER_NUMBER as PC_MEMBER_NUMBER,
SQ_STG_ASICPOLS.PC_ENCUMBRANCE as PC_ENCUMBRANCE,
SQ_STG_ASICPOLS.PC_COMPANY as PC_COMPANY,
SQ_STG_ASICPOLS.PC_STATUS as PC_STATUS,
SQ_STG_ASICPOLS.PC_SSNO_1 as PC_SSNO_1,
SQ_STG_ASICPOLS.PC_SSNO_2 as PC_SSNO_2,
SQ_STG_ASICPOLS.PC_STATE as PC_STATE,
SQ_STG_ASICPOLS.PC_ALPHA_2 as PC_ALPHA_2,
SQ_STG_ASICPOLS.LOAD_DT as LOAD_DT,
SQ_STG_ASICPOLS.FEED_IND as FEED_IND,
SQ_STG_ASICPOLS.source_record_id
FROM
SQ_STG_ASICPOLS
);


-- Component LKP_ASICPOLS, Type LOOKUP 
CREATE OR REPLACE TEMPORARY TABLE LKP_ASICPOLS AS
(
SELECT
LKP.SC_SERVICE_CENTER,
LKP.SC_POLICY_NUM,
LKP.CHG_EFF_DT,
LKP.PC_ALPHA_CODE,
LKP.PC_EFF_DATE,
LKP.PC_EXP_DATE,
LKP.PC_NAME_1,
LKP.PC_NAME_2,
LKP.PC_ADDRESS_1,
LKP.PC_ADDRESS_2,
LKP.PC_CITYST,
LKP.PC_ZIP,
LKP.PC_ZIP_EXT,
LKP.PC_TAX_CODE,
LKP.PC_AGENT,
LKP.PC_MEMBER_NUMBER,
LKP.PC_ENCUMBRANCE,
LKP.PC_COMPANY,
LKP.PC_STATUS,
LKP.PC_SSNO_1,
LKP.PC_SSNO_2,
LKP.PC_STATE,
LKP.PC_ALPHA_2,
LKP.FEED_IND,
exp_HOLD_DATA.source_record_id,
ROW_NUMBER() OVER(PARTITION BY exp_HOLD_DATA.source_record_id ORDER BY LKP.SC_SERVICE_CENTER asc,LKP.SC_POLICY_NUM asc,LKP.CHG_EFF_DT asc,LKP.CHG_EXP_DT asc,LKP.PC_ALPHA_CODE asc,LKP.PC_EFF_DATE asc,LKP.PC_EXP_DATE asc,LKP.PC_NAME_1 asc,LKP.PC_NAME_2 asc,LKP.PC_ADDRESS_1 asc,LKP.PC_ADDRESS_2 asc,LKP.PC_CITYST asc,LKP.PC_ZIP asc,LKP.PC_ZIP_EXT asc,LKP.PC_TAX_CODE asc,LKP.PC_AGENT asc,LKP.PC_MEMBER_NUMBER asc,LKP.PC_ENCUMBRANCE asc,LKP.PC_COMPANY asc,LKP.PC_STATUS asc,LKP.PC_SSNO_1 asc,LKP.PC_SSNO_2 asc,LKP.PC_STATE asc,LKP.PC_ALPHA_2 asc,LKP.FEED_IND asc) RNK
FROM
exp_HOLD_DATA
LEFT JOIN (
SELECT ASICPOLS.SC_SERVICE_CENTER as SC_SERVICE_CENTER, ASICPOLS.SC_POLICY_NUM as SC_POLICY_NUM, ASICPOLS.CHG_EFF_DT as CHG_EFF_DT, ASICPOLS.CHG_EXP_DT as CHG_EXP_DT, ASICPOLS.PC_ALPHA_CODE as PC_ALPHA_CODE, ASICPOLS.PC_EFF_DATE as PC_EFF_DATE, ASICPOLS.PC_EXP_DATE as PC_EXP_DATE, ASICPOLS.PC_NAME_1 as PC_NAME_1, ASICPOLS.PC_NAME_2 as PC_NAME_2, ASICPOLS.PC_ADDRESS_1 as PC_ADDRESS_1, ASICPOLS.PC_ADDRESS_2 as PC_ADDRESS_2, ASICPOLS.PC_CITYST as PC_CITYST, ASICPOLS.PC_ZIP as PC_ZIP, ASICPOLS.PC_ZIP_EXT as PC_ZIP_EXT, ASICPOLS.PC_TAX_CODE as PC_TAX_CODE, ASICPOLS.PC_AGENT as PC_AGENT, ASICPOLS.PC_MEMBER_NUMBER as PC_MEMBER_NUMBER, ASICPOLS.PC_ENCUMBRANCE as PC_ENCUMBRANCE, ASICPOLS.PC_COMPANY as PC_COMPANY, ASICPOLS.PC_STATUS as PC_STATUS, ASICPOLS.PC_SSNO_1 as PC_SSNO_1, ASICPOLS.PC_SSNO_2 as PC_SSNO_2, ASICPOLS.PC_STATE as PC_STATE, ASICPOLS.PC_ALPHA_2 as PC_ALPHA_2, ASICPOLS.FEED_IND as FEED_IND FROM DB_T_core_MEMBXREF_PROD.ASICPOLS where ECTL_TX_CD=''NEW''
) LKP ON LKP.SC_POLICY_NUM = exp_HOLD_DATA.SC_POLICY_NUM
QUALIFY RNK = 1
);


-- Component exp_DERIVE_FLAG, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_DERIVE_FLAG AS
(
SELECT
LKP_ASICPOLS.SC_POLICY_NUM as SC_POLICY_NUM_LKP,
LKP_ASICPOLS.CHG_EFF_DT as CHG_EFF_DT_LKP,
exp_HOLD_DATA.SC_SERVICE_CENTER as SC_SERVICE_CENTER_SRC,
exp_HOLD_DATA.SC_POLICY_NUM as SC_POLICY_NUM_SRC,
exp_HOLD_DATA.PC_ALPHA_CODE as PC_ALPHA_CODE_SRC,
exp_HOLD_DATA.PC_EFF_DATE as PC_EFF_DATE_SRC,
exp_HOLD_DATA.PC_EXP_DATE as PC_EXP_DATE_SRC,
exp_HOLD_DATA.PC_NAME_1 as PC_NAME_1_SRC,
exp_HOLD_DATA.PC_NAME_2 as PC_NAME_2_SRC,
exp_HOLD_DATA.PC_ADDRESS_1 as PC_ADDRESS_1_SRC,
exp_HOLD_DATA.PC_ADDRESS_2 as PC_ADDRESS_2_SRC,
exp_HOLD_DATA.PC_CITYST as PC_CITYST_SRC,
exp_HOLD_DATA.PC_ZIP as PC_ZIP_SRC,
exp_HOLD_DATA.PC_ZIP_EXT as PC_ZIP_EXT_SRC,
exp_HOLD_DATA.PC_TAX_CODE as PC_TAX_CODE_SRC,
exp_HOLD_DATA.PC_AGENT as PC_AGENT_SRC,
exp_HOLD_DATA.PC_MEMBER_NUMBER as PC_MEMBER_NUMBER_SRC,
exp_HOLD_DATA.PC_ENCUMBRANCE as PC_ENCUMBRANCE_SRC,
exp_HOLD_DATA.PC_COMPANY as PC_COMPANY_SRC,
exp_HOLD_DATA.PC_STATUS as PC_STATUS_SRC,
exp_HOLD_DATA.PC_SSNO_1 as PC_SSNO_1_SRC,
exp_HOLD_DATA.PC_SSNO_2 as PC_SSNO_2_SRC,
exp_HOLD_DATA.PC_STATE as PC_STATE_SRC,
exp_HOLD_DATA.PC_ALPHA_2 as PC_ALPHA_2_SRC,
exp_HOLD_DATA.LOAD_DT as LOAD_DT_SRC,
exp_HOLD_DATA.FEED_IND as FEED_IND_SRC,
LTRIM ( RTRIM ( :PMMappingName ) ) as out_PROJ_NAME,
:PROJ_ID as out_PROJ_ID,
:BATCH_ACTIVE_IND as out_BATCH_ACTIVE_IND,
''NEW'' as ECTL_TX_CD,
CASE WHEN LKP_ASICPOLS.SC_POLICY_NUM IS NULL THEN ''NEW'' ELSE CASE WHEN CASE WHEN LKP_ASICPOLS.SC_SERVICE_CENTER IS NULL THEN 0 ELSE LKP_ASICPOLS.SC_SERVICE_CENTER END <> CASE WHEN exp_HOLD_DATA.SC_SERVICE_CENTER IS NULL THEN 0 ELSE exp_HOLD_DATA.SC_SERVICE_CENTER END OR CASE WHEN LKP_ASICPOLS.PC_ALPHA_CODE IS NULL THEN ''~'' ELSE LKP_ASICPOLS.PC_ALPHA_CODE END <> CASE WHEN exp_HOLD_DATA.PC_ALPHA_CODE IS NULL THEN ''~'' ELSE exp_HOLD_DATA.PC_ALPHA_CODE END OR CASE WHEN LKP_ASICPOLS.PC_EFF_DATE IS NULL THEN TO_DATE ( ''01/01/0001'' , ''MM/DD/YYYY'' ) ELSE LKP_ASICPOLS.PC_EFF_DATE END <> CASE WHEN exp_HOLD_DATA.PC_EFF_DATE IS NULL THEN TO_DATE ( ''01/01/0001'' , ''MM/DD/YYYY'' ) ELSE exp_HOLD_DATA.PC_EFF_DATE END OR CASE WHEN LKP_ASICPOLS.PC_EXP_DATE IS NULL THEN TO_DATE ( ''01/01/0001'' , ''MM/DD/YYYY'' ) ELSE LKP_ASICPOLS.PC_EXP_DATE END <> CASE WHEN exp_HOLD_DATA.PC_EXP_DATE IS NULL THEN TO_DATE ( ''01/01/0001'' , ''MM/DD/YYYY'' ) ELSE exp_HOLD_DATA.PC_EXP_DATE END OR CASE WHEN LKP_ASICPOLS.PC_NAME_1 IS NULL THEN ''~'' ELSE LKP_ASICPOLS.PC_NAME_1 END <> CASE WHEN exp_HOLD_DATA.PC_NAME_1 IS NULL THEN ''~'' ELSE exp_HOLD_DATA.PC_NAME_1 END OR CASE WHEN LKP_ASICPOLS.PC_NAME_2 IS NULL THEN ''~'' ELSE LKP_ASICPOLS.PC_NAME_2 END <> CASE WHEN exp_HOLD_DATA.PC_NAME_2 IS NULL THEN ''~'' ELSE exp_HOLD_DATA.PC_NAME_2 END OR CASE WHEN LKP_ASICPOLS.PC_ADDRESS_1 IS NULL THEN ''~'' ELSE LKP_ASICPOLS.PC_ADDRESS_1 END <> CASE WHEN exp_HOLD_DATA.PC_ADDRESS_1 IS NULL THEN ''~'' ELSE exp_HOLD_DATA.PC_ADDRESS_1 END OR CASE WHEN LKP_ASICPOLS.PC_ADDRESS_2 IS NULL THEN ''~'' ELSE LKP_ASICPOLS.PC_ADDRESS_2 END <> CASE WHEN exp_HOLD_DATA.PC_ADDRESS_2 IS NULL THEN ''~'' ELSE exp_HOLD_DATA.PC_ADDRESS_2 END OR CASE WHEN LKP_ASICPOLS.PC_CITYST IS NULL THEN ''~'' ELSE LKP_ASICPOLS.PC_CITYST END <> CASE WHEN exp_HOLD_DATA.PC_CITYST IS NULL THEN ''~'' ELSE exp_HOLD_DATA.PC_CITYST END OR CASE WHEN LKP_ASICPOLS.PC_ZIP IS NULL THEN ''~'' ELSE LKP_ASICPOLS.PC_ZIP END <> CASE WHEN exp_HOLD_DATA.PC_ZIP IS NULL THEN ''~'' ELSE exp_HOLD_DATA.PC_ZIP END OR CASE WHEN LKP_ASICPOLS.PC_ZIP_EXT IS NULL THEN ''~'' ELSE LKP_ASICPOLS.PC_ZIP_EXT END <> CASE WHEN exp_HOLD_DATA.PC_ZIP_EXT IS NULL THEN ''~'' ELSE exp_HOLD_DATA.PC_ZIP_EXT END OR CASE WHEN LKP_ASICPOLS.PC_TAX_CODE IS NULL THEN ''~'' ELSE LKP_ASICPOLS.PC_TAX_CODE END <> CASE WHEN exp_HOLD_DATA.PC_TAX_CODE IS NULL THEN ''~'' ELSE exp_HOLD_DATA.PC_TAX_CODE END OR CASE WHEN LKP_ASICPOLS.PC_AGENT IS NULL THEN 0 ELSE LKP_ASICPOLS.PC_AGENT END <> CASE WHEN exp_HOLD_DATA.PC_AGENT IS NULL THEN 0 ELSE exp_HOLD_DATA.PC_AGENT END OR CASE WHEN LKP_ASICPOLS.PC_MEMBER_NUMBER IS NULL THEN ''~'' ELSE LKP_ASICPOLS.PC_MEMBER_NUMBER END <> CASE WHEN exp_HOLD_DATA.PC_MEMBER_NUMBER IS NULL THEN ''~'' ELSE exp_HOLD_DATA.PC_MEMBER_NUMBER END OR CASE WHEN LKP_ASICPOLS.PC_ENCUMBRANCE IS NULL THEN ''~'' ELSE LKP_ASICPOLS.PC_ENCUMBRANCE END <> CASE WHEN exp_HOLD_DATA.PC_ENCUMBRANCE IS NULL THEN ''~'' ELSE exp_HOLD_DATA.PC_ENCUMBRANCE END OR CASE WHEN LKP_ASICPOLS.PC_COMPANY IS NULL THEN ''~'' ELSE LKP_ASICPOLS.PC_COMPANY END <> CASE WHEN exp_HOLD_DATA.PC_COMPANY IS NULL THEN ''~'' ELSE exp_HOLD_DATA.PC_COMPANY END OR CASE WHEN LKP_ASICPOLS.PC_STATUS IS NULL THEN ''~'' ELSE LKP_ASICPOLS.PC_STATUS END <> CASE WHEN exp_HOLD_DATA.PC_STATUS IS NULL THEN ''~'' ELSE exp_HOLD_DATA.PC_STATUS END OR CASE WHEN LKP_ASICPOLS.PC_SSNO_1 IS NULL THEN ''~'' ELSE LKP_ASICPOLS.PC_SSNO_1 END <> CASE WHEN exp_HOLD_DATA.PC_SSNO_1 IS NULL THEN ''~'' ELSE exp_HOLD_DATA.PC_SSNO_1 END OR CASE WHEN LKP_ASICPOLS.PC_SSNO_2 IS NULL THEN ''~'' ELSE LKP_ASICPOLS.PC_SSNO_2 END <> CASE WHEN exp_HOLD_DATA.PC_SSNO_2 IS NULL THEN ''~'' ELSE exp_HOLD_DATA.PC_SSNO_2 END OR CASE WHEN LKP_ASICPOLS.PC_STATE IS NULL THEN ''~'' ELSE LKP_ASICPOLS.PC_STATE END <> CASE WHEN exp_HOLD_DATA.PC_STATE IS NULL THEN ''~'' ELSE exp_HOLD_DATA.PC_STATE END OR CASE WHEN LKP_ASICPOLS.PC_ALPHA_2 IS NULL THEN ''~'' ELSE LKP_ASICPOLS.PC_ALPHA_2 END <> CASE WHEN exp_HOLD_DATA.PC_ALPHA_2 IS NULL THEN ''~'' ELSE exp_HOLD_DATA.PC_ALPHA_2 END THEN ''UPD'' ELSE ''REJ'' END END as out_CHK,
exp_HOLD_DATA.source_record_id
FROM
exp_HOLD_DATA
INNER JOIN LKP_ASICPOLS ON exp_HOLD_DATA.source_record_id = LKP_ASICPOLS.source_record_id
);


-- Component mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE, Type MAPPLET 
--MAPPLET NOT REGISTERED: mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE, mapplet instance mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE;


-- Component rtr_INS_UPD_INSERT, Type ROUTER Output Group INSERT
create or replace temp table RTR_INS_UPD_insert as
SELECT
exp_DERIVE_FLAG.SC_SERVICE_CENTER_SRC as SC_SERVICE_CENTER_SRC,
exp_DERIVE_FLAG.SC_POLICY_NUM_SRC as out_SC_POLICY_NUM_SRC,
exp_DERIVE_FLAG.PC_ALPHA_CODE_SRC as out_PC_ALPHA_CODE_SRC,
exp_DERIVE_FLAG.PC_EFF_DATE_SRC as PC_EFF_DATE_SRC,
exp_DERIVE_FLAG.PC_EXP_DATE_SRC as PC_EXP_DATE_SRC,
exp_DERIVE_FLAG.PC_NAME_1_SRC as out_PC_NAME_1_SRC,
exp_DERIVE_FLAG.PC_NAME_2_SRC as out_PC_NAME_2_SRC,
exp_DERIVE_FLAG.PC_ADDRESS_1_SRC as out_PC_ADDRESS_1_SRC,
exp_DERIVE_FLAG.PC_ADDRESS_2_SRC as out_PC_ADDRESS_2_SRC,
exp_DERIVE_FLAG.PC_CITYST_SRC as out_PC_CITYST_SRC,
exp_DERIVE_FLAG.PC_ZIP_SRC as out_PC_ZIP_SRC,
exp_DERIVE_FLAG.PC_ZIP_EXT_SRC as out_PC_ZIP_EXT_SRC,
exp_DERIVE_FLAG.PC_TAX_CODE_SRC as out_PC_TAX_CODE_SRC,
exp_DERIVE_FLAG.PC_AGENT_SRC as PC_AGENT_SRC,
exp_DERIVE_FLAG.PC_MEMBER_NUMBER_SRC as out_PC_MEMBER_NUMBER_SRC,
exp_DERIVE_FLAG.PC_ENCUMBRANCE_SRC as out_PC_ENCUMBRANCE_SRC,
exp_DERIVE_FLAG.PC_COMPANY_SRC as out_PC_COMPANY_SRC,
exp_DERIVE_FLAG.PC_STATUS_SRC as out_PC_STATUS_SRC,
exp_DERIVE_FLAG.PC_SSNO_1_SRC as out_PC_SSNO_1_SRC,
exp_DERIVE_FLAG.PC_SSNO_2_SRC as out_PC_SSNO_2_SRC,
exp_DERIVE_FLAG.PC_STATE_SRC as out_PC_STATE_SRC,
exp_DERIVE_FLAG.PC_ALPHA_2_SRC as out_PC_ALPHA_2_SRC,
exp_DERIVE_FLAG.LOAD_DT_SRC as LOAD_DT_SRC,
exp_DERIVE_FLAG.FEED_IND_SRC as FEED_IND_SRC,
--''1'' as ECTL_BATCH_ID_SRC,
--''1900-01-01'' as ECTL_ORIG_INS_TS_SRC,
--''1900-01-01'' as ECTL_MODIFY_TS_SRC,
--''1'' as ECTL_SRC_ID_SRC,
--''1'' as ECTL_SRC_INST_ID_SRC,
--''1'' as ECTL_PRGM_ID_SRC,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_BATCH_ID as ECTL_BATCH_ID_SRC,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ORIG_INS_TS as ECTL_ORIG_INS_TS_SRC,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ORIG_INS_TS as ECTL_MODIFY_TS_SRC,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_SRC_ID as ECTL_SRC_ID_SRC,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_SRC_INST_ID as ECTL_SRC_INST_ID_SRC,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_PRGM_ID as ECTL_PRGM_ID_SRC,
exp_DERIVE_FLAG.ECTL_TX_CD as ECTL_TX_CD_SRC,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_BATCH_START_DATE as ECTL_START_DATE_SRC,
--''1900-01-01'' as ECTL_START_DATE_SRC,
exp_DERIVE_FLAG.out_CHK as out_CHK,
exp_DERIVE_FLAG.SC_POLICY_NUM_LKP as SC_POLICY_NUM_LKP,
exp_DERIVE_FLAG.CHG_EFF_DT_LKP as CHG_EFF_DT_LKP,
exp_DERIVE_FLAG.source_record_id
FROM
exp_DERIVE_FLAG
LEFT JOIN mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE ON exp_DERIVE_FLAG.source_record_id = mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.source_record_id
WHERE exp_DERIVE_FLAG.out_CHK = ''NEW'' OR exp_DERIVE_FLAG.out_CHK = ''UPD'';


-- Component rtr_INS_UPD_UPDATE, Type ROUTER Output Group UPDATE
create or replace temp table RTR_INS_UPD_UPDATE as
SELECT
exp_DERIVE_FLAG.SC_SERVICE_CENTER_SRC as SC_SERVICE_CENTER_SRC,
exp_DERIVE_FLAG.SC_POLICY_NUM_SRC as out_SC_POLICY_NUM_SRC,
exp_DERIVE_FLAG.PC_ALPHA_CODE_SRC as out_PC_ALPHA_CODE_SRC,
exp_DERIVE_FLAG.PC_EFF_DATE_SRC as PC_EFF_DATE_SRC,
exp_DERIVE_FLAG.PC_EXP_DATE_SRC as PC_EXP_DATE_SRC,
exp_DERIVE_FLAG.PC_NAME_1_SRC as out_PC_NAME_1_SRC,
exp_DERIVE_FLAG.PC_NAME_2_SRC as out_PC_NAME_2_SRC,
exp_DERIVE_FLAG.PC_ADDRESS_1_SRC as out_PC_ADDRESS_1_SRC,
exp_DERIVE_FLAG.PC_ADDRESS_2_SRC as out_PC_ADDRESS_2_SRC,
exp_DERIVE_FLAG.PC_CITYST_SRC as out_PC_CITYST_SRC,
exp_DERIVE_FLAG.PC_ZIP_SRC as out_PC_ZIP_SRC,
exp_DERIVE_FLAG.PC_ZIP_EXT_SRC as out_PC_ZIP_EXT_SRC,
exp_DERIVE_FLAG.PC_TAX_CODE_SRC as out_PC_TAX_CODE_SRC,
exp_DERIVE_FLAG.PC_AGENT_SRC as PC_AGENT_SRC,
exp_DERIVE_FLAG.PC_MEMBER_NUMBER_SRC as out_PC_MEMBER_NUMBER_SRC,
exp_DERIVE_FLAG.PC_ENCUMBRANCE_SRC as out_PC_ENCUMBRANCE_SRC,
exp_DERIVE_FLAG.PC_COMPANY_SRC as out_PC_COMPANY_SRC,
exp_DERIVE_FLAG.PC_STATUS_SRC as out_PC_STATUS_SRC,
exp_DERIVE_FLAG.PC_SSNO_1_SRC as out_PC_SSNO_1_SRC,
exp_DERIVE_FLAG.PC_SSNO_2_SRC as out_PC_SSNO_2_SRC,
exp_DERIVE_FLAG.PC_STATE_SRC as out_PC_STATE_SRC,
exp_DERIVE_FLAG.PC_ALPHA_2_SRC as out_PC_ALPHA_2_SRC,
exp_DERIVE_FLAG.LOAD_DT_SRC as LOAD_DT_SRC,
exp_DERIVE_FLAG.FEED_IND_SRC as FEED_IND_SRC,
--mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_BATCH_ID as ECTL_BATCH_ID_SRC,
--mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ORIG_INS_TS as ECTL_ORIG_INS_TS_SRC,
--mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ORIG_INS_TS as ECTL_MODIFY_TS_SRC,
--mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_SRC_ID as ECTL_SRC_ID_SRC,
--mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_SRC_INST_ID as ECTL_SRC_INST_ID_SRC,
--mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_PRGM_ID as ECTL_PRGM_ID_SRC,
''1'' as ECTL_BATCH_ID_SRC,
''1900-01-01'' as ECTL_ORIG_INS_TS_SRC,
''1900-01-01'' as ECTL_MODIFY_TS_SRC,
''1'' as ECTL_SRC_ID_SRC,
''1'' as ECTL_SRC_INST_ID_SRC,
''1'' as ECTL_PRGM_ID_SRC,
exp_DERIVE_FLAG.ECTL_TX_CD as ECTL_TX_CD_SRC,
--mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_BATCH_START_DATE as ECTL_START_DATE_SRC,
''1900-01-01'' as ECTL_START_DATE_SRC,
exp_DERIVE_FLAG.out_CHK as out_CHK,
exp_DERIVE_FLAG.SC_POLICY_NUM_LKP as SC_POLICY_NUM_LKP,
exp_DERIVE_FLAG.CHG_EFF_DT_LKP as CHG_EFF_DT_LKP,
exp_DERIVE_FLAG.source_record_id
FROM
exp_DERIVE_FLAG
--LEFT JOIN mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE ON exp_DERIVE_FLAG.source_record_id = mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.source_record_id
WHERE exp_DERIVE_FLAG.out_CHK = ''UPD'';


-- Component exp_GET_EXP_DATE, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_GET_EXP_DATE AS
(
SELECT
rtr_INS_UPD_UPDATE.SC_POLICY_NUM_LKP as SC_POLICY_NUM_LKP3,
rtr_INS_UPD_UPDATE.CHG_EFF_DT_LKP as CHG_EFF_DT_LKP3,
TO_CHAR ( ( DATE_PART(''YYYY'', TO_TIMESTAMP(rtr_INS_UPD_UPDATE.LOAD_DT_SRC)) * 10000 ) + ( DATE_PART(''MM'', TO_TIMESTAMP(rtr_INS_UPD_UPDATE.LOAD_DT_SRC)) * 100 ) + 1 ) as var_FIRST_DAY_EFF_DT,
 TO_DATE ( var_FIRST_DAY_EFF_DT  )  - 1  as var_CHG_EXP_DT_NEW,
CASE WHEN rtr_INS_UPD_UPDATE.CHG_EFF_DT_LKP >= TO_DATE ( var_FIRST_DAY_EFF_DT , ''YYYYMMDD'' ) THEN rtr_INS_UPD_UPDATE.CHG_EFF_DT_LKP ELSE var_CHG_EXP_DT_NEW END as out_CHG_EXP_DT_NEW,
rtr_INS_UPD_UPDATE.ECTL_BATCH_ID_SRC as ECTL_BATCH_ID_SRC3,
rtr_INS_UPD_UPDATE.ECTL_ORIG_INS_TS_SRC as ECTL_ORIG_INS_TS_SRC3,
rtr_INS_UPD_UPDATE.ECTL_MODIFY_TS_SRC as ECTL_MODIFY_TS_SRC3,
CURRENT_TIMESTAMP as ECTL_END_DATE_SRC3,
rtr_INS_UPD_UPDATE.out_CHK as out_CHK3,
rtr_INS_UPD_UPDATE.source_record_id
FROM
rtr_INS_UPD_UPDATE
);


-- Component exp_GET_EFF_DATE, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_GET_EFF_DATE AS
(
SELECT
rtr_INS_UPD_INSERT.SC_SERVICE_CENTER_SRC as SC_SERVICE_CENTER,
rtr_INS_UPD_INSERT.out_SC_POLICY_NUM_SRC as SC_POLICY_NUM,
TO_CHAR ( ( DATE_PART(''YYYY'', TO_TIMESTAMP(rtr_INS_UPD_INSERT.LOAD_DT_SRC)) * 10000 ) + ( DATE_PART(''MM'', TO_TIMESTAMP(rtr_INS_UPD_INSERT.LOAD_DT_SRC)) * 100 ) + 1 ) as var_FIRST_DAY_EFF_DT,
TO_DATE ( var_FIRST_DAY_EFF_DT , ''YYYYMMDD'' ) as var_CHG_EFF_DATE,
CASE WHEN rtr_INS_UPD_INSERT.CHG_EFF_DT_LKP >= var_CHG_EFF_DATE THEN  rtr_INS_UPD_INSERT.CHG_EFF_DT_LKP + 1 ELSE var_CHG_EFF_DATE END as out_CHG_EFF_DATE,
TO_DATE ( ''9999-12-31'' , ''YYYY-MM-DD'' ) as CHG_EXP_DATE,
rtr_INS_UPD_INSERT.out_PC_ALPHA_CODE_SRC as PC_ALPHA_CODE,
rtr_INS_UPD_INSERT.PC_EFF_DATE_SRC as PC_EFF_DATE,
rtr_INS_UPD_INSERT.PC_EXP_DATE_SRC as PC_EXP_DATE,
rtr_INS_UPD_INSERT.out_PC_NAME_1_SRC as PC_NAME_1,
rtr_INS_UPD_INSERT.out_PC_NAME_2_SRC as PC_NAME_2,
rtr_INS_UPD_INSERT.out_PC_ADDRESS_1_SRC as PC_ADDRESS_1,
rtr_INS_UPD_INSERT.out_PC_ADDRESS_2_SRC as PC_ADDRESS_2,
rtr_INS_UPD_INSERT.out_PC_CITYST_SRC as PC_CITYST,
rtr_INS_UPD_INSERT.out_PC_ZIP_SRC as PC_ZIP,
rtr_INS_UPD_INSERT.out_PC_ZIP_EXT_SRC as PC_ZIP_EXT,
rtr_INS_UPD_INSERT.out_PC_TAX_CODE_SRC as PC_TAX_CODE,
rtr_INS_UPD_INSERT.PC_AGENT_SRC as PC_AGENT,
rtr_INS_UPD_INSERT.out_PC_MEMBER_NUMBER_SRC as PC_MEMBER_NUMBER,
rtr_INS_UPD_INSERT.out_PC_ENCUMBRANCE_SRC as PC_ENCUMBRANCE,
rtr_INS_UPD_INSERT.out_PC_COMPANY_SRC as PC_COMPANY,
rtr_INS_UPD_INSERT.out_PC_STATUS_SRC as PC_STATUS,
rtr_INS_UPD_INSERT.out_PC_SSNO_1_SRC as PC_SSNO_1,
rtr_INS_UPD_INSERT.out_PC_SSNO_2_SRC as PC_SSNO_2,
rtr_INS_UPD_INSERT.out_PC_STATE_SRC as PC_STATE,
rtr_INS_UPD_INSERT.out_PC_ALPHA_2_SRC as PC_ALPHA_2,
rtr_INS_UPD_INSERT.FEED_IND_SRC as FEED_IND,
rtr_INS_UPD_INSERT.ECTL_BATCH_ID_SRC as ECTL_BATCH_ID,
rtr_INS_UPD_INSERT.ECTL_ORIG_INS_TS_SRC as ECTL_ORIG_INS_TS,
rtr_INS_UPD_INSERT.ECTL_MODIFY_TS_SRC as ECTL_MODIFY_TS,
rtr_INS_UPD_INSERT.ECTL_SRC_ID_SRC as ECTL_SRC_ID,
rtr_INS_UPD_INSERT.ECTL_SRC_INST_ID_SRC as ECTL_SRC_INST_ID,
rtr_INS_UPD_INSERT.ECTL_PRGM_ID_SRC as ECTL_PRGM_ID,
rtr_INS_UPD_INSERT.ECTL_TX_CD_SRC as ECTL_TX_CD,
rtr_INS_UPD_INSERT.ECTL_START_DATE_SRC as ECTL_START_DATE,
TO_DATE ( ''9999-12-31'' , ''YYYY-MM-DD'' ) as ECTL_END_DATE,
rtr_INS_UPD_INSERT.source_record_id
FROM
rtr_INS_UPD_INSERT
);


-- Component ASICPOLS_INS, Type TARGET 
INSERT INTO DB_T_CORE_MEMBXREF_PROD.ASICPOLS
(
SC_SERVICE_CENTER,
SC_POLICY_NUM,
CHG_EFF_DT,
CHG_EXP_DT,
PC_ALPHA_CODE,
PC_EFF_DATE,
PC_EXP_DATE,
PC_NAME_1,
PC_NAME_2,
PC_ADDRESS_1,
PC_ADDRESS_2,
PC_CITYST,
PC_ZIP,
PC_ZIP_EXT,
PC_TAX_CODE,
PC_AGENT,
PC_MEMBER_NUMBER,
PC_ENCUMBRANCE,
PC_COMPANY,
PC_STATUS,
PC_SSNO_1,
PC_SSNO_2,
PC_STATE,
PC_ALPHA_2,
FEED_IND,
ECTL_BATCH_ID,
ECTL_ORIG_INS_TS,
ECTL_MODIFY_TS,
ECTL_SRC_ID,
ECTL_SRC_INST_ID,
ECTL_PRGM_ID,
ECTL_TX_CD,
ECTL_START_DATE,
ECTL_END_DATE
)
SELECT
exp_GET_EFF_DATE.SC_SERVICE_CENTER as SC_SERVICE_CENTER,
exp_GET_EFF_DATE.SC_POLICY_NUM as SC_POLICY_NUM,
exp_GET_EFF_DATE.out_CHG_EFF_DATE as CHG_EFF_DT,
exp_GET_EFF_DATE.CHG_EXP_DATE as CHG_EXP_DT,
exp_GET_EFF_DATE.PC_ALPHA_CODE as PC_ALPHA_CODE,
exp_GET_EFF_DATE.PC_EFF_DATE as PC_EFF_DATE,
exp_GET_EFF_DATE.PC_EXP_DATE as PC_EXP_DATE,
exp_GET_EFF_DATE.PC_NAME_1 as PC_NAME_1,
exp_GET_EFF_DATE.PC_NAME_2 as PC_NAME_2,
exp_GET_EFF_DATE.PC_ADDRESS_1 as PC_ADDRESS_1,
exp_GET_EFF_DATE.PC_ADDRESS_2 as PC_ADDRESS_2,
exp_GET_EFF_DATE.PC_CITYST as PC_CITYST,
exp_GET_EFF_DATE.PC_ZIP as PC_ZIP,
exp_GET_EFF_DATE.PC_ZIP_EXT as PC_ZIP_EXT,
exp_GET_EFF_DATE.PC_TAX_CODE as PC_TAX_CODE,
exp_GET_EFF_DATE.PC_AGENT as PC_AGENT,
exp_GET_EFF_DATE.PC_MEMBER_NUMBER as PC_MEMBER_NUMBER,
exp_GET_EFF_DATE.PC_ENCUMBRANCE as PC_ENCUMBRANCE,
exp_GET_EFF_DATE.PC_COMPANY as PC_COMPANY,
exp_GET_EFF_DATE.PC_STATUS as PC_STATUS,
exp_GET_EFF_DATE.PC_SSNO_1 as PC_SSNO_1,
exp_GET_EFF_DATE.PC_SSNO_2 as PC_SSNO_2,
exp_GET_EFF_DATE.PC_STATE as PC_STATE,
exp_GET_EFF_DATE.PC_ALPHA_2 as PC_ALPHA_2,
exp_GET_EFF_DATE.FEED_IND as FEED_IND,
exp_GET_EFF_DATE.ECTL_BATCH_ID as ECTL_BATCH_ID,
exp_GET_EFF_DATE.ECTL_ORIG_INS_TS as ECTL_ORIG_INS_TS,
exp_GET_EFF_DATE.ECTL_MODIFY_TS as ECTL_MODIFY_TS,
exp_GET_EFF_DATE.ECTL_SRC_ID as ECTL_SRC_ID,
exp_GET_EFF_DATE.ECTL_SRC_INST_ID as ECTL_SRC_INST_ID,
exp_GET_EFF_DATE.ECTL_PRGM_ID as ECTL_PRGM_ID,
exp_GET_EFF_DATE.ECTL_TX_CD as ECTL_TX_CD,
exp_GET_EFF_DATE.ECTL_START_DATE as ECTL_START_DATE,
exp_GET_EFF_DATE.ECTL_END_DATE as ECTL_END_DATE
FROM
exp_GET_EFF_DATE;


-- Component upd_ASICPOLS, Type UPDATE 
CREATE OR REPLACE TEMPORARY TABLE upd_ASICPOLS AS
(
/* UPDATE_STRATEGY_ACTION = 0 FOR INSERT / UPDATE_STRATEGY_ACTION = 1 FOR UPDATE / UPDATE_STRATEGY_ACTION = 2 FOR DELETE / UPDATE_STRATEGY_ACTION = 3 FOR REJECT */
SELECT
exp_GET_EXP_DATE.SC_POLICY_NUM_LKP3 as SC_POLICY_NUM_LKP3,
exp_GET_EXP_DATE.CHG_EFF_DT_LKP3 as CHG_EFF_DT_LKP3,
exp_GET_EXP_DATE.out_CHG_EXP_DT_NEW as CHG_EXP_DT_NEW,
exp_GET_EXP_DATE.ECTL_BATCH_ID_SRC3 as ECTL_BATCH_ID,
exp_GET_EXP_DATE.ECTL_ORIG_INS_TS_SRC3 as ECTL_ORIG_INS_TS,
exp_GET_EXP_DATE.ECTL_MODIFY_TS_SRC3 as ECTL_MODIFY_TS,
exp_GET_EXP_DATE.ECTL_END_DATE_SRC3 as ECTL_END_DATE,
exp_GET_EXP_DATE.out_CHK3 as out_CHK,
1 as UPDATE_STRATEGY_ACTION
FROM
exp_GET_EXP_DATE
);


-- Component ASICPOLS_UPD, Type TARGET 
INSERT INTO DB_T_CORE_MEMBXREF_PROD.ASICPOLS
(
SC_POLICY_NUM,
CHG_EFF_DT,
CHG_EXP_DT,
ECTL_BATCH_ID,
ECTL_ORIG_INS_TS,
ECTL_MODIFY_TS,
ECTL_TX_CD,
ECTL_END_DATE
)
SELECT
upd_ASICPOLS.SC_POLICY_NUM_LKP3 as SC_POLICY_NUM,
upd_ASICPOLS.CHG_EFF_DT_LKP3 as CHG_EFF_DT,
upd_ASICPOLS.CHG_EXP_DT_NEW as CHG_EXP_DT,
upd_ASICPOLS.ECTL_BATCH_ID as ECTL_BATCH_ID,
upd_ASICPOLS.ECTL_ORIG_INS_TS as ECTL_ORIG_INS_TS,
upd_ASICPOLS.ECTL_MODIFY_TS as ECTL_MODIFY_TS,
upd_ASICPOLS.out_CHK as ECTL_TX_CD,
upd_ASICPOLS.ECTL_END_DATE as ECTL_END_DATE
FROM
upd_ASICPOLS
WHERE UPDATE_STRATEGY_ACTION = 0;

/* Perform Updates */
MERGE INTO DB_T_CORE_MEMBXREF_PROD.ASICPOLS
USING upd_ASICPOLS ON (UPDATE_STRATEGY_ACTION = 1  )
WHEN MATCHED THEN UPDATE
SET
SC_POLICY_NUM = upd_ASICPOLS.SC_POLICY_NUM_LKP3,
CHG_EFF_DT = upd_ASICPOLS.CHG_EFF_DT_LKP3,
CHG_EXP_DT = upd_ASICPOLS.CHG_EXP_DT_NEW,
ECTL_BATCH_ID = upd_ASICPOLS.ECTL_BATCH_ID,
ECTL_ORIG_INS_TS = upd_ASICPOLS.ECTL_ORIG_INS_TS,
ECTL_MODIFY_TS = upd_ASICPOLS.ECTL_MODIFY_TS,
ECTL_TX_CD = upd_ASICPOLS.out_CHK,
ECTL_END_DATE = upd_ASICPOLS.ECTL_END_DATE
;


-- PIPELINE END FOR 2

END; ';