-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_BAL_SRC_TO_PRESTG_STG_MULTILINE_POLSTAT("WORKLET_NAME" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS '
DECLARE
	run_id STRING;
	workflow_name STRING;
	session_name STRING;
	TGT_FLTR_VAR STRING;
    TABLE_NM STRING;
    TBL_NM STRING;
    ACT_PROJ_ID STRING;
    BATCH_ACTIVE_IND STRING;
    Mapping_Name STRING;
    temp_sql STRING;
	v_start_time TIMESTAMP;
BEGIN
	run_id := (SELECT run_id FROM control_run_id WHERE worklet_name = :worklet_name ORDER BY insert_ts DESC LIMIT 1);
	workflow_name := (SELECT workflow_name FROM control_run_id WHERE worklet_name = :worklet_name ORDER BY insert_ts DESC LIMIT 1);
	session_name := ''s_m_BAL_SRC_TO_PRESTG_STG_MULTILINE_POLSTAT'';
	TGT_FLTR_VAR := public.func_get_scoped_param(:run_id, ''TGT_FLTR_VAR'', :workflow_name, :worklet_name, :session_name);
	TABLE_NM := public.func_get_scoped_param(:run_id, ''TABLE_NM'', :workflow_name, :worklet_name, :session_name);
	TBL_NM := public.func_get_scoped_param(:run_id, ''TBL_NM'', :workflow_name, :worklet_name, :session_name);
	ACT_PROJ_ID := public.func_get_scoped_param(:run_id, ''ACT_PROJ_ID'', :workflow_name, :worklet_name, :session_name);
	BATCH_ACTIVE_IND := public.func_get_scoped_param(:run_id, ''BATCH_ACTIVE_IND'', :workflow_name, :worklet_name, :session_name);
	Mapping_Name := public.func_get_scoped_param(:run_id, ''Mapping_Name'', :workflow_name, :worklet_name, :session_name);
	v_start_time := CURRENT_TIMESTAMP();

-- PIPELINE START FOR 1

-- Component SQTRANS, Type SOURCE 
temp_sql := CONCAT(''
CREATE OR REPLACE TEMPORARY TABLE SQTRANS AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as POL_NBR,
$2 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT COUNT(*) AS POL_NBR FROM '', TABLE_NM, '' WHERE '', TGT_FLTR_VAR, ''
) SRC
)
)'');
EXECUTE IMMEDIATE :temp_sql;


-- PIPELINE START FOR 1

-- Component SQ_TRG_MULTILINE_POLSTAT_SRC, Type TABLE_DDL Creating an empty table
CREATE OR REPLACE TEMPORARY TABLE SQ_TRG_MULTILINE_POLSTAT
(
RECORD_CNT decimal,
source_record_id number autoincrement start=1 increment=1
);


-- Component SQ_TRG_MULTILINE_POLSTAT_SRC, Type IMPORT_DATA Importing Data
;


-- Component EXPTRANS1, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE EXPTRANS1 AS
(
SELECT
TO_NUMBER(SQTRANS.POL_NBR) as out_RECORD_CNT,
1 as out_DUMMY_TGT,
SQTRANS.source_record_id
FROM
SQTRANS
);


-- Component EXPTRANS, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE EXPTRANS AS
(
SELECT
TO_NUMBER(SQ_TRG_MULTILINE_POLSTAT.RECORD_CNT) as out_RECORD_CNT,
vROW_NO + 1 as vROW_NO,
vROW_NO as ROW_NO,
1 as out_DUMMY,
SQ_TRG_MULTILINE_POLSTAT.source_record_id
FROM
SQ_TRG_MULTILINE_POLSTAT
);


-- Component FILTRANS, Type FILTER 
CREATE OR REPLACE TEMPORARY TABLE FILTRANS AS
(
SELECT
EXPTRANS.out_RECORD_CNT as RECORD_CNT_TRG,
EXPTRANS.ROW_NO as ROW_NO,
EXPTRANS.out_DUMMY as DUMMY_TRG,
EXPTRANS.source_record_id
FROM
EXPTRANS
WHERE EXPTRANS.ROW_NO = 1
);


-- Component JNRTRANS, Type JOINER 
CREATE OR REPLACE TEMPORARY TABLE JNRTRANS AS
(
SELECT
FILTRANS.RECORD_CNT_TRG as RECORD_CNT_TRG,
FILTRANS.DUMMY_TRG as DUMMY_TRG,
EXPTRANS1.out_RECORD_CNT as RECORD_CNT_TGT,
EXPTRANS1.out_DUMMY_TGT as DUMMY_TGT,
row_number() over (order by 1) AS source_record_id
FROM
EXPTRANS1
INNER JOIN FILTRANS ON EXPTRANS1.out_DUMMY_TGT = FILTRANS.DUMMY_TRG
);


-- Component EXPTRANS2, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE EXPTRANS2 AS
(
SELECT
JNRTRANS.RECORD_CNT_TRG as RECORD_CNT_TRG,
JNRTRANS.RECORD_CNT_TGT as RECORD_CNT_TGT,
TO_NUMBER(JNRTRANS.RECORD_CNT_TRG) - JNRTRANS.RECORD_CNT_TGT as out_ECTL_TGT_REJ_CNT,
CASE WHEN TO_NUMBER(JNRTRANS.RECORD_CNT_TRG) - JNRTRANS.RECORD_CNT_TGT = 0 THEN 0 ELSE 1 END as var_CNT_CHK,
CASE WHEN var_CNT_CHK = 0 THEN :TABLE_NM || '' - AUDIT PASSED FOR RECORD COUNT'' ELSE :TABLE_NM || '' - AUDIT FAILED FOR RECORD COUNT'' END as out_ECTL_MESSAGE_TXT,
CURRENT_TIMESTAMP as out_ECTL_ORIG_INS_TS,
0 as out_ECTL_TGT_DEL_UPD_CNT,
:TABLE_NM as in_SRC_TBL_NM,
:BATCH_ACTIVE_IND as in_BATCH_ACTIVE_IND,
:ACT_PROJ_ID as in_ACT_PROJ_ID,
:Mapping_Name as in_PRGM_NM,
JNRTRANS.source_record_id
FROM
JNRTRANS
);


-- Component mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE, Type MAPPLET 
-- MAPPLET NOT REGISTERED: mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE, mapplet instance mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE;
CALL mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE(''EXPTRANS2'');


-- Component EXPTRANS3, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE EXPTRANS3 AS
(
SELECT
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_PRGM_ID as out_ECTL_PRGM_ID,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_BATCH_ID as out_ECTL_BATCH_ID,
mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.out_ECTL_TABLE_ID as out_ECTL_TABLE_ID,
EXPTRANS2.RECORD_CNT_TRG as RECORD_CNT_TRG,
EXPTRANS2.RECORD_CNT_TGT as RECORD_CNT_TGT,
EXPTRANS2.out_ECTL_TGT_REJ_CNT as out_ECTL_TGT_REJ_CNT,
EXPTRANS2.out_ECTL_MESSAGE_TXT as out_ECTL_MESSAGE_TXT,
EXPTRANS2.out_ECTL_ORIG_INS_TS as out_ECTL_ORIG_INS_TS,
EXPTRANS2.out_ECTL_TGT_DEL_UPD_CNT as out_ECTL_TGT_DEL_UPD_CNT,
EXPTRANS2.source_record_id
FROM
EXPTRANS2
INNER JOIN mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE ON EXPTRANS2.source_record_id = mplt_LKP_ECTL_BATCH_PRGM_VALIDATION_CORE.source_record_id
);


-- Component Shortcut_to_ECTL_AUDIT_LOG, Type TARGET 
INSERT INTO DB_T_CTRL_FIN_PROD.ECTL_AUDIT_LOG
(
ECTL_BATCH_ID,
ECTL_PRGM_ID,
ECTL_TABLE_ID,
ECTL_SRC_ROW_CNT,
ECTL_TRGT_INS_CNT,
ECTL_TRGT_UPD_CNT,
ECTL_TRGT_DEL_CNT,
ECTL_TRGT_REJ_CNT,
ECTL_MESSAGE_TXT,
ECTL_ORIG_INS_TS
)
SELECT
EXPTRANS3.out_ECTL_BATCH_ID as ECTL_BATCH_ID,
EXPTRANS3.out_ECTL_PRGM_ID as ECTL_PRGM_ID,
EXPTRANS3.out_ECTL_TABLE_ID as ECTL_TABLE_ID,
EXPTRANS3.RECORD_CNT_TRG as ECTL_SRC_ROW_CNT,
EXPTRANS3.RECORD_CNT_TGT as ECTL_TRGT_INS_CNT,
EXPTRANS3.out_ECTL_TGT_DEL_UPD_CNT as ECTL_TRGT_UPD_CNT,
EXPTRANS3.out_ECTL_TGT_DEL_UPD_CNT as ECTL_TRGT_DEL_CNT,
EXPTRANS3.out_ECTL_TGT_REJ_CNT as ECTL_TRGT_REJ_CNT,
EXPTRANS3.out_ECTL_MESSAGE_TXT as ECTL_MESSAGE_TXT,
EXPTRANS3.out_ECTL_ORIG_INS_TS as ECTL_ORIG_INS_TS
FROM
EXPTRANS3;


-- PIPELINE START FOR 2

-- Component SQ_Shortcut_to_ECTL_AUDIT_LOG, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_Shortcut_to_ECTL_AUDIT_LOG AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as ECTL_BATCH_ID,
$2 as ECTL_PRGM_ID,
$3 as ECTL_TABLE_ID,
$4 as ECTL_SRC_ROW_CNT,
$5 as ECTL_TRGT_INS_CNT,
$6 as ECTL_TRGT_UPD_CNT,
$7 as ECTL_TRGT_DEL_CNT,
$8 as ECTL_TRGT_REJ_CNT,
$9 as ECTL_MESSAGE_TXT,
$10 as ECTL_ORIG_INS_TS,
$11 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT ECTL_AUDIT_LOG.ECTL_TRGT_REJ_CNT 

FROM

 DB_T_CTRL_FIN_PROD.ECTL_AUDIT_LOG

WHERE ECTL_BATCH_ID IN (SELECT ECTL_BATCH_ID FROM DB_T_CTRL_FIN_PROD.ECTL_BATCH_INFO WHERE ECTL_ACTIVE_IND='':BATCH_ACTIVE_IND''  AND ECTL_PROJ_ID=:ACT_PROJ_ID)

AND ECTL_PRGM_ID IN (SELECT ECTL_PRGM_ID FROM DB_T_CTRL_FIN_PROD.ECTL_PRGM_INFO WHERE ECTL_PRGM_NM ='':PRGM_NM'')

AND ECTL_TABLE_ID IN (SELECT ECTL_TABLE_ID FROM DB_T_CTRL_FIN_PROD.ECTL_TABLE_XREF WHERE ECTL_TABLE_NM = '':TBL_NM'')
) SRC
)
);


-- Component EXPTRANS4, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE EXPTRANS4 AS
(
SELECT
CASE WHEN SQ_Shortcut_to_ECTL_AUDIT_LOG.ECTL_TRGT_REJ_CNT = 0 THEN ''SUCCESS'' ELSE RAISE_ERROR(''AUDIT BALANCING FAILED FOR '' || :TABLE_NM || '' TABLE'') END as var_CHK_ABORT,
''SUCCESS'' as out_SUCCESS,
SQ_Shortcut_to_ECTL_AUDIT_LOG.source_record_id
FROM
SQ_Shortcut_to_ECTL_AUDIT_LOG
);


-- Component FILTRANS1, Type FILTER 
CREATE OR REPLACE TEMPORARY TABLE FILTRANS1 AS
(
SELECT
EXPTRANS4.out_SUCCESS as SUCCESS,
EXPTRANS4.source_record_id
FROM
EXPTRANS4
WHERE EXPTRANS4.out_SUCCESS <> ''SUCCESS''
);


-- Component Shortcut_to_ECTL_AUDIT_LOG_INS, Type TARGET 
INSERT INTO DB_T_CTRL_FIN_PROD.ECTL_AUDIT_LOG
(
ECTL_MESSAGE_TXT
)
SELECT
FILTRANS1.SUCCESS as ECTL_MESSAGE_TXT
FROM
FILTRANS1;


-- PIPELINE END FOR 2

END; ';