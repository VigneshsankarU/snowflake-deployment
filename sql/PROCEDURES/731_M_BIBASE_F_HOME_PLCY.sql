-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_BIBASE_F_HOME_PLCY("WORKLET_NAME" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' DECLARE
  CAL_END_DT STRING;
  CAL_END_MTH_ID STRING;
run_id varchar;
	start_dttm timestamp;
	end_dttm timestamp;
    prcs_id int;
FS_DATE date;

BEGIN 
 run_id :=   (SELECT run_id   FROM control_run_id where worklet_name=:worklet_name order by insert_ts desc limit 1);   
 END_DTTM:=   (SELECT left(param_value,19) FROM control_params where run_id = :run_id and upper(param_name)=''END_DTTM'' limit 1);
 START_DTTM:=     (SELECT left(param_value,19) FROM control_params where run_id = :run_id and upper(param_name)=''START_DTTM'' limit 1);
 PRCS_ID:=     (SELECT param_value FROM control_params where run_id = :run_id and upper(param_name)=''PRCS_ID'' limit 1);
CAL_END_DT:=     (SELECT param_value FROM control_params where run_id = :run_id and upper(param_name)=''CAL_END_DT'' limit 1);
CAL_END_MTH_ID:=     (SELECT param_value FROM control_params where run_id = :run_id and upper(param_name)=''CAL_END_MTH_ID'' limit 1);
   

-- Component sq_AGMT, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE sq_AGMT AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as PLCY_NBR,
$2 as PRODUCER_ID,
$3 as MO_ID,
$4 as BUSN_TYPE_CD,
$5 as INSRNC_SCR_AMT,
$6 as INSRNC_SCR_CNT,
$7 as CVGE_A_AMT,
$8 as SQUAR_FOOTGE_AMT,
$9 as HS_AGE_AMT,
$10 as CLNT_AGE_AMT,
$11 as HO4_CNT,
$12 as AUTO_DSCNT_CNT,
$13 as ACV_ROOF_CNT,
$14 as ACV_OTH_STRUCTURES_CNT,
$15 as EXCLDD_OTH_STRUCTURES_CNT,
$16 as PREFD_CO_CNT,
$17 as DEDCTB_500_CNT,
$18 as DEDCTB_1000_CNT,
$19 as DEDCTB_2000_CNT,
$20 as PCT_DEDCTB_CNT,
$21 as OTH_DEDCTB_CNT,
$22 as SRC_SYS_CD,
$23 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT 

AG.PLCY_NBR

,CAST(CO_AGNT.AGNT_NUM AS INTEGER) AS PRODUCER_ID

, :CAL_END_MTH_ID MO_ID

,CAST(CASE WHEN (PREV.HOST_AGMT_NUM IS NULL AND PLCY_NBR NOT LIKE ''H%'') THEN ''NEW'' ELSE ''EXISTING'' END  AS VARCHAR(50))AS BUSN_TYPE_CD

,CAST(CASE WHEN (SCR BETWEEN 1 AND 997 )  THEN SCR  ELSE 0 END AS INTEGER) AS INS_SCR_AMT

,CASE WHEN (SCR BETWEEN 1 AND 997 ) THEN 1 ELSE 0 END    AS INS_SCR_PLCY_CNT

,COV.DWELLING_AMT CVGE_A_AMT

,SQ.PRTY_ASSET_SPEC_MEAS  SQUAR_FOOTGE_AMT

, CASE WHEN ( CNSTRCTN_DT <>''1900-01-01'' OR  CNSTRCTN_DT IS NOT NULL) THEN (EXTRACT( YEAR, CAST(:CAL_END_DT AS DATE))- EXTRACT( YEAR, CAST( CNSTRCTN_DT AS DATE)))  ELSE 0 END AS HS_AGE_AMT 

, CASE WHEN ( (EXTRACT( YEAR, CAST(:CAL_END_DT AS DATE))-EXTRACT(YEAR, BIRTH_DT)) between 15 and 100 ) THEN (EXTRACT( YEAR, CAST(:CAL_END_DT AS DATE))-EXTRACT(YEAR, BIRTH_DT)) ELSE 0 END AS CLNT_AGE_AMT

,CASE WHEN (PROD_NAME LIKE ''%4'') THEN 1 ELSE 0 END HO4_CNT

,CASE WHEN (AUTO_DSCNT =''Y'') THEN 1 ELSE 0 END AUTO_DSCNT_CNT

,CASE WHEN (ACV_ROOF_CNT =''Y'') THEN 1 ELSE 0 END  ACV_ROOF_CNT

,CASE WHEN (ACV_OTH_STRUCTURES_CNT =''Y'') THEN 1 ELSE 0 END  ACV_OTH_STRUCTURES_CNT

,CASE WHEN (EXCLDD_OTH_STRUCTURES_CNT =''Y'') THEN 1 ELSE 0 END  EXCLDD_OTH_STRUCTURES_CNT

,CASE WHEN (CO_CD IN (''AIC'',''AMI'')) THEN 1 ELSE 0 END  PREFD_CO_CNT

, DEDCTB_500_CNT

,DEDCTB_1000_CNT

,DEDCTB_2000_CNT

,PCT_DEDCTB_CNT

,OTH_DEDCTB_CNT

,''GW'' AS SRC_SYS_CD

FROM 

(

SELECT A.AGMT_ID,  ast.AGMT_STS_CD,

A.HOST_AGMT_NUM PLCY_NBR,P.PROD_NAME,a.CNTNUS_SRVC_DTTM,

CASE WHEN a.MODL_EFF_DTTM > a.MODL_CRTN_DTTM THEN a.MODL_EFF_DTTM 

ELSE a.MODL_CRTN_DTTM END AS NEW_AGMT_EFF_DTTM FROM  DB_T_PROD_CORE.AGMT AS A 

JOIN  DB_T_PROD_CORE.AGMT TRM 

ON TRM.HOST_AGMT_NUM=A.HOST_AGMT_NUM AND TRM.TERM_NUM=A.TERM_NUM 

and    TRM.AGMT_TYPE_CD=''POLTRM''   AND CAST(CAST(:CAL_END_DT AS DATE)+1 AS TIMESTAMP(6)) - INTERVAL ''0.000001 SECOND'' 

BETWEEN trm.AGMT_EFF_DTTM AND trm.AGMT_PLND_EXPN_DTTM 

AND A.EDW_END_DTTM =''9999-12-31 23:59:59.999999''

JOIN DB_T_PROD_CORE.AGMT_STS  AS AS1  ON  TRM.AGMT_ID=AS1.AGMT_ID 

AND AS1.AGMT_STS_STRT_DTTM <= CAST(CAST(:CAL_END_DT AS DATE)+1 AS TIMESTAMP(6)) - INTERVAL ''0.000001 SECOND'' 

and NEW_AGMT_EFF_DTTM < CAST(CAST(:CAL_END_DT  AS DATE)+1 AS TIMESTAMP(6)) - INTERVAL ''0.000001 SECOND''

AND A.AGMT_TYPE_CD = ''PPV'' AND AS1.AGMT_STS_CD <> ''CNFRMDDT'' 

JOIN DB_T_PROD_CORE.AGMT_PROD  AS AP ON A.AGMT_ID=AP.AGMT_ID  AND AP.AGMT_PROD_ROLE_CD=''PLCYTYPE''

AND  :CAL_END_DT  BETWEEN CAST(AP.AGMT_PROD_STRT_DTTM AS DATE) AND CAST(AP.AGMT_PROD_END_DTTM AS DATE)

JOIN DB_T_PROD_CORE.PROD  P ON AP.PROD_ID=P.PROD_ID 

AND :CAL_END_DT BETWEEN CAST(P.PROD_STRT_DTTM AS DATE) AND CAST(P.PROD_END_DTTM AS DATE)

AND P.EDW_END_DTTM =''9999-12-31 23:59:59.999999''

LEFT OUTER JOIN DB_T_PROD_CORE.AGMT_STS_TYPE AST ON AS1.AGMT_STS_CD = AST.AGMT_STS_CD 

LEFT OUTER JOIN DB_T_PROD_CORE.AGMT_MBRSHP  AS AM ON  A.AGMT_ID=AM.AGMT_ID

 AND :CAL_END_DT BETWEEN CAST(AM.AGMT_MBRSHP_STRT_DTTM AS DATE) AND CAST(AM.AGMT_MBRSHP_END_DTTM AS DATE)

LEFT OUTER JOIN DB_T_PROD_CORE.MBRSHP   AS M ON M.MBRSHP_ID=AM.MBRSHP_ID AND CAST(M.EDW_END_DTTM AS DATE) =CAST( ''9999-12-31''  AS DATE)

WHERE 	  P.PROD_NAME like ''HO%''

QUALIFY ROW_NUMBER() OVER(PARTITION BY A.HOST_AGMT_NUM ORDER BY A.MODL_CRTN_DTTM DESC, A.MODL_EFF_DTTM DESC,  AS1.AGMT_STS_STRT_DTTM DESC, AS1.EDW_END_DTTM DESC) = 1



and ast.AGMT_STS_CD =''inforce''

) AG

LEFT OUTER JOIN 

(

SELECT AGMT_ID, MAX(CASE WHEN (CAST(BIRTH_DT AS DATE)<> ''1900-01-01'' ) THEN BIRTH_DT END) BIRTH_DT,  MAX(CO_CD) CO_CD, MAX(AGNT_NUM) AGNT_NUM FROM (

SELECT PA.AGMT_ID,

CASE WHEN  PA.PRTY_AGMT_ROLE_CD = ''PLCYPRININS'' THEN  BIRTH_DT END AS BIRTH_DT, 

CASE WHEN  PA.PRTY_AGMT_ROLE_CD = ''CMP'' THEN  LTRIM( IO.INTRNL_ORG_NUM,''0'') END AS CO_CD ,

CASE WHEN  PA.PRTY_AGMT_ROLE_CD = ''PRDA'' THEN  LTRIM( IO.INTRNL_ORG_NUM,''0'') END AS AGNT_NUM

FROM  DB_T_PROD_CORE.PRTY_AGMT AS PA  

 LEFT OUTER JOIN DB_T_PROD_CORE.INDIV AS INM ON PA.PRTY_ID = INM.INDIV_PRTY_ID  

  LEFT OUTER JOIN DB_T_PROD_CORE.INTRNL_ORG AS IO ON PA.PRTY_ID = IO.INTRNL_ORG_PRTY_ID

 LEFT OUTER JOIN DB_T_PROD_CORE.ORG_NAME AS ORGN ON PA.PRTY_ID = ORGN.PRTY_ID

 WHERE  PA.PRTY_AGMT_ROLE_CD IN (''PLCYPRININS'', ''CMP'', ''PRDA'') 

 QUALIFY ROW_NUMBER() OVER(PARTITION BY PA.AGMT_ID,PA.PRTY_ID,PA.PRTY_AGMT_ROLE_CD ORDER BY PA.PRTY_AGMT_STRT_DTTM DESC, PA.TRANS_STRT_DTTM  DESC)=1)T1

 GROUP BY 1

  )CO_AGNT  ON AG.AGMT_ID=CO_AGNT.AGMT_ID

 LEFT OUTER JOIN  (

SELECT AGMT_ID,

MAX(CASE WHEN  NK_SRC_KEY = ''HODW_DWELLING_LIMIT_HOE''  THEN AGMT_FEAT_AMT END) DWELLING_AMT,

MAX(CASE WHEN  FEAT_ELGBL_IND = ''T'' AND NK_SRC_KEY = ''HOMULTIPOLICYDISCOUNT_ALFA'' THEN ''Y'' ELSE ''N''  END)  AS AUTO_DSCNT,

MAX(CASE WHEN  NK_SRC_KEY=''HODW_ACVROOF_ALFA''  THEN ''Y'' ELSE ''N'' END )ACV_ROOF_CNT,

MAX(CASE WHEN  NK_SRC_KEY = ''HOSI_SPECIFICOTHERSTRUCTUREITEMACVENDORSEMENT_ALFA'' THEN ''Y'' ELSE ''N'' END) ACV_OTH_STRUCTURES_CNT,

MAX(CASE WHEN  NK_SRC_KEY = ''HOLI_SPECIFICOTHERSTRUCTUREEXCLSCHEDULE_ALFA''  THEN ''Y'' ELSE ''N'' END ) EXCLDD_OTH_STRUCTURES_CNT

FROM 

(SELECT A.AGMT_ID,FEAT_ID,AGMT_FEAT_AMT,INSRNC_LOB_TYPE_CD, A.FEAT_ELGBL_IND  FROM DB_T_PROD_CORE.AGMT_FEAT A

JOIN DB_T_PROD_CORE.AGMT_PROD  AS AP ON A.AGMT_ID=AP.AGMT_ID 

JOIN DB_T_PROD_CORE.PROD  P ON AP.PROD_ID=P.PROD_ID 

WHERE  INSRNC_LOB_TYPE_CD=''HO'' 

AND CAST(A.AGMT_FEAT_STRT_DTTM AS DATE)<=to_date(:CAL_END_DT ,''YYYY-MM-DD'')  

AND CAST(A.TRANS_END_DTTM AS DATE)>=to_date(:CAL_END_DT ,''YYYY-MM-DD'')  

QUALIFY ROW_NUMBER() OVER(PARTITION BY A.AGMT_ID,A.FEAT_ID ORDER BY A.AGMT_FEAT_STRT_DTTM DESC, A.TRANS_STRT_DTTM DESC ) = 1) T1

JOIN DB_T_PROD_CORE.FEAT AS F ON T1.FEAT_ID = F.FEAT_ID  

GROUP BY 1) COV ON AG.AGMT_ID=COV.AGMT_ID

LEFT OUTER JOIN (

SELECT AGMT_ID

,COUNT( DISTINCT CASE WHEN (DEDUCT =''500'') THEN AGMT_ID ELSE NULL END) DEDCTB_500_CNT

,COUNT( DISTINCT CASE WHEN (DEDUCT =''1K'') THEN AGMT_ID ELSE NULL END) DEDCTB_1000_CNT

,COUNT( DISTINCT CASE WHEN (DEDUCT =''2K'') THEN AGMT_ID ELSE NULL END) DEDCTB_2000_CNT

,COUNT( DISTINCT CASE WHEN (DEDUCT IN (''1.0%'',''2.0%'',''1.5%'',''5%'',''5.0%'',''1%'',''10%'',''0.25%'',''0.5%'',''2%'')) THEN AGMT_ID ELSE NULL END) PCT_DEDCTB_CNT

,COUNT( DISTINCT CASE WHEN (DEDUCT NOT IN (''500'',''1K'',''2K'',''1.0%'',''2.0%'',''1.5%'',''5%'',''5.0%'',''1%'',''10%'',''0.25%'',''0.5%'',''2%'')) THEN AGMT_ID ELSE NULL END) OTH_DEDCTB_CNT

FROM (

SELECT  AF.AGMT_ID,F.FEAT_NAME DEDUCT, F.FEAT_ID

FROM DB_T_PROD_CORE.FEAT F        

JOIN DB_T_PROD_CORE.AGMT_FEAT AF ON F.FEAT_ID=AF.FEAT_ID 

LEFT JOIN DB_T_PROD_CORE.FEAT_RLTD FR3 ON F.FEAT_ID=FR3.RLTD_FEAT_ID AND   FR3.FEAT_RLTNSHP_TYPE_CD =''COVOPTT'' 

LEFT JOIN DB_T_PROD_CORE.FEAT F3 ON FR3.FEAT_ID=F3.FEAT_ID

WHERE F3.FEAT_NAME=''SECTION I DEDUCTIBLES'' AND CAST(AF.TRANS_STRT_DTTM AS DATE)<=:CAL_END_DT::date

AND CAST(AF.TRANS_END_DTTM AS DATE)>=:CAL_END_DT::date

QUALIFY ROW_NUMBER() OVER(PARTITION BY AGMT_ID,F.FEAT_ID ORDER BY AF.TRANS_STRT_DTTM DESC, AF.EDW_END_DTTM DESC)=1)T1

GROUP BY 1)DED ON DED.AGMT_ID=AG.AGMT_ID

LEFT OUTER JOIN (SELECT  DISTINCT AGMT_ID, PRTY_ASSET_SPEC_MEAS, CNSTRCTN_DT  FROM DB_T_PROD_CORE.AGMT_ASSET A LEFT OUTER JOIN DB_T_PROD_CORE.PRTY_ASSET_SPEC  PAS ON A.PRTY_ASSET_ID=PAS.PRTY_ASSET_ID

LEFT OUTER JOIN DB_T_PROD_CORE.REAL_ESTAT   RE ON A.PRTY_ASSET_ID=RE.PRTY_ASSET_ID

AND CAST(RE.EDW_STRT_DTTM AS DATE)<=:CAL_END_DT::date AND CAST(RE.EDW_END_DTTM AS DATE)>=:CAL_END_DT::date

WHERE PRTY_ASSET_SPEC_TYPE_CD=''SIZE'' AND PRTY_ASSET_SPEC_UOM_CD=''SQFT'' AND CAST(A.AGMT_ASSET_STRT_DTTM AS DATE) <=:CAL_END_DT::date

AND CAST(A.TRANS_END_DTTM AS DATE)>=:CAL_END_DT

QUALIFY ROW_NUMBER() OVER(PARTITION BY  AGMT_ID ORDER BY A.AGMT_ASSET_STRT_DTTM DESC, A.EDW_END_DTTM DESC)=1)SQ

ON SQ.AGMT_ID=AG.AGMT_ID 

LEFT OUTER JOIN (

SELECT PA.AGMT_ID,MAX(SCR1.SCR) SCR FROM 

(SELECT PS1.PRTY_ID,PS1.PRTY_SCR_VAL AS SCR

FROM DB_T_PROD_CORE.PRTY_SCR PS1

JOIN  DB_T_PROD_CORE.MODL_RUN MR1

ON PS1.MODL_RUN_ID= MR1.MODL_RUN_ID

WHERE PS1.MODL_ID =1 AND CAST(MR1.MODL_RUN_DTTM AS DATE)<=:CAL_END_DT::date

QUALIFY ROW_NUMBER() OVER(PARTITION BY PS1.PRTY_ID ORDER BY  MR1.MODL_RUN_DTTM DESC)=1 )SCR1

JOIN DB_T_PROD_CORE.PRTY_AGMT  PA

ON PA.PRTY_AGMT_ROLE_CD IN ( ''PLCYPRININS'' ,''PLCYADDNMINS'') AND SCR1.PRTY_ID=PA.PRTY_ID 

WHERE CAST( PA.PRTY_AGMT_STRT_DTTM AS DATE)<= :CAL_END_DT::date  

AND CAST( PA.TRANS_END_DTTM AS DATE)>= :CAL_END_DT  

GROUP BY 1) SCR ON SCR.AGMT_ID=AG.AGMT_ID

  LEFT OUTER JOIN   (SELECT HOST_AGMT_NUM FROM DB_T_PROD_CORE.AGMT PREV WHERE

  PREV.AGMT_TYPE_CD=''PPV'' AND CAST(PREV.MODL_EFF_DTTM AS DATE)<=ADD_MONTHS(CAST(:CAL_END_DT AS DATE),-1)

AND SRC_SYS_CD=''GWPC''

  GROUP BY 1) PREV 

 ON PREV.HOST_AGMT_NUM =AG.PLCY_NBR

 WHERE  AGMT_STS_CD IN (''INFORCE'',''RNEWLLAPSD'',''CNFRMD'')

  GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21
) SRC
)
);


-- Component LKP_PLCY_XREF, Type LOOKUP 
CREATE OR REPLACE TEMPORARY TABLE LKP_PLCY_XREF AS
(
SELECT
LKP.PLCY_ID,
sq_AGMT.source_record_id,
ROW_NUMBER() OVER(PARTITION BY sq_AGMT.source_record_id ORDER BY LKP.PLCY_ID asc) RNK
FROM
sq_AGMT
LEFT JOIN (
SELECT PLCY_ID as PLCY_ID, PLCY_NBR as PLCY_NBR FROM db_v_prod_pres.PLCY_XREF
WHERE SRC_TYPE=''GW''
QUALIFY ROW_NUMBER() OVER (PARTITION BY PLCY_NBR ORDER BY EDW_END_DTTM DESC)=1
) LKP ON 
sq_AGMT.PLCY_NBR = LKP.PLCY_NBR
QUALIFY RNK = 1
);


-- Component exp_Passthrough, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_Passthrough AS
(
SELECT
LKP_PLCY_XREF.PLCY_ID as PLCY_ID,
sq_AGMT.PRODUCER_ID as PRODUCER_ID,
sq_AGMT.MO_ID as MO_ID,
sq_AGMT.BUSN_TYPE_CD as BUSN_TYPE_CD,
sq_AGMT.INSRNC_SCR_AMT as INSRNC_SCR_AMT,
sq_AGMT.INSRNC_SCR_CNT as INSRNC_SCR_CNT,
sq_AGMT.CVGE_A_AMT as CVGE_A_AMT,
sq_AGMT.SQUAR_FOOTGE_AMT as SQUAR_FOOTGE_AMT,
sq_AGMT.HS_AGE_AMT as HS_AGE_AMT,
sq_AGMT.CLNT_AGE_AMT as CLNT_AGE_AMT,
sq_AGMT.HO4_CNT as HO4_CNT,
sq_AGMT.AUTO_DSCNT_CNT as AUTO_DSCNT_CNT,
sq_AGMT.ACV_ROOF_CNT as ACV_ROOF_CNT,
sq_AGMT.ACV_OTH_STRUCTURES_CNT as ACV_OTH_STRUCTURES_CNT,
sq_AGMT.EXCLDD_OTH_STRUCTURES_CNT as EXCLDD_OTH_STRUCTURES_CNT,
sq_AGMT.PREFD_CO_CNT as PREFD_CO_CNT,
sq_AGMT.DEDCTB_500_CNT as DEDCTB_500_CNT,
sq_AGMT.DEDCTB_1000_CNT as DEDCTB_1000_CNT,
sq_AGMT.DEDCTB_2000_CNT as DEDCTB_2000_CNT,
sq_AGMT.PCT_DEDCTB_CNT as PCT_DEDCTB_CNT,
sq_AGMT.OTH_DEDCTB_CNT as OTH_DEDCTB_CNT,
sq_AGMT.SRC_SYS_CD as SRC_SYS_CD,
sq_AGMT.source_record_id
FROM
sq_AGMT
INNER JOIN LKP_PLCY_XREF ON sq_AGMT.source_record_id = LKP_PLCY_XREF.source_record_id
);


-- Component FIL_INVALID_POLICY_NBR, Type FILTER 
CREATE OR REPLACE TEMPORARY TABLE FIL_INVALID_POLICY_NBR AS
(
SELECT
exp_Passthrough.PLCY_ID as PLCY_ID,
exp_Passthrough.PRODUCER_ID as PRODUCER_ID,
exp_Passthrough.MO_ID as MO_ID,
exp_Passthrough.BUSN_TYPE_CD as BUSN_TYPE_CD,
exp_Passthrough.INSRNC_SCR_AMT as INSRNC_SCR_AMT,
exp_Passthrough.INSRNC_SCR_CNT as INSRNC_SCR_CNT,
exp_Passthrough.CVGE_A_AMT as CVGE_A_AMT,
exp_Passthrough.SQUAR_FOOTGE_AMT as SQUAR_FOOTGE_AMT,
exp_Passthrough.HS_AGE_AMT as HS_AGE_AMT,
exp_Passthrough.CLNT_AGE_AMT as CLNT_AGE_AMT,
exp_Passthrough.HO4_CNT as HO4_CNT,
exp_Passthrough.AUTO_DSCNT_CNT as AUTO_DSCNT_CNT,
exp_Passthrough.ACV_ROOF_CNT as ACV_ROOF_CNT,
exp_Passthrough.ACV_OTH_STRUCTURES_CNT as ACV_OTH_STRUCTURES_CNT,
exp_Passthrough.EXCLDD_OTH_STRUCTURES_CNT as EXCLDD_OTH_STRUCTURES_CNT,
exp_Passthrough.PREFD_CO_CNT as PREFD_CO_CNT,
exp_Passthrough.DEDCTB_500_CNT as DEDCTB_500_CNT,
exp_Passthrough.DEDCTB_1000_CNT as DEDCTB_1000_CNT,
exp_Passthrough.DEDCTB_2000_CNT as DEDCTB_2000_CNT,
exp_Passthrough.PCT_DEDCTB_CNT as PCT_DEDCTB_CNT,
exp_Passthrough.OTH_DEDCTB_CNT as OTH_DEDCTB_CNT,
exp_Passthrough.SRC_SYS_CD as SRC_SYS_CD,
exp_Passthrough.source_record_id
FROM
exp_Passthrough
WHERE exp_Passthrough.PLCY_ID IS NOT NULL
);


-- Component F_HOME_PLCY, Type TARGET 
INSERT INTO DB_V_PROD_PRES.F_HOME_PLCY
(
PLCY_ID,
MO_ID,
PRODUCER_ID,
BUSN_TYPE_CD,
INSRNC_SCR_AMT,
INSRNC_SCR_CNT,
CVGE_A_AMT,
SQUAR_FOOTGE_AMT,
HS_AGE_AMT,
CLNT_AGE_AMT,
HO4_CNT,
AUTO_DSCNT_CNT,
ACV_ROOF_CNT,
ACV_OTH_STRUCTURES_CNT,
EXCLDD_OTH_STRUCTURES_CNT,
PREFD_CO_CNT,
DEDCTB_500_CNT,
DEDCTB_1000_CNT,
DEDCTB_2000_CNT,
PCT_DEDCTB_CNT,
OTH_DEDCTB_CNT,
SRC_SYS_CD
)
SELECT
FIL_INVALID_POLICY_NBR.PLCY_ID as PLCY_ID,
FIL_INVALID_POLICY_NBR.MO_ID as MO_ID,
FIL_INVALID_POLICY_NBR.PRODUCER_ID as PRODUCER_ID,
FIL_INVALID_POLICY_NBR.BUSN_TYPE_CD as BUSN_TYPE_CD,
FIL_INVALID_POLICY_NBR.INSRNC_SCR_AMT as INSRNC_SCR_AMT,
FIL_INVALID_POLICY_NBR.INSRNC_SCR_CNT as INSRNC_SCR_CNT,
FIL_INVALID_POLICY_NBR.CVGE_A_AMT as CVGE_A_AMT,
FIL_INVALID_POLICY_NBR.SQUAR_FOOTGE_AMT as SQUAR_FOOTGE_AMT,
FIL_INVALID_POLICY_NBR.HS_AGE_AMT as HS_AGE_AMT,
FIL_INVALID_POLICY_NBR.CLNT_AGE_AMT as CLNT_AGE_AMT,
FIL_INVALID_POLICY_NBR.HO4_CNT as HO4_CNT,
FIL_INVALID_POLICY_NBR.AUTO_DSCNT_CNT as AUTO_DSCNT_CNT,
FIL_INVALID_POLICY_NBR.ACV_ROOF_CNT as ACV_ROOF_CNT,
FIL_INVALID_POLICY_NBR.ACV_OTH_STRUCTURES_CNT as ACV_OTH_STRUCTURES_CNT,
FIL_INVALID_POLICY_NBR.EXCLDD_OTH_STRUCTURES_CNT as EXCLDD_OTH_STRUCTURES_CNT,
FIL_INVALID_POLICY_NBR.PREFD_CO_CNT as PREFD_CO_CNT,
FIL_INVALID_POLICY_NBR.DEDCTB_500_CNT as DEDCTB_500_CNT,
FIL_INVALID_POLICY_NBR.DEDCTB_1000_CNT as DEDCTB_1000_CNT,
FIL_INVALID_POLICY_NBR.DEDCTB_2000_CNT as DEDCTB_2000_CNT,
FIL_INVALID_POLICY_NBR.PCT_DEDCTB_CNT as PCT_DEDCTB_CNT,
FIL_INVALID_POLICY_NBR.OTH_DEDCTB_CNT as OTH_DEDCTB_CNT,
FIL_INVALID_POLICY_NBR.SRC_SYS_CD as SRC_SYS_CD
FROM
FIL_INVALID_POLICY_NBR;


END; ';