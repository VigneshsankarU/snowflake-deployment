-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.MPLT_LKP_CTRL_TBLS_VALIDATION("IN_MPLT_LKP_BATCH_PRGM" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS '
BEGIN 

-- Component LKP_ECTL_PRGM_INFO, Type LOOKUP 
EXECUTE IMMEDIATE ''
CREATE OR REPLACE TEMPORARY TABLE LKP_ECTL_PRGM_INFO AS
    (
    SELECT
    LKP.ECTL_PRGM_ID,
    input_mapplet.source_record_id,
    ROW_NUMBER() OVER(PARTITION BY input_mapplet.source_record_id ORDER BY LKP.ECTL_PRGM_ID asc) RNK
    FROM
    '' || in_MPLT_LKP_BATCH_PRGM || '' input_mapplet
    LEFT JOIN (
    SELECT ECTL_PRGM_INFO.ECTL_PRGM_ID as ECTL_PRGM_ID, ECTL_PRGM_INFO.ECTL_PROJ_ID as ECTL_PROJ_ID, ECTL_PRGM_INFO.ECTL_PRGM_NM as ECTL_PRGM_NM FROM DB_T_CTRL_FIN_PROD.ECTL_PRGM_INFO WHERE ECTL_ACTIVE_IND = ''''Y''''
    ) LKP ON LKP.ECTL_PROJ_ID = input_mapplet.in_PROJ_ID1 AND LKP.ECTL_PRGM_NM = input_mapplet.in_PRGM_NM
    QUALIFY RNK = 1
    );
'';

-- Component LKP_ECTL_BATCH_INFO, Type LOOKUP 
EXECUTE IMMEDIATE ''
CREATE OR REPLACE TEMPORARY TABLE LKP_ECTL_BATCH_INFO AS
    (
    SELECT
    LKP.ECTL_BATCH_ID,
    input_mapplet.source_record_id,
    ROW_NUMBER() OVER(PARTITION BY input_mapplet.source_record_id ORDER BY LKP.ECTL_BATCH_ID asc) RNK
    FROM
    '' || in_MPLT_LKP_BATCH_PRGM || '' input_mapplet
    LEFT JOIN (
    SELECT
    ECTL_BATCH_ID,
    ECTL_ACTIVE_IND,
    ECTL_PROJ_ID
    FROM DB_T_CTRL_FIN_PROD.ECTL_BATCH_INFO
    ) LKP ON LKP.ECTL_ACTIVE_IND = input_mapplet.in_BATCH_ACTIVE_IND AND LKP.ECTL_PROJ_ID = input_mapplet.in_PROJ_ID
    QUALIFY RNK = 1
    );
'';

-- Component LKP_ECTL_TABLE_XREF, Type LOOKUP 
EXECUTE IMMEDIATE ''
CREATE OR REPLACE TEMPORARY TABLE LKP_ECTL_TABLE_XREF AS
    (
    SELECT
    LKP.ECTL_TABLE_ID,
    input_mapplet.source_record_id,
    ROW_NUMBER() OVER(PARTITION BY input_mapplet.source_record_id ORDER BY LKP.ECTL_TABLE_ID asc) RNK
    FROM
    '' || in_MPLT_LKP_BATCH_PRGM || '' input_mapplet
    LEFT JOIN (
    SELECT
    ECTL_TABLE_ID,
    ECTL_TABLE_NM
    FROM DB_T_CTRL_FIN_PROD.ECTL_TABLE_XREF
    ) LKP ON LKP.ECTL_TABLE_NM = input_mapplet.in_SRC_TABLE_NM
    QUALIFY RNK = 1
    );
'';

-- Component exp_ASSIGN_TS, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_ASSIGN_TS AS
    (
    SELECT
    LKP_ECTL_PRGM_INFO.ECTL_PRGM_ID as ECTL_PRGM_ID,
    LKP_ECTL_TABLE_XREF.ECTL_TABLE_ID as ECTL_TABLE_ID,
    LKP_ECTL_BATCH_INFO.ECTL_BATCH_ID as ECTL_BATCH_ID,
    CASE WHEN LKP_ECTL_BATCH_INFO.ECTL_BATCH_ID IS NULL OR LKP_ECTL_PRGM_INFO.ECTL_PRGM_ID IS NULL OR LKP_ECTL_TABLE_XREF.ECTL_TABLE_ID IS NULL THEN 
    null --RAISE_ERROR(''ERROR-BATCH/PROGRAM NOT ACTIVE'') 
    ELSE 
    null --$3 
    END as var_BATCH_VALIDATION,
    LKP_ECTL_PRGM_INFO.source_record_id
    FROM
    LKP_ECTL_PRGM_INFO
    INNER JOIN LKP_ECTL_BATCH_INFO ON LKP_ECTL_PRGM_INFO.source_record_id = LKP_ECTL_BATCH_INFO.source_record_id
    INNER JOIN LKP_ECTL_TABLE_XREF ON LKP_ECTL_BATCH_INFO.source_record_id = LKP_ECTL_TABLE_XREF.source_record_id
    );


-- Component output_mapplet, Type OUTPUT_TRANSFORMATION 
-- Component output_mapplet, Type MAPPLET 
    CREATE OR REPLACE TEMPORARY TABLE mplt_LKP_CTRL_TBLS_VALIDATION AS
        (
        SELECT
        exp_ASSIGN_TS.ECTL_TABLE_ID as out_ECTL_TABLE_ID,
        exp_ASSIGN_TS.ECTL_BATCH_ID as out_ECTL_BATCH_ID,
        exp_ASSIGN_TS.ECTL_PRGM_ID as out_ECTL_PRGM_ID,
        SOURCE_RECORD_ID
        FROM
        exp_ASSIGN_TS
        );


END; ';