-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_AGG_MULTILINE_POLSTAT_MTHLY("RUN_ID" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' BEGIN 

-- Component SQ_AGG_MULTILINE_POLSTAT, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_AGG_MULTILINE_POLSTAT AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as MO_ID,
$2 as SALES_ST_CD,
$3 as SALES_RGN_CD,
$4 as SALES_DIST_CD,
$5 as SALES_SVC_CD,
$6 as AGENCY_NBR,
$7 as AGNT_CLIENT_ID,
$8 as MASTER_COMPANY_NBR,
$9 as LOB_CD,
$10 as LOB_DESC,
$11 as LOB_SORT_CD,
$12 as POL_TYPE,
$13 as REASON,
$14 as PLCY_CNT_BEG_IFO,
$15 as PLCY_CNT_NEW_BUSI,
$16 as PLCY_C2C_NEW_BUSI,
$17 as UNIT_C2C_NEW_BUSI,
$18 as PLCY_RINSTMT,
$19 as HO_FIRE_PLCY_FORM_CHG_RINSTMT,
$20 as PLCY_CNT_LAPS,
$21 as PLCY_CNT_LAPS_CNVRSN,
$22 as PLCY_CNT_CANC,
$23 as PLCY_CNT_CANC_CNVRSN,
$24 as HO_FIRE_PLCY_FORM_CHG_CANC,
$25 as PLCY_C2C_CANC,
$26 as UNIT_C2C_CANC,
$27 as PLCY_C2C_UNIT_CANC,
$28 as UNIT_CNT_BEG_IFO,
$29 as UNIT_IFO_NEW_BUSI,
$30 as UNIT_RINSTMT,
$31 as UNIT_CNT_CANC,
$32 as UNIT_CNT_CANC_CNVRSN,
$33 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
WITH ECTL_PARAM_DATE AS (

SELECT 

CAL_END_DATE-EXTRACT(DAY FROM CAL_END_DATE)+1 CAL_START_DATE,

MAX(FEED_DT) CAL_END_DATE, 

EXTRACT(YEAR FROM CAL_END_DATE)*100+EXTRACT(MONTH FROM CAL_END_DATE) CAL_MO_ID 

FROM DB_T_ML_PROD.MULTILINE_POLSTAT

)

 

SELECT CAL_MO_ID MO_ID,

ST_CD_NEW,

COALESCE(AGNT1.SALES_RGN_CD,AGNT2.SALES_RGN_CD,AGNT3.SALES_RGN_CD,A1.ST_CD_NEW||''99999'') AS SALES_RGN_CD, 

COALESCE(AGNT1.SALES_DST_CD,AGNT2.SALES_DST_CD,AGNT3.SALES_DST_CD,A1.ST_CD_NEW||''99999'') AS SALES_DST_CD, 

A1.SALES_SVC_CD,

A1.AGENCY_NBR,

COALESCE(AGNT1.AGNT_CLIENT_ID,AGNT2.AGNT_CLIENT_ID,AGNT3.AGNT_CLIENT_ID) AS AGNT_CLIENT_ID, 

MASTER_COMPANY_NBR_NEW,

CASE WHEN A1.LOB_CD_NEW = ''PORTFLIO'' THEN ''PORT'' ELSE A1.LOB_CD_NEW END LOB_CD,

CASE WHEN A1.LOB_CD_NEW = ''AUTO'' AND A1.MASTER_COMPANY_NBR_NEW=10 THEN A1.LOB_CD_NEW || '' - '' ||''AMI'' 

WHEN A1.LOB_CD_NEW = ''AUTO'' AND A1.MASTER_COMPANY_NBR_NEW=70 THEN A1.LOB_CD_NEW || '' - '' ||''AMG'' 

WHEN A1.LOB_CD_NEW = ''AUTO'' AND A1.MASTER_COMPANY_NBR_NEW=40 THEN A1.LOB_CD_NEW || '' - '' ||''AIC'' 

WHEN A1.LOB_CD_NEW = ''AUTO'' AND A1.MASTER_COMPANY_NBR_NEW=50 THEN A1.LOB_CD_NEW || '' - '' ||''AGI'' 

WHEN A1.LOB_CD_NEW = ''FIRE'' AND A1.MASTER_COMPANY_NBR_NEW=60 AND A1.POL_TYPE='''' THEN A1.LOB_CD_NEW || '' - '' ||''AMI'' 

WHEN A1.LOB_CD_NEW = ''FIRE'' AND A1.MASTER_COMPANY_NBR_NEW=60 AND A1.POL_TYPE=''F''THEN A1.LOB_CD_NEW || '' TEN - '' ||''AMI'' 

WHEN A1.LOB_CD_NEW = ''FIRE'' AND A1.MASTER_COMPANY_NBR_NEW=40 AND A1.POL_TYPE='''' THEN A1.LOB_CD_NEW || '' - '' ||''AIC'' 

WHEN A1.LOB_CD_NEW = ''FIRE'' AND A1.MASTER_COMPANY_NBR_NEW=40 AND A1.POL_TYPE=''F'' THEN A1.LOB_CD_NEW || '' TEN - '' ||''AIC''

WHEN A1.LOB_CD_NEW = ''HOME'' AND A1.MASTER_COMPANY_NBR_NEW=10 AND A1.POL_TYPE='''' THEN A1.LOB_CD_NEW || '' - '' ||''AMI'' 

WHEN A1.LOB_CD_NEW = ''HOME'' AND A1.MASTER_COMPANY_NBR_NEW=10 AND A1.POL_TYPE=''H'' THEN A1.LOB_CD_NEW || '' TEN - '' ||''AMI'' 

WHEN A1.LOB_CD_NEW = ''HOME'' AND A1.MASTER_COMPANY_NBR_NEW=70 AND A1.POL_TYPE='''' THEN A1.LOB_CD_NEW || '' - '' ||''AMG'' 

WHEN A1.LOB_CD_NEW = ''HOME'' AND A1.MASTER_COMPANY_NBR_NEW=40 AND A1.POL_TYPE='''' THEN A1.LOB_CD_NEW || '' - '' ||''AIC'' 

WHEN A1.LOB_CD_NEW = ''HOME'' AND A1.MASTER_COMPANY_NBR_NEW=40 AND A1.POL_TYPE = ''H'' THEN A1.LOB_CD_NEW || '' TEN - '' ||''AIC''

WHEN A1.LOB_CD_NEW = ''HOME'' AND A1.MASTER_COMPANY_NBR_NEW=50 AND A1.POL_TYPE='''' THEN A1.LOB_CD_NEW || '' - '' ||''AGI'' 

WHEN A1.LOB_CD_NEW = ''HOME'' AND A1.MASTER_COMPANY_NBR_NEW=50 AND A1.POL_TYPE=''D''THEN A1.LOB_CD_NEW || '' DPP - '' ||''AGI'' 

WHEN A1.LOB_CD_NEW=''FARM'' THEN ''R.F.D'' 

WHEN A1.LOB_CD_NEW=''MACHINE'' THEN ''MACHINERY'' 

WHEN A1.LOB_CD_NEW=''MANHOME'' THEN ''MOBILE HOME''

WHEN A1.LOB_CD_NEW=''SCHDPROP'' AND POL_TYPE = ''B'' THEN ''WATERCRAFT'' 

WHEN A1.LOB_CD_NEW=''SCHDPROP'' AND POL_TYPE = ''S'' THEN ''PAF''

WHEN A1.LOB_CD_NEW=''FARMCOMP'' THEN ''F.C.L'' 

WHEN A1.LOB_CD_NEW=''COMPPERS'' THEN ''C.P.L''

WHEN A1.LOB_CD_NEW=''GENLIAB'' AND POL_TYPE = ''FARM'' THEN ''G.L - FARM''

WHEN A1.LOB_CD_NEW=''GENLIAB'' AND (POL_TYPE = ''PERSONAL'' OR POL_TYPE = '''') THEN ''G.L - PERSONAL''

WHEN A1.LOB_CD_NEW=''GENLIAB'' AND POL_TYPE = ''COMMERCIAL'' THEN ''G.L - COMMERCIAL''

WHEN A1.LOB_CD_NEW=''PORTFLIO'' THEN ''PORTFOLIO''

WHEN A1.LOB_CD_NEW=''BOCHURCH'' AND A1.POL_TYPE = ''C'' THEN ''CHURCH'' 

WHEN A1.LOB_CD_NEW=''BOCHURCH'' AND A1.POL_TYPE = ''B'' THEN ''BUSINESS OWNER'' 

WHEN A1.LOB_CD_NEW=''WORKCOMP'' THEN ''WORKCOMP''

ELSE A1.LOB_CD_NEW END LOB_DESC, 

CAST( CASE 

WHEN A1.LOB_CD_NEW = ''AUTO'' AND A1.MASTER_COMPANY_NBR_NEW=10 THEN 1

WHEN A1.LOB_CD_NEW = ''AUTO'' AND A1.MASTER_COMPANY_NBR_NEW=70 THEN 2

WHEN A1.LOB_CD_NEW = ''AUTO'' AND A1.MASTER_COMPANY_NBR_NEW=40 THEN 3

WHEN A1.LOB_CD_NEW = ''AUTO'' AND A1.MASTER_COMPANY_NBR_NEW=50 THEN 4

WHEN A1.LOB_CD_NEW = ''FIRE'' AND A1.MASTER_COMPANY_NBR_NEW=60 AND A1.POL_TYPE='''' THEN 5

WHEN A1.LOB_CD_NEW = ''FIRE'' AND A1.MASTER_COMPANY_NBR_NEW=60 AND A1.POL_TYPE=''F''THEN 6

WHEN A1.LOB_CD_NEW = ''FIRE'' AND A1.MASTER_COMPANY_NBR_NEW=40 AND A1.POL_TYPE='''' THEN 7

WHEN A1.LOB_CD_NEW = ''FIRE'' AND A1.MASTER_COMPANY_NBR_NEW=40 AND A1.POL_TYPE=''F'' THEN 8

WHEN A1.LOB_CD_NEW = ''HOME'' AND A1.MASTER_COMPANY_NBR_NEW=10 AND A1.POL_TYPE='''' THEN 9 

WHEN A1.LOB_CD_NEW = ''HOME'' AND A1.MASTER_COMPANY_NBR_NEW=10 AND A1.POL_TYPE=''H'' THEN 10 

WHEN A1.LOB_CD_NEW = ''HOME'' AND A1.MASTER_COMPANY_NBR_NEW=70 AND A1.POL_TYPE=''''THEN 11

WHEN A1.LOB_CD_NEW = ''HOME'' AND A1.MASTER_COMPANY_NBR_NEW=40 AND A1.POL_TYPE=''''THEN 12

WHEN A1.LOB_CD_NEW = ''HOME'' AND A1.MASTER_COMPANY_NBR_NEW=40 AND A1.POL_TYPE = ''H'' THEN 13 

WHEN A1.LOB_CD_NEW = ''HOME'' AND A1.MASTER_COMPANY_NBR_NEW=50 AND A1.POL_TYPE='''' THEN 14

WHEN A1.LOB_CD_NEW = ''HOME'' AND A1.MASTER_COMPANY_NBR_NEW=50 AND A1.POL_TYPE=''D'' THEN 15 

WHEN A1.LOB_CD_NEW=''FARM'' THEN 16

WHEN A1.LOB_CD_NEW=''MACHINE'' THEN 17

WHEN A1.LOB_CD_NEW=''MANHOME'' THEN 18

WHEN A1.LOB_CD_NEW=''SCHDPROP'' AND POL_TYPE = ''B'' THEN 19

WHEN A1.LOB_CD_NEW=''SCHDPROP'' AND POL_TYPE = ''S'' THEN 20 

WHEN A1.LOB_CD_NEW=''FARMCOMP'' THEN 21

WHEN A1.LOB_CD_NEW=''COMPPERS'' THEN 22 

WHEN A1.LOB_CD_NEW=''GENLIAB'' AND POL_TYPE = ''FARM'' THEN 23

WHEN A1.LOB_CD_NEW=''GENLIAB'' AND (POL_TYPE = ''PERSONAL'' OR POL_TYPE = '''') THEN 24

WHEN A1.LOB_CD_NEW=''GENLIAB'' AND POL_TYPE = ''COMMERCIAL'' THEN 25

WHEN A1.LOB_CD_NEW=''PORTFLIO'' THEN 26

WHEN A1.LOB_CD_NEW=''BOCHURCH'' AND A1.POL_TYPE = ''C'' THEN 27

WHEN A1.LOB_CD_NEW=''BOCHURCH'' AND A1.POL_TYPE = ''B'' THEN 28

WHEN A1.LOB_CD_NEW=''WORKCOMP'' THEN 29

ELSE NULL END AS INTEGER) LOB_CD_NEW_SR,

POL_TYPE,

REASON_NEW,

SUM(PLCY_CNT_BEG_IFO) "DB_T_CORE_DM_PROD.policy Beginning Inforce",

SUM(PLCY_IFO_NEW_BUSI) "DB_T_CORE_DM_PROD.policy New Business",

SUM(PLCY_C2C_NEW_BUSI) "DB_T_CORE_DM_PROD.policy C2C New Business",

SUM(UNIT_C2C_NEW_BUSI) "Unit C2C New Business",

SUM(PLCY_RINSTMT) "DB_T_CORE_DM_PROD.policy Reinstatements",

SUM(HO_PLCY_FORM_CHG_RINSTMT) "Home Form Change Reactivates",

SUM(PLCY_CNT_LAPS) "DB_T_CORE_DM_PROD.policy Lapses", 

SUM(PLCY_CNT_LAPS_CNVRSN) "DB_T_CORE_DM_PROD.policy Lapses due to Conversion", 

SUM(PLCY_CNT_CANC) "DB_T_CORE_DM_PROD.policy Cancels",

SUM(PLCY_CNT_CANC_CNVRSN) "DB_T_CORE_DM_PROD.policy Cancels due to Conversion",

SUM(HO_PLCY_FORM_CHG_CANC) "Home Form Change Cancellations" ,

SUM(PLCY_C2C_CANC) "DB_T_CORE_DM_PROD.policy C2C Cancels", 

SUM(UNIT_C2C_CANC) "Unit C2C Cancels", 

SUM(PLCY_C2C_UNIT_CANC) "DB_T_CORE_DM_PROD.policy Unit C2C Cancels",

SUM(UNIT_CNT_BEG_IFO) "Units Beginning Inforce",

SUM(UNIT_IFO_NEW_BUSI) "Units Added",

SUM(UNIT_RINSTMT) "Unit Reactivates",

SUM(UNIT_CNT_CANC) "Unit Cancels",

SUM(UNIT_CNT_CANC_CNVRSN) "Unit Cancels due to Conversion" 

FROM 

( SELECT 

CURR.ST_CD ST_CD_NEW,

CURR.MASTER_COMPANY_NBR MASTER_COMPANY_NBR_NEW,

CURR.LOB_CD LOB_CD_NEW,

CURR.FEED_DT FEED_DT_NEW, 

CASE WHEN CURR.LOB_CD=''GENLIAB'' THEN COALESCE(SM.SMLN_GL_COV_TYPE,FGM.FGM_GL_COV_TYPE,'''') 

WHEN CURR.LOB_CD IN (''HOME'',''FIRE'') THEN CURR.FIRE_HOME_TYPE_POL

WHEN CURR.LOB_CD = ''BOCHURCH'' THEN CURR.SM_POL_IND

WHEN CURR.LOB_CD = ''SCHDPROP'' THEN COALESCE(SM.SMLN_POL_TYPE,''B'') 

ELSE NULL END POL_TYPE,

CURR.REASON REASON_NEW,

LTRIM (CURR.AGENT, ''0'') AS AGENCY_NBR,

LTRIM(CURR.PLCY_SVC_NBR, ''0'') SALES_SVC_CD,

/* Beginning Inforce Policies */

SUM(0) PLCY_CNT_BEG_IFO,

/* New Business Policies */

SUM(CASE 

WHEN CURR.LOB_CD=''SCHDPROP'' AND CURR.POLICY_ACTIVITY =''NEW'' THEN 1 

WHEN CURR.LOB_CD<>''SCHDPROP'' AND 

((PREV.PLCY_NBR IS NULL) OR (CURR.POLICY_ACTIVITY =''NEW'' AND CURR.STATUS_OGN_EFF_DT = CURR.FEED_DT)) 

THEN 1 ELSE 0 END) PLCY_IFO_NEW_BUSI,

/* Sum of PLCY_C2C_CANC and PLCY_C2C_UNIT_CANC should be closely same as PLCY_C2C_NEW_BUSI */

SUM(CASE 

WHEN PREV.PLCY_NBR IS NULL AND AUT_QUOTE_NB.POL_NBR IS NOT NULL THEN 1 ELSE 0 END) PLCY_C2C_NEW_BUSI,

SUM(CASE 

WHEN PREV.PLCY_NBR IS NULL AND AUT_QUOTE_NB.POL_NBR IS NOT NULL THEN CURR.INF_UNIT_CTS ELSE 0 END) UNIT_C2C_NEW_BUSI,

/* Reactivated Policies*/

SUM(CASE WHEN CURR.POLICY_ACTIVITY =''REIN'' AND CURR.STATUS_OGN_EFF_DT = CURR.FEED_DT THEN 1 ELSE 0 END) PLCY_RINSTMT,

/* Homeowner DB_T_CORE_DM_PROD.policy form change is getting counted as reinstatements in MM361 .HO_PLCY_FORM_CHG +PLCY_RINSTMT should be equal to Homeowner reinstatements in MM361 */

SUM(CASE WHEN CURR.LOB_CD IN (''HOME'',''FIRE'') AND CURR.FIRE_HOME_TYPE_POL <> PREV.FIRE_HOME_TYPE_POL AND PREV.POLICY_ACTIVITY NOT IN (''CANC'',''LCANC'') THEN 1 ELSE 0 END) HO_PLCY_FORM_CHG_RINSTMT,

/* Lapsed Policies*/

SUM(CASE WHEN CURR.POLICY_ACTIVITY =''LCANC'' AND CURR.STATUS_OGN_EFF_DT = CURR.FEED_DT 

AND PREV.POLICY_ACTIVITY IN (''NEW'',''INFR'',''REIN'',''LAPS'') THEN 1 ELSE 0 END) PLCY_CNT_LAPS, /*  Neglecting those rows whose previous rows are cancellations */
/* Converted/Lapsed Policies*/

SUM(CASE WHEN CURR.POLICY_ACTIVITY =''LCANC'' AND CURR.STATUS_OGN_EFF_DT = CURR.FEED_DT 

AND PREV.POLICY_ACTIVITY IN (''NEW'',''INFR'',''REIN'',''LAPS'') AND EDW.HOST_AGMT_NUM IS NOT NULL THEN 1 ELSE 0 END) PLCY_CNT_LAPS_CNVRSN, /*  Neglecting those rows whose previous rows are cancellations */
/* Cancelled Policies*/

SUM(CASE WHEN CURR.POLICY_ACTIVITY =''CANC'' AND CURR.LOB_CD = ''AUTO'' AND CURR.STATUS_OGN_EFF_DT = CURR.FEED_DT THEN 1 

WHEN CURR.POLICY_ACTIVITY =''CANC'' AND CURR.LOB_CD <> ''AUTO'' AND CURR.STATUS_OGN_EFF_DT = CURR.FEED_DT 

AND (PREV.STATUS IN (0,10,20,21,40) OR PREV.PLCY_NBR IS NULL ) THEN 1 

ELSE 0 END) PLCY_CNT_CANC, 

/* Converted/Cancelled Policies*/

SUM(CASE WHEN CURR.POLICY_ACTIVITY =''CANC'' AND CURR.LOB_CD = ''AUTO'' AND CURR.STATUS_OGN_EFF_DT = CURR.FEED_DT AND EDW.HOST_AGMT_NUM IS NOT NULL THEN 1 

WHEN CURR.POLICY_ACTIVITY =''CANC'' AND CURR.LOB_CD <> ''AUTO'' AND CURR.STATUS_OGN_EFF_DT = CURR.FEED_DT 

AND (PREV.STATUS IN (0,10,20,21,40) OR PREV.PLCY_NBR IS NULL ) AND EDW.HOST_AGMT_NUM IS NOT NULL THEN 1 ELSE 0 END) PLCY_CNT_CANC_CNVRSN, 

SUM(0) HO_PLCY_FORM_CHG_CANC,

/* The policies which are cancelled (cancelled at DB_T_CORE_DM_PROD.policy level i.e all units in the DB_T_CORE_DM_PROD.policy are cancelled) for the current month and whose members having new business policies with C2C DB_T_CORE_DM_PROD.discount effective in the current month are considered here. */

SUM(CASE WHEN CURR.POLICY_ACTIVITY =''CANC'' AND CURR.STATUS_OGN_EFF_DT = CURR.FEED_DT 

AND AUT_QUOTE_CANC.POL_NBR IS NOT NULL THEN 1 ELSE 0 END) PLCY_C2C_CANC, 

SUM(CASE 

WHEN CURR.POLICY_ACTIVITY IN (''CANC'') AND CURR.LOB_CD = ''AUTO'' AND PREV.POLICY_ACTIVITY IN (''CANC'') AND AUT_QUOTE_CANC.POL_NBR IS NOT NULL THEN 0 

WHEN CURR.POLICY_ACTIVITY IN (''CANC'') AND CURR.LOB_CD = ''AUTO'' AND PREV.POLICY_ACTIVITY NOT IN (''CANC'') AND AUT_QUOTE_CANC.POL_NBR IS NOT NULL THEN PREV.INF_UNIT_CTS 

WHEN CURR.POLICY_ACTIVITY IN (''INFR'') AND CURR.LOB_CD = ''AUTO'' AND PREV.POLICY_ACTIVITY IN (''NEW'',''INFR'',''REIN'') 

AND CURR.INF_UNIT_CTS<PREV.INF_UNIT_CTS AND AUT_QUOTE_CANC.POL_NBR IS NOT NULL THEN PREV.INF_UNIT_CTS-CURR.INF_UNIT_CTS ELSE 0 END ) UNIT_C2C_CANC,

/* The policies which are inforce ( but few units in the DB_T_CORE_DM_PROD.policy are cancelled) for the current month and whose members having new business policies with C2C DB_T_CORE_DM_PROD.discount effective in the current month are considered here. */

COUNT(DISTINCT CASE 

WHEN CURR.POLICY_ACTIVITY IN (''INFR'') AND CURR.LOB_CD = ''AUTO'' AND PREV.POLICY_ACTIVITY IN (''NEW'',''INFR'',''REIN'') 

AND CURR.INF_UNIT_CTS<PREV.INF_UNIT_CTS AND AUT_QUOTE_CANC.POL_NBR IS NOT NULL THEN CURR.PLCY_NBR ELSE NULL END ) PLCY_C2C_UNIT_CANC,

/* Beginning Inforce Units*/ 

SUM(0) UNIT_CNT_BEG_IFO,

/* New Business Units */

SUM(CASE WHEN CURR.POLICY_ACTIVITY = ''NEW'' AND CURR.LOB_CD = ''AUTO'' THEN CURR.INF_UNIT_CTS

WHEN CURR.POLICY_ACTIVITY = ''INFR'' AND CURR.LOB_CD = ''AUTO'' AND PREV.POLICY_ACTIVITY IN (''NEW'',''INFR'',''REIN'') 

AND CURR.INF_UNIT_CTS>PREV.INF_UNIT_CTS THEN CURR.INF_UNIT_CTS-PREV.INF_UNIT_CTS ELSE 0 END) UNIT_IFO_NEW_BUSI,

/* Reactivated Units*/

SUM(CASE WHEN CURR.POLICY_ACTIVITY =''REIN'' AND CURR.LOB_CD = ''AUTO'' 

AND CURR.STATUS_OGN_EFF_DT = CURR.FEED_DT THEN CURR.INF_UNIT_CTS ELSE 0 END) UNIT_RINSTMT,

/* Cancelled Units*/

SUM(CASE 

WHEN CURR.POLICY_ACTIVITY IN (''CANC'') AND CURR.LOB_CD = ''AUTO'' AND PREV.POLICY_ACTIVITY IN (''CANC'') THEN 0 

WHEN CURR.POLICY_ACTIVITY IN (''CANC'') AND CURR.LOB_CD = ''AUTO'' AND PREV.POLICY_ACTIVITY NOT IN (''CANC'') THEN PREV.INF_UNIT_CTS 

WHEN CURR.POLICY_ACTIVITY IN (''INFR'') AND CURR.LOB_CD = ''AUTO'' AND PREV.POLICY_ACTIVITY IN (''NEW'',''INFR'',''REIN'')  

AND CURR.INF_UNIT_CTS<PREV.INF_UNIT_CTS THEN PREV.INF_UNIT_CTS-CURR.INF_UNIT_CTS ELSE 0 END ) UNIT_CNT_CANC,

/* Cancelled Units*/

SUM(CASE 

WHEN CURR.POLICY_ACTIVITY IN (''CANC'') AND CURR.LOB_CD = ''AUTO'' AND PREV.POLICY_ACTIVITY IN (''CANC'') AND EDW.HOST_AGMT_NUM IS NOT NULL THEN 0 

WHEN CURR.POLICY_ACTIVITY IN (''CANC'') AND CURR.LOB_CD = ''AUTO'' AND PREV.POLICY_ACTIVITY NOT IN (''CANC'') AND EDW.HOST_AGMT_NUM IS NOT NULL THEN PREV.INF_UNIT_CTS 

WHEN CURR.POLICY_ACTIVITY IN (''INFR'') AND CURR.LOB_CD = ''AUTO'' AND PREV.POLICY_ACTIVITY IN (''NEW'',''INFR'',''REIN'') AND EDW.HOST_AGMT_NUM IS NOT NULL 

AND CURR.INF_UNIT_CTS<PREV.INF_UNIT_CTS THEN PREV.INF_UNIT_CTS-CURR.INF_UNIT_CTS ELSE 0 END ) UNIT_CNT_CANC_CNVRSN 

FROM 

/* The inline query ''DT'' is used to pass the monthid''s for which the history load is required */

DB_T_ML_PROD.MULTILINE_POLSTAT CURR 

/* The ''PREV'' table is used to get the prior month details for all the policies */

LEFT OUTER JOIN 

DB_T_ML_PROD.MULTILINE_POLSTAT PREV

ON CURR.PLCY_NBR = PREV.PLCY_NBR AND 

CURR.PLCY_CHG_EFF_DT-1 = PREV.PLCY_CHG_EXP_DT 

LEFT OUTER JOIN 

/* The inline query ''AUT_QUOTE_NB'' gives the new buisness policies having C2C DB_T_CORE_DM_PROD.discount */ 

(SELECT ML.FEED_DT,ML.PLCY_NBR AS POL_NBR FROM 

(SELECT CURR.MASTER_COMPANY_NBR,

CURR.FEED_DT ,

CURR.EFF_DT,

CURR.ALFA_CUST_MEMB_NBR,

CURR.ALFA_CUST_MEMB_TYPE,

CURR.PLCY_NBR 

FROM DB_T_ML_PROD.MULTILINE_POLSTAT CURR 

LEFT OUTER JOIN 

DB_T_ML_PROD.MULTILINE_POLSTAT PREV

ON CURR.PLCY_NBR = PREV.PLCY_NBR

AND CURR.PLCY_CHG_EFF_DT-1 = PREV.PLCY_CHG_EXP_DT

WHERE ((PREV.PLCY_NBR IS NULL) OR (CURR.POLICY_ACTIVITY =''NEW'' AND CURR.STATUS_OGN_EFF_DT = CURR.FEED_DT))

AND CURR.LOB_CD = ''AUTO'' 

AND CURR.FEED_DT = (SELECT CAL_END_DATE FROM ECTL_PARAM_DATE)

GROUP BY 1,2,3,4,5,6 ) ML 

LEFT OUTER JOIN 

(SELECT CURR.MASTER_COMPANY_NBR,CURR.FEED_DT ,CURR.EFF_DT,CURR.EXP_DT,CURR.ALFA_CUST_MEMB_NBR,CURR.ALFA_CUST_MEMB_TYPE,CURR.PLCY_NBR 

FROM DB_T_ML_PROD.MULTILINE_POLSTAT CURR 

WHERE CURR.LOB_CD = ''AUTO'' AND (CURR.POLICY_ACTIVITY =''CANC'' AND CURR.STATUS_OGN_EFF_DT = CURR.FEED_DT )

AND CURR.FEED_DT = (SELECT CAL_END_DATE FROM ECTL_PARAM_DATE)

GROUP BY 1,2,3,4,5,6,7) POL_C

ON ML.ALFA_CUST_MEMB_NBR = POL_C.ALFA_CUST_MEMB_NBR 

AND ML.ALFA_CUST_MEMB_TYPE = POL_C.ALFA_CUST_MEMB_TYPE 

AND ML.FEED_DT = POL_C.FEED_DT 

AND ML.MASTER_COMPANY_NBR <> POL_C.MASTER_COMPANY_NBR 

LEFT OUTER JOIN 

(SELECT CURR.MASTER_COMPANY_NBR,CURR.FEED_DT ,CURR.EFF_DT,CURR.EXP_DT,CURR.ALFA_CUST_MEMB_NBR,CURR.ALFA_CUST_MEMB_TYPE,CURR.PLCY_NBR 

FROM DB_T_ML_PROD.MULTILINE_POLSTAT CURR 

LEFT OUTER JOIN 

DB_T_ML_PROD.MULTILINE_POLSTAT PREV

ON CURR.PLCY_NBR = PREV.PLCY_NBR

AND CURR.PLCY_CHG_EFF_DT-1 = PREV.PLCY_CHG_EXP_DT

WHERE CURR.LOB_CD = ''AUTO'' 

AND (CURR.POLICY_ACTIVITY IN (''INFR'') AND CURR.LOB_CD = ''AUTO'' AND PREV.POLICY_ACTIVITY IN (''NEW'',''INFR'',''REIN'') AND CURR.INF_UNIT_CTS<PREV.INF_UNIT_CTS)

AND CURR.FEED_DT = (SELECT CAL_END_DATE FROM ECTL_PARAM_DATE)

GROUP BY 1,2,3,4,5,6,7) POL_U

ON ML.ALFA_CUST_MEMB_NBR = POL_U.ALFA_CUST_MEMB_NBR 

AND ML.ALFA_CUST_MEMB_TYPE = POL_U.ALFA_CUST_MEMB_TYPE 

AND ML.FEED_DT = POL_U.FEED_DT 

AND ML.MASTER_COMPANY_NBR <> POL_U.MASTER_COMPANY_NBR 

WHERE POL_C.PLCY_NBR IS NOT NULL OR POL_U.PLCY_NBR IS NOT NULL

GROUP BY 1,2) AUT_QUOTE_NB

ON CURR.LOB_CD = ''AUTO'' 

AND CURR.PLCY_NBR = AUT_QUOTE_NB.POL_NBR 

AND CURR.FEED_DT = AUT_QUOTE_NB.FEED_DT 

LEFT OUTER JOIN 

/* The inline query ''AUT_QUOTE_CANC'' gives the DB_T_STAG_MEMBXREF_PROD.member which have at least one new buisness DB_T_CORE_DM_PROD.policy with C2C DB_T_CORE_DM_PROD.discount */ 

(SELECT ML.FEED_DT,ML.PLCY_NBR AS POL_NBR FROM 

(SELECT CURR.MASTER_COMPANY_NBR,CURR.FEED_DT ,CURR.EFF_DT,CURR.EXP_DT,CURR.ALFA_CUST_MEMB_NBR,CURR.ALFA_CUST_MEMB_TYPE,CURR.PLCY_NBR 

FROM DB_T_ML_PROD.MULTILINE_POLSTAT CURR 

LEFT OUTER JOIN 

DB_T_ML_PROD.MULTILINE_POLSTAT PREV

ON CURR.PLCY_NBR = PREV.PLCY_NBR

AND CURR.PLCY_CHG_EFF_DT-1 = PREV.PLCY_CHG_EXP_DT 

WHERE CURR.LOB_CD = ''AUTO'' AND 

((CURR.POLICY_ACTIVITY =''CANC'' AND CURR.STATUS_OGN_EFF_DT = CURR.FEED_DT) 

OR (CURR.POLICY_ACTIVITY IN (''INFR'') AND PREV.POLICY_ACTIVITY IN (''NEW'',''INFR'',''REIN'') AND CURR.INF_UNIT_CTS<PREV.INF_UNIT_CTS))

AND CURR.FEED_DT = (SELECT CAL_END_DATE FROM ECTL_PARAM_DATE)

GROUP BY 1,2,3,4,5,6,7 ) ML 

INNER JOIN 

(SELECT CURR.MASTER_COMPANY_NBR,CURR.FEED_DT ,CURR.EFF_DT,CURR.EXP_DT,CURR.ALFA_CUST_MEMB_NBR,CURR.ALFA_CUST_MEMB_TYPE,CURR.PLCY_NBR 

FROM DB_T_ML_PROD.MULTILINE_POLSTAT CURR 

LEFT OUTER JOIN DB_T_ML_PROD.MULTILINE_POLSTAT PREV

ON CURR.PLCY_NBR = PREV.PLCY_NBR AND CURR.PLCY_CHG_EFF_DT-1 = PREV.PLCY_CHG_EXP_DT

WHERE CURR.LOB_CD = ''AUTO'' AND ((PREV.PLCY_NBR IS NULL) OR (CURR.POLICY_ACTIVITY =''NEW'' AND CURR.STATUS_OGN_EFF_DT = CURR.FEED_DT))

AND CURR.FEED_DT = (SELECT CAL_END_DATE FROM ECTL_PARAM_DATE)

GROUP BY 1,2,3,4,5,6,7) POL_C

ON ML.ALFA_CUST_MEMB_NBR = POL_C.ALFA_CUST_MEMB_NBR 

AND ML.ALFA_CUST_MEMB_TYPE = POL_C.ALFA_CUST_MEMB_TYPE 

AND ML.FEED_DT = POL_C.FEED_DT 

AND ML.MASTER_COMPANY_NBR <> POL_C.MASTER_COMPANY_NBR 

GROUP BY 1,2) AUT_QUOTE_CANC

ON CURR.LOB_CD = ''AUTO'' 

AND CURR.PLCY_NBR = AUT_QUOTE_CANC.POL_NBR 

AND CURR.FEED_DT = AUT_QUOTE_CANC.FEED_DT 

LEFT OUTER JOIN 

(SELECT A.SC_POLICY_NUM,A.FGM_GL_COV_TYPE,A.FGM_SM_POLICY_IND, A.LOAD_MO_ID ST_MO_ID,

COALESCE(
  DATE_PART (
    ''year'',
    DATEADD (
      MONTH,
      -1,
      TO_DATE (CAST(B.LOAD_MO_ID AS VARCHAR), ''yyyymm'')
    )
  ) * 100 + DATE_PART (
    ''month'',
    DATEADD (
      MONTH,
      -1,
      TO_DATE (CAST(B.LOAD_MO_ID AS VARCHAR), ''yyyymm'')
    )
  ),
  999912
) AS END_MO_ID

FROM (SELECT SC_POLICY_NUM,FGM_GL_COV_TYPE,FGM_SM_POLICY_IND,LOAD_DT, 

EXTRACT(YEAR FROM LOAD_DT)*100+ EXTRACT(MONTH FROM LOAD_DT) LOAD_MO_ID, 

ROW_NUMBER() OVER(PARTITION BY SC_POLICY_NUM ORDER BY LOAD_DT ASC) RNK

FROM ESTAGMEMBDB_LGCY.STG_FGMPOLS) A LEFT OUTER JOIN 

(SELECT SC_POLICY_NUM,FGM_GL_COV_TYPE,FGM_SM_POLICY_IND,LOAD_DT, 

EXTRACT(YEAR FROM LOAD_DT)*100+ EXTRACT(MONTH FROM LOAD_DT) LOAD_MO_ID, 

ROW_NUMBER() OVER(PARTITION BY SC_POLICY_NUM ORDER BY LOAD_DT ASC) RNK

FROM ESTAGMEMBDB_LGCY.STG_FGMPOLS) B

ON A.SC_POLICY_NUM = B.SC_POLICY_NUM AND A.RNK+1 = B.RNK

LEFT OUTER JOIN ECTL_PARAM_DATE DT ON 1=1 

WHERE CAL_MO_ID BETWEEN ST_MO_ID AND END_MO_ID

) FGM

ON TRIM(CURR.PLCY_NBR) = FGM.SC_POLICY_NUM AND CURR.LOB_CD = ''GENLIAB'' 

LEFT OUTER JOIN 

(SELECT A.SC_POLICY_NUM,A.SMLN_GL_COV_TYPE,A.SMLN_POL_TYPE, A.LOAD_MO_ID ST_MO_ID,

COALESCE(
  DATE_PART (
    ''year'',
    DATEADD (
      MONTH,
      -1,
      TO_DATE (CAST(B.LOAD_MO_ID AS VARCHAR), ''yyyymm'')
    )
  ) * 100 + DATE_PART (
    ''month'',
    DATEADD (
      MONTH,
      -1,
      TO_DATE (CAST(B.LOAD_MO_ID AS VARCHAR), ''yyyymm'')
    )
  ),
  999912
) AS END_MO_ID

FROM (SELECT SC_POLICY_NUM,SMLN_GL_COV_TYPE,SMLN_POL_TYPE,LOAD_DT, 

EXTRACT(YEAR FROM LOAD_DT)*100+ EXTRACT(MONTH FROM LOAD_DT) LOAD_MO_ID, 

ROW_NUMBER() OVER(PARTITION BY SC_POLICY_NUM ORDER BY LOAD_DT ASC) RNK

FROM ESTAGMEMBDB_LGCY.STG_SMLNPOLS) A LEFT OUTER JOIN 

(SELECT SC_POLICY_NUM,SMLN_GL_COV_TYPE,SMLN_POL_TYPE,LOAD_DT, 

EXTRACT(YEAR FROM LOAD_DT)*100+ EXTRACT(MONTH FROM LOAD_DT) LOAD_MO_ID, 

ROW_NUMBER() OVER(PARTITION BY SC_POLICY_NUM ORDER BY LOAD_DT ASC) RNK

FROM ESTAGMEMBDB_LGCY.STG_SMLNPOLS) B

ON A.SC_POLICY_NUM = B.SC_POLICY_NUM AND A.RNK+1 = B.RNK 

LEFT OUTER JOIN ECTL_PARAM_DATE DT ON 1=1 

WHERE CAL_MO_ID BETWEEN ST_MO_ID AND END_MO_ID

) SM

ON TRIM(CURR.PLCY_NBR) = SM.SC_POLICY_NUM AND CURR.LOB_CD IN (''GENLIAB'',''SCHDPROP'')

LEFT OUTER JOIN 

(SELECT HOST_AGMT_NUM FROM DB_T_PROD_CORE.AGMT WHERE AGMT_TYPE_CD = ''PPV'' AND CAST(MODL_EFF_DTTM AS DATE)<=(SELECT CAL_END_DATE FROM ECTL_PARAM_DATE) GROUP BY 1) EDW 

ON TRIM(CURR.PLCY_NBR) = EDW.HOST_AGMT_NUM 

WHERE LOB_CD_NEW IS NOT NULL AND CURR.FEED_DT =(SELECT CAL_END_DATE FROM ECTL_PARAM_DATE)

GROUP BY 1,2,3,4,5,6,7,8 

HAVING 

COALESCE(PLCY_IFO_NEW_BUSI,0) + 

COALESCE(PLCY_C2C_NEW_BUSI,0) + 

COALESCE(UNIT_C2C_NEW_BUSI,0) + 

COALESCE(PLCY_RINSTMT,0) + 

COALESCE(PLCY_CNT_LAPS,0) + 

COALESCE(PLCY_CNT_LAPS_CNVRSN,0) + 

COALESCE(PLCY_CNT_CANC,0) + 

COALESCE(PLCY_CNT_CANC_CNVRSN,0) + 

COALESCE(PLCY_C2C_CANC,0) + 

COALESCE(UNIT_C2C_CANC,0) + 

COALESCE(UNIT_IFO_NEW_BUSI,0) + 

COALESCE(UNIT_RINSTMT,0) + 

COALESCE(UNIT_CNT_CANC,0) + 

COALESCE(UNIT_CNT_CANC_CNVRSN,0) + 

COALESCE(PLCY_C2C_UNIT_CANC,0)+

COALESCE(HO_PLCY_FORM_CHG_RINSTMT,0) >0 

UNION ALL

SELECT 

PREV.ST_CD ST_CD_NEW,

PREV.MASTER_COMPANY_NBR MASTER_COMPANY_NBR_NEW,

PREV.LOB_CD LOB_CD_NEW,

CURR.FEED_DT FEED_DT_NEW, 

PREV.FIRE_HOME_TYPE_POL POL_TYPE,

PREV.REASON,

LTRIM( PREV.AGENT,''0'') AGENCY_NBR,

TRIM(PREV.PLCY_SVC_NBR,''0'') SALES_SVC_CD,

SUM(0) PLCY_CNT_BEG_IFO,

SUM(0) PLCY_IFO_NEW_BUSI,

SUM(0) PLCY_C2C_NEW_BUSI,

SUM(0) UNIT_C2C_NEW_BUSI,

SUM(0) PLCY_RINSTMT,

SUM(0) HO_PLCY_FORM_CHG_RINSTMT,

SUM(0) PLCY_CNT_LAPS,

SUM(0) PLCY_CNT_LAPS_CNVRSN,

SUM(0) PLCY_CNT_CANC, 

SUM(0) PLCY_CNT_CANC_CNVRSN, 

/* Homeowner DB_T_CORE_DM_PROD.policy form change is getting counted as Cancellations in MM361 .HO_PLCY_FORM_CHG_CANC +PLCY_CNT_CANC should be equal to Homeowner cancellations in MM361 */

SUM(1) HO_PLCY_FORM_CHG_CANC ,

SUM(0) PLCY_C2C_CANC, 

SUM(0) UNIT_C2C_CANC, 

SUM(0) PLCY_C2C_UNIT_CANC,

SUM(0) UNIT_CNT_BEG_IFO,

SUM(0) UNIT_IFO_NEW_BUSI,

SUM(0) UNIT_RINSTMT,

SUM(0) UNIT_CNT_CANC,

SUM(0) UNIT_CNT_CANC_CNVRSN 

FROM 

/* The inline query ''DT'' is used to pass the monthid''s for which the history load is required */

DB_T_ML_PROD.MULTILINE_POLSTAT CURR 

/* The ''PREV'' table is used to get the prior month details for all the policies */

LEFT OUTER JOIN 

DB_T_ML_PROD.MULTILINE_POLSTAT PREV

ON CURR.PLCY_NBR = PREV.PLCY_NBR

AND CURR.PLCY_CHG_EFF_DT-1 = PREV.PLCY_CHG_EXP_DT

WHERE CURR.LOB_CD IN (''HOME'',''FIRE'') AND CURR.FIRE_HOME_TYPE_POL <> PREV.FIRE_HOME_TYPE_POL 

AND PREV.POLICY_ACTIVITY NOT IN (''CANC'',''LCANC'') 

AND CURR.FEED_DT = (SELECT CAL_END_DATE FROM ECTL_PARAM_DATE)

GROUP BY 1,2,3,4,5,6,7,8 

HAVING HO_PLCY_FORM_CHG_CANC>0 

UNION ALL

SELECT 

IFO.ST_CD ST_CD_NEW,

IFO.MASTER_COMPANY_NBR MASTER_COMPANY_NBR_NEW,

IFO.LOB_CD LOB_CD_NEW,

B.CAL_END_DATE FEED_DT_NEW, 

CASE WHEN IFO.LOB_CD=''GENLIAB'' THEN COALESCE(SM.SMLN_GL_COV_TYPE,FGM.FGM_GL_COV_TYPE,'''') 

WHEN IFO.LOB_CD IN (''HOME'',''FIRE'') THEN IFO.FIRE_HOME_TYPE_POL

WHEN IFO.LOB_CD = ''BOCHURCH'' THEN IFO.SM_POL_IND

WHEN IFO.LOB_CD = ''SCHDPROP'' THEN COALESCE(SM.SMLN_POL_TYPE,''B'') 

ELSE NULL END POL_TYPE, 

IFO.REASON REASON_NE,W,

TRIM(IFO.AGENT,''0'') AGENCY_NBR,

TRIM(IFO.PLCY_SVC_NBR,''0'') SALES_SVC_CD,

/* Beginning Inforce Policies */

SUM(1) PLCY_CNT_BEG_IFO,

SUM(0) PLCY_IFO_NEW_BUSI,

SUM(0) PLCY_C2C_NEW_BUSI,

SUM(0) UNIT_C2C_NEW_BUSI,

SUM(0) PLCY_RINSTMT,

SUM(0) HO_PLCY_FORM_CHG_RINSTMT,

SUM(0) PLCY_CNT_LAPS,

SUM(0) PLCY_CNT_LAPS_CNVRSN,

SUM(0) PLCY_CNT_CANC, 

SUM(0) PLCY_CNT_CANC_CNVRSN, 

SUM(0) HO_PLCY_FORM_CHG_CANC ,

SUM(0) PLCY_C2C_CANC, 

SUM(0) UNIT_C2C_CANC, 

SUM(0) PLCY_C2C_UNIT_CANC,

SUM( CASE WHEN LOB_CD = ''AUTO'' THEN INF_UNIT_CTS ELSE 0 END) UNIT_CNT_BEG_IFO,

SUM(0) UNIT_IFO_NEW_BUSI,

SUM(0) UNIT_RINSTMT,

SUM(0) UNIT_CNT_CANC,

SUM(0) UNIT_CNT_CANC_CNVRSN 

FROM 

/* The inline query ''IFO'' gives the inforce DB_T_CORE_DM_PROD.policy and unit counts for various months from DB_T_SHRD_PROD.DT_DIM */ 

DB_T_ML_PROD.MULTILINE_POLSTAT IFO 

INNER JOIN 

(SELECT CAL_END_DATE FROM ECTL_PARAM_DATE) B 

ON 1=1 

LEFT OUTER JOIN 

(SELECT A.SC_POLICY_NUM,A.FGM_GL_COV_TYPE,A.FGM_SM_POLICY_IND, A.LOAD_MO_ID ST_MO_ID,

COALESCE(
  TO_NUMBER (
    TO_CHAR (
      DATEADD (
        MONTH,
        -1,
        TO_DATE (CAST(B.LOAD_MO_ID AS VARCHAR), ''yyyymm'')
      ),
      ''YYYYMM''
    )
  ),
  999912
) AS END_MO_ID

FROM (SELECT SC_POLICY_NUM,FGM_GL_COV_TYPE,FGM_SM_POLICY_IND,LOAD_DT, 

EXTRACT(YEAR FROM LOAD_DT)*100+ EXTRACT(MONTH FROM LOAD_DT) LOAD_MO_ID, 

ROW_NUMBER() OVER(PARTITION BY SC_POLICY_NUM ORDER BY LOAD_DT ASC) RNK

FROM ESTAGMEMBDB_LGCY.STG_FGMPOLS) A LEFT OUTER JOIN 

(SELECT SC_POLICY_NUM,FGM_GL_COV_TYPE,FGM_SM_POLICY_IND,LOAD_DT, 

EXTRACT(YEAR FROM LOAD_DT)*100+ EXTRACT(MONTH FROM LOAD_DT) LOAD_MO_ID, 

ROW_NUMBER() OVER(PARTITION BY SC_POLICY_NUM ORDER BY LOAD_DT ASC) RNK

FROM ESTAGMEMBDB_LGCY.STG_FGMPOLS) B

ON A.SC_POLICY_NUM = B.SC_POLICY_NUM AND A.RNK+1 = B.RNK

LEFT OUTER JOIN ECTL_PARAM_DATE DT ON 1=1 

WHERE CAL_MO_ID BETWEEN ST_MO_ID AND END_MO_ID

) FGM

ON IFO.PLCY_NBR = FGM.SC_POLICY_NUM AND IFO.LOB_CD = ''GENLIAB''

LEFT OUTER JOIN 

(SELECT A.SC_POLICY_NUM,A.SMLN_GL_COV_TYPE,A.SMLN_POL_TYPE, A.LOAD_MO_ID ST_MO_ID,

COALESCE(
  TO_NUMBER (
    TO_CHAR (
      ADD_MONTHS (
        TO_DATE (CAST(B.LOAD_MO_ID AS VARCHAR), ''yyyymm''),
        -1
      ),
      ''YYYYMM''
    )
  ),
  999912
) AS END_MO_ID

FROM (SELECT SC_POLICY_NUM,SMLN_GL_COV_TYPE,SMLN_POL_TYPE,LOAD_DT, 

EXTRACT(YEAR FROM LOAD_DT)*100+ EXTRACT(MONTH FROM LOAD_DT) LOAD_MO_ID, 

ROW_NUMBER() OVER(PARTITION BY SC_POLICY_NUM ORDER BY LOAD_DT ASC) RNK

FROM ESTAGMEMBDB_LGCY.STG_SMLNPOLS) A LEFT OUTER JOIN 

(SELECT SC_POLICY_NUM,SMLN_GL_COV_TYPE,SMLN_POL_TYPE,LOAD_DT, 

EXTRACT(YEAR FROM LOAD_DT)*100+ EXTRACT(MONTH FROM LOAD_DT) LOAD_MO_ID, 

ROW_NUMBER() OVER(PARTITION BY SC_POLICY_NUM ORDER BY LOAD_DT ASC) RNK

FROM ESTAGMEMBDB_LGCY.STG_SMLNPOLS) B

ON A.SC_POLICY_NUM = B.SC_POLICY_NUM AND A.RNK+1 = B.RNK 

LEFT OUTER JOIN ECTL_PARAM_DATE DT ON 1=1 

WHERE CAL_MO_ID BETWEEN ST_MO_ID AND END_MO_ID

) SM

ON IFO.PLCY_NBR = SM.SC_POLICY_NUM AND IFO.LOB_CD IN (''GENLIAB'',''SCHDPROP'')

WHERE IFO.FEED_DT < B.CAL_END_DATE AND 

IFO.PLCY_CHG_EXP_DT > B.CAL_END_DATE - EXTRACT(DAY FROM B.CAL_END_DATE ) 

AND IFO.INFORCE_IND = ''Y'' 

GROUP BY 1,2,3,4,5,6,7,8 

HAVING COALESCE(PLCY_CNT_BEG_IFO,0)+COALESCE(UNIT_CNT_BEG_IFO,0) >0 

) A1 

INNER JOIN 

(SELECT CAL_MO_ID, CAL_END_DATE FROM ECTL_PARAM_DATE) B 

ON 1=1 

LEFT OUTER JOIN 

(SELECT AGENCY_NBR, SALES_SVC_CD, AGNT_CLIENT_ID,SALES_RGN_CD,SALES_DST_CD FROM DB_T_CORE_PROD.AGENT_HIER A 

INNER JOIN ECTL_PARAM_DATE B 

ON B.CAL_END_DATE BETWEEN A.AGNT_EFF_DT AND A.AGNT_EXPIRY_DT 

QUALIFY RANK() OVER(PARTITION BY AGENCY_NBR, SALES_SVC_CD ORDER BY AGNT_TERMINATION_DT DESC, AGNT_EFF_DT DESC) =1 ) AGNT1

ON A1.AGENCY_NBR = AGNT1.AGENCY_NBR AND A1.SALES_SVC_CD = AGNT1.SALES_SVC_CD

LEFT OUTER JOIN 

(SELECT AGENCY_NBR, SALES_SVC_CD, AGNT_CLIENT_ID,SALES_RGN_CD,SALES_DST_CD FROM DB_T_CORE_PROD.AGENT_HIER A 

INNER JOIN ECTL_PARAM_DATE B

ON B.CAL_END_DATE BETWEEN A.AGNT_EFF_DT AND A.AGNT_EXPIRY_DT 

QUALIFY RANK() OVER(PARTITION BY AGENCY_NBR ORDER BY AGNT_TERMINATION_DT DESC, AGNT_EFF_DT DESC) =1 ) AGNT2

ON A1.AGENCY_NBR = AGNT2.AGENCY_NBR 

LEFT OUTER JOIN 

(SELECT AGENCY_NBR, SALES_SVC_CD, AGNT_CLIENT_ID,SALES_RGN_CD,SALES_DST_CD FROM DB_T_CORE_PROD.AGENT_HIER A 

QUALIFY RANK() OVER(PARTITION BY AGENCY_NBR ORDER BY ECTL_ORIG_INS_TS DESC) =1 ) AGNT3

ON A1.AGENCY_NBR = AGNT3.AGENCY_NBR

GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13
) SRC
)
);


-- Component Exp_pass_through, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE Exp_pass_through AS
(
SELECT
SQ_AGG_MULTILINE_POLSTAT.MO_ID as MO_ID,
SQ_AGG_MULTILINE_POLSTAT.SALES_ST_CD as SALES_ST_CD,
SQ_AGG_MULTILINE_POLSTAT.SALES_RGN_CD as SALES_RGN_CD,
SQ_AGG_MULTILINE_POLSTAT.SALES_DIST_CD as SALES_DIST_CD,
SQ_AGG_MULTILINE_POLSTAT.SALES_SVC_CD as SALES_SVC_CD,
SQ_AGG_MULTILINE_POLSTAT.AGENCY_NBR as AGENCY_NBR,
SQ_AGG_MULTILINE_POLSTAT.AGNT_CLIENT_ID as AGNT_CLIENT_ID,
SQ_AGG_MULTILINE_POLSTAT.MASTER_COMPANY_NBR as MASTER_COMPANY_NBR,
SQ_AGG_MULTILINE_POLSTAT.LOB_CD as LOB_CD,
SQ_AGG_MULTILINE_POLSTAT.LOB_DESC as LOB_DESC,
SQ_AGG_MULTILINE_POLSTAT.LOB_SORT_CD as LOB_SORT_CD,
SQ_AGG_MULTILINE_POLSTAT.POL_TYPE as POL_TYPE,
SQ_AGG_MULTILINE_POLSTAT.REASON as REASON,
SQ_AGG_MULTILINE_POLSTAT.PLCY_CNT_BEG_IFO as PLCY_CNT_BEG_IFO,
SQ_AGG_MULTILINE_POLSTAT.PLCY_CNT_NEW_BUSI as PLCY_CNT_NEW_BUSI,
SQ_AGG_MULTILINE_POLSTAT.PLCY_C2C_NEW_BUSI as PLCY_C2C_NEW_BUSI,
SQ_AGG_MULTILINE_POLSTAT.UNIT_C2C_NEW_BUSI as UNIT_C2C_NEW_BUSI,
SQ_AGG_MULTILINE_POLSTAT.PLCY_RINSTMT as PLCY_RINSTMT,
SQ_AGG_MULTILINE_POLSTAT.HO_FIRE_PLCY_FORM_CHG_RINSTMT as HO_FIRE_PLCY_FORM_CHG_RINSTMT,
SQ_AGG_MULTILINE_POLSTAT.PLCY_CNT_LAPS as PLCY_CNT_LAPS,
SQ_AGG_MULTILINE_POLSTAT.PLCY_CNT_LAPS_CNVRSN as PLCY_CNT_LAPS_CNVRSN,
SQ_AGG_MULTILINE_POLSTAT.PLCY_CNT_CANC as PLCY_CNT_CANC,
SQ_AGG_MULTILINE_POLSTAT.PLCY_CNT_CANC_CNVRSN as PLCY_CNT_CANC_CNVRSN,
SQ_AGG_MULTILINE_POLSTAT.HO_FIRE_PLCY_FORM_CHG_CANC as HO_FIRE_PLCY_FORM_CHG_CANC,
SQ_AGG_MULTILINE_POLSTAT.PLCY_C2C_CANC as PLCY_C2C_CANC,
SQ_AGG_MULTILINE_POLSTAT.UNIT_C2C_CANC as UNIT_C2C_CANC,
SQ_AGG_MULTILINE_POLSTAT.PLCY_C2C_UNIT_CANC as PLCY_C2C_UNIT_CANC,
SQ_AGG_MULTILINE_POLSTAT.UNIT_CNT_BEG_IFO as UNIT_CNT_BEG_IFO,
SQ_AGG_MULTILINE_POLSTAT.UNIT_IFO_NEW_BUSI as UNIT_IFO_NEW_BUSI,
SQ_AGG_MULTILINE_POLSTAT.UNIT_RINSTMT as UNIT_RINSTMT,
SQ_AGG_MULTILINE_POLSTAT.UNIT_CNT_CANC as UNIT_CNT_CANC,
SQ_AGG_MULTILINE_POLSTAT.UNIT_CNT_CANC_CNVRSN as UNIT_CNT_CANC_CNVRSN,
SQ_AGG_MULTILINE_POLSTAT.source_record_id
FROM
SQ_AGG_MULTILINE_POLSTAT
);


-- Component AGG_MULTILINE_POLSTAT_MTHLY, Type TARGET 
INSERT INTO DB_T_ML_PROD.AGG_MULTILINE_POLSTAT_MTHLY
(
MO_ID,
SALES_ST_CD,
SALES_RGN_CD,
SALES_DIST_CD,
SALES_SVC_CD,
AGENCY_NBR,
AGNT_CLIENT_ID,
MASTER_COMPANY_NBR,
LOB_CD,
LOB_DESC,
LOB_SORT_CD,
POL_TYPE,
REASON,
PLCY_CNT_BEG_IFO,
PLCY_CNT_NEW_BUSI,
PLCY_C2C_NEW_BUSI,
UNIT_C2C_NEW_BUSI,
PLCY_RINSTMT,
HO_FIRE_PLCY_FORM_CHG_RINSTMT,
PLCY_CNT_LAPS,
PLCY_CNT_LAPS_CNVRSN,
PLCY_CNT_CANC,
PLCY_CNT_CANC_CNVRSN,
HO_FIRE_PLCY_FORM_CHG_CANC,
PLCY_C2C_CANC,
UNIT_C2C_CANC,
PLCY_C2C_UNIT_CANC,
UNIT_CNT_BEG_IFO,
UNIT_IFO_NEW_BUSI,
UNIT_RINSTMT,
UNIT_CNT_CANC,
UNIT_CNT_CANC_CNVRSN
)
SELECT
Exp_pass_through.MO_ID as MO_ID,
Exp_pass_through.SALES_ST_CD as SALES_ST_CD,
Exp_pass_through.SALES_RGN_CD as SALES_RGN_CD,
Exp_pass_through.SALES_DIST_CD as SALES_DIST_CD,
Exp_pass_through.SALES_SVC_CD as SALES_SVC_CD,
Exp_pass_through.AGENCY_NBR as AGENCY_NBR,
Exp_pass_through.AGNT_CLIENT_ID as AGNT_CLIENT_ID,
Exp_pass_through.MASTER_COMPANY_NBR as MASTER_COMPANY_NBR,
Exp_pass_through.LOB_CD as LOB_CD,
Exp_pass_through.LOB_DESC as LOB_DESC,
Exp_pass_through.LOB_SORT_CD as LOB_SORT_CD,
Exp_pass_through.POL_TYPE as POL_TYPE,
Exp_pass_through.REASON as REASON,
Exp_pass_through.PLCY_CNT_BEG_IFO as PLCY_CNT_BEG_IFO,
Exp_pass_through.PLCY_CNT_NEW_BUSI as PLCY_CNT_NEW_BUSI,
Exp_pass_through.PLCY_C2C_NEW_BUSI as PLCY_C2C_NEW_BUSI,
Exp_pass_through.UNIT_C2C_NEW_BUSI as UNIT_C2C_NEW_BUSI,
Exp_pass_through.PLCY_RINSTMT as PLCY_RINSTMT,
Exp_pass_through.HO_FIRE_PLCY_FORM_CHG_RINSTMT as HO_FIRE_PLCY_FORM_CHG_RINSTMT,
Exp_pass_through.PLCY_CNT_LAPS as PLCY_CNT_LAPS,
Exp_pass_through.PLCY_CNT_LAPS_CNVRSN as PLCY_CNT_LAPS_CNVRSN,
Exp_pass_through.PLCY_CNT_CANC as PLCY_CNT_CANC,
Exp_pass_through.PLCY_CNT_CANC_CNVRSN as PLCY_CNT_CANC_CNVRSN,
Exp_pass_through.HO_FIRE_PLCY_FORM_CHG_CANC as HO_FIRE_PLCY_FORM_CHG_CANC,
Exp_pass_through.PLCY_C2C_CANC as PLCY_C2C_CANC,
Exp_pass_through.UNIT_C2C_CANC as UNIT_C2C_CANC,
Exp_pass_through.PLCY_C2C_UNIT_CANC as PLCY_C2C_UNIT_CANC,
Exp_pass_through.UNIT_CNT_BEG_IFO as UNIT_CNT_BEG_IFO,
Exp_pass_through.UNIT_IFO_NEW_BUSI as UNIT_IFO_NEW_BUSI,
Exp_pass_through.UNIT_RINSTMT as UNIT_RINSTMT,
Exp_pass_through.UNIT_CNT_CANC as UNIT_CNT_CANC,
Exp_pass_through.UNIT_CNT_CANC_CNVRSN as UNIT_CNT_CANC_CNVRSN
FROM
Exp_pass_through;


-- Component AGG_MULTILINE_POLSTAT_MTHLY, Type Post SQL 
UPDATE EVIEWDB_LGCY.ECTL_PRGM_PARAM 

SET ECTL_PARAM_VALUE = ''N'' , 

ECTL_ORIG_INS_TS = (SELECT CAL_START_DATE FROM (

SELECT 

CAL_END_DATE-EXTRACT(DAY FROM CAL_END_DATE)+1 CAL_START_DATE,

MAX(FEED_DT) CAL_END_DATE, 

EXTRACT(YEAR FROM CAL_END_DATE)*100+EXTRACT(MONTH FROM CAL_END_DATE) CAL_MO_ID 

FROM ECOREMLDB_LGCY.MULTILINE_POLSTAT

)A)

WHERE ECTL_PARAM_DESC = ''MULTILINE POLSTAT MTHLY LOAD STATUS'' 

AND ECTL_PARAM_ID = 20 ;


END; ';