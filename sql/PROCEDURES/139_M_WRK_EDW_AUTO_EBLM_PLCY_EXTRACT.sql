-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_WRK_EDW_AUTO_EBLM_PLCY_EXTRACT("WORKLET_NAME" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' 
DECLARE
       run_id STRING;
       PRCS_ID STRING;
	   CAL_END_DT STRING;
	   v_start_time TIMESTAMP;
BEGIN
       run_id := (SELECT run_id FROM control_worklet WHERE worklet_name = :worklet_name ORDER BY insert_ts DESC LIMIT 1);
       PRCS_ID := (SELECT param_value FROM control_params WHERE run_id = :run_id AND param_name = ''PRCS_ID'' LIMIT 1);
       CAL_END_DT := (SELECT param_value FROM control_params WHERE run_id = :run_id AND param_name = ''CAL_END_DT'' LIMIT 1);
	   v_start_time := CURRENT_TIMESTAMP();

-- Component sq_edw_eblm_plcy_veh, Type Pre SQL 
DELETE FROM DB_T_PROD_WRK.EDW_EBLM_PLCY_FEED    WHERE MO_ID=EXTRACT(YEAR FROM CAST(:CAL_END_DT AS DATE))*100+EXTRACT(MONTH FROM CAST(:CAL_END_DT AS DATE));


-- Component sq_edw_eblm_plcy_veh, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE sq_edw_eblm_plcy_veh AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as MO_ID,
$2 as PLCY_NBR,
$3 as PLCY_VEH_KEY,
$4 as DW_PLCY_SKEY,
$5 as PLCY_CHG_EFF_DT,
$6 as PLCY_CHG_EXP_DT,
$7 as PLCY_PLN_EXP_DT,
$8 as PLCY_EFF_TYPE_CD,
$9 as VEH_CHG_EFF_DT,
$10 as VEH_CHG_EXP_DT,
$11 as DRV_SKEY,
$12 as RSK_ST_CD,
$13 as RSK_CNTY_CD,
$14 as RSK_TERR_CD,
$15 as RSK_POSTAL_CD,
$16 as PA_SYM_CD,
$17 as UNIT_YEAR,
$18 as PLCY_OGN_EFF_DT,
$19 as PLCY_OGN_IPT_DT,
$20 as YEARS_WITH_ALFA,
$21 as COMPANY_NBR,
$22 as CLASS_DISCOUNT,
$23 as VEH_MAKE_DESC,
$24 as VEH_MODEL_YR,
$25 as VEH_TYPE_CD,
$26 as DRIVER_CLASS,
$27 as VEH_STT_AMT,
$28 as VEH_CST_NEW_AMT,
$29 as ANN_MILE_DESC,
$30 as VEH_EFF_TYPE_CD,
$31 as VEH_PFO_CD,
$32 as GENDER_CD,
$33 as CLIENT_DOB,
$34 as CLIENT_AGE,
$35 as MARITAL_STATUS_CD,
$36 as CLIENT_OCP,
$37 as VEH_USE_CD,
$38 as CLIENT_EFF_DT,
$39 as NBR_MILES_WORK,
$40 as PA_POINTS_NBR,
$41 as NBR_SPEED_VIOLNS,
$42 as NBR_OTHR_MINR_VIOLNS,
$43 as NBR_DUI,
$44 as NBR_OTHR_MJR_VIOLNS,
$45 as NBR_CHARG_ACC_PD,
$46 as NBR_CHARG_ACC_BI,
$47 as INS_SCR1,
$48 as INS_SCR2,
$49 as BI_LIMIT,
$50 as PD_LIMIT,
$51 as MP_LIMIT,
$52 as CMP_LIMIT,
$53 as COL_LIMIT,
$54 as CMP_DED,
$55 as COL_DED,
$56 as ERS_DED,
$57 as LOI_LIMIT,
$58 as LOU_LIMIT,
$59 as UNB_LIMIT,
$60 as UNB_ADDON_IND,
$61 as UNB_RED_IND,
$62 as UND_DED,
$63 as UNP_LIMIT,
$64 as UNP_ADDON_IND,
$65 as UNP_RED_IND,
$66 as SL_LIMIT,
$67 as UNSL_LIMIT,
$68 as UNSL_ADDON_IND,
$69 as UNSL_RED_IND,
$70 as UNSL_DED,
$71 as LOI_IND,
$72 as ERS_IND,
$73 as LOU_IND,
$74 as CS_IND,
$75 as SG_IND,
$76 as EXN_IND,
$77 as CUS_IND,
$78 as GAP_IND,
$79 as COMBO_DSC1,
$80 as MULTICAR_DSC1,
$81 as NC_DSC,
$82 as VC_DSC,
$83 as AB_DSC1,
$84 as AT_DSC1,
$85 as AS_DSC,
$86 as NPIS_DSC1,
$87 as RTU_DSC1,
$88 as DTR_DSC1,
$89 as HSD_DSC1,
$90 as DDC_DSC1,
$91 as HOD_DSC1,
$92 as LFD_DSC1,
$93 as CGHS_DSC1,
$94 as ARPB_DSC,
$95 as ARPP_DSC,
$96 as ARPM_DSC,
$97 as ARPC_DSC,
$98 as ABS_DSC1,
$99 as SALES_AGENCY_NBR,
$100 as PTY_INS_CARRIER_CD,
$101 as PTY_INS_CARRIER_NM,
$102 as NM_INSUR_GENDER_CD,
$103 as NM_INSUR_DOB,
$104 as NM_INSUR_AGE,
$105 as NM_INSUR_MARITAL_STATUS_CD,
$106 as NM_INSUR_MEMB_TYPE,
$107 as NM_INSUR_MEMB_NBR,
$108 as NM_INSUR_SKEY,
$109 as SCR_TYPE,
$110 as SCR,
$111 as SCR_DATE,
$112 as DEFAULT_IND,
$113 as DRVEXC,
$114 as DRVEXC25,
$115 as ACCIDENT_FORGIVE_IND,
$116 as UMBRELLA_IND,
$117 as BILL_PAY,
$118 as FARM_IND,
$119 as LENGTH_WITH_PRIOR_CARRIER,
$120 as LIFE_IND,
$121 as MH_IND,
$122 as NUM_DEFENSIVE_DRIVER,
$123 as NUM_DRIVER_TRAINING,
$124 as NUM_DRIVERS,
$125 as NUM_FEMALE,
$126 as NUM_HONOR_STUDENTS,
$127 as NUM_LIFE_POL,
$128 as NUM_MALE,
$129 as NUM_MH,
$130 as NUM_OF_LATE_PAY,
$131 as NUM_SF,
$132 as NUM_UNLISTED_DRIVER,
$133 as NUM_VEHICLES,
$134 as PRIOR_CLAIMS_IND,
$135 as RELATIONSHIP_DISC_IND,
$136 as STANDARD_FIRE_IND,
$137 as WTC_IND,
$138 as AFFINITY_GROUP_IND,
$139 as NUM_ACCIDENTS,
$140 as NUM_MAJOR_VIOLATIONS,
$141 as NUM_MINOR_VIOLATIONS,
$142 as CENSUS_BLOCK,
$143 as RED_MOUNTAIN_SCORE,
$144 as PA_SYM_CD_2,
$145 as PLCY_TYPE,
$146 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT DISTINCT 

extract(year from cast(:CAL_END_DT as date))*100+extract(month from cast(:CAL_END_DT as date)) mo_id,

D.PLCY_NBR

	,A.PLCY_VEH_KEY AS PLCY_VEH_KEY

	,A.DW_PLCY_SKEY AS DW_PLCY_SKEY

	,A.PLCY_CHG_EFF_DT AS PLCY_CHG_EFF_DT

	,A.PLCY_CHG_EXP_DT AS PLCY_CHG_EXP_DT

	,A.PLCY_PLN_EXP_DT AS PLCY_PLN_EXP_DT

	,A.PLCY_EFF_TYPE_CD

	,A.VEH_CHG_EFF_DT AS VEH_CHG_EFF_DT

	,A.VEH_CHG_EXP_DT AS VEH_CHG_EXP_DT

	,A.DRV_SKEY AS DRV_SKEY

	,A.RSK_ST_CD AS RSK_ST_CD

	,CAST(NULL AS VARCHAR(10)) AS RSK_CNTY_CD

	,A.RSK_TERR_CD AS RSK_TERR_CD

	,A.RSK_POSTAL_CD AS RSK_POSTAL_CD

	,PA_SYM_CD AS PA_SYM_CD

	, EXTRACT(YEAR FROM A.PLCY_OGN_EFF_DT) AS UNIT_YEAR

	,A.PLCY_OGN_EFF_DT AS PLCY_OGN_EFF_DT

	,A.PLCY_OGN_IPT_DT AS PLCY_OGN_IPT_DT

	,A.YEARS_WITH_ALFA AS YEARS_WITH_ALFA

	,A.MASTER_COMPANY_NBR AS COMPANY_NBR

	,CAST(NULL AS VARCHAR(2)) AS CLASS_DISCOUNT

	,A.VEH_MAKE_DESC AS VEH_MAKE_DESC

	,CAST(A.VEH_MODEL_YR AS SMALLINT) AS VEH_MODEL_YR

	,CAST(NULL AS VARCHAR(10)) AS VEH_TYPE_CD

	,DRIVER_POINT.DRVR_CLAS_CD AS DRIVER_CLASS

	,CAST(0 AS DECIMAL(12, 2)) AS VEH_STT_AMT

	,A.VEH_CST_NEW_AMT AS VEH_CST_NEW_AMT

	,A.ANN_MILE_DESC AS ANN_MILE_DESC

	,CAST(NULL AS VARCHAR(10)) AS VEH_EFF_TYPE_CD

	,CAST(NULL AS VARCHAR(10)) AS VEH_PFO_CD

	,A.GENDER_CD AS GENDER_CD

	,A.CLIENT_DOB AS CLIENT_DOB

	,A.CLIENT_AGE AS CLIENT_AGE

	,A.MARITAL_STATUS_CD AS MARITAL_STATUS_CD

	,A.OCP_DESC AS CLIENT_OCP

	,A.VEH_USE_CD AS VEH_USE_CD

	,A.CLIENT_EFF_DT AS CLIENT_EFF_DT

	,CAST(A.NBR_MILES_WORK AS SMALLINT) AS NBR_MILES_WORK

	,DRIVER_POINT.PNLTY_PNTS_CNT AS PA_POINTS_NBR

	,CAST(0 AS SMALLINT) AS NBR_SPEED_VIOLNS

	,CAST(0 AS SMALLINT) AS NBR_OTHR_MINR_VIOLNS

	,CAST(0 AS SMALLINT) AS NBR_DUI

	,CAST(0 AS SMALLINT) AS NBR_OTHR_MJR_VIOLNS

	,CAST(0 AS SMALLINT) AS NBR_CHARG_ACC_PD

	,CAST(0 AS SMALLINT) AS NBR_CHARG_ACC_BI

	,A.INS_SCR1

	,A.INS_SCR2

	,B.BI_LIMIT AS BI_LIMIT

	,B.PD_LIMIT AS PD_LIMIT

	,B.MED_LIMIT AS MP_LIMIT

	,B.CMP_LIMIT AS CMP_LIMIT

	,B.COL_LIMIT AS COL_LIMIT

	,B.CMP_DED AS CMP_DED

	,B.COL_DED AS COL_DED

	,B.ERS_DED AS ERS_DED

	,B.LOI_LIMIT AS LOI_LIMIT

	,B.LOU_LIMIT AS LOU_LIMIT

	,B.UNB_LIMIT AS UNB_LIMIT

	,B.UNB_ADDON_IND

	,B.UNB_RED_IND

	,B.UND_DED AS UND_DED

	,B.UNP_LIMIT AS UNP_LIMIT

	,B.UNP_ADDON_IND

	,B.UNP_RED_IND

	,B.SL_LIMIT AS SL_LIMIT

	,B.UNSL_LIMIT AS UNSL_LIMIT

	,B.UNSL_ADDON_IND

	,B.UNSL_RED_IND

	,B.UNSL_DED AS UNSL_DED

	,COALESCE(B.LOI_IND, ''N'') AS LOI_IND

	,COALESCE(B.ERS_IND, ''N'') AS ERS_IND

	,COALESCE(B.LOU_IND, ''N'') AS LOU_IND

	,COALESCE(B.CS_IND, ''N'') AS CS_IND

	,COALESCE(B.SG_IND, ''N'') AS SG_IND

	,COALESCE(B.EXN_IND, ''N'') AS EXN_IND

	,COALESCE(B.CUS_IND, ''N'') AS CUS_IND

	,COALESCE(B.GAP_IND, ''N'') AS GAP_IND

	,COALESCE(C.COMBO_DSC, ''N'') AS COMBO_DSC

	,COALESCE(C.MULTICAR_DSC, ''N'') AS MULTICAR_DSC

	,CAST(NULL AS VARCHAR(4)) AS NC_DSC

	,CAST(NULL AS VARCHAR(1)) AS VC_DSC

	,COALESCE(C.AB_DSC, ''N'') AS AB_DSC

	,COALESCE(C.AT_DSC, ''N'') AS AT_DSC

	,CAST(NULL AS VARCHAR(1)) AS AS_DSC

	,COALESCE(C.NPIS_DSC, ''N'') AS NPIS_DSC

	,COALESCE(C.RTU_DSC, ''N'') AS RTU_DSC

	,COALESCE(C.DTR_DSC, ''N'') AS DTR_DSC

	,COALESCE(C.HSD_DSC, ''N'') AS HSD_DSC

	,COALESCE(C.DDC_DSC, ''N'') AS DDC_DSC

	,COALESCE(C.HOD_DSC, ''N'') AS HOD_DSC

	,COALESCE(C.LFD_DSC, ''N'') AS LFD_DSC

	,COALESCE(C.CGHS_DSC, ''N'') AS CGHS_DSC

	,CAST(NULL AS VARCHAR(1)) AS ARPB_DSC

	,CAST(NULL AS VARCHAR(1)) AS ARPP_DSC

	,CAST(NULL AS VARCHAR(1)) AS ARPM_DSC

	,CAST(NULL AS VARCHAR(1)) AS ARPC_DSC

	,COALESCE(C.ABS_DSC, ''N'') AS ABS_DSC

	,A.SALES_AGENCY_NBR

	,A.PTY_INS_CARRIER_CD

	,A.PTY_INS_CARRIER_NM

	,A.NM_INSUR_GENDER_CD

	,A.NM_INSUR_DOB

	,A.NM_INSUR_AGE

	,A.NM_INSUR_MARITAL_STATUS_CD

	,A.NM_INSUR_MEMB_TYPE

	,A.NM_INSUR_MEMB_NBR

	,A.NM_INSUR_SKEY

	,D.MODL_NAME AS SCR_TYPE

	,cast(CASE 

			WHEN D.AGMT_SCR_VAL = ''.00''

				THEN ''0.00''

			ELSE D.AGMT_SCR_VAL

			END AS INTEGER) AS SCR

	,CAST(D.MODL_RUN_DTTM AS DATE) AS SCR_DATE

	,CAST(NULL AS VARCHAR(1)) AS DEFAULT_IND

	,A.DRVEXC

	,A.DRVEXC25,COALESCE(ACCIDENT_FORGIVE_IND,''N'')ACCIDENT_FORGIVE_IND,COALESCE(UMBRELLA_IND,''N'')UMBRELLA_IND,BILG_METH_TYPE_CD BILL_PAY,COALESCE(RLSHP_DISC_NUM_FRM_POLS,''N'')RLSHP_DISC_NUM_FRM_POLS,

	COALESCE(PRIOR_INSRNC_IND,''N'') LENGTH_WITH_PRIOR_CARRIER,COALESCE(lifediscount_IND,''N'')lifediscount_IND,COALESCE(RLSHP_DISC_NUM_MH_IND,''N'')RLSHP_DISC_NUM_MH_IND,

		COALESCE(NUM_DEFENSIVE_DRIVER,0)NUM_DEFENSIVE_DRIVER,COALESCE(NUM_DRIVER_TRAINING,0)NUM_DRIVER_TRAINING,COALESCE(NUM_DRIVERS,0)NUM_DRIVERS,COALESCE(NUM_FEMALE,0)NUM_FEMALE,

COALESCE(NUM_HONOR_STUDENTS,0)NUM_HONOR_STUDENTS,COALESCE(NUM_LIFE_POL,0)NUM_LIFE_POL,COALESCE(NUM_MALE,0)NUM_MALE, COALESCE(RLSHP_DISC_NUM_MH_POLS,0) NUM_MH,COALESCE(NUM_OF_LATE_PAY,0)NUM_OF_LATE_PAY,

COALESCE(RLSHP_DISC_NUM_SF_POLS,0) NUM_SF,COALESCE(NUM_UNLISTED_DRIVER,0)NUM_UNLISTED_DRIVER,COALESCE(NUM_VEHICLES,0)NUM_VEHICLES,

COALESCE(PRIOR_CLAIMS_IND,''N'')PRIOR_CLAIMS_IND,COALESCE(RELATIONSHIP_DISC_IND,''N'')RELATIONSHIP_DISC_IND,

COALESCE(RLSHP_DISC_NUM_SF_IND,''N'') STANDARD_FIRE_IND

,COALESCE(watercraft_IND,''N'') WTC_IND,

COALESCE(affinity_dis_IND,''N'') afFINITY_GROUP_IND ,

COALESCE(acdnt_cnt,0) NUM_ACCIDENTS,

	COALESCE(MAJ_CNVICTN_CNT ,0)NUM_MAJOR_VIOLATIONS, COALESCE(MINOR_CNVICTN_CNT,0) NUM_MINOR_VIOLATIONS

		,	NULL CENSUS_BLOCK,

	COALESCE(AGMT_ASSET_SCR_VAL,0) RED_MOUNTAIN_SCORE,

	PA_SYM_CD_2,PROD_NAME

FROM (SELECT SCR1.AGMT_ID

	,POL.HOST_AGMT_NUM AS PLCY_NBR

	,SCR1.MODL_ID

	,SCR1.MODL_RUN_DTTM

	,SCR1.AGMT_SCR_VAL

	,SCR1.MODL_NAME

	,POL.AGMT_SIGND_DTTM AS PLCY_OGN_EFF_DT

	,POL.AGMT_EFF_DTTM AS PLCY_EFFECTIVE_DT,pol.BILG_METH_TYPE_CD,pol.PRIOR_INSRNC_IND,prod_name

	FROM (SELECT * FROM 

(

SELECT  PPV.HOST_AGMT_NUM,PPV.AGMT_ID,PPV.AGMT_SRC_CD,MODL_CRTN_DTTM,

        A_S.AGMT_STS_CD,

A_S.AGMT_STS_RSN_CD,

CASE    WHEN A_S.AGMT_STS_CD = ''CNCLD'' 

    AND A_S.AGMT_STS_RSN_CD = ''CHGUWCMPY'' THEN ''Y'' 

END AS C2C_CANC_IND ,PPV.AGMT_EFF_DTTM,PPV.AGMT_SIGND_DTTM,BILG_METH_TYPE_CD,PRIOR_INSRNC_IND

FROM    

(

SELECT  T1.HOST_AGMT_NUM,T1.TERM_NUM,T1.AGMT_ID,T1.MODL_CRTN_DTTM,T1.AGMT_SRC_CD,

        T1.MODL_EFF_DTTM,T1.AGMT_EFF_DTTM,T1.AGMT_SIGND_DTTM,T1.BILG_METH_TYPE_CD,t1.PRIOR_INSRNC_IND,

CASE    WHEN T1.MODL_EFF_DTTM > T1.MODL_CRTN_DTTM THEN T1.MODL_EFF_DTTM 

ELSE    T1.MODL_CRTN_DTTM 

END AS NEW_AGMT_EFF_DTTM

FROM    DB_T_PROD_CORE.AGMT T1 

WHERE   T1.AGMT_TYPE_CD = ''PPV'' 

    AND T1.SRC_SYS_CD = ''GWPC'' 

    AND CAST(:CAL_END_DT AS DATE)  

BETWEEN AGMT_EFF_DTTM AND AGMT_PLND_EXPN_DTTM

    AND T1.TRANS_STRT_DTTM = 

(

SELECT  MIN(T2.TRANS_STRT_DTTM) 

FROM    DB_T_PROD_CORE.AGMT T2 

WHERE   T1.AGMT_ID = T2.AGMT_ID) 

    AND NEW_AGMT_EFF_DTTM <=  CAST(:CAL_END_DT AS DATE)  

) PPV 

INNER JOIN 

(

SELECT  HOST_AGMT_NUM, TERM_NUM,AGMT_ID 

FROM    DB_T_PROD_CORE.AGMT 

WHERE   AGMT_TYPE_CD = ''POLTRM'' 

    AND CAST(:CAL_END_DT AS DATE)  

BETWEEN AGMT_EFF_DTTM AND AGMT_PLND_EXPN_DTTM 

GROUP   BY 1,2,3) TRM 

    ON  PPV.HOST_AGMT_NUM = TRM.HOST_AGMT_NUM 

    AND PPV.TERM_NUM = TRM.TERM_NUM  



INNER JOIN 

DB_T_PROD_CORE.AGMT_STS A_S 

    ON  TRM.AGMT_ID = A_S.AGMT_ID  

    AND A_S.AGMT_STS_STRT_DTTM <= CAST(:CAL_END_DT AS DATE)  

    AND A_S.AGMT_STS_CD <> ''CNFRMDDT'' 

QUALIFY ROW_NUMBER() OVER(PARTITION BY PPV.AGMT_ID 

ORDER   BY A_S.AGMT_STS_STRT_DTTM DESC) = 1 

)  A  QUALIFY ROW_NUMBER() OVER(PARTITION BY HOST_AGMT_NUM 

ORDER   BY  CASE WHEN (AGMT_STS_CD=''INFORCE'') THEN 1 ELSE 2 END ,

MODL_CRTN_DTTM DESC ) = 1



)POL 

JOIN DB_T_PROD_CORE.AGMT_PROD  ON POL.AGMT_ID=AGMT_PROD.AGMT_ID AND AGMT_PROD.EDW_END_DTTM=''9999-12-31 23:59:59.999999''  

AND AGMT_STS_CD=''INFORCE''

JOIN DB_T_PROD_CORE.PROD  ON AGMT_PROD.PROD_ID=PROD.PROD_ID AND PROD.EDW_END_DTTM=''9999-12-31 23:59:59.999999'' 

 and PROD.PROD_NAME IN (''PPV'', ''AUTO'',''PPV2'', ''COMMERCIAL'', ''PERSONAL AUTO'')   

left join (

		SELECT DISTINCT AS1.AGMT_ID

		,AS1.MODL_ID

		,AGMT_SCR_VAL

		,MR1.MODL_RUN_DTTM

		,AN.MODL_NAME

		 FROM DB_T_PROD_CORE.AGMT_SCR AS AS1

		JOIN DB_T_PROD_CORE.MODL_RUN AS MR1 ON AS1.MODL_RUN_ID = MR1.MODL_RUN_ID

		INNER JOIN DB_T_PROD_CORE.ANLTCL_MODL AN ON AN.MODL_ID = MR1.MODL_ID

		WHERE AN.MODL_NAME IN (''LVP'')

			AND MR1.MODL_RUN_DTTM <= CAST(:CAL_END_DT AS DATE) QUALIFY RANK() OVER (

				PARTITION BY AS1.AGMT_ID

				,AS1.MODL_ID ORDER BY MR1.MODL_RUN_DTTM DESC

				) = 1

		) SCR1 on scr1.agmt_id=pol.agmt_id

		

	) AS D   JOIN DB_T_PROD_WRK.EDW_EBLM_PLCY_VEH A

	ON A.PLCY_NBR = D.PLCY_NBR

	AND A.MO_ID=EXTRACT(YEAR FROM CAST(:CAL_END_DT AS DATE))*100+EXTRACT(MONTH FROM CAST(:CAL_END_DT AS DATE))

LEFT OUTER JOIN DB_T_PROD_WRK.EDW_EBLM_VEH_COV B ON A.PLCY_VEH_KEY = B.PLCY_VEH_KEY

	AND A.MO_ID=B.MO_ID

LEFT OUTER JOIN DB_T_PROD_WRK.EDW_EBLM_VEH_DISC C ON A.PLCY_VEH_KEY = C.PLCY_VEH_KEY

AND A.MO_ID=C.MO_ID

LEFT JOIN (

		SELECT PA.AGMT_ID

		,PPA.PRTY_ID

				,PPA.DRVR_CLAS_CD

		,PDH.PNLTY_PNTS_CNT FROM DB_T_PROD_CORE.PRTY_AGMT PA 

		JOIN DB_T_PROD_CORE.PRTY_TO_PRTY_ASSET PPA ON PA.PRTY_ID = PPA.PRTY_ID

		JOIN DB_T_PROD_CORE.PRTY_DRVG_HIST PDH ON PPA.PRTY_ID = PDH.INDIV_PRTY_ID

		AND PA.PRTY_AGMT_ROLE_CD=''PLCYPRININS''

		WHERE PA.TRANS_STRT_DTTM<=CAST(:CAL_END_DT AS DATE) AND PA.TRANS_END_DTTM>=CAST(:CAL_END_DT AS DATE)

		AND PPA.TRANS_STRT_DTTM<=CAST(:CAL_END_DT AS DATE) AND PPA.TRANS_END_DTTM>=CAST(:CAL_END_DT AS DATE)

				QUALIFY ROW_NUMBER() OVER(PARTITION BY PA.AGMT_ID

		,PPA.PRTY_ID ORDER BY PPA.EDW_END_DTTM DESC,PDH.EDW_END_DTTM DESC)=1

		

)DRIVER_POINT ON D.AGMT_ID=DRIVER_POINT.AGMT_ID

left join (SELECT	A.INDIV_PRTY_ID,

		A.DRVG_HIST_DTTM,  B.PNLTY_PNTS_CNT  , MAJ_CNVICTN_CNT, MINOR_CNVICTN_CNT,

		DUI_IND	, a.acdnt_cnt					

FROM							

					(		

	SELECT	INDIV_PRTY_ID,

			MAX(DRVG_HIST_DTTM) DRVG_HIST_DTTM , acdnt_cnt					

						FROM	DB_T_PROD_CORE.PRTY_DRVG_HIST	 PRTY_DRVG_HIST	

						WHERE			

/* Hardcoded month end timestamp before which the scoring model was run	 */
						PRTY_DRVG_HIST.EDW_END_DTTM = TO_TIMESTAMP_NTZ(''12/31/9999 23:59:59.999999'', ''MM/DD/YYYY HH24:MI:SS.FF6'')

						GROUP BY INDIV_PRTY_ID ,acdnt_cnt) A,

				

					(		

	SELECT	INDIV_PRTY_ID, DRVG_HIST_DTTM, PNLTY_PNTS_CNT  ,

			MAJ_CNVICTN_CNT, MINOR_CNVICTN_CNT, DUI_IND						

	FROM	DB_T_PROD_CORE.PRTY_DRVG_HIST PRTY_DRVG_HIST						

						WHERE PRTY_DRVG_HIST.EDW_END_DTTM = TO_TIMESTAMP_NTZ(''12/31/9999 23:59:59.999999'', ''MM/DD/YYYY HH24:MI:SS.FF6'')

								

						) B 		

WHERE	A.INDIV_PRTY_ID =B.INDIV_PRTY_ID  						

	AND	A.DRVG_HIST_DTTM=B.DRVG_HIST_DTTM )driv_hist on driv_hist.indiv_prty_id=DRIVER_POINT.PRTY_ID

	left join (SELECT AGMT_ID, MAX(CASE WHEN NK_SRC_KEY = ''PAAccidentWaiver_alfa'' THEN ''Y'' ELSE ''N'' END) ACCIDENT_FORGIVE_IND,

MAX(CASE WHEN NK_SRC_KEY =''PALifePolicyDiscount_alfa'' AND FEAT_ELGBL_IND = ''T''THEN ''Y'' ELSE ''N'' END) lifediscount_IND,

COUNT(CASE WHEN NK_SRC_KEY =''PALifePolicyDiscount_alfa'' AND FEAT_ELGBL_IND = ''T''THEN AGMT_ID END) NUM_LIFE_POL,

MAX(CASE WHEN NK_SRC_KEY =''PAUmbrellaPolicyDiscount_alfa'' THEN ''Y'' ELSE ''N'' END) watercraft_IND,

MAX(case when NK_SRC_KEY=''PAAffinityDiscount_alfa''  AND FEAT_ELGBL_IND = ''T'' THEN ''Y'' ELSE ''N'' END) affinity_dis_IND

from DB_T_PROD_CORE.FEAT 

a join DB_T_PROD_CORE.agmt_feat b on a.feat_id=b.feat_id

WHERE  NK_SRC_KEY in (''PALifePolicyDiscount_alfa'', ''PAAccidentWaiver_alfa'',''PAAffinityDiscount_alfa'',''PAUmbrellaPolicyDiscount_alfa'')

GROUP BY 1

) discount

on discount.agmt_id=d.agmt_id

LEFT JOIN (SELECT AGMT_ID, Sum(CASE WHEN A.AGMT_SPEC_TYPE_CD=''RLTNSHPDSCNTNUMFRMPOLS'' AND A.SPEC_TYPE_CD=''ONE    '' THEN 1

     WHEN A.AGMT_SPEC_TYPE_CD=''RLTNSHPDSCNTNUMFRMPOLS'' AND A.SPEC_TYPE_CD=''TWO    '' THEN 2

	 WHEN A.AGMT_SPEC_TYPE_CD=''RLTNSHPDSCNTNUMFRMPOLS'' AND A.SPEC_TYPE_CD=''THREE  '' THEN 3

	 WHEN A.AGMT_SPEC_TYPE_CD=''RLTNSHPDSCNTNUMFRMPOLS'' AND A.SPEC_TYPE_CD=''FOUR   '' THEN 4

	 WHEN A.AGMT_SPEC_TYPE_CD=''RLTNSHPDSCNTNUMFRMPOLS'' AND A.SPEC_TYPE_CD IN (''FIVE   '',''FIVEAMR'') THEN 5 ELSE 0 END) AS RLSHP_DISC_NUM_FRM_POLS,

Sum(CASE WHEN A.AGMT_SPEC_TYPE_CD=''RLTNSHPDSCNTNUMHO3POLS'' AND A.SPEC_TYPE_CD=''ONE    '' THEN 1

     WHEN A.AGMT_SPEC_TYPE_CD=''RLTNSHPDSCNTNUMHO3POLS'' AND A.SPEC_TYPE_CD=''TWO    '' THEN 2

	 WHEN A.AGMT_SPEC_TYPE_CD=''RLTNSHPDSCNTNUMHO3POLS'' AND A.SPEC_TYPE_CD=''THREE  '' THEN 3

	 WHEN A.AGMT_SPEC_TYPE_CD=''RLTNSHPDSCNTNUMHO3POLS'' AND A.SPEC_TYPE_CD=''FOUR   '' THEN 4 END)RLSHP_DISC_NUM_HO3_POLS,

	 Sum(CASE WHEN A.AGMT_SPEC_TYPE_CD=''RLTNSHPDSCNTNUMMHPOLS'' AND A.SPEC_TYPE_CD=''ONE'' THEN 1

     WHEN A.AGMT_SPEC_TYPE_CD=''RLTNSHPDSCNTNUMMHPOLS'' AND A.SPEC_TYPE_CD=''TWO'' THEN 2

	 WHEN A.AGMT_SPEC_TYPE_CD=''RLTNSHPDSCNTNUMMHPOLS'' AND A.SPEC_TYPE_CD=''THREE'' THEN 3

	 WHEN A.AGMT_SPEC_TYPE_CD=''RLTNSHPDSCNTNUMMHPOLS'' AND A.SPEC_TYPE_CD=''FOUR'' THEN 4

	 WHEN A.AGMT_SPEC_TYPE_CD=''RLTNSHPDSCNTNUMMHPOLS'' AND A.SPEC_TYPE_CD IN (''FIVE'',''FIVEAMR'') THEN 5 ELSE 0 END) AS RLSHP_DISC_NUM_MH_IND,

	 count( 

(CASE WHEN A.AGMT_SPEC_TYPE_CD=''RLTNSHPDSCNTNUMMHPOLS'' AND A.SPEC_TYPE_CD=''ONE'' THEN 1

     WHEN A.AGMT_SPEC_TYPE_CD=''RLTNSHPDSCNTNUMMHPOLS'' AND A.SPEC_TYPE_CD=''TWO'' THEN 2

	 WHEN A.AGMT_SPEC_TYPE_CD=''RLTNSHPDSCNTNUMMHPOLS'' AND A.SPEC_TYPE_CD=''THREE'' THEN 3

	 WHEN A.AGMT_SPEC_TYPE_CD=''RLTNSHPDSCNTNUMMHPOLS'' AND A.SPEC_TYPE_CD=''FOUR'' THEN 4

	 WHEN A.AGMT_SPEC_TYPE_CD=''RLTNSHPDSCNTNUMMHPOLS'' AND A.SPEC_TYPE_CD IN (''FIVE'',''FIVEAMR'') THEN 5 ELSE 0 END)) AS RLSHP_DISC_NUM_MH_POLS,

	 

count((CASE WHEN A.AGMT_SPEC_TYPE_CD=''RLTNSHPDSCNTNUMSFPOLS'' AND A.SPEC_TYPE_CD=''ONE'' THEN 1

     WHEN A.AGMT_SPEC_TYPE_CD=''RLTNSHPDSCNTNUMSFPOLS'' AND A.SPEC_TYPE_CD=''TWO'' THEN 2

	 WHEN A.AGMT_SPEC_TYPE_CD=''RLTNSHPDSCNTNUMSFPOLS'' AND A.SPEC_TYPE_CD=''THREE'' THEN 3

	 WHEN A.AGMT_SPEC_TYPE_CD=''RLTNSHPDSCNTNUMSFPOLS'' AND A.SPEC_TYPE_CD=''FOUR'' THEN 4

	 WHEN A.AGMT_SPEC_TYPE_CD=''RLTNSHPDSCNTNUMSFPOLS'' AND A.SPEC_TYPE_CD IN (''FIVE'',''FIVEAMR'') THEN 5 ELSE 0 END)) AS RLSHP_DISC_NUM_SF_IND,

	 SUM((CASE WHEN A.AGMT_SPEC_TYPE_CD=''RLTNSHPDSCNTNUMSFPOLS'' AND A.SPEC_TYPE_CD=''ONE'' THEN 1

     WHEN A.AGMT_SPEC_TYPE_CD=''RLTNSHPDSCNTNUMSFPOLS'' AND A.SPEC_TYPE_CD=''TWO'' THEN 2

	 WHEN A.AGMT_SPEC_TYPE_CD=''RLTNSHPDSCNTNUMSFPOLS'' AND A.SPEC_TYPE_CD=''THREE'' THEN 3

	 WHEN A.AGMT_SPEC_TYPE_CD=''RLTNSHPDSCNTNUMSFPOLS'' AND A.SPEC_TYPE_CD=''FOUR'' THEN 4

	 WHEN A.AGMT_SPEC_TYPE_CD=''RLTNSHPDSCNTNUMSFPOLS'' AND A.SPEC_TYPE_CD IN (''FIVE'',''FIVEAMR'') THEN 5 ELSE 0 END)) AS RLSHP_DISC_NUM_SF_POLS

,MAX(CASE WHEN AGMT_SPEC_TYPE_CD IN

(''RLTNSHPDSCNTNUMFRMPOLS'',''RLTNSHPDSCNTNUMHO3POLS'',''RLTNSHPDSCNTNUMHO4POLS'',''RLTNSHPDSCNTNUMHO5POLS'',''RLTNSHPDSCNTNUMHO6POLS'',

''RLTNSHPDSCNTNUMHO8POLS'',''RLTNSHPDSCNTNUMLFPOLS'',''RLTNSHPDSCNTNUMMHPOLS'',''RLTNSHPDSCNTNUMSFPOLS'') THEN ''Y'' ELSE ''N'' END )RELATIONSHIP_DISC_IND,



	 max(case when agmt_spec_type_cd=''UMBRELLAIND'' then ''Y'' ELSE ''N'' END)UMBRELLA_IND

FROM  DB_T_PROD_CORE.AGMT_SPEC A WHERE AGMT_SPEC_TYPE_CD IN

(''RLTNSHPDSCNTNUMFRMPOLS'',''RLTNSHPDSCNTNUMHO3POLS'',''RLTNSHPDSCNTNUMHO4POLS'',''RLTNSHPDSCNTNUMHO5POLS'',''RLTNSHPDSCNTNUMHO6POLS'',

''RLTNSHPDSCNTNUMHO8POLS'',''RLTNSHPDSCNTNUMLFPOLS'',''RLTNSHPDSCNTNUMMHPOLS'',''RLTNSHPDSCNTNUMSFPOLS'',''UMBRELLAIND'')

GROUP BY A.AGMT_ID) FARM_DIS ON FARM_DIS.AGMT_ID=D.AGMT_ID



LEFT JOIN (

SELECT A.AGMT_ID, COUNT(DISTINCT PRTY_ID) NUM_DRIVERS,

COUNT(DISTINCT CASE WHEN GNDR_TYPE_CD=''M'' THEN PRTY_ID END) NUM_MALE,

COUNT(DISTINCT CASE WHEN GNDR_TYPE_CD=''F'' THEN PRTY_ID END) NUM_FEMALE,

COUNT( DISTINCT CASE WHEN D.NK_SRC_KEY =''PADriverTrainingDiscount_alfa'' THEN PRTY_ASSET_ID END) NUM_DEFENSIVE_DRIVER,

COUNT( DISTINCT CASE WHEN D.NK_SRC_KEY =''PADriverTrainingDiscount_alfa'' THEN PRTY_ASSET_ID END) NUM_DRIVER_TRAINING,

COUNT( DISTINCT CASE WHEN D.NK_SRC_KEY =''PAYouthHonorStudent_alfa'' THEN PRTY_ASSET_ID END) NUM_HONOR_STUDENTS

FROM DB_T_PROD_CORE.PRTY_AGMT A JOIN DB_T_PROD_CORE.INDIV B ON A.PRTY_ID=B.INDIV_PRTY_ID 

LEFT JOIN DB_T_PROD_CORE.AGMT_INSRD_ASSET_FEAT C ON A.AGMT_ID=C.AGMT_ID

LEFT JOIN DB_T_PROD_CORE.FEAT D ON D.FEAT_ID=C.FEAT_ID

WHERE PRTY_AGMT_ROLE_CD IN (''PLCYDRVR'')

GROUP BY 1)DRV ON DRV.AGMT_ID=D.AGMT_ID

left join (SELECT agmt_id,  MAX(PLCY_CNT) NUM_OF_LATE_PAY  FROM DB_T_PROD_CORE.PLCY_MTRC PLCY_MTRC

WHERE INSRNC_MTRC_TYPE_CD=''3DLTPY''

group by 1) mtrc ON MTRC.AGMT_ID=D.AGMT_ID

left join (SELECT DISTINCT sum( case when (UNLISTD_OPRTR_IND=1 ) then 1 else 0 end )NUM_UNLISTED_DRIVER, C.AGMT_ID FROM DB_T_PROD_CORE.PRTY_CLM A JOIN DB_T_PROD_CORE.INDIV B ON

A.PRTY_ID=B.INDIV_PRTY_ID JOIN DB_T_PROD_CORE.PRTY_AGMT C ON A.PRTY_ID=C.PRTY_ID

GROUP BY 2) unlist on unlist.Agmt_id=d.agmt_id

left join (SELECT DISTINCT COUNT(DISTINCT PRTY_ASSET_ID) NUM_VEHICLES, A.AGMT_ID FROM DB_T_PROD_CORE.AGMT_ASSET  A WHERE CAST(:CAL_END_DT AS DATE)

BETWEEN TRANS_STRT_DTTM AND TRANS_END_DTTM

GROUP BY 2) VEH on VEH.Agmt_id=d.agmt_id

LEFT JOIN (SELECT DISTINCT  case when clm_num is not null then ''Y''ELSE ''N'' END PRIOR_CLAIMS_IND ,plcy_num FROM db_t_prod_core.PRIOR_LOSS_SUMRY) PRIOR_CLM

ON PRIOR_CLM.PLCY_NUM =A.PLCY_NBR



LEFT JOIN (SELECT A.AGMT_ID,CAST(c.host_agmt_num||b.motr_veh_ser_num AS VARCHAR(200)) VHE_SER , max(AGMT_ASSET_SCR_VAL ) AGMT_ASSET_SCR_VAL FROM DB_T_PROD_CORE.AGMT_ASSET_SCR a 

join DB_T_PROD_CORE.MOTR_VEH B ON A.PRTY_ASSET_ID=B.PRTY_ASSET_ID

JOIN DB_T_PROD_CORE.AGMT C ON A.AGMT_ID=C.AGMT_ID

WHERE A.EDW_END_DTTM=''9999-12-31 23:59:59.999999'' group by 1,2) AGMT_SCR ON AGMT_SCR.AGMT_ID=D.AGMT_ID AND VHE_SER=A.PLCY_VEH_KEY  ORDER BY 1,2,3
) SRC
)
);


-- Component exp_pass_to_target, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_pass_to_target AS
(
SELECT
sq_edw_eblm_plcy_veh.PLCY_NBR as PLCY_NBR,
sq_edw_eblm_plcy_veh.PLCY_VEH_KEY as PLCY_VEH_KEY,
sq_edw_eblm_plcy_veh.DW_PLCY_SKEY as DW_PLCY_SKEY,
sq_edw_eblm_plcy_veh.PLCY_CHG_EFF_DT as PLCY_CHG_EFF_DT,
sq_edw_eblm_plcy_veh.PLCY_CHG_EXP_DT as PLCY_CHG_EXP_DT,
sq_edw_eblm_plcy_veh.PLCY_PLN_EXP_DT as PLCY_PLN_EXP_DT,
sq_edw_eblm_plcy_veh.PLCY_EFF_TYPE_CD as PLCY_EFF_TYPE_CD,
sq_edw_eblm_plcy_veh.VEH_CHG_EFF_DT as VEH_CHG_EFF_DT,
sq_edw_eblm_plcy_veh.VEH_CHG_EXP_DT as VEH_CHG_EXP_DT,
sq_edw_eblm_plcy_veh.DRV_SKEY as DRV_SKEY,
sq_edw_eblm_plcy_veh.RSK_ST_CD as RSK_ST_CD,
sq_edw_eblm_plcy_veh.RSK_CNTY_CD as RSK_CNTY_CD,
sq_edw_eblm_plcy_veh.RSK_TERR_CD as RSK_TERR_CD,
sq_edw_eblm_plcy_veh.RSK_POSTAL_CD as RSK_POSTAL_CD,
sq_edw_eblm_plcy_veh.PA_SYM_CD as PA_SYM_CD,
sq_edw_eblm_plcy_veh.UNIT_YEAR as UNIT_YEAR,
sq_edw_eblm_plcy_veh.PLCY_OGN_EFF_DT as PLCY_OGN_EFF_DT,
sq_edw_eblm_plcy_veh.PLCY_OGN_IPT_DT as PLCY_OGN_IPT_DT,
sq_edw_eblm_plcy_veh.YEARS_WITH_ALFA as YEARS_WITH_ALFA,
sq_edw_eblm_plcy_veh.COMPANY_NBR as COMPANY_NBR,
sq_edw_eblm_plcy_veh.CLASS_DISCOUNT as CLASS_DISCOUNT,
sq_edw_eblm_plcy_veh.VEH_MAKE_DESC as VEH_MAKE_DESC,
sq_edw_eblm_plcy_veh.VEH_MODEL_YR as VEH_MODEL_YR,
sq_edw_eblm_plcy_veh.VEH_TYPE_CD as VEH_TYPE_CD,
sq_edw_eblm_plcy_veh.DRIVER_CLASS as DRIVER_CLASS,
sq_edw_eblm_plcy_veh.VEH_STT_AMT as VEH_STT_AMT,
sq_edw_eblm_plcy_veh.VEH_CST_NEW_AMT as VEH_CST_NEW_AMT,
sq_edw_eblm_plcy_veh.ANN_MILE_DESC as ANN_MILE_DESC,
sq_edw_eblm_plcy_veh.VEH_EFF_TYPE_CD as VEH_EFF_TYPE_CD,
sq_edw_eblm_plcy_veh.VEH_PFO_CD as VEH_PFO_CD,
sq_edw_eblm_plcy_veh.GENDER_CD as GENDER_CD,
sq_edw_eblm_plcy_veh.CLIENT_DOB as CLIENT_DOB,
sq_edw_eblm_plcy_veh.CLIENT_AGE as CLIENT_AGE,
sq_edw_eblm_plcy_veh.MARITAL_STATUS_CD as MARITAL_STATUS_CD,
sq_edw_eblm_plcy_veh.CLIENT_OCP as CLIENT_OCP,
sq_edw_eblm_plcy_veh.VEH_USE_CD as VEH_USE_CD,
sq_edw_eblm_plcy_veh.CLIENT_EFF_DT as CLIENT_EFF_DT,
sq_edw_eblm_plcy_veh.NBR_MILES_WORK as NBR_MILES_WORK,
sq_edw_eblm_plcy_veh.PA_POINTS_NBR as PA_POINTS_NBR,
sq_edw_eblm_plcy_veh.NBR_SPEED_VIOLNS as NBR_SPEED_VIOLNS,
sq_edw_eblm_plcy_veh.NBR_OTHR_MINR_VIOLNS as NBR_OTHR_MINR_VIOLNS,
sq_edw_eblm_plcy_veh.NBR_DUI as NBR_DUI,
sq_edw_eblm_plcy_veh.NBR_OTHR_MJR_VIOLNS as NBR_OTHR_MJR_VIOLNS,
sq_edw_eblm_plcy_veh.NBR_CHARG_ACC_PD as NBR_CHARG_ACC_PD,
sq_edw_eblm_plcy_veh.NBR_CHARG_ACC_BI as NBR_CHARG_ACC_BI,
sq_edw_eblm_plcy_veh.INS_SCR1 as INS_SCR1,
sq_edw_eblm_plcy_veh.INS_SCR2 as INS_SCR2,
sq_edw_eblm_plcy_veh.BI_LIMIT as BI_LIMIT,
sq_edw_eblm_plcy_veh.PD_LIMIT as PD_LIMIT,
sq_edw_eblm_plcy_veh.MP_LIMIT as MP_LIMIT,
sq_edw_eblm_plcy_veh.CMP_LIMIT as CMP_LIMIT,
sq_edw_eblm_plcy_veh.COL_LIMIT as COL_LIMIT,
sq_edw_eblm_plcy_veh.CMP_DED as CMP_DED,
sq_edw_eblm_plcy_veh.COL_DED as COL_DED,
sq_edw_eblm_plcy_veh.ERS_DED as ERS_DED,
sq_edw_eblm_plcy_veh.LOI_LIMIT as LOI_LIMIT,
sq_edw_eblm_plcy_veh.LOU_LIMIT as LOU_LIMIT,
sq_edw_eblm_plcy_veh.UNB_LIMIT as UNB_LIMIT,
sq_edw_eblm_plcy_veh.UNB_ADDON_IND as UNB_ADDON_IND,
sq_edw_eblm_plcy_veh.UNB_RED_IND as UNB_RED_IND,
sq_edw_eblm_plcy_veh.UND_DED as UND_DED,
sq_edw_eblm_plcy_veh.UNP_LIMIT as UNP_LIMIT,
sq_edw_eblm_plcy_veh.UNP_ADDON_IND as UNP_ADDON_IND,
sq_edw_eblm_plcy_veh.UNP_RED_IND as UNP_RED_IND,
sq_edw_eblm_plcy_veh.SL_LIMIT as SL_LIMIT,
sq_edw_eblm_plcy_veh.UNSL_LIMIT as UNSL_LIMIT,
sq_edw_eblm_plcy_veh.UNSL_ADDON_IND as UNSL_ADDON_IND,
CASE WHEN sq_edw_eblm_plcy_veh.UNSL_RED_IND = ''Y'' THEN sq_edw_eblm_plcy_veh.UNSL_RED_IND ELSE ''N'' END as UNSL_RED_IND_out,
sq_edw_eblm_plcy_veh.UNSL_DED as UNSL_DED,
sq_edw_eblm_plcy_veh.LOI_IND as LOI_IND,
sq_edw_eblm_plcy_veh.ERS_IND as ERS_IND,
sq_edw_eblm_plcy_veh.LOU_IND as LOU_IND,
sq_edw_eblm_plcy_veh.CS_IND as CS_IND,
sq_edw_eblm_plcy_veh.SG_IND as SG_IND,
sq_edw_eblm_plcy_veh.EXN_IND as EXN_IND,
sq_edw_eblm_plcy_veh.CUS_IND as CUS_IND,
sq_edw_eblm_plcy_veh.GAP_IND as GAP_IND,
sq_edw_eblm_plcy_veh.COMBO_DSC1 as COMBO_DSC1,
sq_edw_eblm_plcy_veh.MULTICAR_DSC1 as MULTICAR_DSC1,
sq_edw_eblm_plcy_veh.NC_DSC as NC_DSC,
sq_edw_eblm_plcy_veh.VC_DSC as VC_DSC,
sq_edw_eblm_plcy_veh.AB_DSC1 as AB_DSC1,
sq_edw_eblm_plcy_veh.AT_DSC1 as AT_DSC1,
sq_edw_eblm_plcy_veh.AS_DSC as AS_DSC,
sq_edw_eblm_plcy_veh.NPIS_DSC1 as NPIS_DSC1,
sq_edw_eblm_plcy_veh.RTU_DSC1 as RTU_DSC1,
sq_edw_eblm_plcy_veh.DTR_DSC1 as DTR_DSC1,
sq_edw_eblm_plcy_veh.HSD_DSC1 as HSD_DSC1,
sq_edw_eblm_plcy_veh.DDC_DSC1 as DDC_DSC1,
sq_edw_eblm_plcy_veh.HOD_DSC1 as HOD_DSC1,
sq_edw_eblm_plcy_veh.LFD_DSC1 as LFD_DSC1,
sq_edw_eblm_plcy_veh.CGHS_DSC1 as CGHS_DSC1,
sq_edw_eblm_plcy_veh.ARPB_DSC as ARPB_DSC,
sq_edw_eblm_plcy_veh.ARPP_DSC as ARPP_DSC,
sq_edw_eblm_plcy_veh.ARPM_DSC as ARPM_DSC,
sq_edw_eblm_plcy_veh.ARPC_DSC as ARPC_DSC,
sq_edw_eblm_plcy_veh.ABS_DSC1 as ABS_DSC1,
sq_edw_eblm_plcy_veh.SALES_AGENCY_NBR as SALES_AGENCY_NBR,
sq_edw_eblm_plcy_veh.PTY_INS_CARRIER_CD as PTY_INS_CARRIER_CD,
sq_edw_eblm_plcy_veh.PTY_INS_CARRIER_NM as PTY_INS_CARRIER_NM,
sq_edw_eblm_plcy_veh.NM_INSUR_GENDER_CD as NM_INSUR_GENDER_CD,
sq_edw_eblm_plcy_veh.NM_INSUR_DOB as NM_INSUR_DOB,
sq_edw_eblm_plcy_veh.NM_INSUR_AGE as NM_INSUR_AGE,
sq_edw_eblm_plcy_veh.NM_INSUR_MARITAL_STATUS_CD as NM_INSUR_MARITAL_STATUS_CD,
sq_edw_eblm_plcy_veh.NM_INSUR_MEMB_TYPE as NM_INSUR_MEMB_TYPE,
sq_edw_eblm_plcy_veh.NM_INSUR_MEMB_NBR as NM_INSUR_MEMB_NBR,
sq_edw_eblm_plcy_veh.NM_INSUR_SKEY as NM_INSUR_SKEY,
sq_edw_eblm_plcy_veh.SCR_TYPE as SCR_TYPE,
sq_edw_eblm_plcy_veh.SCR as SCR,
sq_edw_eblm_plcy_veh.SCR_DATE as SCR_DATE,
sq_edw_eblm_plcy_veh.DEFAULT_IND as DEFAULT_IND,
sq_edw_eblm_plcy_veh.DRVEXC as DRVEXC,
sq_edw_eblm_plcy_veh.DRVEXC25 as DRVEXC25,
cast(LTRIM ( RTRIM ( :PRCS_ID ) ) as BIGINT) as out_PRCS_ID,
CURRENT_TIMESTAMP as out_LOAD_DT,
sq_edw_eblm_plcy_veh.ACCIDENT_FORGIVE_IND as ACCIDENT_FORGIVE_IND,
sq_edw_eblm_plcy_veh.UMBRELLA_IND as UMBRELLA_IND,
sq_edw_eblm_plcy_veh.BILL_PAY as BILL_PAY,
sq_edw_eblm_plcy_veh.FARM_IND as FARM_IND,
sq_edw_eblm_plcy_veh.LENGTH_WITH_PRIOR_CARRIER as LENGTH_WITH_PRIOR_CARRIER,
sq_edw_eblm_plcy_veh.LIFE_IND as LIFE_IND,
sq_edw_eblm_plcy_veh.MH_IND as MH_IND,
sq_edw_eblm_plcy_veh.NUM_DEFENSIVE_DRIVER as NUM_DEFENSIVE_DRIVER,
sq_edw_eblm_plcy_veh.NUM_DRIVER_TRAINING as NUM_DRIVER_TRAINING,
sq_edw_eblm_plcy_veh.NUM_DRIVERS as NUM_DRIVERS,
sq_edw_eblm_plcy_veh.NUM_FEMALE as NUM_FEMALE,
sq_edw_eblm_plcy_veh.NUM_HONOR_STUDENTS as NUM_HONOR_STUDENTS,
sq_edw_eblm_plcy_veh.NUM_LIFE_POL as NUM_LIFE_POL,
sq_edw_eblm_plcy_veh.NUM_MALE as NUM_MALE,
sq_edw_eblm_plcy_veh.NUM_MH as NUM_MH,
sq_edw_eblm_plcy_veh.NUM_OF_LATE_PAY as NUM_OF_LATE_PAY,
sq_edw_eblm_plcy_veh.NUM_SF as NUM_SF,
sq_edw_eblm_plcy_veh.NUM_UNLISTED_DRIVER as NUM_UNLISTED_DRIVER,
sq_edw_eblm_plcy_veh.NUM_VEHICLES as NUM_VEHICLES,
sq_edw_eblm_plcy_veh.PRIOR_CLAIMS_IND as PRIOR_CLAIMS_IND,
sq_edw_eblm_plcy_veh.RELATIONSHIP_DISC_IND as RELATIONSHIP_DISC_IND,
sq_edw_eblm_plcy_veh.STANDARD_FIRE_IND as STANDARD_FIRE_IND,
sq_edw_eblm_plcy_veh.WTC_IND as WTC_IND,
sq_edw_eblm_plcy_veh.AFFINITY_GROUP_IND as AFFINITY_GROUP_IND,
sq_edw_eblm_plcy_veh.NUM_ACCIDENTS as NUM_ACCIDENTS,
sq_edw_eblm_plcy_veh.NUM_MAJOR_VIOLATIONS as NUM_MAJOR_VIOLATIONS,
sq_edw_eblm_plcy_veh.NUM_MINOR_VIOLATIONS as NUM_MINOR_VIOLATIONS,
sq_edw_eblm_plcy_veh.CENSUS_BLOCK as CENSUS_BLOCK,
sq_edw_eblm_plcy_veh.RED_MOUNTAIN_SCORE as RED_MOUNTAIN_SCORE,
sq_edw_eblm_plcy_veh.PA_SYM_CD_2 as PA_SYM_CD_2,
sq_edw_eblm_plcy_veh.PLCY_TYPE as PLCY_TYPE,
sq_edw_eblm_plcy_veh.MO_ID as MO_ID,
sq_edw_eblm_plcy_veh.source_record_id
FROM
sq_edw_eblm_plcy_veh
);


-- Component tgt_edw_eblm_plcy_feed, Type TARGET 
INSERT INTO DB_T_PROD_WRK.EDW_EBLM_PLCY_FEED
(
MO_ID,
PLCY_NBR,
PLCY_VEH_KEY,
DW_PLCY_SKEY,
PLCY_CHG_EFF_DT,
PLCY_CHG_EXP_DT,
PLCY_PLN_EXP_DT,
PLCY_EFF_TYPE_CD,
VEH_CHG_EFF_DT,
VEH_CHG_EXP_DT,
DRV_SKEY,
RSK_ST_CD,
RSK_CNTY_CD,
RSK_TERR_CD,
RSK_POSTAL_CD,
PA_SYM_CD,
UNIT_YEAR,
PLCY_OGN_EFF_DT,
PLCY_OGN_IPT_DT,
YEARS_WITH_ALFA,
COMPANY_NBR,
CLASS_DISCOUNT,
VEH_MAKE_DESC,
VEH_MODEL_YR,
VEH_TYPE_CD,
DRIVER_CLASS,
VEH_STT_AMT,
VEH_CST_NEW_AMT,
ANN_MILE_DESC,
VEH_EFF_TYPE_CD,
VEH_PFO_CD,
GENDER_CD,
CLIENT_DOB,
CLIENT_AGE,
MARITAL_STATUS_CD,
CLIENT_OCP,
VEH_USE_CD,
CLIENT_EFF_DT,
NBR_MILES_WORK,
PA_POINTS_NBR,
NBR_SPEED_VIOLNS,
NBR_OTHR_MINR_VIOLNS,
NBR_DUI,
NBR_OTHR_MJR_VIOLNS,
NBR_CHARG_ACC_PD,
NBR_CHARG_ACC_BI,
INS_SCR1,
INS_SCR2,
BI_LIMIT,
PD_LIMIT,
MP_LIMIT,
CMP_LIMIT,
COL_LIMIT,
CMP_DED,
COL_DED,
ERS_DED,
LOI_LIMIT,
LOU_LIMIT,
UNB_LIMIT,
UNB_ADDON_IND,
UNB_RED_IND,
UND_DED,
UNP_LIMIT,
UNP_ADDON_IND,
UNP_RED_IND,
SL_LIMIT,
UNSL_LIMIT,
UNSL_ADDON_IND,
UNSL_RED_IND,
UNSL_DED,
LOI_IND,
ERS_IND,
LOU_IND,
CS_IND,
SG_IND,
EXN_IND,
CUS_IND,
GAP_IND,
COMBO_DSC,
MULTICAR_DSC,
NC_DSC,
VC_DSC,
AB_DSC,
AT_DSC,
AS_DSC,
NPIS_DSC,
RTU_DSC,
DTR_DSC,
HSD_DSC,
DDC_DSC,
HOD_DSC,
LFD_DSC,
CGHS_DSC,
ARPB_DSC,
ARPP_DSC,
ARPM_DSC,
ARPC_DSC,
ABS_DSC,
SALES_AGENCY_NBR,
PTY_INS_CARRIER_CD,
PTY_INS_CARRIER_NM,
NM_INSUR_GENDER_CD,
NM_INSUR_DOB,
NM_INSUR_AGE,
NM_INSUR_MARITAL_STATUS_CD,
NM_INSUR_MEMB_TYPE,
NM_INSUR_MEMB_NBR,
NM_INSUR_SKEY,
SCR_TYPE,
SCR,
SCR_DATE,
DEFAULT_IND,
DRVEXC,
DRVEXC25,
ACCIDENT_FORGIVE_IND,
UMBRELLA_IND,
BILL_PAY,
FARM_IND,
LENGTH_WITH_PRIOR_CARRIER,
LIFE_IND,
MH_IND,
NUM_DEFENSIVE_DRIVER,
NUM_DRIVER_TRAINING,
NUM_DRIVERS,
NUM_FEMALE,
NUM_HONOR_STUDENTS,
NUM_LIFE_POL,
NUM_MALE,
NUM_MH,
NUM_OF_LATE_PAY,
NUM_SF,
NUM_UNLISTED_DRIVER,
NUM_VEHICLES,
PRIOR_CLAIMS_IND,
RELATIONSHIP_DISC_IND,
STANDARD_FIRE_IND,
WTC_IND,
AFFINITY_GROUP_IND,
NUM_ACCIDENTS,
NUM_MAJOR_VIOLATIONS,
NUM_MINOR_VIOLATIONS,
CENSUS_BLOCK,
RED_MOUNTAIN_SCORE,
PA_SYM_CD_2,
PLCY_TYPE,
PRCS_ID,
LOAD_DT
)
SELECT
exp_pass_to_target.MO_ID as MO_ID,
exp_pass_to_target.PLCY_NBR as PLCY_NBR,
exp_pass_to_target.PLCY_VEH_KEY as PLCY_VEH_KEY,
exp_pass_to_target.DW_PLCY_SKEY as DW_PLCY_SKEY,
exp_pass_to_target.PLCY_CHG_EFF_DT as PLCY_CHG_EFF_DT,
exp_pass_to_target.PLCY_CHG_EXP_DT as PLCY_CHG_EXP_DT,
exp_pass_to_target.PLCY_PLN_EXP_DT as PLCY_PLN_EXP_DT,
exp_pass_to_target.PLCY_EFF_TYPE_CD as PLCY_EFF_TYPE_CD,
exp_pass_to_target.VEH_CHG_EFF_DT as VEH_CHG_EFF_DT,
exp_pass_to_target.VEH_CHG_EXP_DT as VEH_CHG_EXP_DT,
exp_pass_to_target.DRV_SKEY as DRV_SKEY,
exp_pass_to_target.RSK_ST_CD as RSK_ST_CD,
exp_pass_to_target.RSK_CNTY_CD as RSK_CNTY_CD,
exp_pass_to_target.RSK_TERR_CD as RSK_TERR_CD,
exp_pass_to_target.RSK_POSTAL_CD as RSK_POSTAL_CD,
exp_pass_to_target.PA_SYM_CD as PA_SYM_CD,
exp_pass_to_target.UNIT_YEAR as UNIT_YEAR,
exp_pass_to_target.PLCY_OGN_EFF_DT as PLCY_OGN_EFF_DT,
exp_pass_to_target.PLCY_OGN_IPT_DT as PLCY_OGN_IPT_DT,
exp_pass_to_target.YEARS_WITH_ALFA as YEARS_WITH_ALFA,
exp_pass_to_target.COMPANY_NBR as COMPANY_NBR,
exp_pass_to_target.CLASS_DISCOUNT as CLASS_DISCOUNT,
exp_pass_to_target.VEH_MAKE_DESC as VEH_MAKE_DESC,
exp_pass_to_target.VEH_MODEL_YR as VEH_MODEL_YR,
exp_pass_to_target.VEH_TYPE_CD as VEH_TYPE_CD,
exp_pass_to_target.DRIVER_CLASS as DRIVER_CLASS,
exp_pass_to_target.VEH_STT_AMT as VEH_STT_AMT,
exp_pass_to_target.VEH_CST_NEW_AMT as VEH_CST_NEW_AMT,
exp_pass_to_target.ANN_MILE_DESC as ANN_MILE_DESC,
exp_pass_to_target.VEH_EFF_TYPE_CD as VEH_EFF_TYPE_CD,
exp_pass_to_target.VEH_PFO_CD as VEH_PFO_CD,
exp_pass_to_target.GENDER_CD as GENDER_CD,
exp_pass_to_target.CLIENT_DOB as CLIENT_DOB,
exp_pass_to_target.CLIENT_AGE as CLIENT_AGE,
exp_pass_to_target.MARITAL_STATUS_CD as MARITAL_STATUS_CD,
exp_pass_to_target.CLIENT_OCP as CLIENT_OCP,
exp_pass_to_target.VEH_USE_CD as VEH_USE_CD,
exp_pass_to_target.CLIENT_EFF_DT as CLIENT_EFF_DT,
exp_pass_to_target.NBR_MILES_WORK as NBR_MILES_WORK,
exp_pass_to_target.PA_POINTS_NBR as PA_POINTS_NBR,
exp_pass_to_target.NBR_SPEED_VIOLNS as NBR_SPEED_VIOLNS,
exp_pass_to_target.NBR_OTHR_MINR_VIOLNS as NBR_OTHR_MINR_VIOLNS,
exp_pass_to_target.NBR_DUI as NBR_DUI,
exp_pass_to_target.NBR_OTHR_MJR_VIOLNS as NBR_OTHR_MJR_VIOLNS,
exp_pass_to_target.NBR_CHARG_ACC_PD as NBR_CHARG_ACC_PD,
exp_pass_to_target.NBR_CHARG_ACC_BI as NBR_CHARG_ACC_BI,
exp_pass_to_target.INS_SCR1 as INS_SCR1,
exp_pass_to_target.INS_SCR2 as INS_SCR2,
exp_pass_to_target.BI_LIMIT as BI_LIMIT,
exp_pass_to_target.PD_LIMIT as PD_LIMIT,
exp_pass_to_target.MP_LIMIT as MP_LIMIT,
exp_pass_to_target.CMP_LIMIT as CMP_LIMIT,
exp_pass_to_target.COL_LIMIT as COL_LIMIT,
exp_pass_to_target.CMP_DED as CMP_DED,
exp_pass_to_target.COL_DED as COL_DED,
exp_pass_to_target.ERS_DED as ERS_DED,
exp_pass_to_target.LOI_LIMIT as LOI_LIMIT,
exp_pass_to_target.LOU_LIMIT as LOU_LIMIT,
exp_pass_to_target.UNB_LIMIT as UNB_LIMIT,
exp_pass_to_target.UNB_ADDON_IND as UNB_ADDON_IND,
exp_pass_to_target.UNB_RED_IND as UNB_RED_IND,
exp_pass_to_target.UND_DED as UND_DED,
exp_pass_to_target.UNP_LIMIT as UNP_LIMIT,
exp_pass_to_target.UNP_ADDON_IND as UNP_ADDON_IND,
exp_pass_to_target.UNP_RED_IND as UNP_RED_IND,
exp_pass_to_target.SL_LIMIT as SL_LIMIT,
exp_pass_to_target.UNSL_LIMIT as UNSL_LIMIT,
exp_pass_to_target.UNSL_ADDON_IND as UNSL_ADDON_IND,
exp_pass_to_target.UNSL_RED_IND_out as UNSL_RED_IND,
exp_pass_to_target.UNSL_DED as UNSL_DED,
exp_pass_to_target.LOI_IND as LOI_IND,
exp_pass_to_target.ERS_IND as ERS_IND,
exp_pass_to_target.LOU_IND as LOU_IND,
exp_pass_to_target.CS_IND as CS_IND,
exp_pass_to_target.SG_IND as SG_IND,
exp_pass_to_target.EXN_IND as EXN_IND,
exp_pass_to_target.CUS_IND as CUS_IND,
exp_pass_to_target.GAP_IND as GAP_IND,
exp_pass_to_target.COMBO_DSC1 as COMBO_DSC,
exp_pass_to_target.MULTICAR_DSC1 as MULTICAR_DSC,
exp_pass_to_target.NC_DSC as NC_DSC,
exp_pass_to_target.VC_DSC as VC_DSC,
exp_pass_to_target.AB_DSC1 as AB_DSC,
exp_pass_to_target.AT_DSC1 as AT_DSC,
exp_pass_to_target.AS_DSC as AS_DSC,
exp_pass_to_target.NPIS_DSC1 as NPIS_DSC,
exp_pass_to_target.RTU_DSC1 as RTU_DSC,
exp_pass_to_target.DTR_DSC1 as DTR_DSC,
exp_pass_to_target.HSD_DSC1 as HSD_DSC,
exp_pass_to_target.DDC_DSC1 as DDC_DSC,
exp_pass_to_target.HOD_DSC1 as HOD_DSC,
exp_pass_to_target.LFD_DSC1 as LFD_DSC,
exp_pass_to_target.CGHS_DSC1 as CGHS_DSC,
exp_pass_to_target.ARPB_DSC as ARPB_DSC,
exp_pass_to_target.ARPP_DSC as ARPP_DSC,
exp_pass_to_target.ARPM_DSC as ARPM_DSC,
exp_pass_to_target.ARPC_DSC as ARPC_DSC,
exp_pass_to_target.ABS_DSC1 as ABS_DSC,
exp_pass_to_target.SALES_AGENCY_NBR as SALES_AGENCY_NBR,
exp_pass_to_target.PTY_INS_CARRIER_CD as PTY_INS_CARRIER_CD,
exp_pass_to_target.PTY_INS_CARRIER_NM as PTY_INS_CARRIER_NM,
exp_pass_to_target.NM_INSUR_GENDER_CD as NM_INSUR_GENDER_CD,
exp_pass_to_target.NM_INSUR_DOB as NM_INSUR_DOB,
exp_pass_to_target.NM_INSUR_AGE as NM_INSUR_AGE,
exp_pass_to_target.NM_INSUR_MARITAL_STATUS_CD as NM_INSUR_MARITAL_STATUS_CD,
exp_pass_to_target.NM_INSUR_MEMB_TYPE as NM_INSUR_MEMB_TYPE,
exp_pass_to_target.NM_INSUR_MEMB_NBR as NM_INSUR_MEMB_NBR,
exp_pass_to_target.NM_INSUR_SKEY as NM_INSUR_SKEY,
exp_pass_to_target.SCR_TYPE as SCR_TYPE,
exp_pass_to_target.SCR as SCR,
exp_pass_to_target.SCR_DATE as SCR_DATE,
exp_pass_to_target.DEFAULT_IND as DEFAULT_IND,
exp_pass_to_target.DRVEXC as DRVEXC,
exp_pass_to_target.DRVEXC25 as DRVEXC25,
exp_pass_to_target.ACCIDENT_FORGIVE_IND as ACCIDENT_FORGIVE_IND,
exp_pass_to_target.UMBRELLA_IND as UMBRELLA_IND,
exp_pass_to_target.BILL_PAY as BILL_PAY,
exp_pass_to_target.FARM_IND as FARM_IND,
exp_pass_to_target.LENGTH_WITH_PRIOR_CARRIER as LENGTH_WITH_PRIOR_CARRIER,
exp_pass_to_target.LIFE_IND as LIFE_IND,
exp_pass_to_target.MH_IND as MH_IND,
exp_pass_to_target.NUM_DEFENSIVE_DRIVER as NUM_DEFENSIVE_DRIVER,
exp_pass_to_target.NUM_DRIVER_TRAINING as NUM_DRIVER_TRAINING,
exp_pass_to_target.NUM_DRIVERS as NUM_DRIVERS,
exp_pass_to_target.NUM_FEMALE as NUM_FEMALE,
exp_pass_to_target.NUM_HONOR_STUDENTS as NUM_HONOR_STUDENTS,
exp_pass_to_target.NUM_LIFE_POL as NUM_LIFE_POL,
exp_pass_to_target.NUM_MALE as NUM_MALE,
exp_pass_to_target.NUM_MH as NUM_MH,
exp_pass_to_target.NUM_OF_LATE_PAY as NUM_OF_LATE_PAY,
exp_pass_to_target.NUM_SF as NUM_SF,
exp_pass_to_target.NUM_UNLISTED_DRIVER as NUM_UNLISTED_DRIVER,
exp_pass_to_target.NUM_VEHICLES as NUM_VEHICLES,
exp_pass_to_target.PRIOR_CLAIMS_IND as PRIOR_CLAIMS_IND,
exp_pass_to_target.RELATIONSHIP_DISC_IND as RELATIONSHIP_DISC_IND,
exp_pass_to_target.STANDARD_FIRE_IND as STANDARD_FIRE_IND,
exp_pass_to_target.WTC_IND as WTC_IND,
exp_pass_to_target.AFFINITY_GROUP_IND as AFFINITY_GROUP_IND,
exp_pass_to_target.NUM_ACCIDENTS as NUM_ACCIDENTS,
exp_pass_to_target.NUM_MAJOR_VIOLATIONS as NUM_MAJOR_VIOLATIONS,
exp_pass_to_target.NUM_MINOR_VIOLATIONS as NUM_MINOR_VIOLATIONS,
exp_pass_to_target.CENSUS_BLOCK as CENSUS_BLOCK,
exp_pass_to_target.RED_MOUNTAIN_SCORE as RED_MOUNTAIN_SCORE,
exp_pass_to_target.PA_SYM_CD_2 as PA_SYM_CD_2,
exp_pass_to_target.PLCY_TYPE as PLCY_TYPE,
exp_pass_to_target.out_PRCS_ID as PRCS_ID,
exp_pass_to_target.out_LOAD_DT as LOAD_DT
FROM
exp_pass_to_target;


END; ';