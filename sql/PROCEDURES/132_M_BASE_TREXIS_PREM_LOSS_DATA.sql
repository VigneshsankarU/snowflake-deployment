-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_BASE_TREXIS_PREM_LOSS_DATA("WORKLET_NAME" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' 
DECLARE
       run_id STRING;
       PRCS_ID STRING;
	   v_start_time TIMESTAMP;
BEGIN
       run_id := (SELECT run_id FROM control_worklet WHERE worklet_name = :worklet_name ORDER BY insert_ts DESC LIMIT 1);
       PRCS_ID := (SELECT param_value FROM control_params WHERE run_id = :run_id AND param_name = ''PRCS_ID'' LIMIT 1);
	   v_start_time := CURRENT_TIMESTAMP();

-- Component SQ_TREXIS_PREM_AND_LOSS_DATA, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_TREXIS_PREM_AND_LOSS_DATA AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as MTH_ID,
$2 as PLCY_NUM,
$3 as LOB_CD,
$4 as LOB_DESC,
$5 as TERM_EFF_DT,
$6 as LOSS_DT,
$7 as CAT_CD,
$8 as WRTN_PREM,
$9 as EARND_PREM,
$10 as INCURD_LOSS,
$11 as AGNT_NUM,
$12 as SRVC_CTR,
$13 as MBRSHP_NUM,
$14 as AGT_IND,
$15 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT STG_TREXIS_PREM_AND_LOSS_DATA.MTH_ID, STG_TREXIS_PREM_AND_LOSS_DATA.PLCY_NUM, STG_TREXIS_PREM_AND_LOSS_DATA.LOB_CD, STG_TREXIS_PREM_AND_LOSS_DATA.LOB_DESC, STG_TREXIS_PREM_AND_LOSS_DATA.TERM_EFF_DT, STG_TREXIS_PREM_AND_LOSS_DATA.LOSS_DT, STG_TREXIS_PREM_AND_LOSS_DATA.CAT_CD, STG_TREXIS_PREM_AND_LOSS_DATA.WRTN_PREM, STG_TREXIS_PREM_AND_LOSS_DATA.EARND_PREM, STG_TREXIS_PREM_AND_LOSS_DATA.INCURD_LOSS, STG_TREXIS_PREM_AND_LOSS_DATA.AGNT_NUM, STG_TREXIS_PREM_AND_LOSS_DATA.SRVC_CTR, STG_TREXIS_PREM_AND_LOSS_DATA.MBRSHP_NUM ,

STG_TREXIS_PREM_AND_LOSS_DATA.AGT_IND

FROM

 DB_T_PROD_STAG.STG_TREXIS_PREM_AND_LOSS_DATA
) SRC
)
);


-- Component exp_PASS_THROUGH, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE exp_PASS_THROUGH AS
(
SELECT
SQ_TREXIS_PREM_AND_LOSS_DATA.MTH_ID as MTH_ID,
SQ_TREXIS_PREM_AND_LOSS_DATA.PLCY_NUM as PLCY_NUM,
SQ_TREXIS_PREM_AND_LOSS_DATA.LOB_CD as LOB_CD,
SQ_TREXIS_PREM_AND_LOSS_DATA.LOB_DESC as LOB_DESC,
to_date ( substr ( SQ_TREXIS_PREM_AND_LOSS_DATA.TERM_EFF_DT , 1 , 10 ) , ''yyyy-mm-dd'' ) as o_TERM_EFF_DT,
SQ_TREXIS_PREM_AND_LOSS_DATA.LOSS_DT as LOSS_DT,
SQ_TREXIS_PREM_AND_LOSS_DATA.CAT_CD as CAT_CD,
SQ_TREXIS_PREM_AND_LOSS_DATA.WRTN_PREM as WRTN_PREM,
SQ_TREXIS_PREM_AND_LOSS_DATA.EARND_PREM as EARND_PREM,
SQ_TREXIS_PREM_AND_LOSS_DATA.INCURD_LOSS as INCURD_LOSS,
SQ_TREXIS_PREM_AND_LOSS_DATA.AGNT_NUM as AGNT_NUM,
SQ_TREXIS_PREM_AND_LOSS_DATA.SRVC_CTR as SRVC_CTR,
SQ_TREXIS_PREM_AND_LOSS_DATA.MBRSHP_NUM as MBRSHP_NUM,
SQ_TREXIS_PREM_AND_LOSS_DATA.AGT_IND as AGT_IND,
:PRCS_ID as PRCS_ID,
CURRENT_TIMESTAMP as EDW_STRT_DTTM,
TO_DATE ( ''12/31/9999 23:59:59.999999'' , ''MM/DD/YYYY HH24:MI:SS.FF6'' ) as EDW_END_DTTM,
SQ_TREXIS_PREM_AND_LOSS_DATA.source_record_id
FROM
SQ_TREXIS_PREM_AND_LOSS_DATA
);


-- Component TREXIS_PREM_AND_LOSS_DATA1, Type TARGET 
INSERT INTO DB_T_PROD_COMN.TREXIS_PREM_AND_LOSS_DATA
(
MTH_ID,
PLCY_NUM,
LOB_CD,
LOB_DESC,
TERM_EFF_DT,
LOSS_DT,
CAT_CD,
WRTN_PREM,
EARND_PREM,
INCURD_LOSS,
AGNT_NUM,
SRVC_CTR,
MBRSHP_NUM,
AGT_IND,
PRCS_ID,
EDW_STRT_DTTM,
EDW_END_DTTM
)
SELECT
exp_PASS_THROUGH.MTH_ID as MTH_ID,
exp_PASS_THROUGH.PLCY_NUM as PLCY_NUM,
exp_PASS_THROUGH.LOB_CD as LOB_CD,
exp_PASS_THROUGH.LOB_DESC as LOB_DESC,
exp_PASS_THROUGH.o_TERM_EFF_DT as TERM_EFF_DT,
exp_PASS_THROUGH.LOSS_DT as LOSS_DT,
exp_PASS_THROUGH.CAT_CD as CAT_CD,
exp_PASS_THROUGH.WRTN_PREM as WRTN_PREM,
exp_PASS_THROUGH.EARND_PREM as EARND_PREM,
exp_PASS_THROUGH.INCURD_LOSS as INCURD_LOSS,
exp_PASS_THROUGH.AGNT_NUM as AGNT_NUM,
exp_PASS_THROUGH.SRVC_CTR as SRVC_CTR,
exp_PASS_THROUGH.MBRSHP_NUM as MBRSHP_NUM,
exp_PASS_THROUGH.AGT_IND as AGT_IND,
exp_PASS_THROUGH.PRCS_ID as PRCS_ID,
exp_PASS_THROUGH.EDW_STRT_DTTM as EDW_STRT_DTTM,
exp_PASS_THROUGH.EDW_END_DTTM as EDW_END_DTTM
FROM
exp_PASS_THROUGH;


END; ';