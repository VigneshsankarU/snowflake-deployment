-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_STG_CAT_CD("RUN_ID" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' BEGIN 

-- Component Shortcut_to_STG_CAT_CD, Type TRUNCATE_TABLE 
TRUNCATE TABLE DB_T_STAG_PROD.STG_CAT_CD;


-- Component SQ_Shortcut_to_GW_CAT_CODE_CONV, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_Shortcut_to_GW_CAT_CODE_CONV AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as CAT_STATE,
$2 as CAT_CATCODE,
$3 as CAT_START_DT,
$4 as CAT_END_DT,
$5 as CAT_YEAR,
$6 as CAT_3CATCODE,
$7 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT
GW_CAT_CODE_CONV.CAT_STATE,
GW_CAT_CODE_CONV.CAT_CATCODE,
GW_CAT_CODE_CONV.CAT_START_DT,
GW_CAT_CODE_CONV.CAT_END_DT,
GW_CAT_CODE_CONV.CAT_YEAR,
GW_CAT_CODE_CONV.CAT_3CATCODE
FROM GW_CAT_CODE_CONV
) SRC
)
);


-- Component Shortcut_to_STG_CAT_CD, Type TARGET 
INSERT INTO DB_T_STAG_PROD.STG_CAT_CD
(
CAT_STATE,
CAT_CATCODE,
CAT_START_DT,
CAT_END_DT,
CAT_YEAR,
CAT_3CATCODE
)
SELECT
SQ_Shortcut_to_GW_CAT_CODE_CONV.CAT_STATE as CAT_STATE,
SQ_Shortcut_to_GW_CAT_CODE_CONV.CAT_CATCODE as CAT_CATCODE,
SQ_Shortcut_to_GW_CAT_CODE_CONV.CAT_START_DT as CAT_START_DT,
SQ_Shortcut_to_GW_CAT_CODE_CONV.CAT_END_DT as CAT_END_DT,
SQ_Shortcut_to_GW_CAT_CODE_CONV.CAT_YEAR as CAT_YEAR,
SQ_Shortcut_to_GW_CAT_CODE_CONV.CAT_3CATCODE as CAT_3CATCODE
FROM
SQ_Shortcut_to_GW_CAT_CODE_CONV;


END; ';