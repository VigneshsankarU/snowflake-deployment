-- Object Type: PROCEDURES
CREATE OR REPLACE PROCEDURE ALFA_EDW_DEV.PUBLIC.M_BIBASE_W_SP_CREATE_PARAM_FILE_MTHLY("WORKLET_NAME" VARCHAR)
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS ' 
DECLARE
  COMPOSITE_MTHLY_LOAD_IND STRING;
  CMPSIT_HIST_JOB_START_DT STRING;
  PMWorkflowName STRING;
  PMSessionName STRING;
  run_id STRING;
  workflow_name STRING;
  session_name STRING;
BEGIN
  run_id := public.func_get_scoped_param(:run_id, ''run_id'', :workflow_name, :worklet_name, :session_name);
  workflow_name := public.func_get_scoped_param(:run_id, ''workflow_name'', :workflow_name, :worklet_name, :session_name);
  session_name := public.func_get_scoped_param(:run_id, ''session_name'', :workflow_name, :worklet_name, :session_name);

  SELECT 
    TRY_PARSE_JSON(:param_json):COMPOSITE_MTHLY_LOAD_IND::STRING,
    TRY_PARSE_JSON(:param_json):CMPSIT_HIST_JOB_START_DT::STRING,
    TRY_PARSE_JSON(:param_json):PMWorkflowName::STRING,
    ''s_m_bibase_wr_fnol_dtl_ins''
  INTO
    COMPOSITE_MTHLY_LOAD_IND,
    CMPSIT_HIST_JOB_START_DT,
    PMWorkflowName,
    PMSessionName;

-- Component SQ_ETL_PRCS_CTRL, Type SOURCE 
CREATE OR REPLACE TEMPORARY TABLE SQ_ETL_PRCS_CTRL AS
(
SELECT /* adding column aliases to ensure proper downstream column references */
$1 as COMPOSITE_MTHLY_LOAD_DT,
$2 as source_record_id
FROM (
SELECT SRC.*, row_number() over (order by 1) AS source_record_id FROM (
SELECT 

case 

when  :COMPOSITE_MTHLY_LOAD_IND  = ''MTHLY'' then

M.COMPOSITE_MTHLY_LOAD_DT1

 when  :COMPOSITE_MTHLY_LOAD_IND  = ''HISTORY'' then 

 H.COMPOSITE_MTHLY_LOAD_DT1

 END AS COMPOSITE_MTHLY_LOAD_DT

 FROM 

(

SELECT ''1'' AS DUMMYCOL,

TO_CHAR(CAST(A.CAL_MTH_END_TS AS DATE), ''YYYY-MM-DD'') AS COMPOSITE_MTHLY_LOAD_DT1 FROM 

(SELECT CAST(MIN(CALENDAR_DATE) AS TIMESTAMP(6)) - INTERVAL ''0.000001 SECONDS'' AS CAL_MTH_END_TS FROM DB_SP_PROD.CALENDAR 

GROUP BY YEAR_OF_CALENDAR*100+MONTH_OF_YEAR) A 

JOIN (SELECT MIN(JOB_END_DT) MIN_JOB_END_DT, MAX(JOB_END_DT) AS MAX_JOB_END_DT FROM DB_T_PROD_CORE.ETL_PRCS_CTRL WHERE PRCS_STAG = ''EDW_DLY'' AND PRCS_STS=''SUCCEEDED'') B 

ON A.CAL_MTH_END_TS BETWEEN MIN_JOB_END_DT AND MAX_JOB_END_DT

QUALIFY 

(ROW_NUMBER() OVER(ORDER BY COMPOSITE_MTHLY_LOAD_DT1 DESC)=1 AND :COMPOSITE_MTHLY_LOAD_IND = ''MTHLY'')

) AS M FULL JOIN

(SELECT ''1'' AS DUMMYCOL,

TO_CHAR(CAST(A.CAL_MTH_END_TS AS DATE), ''YYYY-MM-DD'') AS COMPOSITE_MTHLY_LOAD_DT1 FROM 

(SELECT CAST(MIN(CALENDAR_DATE) AS TIMESTAMP(6)) - INTERVAL ''0.000001 SECONDS'' AS CAL_MTH_END_TS FROM DB_SP_PROD.CALENDAR 

GROUP BY YEAR_OF_CALENDAR*100+MONTH_OF_YEAR) A 

WHERE  :COMPOSITE_MTHLY_LOAD_IND = ''HISTORY''

AND CAST(A.CAL_MTH_END_TS AS DATE) BETWEEN CAST (SUBSTR(:CMPSIT_HIST_JOB_START_DT,1,10) AS DATE) AND CAST(SUBSTR(:CMPSIT_HIST_JOB_END_DT,1,10) AS DATE)

) AS H

ON  M.DUMMYCOL=H.DUMMYCOL

ORDER BY COMPOSITE_MTHLY_LOAD_DT DESC
) SRC
)
);


-- Component Exp_pass_src_to_tgt, Type EXPRESSION 
CREATE OR REPLACE TEMPORARY TABLE Exp_pass_src_to_tgt AS
(
SELECT
TO_CHAR ( SQ_ETL_PRCS_CTRL.COMPOSITE_MTHLY_LOAD_DT , ''YYYY-MM-DD'' ) as O_COMPOSITE_MTHLY_LOAD_DT,
SQ_ETL_PRCS_CTRL.source_record_id
FROM
SQ_ETL_PRCS_CTRL
);


-- Component COMPOSITE_PARAM_FILE_MTHLY, Type TARGET_EXPORT_PREPARE Stage data before exporting
CREATE OR REPLACE TEMPORARY TABLE COMPOSITE_PARAM_FILE_MTHLY AS
(
SELECT
Exp_pass_src_to_tgt.O_COMPOSITE_MTHLY_LOAD_DT as COMPOSITE_MTHLY_LOAD_DT
FROM
Exp_pass_src_to_tgt
);


-- Component COMPOSITE_PARAM_FILE_MTHLY, Type EXPORT_DATA Exporting data
;


END; ';